<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span class="hs-cpp">

#include &quot;inline.hs&quot;
</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- Module      : Streamly.Internal.Data.Stream.StreamK.Type</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- Copyright   : (c) 2017 Composewell Technologies</span><span>
</span><span id="line-8"></span><span class="hs-comment">--</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- License     : BSD3</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- Maintainer  : streamly@composewell.com</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- Stability   : experimental</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- Portability : GHC</span><span>
</span><span id="line-13"></span><span class="hs-comment">--</span><span>
</span><span id="line-14"></span><span class="hs-comment">--</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- Continuation passing style (CPS) stream implementation. The symbol 'K' below</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- denotes a function as well as a Kontinuation.</span><span>
</span><span id="line-17"></span><span class="hs-comment">--</span><span>
</span><span id="line-18"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Streamly.Internal.Data.Stream.StreamK.Type</span><span>
</span><span id="line-19"></span><span>    </span><span class="hs-special">(</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><span class="hs-comment">-- * The stream type</span></span><span>
</span><span id="line-21"></span><span>      </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier">Stream</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#toStreamK"><span class="hs-identifier">toStreamK</span></a></span><span>
</span><span id="line-23"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromStreamK"><span class="hs-identifier">fromStreamK</span></a></span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><span class="hs-comment">-- * foldr/build</span></span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier">mkStream</span></a></span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier">foldStream</span></a></span><span>
</span><span id="line-28"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier">foldStreamShared</span></a></span><span>
</span><span id="line-29"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrM"><span class="hs-identifier">foldrM</span></a></span><span>
</span><span id="line-30"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrS"><span class="hs-identifier">foldrS</span></a></span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSShared"><span class="hs-identifier">foldrSShared</span></a></span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSM"><span class="hs-identifier">foldrSM</span></a></span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#build"><span class="hs-identifier">build</span></a></span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildS"><span class="hs-identifier">buildS</span></a></span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildM"><span class="hs-identifier">buildM</span></a></span><span>
</span><span id="line-36"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildSM"><span class="hs-identifier">buildSM</span></a></span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#augmentS"><span class="hs-identifier">augmentS</span></a></span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#augmentSM"><span class="hs-identifier">augmentSM</span></a></span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Construction</span></span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromStopK"><span class="hs-identifier">fromStopK</span></a></span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromYieldK"><span class="hs-identifier">fromYieldK</span></a></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#consK"><span class="hs-identifier">consK</span></a></span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#cons"><span class="hs-identifier">cons</span></a></span><span>
</span><span id="line-45"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#.%3A"><span class="hs-operator">(.:)</span></a></span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#consM"><span class="hs-identifier">consM</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#consMBy"><span class="hs-identifier">consMBy</span></a></span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-identifier">nil</span></a></span><span>
</span><span id="line-49"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nilM"><span class="hs-identifier">nilM</span></a></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Generation</span></span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromEffect"><span class="hs-identifier">fromEffect</span></a></span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromPure"><span class="hs-identifier">fromPure</span></a></span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#unfoldr"><span class="hs-identifier">unfoldr</span></a></span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#unfoldrMWith"><span class="hs-identifier">unfoldrMWith</span></a></span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#repeat"><span class="hs-identifier">repeat</span></a></span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#repeatMWith"><span class="hs-identifier">repeatMWith</span></a></span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#replicateMWith"><span class="hs-identifier">replicateMWith</span></a></span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromIndicesMWith"><span class="hs-identifier">fromIndicesMWith</span></a></span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#iterateMWith"><span class="hs-identifier">iterateMWith</span></a></span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromFoldable"><span class="hs-identifier">fromFoldable</span></a></span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromFoldableM"><span class="hs-identifier">fromFoldableM</span></a></span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mfix"><span class="hs-identifier">mfix</span></a></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Elimination</span></span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#uncons"><span class="hs-identifier">uncons</span></a></span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldl%27"><span class="hs-identifier">foldl'</span></a></span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldlx%27"><span class="hs-identifier">foldlx'</span></a></span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#drain"><span class="hs-identifier">drain</span></a></span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#null"><span class="hs-identifier">null</span></a></span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#tail"><span class="hs-identifier">tail</span></a></span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#init"><span class="hs-identifier">init</span></a></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Transformation</span></span><span>
</span><span id="line-75"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#conjoin"><span class="hs-identifier">conjoin</span></a></span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#serial"><span class="hs-identifier">serial</span></a></span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#map"><span class="hs-identifier">map</span></a></span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapMWith"><span class="hs-identifier">mapMWith</span></a></span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapMSerial"><span class="hs-identifier">mapMSerial</span></a></span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#unShare"><span class="hs-identifier">unShare</span></a></span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#concatMapWith"><span class="hs-identifier">concatMapWith</span></a></span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#concatMap"><span class="hs-identifier">concatMap</span></a></span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#bindWith"><span class="hs-identifier">bindWith</span></a></span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#concatPairsWith"><span class="hs-identifier">concatPairsWith</span></a></span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#apWith"><span class="hs-identifier">apWith</span></a></span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#apSerial"><span class="hs-identifier">apSerial</span></a></span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#apSerialDiscardFst"><span class="hs-identifier">apSerialDiscardFst</span></a></span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#apSerialDiscardSnd"><span class="hs-identifier">apSerialDiscardSnd</span></a></span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldlS"><span class="hs-identifier">foldlS</span></a></span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#reverse"><span class="hs-identifier">reverse</span></a></span><span>
</span><span id="line-91"></span><span>
</span><span id="line-92"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Reader</span></span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#withLocal"><span class="hs-identifier">withLocal</span></a></span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span class="hs-keyword">where</span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ap</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(&gt;=&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadReader</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadTrans</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">lift</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Function</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fix</span></span><span class="hs-special">)</span><span class="hs-cpp">
#if __GLASGOW_HASKELL__ &lt; 804
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Semigroup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Semigroup</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.Type.html"><span class="hs-identifier">Streamly.Internal.Data.SVar.Type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.SVar.Type.html#State"><span class="hs-identifier">State</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier">adaptState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.Type.html#defState"><span class="hs-identifier">defState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">map</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mapM</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">concatMap</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">foldr</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">repeat</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">null</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">reverse</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">tail</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">init</span></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-110"></span><span class="hs-comment">-- Basic stream type</span><span>
</span><span id="line-111"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span class="hs-comment">-- | The type @Stream m a@ represents a monadic stream of values of type 'a'</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- constructed using actions in monad 'm'. It uses stop, singleton and yield</span><span>
</span><span id="line-115"></span><span class="hs-comment">-- continuations equivalent to the following direct style type:</span><span>
</span><span id="line-116"></span><span class="hs-comment">--</span><span>
</span><span id="line-117"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-118"></span><span class="hs-comment">-- data Stream m a = Stop | Singleton a | Yield a (Stream m a)</span><span>
</span><span id="line-119"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-120"></span><span class="hs-comment">--</span><span>
</span><span id="line-121"></span><span class="hs-comment">-- To facilitate parallel composition we maintain a local state in an 'SVar'</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- that is shared across and is used for synchronization of the streams being</span><span>
</span><span id="line-123"></span><span class="hs-comment">-- composed.</span><span>
</span><span id="line-124"></span><span class="hs-comment">--</span><span>
</span><span id="line-125"></span><span class="hs-comment">-- The singleton case can be expressed in terms of stop and yield but we have</span><span>
</span><span id="line-126"></span><span class="hs-comment">-- it as a separate case to optimize composition operations for streams with</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- single element.  We build singleton streams in the implementation of 'pure'</span><span>
</span><span id="line-128"></span><span class="hs-comment">-- for Applicative and Monad, and in 'lift' for MonadTrans.</span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span class="hs-comment">-- XXX remove the Stream type parameter from State as it is always constant.</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- We can remove it from SVar as well</span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="hs-keyword">newtype</span><span> </span><span id="Stream"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-var">Stream</span></a></span></span><span> </span><span id="local-6989586621679370066"><span class="annot"><a href="#local-6989586621679370066"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679370065"><span class="annot"><a href="#local-6989586621679370065"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-134"></span><span>    </span><span id="MkStream"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#MkStream"><span class="hs-identifier hs-var">MkStream</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679370554"><span class="annot"><a href="#local-6989586621679370554"><span class="hs-identifier hs-type">r</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-135"></span><span>               </span><span class="annot"><a href="Streamly.Internal.Data.SVar.Type.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370066"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370065"><span class="hs-identifier hs-type">a</span></a></span><span>         </span><span class="hs-comment">-- state</span><span>
</span><span id="line-136"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370065"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370066"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370065"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370066"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370554"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- yield</span><span>
</span><span id="line-137"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370065"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370066"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370554"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>               </span><span class="hs-comment">-- singleton</span><span>
</span><span id="line-138"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370066"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370554"><span class="hs-identifier hs-type">r</span></a></span><span>                      </span><span class="hs-comment">-- stop</span><span>
</span><span id="line-139"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370066"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370554"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-140"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromStreamK"><span class="hs-pragma hs-type">fromStreamK</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-143"></span><span id="local-6989586621679370633"><span id="local-6989586621679370634"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromStreamK"><span class="hs-identifier hs-type">fromStreamK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370634"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370633"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370634"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370633"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-144"></span><span id="fromStreamK"><span class="annot"><span class="annottext">fromStreamK :: forall (m :: * -&gt; *) a. Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromStreamK"><span class="hs-identifier hs-var hs-var">fromStreamK</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#toStreamK"><span class="hs-pragma hs-type">toStreamK</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-147"></span><span id="local-6989586621679370061"><span id="local-6989586621679370062"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#toStreamK"><span class="hs-identifier hs-type">toStreamK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370062"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370061"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370062"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370061"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-148"></span><span id="toStreamK"><span class="annot"><span class="annottext">toStreamK :: forall (m :: * -&gt; *) a. Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#toStreamK"><span class="hs-identifier hs-var hs-var">toStreamK</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span id="local-6989586621679370630"><span id="local-6989586621679370631"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-type">mkStream</span></a></span><span>
</span><span id="line-151"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679370628"><span class="annot"><a href="#local-6989586621679370628"><span class="hs-identifier hs-type">r</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.Type.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370631"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370630"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-152"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370630"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370631"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370630"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370631"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370628"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370630"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370631"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370628"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370631"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370628"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-155"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370631"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370628"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370631"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370630"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-157"></span><span id="mkStream"><span class="annot"><span class="annottext">mkStream :: forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var hs-var">mkStream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#MkStream"><span class="hs-identifier hs-var">MkStream</span></a></span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span class="hs-comment">-- | A terminal function that has no continuation to follow.</span><span>
</span><span id="line-160"></span><span class="hs-keyword">type</span><span> </span><span id="StopK"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#StopK"><span class="hs-identifier hs-var">StopK</span></a></span></span><span> </span><span id="local-6989586621679370060"><span class="annot"><a href="#local-6989586621679370060"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679370059"><span class="annot"><a href="#local-6989586621679370059"><span class="hs-identifier hs-type">r</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621679370060"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370059"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370060"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370059"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span class="hs-comment">-- | A monadic continuation, it is a function that yields a value of type &quot;a&quot;</span><span>
</span><span id="line-163"></span><span class="hs-comment">-- and calls the argument (a -&gt; m r) as a continuation with that value. We can</span><span>
</span><span id="line-164"></span><span class="hs-comment">-- also think of it as a callback with a handler (a -&gt; m r).  Category</span><span>
</span><span id="line-165"></span><span class="hs-comment">-- theorists call it a codensity type, a special type of right kan extension.</span><span>
</span><span id="line-166"></span><span class="hs-keyword">type</span><span> </span><span id="YieldK"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#YieldK"><span class="hs-identifier hs-var">YieldK</span></a></span></span><span> </span><span id="local-6989586621679370058"><span class="annot"><a href="#local-6989586621679370058"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679370057"><span class="annot"><a href="#local-6989586621679370057"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679370056"><span class="annot"><a href="#local-6989586621679370056"><span class="hs-identifier hs-type">r</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370057"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370058"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370056"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370058"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370056"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span id="local-6989586621679370626"><span id="local-6989586621679370627"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#_wrapM"><span class="hs-identifier hs-type">_wrapM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370627"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370627"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370626"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#YieldK"><span class="hs-identifier hs-type">YieldK</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370627"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370626"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-169"></span><span id="_wrapM"><span class="annot"><span class="annottext">_wrapM :: forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; YieldK m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#_wrapM"><span class="hs-identifier hs-var hs-var">_wrapM</span></a></span></span><span> </span><span id="local-6989586621679370051"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679370051"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679370051"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span class="hs-comment">-- | Make an empty stream from a stop function.</span><span>
</span><span id="line-172"></span><span id="local-6989586621679370616"><span id="local-6989586621679370618"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromStopK"><span class="hs-identifier hs-type">fromStopK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#StopK"><span class="hs-identifier hs-type">StopK</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370618"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370618"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370616"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-173"></span><span id="fromStopK"><span class="annot"><span class="annottext">fromStopK :: forall (m :: * -&gt; *) a. StopK m -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromStopK"><span class="hs-identifier hs-var hs-var">fromStopK</span></a></span></span><span> </span><span id="local-6989586621679370050"><span class="annot"><span class="annottext">StopK m
</span><a href="#local-6989586621679370050"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679370049"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679370049"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StopK m
</span><a href="#local-6989586621679370050"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679370049"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span class="hs-comment">-- | Make a singleton stream from a callback function. The callback function</span><span>
</span><span id="line-176"></span><span class="hs-comment">-- calls the one-shot yield continuation to yield an element.</span><span>
</span><span id="line-177"></span><span id="local-6989586621679370608"><span id="local-6989586621679370609"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromYieldK"><span class="hs-identifier hs-type">fromYieldK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#YieldK"><span class="hs-identifier hs-type">YieldK</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370609"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370608"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370609"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370608"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-178"></span><span id="fromYieldK"><span class="annot"><span class="annottext">fromYieldK :: forall (m :: * -&gt; *) a. YieldK m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromYieldK"><span class="hs-identifier hs-var hs-var">fromYieldK</span></a></span></span><span> </span><span id="local-6989586621679370048"><span class="annot"><span class="annottext">YieldK m a
</span><a href="#local-6989586621679370048"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679370047"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679370047"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span class="annot"><span class="annottext">m r
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">YieldK m a
</span><a href="#local-6989586621679370048"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679370047"><span class="hs-identifier hs-var">sng</span></a></span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span class="hs-comment">-- | Add a yield function at the head of the stream.</span><span>
</span><span id="line-181"></span><span id="local-6989586621679370603"><span id="local-6989586621679370604"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#consK"><span class="hs-identifier hs-type">consK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#YieldK"><span class="hs-identifier hs-type">YieldK</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370604"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370603"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370604"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370603"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370604"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370603"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-182"></span><span id="consK"><span class="annot"><span class="annottext">consK :: forall (m :: * -&gt; *) a. YieldK m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#consK"><span class="hs-identifier hs-var hs-var">consK</span></a></span></span><span> </span><span id="local-6989586621679370046"><span class="annot"><span class="annottext">YieldK m a
</span><a href="#local-6989586621679370046"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679370045"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679370045"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679370044"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679370044"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">m r
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">YieldK m a
</span><a href="#local-6989586621679370046"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679370044"><span class="hs-operator hs-var">`yld`</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679370045"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span class="hs-comment">-- XXX Build a stream from a repeating callback function.</span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-187"></span><span class="hs-comment">-- Construction</span><span>
</span><span id="line-188"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span class="hs-keyword">infixr</span><span> </span><span class="hs-number">5</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#cons"><span class="hs-operator hs-type">`cons`</span></a></span><span>
</span><span id="line-191"></span><span>
</span><span id="line-192"></span><span class="hs-comment">-- faster than consM because there is no bind.</span><span>
</span><span id="line-193"></span><span class="hs-comment">-- | Construct a stream by adding a pure value at the head of an existing</span><span>
</span><span id="line-194"></span><span class="hs-comment">-- stream. For serial streams this is the same as @(return a) \`consM` r@ but</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- more efficient. For concurrent streams this is not concurrent whereas</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- 'consM' is concurrent. For example:</span><span>
</span><span id="line-197"></span><span class="hs-comment">--</span><span>
</span><span id="line-198"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-199"></span><span class="hs-comment">-- &gt; toList $ 1 \`cons` 2 \`cons` 3 \`cons` nil</span><span>
</span><span id="line-200"></span><span class="hs-comment">-- [1,2,3]</span><span>
</span><span id="line-201"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-202"></span><span class="hs-comment">--</span><span>
</span><span id="line-203"></span><span class="hs-comment">-- @since 0.1.0</span><span>
</span><span id="line-204"></span><span class="hs-pragma">{-# INLINE_NORMAL cons #-}</span><span>
</span><span id="line-205"></span><span id="local-6989586621679370598"><span id="local-6989586621679370599"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#cons"><span class="hs-identifier hs-type">cons</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679370599"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370598"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370599"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370598"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370599"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-206"></span><span id="cons"><span class="annot"><span class="annottext">cons :: forall a (m :: * -&gt; *). a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#cons"><span class="hs-identifier hs-var hs-var">cons</span></a></span></span><span> </span><span id="local-6989586621679370043"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679370043"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679370042"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679370042"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679370041"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679370041"><span class="hs-identifier hs-var">yield</span></a></span></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">m r
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679370041"><span class="hs-identifier hs-var">yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679370043"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679370042"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span class="hs-keyword">infixr</span><span> </span><span class="hs-number">5</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#.%3A"><span class="hs-operator hs-type">.:</span></a></span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span class="hs-comment">-- | Operator equivalent of 'cons'.</span><span>
</span><span id="line-211"></span><span class="hs-comment">--</span><span>
</span><span id="line-212"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-213"></span><span class="hs-comment">-- &gt; toList $ 1 .: 2 .: 3 .: nil</span><span>
</span><span id="line-214"></span><span class="hs-comment">-- [1,2,3]</span><span>
</span><span id="line-215"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-216"></span><span class="hs-comment">--</span><span>
</span><span id="line-217"></span><span class="hs-comment">-- @since 0.1.1</span><span>
</span><span id="line-218"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">.:</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-219"></span><span id="local-6989586621679370039"><span id="local-6989586621679370040"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#.%3A"><span class="hs-operator hs-type">(.:)</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679370040"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370039"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370040"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370039"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370040"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-220"></span><span id=".%3A"><span class="annot"><span class="annottext">.: :: forall a (m :: * -&gt; *). a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#.%3A"><span class="hs-operator hs-var hs-var">(.:)</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *). a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#cons"><span class="hs-identifier hs-var">cons</span></a></span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span class="hs-comment">-- | An empty stream.</span><span>
</span><span id="line-223"></span><span class="hs-comment">--</span><span>
</span><span id="line-224"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-225"></span><span class="hs-comment">-- &gt; toList nil</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- []</span><span>
</span><span id="line-227"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-228"></span><span class="hs-comment">--</span><span>
</span><span id="line-229"></span><span class="hs-comment">-- @since 0.1.0</span><span>
</span><span id="line-230"></span><span class="hs-pragma">{-# INLINE_NORMAL nil #-}</span><span>
</span><span id="line-231"></span><span id="local-6989586621679370593"><span id="local-6989586621679370594"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-identifier hs-type">nil</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370594"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370593"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-232"></span><span id="nil"><span class="annot"><span class="annottext">nil :: forall (m :: * -&gt; *) a. Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-identifier hs-var hs-var">nil</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679370038"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679370038"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679370038"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span class="hs-comment">-- | An empty stream producing a side effect.</span><span>
</span><span id="line-235"></span><span class="hs-comment">--</span><span>
</span><span id="line-236"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-237"></span><span class="hs-comment">-- &gt; toList (nilM (print &quot;nil&quot;))</span><span>
</span><span id="line-238"></span><span class="hs-comment">-- &quot;nil&quot;</span><span>
</span><span id="line-239"></span><span class="hs-comment">-- []</span><span>
</span><span id="line-240"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-241"></span><span class="hs-comment">--</span><span>
</span><span id="line-242"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-243"></span><span class="hs-pragma">{-# INLINE_NORMAL nilM #-}</span><span>
</span><span id="line-244"></span><span id="local-6989586621679370587"><span id="local-6989586621679370588"><span id="local-6989586621679370589"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nilM"><span class="hs-identifier hs-type">nilM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="annot"><a href="#local-6989586621679370589"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370589"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370588"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370589"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370587"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-245"></span><span id="nilM"><span class="annot"><span class="annottext">nilM :: forall (m :: * -&gt; *) b a. Applicative m =&gt; m b -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nilM"><span class="hs-identifier hs-var hs-var">nilM</span></a></span></span><span> </span><span id="local-6989586621679370036"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679370036"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679370034"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679370034"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679370036"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679370034"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span class="hs-pragma">{-# INLINE_NORMAL fromPure #-}</span><span>
</span><span id="line-248"></span><span id="local-6989586621679370578"><span id="local-6989586621679370579"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromPure"><span class="hs-identifier hs-type">fromPure</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679370579"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370578"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370579"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-249"></span><span id="fromPure"><span class="annot"><span class="annottext">fromPure :: forall a (m :: * -&gt; *). a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromPure"><span class="hs-identifier hs-var hs-var">fromPure</span></a></span></span><span> </span><span id="local-6989586621679370033"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679370033"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679370032"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679370032"><span class="hs-identifier hs-var">single</span></a></span></span><span> </span><span class="annot"><span class="annottext">m r
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679370032"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679370033"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span class="hs-pragma">{-# INLINE_NORMAL fromEffect #-}</span><span>
</span><span id="line-252"></span><span id="local-6989586621679370573"><span id="local-6989586621679370574"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromEffect"><span class="hs-identifier hs-type">fromEffect</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370574"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370574"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370573"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370574"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370573"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-253"></span><span id="fromEffect"><span class="annot"><span class="annottext">fromEffect :: forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromEffect"><span class="hs-identifier hs-var hs-var">fromEffect</span></a></span></span><span> </span><span id="local-6989586621679370030"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679370030"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679370028"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679370028"><span class="hs-identifier hs-var">single</span></a></span></span><span> </span><span class="annot"><span class="annottext">m r
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679370030"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679370028"><span class="hs-identifier hs-var">single</span></a></span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span class="hs-keyword">infixr</span><span> </span><span class="hs-number">5</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#consM"><span class="hs-operator hs-type">`consM`</span></a></span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span class="hs-comment">-- NOTE: specializing the function outside the instance definition seems to</span><span>
</span><span id="line-258"></span><span class="hs-comment">-- improve performance quite a bit at times, even if we have the same</span><span>
</span><span id="line-259"></span><span class="hs-comment">-- SPECIALIZE in the instance definition.</span><span>
</span><span id="line-260"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#consM"><span class="hs-pragma hs-type">consM</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-261"></span><span class="hs-pragma">{-# SPECIALIZE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#consM"><span class="hs-pragma hs-type">consM</span></a></span><span> </span><span class="hs-pragma">::</span><span> </span><span id="local-6989586621679370027"><span class="annot"><span class="hs-pragma hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679370027"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><span class="hs-pragma hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679370027"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><span class="hs-pragma hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679370027"><span class="hs-pragma hs-type">a</span></a></span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-262"></span><span id="local-6989586621679370568"><span id="local-6989586621679370569"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#consM"><span class="hs-identifier hs-type">consM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370569"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370569"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370568"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370569"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370568"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370569"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370568"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-263"></span><span id="consM"><span class="annot"><span class="annottext">consM :: forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#consM"><span class="hs-identifier hs-var hs-var">consM</span></a></span></span><span> </span><span id="local-6989586621679370025"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679370025"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621679370024"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679370024"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#MkStream"><span class="hs-identifier hs-var">MkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679370022"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679370022"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">m r
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679370025"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679370022"><span class="hs-operator hs-var">`yld`</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679370024"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span class="hs-comment">-- XXX specialize to IO?</span><span>
</span><span id="line-266"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#consMBy"><span class="hs-pragma hs-type">consMBy</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-267"></span><span id="local-6989586621679370563"><span id="local-6989586621679370564"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#consMBy"><span class="hs-identifier hs-type">consMBy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370564"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370564"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370563"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370564"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370563"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370564"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370563"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370564"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370563"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370564"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370563"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370564"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370563"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-269"></span><span id="consMBy"><span class="annot"><span class="annottext">consMBy :: forall (m :: * -&gt; *) a.
Monad m =&gt;
(Stream m a -&gt; Stream m a -&gt; Stream m a)
-&gt; m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#consMBy"><span class="hs-identifier hs-var hs-var">consMBy</span></a></span></span><span> </span><span id="local-6989586621679370019"><span class="annot"><span class="annottext">Stream m a -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679370019"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679370018"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679370018"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621679370017"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679370017"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromEffect"><span class="hs-identifier hs-var">fromEffect</span></a></span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679370018"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679370019"><span class="hs-operator hs-var">`f`</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679370017"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-272"></span><span class="hs-comment">-- Folding a stream</span><span>
</span><span id="line-273"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span class="hs-comment">-- | Fold a stream by providing an SVar, a stop continuation, a singleton</span><span>
</span><span id="line-276"></span><span class="hs-comment">-- continuation and a yield continuation. The stream would share the current</span><span>
</span><span id="line-277"></span><span class="hs-comment">-- SVar passed via the State.</span><span>
</span><span id="line-278"></span><span class="hs-pragma">{-# INLINE_EARLY foldStreamShared #-}</span><span>
</span><span id="line-279"></span><span id="local-6989586621679370558"><span id="local-6989586621679370559"><span id="local-6989586621679370560"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-type">foldStreamShared</span></a></span><span>
</span><span id="line-280"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.Type.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370560"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370559"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-281"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370559"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370560"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370559"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370560"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370558"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370559"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370560"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370558"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370560"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370558"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-284"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370560"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370559"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-285"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370560"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370558"><span class="hs-identifier hs-type">r</span></a></span></span></span></span><span>
</span><span id="line-286"></span><span id="foldStreamShared"><span class="annot"><span class="annottext">foldStreamShared :: forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var hs-var">foldStreamShared</span></a></span></span><span> </span><span id="local-6989586621679370016"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679370016"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679370015"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679370015"><span class="hs-identifier hs-var">yield</span></a></span></span><span> </span><span id="local-6989586621679370014"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679370014"><span class="hs-identifier hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679370013"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679370013"><span class="hs-identifier hs-var">stop</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#MkStream"><span class="hs-identifier hs-type">MkStream</span></a></span><span> </span><span id="local-6989586621679370012"><span class="annot"><span class="annottext">forall r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r
</span><a href="#local-6989586621679370012"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r
</span><a href="#local-6989586621679370012"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679370016"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679370015"><span class="hs-identifier hs-var">yield</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679370014"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679370013"><span class="hs-identifier hs-var">stop</span></a></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span class="hs-comment">-- | Fold a stream by providing a State, stop continuation, a singleton</span><span>
</span><span id="line-289"></span><span class="hs-comment">-- continuation and a yield continuation. The stream will not use the SVar</span><span>
</span><span id="line-290"></span><span class="hs-comment">-- passed via State.</span><span>
</span><span id="line-291"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-pragma hs-type">foldStream</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-292"></span><span id="local-6989586621679370009"><span id="local-6989586621679370010"><span id="local-6989586621679370011"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-type">foldStream</span></a></span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.Type.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370010"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-294"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370010"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370010"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370009"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370010"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370009"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370009"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-297"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370010"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-298"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370009"><span class="hs-identifier hs-type">r</span></a></span></span></span></span><span>
</span><span id="line-299"></span><span id="foldStream"><span class="annot"><span class="annottext">foldStream :: forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var hs-var">foldStream</span></a></span></span><span> </span><span id="local-6989586621679370008"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679370008"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679370007"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679370007"><span class="hs-identifier hs-var">yield</span></a></span></span><span> </span><span id="local-6989586621679370006"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679370006"><span class="hs-identifier hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679370005"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679370005"><span class="hs-identifier hs-var">stop</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#MkStream"><span class="hs-identifier hs-type">MkStream</span></a></span><span> </span><span id="local-6989586621679370004"><span class="annot"><span class="annottext">forall r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r
</span><a href="#local-6989586621679370004"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-300"></span><span>    </span><span class="annot"><span class="annottext">forall r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r
</span><a href="#local-6989586621679370004"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679370008"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679370007"><span class="hs-identifier hs-var">yield</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679370006"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679370005"><span class="hs-identifier hs-var">stop</span></a></span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-303"></span><span class="hs-comment">-- foldr/build fusion</span><span>
</span><span id="line-304"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span class="hs-comment">-- XXX perhaps we can just use foldrSM/buildM everywhere as they are more</span><span>
</span><span id="line-307"></span><span class="hs-comment">-- general and cover foldrS/buildS as well.</span><span>
</span><span id="line-308"></span><span>
</span><span id="line-309"></span><span class="hs-comment">-- | The function 'f' decides how to reconstruct the stream. We could</span><span>
</span><span id="line-310"></span><span class="hs-comment">-- reconstruct using a shared state (SVar) or without sharing the state.</span><span>
</span><span id="line-311"></span><span class="hs-comment">--</span><span>
</span><span id="line-312"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSWith"><span class="hs-pragma hs-type">foldrSWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-313"></span><span id="local-6989586621679370542"><span id="local-6989586621679370544"><span id="local-6989586621679370545"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSWith"><span class="hs-identifier hs-type">foldrSWith</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-314"></span><span>    </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679370543"><span class="annot"><a href="#local-6989586621679370543"><span class="hs-identifier hs-type">r</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.Type.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370545"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370544"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-315"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370544"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370545"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370544"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370545"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370543"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-316"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370544"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370545"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370543"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370545"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370543"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-318"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370545"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370544"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-319"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370545"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370543"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370542"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370545"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370544"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370545"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370544"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370545"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370544"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-322"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370545"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370542"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-323"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370545"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370544"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-324"></span><span id="foldrSWith"><span class="annot"><span class="annottext">foldrSWith :: forall (m :: * -&gt; *) b a.
(forall r.
 State Stream m b
 -&gt; (b -&gt; Stream m b -&gt; m r)
 -&gt; (b -&gt; m r)
 -&gt; m r
 -&gt; Stream m b
 -&gt; m r)
-&gt; (a -&gt; Stream m b -&gt; Stream m b)
-&gt; Stream m b
-&gt; Stream m a
-&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSWith"><span class="hs-identifier hs-var hs-var">foldrSWith</span></a></span></span><span> </span><span id="local-6989586621679370002"><span class="annot"><span class="annottext">forall r.
State Stream m b
-&gt; (b -&gt; Stream m b -&gt; m r)
-&gt; (b -&gt; m r)
-&gt; m r
-&gt; Stream m b
-&gt; m r
</span><a href="#local-6989586621679370002"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679370001"><span class="annot"><span class="annottext">a -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679370001"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679370000"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679370000"><span class="hs-identifier hs-var">final</span></a></span></span><span> </span><span id="local-6989586621679369999"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369999"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; Stream m b
</span><a href="#local-6989586621679369998"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369999"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-325"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-326"></span><span>    </span><span id="local-6989586621679369998"><span class="annot"><span class="annottext">go :: Stream m a -&gt; Stream m b
</span><a href="#local-6989586621679369998"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679369997"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369997"><span class="hs-identifier hs-var">m1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369996"><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369996"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369995"><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369995"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369994"><span class="annot"><span class="annottext">b -&gt; m r
</span><a href="#local-6989586621679369994"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369993"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369993"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-327"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369992"><span class="annot"><span class="annottext">run :: Stream m b -&gt; m r
</span><a href="#local-6989586621679369992"><span class="hs-identifier hs-var hs-var">run</span></a></span></span><span> </span><span id="local-6989586621679369991"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369991"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall r.
State Stream m b
-&gt; (b -&gt; Stream m b -&gt; m r)
-&gt; (b -&gt; m r)
-&gt; m r
-&gt; Stream m b
-&gt; m r
</span><a href="#local-6989586621679370002"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369996"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369995"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; m r
</span><a href="#local-6989586621679369994"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369993"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369991"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-328"></span><span>            </span><span id="local-6989586621679369990"><span class="annot"><span class="annottext">stop :: m r
</span><a href="#local-6989586621679369990"><span class="hs-identifier hs-var hs-var">stop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369992"><span class="hs-identifier hs-var">run</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679370000"><span class="hs-identifier hs-var">final</span></a></span><span>
</span><span id="line-329"></span><span>            </span><span id="local-6989586621679369989"><span class="annot"><span class="annottext">single :: a -&gt; m r
</span><a href="#local-6989586621679369989"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369988"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369988"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369992"><span class="hs-identifier hs-var">run</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679370001"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369988"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679370000"><span class="hs-identifier hs-var">final</span></a></span><span>
</span><span id="line-330"></span><span>            </span><span id="local-6989586621679369987"><span class="annot"><span class="annottext">yieldk :: a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369987"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369986"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369986"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369985"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369985"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369992"><span class="hs-identifier hs-var">run</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679370001"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369986"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m a -&gt; Stream m b
</span><a href="#local-6989586621679369998"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369985"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-331"></span><span>         </span><span class="hs-comment">-- XXX if type a and b are the same we do not need adaptState, can we</span><span>
</span><span id="line-332"></span><span>         </span><span class="hs-comment">-- save some perf with that?</span><span>
</span><span id="line-333"></span><span>         </span><span class="hs-comment">-- XXX since we are using adaptState anyway here we can use</span><span>
</span><span id="line-334"></span><span>         </span><span class="hs-comment">-- foldStreamShared instead, will that save some perf?</span><span>
</span><span id="line-335"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369996"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369987"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369989"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369990"><span class="hs-identifier hs-var">stop</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369997"><span class="hs-identifier hs-var">m1</span></a></span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span class="hs-comment">-- XXX we can use rewrite rules just for foldrSWith, if the function f is the</span><span>
</span><span id="line-338"></span><span class="hs-comment">-- same we can rewrite it.</span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span class="hs-comment">-- | Fold sharing the SVar state within the reconstructed stream</span><span>
</span><span id="line-341"></span><span class="hs-pragma">{-# INLINE_NORMAL foldrSShared #-}</span><span>
</span><span id="line-342"></span><span id="local-6989586621679370535"><span id="local-6989586621679370536"><span id="local-6989586621679370537"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSShared"><span class="hs-identifier hs-type">foldrSShared</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-343"></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370537"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370536"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370535"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370536"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370535"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370536"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370535"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-345"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370536"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370537"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-346"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370536"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370535"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-347"></span><span id="foldrSShared"><span class="annot"><span class="annottext">foldrSShared :: forall a (m :: * -&gt; *) b.
(a -&gt; Stream m b -&gt; Stream m b)
-&gt; Stream m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSShared"><span class="hs-identifier hs-var hs-var">foldrSShared</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b a.
(forall r.
 State Stream m b
 -&gt; (b -&gt; Stream m b -&gt; m r)
 -&gt; (b -&gt; m r)
 -&gt; m r
 -&gt; Stream m b
 -&gt; m r)
-&gt; (a -&gt; Stream m b -&gt; Stream m b)
-&gt; Stream m b
-&gt; Stream m a
-&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSWith"><span class="hs-identifier hs-var">foldrSWith</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a></span><span>
</span><span id="line-348"></span><span>
</span><span id="line-349"></span><span class="hs-comment">-- XXX consM is a typeclass method, therefore rewritten already. Instead maybe</span><span>
</span><span id="line-350"></span><span class="hs-comment">-- we can make consM polymorphic using rewrite rules.</span><span>
</span><span id="line-351"></span><span class="hs-comment">-- {-# RULES &quot;foldrSShared/id&quot;     foldrSShared consM nil = \x -&gt; x #-}</span><span>
</span><span id="line-352"></span><span class="hs-pragma">{-# RULES</span><span> </span><span class="annot"><span class="hs-pragma">&quot;foldrSShared/nil&quot;</span></span><span>
</span><span id="line-353"></span><span>    </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369984"><span class="annot"><a href="#local-6989586621679369984"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369983"><span class="annot"><a href="#local-6989586621679369983"><span class="hs-pragma hs-var">z</span></a></span></span><span class="hs-pragma">.</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSShared"><span class="hs-pragma hs-type">foldrSShared</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369984"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369983"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-pragma hs-type">nil</span></a></span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369983"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-354"></span><span class="hs-pragma">{-# RULES</span><span> </span><span class="annot"><span class="hs-pragma">&quot;foldrSShared/single&quot;</span></span><span>
</span><span id="line-355"></span><span>    </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369982"><span class="annot"><a href="#local-6989586621679369982"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369981"><span class="annot"><a href="#local-6989586621679369981"><span class="hs-pragma hs-var">z</span></a></span></span><span> </span><span id="local-6989586621679369980"><span class="annot"><a href="#local-6989586621679369980"><span class="hs-pragma hs-var">x</span></a></span></span><span class="hs-pragma">.</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSShared"><span class="hs-pragma hs-type">foldrSShared</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369982"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369981"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromPure"><span class="hs-pragma hs-type">fromPure</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369980"><span class="hs-pragma hs-type">x</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369982"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369980"><span class="hs-pragma hs-type">x</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369981"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-356"></span><span class="hs-comment">-- {-# RULES &quot;foldrSShared/app&quot; [1]</span><span>
</span><span id="line-357"></span><span class="hs-comment">--     forall ys. foldrSShared consM ys = \xs -&gt; xs `conjoin` ys #-}</span><span>
</span><span id="line-358"></span><span>
</span><span id="line-359"></span><span class="hs-comment">-- | Lazy right associative fold to a stream.</span><span>
</span><span id="line-360"></span><span class="hs-pragma">{-# INLINE_NORMAL foldrS #-}</span><span>
</span><span id="line-361"></span><span id="local-6989586621679369977"><span id="local-6989586621679369978"><span id="local-6989586621679369979"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrS"><span class="hs-identifier hs-type">foldrS</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-362"></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679369979"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369978"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369977"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369978"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369977"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-363"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369978"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369977"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-364"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369978"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369979"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-365"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369978"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369977"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-366"></span><span id="foldrS"><span class="annot"><span class="annottext">foldrS :: forall a (m :: * -&gt; *) b.
(a -&gt; Stream m b -&gt; Stream m b)
-&gt; Stream m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrS"><span class="hs-identifier hs-var hs-var">foldrS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b a.
(forall r.
 State Stream m b
 -&gt; (b -&gt; Stream m b -&gt; m r)
 -&gt; (b -&gt; m r)
 -&gt; m r
 -&gt; Stream m b
 -&gt; m r)
-&gt; (a -&gt; Stream m b -&gt; Stream m b)
-&gt; Stream m b
-&gt; Stream m a
-&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSWith"><span class="hs-identifier hs-var">foldrSWith</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span>
</span><span id="line-367"></span><span>
</span><span id="line-368"></span><span class="hs-pragma">{-# RULES</span><span> </span><span class="annot"><span class="hs-pragma">&quot;foldrS/id&quot;</span></span><span>     </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrS"><span class="hs-pragma hs-type">foldrS</span></a></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#cons"><span class="hs-pragma hs-type">cons</span></a></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-pragma hs-type">nil</span></a></span><span> </span><span class="hs-pragma">=</span><span> </span><span class="hs-pragma">\</span><span id="local-6989586621679369976"><span class="annot"><a href="#local-6989586621679369976"><span class="hs-pragma hs-var">x</span></a></span></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369976"><span class="hs-pragma hs-type">x</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-369"></span><span class="hs-pragma">{-# RULES</span><span> </span><span class="annot"><span class="hs-pragma">&quot;foldrS/nil&quot;</span></span><span>    </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369975"><span class="annot"><a href="#local-6989586621679369975"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369974"><span class="annot"><a href="#local-6989586621679369974"><span class="hs-pragma hs-var">z</span></a></span></span><span class="hs-pragma">.</span><span>   </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrS"><span class="hs-pragma hs-type">foldrS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369975"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369974"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-pragma hs-type">nil</span></a></span><span>  </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369974"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-370"></span><span class="hs-comment">-- See notes in GHC.Base about this rule</span><span>
</span><span id="line-371"></span><span class="hs-comment">-- {-# RULES &quot;foldr/cons&quot;</span><span>
</span><span id="line-372"></span><span class="hs-comment">--  forall k z x xs. foldrS k z (x `cons` xs) = k x (foldrS k z xs) #-}</span><span>
</span><span id="line-373"></span><span class="hs-pragma">{-# RULES</span><span> </span><span class="annot"><span class="hs-pragma">&quot;foldrS/single&quot;</span></span><span> </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369973"><span class="annot"><a href="#local-6989586621679369973"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369972"><span class="annot"><a href="#local-6989586621679369972"><span class="hs-pragma hs-var">z</span></a></span></span><span> </span><span id="local-6989586621679369971"><span class="annot"><a href="#local-6989586621679369971"><span class="hs-pragma hs-var">x</span></a></span></span><span class="hs-pragma">.</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrS"><span class="hs-pragma hs-type">foldrS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369973"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369972"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromPure"><span class="hs-pragma hs-type">fromPure</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369971"><span class="hs-pragma hs-type">x</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369973"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369971"><span class="hs-pragma hs-type">x</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369972"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-374"></span><span class="hs-comment">-- {-# RULES &quot;foldrS/app&quot; [1]</span><span>
</span><span id="line-375"></span><span class="hs-comment">--  forall ys. foldrS cons ys = \xs -&gt; xs `conjoin` ys #-}</span><span>
</span><span id="line-376"></span><span>
</span><span id="line-377"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-378"></span><span class="hs-comment">-- foldrS with monadic cons i.e. consM</span><span>
</span><span id="line-379"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-380"></span><span>
</span><span id="line-381"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSMWith"><span class="hs-pragma hs-type">foldrSMWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-382"></span><span id="local-6989586621679370531"><span id="local-6989586621679370533"><span id="local-6989586621679370534"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSMWith"><span class="hs-identifier hs-type">foldrSMWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370534"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-383"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679370532"><span class="annot"><a href="#local-6989586621679370532"><span class="hs-identifier hs-type">r</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.Type.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370534"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370533"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-384"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370533"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370534"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370533"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370534"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370532"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-385"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370533"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370534"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370532"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-386"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370534"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370532"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-387"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370534"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370533"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-388"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370534"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370532"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-389"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370534"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370531"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370534"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370533"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370534"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370533"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-390"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370534"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370533"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-391"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370534"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370531"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-392"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370534"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370533"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-393"></span><span id="foldrSMWith"><span class="annot"><span class="annottext">foldrSMWith :: forall (m :: * -&gt; *) b a.
Monad m =&gt;
(forall r.
 State Stream m b
 -&gt; (b -&gt; Stream m b -&gt; m r)
 -&gt; (b -&gt; m r)
 -&gt; m r
 -&gt; Stream m b
 -&gt; m r)
-&gt; (m a -&gt; Stream m b -&gt; Stream m b)
-&gt; Stream m b
-&gt; Stream m a
-&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSMWith"><span class="hs-identifier hs-var hs-var">foldrSMWith</span></a></span></span><span> </span><span id="local-6989586621679369968"><span class="annot"><span class="annottext">forall r.
State Stream m b
-&gt; (b -&gt; Stream m b -&gt; m r)
-&gt; (b -&gt; m r)
-&gt; m r
-&gt; Stream m b
-&gt; m r
</span><a href="#local-6989586621679369968"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679369967"><span class="annot"><span class="annottext">m a -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369967"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679369966"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369966"><span class="hs-identifier hs-var">final</span></a></span></span><span> </span><span id="local-6989586621679369965"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369965"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; Stream m b
</span><a href="#local-6989586621679369964"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369965"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-394"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-395"></span><span>    </span><span id="local-6989586621679369964"><span class="annot"><span class="annottext">go :: Stream m a -&gt; Stream m b
</span><a href="#local-6989586621679369964"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679369963"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369963"><span class="hs-identifier hs-var">m1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369962"><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369962"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369961"><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369961"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369960"><span class="annot"><span class="annottext">b -&gt; m r
</span><a href="#local-6989586621679369960"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369959"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369959"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-396"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369958"><span class="annot"><span class="annottext">run :: Stream m b -&gt; m r
</span><a href="#local-6989586621679369958"><span class="hs-identifier hs-var hs-var">run</span></a></span></span><span> </span><span id="local-6989586621679369957"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369957"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall r.
State Stream m b
-&gt; (b -&gt; Stream m b -&gt; m r)
-&gt; (b -&gt; m r)
-&gt; m r
-&gt; Stream m b
-&gt; m r
</span><a href="#local-6989586621679369968"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369962"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369961"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; m r
</span><a href="#local-6989586621679369960"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369959"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369957"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-397"></span><span>            </span><span id="local-6989586621679369956"><span class="annot"><span class="annottext">stop :: m r
</span><a href="#local-6989586621679369956"><span class="hs-identifier hs-var hs-var">stop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369958"><span class="hs-identifier hs-var">run</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369966"><span class="hs-identifier hs-var">final</span></a></span><span>
</span><span id="line-398"></span><span>            </span><span id="local-6989586621679369954"><span class="annot"><span class="annottext">single :: a -&gt; m r
</span><a href="#local-6989586621679369954"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369953"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369953"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369958"><span class="hs-identifier hs-var">run</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">m a -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369967"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369953"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369966"><span class="hs-identifier hs-var">final</span></a></span><span>
</span><span id="line-399"></span><span>            </span><span id="local-6989586621679369951"><span class="annot"><span class="annottext">yieldk :: a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369951"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369950"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369950"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369949"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369949"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369958"><span class="hs-identifier hs-var">run</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">m a -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369967"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369950"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m a -&gt; Stream m b
</span><a href="#local-6989586621679369964"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369949"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-400"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369962"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369951"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369954"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369956"><span class="hs-identifier hs-var">stop</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369963"><span class="hs-identifier hs-var">m1</span></a></span><span>
</span><span id="line-401"></span><span>
</span><span id="line-402"></span><span class="hs-pragma">{-# INLINE_NORMAL foldrSM #-}</span><span>
</span><span id="line-403"></span><span id="local-6989586621679370523"><span id="local-6989586621679370524"><span id="local-6989586621679370525"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSM"><span class="hs-identifier hs-type">foldrSM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370525"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-404"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370525"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370524"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370525"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370523"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370525"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370523"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370525"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370523"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-406"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370525"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370524"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-407"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370525"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370523"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-408"></span><span id="foldrSM"><span class="annot"><span class="annottext">foldrSM :: forall (m :: * -&gt; *) a b.
Monad m =&gt;
(m a -&gt; Stream m b -&gt; Stream m b)
-&gt; Stream m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSM"><span class="hs-identifier hs-var hs-var">foldrSM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b a.
Monad m =&gt;
(forall r.
 State Stream m b
 -&gt; (b -&gt; Stream m b -&gt; m r)
 -&gt; (b -&gt; m r)
 -&gt; m r
 -&gt; Stream m b
 -&gt; m r)
-&gt; (m a -&gt; Stream m b -&gt; Stream m b)
-&gt; Stream m b
-&gt; Stream m a
-&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSMWith"><span class="hs-identifier hs-var">foldrSMWith</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span>
</span><span id="line-409"></span><span>
</span><span id="line-410"></span><span class="hs-comment">-- {-# RULES &quot;foldrSM/id&quot;     foldrSM consM nil = \x -&gt; x #-}</span><span>
</span><span id="line-411"></span><span class="hs-pragma">{-# RULES</span><span> </span><span class="annot"><span class="hs-pragma">&quot;foldrSM/nil&quot;</span></span><span>    </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369946"><span class="annot"><a href="#local-6989586621679369946"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369945"><span class="annot"><a href="#local-6989586621679369945"><span class="hs-pragma hs-var">z</span></a></span></span><span class="hs-pragma">.</span><span>   </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSM"><span class="hs-pragma hs-type">foldrSM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369946"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369945"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-pragma hs-type">nil</span></a></span><span>  </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369945"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-412"></span><span class="hs-pragma">{-# RULES</span><span> </span><span class="annot"><span class="hs-pragma">&quot;foldrSM/single&quot;</span></span><span> </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369944"><span class="annot"><a href="#local-6989586621679369944"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369943"><span class="annot"><a href="#local-6989586621679369943"><span class="hs-pragma hs-var">z</span></a></span></span><span> </span><span id="local-6989586621679369942"><span class="annot"><a href="#local-6989586621679369942"><span class="hs-pragma hs-var">x</span></a></span></span><span class="hs-pragma">.</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSM"><span class="hs-pragma hs-type">foldrSM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369944"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369943"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromEffect"><span class="hs-pragma hs-type">fromEffect</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369942"><span class="hs-pragma hs-type">x</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369944"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369942"><span class="hs-pragma hs-type">x</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369943"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-413"></span><span class="hs-comment">-- {-# RULES &quot;foldrSM/app&quot; [1]</span><span>
</span><span id="line-414"></span><span class="hs-comment">--  forall ys. foldrSM consM ys = \xs -&gt; xs `conjoin` ys #-}</span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span class="hs-comment">-- Like foldrSM but sharing the SVar state within the recostructed stream.</span><span>
</span><span id="line-417"></span><span class="hs-pragma">{-# INLINE_NORMAL foldrSMShared #-}</span><span>
</span><span id="line-418"></span><span id="local-6989586621679369938"><span id="local-6989586621679369939"><span id="local-6989586621679369940"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSMShared"><span class="hs-identifier hs-type">foldrSMShared</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679369940"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-419"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679369940"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369939"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369940"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369938"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369940"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369938"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-420"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369940"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369938"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-421"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369940"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369939"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-422"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369940"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369938"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-423"></span><span id="foldrSMShared"><span class="annot"><span class="annottext">foldrSMShared :: forall (m :: * -&gt; *) a b.
Monad m =&gt;
(m a -&gt; Stream m b -&gt; Stream m b)
-&gt; Stream m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSMShared"><span class="hs-identifier hs-var hs-var">foldrSMShared</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b a.
Monad m =&gt;
(forall r.
 State Stream m b
 -&gt; (b -&gt; Stream m b -&gt; m r)
 -&gt; (b -&gt; m r)
 -&gt; m r
 -&gt; Stream m b
 -&gt; m r)
-&gt; (m a -&gt; Stream m b -&gt; Stream m b)
-&gt; Stream m b
-&gt; Stream m a
-&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSMWith"><span class="hs-identifier hs-var">foldrSMWith</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a></span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span class="hs-comment">-- {-# RULES &quot;foldrSM/id&quot;     foldrSM consM nil = \x -&gt; x #-}</span><span>
</span><span id="line-426"></span><span class="hs-pragma">{-# RULES</span><span> </span><span class="annot"><span class="hs-pragma">&quot;foldrSMShared/nil&quot;</span></span><span>
</span><span id="line-427"></span><span>    </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369935"><span class="annot"><a href="#local-6989586621679369935"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369934"><span class="annot"><a href="#local-6989586621679369934"><span class="hs-pragma hs-var">z</span></a></span></span><span class="hs-pragma">.</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSMShared"><span class="hs-pragma hs-type">foldrSMShared</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369935"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369934"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-pragma hs-type">nil</span></a></span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369934"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-428"></span><span class="hs-pragma">{-# RULES</span><span> </span><span class="annot"><span class="hs-pragma">&quot;foldrSMShared/single&quot;</span></span><span>
</span><span id="line-429"></span><span>    </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369933"><span class="annot"><a href="#local-6989586621679369933"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369932"><span class="annot"><a href="#local-6989586621679369932"><span class="hs-pragma hs-var">z</span></a></span></span><span> </span><span id="local-6989586621679369931"><span class="annot"><a href="#local-6989586621679369931"><span class="hs-pragma hs-var">x</span></a></span></span><span class="hs-pragma">.</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSMShared"><span class="hs-pragma hs-type">foldrSMShared</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369933"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369932"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromEffect"><span class="hs-pragma hs-type">fromEffect</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369931"><span class="hs-pragma hs-type">x</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369933"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369931"><span class="hs-pragma hs-type">x</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369932"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-430"></span><span class="hs-comment">-- {-# RULES &quot;foldrSM/app&quot; [1]</span><span>
</span><span id="line-431"></span><span class="hs-comment">--  forall ys. foldrSM consM ys = \xs -&gt; xs `conjoin` ys #-}</span><span>
</span><span id="line-432"></span><span>
</span><span id="line-433"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-434"></span><span class="hs-comment">-- build</span><span>
</span><span id="line-435"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-436"></span><span>
</span><span id="line-437"></span><span class="hs-pragma">{-# INLINE_NORMAL build #-}</span><span>
</span><span id="line-438"></span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#build"><span class="hs-identifier hs-type">build</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679370518"><span class="annot"><a href="#local-6989586621679370518"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679370520"><span class="annot"><a href="#local-6989586621679370520"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679370519"><span class="annot"><a href="#local-6989586621679370519"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370520"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370519"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370519"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370519"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370519"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370518"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370520"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-439"></span><span id="build"><span class="annot"><span class="annottext">build :: forall (m :: * -&gt; *) a.
(forall b. (a -&gt; b -&gt; b) -&gt; b -&gt; b) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#build"><span class="hs-identifier hs-var hs-var">build</span></a></span></span><span> </span><span id="local-6989586621679369930"><span class="annot"><span class="annottext">forall b. (a -&gt; b -&gt; b) -&gt; b -&gt; b
</span><a href="#local-6989586621679369930"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b. (a -&gt; b -&gt; b) -&gt; b -&gt; b
</span><a href="#local-6989586621679369930"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *). a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#cons"><span class="hs-identifier hs-var">cons</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-identifier hs-var">nil</span></a></span><span>
</span><span id="line-440"></span><span>
</span><span id="line-441"></span><span class="hs-pragma">{-# RULES</span><span> </span><span id="local-6989586621679369929"><span class="annot"><span class="hs-pragma">&quot;foldrM/build&quot;</span></span><span>
</span><span id="line-442"></span><span>    </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369928"><span class="annot"><a href="#local-6989586621679369928"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369927"><span class="annot"><a href="#local-6989586621679369927"><span class="hs-pragma hs-var">z</span></a></span></span><span> </span><span class="hs-pragma">(</span><span id="local-6989586621679369926"><span class="annot"><a href="#local-6989586621679369926"><span class="hs-pragma hs-var">g</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369925"><span class="annot"><a href="#local-6989586621679369925"><span class="hs-pragma hs-type">b</span></a></span></span><span class="hs-pragma">.</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369929"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369925"><span class="hs-pragma hs-type">b</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369925"><span class="hs-pragma hs-type">b</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369925"><span class="hs-pragma hs-type">b</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369925"><span class="hs-pragma hs-type">b</span></a></span><span class="hs-pragma">)</span><span class="hs-pragma">.</span><span>
</span><span id="line-443"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrM"><span class="hs-pragma hs-type">foldrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369928"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369927"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#build"><span class="hs-pragma hs-type">build</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369926"><span class="hs-pragma hs-type">g</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369926"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369928"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369927"><span class="hs-pragma hs-type">z</span></a></span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-444"></span><span>
</span><span id="line-445"></span><span class="hs-pragma">{-# RULES</span><span> </span><span id="local-6989586621679369924"><span class="annot"><span class="hs-pragma">&quot;foldrS/build&quot;</span></span><span>
</span><span id="line-446"></span><span>      </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369923"><span class="annot"><a href="#local-6989586621679369923"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369922"><span class="annot"><a href="#local-6989586621679369922"><span class="hs-pragma hs-var">z</span></a></span></span><span> </span><span class="hs-pragma">(</span><span id="local-6989586621679369921"><span class="annot"><a href="#local-6989586621679369921"><span class="hs-pragma hs-var">g</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369920"><span class="annot"><a href="#local-6989586621679369920"><span class="hs-pragma hs-type">b</span></a></span></span><span class="hs-pragma">.</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369924"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369920"><span class="hs-pragma hs-type">b</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369920"><span class="hs-pragma hs-type">b</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369920"><span class="hs-pragma hs-type">b</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369920"><span class="hs-pragma hs-type">b</span></a></span><span class="hs-pragma">)</span><span class="hs-pragma">.</span><span>
</span><span id="line-447"></span><span>      </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrS"><span class="hs-pragma hs-type">foldrS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369923"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369922"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#build"><span class="hs-pragma hs-type">build</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369921"><span class="hs-pragma hs-type">g</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369921"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369923"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369922"><span class="hs-pragma hs-type">z</span></a></span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-448"></span><span>
</span><span id="line-449"></span><span class="hs-pragma">{-# RULES</span><span> </span><span id="local-6989586621679369919"><span class="annot"><span class="hs-pragma">&quot;foldrS/cons/build&quot;</span></span><span>
</span><span id="line-450"></span><span>      </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369918"><span class="annot"><a href="#local-6989586621679369918"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369917"><span class="annot"><a href="#local-6989586621679369917"><span class="hs-pragma hs-var">z</span></a></span></span><span> </span><span id="local-6989586621679369916"><span class="annot"><a href="#local-6989586621679369916"><span class="hs-pragma hs-var">x</span></a></span></span><span> </span><span class="hs-pragma">(</span><span id="local-6989586621679369915"><span class="annot"><a href="#local-6989586621679369915"><span class="hs-pragma hs-var">g</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369914"><span class="annot"><a href="#local-6989586621679369914"><span class="hs-pragma hs-type">b</span></a></span></span><span class="hs-pragma">.</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369919"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369914"><span class="hs-pragma hs-type">b</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369914"><span class="hs-pragma hs-type">b</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369914"><span class="hs-pragma hs-type">b</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369914"><span class="hs-pragma hs-type">b</span></a></span><span class="hs-pragma">)</span><span class="hs-pragma">.</span><span>
</span><span id="line-451"></span><span>      </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrS"><span class="hs-pragma hs-type">foldrS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369918"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369917"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369916"><span class="hs-pragma hs-type">x</span></a></span><span> </span><span class="hs-pragma">`</span><span class="hs-pragma">cons</span><span class="hs-pragma">`</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#build"><span class="hs-pragma hs-type">build</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369915"><span class="hs-pragma hs-type">g</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369918"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369916"><span class="hs-pragma hs-type">x</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369915"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369918"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369917"><span class="hs-pragma hs-type">z</span></a></span><span class="hs-pragma">)</span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-452"></span><span>
</span><span id="line-453"></span><span class="hs-pragma">{-# RULES</span><span> </span><span id="local-6989586621679369913"><span class="annot"><span class="hs-pragma">&quot;foldrSShared/build&quot;</span></span><span>
</span><span id="line-454"></span><span>      </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369912"><span class="annot"><a href="#local-6989586621679369912"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369911"><span class="annot"><a href="#local-6989586621679369911"><span class="hs-pragma hs-var">z</span></a></span></span><span> </span><span class="hs-pragma">(</span><span id="local-6989586621679369910"><span class="annot"><a href="#local-6989586621679369910"><span class="hs-pragma hs-var">g</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369909"><span class="annot"><a href="#local-6989586621679369909"><span class="hs-pragma hs-type">b</span></a></span></span><span class="hs-pragma">.</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369913"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369909"><span class="hs-pragma hs-type">b</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369909"><span class="hs-pragma hs-type">b</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369909"><span class="hs-pragma hs-type">b</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369909"><span class="hs-pragma hs-type">b</span></a></span><span class="hs-pragma">)</span><span class="hs-pragma">.</span><span>
</span><span id="line-455"></span><span>      </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSShared"><span class="hs-pragma hs-type">foldrSShared</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369912"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369911"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#build"><span class="hs-pragma hs-type">build</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369910"><span class="hs-pragma hs-type">g</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369910"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369912"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369911"><span class="hs-pragma hs-type">z</span></a></span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-456"></span><span>
</span><span id="line-457"></span><span class="hs-pragma">{-# RULES</span><span> </span><span id="local-6989586621679369908"><span class="annot"><span class="hs-pragma">&quot;foldrSShared/cons/build&quot;</span></span><span>
</span><span id="line-458"></span><span>      </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369907"><span class="annot"><a href="#local-6989586621679369907"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369906"><span class="annot"><a href="#local-6989586621679369906"><span class="hs-pragma hs-var">z</span></a></span></span><span> </span><span id="local-6989586621679369905"><span class="annot"><a href="#local-6989586621679369905"><span class="hs-pragma hs-var">x</span></a></span></span><span> </span><span class="hs-pragma">(</span><span id="local-6989586621679369904"><span class="annot"><a href="#local-6989586621679369904"><span class="hs-pragma hs-var">g</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369903"><span class="annot"><a href="#local-6989586621679369903"><span class="hs-pragma hs-type">b</span></a></span></span><span class="hs-pragma">.</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369908"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369903"><span class="hs-pragma hs-type">b</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369903"><span class="hs-pragma hs-type">b</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369903"><span class="hs-pragma hs-type">b</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369903"><span class="hs-pragma hs-type">b</span></a></span><span class="hs-pragma">)</span><span class="hs-pragma">.</span><span>
</span><span id="line-459"></span><span>      </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSShared"><span class="hs-pragma hs-type">foldrSShared</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369907"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369906"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369905"><span class="hs-pragma hs-type">x</span></a></span><span> </span><span class="hs-pragma">`</span><span class="hs-pragma">cons</span><span class="hs-pragma">`</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#build"><span class="hs-pragma hs-type">build</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369904"><span class="hs-pragma hs-type">g</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369907"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369905"><span class="hs-pragma hs-type">x</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369904"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369907"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369906"><span class="hs-pragma hs-type">z</span></a></span><span class="hs-pragma">)</span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-460"></span><span>
</span><span id="line-461"></span><span class="hs-comment">-- build a stream by applying cons and nil to a build function</span><span>
</span><span id="line-462"></span><span class="hs-pragma">{-# INLINE_NORMAL buildS #-}</span><span>
</span><span id="line-463"></span><span id="local-6989586621679370515"><span id="local-6989586621679370516"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildS"><span class="hs-identifier hs-type">buildS</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-464"></span><span>       </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370516"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370515"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370516"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370515"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370516"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370515"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370516"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370515"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370516"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-465"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370515"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370516"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-466"></span><span id="buildS"><span class="annot"><span class="annottext">buildS :: forall a (m :: * -&gt; *).
((a -&gt; Stream m a -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildS"><span class="hs-identifier hs-var hs-var">buildS</span></a></span></span><span> </span><span id="local-6989586621679369902"><span class="annot"><span class="annottext">(a -&gt; Stream m a -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369902"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; Stream m a -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369902"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *). a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#cons"><span class="hs-identifier hs-var">cons</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-identifier hs-var">nil</span></a></span><span>
</span><span id="line-467"></span><span>
</span><span id="line-468"></span><span class="hs-pragma">{-# RULES</span><span> </span><span id="local-6989586621679369900"><span id="local-6989586621679369901"><span class="annot"><span class="hs-pragma">&quot;foldrS/buildS&quot;</span></span><span>
</span><span id="line-469"></span><span>      </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369899"><span class="annot"><a href="#local-6989586621679369899"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369898"><span class="annot"><a href="#local-6989586621679369898"><span class="hs-pragma hs-var">z</span></a></span></span><span>
</span><span id="line-470"></span><span>        </span><span class="hs-pragma">(</span><span id="local-6989586621679369897"><span class="annot"><a href="#local-6989586621679369897"><span class="hs-pragma hs-var">g</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369901"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369900"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369901"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369900"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369901"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369900"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369901"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369900"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369901"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span class="hs-pragma">.</span><span>
</span><span id="line-471"></span><span>      </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrS"><span class="hs-pragma hs-type">foldrS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369899"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369898"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildS"><span class="hs-pragma hs-type">buildS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369897"><span class="hs-pragma hs-type">g</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369897"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369899"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369898"><span class="hs-pragma hs-type">z</span></a></span></span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-472"></span><span>
</span><span id="line-473"></span><span class="hs-pragma">{-# RULES</span><span> </span><span id="local-6989586621679369895"><span id="local-6989586621679369896"><span class="annot"><span class="hs-pragma">&quot;foldrS/cons/buildS&quot;</span></span><span>
</span><span id="line-474"></span><span>      </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369894"><span class="annot"><a href="#local-6989586621679369894"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369893"><span class="annot"><a href="#local-6989586621679369893"><span class="hs-pragma hs-var">z</span></a></span></span><span> </span><span id="local-6989586621679369892"><span class="annot"><a href="#local-6989586621679369892"><span class="hs-pragma hs-var">x</span></a></span></span><span>
</span><span id="line-475"></span><span>        </span><span class="hs-pragma">(</span><span id="local-6989586621679369891"><span class="annot"><a href="#local-6989586621679369891"><span class="hs-pragma hs-var">g</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369896"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369895"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369896"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369895"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369896"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369895"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369896"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369895"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369896"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span class="hs-pragma">.</span><span>
</span><span id="line-476"></span><span>      </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrS"><span class="hs-pragma hs-type">foldrS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369894"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369893"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369892"><span class="hs-pragma hs-type">x</span></a></span><span> </span><span class="hs-pragma">`</span><span class="hs-pragma">cons</span><span class="hs-pragma">`</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildS"><span class="hs-pragma hs-type">buildS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369891"><span class="hs-pragma hs-type">g</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369894"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369892"><span class="hs-pragma hs-type">x</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369891"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369894"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369893"><span class="hs-pragma hs-type">z</span></a></span><span class="hs-pragma">)</span></span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-477"></span><span>
</span><span id="line-478"></span><span class="hs-pragma">{-# RULES</span><span> </span><span id="local-6989586621679369889"><span id="local-6989586621679369890"><span class="annot"><span class="hs-pragma">&quot;foldrSShared/buildS&quot;</span></span><span>
</span><span id="line-479"></span><span>      </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369888"><span class="annot"><a href="#local-6989586621679369888"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369887"><span class="annot"><a href="#local-6989586621679369887"><span class="hs-pragma hs-var">z</span></a></span></span><span>
</span><span id="line-480"></span><span>        </span><span class="hs-pragma">(</span><span id="local-6989586621679369886"><span class="annot"><a href="#local-6989586621679369886"><span class="hs-pragma hs-var">g</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369890"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369889"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369890"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369889"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369890"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369889"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369890"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369889"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369890"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span class="hs-pragma">.</span><span>
</span><span id="line-481"></span><span>      </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSShared"><span class="hs-pragma hs-type">foldrSShared</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369888"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369887"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildS"><span class="hs-pragma hs-type">buildS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369886"><span class="hs-pragma hs-type">g</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369886"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369888"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369887"><span class="hs-pragma hs-type">z</span></a></span></span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-482"></span><span>
</span><span id="line-483"></span><span class="hs-pragma">{-# RULES</span><span> </span><span id="local-6989586621679369884"><span id="local-6989586621679369885"><span class="annot"><span class="hs-pragma">&quot;foldrSShared/cons/buildS&quot;</span></span><span>
</span><span id="line-484"></span><span>      </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369883"><span class="annot"><a href="#local-6989586621679369883"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369882"><span class="annot"><a href="#local-6989586621679369882"><span class="hs-pragma hs-var">z</span></a></span></span><span> </span><span id="local-6989586621679369881"><span class="annot"><a href="#local-6989586621679369881"><span class="hs-pragma hs-var">x</span></a></span></span><span>
</span><span id="line-485"></span><span>        </span><span class="hs-pragma">(</span><span id="local-6989586621679369880"><span class="annot"><a href="#local-6989586621679369880"><span class="hs-pragma hs-var">g</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369885"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369884"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369885"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369884"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369885"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369884"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369885"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369884"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369885"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span class="hs-pragma">.</span><span>
</span><span id="line-486"></span><span>      </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSShared"><span class="hs-pragma hs-type">foldrSShared</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369883"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369882"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369881"><span class="hs-pragma hs-type">x</span></a></span><span> </span><span class="hs-pragma">`</span><span class="hs-pragma">cons</span><span class="hs-pragma">`</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildS"><span class="hs-pragma hs-type">buildS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369880"><span class="hs-pragma hs-type">g</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369883"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369881"><span class="hs-pragma hs-type">x</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369880"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369883"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369882"><span class="hs-pragma hs-type">z</span></a></span><span class="hs-pragma">)</span></span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span class="hs-comment">-- build a stream by applying consM and nil to a build function</span><span>
</span><span id="line-489"></span><span class="hs-pragma">{-# INLINE_NORMAL buildSM #-}</span><span>
</span><span id="line-490"></span><span id="local-6989586621679370511"><span id="local-6989586621679370512"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildSM"><span class="hs-identifier hs-type">buildSM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370512"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-491"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370512"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370511"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370512"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370511"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370512"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370511"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370512"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370511"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370512"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370511"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-492"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370512"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370511"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-493"></span><span id="buildSM"><span class="annot"><span class="annottext">buildSM :: forall (m :: * -&gt; *) a.
Monad m =&gt;
((m a -&gt; Stream m a -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildSM"><span class="hs-identifier hs-var hs-var">buildSM</span></a></span></span><span> </span><span id="local-6989586621679369877"><span class="annot"><span class="annottext">(m a -&gt; Stream m a -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369877"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(m a -&gt; Stream m a -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369877"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#consM"><span class="hs-identifier hs-var">consM</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-identifier hs-var">nil</span></a></span><span>
</span><span id="line-494"></span><span>
</span><span id="line-495"></span><span class="hs-pragma">{-# RULES</span><span> </span><span id="local-6989586621679369875"><span id="local-6989586621679369876"><span class="annot"><span class="hs-pragma">&quot;foldrSM/buildSM&quot;</span></span><span>
</span><span id="line-496"></span><span>     </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369874"><span class="annot"><a href="#local-6989586621679369874"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369873"><span class="annot"><a href="#local-6989586621679369873"><span class="hs-pragma hs-var">z</span></a></span></span><span>
</span><span id="line-497"></span><span>        </span><span class="hs-pragma">(</span><span id="local-6989586621679369872"><span class="annot"><a href="#local-6989586621679369872"><span class="hs-pragma hs-var">g</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369876"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369875"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369876"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369875"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369876"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369875"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369876"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369875"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369876"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369875"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span class="hs-pragma">.</span><span>
</span><span id="line-498"></span><span>     </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSM"><span class="hs-pragma hs-type">foldrSM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369874"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369873"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildSM"><span class="hs-pragma hs-type">buildSM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369872"><span class="hs-pragma hs-type">g</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369872"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369874"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369873"><span class="hs-pragma hs-type">z</span></a></span></span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-499"></span><span>
</span><span id="line-500"></span><span class="hs-pragma">{-# RULES</span><span> </span><span id="local-6989586621679369870"><span id="local-6989586621679369871"><span class="annot"><span class="hs-pragma">&quot;foldrSMShared/buildSM&quot;</span></span><span>
</span><span id="line-501"></span><span>     </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369869"><span class="annot"><a href="#local-6989586621679369869"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369868"><span class="annot"><a href="#local-6989586621679369868"><span class="hs-pragma hs-var">z</span></a></span></span><span>
</span><span id="line-502"></span><span>        </span><span class="hs-pragma">(</span><span id="local-6989586621679369867"><span class="annot"><a href="#local-6989586621679369867"><span class="hs-pragma hs-var">g</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369871"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369870"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369871"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369870"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369871"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369870"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369871"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369870"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369871"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369870"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span class="hs-pragma">.</span><span>
</span><span id="line-503"></span><span>     </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSMShared"><span class="hs-pragma hs-type">foldrSMShared</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369869"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369868"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildSM"><span class="hs-pragma hs-type">buildSM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369867"><span class="hs-pragma hs-type">g</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369867"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369869"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369868"><span class="hs-pragma hs-type">z</span></a></span></span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-504"></span><span>
</span><span id="line-505"></span><span class="hs-comment">-- Disabled because this may not fire as consM is a class Op</span><span>
</span><span id="line-506"></span><span class="hs-comment">{-
{-# RULES &quot;foldrS/consM/buildSM&quot;
      forall k z x (g :: (m a -&gt; t m a -&gt; t m a) -&gt; t m a -&gt; t m a)
    . foldrSM k z (x `consM` buildSM g)
    = k x (g k z)
#-}
-}</span><span>
</span><span id="line-513"></span><span>
</span><span id="line-514"></span><span class="hs-comment">-- Build using monadic build functions (continuations) instead of</span><span>
</span><span id="line-515"></span><span class="hs-comment">-- reconstructing a stream.</span><span>
</span><span id="line-516"></span><span class="hs-pragma">{-# INLINE_NORMAL buildM #-}</span><span>
</span><span id="line-517"></span><span id="local-6989586621679370507"><span id="local-6989586621679370508"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildM"><span class="hs-identifier hs-type">buildM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370508"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-518"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679370506"><span class="annot"><a href="#local-6989586621679370506"><span class="hs-identifier hs-type">r</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370507"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370508"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370507"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370508"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370506"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-519"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370507"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370508"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370506"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-520"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370508"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370506"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-521"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370508"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370506"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-522"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-523"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370508"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370507"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-524"></span><span id="buildM"><span class="annot"><span class="annottext">buildM :: forall (m :: * -&gt; *) a.
Monad m =&gt;
(forall r. (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildM"><span class="hs-identifier hs-var hs-var">buildM</span></a></span></span><span> </span><span id="local-6989586621679369865"><span class="annot"><span class="annottext">forall r. (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r
</span><a href="#local-6989586621679369865"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369862"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369862"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369861"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369861"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369860"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369860"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369859"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369859"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-525"></span><span>    </span><span class="annot"><span class="annottext">forall r. (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r
</span><a href="#local-6989586621679369865"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679369858"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369858"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369857"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369857"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369862"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369861"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369860"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369859"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369858"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#consM"><span class="hs-operator hs-var">`consM`</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369857"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369860"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369859"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-526"></span><span>
</span><span id="line-527"></span><span class="hs-comment">-- | Like 'buildM' but shares the SVar state across computations.</span><span>
</span><span id="line-528"></span><span class="hs-pragma">{-# INLINE_NORMAL sharedMWith #-}</span><span>
</span><span id="line-529"></span><span id="local-6989586621679370501"><span id="local-6989586621679370502"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#sharedMWith"><span class="hs-identifier hs-type">sharedMWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370502"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-530"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370502"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370501"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370502"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370501"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370502"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370501"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-531"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679370500"><span class="annot"><a href="#local-6989586621679370500"><span class="hs-identifier hs-type">r</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370501"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370502"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370501"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370502"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370500"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-532"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370501"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370502"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370500"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-533"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370502"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370500"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-534"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370502"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370500"><span class="hs-identifier hs-type">r</span></a></span><span>
</span><span id="line-535"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-536"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370502"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370501"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-537"></span><span id="sharedMWith"><span class="annot"><span class="annottext">sharedMWith :: forall (m :: * -&gt; *) a.
Monad m =&gt;
(m a -&gt; Stream m a -&gt; Stream m a)
-&gt; (forall r. (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#sharedMWith"><span class="hs-identifier hs-var hs-var">sharedMWith</span></a></span></span><span> </span><span id="local-6989586621679369854"><span class="annot"><span class="annottext">m a -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369854"><span class="hs-identifier hs-var">cns</span></a></span></span><span> </span><span id="local-6989586621679369853"><span class="annot"><span class="annottext">forall r. (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r
</span><a href="#local-6989586621679369853"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369851"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369851"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369850"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369850"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369849"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369849"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369848"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369848"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-538"></span><span>    </span><span class="annot"><span class="annottext">forall r. (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r
</span><a href="#local-6989586621679369853"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679369847"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369847"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369846"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369846"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369851"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369850"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369849"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369848"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369847"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369854"><span class="hs-operator hs-var">`cns`</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369846"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369849"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369848"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-539"></span><span>
</span><span id="line-540"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-541"></span><span class="hs-comment">-- augment</span><span>
</span><span id="line-542"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-543"></span><span>
</span><span id="line-544"></span><span class="hs-pragma">{-# INLINE_NORMAL augmentS #-}</span><span>
</span><span id="line-545"></span><span id="local-6989586621679370495"><span id="local-6989586621679370496"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#augmentS"><span class="hs-identifier hs-type">augmentS</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-546"></span><span>       </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370496"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370495"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370496"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370495"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370496"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370495"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370496"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370495"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370496"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-547"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370495"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370496"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-548"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370495"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370496"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-549"></span><span id="augmentS"><span class="annot"><span class="annottext">augmentS :: forall a (m :: * -&gt; *).
((a -&gt; Stream m a -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a)
-&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#augmentS"><span class="hs-identifier hs-var hs-var">augmentS</span></a></span></span><span> </span><span id="local-6989586621679369845"><span class="annot"><span class="annottext">(a -&gt; Stream m a -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369845"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span id="local-6989586621679369844"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369844"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; Stream m a -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369845"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *). a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#cons"><span class="hs-identifier hs-var">cons</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369844"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-550"></span><span>
</span><span id="line-551"></span><span class="hs-pragma">{-# RULES</span><span> </span><span id="local-6989586621679369842"><span id="local-6989586621679369843"><span class="annot"><span class="hs-pragma">&quot;augmentS/nil&quot;</span></span><span>
</span><span id="line-552"></span><span>    </span><span class="hs-pragma">forall</span><span> </span><span class="hs-pragma">(</span><span id="local-6989586621679369841"><span class="annot"><a href="#local-6989586621679369841"><span class="hs-pragma hs-var">g</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369843"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369842"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369843"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369842"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369843"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369842"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369843"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369842"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369843"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span class="hs-pragma">.</span><span>
</span><span id="line-553"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#augmentS"><span class="hs-pragma hs-type">augmentS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369841"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-pragma hs-type">nil</span></a></span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildS"><span class="hs-pragma hs-type">buildS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369841"><span class="hs-pragma hs-type">g</span></a></span></span></span><span>
</span><span id="line-554"></span><span>    </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-555"></span><span>
</span><span id="line-556"></span><span class="hs-pragma">{-# RULES</span><span> </span><span id="local-6989586621679369839"><span id="local-6989586621679369840"><span class="annot"><span class="hs-pragma">&quot;foldrS/augmentS&quot;</span></span><span>
</span><span id="line-557"></span><span>    </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369838"><span class="annot"><a href="#local-6989586621679369838"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369837"><span class="annot"><a href="#local-6989586621679369837"><span class="hs-pragma hs-var">z</span></a></span></span><span> </span><span id="local-6989586621679369836"><span class="annot"><a href="#local-6989586621679369836"><span class="hs-pragma hs-var">xs</span></a></span></span><span>
</span><span id="line-558"></span><span>        </span><span class="hs-pragma">(</span><span id="local-6989586621679369835"><span class="annot"><a href="#local-6989586621679369835"><span class="hs-pragma hs-var">g</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369840"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369839"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369840"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369839"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369840"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369839"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369840"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369839"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369840"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span class="hs-pragma">.</span><span>
</span><span id="line-559"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrS"><span class="hs-pragma hs-type">foldrS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369838"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369837"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#augmentS"><span class="hs-pragma hs-type">augmentS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369835"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369836"><span class="hs-pragma hs-type">xs</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369835"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369838"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrS"><span class="hs-pragma hs-type">foldrS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369838"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369837"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369836"><span class="hs-pragma hs-type">xs</span></a></span><span class="hs-pragma">)</span></span></span><span>
</span><span id="line-560"></span><span>    </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-561"></span><span>
</span><span id="line-562"></span><span class="hs-pragma">{-# RULES</span><span> </span><span id="local-6989586621679369833"><span id="local-6989586621679369834"><span class="annot"><span class="hs-pragma">&quot;augmentS/buildS&quot;</span></span><span>
</span><span id="line-563"></span><span>    </span><span class="hs-pragma">forall</span><span> </span><span class="hs-pragma">(</span><span id="local-6989586621679369832"><span class="annot"><a href="#local-6989586621679369832"><span class="hs-pragma hs-var">g</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369834"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369833"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369834"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369833"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369834"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369833"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369834"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369833"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369834"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span>
</span><span id="line-564"></span><span>           </span><span class="hs-pragma">(</span><span id="local-6989586621679369831"><span class="annot"><a href="#local-6989586621679369831"><span class="hs-pragma hs-var">h</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369834"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369833"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369834"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369833"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369834"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369833"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369834"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369833"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369834"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span class="hs-pragma">.</span><span>
</span><span id="line-565"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#augmentS"><span class="hs-pragma hs-type">augmentS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369832"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildS"><span class="hs-pragma hs-type">buildS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369831"><span class="hs-pragma hs-type">h</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildS"><span class="hs-pragma hs-type">buildS</span></a></span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">\</span><span id="local-6989586621679369830"><span class="annot"><a href="#local-6989586621679369830"><span class="hs-pragma hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679369829"><span class="annot"><a href="#local-6989586621679369829"><span class="hs-pragma hs-var">n</span></a></span></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369832"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369830"><span class="hs-pragma hs-type">c</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369831"><span class="hs-pragma hs-type">h</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369830"><span class="hs-pragma hs-type">c</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369829"><span class="hs-pragma hs-type">n</span></a></span><span class="hs-pragma">)</span><span class="hs-pragma">)</span></span></span><span>
</span><span id="line-566"></span><span>    </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-567"></span><span>
</span><span id="line-568"></span><span class="hs-pragma">{-# INLINE_NORMAL augmentSM #-}</span><span>
</span><span id="line-569"></span><span id="local-6989586621679370491"><span id="local-6989586621679370492"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#augmentSM"><span class="hs-identifier hs-type">augmentSM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370492"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-570"></span><span>       </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370492"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370491"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370492"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370491"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370492"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370491"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370492"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370491"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370492"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370491"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-571"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370492"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370491"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370492"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370491"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-572"></span><span id="augmentSM"><span class="annot"><span class="annottext">augmentSM :: forall (m :: * -&gt; *) a.
Monad m =&gt;
((m a -&gt; Stream m a -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a)
-&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#augmentSM"><span class="hs-identifier hs-var hs-var">augmentSM</span></a></span></span><span> </span><span id="local-6989586621679369826"><span class="annot"><span class="annottext">(m a -&gt; Stream m a -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369826"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span id="local-6989586621679369825"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369825"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(m a -&gt; Stream m a -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369826"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#consM"><span class="hs-identifier hs-var">consM</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369825"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-573"></span><span>
</span><span id="line-574"></span><span class="hs-pragma">{-# RULES</span><span> </span><span id="local-6989586621679369823"><span id="local-6989586621679369824"><span class="annot"><span class="hs-pragma">&quot;augmentSM/nil&quot;</span></span><span>
</span><span id="line-575"></span><span>    </span><span class="hs-pragma">forall</span><span>
</span><span id="line-576"></span><span>        </span><span class="hs-pragma">(</span><span id="local-6989586621679369822"><span class="annot"><a href="#local-6989586621679369822"><span class="hs-pragma hs-var">g</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369824"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369823"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369824"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369823"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369824"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369823"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369824"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369823"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369824"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369823"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span class="hs-pragma">.</span><span>
</span><span id="line-577"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#augmentSM"><span class="hs-pragma hs-type">augmentSM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369822"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-pragma hs-type">nil</span></a></span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildSM"><span class="hs-pragma hs-type">buildSM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369822"><span class="hs-pragma hs-type">g</span></a></span></span></span><span>
</span><span id="line-578"></span><span>    </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-579"></span><span>
</span><span id="line-580"></span><span class="hs-pragma">{-# RULES</span><span> </span><span id="local-6989586621679369820"><span id="local-6989586621679369821"><span class="annot"><span class="hs-pragma">&quot;foldrSM/augmentSM&quot;</span></span><span>
</span><span id="line-581"></span><span>    </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369819"><span class="annot"><a href="#local-6989586621679369819"><span class="hs-pragma hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679369818"><span class="annot"><a href="#local-6989586621679369818"><span class="hs-pragma hs-var">z</span></a></span></span><span> </span><span id="local-6989586621679369817"><span class="annot"><a href="#local-6989586621679369817"><span class="hs-pragma hs-var">xs</span></a></span></span><span>
</span><span id="line-582"></span><span>        </span><span class="hs-pragma">(</span><span id="local-6989586621679369816"><span class="annot"><a href="#local-6989586621679369816"><span class="hs-pragma hs-var">g</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369821"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369820"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369821"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369820"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369821"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369820"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369821"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369820"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369821"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369820"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span class="hs-pragma">.</span><span>
</span><span id="line-583"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSM"><span class="hs-pragma hs-type">foldrSM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369819"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369818"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#augmentSM"><span class="hs-pragma hs-type">augmentSM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369816"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369817"><span class="hs-pragma hs-type">xs</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369816"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369819"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSM"><span class="hs-pragma hs-type">foldrSM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369819"><span class="hs-pragma hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369818"><span class="hs-pragma hs-type">z</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369817"><span class="hs-pragma hs-type">xs</span></a></span><span class="hs-pragma">)</span></span></span><span>
</span><span id="line-584"></span><span>    </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-585"></span><span>
</span><span id="line-586"></span><span class="hs-pragma">{-# RULES</span><span> </span><span id="local-6989586621679369814"><span id="local-6989586621679369815"><span class="annot"><span class="hs-pragma">&quot;augmentSM/buildSM&quot;</span></span><span>
</span><span id="line-587"></span><span>    </span><span class="hs-pragma">forall</span><span>
</span><span id="line-588"></span><span>        </span><span class="hs-pragma">(</span><span id="local-6989586621679369813"><span class="annot"><a href="#local-6989586621679369813"><span class="hs-pragma hs-var">g</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369815"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369814"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369815"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369814"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369815"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369814"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369815"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369814"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369815"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369814"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span>
</span><span id="line-589"></span><span>        </span><span class="hs-pragma">(</span><span id="local-6989586621679369812"><span class="annot"><a href="#local-6989586621679369812"><span class="hs-pragma hs-var">h</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369815"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369814"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369815"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369814"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369815"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369814"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369815"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369814"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369815"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369814"><span class="hs-pragma hs-type">a</span></a></span><span class="hs-pragma">)</span><span class="hs-pragma">.</span><span>
</span><span id="line-590"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#augmentSM"><span class="hs-pragma hs-type">augmentSM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369813"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildSM"><span class="hs-pragma hs-type">buildSM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369812"><span class="hs-pragma hs-type">h</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildSM"><span class="hs-pragma hs-type">buildSM</span></a></span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">\</span><span id="local-6989586621679369811"><span class="annot"><a href="#local-6989586621679369811"><span class="hs-pragma hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679369810"><span class="annot"><a href="#local-6989586621679369810"><span class="hs-pragma hs-var">n</span></a></span></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369813"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369811"><span class="hs-pragma hs-type">c</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369812"><span class="hs-pragma hs-type">h</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369811"><span class="hs-pragma hs-type">c</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369810"><span class="hs-pragma hs-type">n</span></a></span><span class="hs-pragma">)</span><span class="hs-pragma">)</span></span></span><span>
</span><span id="line-591"></span><span>    </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-592"></span><span>
</span><span id="line-593"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-594"></span><span class="hs-comment">-- Experimental foldrM/buildM</span><span>
</span><span id="line-595"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-596"></span><span>
</span><span id="line-597"></span><span class="hs-comment">-- | Lazy right fold with a monadic step function.</span><span>
</span><span id="line-598"></span><span class="hs-pragma">{-# INLINE_NORMAL foldrM #-}</span><span>
</span><span id="line-599"></span><span id="local-6989586621679370486"><span id="local-6989586621679370487"><span id="local-6989586621679370488"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrM"><span class="hs-identifier hs-type">foldrM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370488"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370486"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370486"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370486"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370488"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370486"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-600"></span><span id="foldrM"><span class="annot"><span class="annottext">foldrM :: forall a (m :: * -&gt; *) b.
(a -&gt; m b -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrM"><span class="hs-identifier hs-var hs-var">foldrM</span></a></span></span><span> </span><span id="local-6989586621679369809"><span class="annot"><span class="annottext">a -&gt; m b -&gt; m b
</span><a href="#local-6989586621679369809"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679369808"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679369808"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621679369807"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369807"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; m b
</span><a href="#local-6989586621679369806"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369807"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-601"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-602"></span><span>    </span><span id="local-6989586621679369806"><span class="annot"><span class="annottext">go :: Stream m a -&gt; m b
</span><a href="#local-6989586621679369806"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679369805"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369805"><span class="hs-identifier hs-var">m1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-603"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369804"><span class="annot"><span class="annottext">stop :: m b
</span><a href="#local-6989586621679369804"><span class="hs-identifier hs-var hs-var">stop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679369808"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-604"></span><span>            </span><span id="local-6989586621679369803"><span class="annot"><span class="annottext">single :: a -&gt; m b
</span><a href="#local-6989586621679369803"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369802"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369802"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; m b -&gt; m b
</span><a href="#local-6989586621679369809"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369802"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679369808"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-605"></span><span>            </span><span id="local-6989586621679369801"><span class="annot"><span class="annottext">yieldk :: a -&gt; Stream m a -&gt; m b
</span><a href="#local-6989586621679369801"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369800"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369800"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369799"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369799"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; m b -&gt; m b
</span><a href="#local-6989586621679369809"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369800"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m a -&gt; m b
</span><a href="#local-6989586621679369806"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369799"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-606"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.Type.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m b
</span><a href="#local-6989586621679369801"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m b
</span><a href="#local-6989586621679369803"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679369804"><span class="hs-identifier hs-var">stop</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369805"><span class="hs-identifier hs-var">m1</span></a></span><span>
</span><span id="line-607"></span><span>
</span><span id="line-608"></span><span class="hs-pragma">{-# INLINE_NORMAL foldrMKWith #-}</span><span>
</span><span id="line-609"></span><span id="local-6989586621679370477"><span id="local-6989586621679370478"><span id="local-6989586621679370479"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrMKWith"><span class="hs-identifier hs-type">foldrMKWith</span></a></span><span>
</span><span id="line-610"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.SVar.Type.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370479"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370478"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-611"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370478"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370479"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370478"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370479"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370477"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-612"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370478"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370479"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370477"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-613"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370479"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370477"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-614"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370479"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370478"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-615"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370479"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370477"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-616"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370478"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370479"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370477"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370479"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370477"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-617"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370479"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370477"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-618"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370478"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370479"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370478"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370479"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370477"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370478"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370479"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370477"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370479"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370477"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370479"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370477"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-619"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370479"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370477"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-620"></span><span id="foldrMKWith"><span class="annot"><span class="annottext">foldrMKWith :: forall (m :: * -&gt; *) a b.
(State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m b)
 -&gt; (a -&gt; m b)
 -&gt; m b
 -&gt; Stream m a
 -&gt; m b)
-&gt; (a -&gt; m b -&gt; m b)
-&gt; m b
-&gt; ((a -&gt; Stream m a -&gt; m b) -&gt; (a -&gt; m b) -&gt; m b -&gt; m b)
-&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrMKWith"><span class="hs-identifier hs-var hs-var">foldrMKWith</span></a></span></span><span> </span><span id="local-6989586621679369797"><span class="annot"><span class="annottext">State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m b)
-&gt; (a -&gt; m b)
-&gt; m b
-&gt; Stream m a
-&gt; m b
</span><a href="#local-6989586621679369797"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679369796"><span class="annot"><span class="annottext">a -&gt; m b -&gt; m b
</span><a href="#local-6989586621679369796"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679369795"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679369795"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((a -&gt; Stream m a -&gt; m b) -&gt; (a -&gt; m b) -&gt; m b -&gt; m b) -&gt; m b
</span><a href="#local-6989586621679369794"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-621"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-622"></span><span>    </span><span id="local-6989586621679369794"><span class="annot"><span class="annottext">go :: ((a -&gt; Stream m a -&gt; m b) -&gt; (a -&gt; m b) -&gt; m b -&gt; m b) -&gt; m b
</span><a href="#local-6989586621679369794"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679369793"><span class="annot"><span class="annottext">(a -&gt; Stream m a -&gt; m b) -&gt; (a -&gt; m b) -&gt; m b -&gt; m b
</span><a href="#local-6989586621679369793"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-623"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369792"><span class="annot"><span class="annottext">stop :: m b
</span><a href="#local-6989586621679369792"><span class="hs-identifier hs-var hs-var">stop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679369795"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-624"></span><span>            </span><span id="local-6989586621679369791"><span class="annot"><span class="annottext">single :: a -&gt; m b
</span><a href="#local-6989586621679369791"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369790"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369790"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; m b -&gt; m b
</span><a href="#local-6989586621679369796"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369790"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679369795"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-625"></span><span>            </span><span id="local-6989586621679369789"><span class="annot"><span class="annottext">yieldk :: a -&gt; Stream m a -&gt; m b
</span><a href="#local-6989586621679369789"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369788"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369788"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369787"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369787"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; m b -&gt; m b
</span><a href="#local-6989586621679369796"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369788"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((a -&gt; Stream m a -&gt; m b) -&gt; (a -&gt; m b) -&gt; m b -&gt; m b) -&gt; m b
</span><a href="#local-6989586621679369794"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679369786"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m b
</span><a href="#local-6989586621679369786"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369785"><span class="annot"><span class="annottext">a -&gt; m b
</span><a href="#local-6989586621679369785"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369784"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679369784"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m b)
-&gt; (a -&gt; m b)
-&gt; m b
-&gt; Stream m a
-&gt; m b
</span><a href="#local-6989586621679369797"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.Type.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m b
</span><a href="#local-6989586621679369786"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m b
</span><a href="#local-6989586621679369785"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679369784"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369787"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-626"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(a -&gt; Stream m a -&gt; m b) -&gt; (a -&gt; m b) -&gt; m b -&gt; m b
</span><a href="#local-6989586621679369793"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m b
</span><a href="#local-6989586621679369789"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m b
</span><a href="#local-6989586621679369791"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679369792"><span class="hs-identifier hs-var">stop</span></a></span><span>
</span><span id="line-627"></span><span>
</span><span id="line-628"></span><span class="hs-comment">{-
{-# RULES &quot;foldrM/buildS&quot;
      forall k z (g :: (a -&gt; t m a -&gt; t m a) -&gt; t m a -&gt; t m a)
    . foldrM k z (buildS g)
    = g k z
#-}
-}</span><span>
</span><span id="line-635"></span><span class="hs-comment">-- XXX in which case will foldrM/buildM fusion be useful?</span><span>
</span><span id="line-636"></span><span class="hs-pragma">{-# RULES</span><span> </span><span id="local-6989586621679369782"><span id="local-6989586621679369783"><span class="annot"><span class="hs-pragma">&quot;foldrM/buildM&quot;</span></span><span>
</span><span id="line-637"></span><span>    </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369781"><span class="annot"><a href="#local-6989586621679369781"><span class="hs-pragma hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679369780"><span class="annot"><a href="#local-6989586621679369780"><span class="hs-pragma hs-var">acc</span></a></span></span><span> </span><span class="hs-pragma">(</span><span id="local-6989586621679369779"><span class="annot"><a href="#local-6989586621679369779"><span class="hs-pragma hs-var">g</span></a></span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369778"><span class="annot"><a href="#local-6989586621679369778"><span class="hs-pragma hs-type">r</span></a></span></span><span class="hs-pragma">.</span><span>
</span><span id="line-638"></span><span>           </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369783"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-pragma hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369782"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369783"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369782"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369778"><span class="hs-pragma hs-type">r</span></a></span><span class="hs-pragma">)</span><span>
</span><span id="line-639"></span><span>        </span><span class="hs-pragma">-&gt;</span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369783"><span class="hs-pragma hs-type">a</span></a></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369782"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369778"><span class="hs-pragma hs-type">r</span></a></span><span class="hs-pragma">)</span><span>
</span><span id="line-640"></span><span>        </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369782"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369778"><span class="hs-pragma hs-type">r</span></a></span><span>
</span><span id="line-641"></span><span>        </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369782"><span class="hs-pragma hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369778"><span class="hs-pragma hs-type">r</span></a></span><span>
</span><span id="line-642"></span><span>       </span><span class="hs-pragma">)</span><span class="hs-pragma">)</span><span class="hs-pragma">.</span><span>
</span><span id="line-643"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrM"><span class="hs-pragma hs-type">foldrM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369781"><span class="hs-pragma hs-type">step</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369780"><span class="hs-pragma hs-type">acc</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildM"><span class="hs-pragma hs-type">buildM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369779"><span class="hs-pragma hs-type">g</span></a></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrMKWith"><span class="hs-pragma hs-type">foldrMKWith</span></a></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-pragma hs-type">foldStream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369781"><span class="hs-pragma hs-type">step</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369780"><span class="hs-pragma hs-type">acc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369779"><span class="hs-pragma hs-type">g</span></a></span></span></span><span>
</span><span id="line-644"></span><span>    </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-645"></span><span>
</span><span id="line-646"></span><span class="hs-comment">{-
{-# RULES &quot;foldrM/sharedM&quot;
    forall step acc (g :: (forall r.
           (a -&gt; Stream m a -&gt; m r)
        -&gt; (a -&gt; m r)
        -&gt; m r
        -&gt; m r
       )).
    foldrM step acc (sharedM g) = foldrMKWith foldStreamShared step acc g
    #-}
-}</span><span>
</span><span id="line-657"></span><span>
</span><span id="line-658"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-659"></span><span class="hs-comment">-- Left fold</span><span>
</span><span id="line-660"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-661"></span><span>
</span><span id="line-662"></span><span class="hs-comment">-- | Strict left fold with an extraction function. Like the standard strict</span><span>
</span><span id="line-663"></span><span class="hs-comment">-- left fold, but applies a user supplied extraction function (the third</span><span>
</span><span id="line-664"></span><span class="hs-comment">-- argument) to the folded value at the end. This is designed to work with the</span><span>
</span><span id="line-665"></span><span class="hs-comment">-- @foldl@ library. The suffix @x@ is a mnemonic for extraction.</span><span>
</span><span id="line-666"></span><span class="hs-comment">--</span><span>
</span><span id="line-667"></span><span class="hs-comment">-- Note that the accumulator is always evaluated including the initial value.</span><span>
</span><span id="line-668"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldlx%27"><span class="hs-pragma hs-type">foldlx'</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-669"></span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldlx%27"><span class="hs-identifier hs-type">foldlx'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679370473"><span class="annot"><a href="#local-6989586621679370473"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679370471"><span class="annot"><a href="#local-6989586621679370471"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679370470"><span class="annot"><a href="#local-6989586621679370470"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621679370472"><span class="annot"><a href="#local-6989586621679370472"><span class="hs-identifier hs-type">x</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370473"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-670"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370472"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370471"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370472"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370472"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370472"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370470"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370473"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370471"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370473"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370470"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-671"></span><span id="foldlx%27"><span class="annot"><span class="annottext">foldlx' :: forall (m :: * -&gt; *) a b x.
Monad m =&gt;
(x -&gt; a -&gt; x) -&gt; x -&gt; (x -&gt; b) -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldlx%27"><span class="hs-identifier hs-var hs-var">foldlx'</span></a></span></span><span> </span><span id="local-6989586621679369770"><span class="annot"><span class="annottext">x -&gt; a -&gt; x
</span><a href="#local-6989586621679369770"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679369769"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679369769"><span class="hs-identifier hs-var">begin</span></a></span></span><span> </span><span id="local-6989586621679369768"><span class="annot"><span class="annottext">x -&gt; b
</span><a href="#local-6989586621679369768"><span class="hs-identifier hs-var">done</span></a></span></span><span> </span><span id="local-6989586621679369767"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369767"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m x -&gt; m b
</span><a href="#local-6989586621679369766"><span class="hs-identifier hs-var">get</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; x -&gt; Stream m x
</span><a href="#local-6989586621679369765"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369767"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679369769"><span class="hs-identifier hs-var">begin</span></a></span><span>
</span><span id="line-672"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-673"></span><span>    </span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="#local-6989586621679369766"><span class="hs-pragma hs-type">get</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-674"></span><span>    </span><span class="annot"><a href="#local-6989586621679369766"><span class="hs-identifier hs-type">get</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370473"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370472"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370473"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370470"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-675"></span><span>    </span><span id="local-6989586621679369766"><span class="annot"><span class="annottext">get :: Stream m x -&gt; m b
</span><a href="#local-6989586621679369766"><span class="hs-identifier hs-var hs-var">get</span></a></span></span><span> </span><span id="local-6989586621679369764"><span class="annot"><span class="annottext">Stream m x
</span><a href="#local-6989586621679369764"><span class="hs-identifier hs-var">m1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-676"></span><span>        </span><span class="hs-comment">-- XXX we are not strictly evaluating the accumulator here. Is this</span><span>
</span><span id="line-677"></span><span>        </span><span class="hs-comment">-- okay?</span><span>
</span><span id="line-678"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369762"><span class="annot"><span class="annottext">single :: x -&gt; m b
</span><a href="#local-6989586621679369762"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">x -&gt; b
</span><a href="#local-6989586621679369768"><span class="hs-identifier hs-var">done</span></a></span><span>
</span><span id="line-679"></span><span>        </span><span class="hs-comment">-- XXX this is foldSingleton. why foldStreamShared?</span><span>
</span><span id="line-680"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="annot"><span class="annottext">x -&gt; m b
</span><a href="#local-6989586621679369762"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="annot"><span class="annottext">Stream m x
</span><a href="#local-6989586621679369764"><span class="hs-identifier hs-var">m1</span></a></span><span>
</span><span id="line-681"></span><span>
</span><span id="line-682"></span><span>    </span><span class="hs-comment">-- Note, this can be implemented by making a recursive call to &quot;go&quot;,</span><span>
</span><span id="line-683"></span><span>    </span><span class="hs-comment">-- however that is more expensive because of unnecessary recursion</span><span>
</span><span id="line-684"></span><span>    </span><span class="hs-comment">-- that cannot be tail call optimized. Unfolding recursion explicitly via</span><span>
</span><span id="line-685"></span><span>    </span><span class="hs-comment">-- continuations is much more efficient.</span><span>
</span><span id="line-686"></span><span>    </span><span class="annot"><a href="#local-6989586621679369765"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370473"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370471"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370472"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370473"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370472"><span class="hs-identifier hs-type">x</span></a></span><span>
</span><span id="line-687"></span><span>    </span><span id="local-6989586621679369765"><span class="annot"><span class="annottext">go :: Stream m a -&gt; x -&gt; Stream m x
</span><a href="#local-6989586621679369765"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679369759"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369759"><span class="hs-identifier hs-var">m1</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679369758"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679369758"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">State Stream m x
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679369757"><span class="annot"><span class="annottext">x -&gt; Stream m x -&gt; m r
</span><a href="#local-6989586621679369757"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369756"><span class="annot"><span class="annottext">x -&gt; m r
</span><a href="#local-6989586621679369756"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span class="annot"><span class="annottext">m r
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-688"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369755"><span class="annot"><span class="annottext">stop :: m r
</span><a href="#local-6989586621679369755"><span class="hs-identifier hs-var hs-var">stop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">x -&gt; m r
</span><a href="#local-6989586621679369756"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679369758"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-689"></span><span>            </span><span id="local-6989586621679369754"><span class="annot"><span class="annottext">single :: a -&gt; m r
</span><a href="#local-6989586621679369754"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369753"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369753"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">x -&gt; m r
</span><a href="#local-6989586621679369756"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">x -&gt; a -&gt; x
</span><a href="#local-6989586621679369770"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679369758"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369753"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-690"></span><span>            </span><span class="hs-comment">-- XXX this is foldNonEmptyStream</span><span>
</span><span id="line-691"></span><span>            </span><span id="local-6989586621679369750"><span class="annot"><span class="annottext">yieldk :: a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369750"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369749"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369749"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369748"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369748"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.Type.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">x -&gt; Stream m x -&gt; m r
</span><a href="#local-6989586621679369757"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">x -&gt; m r
</span><a href="#local-6989586621679369756"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-692"></span><span>                </span><span class="annot"><span class="annottext">Stream m a -&gt; x -&gt; Stream m x
</span><a href="#local-6989586621679369765"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369748"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">x -&gt; a -&gt; x
</span><a href="#local-6989586621679369770"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621679369758"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369749"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-693"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.Type.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369750"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369754"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369755"><span class="hs-identifier hs-var">stop</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369759"><span class="hs-identifier hs-var">m1</span></a></span><span>
</span><span id="line-694"></span><span>
</span><span id="line-695"></span><span class="hs-comment">-- | Strict left associative fold.</span><span>
</span><span id="line-696"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldl%27"><span class="hs-pragma hs-type">foldl'</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-697"></span><span id="local-6989586621679370456"><span id="local-6989586621679370457"><span id="local-6989586621679370458"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldl%27"><span class="hs-identifier hs-type">foldl'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370458"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370457"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370456"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370457"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370457"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370458"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370456"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370458"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370457"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-698"></span><span id="foldl%27"><span class="annot"><span class="annottext">foldl' :: forall (m :: * -&gt; *) b a.
Monad m =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldl%27"><span class="hs-identifier hs-var hs-var">foldl'</span></a></span></span><span> </span><span id="local-6989586621679369745"><span class="annot"><span class="annottext">b -&gt; a -&gt; b
</span><a href="#local-6989586621679369745"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679369744"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369744"><span class="hs-identifier hs-var">begin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b x.
Monad m =&gt;
(x -&gt; a -&gt; x) -&gt; x -&gt; (x -&gt; b) -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldlx%27"><span class="hs-identifier hs-var">foldlx'</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; a -&gt; b
</span><a href="#local-6989586621679369745"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369744"><span class="hs-identifier hs-var">begin</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-699"></span><span>
</span><span id="line-700"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-701"></span><span class="hs-comment">-- Specialized folds</span><span>
</span><span id="line-702"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-703"></span><span>
</span><span id="line-704"></span><span class="hs-comment">-- XXX use foldrM to implement folds where possible</span><span>
</span><span id="line-705"></span><span class="hs-comment">-- XXX This (commented) definition of drain and mapM_ perform much better on</span><span>
</span><span id="line-706"></span><span class="hs-comment">-- some benchmarks but worse on others. Need to investigate why, may there is</span><span>
</span><span id="line-707"></span><span class="hs-comment">-- an optimization opportunity that we can exploit.</span><span>
</span><span id="line-708"></span><span class="hs-comment">-- drain = foldrM (\_ xs -&gt; return () &gt;&gt; xs) (return ())</span><span>
</span><span id="line-709"></span><span>
</span><span id="line-710"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-711"></span><span class="hs-comment">-- &gt; drain = foldl' (\_ _ -&gt; ()) ()</span><span>
</span><span id="line-712"></span><span class="hs-comment">-- &gt; drain = mapM_ (\_ -&gt; return ())</span><span>
</span><span id="line-713"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#drain"><span class="hs-pragma hs-type">drain</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-714"></span><span id="local-6989586621679370451"><span id="local-6989586621679370452"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#drain"><span class="hs-identifier hs-type">drain</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370452"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370452"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370451"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370452"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-715"></span><span id="drain"><span class="annot"><span class="annottext">drain :: forall (m :: * -&gt; *) a. Monad m =&gt; Stream m a -&gt; m ()
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#drain"><span class="hs-identifier hs-var hs-var">drain</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *) b.
(a -&gt; m b -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrM"><span class="hs-identifier hs-var">foldrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679369741"><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679369741"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679369741"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-716"></span><span class="hs-comment">{-
drain = go
    where
    go m1 =
        let stop = return ()
            single _ = return ()
            yieldk _ r = go r
         in foldStream defState yieldk single stop m1
-}</span><span>
</span><span id="line-725"></span><span>
</span><span id="line-726"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#null"><span class="hs-pragma hs-type">null</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-727"></span><span id="local-6989586621679370447"><span id="local-6989586621679370448"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#null"><span class="hs-identifier hs-type">null</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370448"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370448"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370447"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370448"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span></span><span>
</span><span id="line-728"></span><span class="hs-comment">-- null = foldrM (\_ _ -&gt; return True) (return False)</span><span>
</span><span id="line-729"></span><span id="null"><span class="annot"><span class="annottext">null :: forall (m :: * -&gt; *) a. Monad m =&gt; Stream m a -&gt; m Bool
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#null"><span class="hs-identifier hs-var hs-var">null</span></a></span></span><span> </span><span id="local-6989586621679369737"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369737"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-730"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369735"><span class="annot"><span class="annottext">stop :: m Bool
</span><a href="#local-6989586621679369735"><span class="hs-identifier hs-var hs-var">stop</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-731"></span><span>        </span><span id="local-6989586621679369732"><span class="annot"><span class="annottext">single :: p -&gt; m Bool
</span><a href="#local-6989586621679369732"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-732"></span><span>        </span><span id="local-6989586621679369729"><span class="annot"><span class="annottext">yieldk :: p -&gt; p -&gt; m Bool
</span><a href="#local-6989586621679369729"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-733"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.Type.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {p} {p}. Monad m =&gt; p -&gt; p -&gt; m Bool
</span><a href="#local-6989586621679369729"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {p}. Monad m =&gt; p -&gt; m Bool
</span><a href="#local-6989586621679369732"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m Bool
</span><a href="#local-6989586621679369735"><span class="hs-identifier hs-var">stop</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369737"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-734"></span><span>
</span><span id="line-735"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-736"></span><span class="hs-comment">-- Semigroup</span><span>
</span><span id="line-737"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-738"></span><span>
</span><span id="line-739"></span><span class="hs-keyword">infixr</span><span> </span><span class="hs-number">6</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#serial"><span class="hs-operator hs-type">`serial`</span></a></span><span>
</span><span id="line-740"></span><span>
</span><span id="line-741"></span><span class="hs-comment">-- | Appends two streams sequentially, yielding all elements from the first</span><span>
</span><span id="line-742"></span><span class="hs-comment">-- stream, and then all elements from the second stream.</span><span>
</span><span id="line-743"></span><span class="hs-comment">--</span><span>
</span><span id="line-744"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#serial"><span class="hs-pragma hs-type">serial</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-745"></span><span id="local-6989586621679370438"><span id="local-6989586621679370439"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#serial"><span class="hs-identifier hs-type">serial</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370439"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370438"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370439"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370438"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370439"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370438"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-746"></span><span class="hs-comment">-- XXX This doubles the time of toNullAp benchmark, may not be fusing properly</span><span>
</span><span id="line-747"></span><span class="hs-comment">-- serial xs ys = augmentS (\c n -&gt; foldrS c n xs) ys</span><span>
</span><span id="line-748"></span><span id="serial"><span class="annot"><span class="annottext">serial :: forall (m :: * -&gt; *) a. Stream m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#serial"><span class="hs-identifier hs-var hs-var">serial</span></a></span></span><span> </span><span id="local-6989586621679369728"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369728"><span class="hs-identifier hs-var">m1</span></a></span></span><span> </span><span id="local-6989586621679369727"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369727"><span class="hs-identifier hs-var">m2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369726"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369728"><span class="hs-identifier hs-var">m1</span></a></span><span>
</span><span id="line-749"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-750"></span><span>    </span><span id="local-6989586621679369726"><span class="annot"><span class="annottext">go :: Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369726"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679369725"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369725"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369724"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369724"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369723"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369723"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369722"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369722"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369721"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369721"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-751"></span><span>               </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369720"><span class="annot"><span class="annottext">stop :: m r
</span><a href="#local-6989586621679369720"><span class="hs-identifier hs-var hs-var">stop</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369724"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369723"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369722"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369721"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369727"><span class="hs-identifier hs-var">m2</span></a></span><span>
</span><span id="line-752"></span><span>                   </span><span id="local-6989586621679369719"><span class="annot"><span class="annottext">single :: a -&gt; m r
</span><a href="#local-6989586621679369719"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369718"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369718"><span class="hs-identifier hs-var">a</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369723"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369718"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369727"><span class="hs-identifier hs-var">m2</span></a></span><span>
</span><span id="line-753"></span><span>                   </span><span id="local-6989586621679369717"><span class="annot"><span class="annottext">yieldk :: a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369717"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369716"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369716"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369715"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369715"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369723"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369716"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369726"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369715"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-754"></span><span>               </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369724"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369717"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369719"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369720"><span class="hs-identifier hs-var">stop</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369725"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-755"></span><span>
</span><span id="line-756"></span><span class="hs-comment">-- join/merge/append streams depending on consM</span><span>
</span><span id="line-757"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#conjoin"><span class="hs-pragma hs-type">conjoin</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-758"></span><span id="local-6989586621679370433"><span id="local-6989586621679370434"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#conjoin"><span class="hs-identifier hs-type">conjoin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370434"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370434"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370433"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370434"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370433"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370434"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370433"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-759"></span><span id="conjoin"><span class="annot"><span class="annottext">conjoin :: forall (m :: * -&gt; *) a.
Monad m =&gt;
Stream m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#conjoin"><span class="hs-identifier hs-var hs-var">conjoin</span></a></span></span><span> </span><span id="local-6989586621679369711"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369711"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
Monad m =&gt;
((m a -&gt; Stream m a -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a)
-&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#augmentSM"><span class="hs-identifier hs-var">augmentSM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679369710"><span class="annot"><span class="annottext">m a -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369710"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679369709"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369709"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
Monad m =&gt;
(m a -&gt; Stream m b -&gt; Stream m b)
-&gt; Stream m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSM"><span class="hs-identifier hs-var">foldrSM</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369710"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369709"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369711"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-760"></span><span>
</span><span id="line-761"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679369704"><span id="local-6989586621679369706"><span id="local-6989586621679370427"><span id="local-6989586621679370428"><span class="annot"><span class="hs-identifier hs-type">Semigroup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370428"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370427"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-762"></span><span>    </span><span id="local-6989586621679369702"><span class="annot"><span class="annottext">&lt;&gt; :: Stream m a -&gt; Stream m a -&gt; Stream m a
</span><span class="hs-operator hs-var hs-var hs-var hs-var">(&lt;&gt;)</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#serial"><span class="hs-identifier hs-var">serial</span></a></span><span>
</span><span id="line-763"></span><span>
</span><span id="line-764"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-765"></span><span class="hs-comment">-- Monoid</span><span>
</span><span id="line-766"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-767"></span><span>
</span><span id="line-768"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679369696"><span id="local-6989586621679370424"><span id="local-6989586621679370425"><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370425"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370424"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-769"></span><span>    </span><span id="local-6989586621679369694"><span class="annot"><span class="annottext">mempty :: Stream m a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">mempty</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-identifier hs-var">nil</span></a></span><span>
</span><span id="line-770"></span><span>    </span><span id="local-6989586621679369692"><span class="annot"><span class="annottext">mappend :: Stream m a -&gt; Stream m a -&gt; Stream m a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">mappend</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(&lt;&gt;)</span></span><span>
</span><span id="line-771"></span><span>
</span><span id="line-772"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-773"></span><span class="hs-comment">-- Functor</span><span>
</span><span id="line-774"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-775"></span><span>
</span><span id="line-776"></span><span class="hs-comment">-- Note eta expanded</span><span>
</span><span id="line-777"></span><span class="hs-pragma">{-# INLINE_LATE mapFB #-}</span><span>
</span><span id="line-778"></span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapFB"><span class="hs-identifier hs-type">mapFB</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679370423"><span class="annot"><a href="#local-6989586621679370423"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621679370422"><span class="annot"><a href="#local-6989586621679370422"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679370421"><span class="annot"><a href="#local-6989586621679370421"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-779"></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370423"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370422"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370423"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370422"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370423"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-780"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370421"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370423"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-781"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370421"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-782"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370422"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370423"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-783"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370422"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370423"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-784"></span><span id="mapFB"><span class="annot"><span class="annottext">mapFB :: forall b (m :: * -&gt; *) a.
(b -&gt; Stream m b -&gt; Stream m b)
-&gt; (a -&gt; b) -&gt; a -&gt; Stream m b -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapFB"><span class="hs-identifier hs-var hs-var">mapFB</span></a></span></span><span> </span><span id="local-6989586621679369690"><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369690"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679369689"><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621679369689"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369688"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369688"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679369687"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369687"><span class="hs-identifier hs-var">ys</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369690"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621679369689"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369688"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369687"><span class="hs-identifier hs-var">ys</span></a></span><span>
</span><span id="line-785"></span><span>
</span><span id="line-786"></span><span class="hs-pragma">{-# RULES</span><span>
</span><span id="line-787"></span><span class="annot"><span class="hs-pragma">&quot;mapFB/mapFB&quot;</span></span><span> </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369686"><span class="annot"><a href="#local-6989586621679369686"><span class="hs-pragma hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679369685"><span class="annot"><a href="#local-6989586621679369685"><span class="hs-pragma hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679369684"><span class="annot"><a href="#local-6989586621679369684"><span class="hs-pragma hs-var">g</span></a></span></span><span class="hs-pragma">.</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapFB"><span class="hs-pragma hs-type">mapFB</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapFB"><span class="hs-pragma hs-type">mapFB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369686"><span class="hs-pragma hs-type">c</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369685"><span class="hs-pragma hs-type">f</span></a></span><span class="hs-pragma">)</span><span> </span><span class="annot"><a href="#local-6989586621679369684"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapFB"><span class="hs-pragma hs-type">mapFB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369686"><span class="hs-pragma hs-type">c</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369685"><span class="hs-pragma hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-pragma hs-type">.</span></span><span> </span><span class="annot"><a href="#local-6989586621679369684"><span class="hs-pragma hs-type">g</span></a></span><span class="hs-pragma">)</span><span>
</span><span id="line-788"></span><span class="annot"><span class="hs-pragma">&quot;mapFB/id&quot;</span></span><span>    </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369683"><span class="annot"><a href="#local-6989586621679369683"><span class="hs-pragma hs-var">c</span></a></span></span><span class="hs-pragma">.</span><span>     </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapFB"><span class="hs-pragma hs-type">mapFB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369683"><span class="hs-pragma hs-type">c</span></a></span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">\</span><span id="local-6989586621679369682"><span class="annot"><a href="#local-6989586621679369682"><span class="hs-pragma hs-var">x</span></a></span></span><span> </span><span class="hs-pragma">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369682"><span class="hs-pragma hs-type">x</span></a></span><span class="hs-pragma">)</span><span>   </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="#local-6989586621679369683"><span class="hs-pragma hs-type">c</span></a></span><span>
</span><span id="line-789"></span><span>    </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-790"></span><span>
</span><span id="line-791"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#map"><span class="hs-pragma hs-type">map</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-792"></span><span id="local-6989586621679370415"><span id="local-6989586621679370416"><span id="local-6989586621679370417"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#map"><span class="hs-identifier hs-type">map</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370417"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370416"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370415"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370417"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370415"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370416"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-793"></span><span id="map"><span class="annot"><span class="annottext">map :: forall a b (m :: * -&gt; *). (a -&gt; b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#map"><span class="hs-identifier hs-var hs-var">map</span></a></span></span><span> </span><span id="local-6989586621679369681"><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621679369681"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679369680"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369680"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *).
((a -&gt; Stream m a -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildS"><span class="hs-identifier hs-var">buildS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679369679"><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369679"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679369678"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369678"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *) b.
(a -&gt; Stream m b -&gt; Stream m b)
-&gt; Stream m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrS"><span class="hs-identifier hs-var">foldrS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall b (m :: * -&gt; *) a.
(b -&gt; Stream m b -&gt; Stream m b)
-&gt; (a -&gt; b) -&gt; a -&gt; Stream m b -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapFB"><span class="hs-identifier hs-var">mapFB</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369679"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621679369681"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369678"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369680"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-794"></span><span>
</span><span id="line-795"></span><span class="hs-comment">-- XXX This definition might potentially be more efficient, but the cost in the</span><span>
</span><span id="line-796"></span><span class="hs-comment">-- benchmark is dominated by unfoldrM cost so we cannot correctly determine</span><span>
</span><span id="line-797"></span><span class="hs-comment">-- differences in the mapping cost. We should perhaps deduct the cost of</span><span>
</span><span id="line-798"></span><span class="hs-comment">-- unfoldrM from the benchmarks and then compare.</span><span>
</span><span id="line-799"></span><span class="hs-comment">{-
map f m = go m
    where
        go m1 =
            mkStream $ \st yld sng stp -&gt;
            let single     = sng . f
                yieldk a r = yld (f a) (go r)
            in foldStream (adaptState st) yieldk single stp m1
-}</span><span>
</span><span id="line-808"></span><span>
</span><span id="line-809"></span><span class="hs-pragma">{-# INLINE_LATE mapMFB #-}</span><span>
</span><span id="line-810"></span><span id="local-6989586621679370408"><span id="local-6989586621679370409"><span id="local-6989586621679370410"><span id="local-6989586621679370411"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapMFB"><span class="hs-identifier hs-type">mapMFB</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370411"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370411"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370410"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370409"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370411"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370410"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370409"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370411"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370410"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370408"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370411"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370410"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370411"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370408"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370409"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370411"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370410"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370409"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370411"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370410"><span class="hs-identifier hs-type">b</span></a></span></span></span></span></span><span>
</span><span id="line-811"></span><span id="mapMFB"><span class="annot"><span class="annottext">mapMFB :: forall (m :: * -&gt; *) b (t :: (* -&gt; *) -&gt; * -&gt; *) a.
Monad m =&gt;
(m b -&gt; t m b -&gt; t m b) -&gt; (a -&gt; m b) -&gt; m a -&gt; t m b -&gt; t m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapMFB"><span class="hs-identifier hs-var hs-var">mapMFB</span></a></span></span><span> </span><span id="local-6989586621679369674"><span class="annot"><span class="annottext">m b -&gt; t m b -&gt; t m b
</span><a href="#local-6989586621679369674"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679369673"><span class="annot"><span class="annottext">a -&gt; m b
</span><a href="#local-6989586621679369673"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679369672"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679369672"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m b -&gt; t m b -&gt; t m b
</span><a href="#local-6989586621679369674"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679369672"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; m b
</span><a href="#local-6989586621679369673"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-812"></span><span>
</span><span id="line-813"></span><span class="hs-pragma">{-# RULES</span><span>
</span><span id="line-814"></span><span>    </span><span class="annot"><span class="hs-pragma">&quot;mapMFB/mapMFB&quot;</span></span><span> </span><span class="hs-pragma">forall</span><span> </span><span id="local-6989586621679369671"><span class="annot"><a href="#local-6989586621679369671"><span class="hs-pragma hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679369670"><span class="annot"><a href="#local-6989586621679369670"><span class="hs-pragma hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679369669"><span class="annot"><a href="#local-6989586621679369669"><span class="hs-pragma hs-var">g</span></a></span></span><span class="hs-pragma">.</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapMFB"><span class="hs-pragma hs-type">mapMFB</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapMFB"><span class="hs-pragma hs-type">mapMFB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369671"><span class="hs-pragma hs-type">c</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369670"><span class="hs-pragma hs-type">f</span></a></span><span class="hs-pragma">)</span><span> </span><span class="annot"><a href="#local-6989586621679369669"><span class="hs-pragma hs-type">g</span></a></span><span> </span><span class="hs-pragma">=</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapMFB"><span class="hs-pragma hs-type">mapMFB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369671"><span class="hs-pragma hs-type">c</span></a></span><span> </span><span class="hs-pragma">(</span><span class="annot"><a href="#local-6989586621679369670"><span class="hs-pragma hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-pragma hs-type">&gt;=&gt;</span></span><span> </span><span class="annot"><a href="#local-6989586621679369669"><span class="hs-pragma hs-type">g</span></a></span><span class="hs-pragma">)</span><span>
</span><span id="line-815"></span><span>    </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-816"></span><span class="hs-comment">-- XXX These rules may never fire because pure/return type class rules will</span><span>
</span><span id="line-817"></span><span class="hs-comment">-- fire first.</span><span>
</span><span id="line-818"></span><span class="hs-comment">{-
&quot;mapMFB/pure&quot;    forall c.     mapMFB c (\x -&gt; pure x)   = c
&quot;mapMFB/return&quot;  forall c.     mapMFB c (\x -&gt; return x) = c
-}</span><span>
</span><span id="line-822"></span><span>
</span><span id="line-823"></span><span class="hs-comment">-- This is experimental serial version supporting fusion.</span><span>
</span><span id="line-824"></span><span class="hs-comment">--</span><span>
</span><span id="line-825"></span><span class="hs-comment">-- XXX what if we do not want to fuse two concurrent mapMs?</span><span>
</span><span id="line-826"></span><span class="hs-comment">-- XXX we can combine two concurrent mapM only if the SVar is of the same type</span><span>
</span><span id="line-827"></span><span class="hs-comment">-- So for now we use it only for serial streams.</span><span>
</span><span id="line-828"></span><span class="hs-comment">-- XXX fusion would be easier for monomoprhic stream types.</span><span>
</span><span id="line-829"></span><span class="hs-comment">-- {-# RULES &quot;mapM serial&quot; mapM = mapMSerial #-}</span><span>
</span><span id="line-830"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapMSerial"><span class="hs-pragma hs-type">mapMSerial</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-831"></span><span id="local-6989586621679370401"><span id="local-6989586621679370402"><span id="local-6989586621679370403"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapMSerial"><span class="hs-identifier hs-type">mapMSerial</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370403"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370402"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370403"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370401"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370403"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370402"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370403"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370401"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-832"></span><span id="mapMSerial"><span class="annot"><span class="annottext">mapMSerial :: forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapMSerial"><span class="hs-identifier hs-var hs-var">mapMSerial</span></a></span></span><span> </span><span id="local-6989586621679369664"><span class="annot"><span class="annottext">a -&gt; m b
</span><a href="#local-6989586621679369664"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679369663"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369663"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
Monad m =&gt;
((m a -&gt; Stream m a -&gt; Stream m a) -&gt; Stream m a -&gt; Stream m a)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#buildSM"><span class="hs-identifier hs-var">buildSM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679369662"><span class="annot"><span class="annottext">m b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369662"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679369661"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369661"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
Monad m =&gt;
(m a -&gt; Stream m b -&gt; Stream m b)
-&gt; Stream m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSMShared"><span class="hs-identifier hs-var">foldrSMShared</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b (t :: (* -&gt; *) -&gt; * -&gt; *) a.
Monad m =&gt;
(m b -&gt; t m b -&gt; t m b) -&gt; (a -&gt; m b) -&gt; m a -&gt; t m b -&gt; t m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapMFB"><span class="hs-identifier hs-var">mapMFB</span></a></span><span> </span><span class="annot"><span class="annottext">m b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369662"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m b
</span><a href="#local-6989586621679369664"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369661"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369663"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-833"></span><span>
</span><span id="line-834"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapMWith"><span class="hs-pragma hs-type">mapMWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-835"></span><span id="local-6989586621679370395"><span id="local-6989586621679370396"><span id="local-6989586621679370397"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapMWith"><span class="hs-identifier hs-type">mapMWith</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-836"></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370397"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370396"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370397"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370396"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370397"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370396"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-837"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370395"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370397"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370396"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-838"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370397"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370395"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-839"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370397"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370396"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-840"></span><span id="mapMWith"><span class="annot"><span class="annottext">mapMWith :: forall (m :: * -&gt; *) b a.
(m b -&gt; Stream m b -&gt; Stream m b)
-&gt; (a -&gt; m b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mapMWith"><span class="hs-identifier hs-var hs-var">mapMWith</span></a></span></span><span> </span><span id="local-6989586621679369660"><span class="annot"><span class="annottext">m b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369660"><span class="hs-identifier hs-var">cns</span></a></span></span><span> </span><span id="local-6989586621679369659"><span class="annot"><span class="annottext">a -&gt; m b
</span><a href="#local-6989586621679369659"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *) b.
(a -&gt; Stream m b -&gt; Stream m b)
-&gt; Stream m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrSShared"><span class="hs-identifier hs-var">foldrSShared</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679369658"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369658"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679369657"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369657"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; m b
</span><a href="#local-6989586621679369659"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369658"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">m b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369660"><span class="hs-operator hs-var">`cns`</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369657"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-identifier hs-var">nil</span></a></span><span>
</span><span id="line-841"></span><span>
</span><span id="line-842"></span><span class="hs-comment">{-
-- See note under map definition above.
mapMWith cns f = go
    where
    go m1 = mkStream $ \st yld sng stp -&gt;
        let single a  = f a &gt;&gt;= sng
            yieldk a r = foldStreamShared st yld sng stp $ f a `cns` go r
         in foldStream (adaptState st) yieldk single stp m1
-}</span><span>
</span><span id="line-851"></span><span>
</span><span id="line-852"></span><span class="hs-comment">-- XXX in fact use the Stream type everywhere and only use polymorphism in the</span><span>
</span><span id="line-853"></span><span class="hs-comment">-- high level modules/prelude.</span><span>
</span><span id="line-854"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679369654"><span id="local-6989586621679370386"><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370386"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Functor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370386"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-855"></span><span>    </span><span id="local-6989586621679369652"><span class="annot"><span class="annottext">fmap :: forall a b. (a -&gt; b) -&gt; Stream m a -&gt; Stream m b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">fmap</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b (m :: * -&gt; *). (a -&gt; b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#map"><span class="hs-identifier hs-var">map</span></a></span><span>
</span><span id="line-856"></span><span>
</span><span id="line-857"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-858"></span><span class="hs-comment">-- Transformers</span><span>
</span><span id="line-859"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-860"></span><span>
</span><span id="line-861"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTrans</span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-862"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><span class="hs-pragma hs-type">lift</span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-863"></span><span>    </span><span id="local-6989586621679369646"><span class="annot"><span class="annottext">lift :: forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; Stream m a
</span><a href="#local-6989586621679369646"><span class="hs-identifier hs-var hs-var hs-var hs-var">lift</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromEffect"><span class="hs-identifier hs-var">fromEffect</span></a></span><span>
</span><span id="line-864"></span><span>
</span><span id="line-865"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-866"></span><span class="hs-comment">-- Nesting</span><span>
</span><span id="line-867"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-868"></span><span>
</span><span id="line-869"></span><span class="hs-comment">-- | Detach a stream from an SVar</span><span>
</span><span id="line-870"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#unShare"><span class="hs-pragma hs-type">unShare</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-871"></span><span id="local-6989586621679369644"><span id="local-6989586621679369645"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#unShare"><span class="hs-identifier hs-type">unShare</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369645"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369644"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369645"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369644"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-872"></span><span id="unShare"><span class="annot"><span class="annottext">unShare :: forall (m :: * -&gt; *) a. Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#unShare"><span class="hs-identifier hs-var hs-var">unShare</span></a></span></span><span> </span><span id="local-6989586621679369643"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369643"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369642"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369642"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369641"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369641"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369640"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369640"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369639"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369639"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-873"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369642"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369641"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369640"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369639"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369643"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-874"></span><span>
</span><span id="line-875"></span><span class="hs-comment">-- XXX the function stream and value stream can run in parallel</span><span>
</span><span id="line-876"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#apWith"><span class="hs-pragma hs-type">apWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-877"></span><span id="local-6989586621679370375"><span id="local-6989586621679370376"><span id="local-6989586621679370377"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#apWith"><span class="hs-identifier hs-type">apWith</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-878"></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370377"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370376"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370377"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370376"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370377"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370376"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-879"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370377"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370375"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370376"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-880"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370377"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370375"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-881"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370377"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370376"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-882"></span><span id="apWith"><span class="annot"><span class="annottext">apWith :: forall (m :: * -&gt; *) b a.
(Stream m b -&gt; Stream m b -&gt; Stream m b)
-&gt; Stream m (a -&gt; b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#apWith"><span class="hs-identifier hs-var hs-var">apWith</span></a></span></span><span> </span><span id="local-6989586621679369638"><span class="annot"><span class="annottext">Stream m b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369638"><span class="hs-identifier hs-var">par</span></a></span></span><span> </span><span id="local-6989586621679369637"><span class="annot"><span class="annottext">Stream m (a -&gt; b)
</span><a href="#local-6989586621679369637"><span class="hs-identifier hs-var">fstream</span></a></span></span><span> </span><span id="local-6989586621679369636"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369636"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m (a -&gt; b) -&gt; Stream m b
</span><a href="#local-6989586621679369635"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (a -&gt; b)
</span><a href="#local-6989586621679369637"><span class="hs-identifier hs-var">fstream</span></a></span><span>
</span><span id="line-883"></span><span>
</span><span id="line-884"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-885"></span><span>
</span><span id="line-886"></span><span>    </span><span id="local-6989586621679369635"><span class="annot"><span class="annottext">go1 :: Stream m (a -&gt; b) -&gt; Stream m b
</span><a href="#local-6989586621679369635"><span class="hs-identifier hs-var hs-var">go1</span></a></span></span><span> </span><span id="local-6989586621679369634"><span class="annot"><span class="annottext">Stream m (a -&gt; b)
</span><a href="#local-6989586621679369634"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-887"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369633"><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369633"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369632"><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369632"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369631"><span class="annot"><span class="annottext">b -&gt; m r
</span><a href="#local-6989586621679369631"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369630"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369630"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-888"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369629"><span class="annot"><span class="annottext">foldShared :: Stream m b -&gt; m r
</span><a href="#local-6989586621679369629"><span class="hs-identifier hs-var hs-var">foldShared</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369633"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369632"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; m r
</span><a href="#local-6989586621679369631"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369630"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-889"></span><span>                </span><span id="local-6989586621679369628"><span class="annot"><span class="annottext">single :: (a -&gt; b) -&gt; m r
</span><a href="#local-6989586621679369628"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369627"><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621679369627"><span class="hs-identifier hs-var">f</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369629"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#unShare"><span class="hs-identifier hs-var">unShare</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b (m :: * -&gt; *). (a -&gt; b) -&gt; Stream m a -&gt; Stream m b
</span><a href="#local-6989586621679369626"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621679369627"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369636"><span class="hs-identifier hs-var">stream</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-890"></span><span>                </span><span id="local-6989586621679369625"><span class="annot"><span class="annottext">yieldk :: (a -&gt; b) -&gt; Stream m (a -&gt; b) -&gt; m r
</span><a href="#local-6989586621679369625"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369624"><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621679369624"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679369623"><span class="annot"><span class="annottext">Stream m (a -&gt; b)
</span><a href="#local-6989586621679369623"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369629"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#unShare"><span class="hs-identifier hs-var">unShare</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b (m :: * -&gt; *). (a -&gt; b) -&gt; Stream m a -&gt; Stream m b
</span><a href="#local-6989586621679369626"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621679369624"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369636"><span class="hs-identifier hs-var">stream</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369638"><span class="hs-operator hs-var">`par`</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (a -&gt; b) -&gt; Stream m b
</span><a href="#local-6989586621679369635"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (a -&gt; b)
</span><a href="#local-6989586621679369623"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-891"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369633"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(a -&gt; b) -&gt; Stream m (a -&gt; b) -&gt; m r
</span><a href="#local-6989586621679369625"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; b) -&gt; m r
</span><a href="#local-6989586621679369628"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369630"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (a -&gt; b)
</span><a href="#local-6989586621679369634"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-892"></span><span>
</span><span id="line-893"></span><span>    </span><span id="local-6989586621679369626"><span class="annot"><span class="annottext">go2 :: (t -&gt; a) -&gt; Stream m t -&gt; Stream m a
</span><a href="#local-6989586621679369626"><span class="hs-identifier hs-var hs-var">go2</span></a></span></span><span> </span><span id="local-6989586621679369622"><span class="annot"><span class="annottext">t -&gt; a
</span><a href="#local-6989586621679369622"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679369621"><span class="annot"><span class="annottext">Stream m t
</span><a href="#local-6989586621679369621"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-894"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369620"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369620"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369619"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369619"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369618"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369618"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369617"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369617"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-895"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369616"><span class="annot"><span class="annottext">single :: t -&gt; m r
</span><a href="#local-6989586621679369616"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369615"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679369615"><span class="hs-identifier hs-var">a</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369618"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t -&gt; a
</span><a href="#local-6989586621679369622"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679369615"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-896"></span><span>                </span><span id="local-6989586621679369614"><span class="annot"><span class="annottext">yieldk :: t -&gt; Stream m t -&gt; m r
</span><a href="#local-6989586621679369614"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369613"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679369613"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369612"><span class="annot"><span class="annottext">Stream m t
</span><a href="#local-6989586621679369612"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369619"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t -&gt; a
</span><a href="#local-6989586621679369622"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679369613"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(t -&gt; a) -&gt; Stream m t -&gt; Stream m a
</span><a href="#local-6989586621679369626"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; a
</span><a href="#local-6989586621679369622"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m t
</span><a href="#local-6989586621679369612"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-897"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369620"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">t -&gt; Stream m t -&gt; m r
</span><a href="#local-6989586621679369614"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; m r
</span><a href="#local-6989586621679369616"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369617"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m t
</span><a href="#local-6989586621679369621"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-898"></span><span>
</span><span id="line-899"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#apSerial"><span class="hs-pragma hs-type">apSerial</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-900"></span><span id="local-6989586621679370364"><span id="local-6989586621679370365"><span id="local-6989586621679370366"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#apSerial"><span class="hs-identifier hs-type">apSerial</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-901"></span><span>       </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370366"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370365"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370364"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-902"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370366"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370365"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-903"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370366"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370364"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-904"></span><span id="apSerial"><span class="annot"><span class="annottext">apSerial :: forall (m :: * -&gt; *) a b.
Stream m (a -&gt; b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#apSerial"><span class="hs-identifier hs-var hs-var">apSerial</span></a></span></span><span> </span><span id="local-6989586621679369611"><span class="annot"><span class="annottext">Stream m (a -&gt; b)
</span><a href="#local-6989586621679369611"><span class="hs-identifier hs-var">fstream</span></a></span></span><span> </span><span id="local-6989586621679369610"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369610"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {a}. Stream m (a -&gt; a) -&gt; Stream m a
</span><a href="#local-6989586621679369609"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (a -&gt; b)
</span><a href="#local-6989586621679369611"><span class="hs-identifier hs-var">fstream</span></a></span><span>
</span><span id="line-905"></span><span>
</span><span id="line-906"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-907"></span><span>
</span><span id="line-908"></span><span>    </span><span id="local-6989586621679369609"><span class="annot"><span class="annottext">go1 :: Stream m (a -&gt; a) -&gt; Stream m a
</span><a href="#local-6989586621679369609"><span class="hs-identifier hs-var hs-var">go1</span></a></span></span><span> </span><span id="local-6989586621679369608"><span class="annot"><span class="annottext">Stream m (a -&gt; a)
</span><a href="#local-6989586621679369608"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-909"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369607"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369607"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369606"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369606"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369605"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369605"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369604"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369604"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-910"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369603"><span class="annot"><span class="annottext">foldShared :: Stream m a -&gt; m r
</span><a href="#local-6989586621679369603"><span class="hs-identifier hs-var hs-var">foldShared</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369607"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369606"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369605"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369604"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-911"></span><span>                </span><span id="local-6989586621679369602"><span class="annot"><span class="annottext">single :: (a -&gt; a) -&gt; m r
</span><a href="#local-6989586621679369602"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369601"><span class="annot"><span class="annottext">a -&gt; a
</span><a href="#local-6989586621679369601"><span class="hs-identifier hs-var">f</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; m r
</span><a href="#local-6989586621679369603"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b (m :: * -&gt; *). (a -&gt; b) -&gt; Stream m a -&gt; Stream m b
</span><a href="#local-6989586621679369600"><span class="hs-identifier hs-var">go3</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a
</span><a href="#local-6989586621679369601"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369610"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-912"></span><span>                </span><span id="local-6989586621679369599"><span class="annot"><span class="annottext">yieldk :: (a -&gt; a) -&gt; Stream m (a -&gt; a) -&gt; m r
</span><a href="#local-6989586621679369599"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369598"><span class="annot"><span class="annottext">a -&gt; a
</span><a href="#local-6989586621679369598"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679369597"><span class="annot"><span class="annottext">Stream m (a -&gt; a)
</span><a href="#local-6989586621679369597"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; m r
</span><a href="#local-6989586621679369603"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; a) -&gt; Stream m (a -&gt; a) -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369596"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a
</span><a href="#local-6989586621679369598"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (a -&gt; a)
</span><a href="#local-6989586621679369597"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369610"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-913"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369607"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(a -&gt; a) -&gt; Stream m (a -&gt; a) -&gt; m r
</span><a href="#local-6989586621679369599"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; a) -&gt; m r
</span><a href="#local-6989586621679369602"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369604"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (a -&gt; a)
</span><a href="#local-6989586621679369608"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-914"></span><span>
</span><span id="line-915"></span><span>    </span><span id="local-6989586621679369596"><span class="annot"><span class="annottext">go2 :: (a -&gt; a) -&gt; Stream m (a -&gt; a) -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369596"><span class="hs-identifier hs-var hs-var">go2</span></a></span></span><span> </span><span id="local-6989586621679369595"><span class="annot"><span class="annottext">a -&gt; a
</span><a href="#local-6989586621679369595"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679369594"><span class="annot"><span class="annottext">Stream m (a -&gt; a)
</span><a href="#local-6989586621679369594"><span class="hs-identifier hs-var">r1</span></a></span></span><span> </span><span id="local-6989586621679369593"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369593"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-916"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369592"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369592"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369591"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369591"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369590"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369590"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369589"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369589"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-917"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369588"><span class="annot"><span class="annottext">foldShared :: Stream m a -&gt; m r
</span><a href="#local-6989586621679369588"><span class="hs-identifier hs-var hs-var">foldShared</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369592"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369591"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369590"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369589"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-918"></span><span>                </span><span id="local-6989586621679369587"><span class="annot"><span class="annottext">stop :: m r
</span><a href="#local-6989586621679369587"><span class="hs-identifier hs-var hs-var">stop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; m r
</span><a href="#local-6989586621679369588"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m (a -&gt; a) -&gt; Stream m a
</span><a href="#local-6989586621679369609"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (a -&gt; a)
</span><a href="#local-6989586621679369594"><span class="hs-identifier hs-var">r1</span></a></span><span>
</span><span id="line-919"></span><span>                </span><span id="local-6989586621679369586"><span class="annot"><span class="annottext">single :: a -&gt; m r
</span><a href="#local-6989586621679369586"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369585"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369585"><span class="hs-identifier hs-var">a</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369591"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; a
</span><a href="#local-6989586621679369595"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369585"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m (a -&gt; a) -&gt; Stream m a
</span><a href="#local-6989586621679369609"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (a -&gt; a)
</span><a href="#local-6989586621679369594"><span class="hs-identifier hs-var">r1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-920"></span><span>                </span><span id="local-6989586621679369584"><span class="annot"><span class="annottext">yieldk :: a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369584"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369583"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369583"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369582"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369582"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369591"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; a
</span><a href="#local-6989586621679369595"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369583"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a -&gt; a) -&gt; Stream m (a -&gt; a) -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369596"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a
</span><a href="#local-6989586621679369595"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (a -&gt; a)
</span><a href="#local-6989586621679369594"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369582"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-921"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369592"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369584"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369586"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369587"><span class="hs-identifier hs-var">stop</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369593"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-922"></span><span>
</span><span id="line-923"></span><span>    </span><span id="local-6989586621679369600"><span class="annot"><span class="annottext">go3 :: (t -&gt; a) -&gt; Stream m t -&gt; Stream m a
</span><a href="#local-6989586621679369600"><span class="hs-identifier hs-var hs-var">go3</span></a></span></span><span> </span><span id="local-6989586621679369581"><span class="annot"><span class="annottext">t -&gt; a
</span><a href="#local-6989586621679369581"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679369580"><span class="annot"><span class="annottext">Stream m t
</span><a href="#local-6989586621679369580"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-924"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369579"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369579"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369578"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369578"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369577"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369577"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369576"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369576"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-925"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369575"><span class="annot"><span class="annottext">single :: t -&gt; m r
</span><a href="#local-6989586621679369575"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369574"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679369574"><span class="hs-identifier hs-var">a</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369577"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t -&gt; a
</span><a href="#local-6989586621679369581"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679369574"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-926"></span><span>                </span><span id="local-6989586621679369573"><span class="annot"><span class="annottext">yieldk :: t -&gt; Stream m t -&gt; m r
</span><a href="#local-6989586621679369573"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369572"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679369572"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369571"><span class="annot"><span class="annottext">Stream m t
</span><a href="#local-6989586621679369571"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369578"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t -&gt; a
</span><a href="#local-6989586621679369581"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679369572"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(t -&gt; a) -&gt; Stream m t -&gt; Stream m a
</span><a href="#local-6989586621679369600"><span class="hs-identifier hs-var">go3</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; a
</span><a href="#local-6989586621679369581"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m t
</span><a href="#local-6989586621679369571"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-927"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369579"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">t -&gt; Stream m t -&gt; m r
</span><a href="#local-6989586621679369573"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; m r
</span><a href="#local-6989586621679369575"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369576"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m t
</span><a href="#local-6989586621679369580"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-928"></span><span>
</span><span id="line-929"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#apSerialDiscardFst"><span class="hs-pragma hs-type">apSerialDiscardFst</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-930"></span><span id="local-6989586621679370351"><span id="local-6989586621679370352"><span id="local-6989586621679370353"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#apSerialDiscardFst"><span class="hs-identifier hs-type">apSerialDiscardFst</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-931"></span><span>       </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370353"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370352"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-932"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370353"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370351"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-933"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370353"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370351"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-934"></span><span id="apSerialDiscardFst"><span class="annot"><span class="annottext">apSerialDiscardFst :: forall (m :: * -&gt; *) a b. Stream m a -&gt; Stream m b -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#apSerialDiscardFst"><span class="hs-identifier hs-var hs-var">apSerialDiscardFst</span></a></span></span><span> </span><span id="local-6989586621679369570"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369570"><span class="hs-identifier hs-var">fstream</span></a></span></span><span> </span><span id="local-6989586621679369569"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369569"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {a}. Stream m a -&gt; Stream m b
</span><a href="#local-6989586621679369568"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369570"><span class="hs-identifier hs-var">fstream</span></a></span><span>
</span><span id="line-935"></span><span>
</span><span id="line-936"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-937"></span><span>
</span><span id="line-938"></span><span>    </span><span id="local-6989586621679369568"><span class="annot"><span class="annottext">go1 :: Stream m a -&gt; Stream m b
</span><a href="#local-6989586621679369568"><span class="hs-identifier hs-var hs-var">go1</span></a></span></span><span> </span><span id="local-6989586621679369567"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369567"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-939"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369566"><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369566"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369565"><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369565"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369564"><span class="annot"><span class="annottext">b -&gt; m r
</span><a href="#local-6989586621679369564"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369563"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369563"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-940"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369562"><span class="annot"><span class="annottext">foldShared :: Stream m b -&gt; m r
</span><a href="#local-6989586621679369562"><span class="hs-identifier hs-var hs-var">foldShared</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369566"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369565"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; m r
</span><a href="#local-6989586621679369564"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369563"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-941"></span><span>                </span><span id="local-6989586621679369561"><span class="annot"><span class="annottext">single :: p -&gt; m r
</span><a href="#local-6989586621679369561"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369562"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369569"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-942"></span><span>                </span><span id="local-6989586621679369560"><span class="annot"><span class="annottext">yieldk :: p -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369560"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679369559"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369559"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369562"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369558"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369559"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369569"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-943"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369566"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall {p}. p -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369560"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">forall {p}. p -&gt; m r
</span><a href="#local-6989586621679369561"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369563"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369567"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-944"></span><span>
</span><span id="line-945"></span><span>    </span><span id="local-6989586621679369558"><span class="annot"><span class="annottext">go2 :: Stream m a -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369558"><span class="hs-identifier hs-var hs-var">go2</span></a></span></span><span> </span><span id="local-6989586621679369557"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369557"><span class="hs-identifier hs-var">r1</span></a></span></span><span> </span><span id="local-6989586621679369556"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369556"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-946"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369555"><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369555"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369554"><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369554"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369553"><span class="annot"><span class="annottext">b -&gt; m r
</span><a href="#local-6989586621679369553"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369552"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369552"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-947"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369551"><span class="annot"><span class="annottext">foldShared :: Stream m b -&gt; m r
</span><a href="#local-6989586621679369551"><span class="hs-identifier hs-var hs-var">foldShared</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369555"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369554"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; m r
</span><a href="#local-6989586621679369553"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369552"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-948"></span><span>                </span><span id="local-6989586621679369550"><span class="annot"><span class="annottext">stop :: m r
</span><a href="#local-6989586621679369550"><span class="hs-identifier hs-var hs-var">stop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369551"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; Stream m b
</span><a href="#local-6989586621679369568"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369557"><span class="hs-identifier hs-var">r1</span></a></span><span>
</span><span id="line-949"></span><span>                </span><span id="local-6989586621679369549"><span class="annot"><span class="annottext">single :: b -&gt; m r
</span><a href="#local-6989586621679369549"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369548"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369548"><span class="hs-identifier hs-var">a</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369554"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369548"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m a -&gt; Stream m b
</span><a href="#local-6989586621679369568"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369557"><span class="hs-identifier hs-var">r1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-950"></span><span>                </span><span id="local-6989586621679369547"><span class="annot"><span class="annottext">yieldk :: b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369547"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369546"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369546"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369545"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369545"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369554"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369546"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m a -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369558"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369557"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369545"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-951"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369555"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369547"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; m r
</span><a href="#local-6989586621679369549"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369550"><span class="hs-identifier hs-var">stop</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369556"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-952"></span><span>
</span><span id="line-953"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#apSerialDiscardSnd"><span class="hs-pragma hs-type">apSerialDiscardSnd</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-954"></span><span id="local-6989586621679370340"><span id="local-6989586621679370341"><span id="local-6989586621679370342"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#apSerialDiscardSnd"><span class="hs-identifier hs-type">apSerialDiscardSnd</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-955"></span><span>       </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370342"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370341"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-956"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370342"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370340"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-957"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370342"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370341"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-958"></span><span id="apSerialDiscardSnd"><span class="annot"><span class="annottext">apSerialDiscardSnd :: forall (m :: * -&gt; *) a b. Stream m a -&gt; Stream m b -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#apSerialDiscardSnd"><span class="hs-identifier hs-var hs-var">apSerialDiscardSnd</span></a></span></span><span> </span><span id="local-6989586621679369544"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369544"><span class="hs-identifier hs-var">fstream</span></a></span></span><span> </span><span id="local-6989586621679369543"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369543"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {a}. Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369542"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369544"><span class="hs-identifier hs-var">fstream</span></a></span><span>
</span><span id="line-959"></span><span>
</span><span id="line-960"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-961"></span><span>
</span><span id="line-962"></span><span>    </span><span id="local-6989586621679369542"><span class="annot"><span class="annottext">go1 :: Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369542"><span class="hs-identifier hs-var hs-var">go1</span></a></span></span><span> </span><span id="local-6989586621679369541"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369541"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-963"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369540"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369540"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369539"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369539"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369538"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369538"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369537"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369537"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-964"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369536"><span class="annot"><span class="annottext">foldShared :: Stream m a -&gt; m r
</span><a href="#local-6989586621679369536"><span class="hs-identifier hs-var hs-var">foldShared</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369540"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369539"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369538"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369537"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-965"></span><span>                </span><span id="local-6989586621679369535"><span class="annot"><span class="annottext">single :: a -&gt; m r
</span><a href="#local-6989586621679369535"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369534"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369534"><span class="hs-identifier hs-var">f</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; m r
</span><a href="#local-6989586621679369536"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall {a} {m :: * -&gt; *} {a}. a -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369533"><span class="hs-identifier hs-var">go3</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369534"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369543"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-966"></span><span>                </span><span id="local-6989586621679369532"><span class="annot"><span class="annottext">yieldk :: a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369532"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369531"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369531"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679369530"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369530"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; m r
</span><a href="#local-6989586621679369536"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; Stream m b -&gt; Stream m a
</span><a href="#local-6989586621679369529"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369531"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369530"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369543"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-967"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369540"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369532"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369535"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369537"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369541"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-968"></span><span>
</span><span id="line-969"></span><span>    </span><span id="local-6989586621679369529"><span class="annot"><span class="annottext">go2 :: a -&gt; Stream m a -&gt; Stream m b -&gt; Stream m a
</span><a href="#local-6989586621679369529"><span class="hs-identifier hs-var hs-var">go2</span></a></span></span><span> </span><span id="local-6989586621679369528"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369528"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679369527"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369527"><span class="hs-identifier hs-var">r1</span></a></span></span><span> </span><span id="local-6989586621679369526"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369526"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-970"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369525"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369525"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369524"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369524"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369523"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369523"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369522"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369522"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-971"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369521"><span class="annot"><span class="annottext">foldShared :: Stream m a -&gt; m r
</span><a href="#local-6989586621679369521"><span class="hs-identifier hs-var hs-var">foldShared</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369525"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369524"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369523"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369522"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-972"></span><span>                </span><span id="local-6989586621679369520"><span class="annot"><span class="annottext">stop :: m r
</span><a href="#local-6989586621679369520"><span class="hs-identifier hs-var hs-var">stop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; m r
</span><a href="#local-6989586621679369521"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369542"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369527"><span class="hs-identifier hs-var">r1</span></a></span><span>
</span><span id="line-973"></span><span>                </span><span id="local-6989586621679369519"><span class="annot"><span class="annottext">single :: p -&gt; m r
</span><a href="#local-6989586621679369519"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369524"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369528"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369542"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369527"><span class="hs-identifier hs-var">r1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-974"></span><span>                </span><span id="local-6989586621679369518"><span class="annot"><span class="annottext">yieldk :: p -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369518"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679369517"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369517"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369524"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369528"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; Stream m b -&gt; Stream m a
</span><a href="#local-6989586621679369529"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369528"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369527"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369517"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-975"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369525"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall {p}. p -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369518"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">forall {p}. p -&gt; m r
</span><a href="#local-6989586621679369519"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369520"><span class="hs-identifier hs-var">stop</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369526"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-976"></span><span>
</span><span id="line-977"></span><span>    </span><span id="local-6989586621679369533"><span class="annot"><span class="annottext">go3 :: a -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369533"><span class="hs-identifier hs-var hs-var">go3</span></a></span></span><span> </span><span id="local-6989586621679369516"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369516"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679369515"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369515"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-978"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369514"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369514"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369513"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369513"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369512"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369512"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369511"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369511"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-979"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369510"><span class="annot"><span class="annottext">single :: p -&gt; m r
</span><a href="#local-6989586621679369510"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369512"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369516"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-980"></span><span>                </span><span id="local-6989586621679369509"><span class="annot"><span class="annottext">yieldk :: p -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369509"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679369508"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369508"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369513"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369516"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369533"><span class="hs-identifier hs-var">go3</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369516"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369508"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-981"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369514"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall {p}. p -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369509"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">forall {p}. p -&gt; m r
</span><a href="#local-6989586621679369510"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369511"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369515"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-982"></span><span>
</span><span id="line-983"></span><span class="hs-comment">-- XXX This is just concatMapWith with arguments flipped. We need to keep this</span><span>
</span><span id="line-984"></span><span class="hs-comment">-- instead of using a concatMap style definition because the bind</span><span>
</span><span id="line-985"></span><span class="hs-comment">-- implementation in Async and WAsync streams show significant perf degradation</span><span>
</span><span id="line-986"></span><span class="hs-comment">-- if the argument order is changed.</span><span>
</span><span id="line-987"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#bindWith"><span class="hs-pragma hs-type">bindWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-988"></span><span id="local-6989586621679370323"><span id="local-6989586621679370324"><span id="local-6989586621679370325"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#bindWith"><span class="hs-identifier hs-type">bindWith</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-989"></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370325"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370324"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370325"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370324"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370325"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370324"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-990"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370325"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370323"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-991"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370323"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370325"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370324"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-992"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370325"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370324"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-993"></span><span id="bindWith"><span class="annot"><span class="annottext">bindWith :: forall (m :: * -&gt; *) b a.
(Stream m b -&gt; Stream m b -&gt; Stream m b)
-&gt; Stream m a -&gt; (a -&gt; Stream m b) -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#bindWith"><span class="hs-identifier hs-var hs-var">bindWith</span></a></span></span><span> </span><span id="local-6989586621679369507"><span class="annot"><span class="annottext">Stream m b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369507"><span class="hs-identifier hs-var">par</span></a></span></span><span> </span><span id="local-6989586621679369506"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369506"><span class="hs-identifier hs-var">m1</span></a></span></span><span> </span><span id="local-6989586621679369505"><span class="annot"><span class="annottext">a -&gt; Stream m b
</span><a href="#local-6989586621679369505"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; Stream m b
</span><a href="#local-6989586621679369504"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369506"><span class="hs-identifier hs-var">m1</span></a></span><span>
</span><span id="line-994"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-995"></span><span>        </span><span id="local-6989586621679369504"><span class="annot"><span class="annottext">go :: Stream m a -&gt; Stream m b
</span><a href="#local-6989586621679369504"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679369503"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369503"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-996"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369502"><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369502"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369501"><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369501"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369500"><span class="annot"><span class="annottext">b -&gt; m r
</span><a href="#local-6989586621679369500"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369499"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369499"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-997"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369498"><span class="annot"><span class="annottext">foldShared :: Stream m b -&gt; m r
</span><a href="#local-6989586621679369498"><span class="hs-identifier hs-var hs-var">foldShared</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369502"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369501"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; m r
</span><a href="#local-6989586621679369500"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369499"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-998"></span><span>                    </span><span id="local-6989586621679369497"><span class="annot"><span class="annottext">single :: a -&gt; m r
</span><a href="#local-6989586621679369497"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369496"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369496"><span class="hs-identifier hs-var">a</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369498"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#unShare"><span class="hs-identifier hs-var">unShare</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Stream m b
</span><a href="#local-6989586621679369505"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369496"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-999"></span><span>                    </span><span id="local-6989586621679369495"><span class="annot"><span class="annottext">yieldk :: a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369495"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369494"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369494"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369493"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369493"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369498"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#unShare"><span class="hs-identifier hs-var">unShare</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Stream m b
</span><a href="#local-6989586621679369505"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369494"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369507"><span class="hs-operator hs-var">`par`</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; Stream m b
</span><a href="#local-6989586621679369504"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369493"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1000"></span><span>                </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369502"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369495"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369497"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369499"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369503"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1001"></span><span>
</span><span id="line-1002"></span><span class="hs-comment">-- XXX express in terms of foldrS?</span><span>
</span><span id="line-1003"></span><span class="hs-comment">-- XXX can we use a different stream type for the generated stream being</span><span>
</span><span id="line-1004"></span><span class="hs-comment">-- falttened so that we can combine them differently and keep the resulting</span><span>
</span><span id="line-1005"></span><span class="hs-comment">-- stream different?</span><span>
</span><span id="line-1006"></span><span class="hs-comment">-- XXX do we need specialize to IO?</span><span>
</span><span id="line-1007"></span><span class="hs-comment">-- XXX can we optimize when c and a are same, by removing the forall using</span><span>
</span><span id="line-1008"></span><span class="hs-comment">-- rewrite rules with type applications?</span><span>
</span><span id="line-1009"></span><span>
</span><span id="line-1010"></span><span class="hs-comment">-- | Perform a 'concatMap' using a specified concat strategy. The first</span><span>
</span><span id="line-1011"></span><span class="hs-comment">-- argument specifies a merge or concat function that is used to merge the</span><span>
</span><span id="line-1012"></span><span class="hs-comment">-- streams generated by the map function. For example, the concat function</span><span>
</span><span id="line-1013"></span><span class="hs-comment">-- could be 'serial', 'parallel', 'async', 'ahead' or any other zip or merge</span><span>
</span><span id="line-1014"></span><span class="hs-comment">-- function.</span><span>
</span><span id="line-1015"></span><span class="hs-comment">--</span><span>
</span><span id="line-1016"></span><span class="hs-comment">-- @since 0.7.0</span><span>
</span><span id="line-1017"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#concatMapWith"><span class="hs-pragma hs-type">concatMapWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1018"></span><span id="local-6989586621679370316"><span id="local-6989586621679370317"><span id="local-6989586621679370318"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#concatMapWith"><span class="hs-identifier hs-type">concatMapWith</span></a></span><span>
</span><span id="line-1019"></span><span>    </span><span class="hs-glyph">::</span><span>
</span><span id="line-1020"></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370318"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370317"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370318"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370317"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370318"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370317"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1021"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370316"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370318"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370317"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1022"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370318"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370316"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1023"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370318"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370317"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-1024"></span><span id="concatMapWith"><span class="annot"><span class="annottext">concatMapWith :: forall (m :: * -&gt; *) b a.
(Stream m b -&gt; Stream m b -&gt; Stream m b)
-&gt; (a -&gt; Stream m b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#concatMapWith"><span class="hs-identifier hs-var hs-var">concatMapWith</span></a></span></span><span> </span><span id="local-6989586621679369492"><span class="annot"><span class="annottext">Stream m b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369492"><span class="hs-identifier hs-var">par</span></a></span></span><span> </span><span id="local-6989586621679369491"><span class="annot"><span class="annottext">a -&gt; Stream m b
</span><a href="#local-6989586621679369491"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679369490"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369490"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b a.
(Stream m b -&gt; Stream m b -&gt; Stream m b)
-&gt; Stream m a -&gt; (a -&gt; Stream m b) -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#bindWith"><span class="hs-identifier hs-var">bindWith</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369492"><span class="hs-identifier hs-var">par</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369490"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m b
</span><a href="#local-6989586621679369491"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-1025"></span><span>
</span><span id="line-1026"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#concatMap"><span class="hs-pragma hs-type">concatMap</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1027"></span><span id="local-6989586621679370310"><span id="local-6989586621679370311"><span id="local-6989586621679370312"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#concatMap"><span class="hs-identifier hs-type">concatMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370312"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370311"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370310"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370311"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370312"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370311"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370310"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-1028"></span><span id="concatMap"><span class="annot"><span class="annottext">concatMap :: forall a (m :: * -&gt; *) b.
(a -&gt; Stream m b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#concatMap"><span class="hs-identifier hs-var hs-var">concatMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b a.
(Stream m b -&gt; Stream m b -&gt; Stream m b)
-&gt; (a -&gt; Stream m b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#concatMapWith"><span class="hs-identifier hs-var">concatMapWith</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#serial"><span class="hs-identifier hs-var">serial</span></a></span><span>
</span><span id="line-1029"></span><span>
</span><span id="line-1030"></span><span class="hs-comment">{-
-- Fused version.
-- XXX This fuses but when the stream is nil this performs poorly.
-- The filterAllOut benchmark degrades. Need to investigate and fix that.
{-# INLINE concatMap #-}
concatMap :: IsStream t =&gt; (a -&gt; t m b) -&gt; t m a -&gt; t m b
concatMap f xs = buildS
    (\c n -&gt; foldrS (\x b -&gt; foldrS c b (f x)) n xs)

-- Stream polymorphic concatMap implementation
-- XXX need to use buildSM/foldrSMShared for parallel behavior
-- XXX unShare seems to degrade the fused performance
{-# INLINE_EARLY concatMap_ #-}
concatMap_ :: IsStream t =&gt; (a -&gt; t m b) -&gt; t m a -&gt; t m b
concatMap_ f xs = buildS
     (\c n -&gt; foldrSShared (\x b -&gt; foldrSShared c b (unShare $ f x)) n xs)
-}</span><span>
</span><span id="line-1047"></span><span>
</span><span id="line-1048"></span><span class="hs-comment">-- | See 'Streamly.Internal.Data.Stream.IsStream.concatPairsWith' for</span><span>
</span><span id="line-1049"></span><span class="hs-comment">-- documentation.</span><span>
</span><span id="line-1050"></span><span class="hs-comment">--</span><span>
</span><span id="line-1051"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#concatPairsWith"><span class="hs-pragma hs-type">concatPairsWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1052"></span><span id="local-6989586621679369487"><span id="local-6989586621679369488"><span id="local-6989586621679369489"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#concatPairsWith"><span class="hs-identifier hs-type">concatPairsWith</span></a></span><span>
</span><span id="line-1053"></span><span>    </span><span class="hs-glyph">::</span><span>
</span><span id="line-1054"></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369489"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369488"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369489"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369488"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369489"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369488"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1055"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679369487"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369489"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369488"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1056"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369489"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369487"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1057"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369489"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369488"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-1058"></span><span id="concatPairsWith"><span class="annot"><span class="annottext">concatPairsWith :: forall (m :: * -&gt; *) b a.
(Stream m b -&gt; Stream m b -&gt; Stream m b)
-&gt; (a -&gt; Stream m b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#concatPairsWith"><span class="hs-identifier hs-var hs-var">concatPairsWith</span></a></span></span><span> </span><span id="local-6989586621679369486"><span class="annot"><span class="annottext">Stream m b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369486"><span class="hs-identifier hs-var">combine</span></a></span></span><span> </span><span id="local-6989586621679369485"><span class="annot"><span class="annottext">a -&gt; Stream m b
</span><a href="#local-6989586621679369485"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679369484"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369484"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m (Stream m b) -&gt; Stream m b
</span><a href="#local-6989586621679369483"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {m :: * -&gt; *}. Stream m a -&gt; Stream m (Stream m b)
</span><a href="#local-6989586621679369482"><span class="hs-identifier hs-var">leafPairs</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369484"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1059"></span><span>
</span><span id="line-1060"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1061"></span><span>
</span><span id="line-1062"></span><span>    </span><span id="local-6989586621679369483"><span class="annot"><span class="annottext">go :: Stream m (Stream m b) -&gt; Stream m b
</span><a href="#local-6989586621679369483"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679369481"><span class="annot"><span class="annottext">Stream m (Stream m b)
</span><a href="#local-6989586621679369481"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1063"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369480"><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369480"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369479"><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369479"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369478"><span class="annot"><span class="annottext">b -&gt; m r
</span><a href="#local-6989586621679369478"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369477"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369477"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1064"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369476"><span class="annot"><span class="annottext">foldShared :: Stream m b -&gt; m r
</span><a href="#local-6989586621679369476"><span class="hs-identifier hs-var hs-var">foldShared</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369480"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369479"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; m r
</span><a href="#local-6989586621679369478"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369477"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-1065"></span><span>                </span><span id="local-6989586621679369475"><span class="annot"><span class="annottext">single :: Stream m b -&gt; m r
</span><a href="#local-6989586621679369475"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369474"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369474"><span class="hs-identifier hs-var">a</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369476"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#unShare"><span class="hs-identifier hs-var">unShare</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369474"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-1066"></span><span>                </span><span id="local-6989586621679369473"><span class="annot"><span class="annottext">yieldk :: Stream m b -&gt; Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369473"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369472"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369472"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369471"><span class="annot"><span class="annottext">Stream m (Stream m b)
</span><a href="#local-6989586621679369471"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369476"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m (Stream m b) -&gt; Stream m b
</span><a href="#local-6989586621679369470"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369472"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (Stream m b)
</span><a href="#local-6989586621679369471"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1067"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369480"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369473"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369475"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369477"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (Stream m b)
</span><a href="#local-6989586621679369481"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-1068"></span><span>
</span><span id="line-1069"></span><span>    </span><span id="local-6989586621679369470"><span class="annot"><span class="annottext">go1 :: Stream m b -&gt; Stream m (Stream m b) -&gt; Stream m b
</span><a href="#local-6989586621679369470"><span class="hs-identifier hs-var hs-var">go1</span></a></span></span><span> </span><span id="local-6989586621679369469"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369469"><span class="hs-identifier hs-var">a1</span></a></span></span><span> </span><span id="local-6989586621679369468"><span class="annot"><span class="annottext">Stream m (Stream m b)
</span><a href="#local-6989586621679369468"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1070"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369467"><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369467"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369466"><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369466"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369465"><span class="annot"><span class="annottext">b -&gt; m r
</span><a href="#local-6989586621679369465"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369464"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369464"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1071"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369463"><span class="annot"><span class="annottext">foldShared :: Stream m b -&gt; m r
</span><a href="#local-6989586621679369463"><span class="hs-identifier hs-var hs-var">foldShared</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369467"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369466"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; m r
</span><a href="#local-6989586621679369465"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369464"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-1072"></span><span>                </span><span id="local-6989586621679369462"><span class="annot"><span class="annottext">stop :: m r
</span><a href="#local-6989586621679369462"><span class="hs-identifier hs-var hs-var">stop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369463"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#unShare"><span class="hs-identifier hs-var">unShare</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369469"><span class="hs-identifier hs-var">a1</span></a></span><span>
</span><span id="line-1073"></span><span>                </span><span id="local-6989586621679369461"><span class="annot"><span class="annottext">single :: Stream m b -&gt; m r
</span><a href="#local-6989586621679369461"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369460"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369460"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369463"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#unShare"><span class="hs-identifier hs-var">unShare</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369469"><span class="hs-identifier hs-var">a1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369486"><span class="hs-operator hs-var">`combine`</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369460"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-1074"></span><span>                </span><span id="local-6989586621679369459"><span class="annot"><span class="annottext">yieldk :: Stream m b -&gt; Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369459"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369458"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369458"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369457"><span class="annot"><span class="annottext">Stream m (Stream m b)
</span><a href="#local-6989586621679369457"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1075"></span><span>                    </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369463"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m (Stream m b) -&gt; Stream m b
</span><a href="#local-6989586621679369483"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369486"><span class="hs-identifier hs-var">combine</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369469"><span class="hs-identifier hs-var">a1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369458"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *). a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#cons"><span class="hs-operator hs-var">`cons`</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *}.
Stream m (Stream m b) -&gt; Stream m (Stream m b)
</span><a href="#local-6989586621679369456"><span class="hs-identifier hs-var">nonLeafPairs</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (Stream m b)
</span><a href="#local-6989586621679369457"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1076"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369467"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369459"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369461"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369462"><span class="hs-identifier hs-var">stop</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (Stream m b)
</span><a href="#local-6989586621679369468"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-1077"></span><span>
</span><span id="line-1078"></span><span>    </span><span class="hs-comment">-- Exactly the same as &quot;go&quot; except that stop continuation extracts the</span><span>
</span><span id="line-1079"></span><span>    </span><span class="hs-comment">-- stream.</span><span>
</span><span id="line-1080"></span><span>    </span><span id="local-6989586621679369482"><span class="annot"><span class="annottext">leafPairs :: Stream m a -&gt; Stream m (Stream m b)
</span><a href="#local-6989586621679369482"><span class="hs-identifier hs-var hs-var">leafPairs</span></a></span></span><span> </span><span id="local-6989586621679369455"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369455"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1081"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369454"><span class="annot"><span class="annottext">State Stream m (Stream m b)
</span><a href="#local-6989586621679369454"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369453"><span class="annot"><span class="annottext">Stream m b -&gt; Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369453"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369452"><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369452"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369451"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369451"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1082"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369450"><span class="annot"><span class="annottext">foldShared :: Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369450"><span class="hs-identifier hs-var hs-var">foldShared</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (Stream m b)
</span><a href="#local-6989586621679369454"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369453"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369452"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369451"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-1083"></span><span>                </span><span id="local-6989586621679369449"><span class="annot"><span class="annottext">single :: a -&gt; m r
</span><a href="#local-6989586621679369449"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369448"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369448"><span class="hs-identifier hs-var">a</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369452"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Stream m b
</span><a href="#local-6989586621679369485"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369448"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1084"></span><span>                </span><span id="local-6989586621679369447"><span class="annot"><span class="annottext">yieldk :: a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369447"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369446"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369446"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369445"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369445"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369450"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; Stream m (Stream m b)
</span><a href="#local-6989586621679369444"><span class="hs-identifier hs-var">leafPairs1</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369446"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369445"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1085"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (Stream m b)
</span><a href="#local-6989586621679369454"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369447"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369449"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369451"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369455"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-1086"></span><span>
</span><span id="line-1087"></span><span>    </span><span id="local-6989586621679369444"><span class="annot"><span class="annottext">leafPairs1 :: a -&gt; Stream m a -&gt; Stream m (Stream m b)
</span><a href="#local-6989586621679369444"><span class="hs-identifier hs-var hs-var">leafPairs1</span></a></span></span><span> </span><span id="local-6989586621679369443"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369443"><span class="hs-identifier hs-var">a1</span></a></span></span><span> </span><span id="local-6989586621679369442"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369442"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1088"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369441"><span class="annot"><span class="annottext">State Stream m (Stream m b)
</span><a href="#local-6989586621679369441"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369440"><span class="annot"><span class="annottext">Stream m b -&gt; Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369440"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369439"><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369439"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span class="annot"><span class="annottext">m r
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1089"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369438"><span class="annot"><span class="annottext">stop :: m r
</span><a href="#local-6989586621679369438"><span class="hs-identifier hs-var hs-var">stop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369439"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Stream m b
</span><a href="#local-6989586621679369485"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369443"><span class="hs-identifier hs-var">a1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1090"></span><span>                </span><span id="local-6989586621679369437"><span class="annot"><span class="annottext">single :: a -&gt; m r
</span><a href="#local-6989586621679369437"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369436"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369436"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369439"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Stream m b
</span><a href="#local-6989586621679369485"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369443"><span class="hs-identifier hs-var">a1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369486"><span class="hs-operator hs-var">`combine`</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m b
</span><a href="#local-6989586621679369485"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369436"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1091"></span><span>                </span><span id="local-6989586621679369435"><span class="annot"><span class="annottext">yieldk :: a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369435"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369434"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369434"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369433"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369433"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369440"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Stream m b
</span><a href="#local-6989586621679369485"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369443"><span class="hs-identifier hs-var">a1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369486"><span class="hs-operator hs-var">`combine`</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m b
</span><a href="#local-6989586621679369485"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369434"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m a -&gt; Stream m (Stream m b)
</span><a href="#local-6989586621679369482"><span class="hs-identifier hs-var">leafPairs</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369433"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1092"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (Stream m b)
</span><a href="#local-6989586621679369441"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369435"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369437"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369438"><span class="hs-identifier hs-var">stop</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369442"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-1093"></span><span>
</span><span id="line-1094"></span><span>    </span><span class="hs-comment">-- Exactly the same as &quot;leafPairs&quot; except that it does not map &quot;f&quot;</span><span>
</span><span id="line-1095"></span><span>    </span><span id="local-6989586621679369456"><span class="annot"><span class="annottext">nonLeafPairs :: Stream m (Stream m b) -&gt; Stream m (Stream m b)
</span><a href="#local-6989586621679369456"><span class="hs-identifier hs-var hs-var">nonLeafPairs</span></a></span></span><span> </span><span id="local-6989586621679369432"><span class="annot"><span class="annottext">Stream m (Stream m b)
</span><a href="#local-6989586621679369432"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1096"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369431"><span class="annot"><span class="annottext">State Stream m (Stream m b)
</span><a href="#local-6989586621679369431"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369430"><span class="annot"><span class="annottext">Stream m b -&gt; Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369430"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369429"><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369429"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369428"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369428"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1097"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369427"><span class="annot"><span class="annottext">foldShared :: Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369427"><span class="hs-identifier hs-var hs-var">foldShared</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (Stream m b)
</span><a href="#local-6989586621679369431"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369430"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369429"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369428"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-1098"></span><span>                </span><span id="local-6989586621679369426"><span class="annot"><span class="annottext">single :: Stream m b -&gt; m r
</span><a href="#local-6989586621679369426"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369425"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369425"><span class="hs-identifier hs-var">a</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369429"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369425"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-1099"></span><span>                </span><span id="local-6989586621679369424"><span class="annot"><span class="annottext">yieldk :: Stream m b -&gt; Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369424"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369423"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369423"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369422"><span class="annot"><span class="annottext">Stream m (Stream m b)
</span><a href="#local-6989586621679369422"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369427"><span class="hs-identifier hs-var">foldShared</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m (Stream m b) -&gt; Stream m (Stream m b)
</span><a href="#local-6989586621679369421"><span class="hs-identifier hs-var">nonLeafPairs1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369423"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (Stream m b)
</span><a href="#local-6989586621679369422"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1100"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (Stream m b)
</span><a href="#local-6989586621679369431"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369424"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369426"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369428"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (Stream m b)
</span><a href="#local-6989586621679369432"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-1101"></span><span>
</span><span id="line-1102"></span><span>    </span><span id="local-6989586621679369421"><span class="annot"><span class="annottext">nonLeafPairs1 :: Stream m b -&gt; Stream m (Stream m b) -&gt; Stream m (Stream m b)
</span><a href="#local-6989586621679369421"><span class="hs-identifier hs-var hs-var">nonLeafPairs1</span></a></span></span><span> </span><span id="local-6989586621679369420"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369420"><span class="hs-identifier hs-var">a1</span></a></span></span><span> </span><span id="local-6989586621679369419"><span class="annot"><span class="annottext">Stream m (Stream m b)
</span><a href="#local-6989586621679369419"><span class="hs-identifier hs-var">stream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1103"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369418"><span class="annot"><span class="annottext">State Stream m (Stream m b)
</span><a href="#local-6989586621679369418"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369417"><span class="annot"><span class="annottext">Stream m b -&gt; Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369417"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369416"><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369416"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span class="annot"><span class="annottext">m r
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1104"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369415"><span class="annot"><span class="annottext">stop :: m r
</span><a href="#local-6989586621679369415"><span class="hs-identifier hs-var hs-var">stop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369416"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369420"><span class="hs-identifier hs-var">a1</span></a></span><span>
</span><span id="line-1105"></span><span>                </span><span id="local-6989586621679369414"><span class="annot"><span class="annottext">single :: Stream m b -&gt; m r
</span><a href="#local-6989586621679369414"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369413"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369413"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369416"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369420"><span class="hs-identifier hs-var">a1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369486"><span class="hs-operator hs-var">`combine`</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369413"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1106"></span><span>                </span><span id="local-6989586621679369412"><span class="annot"><span class="annottext">yieldk :: Stream m b -&gt; Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369412"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369411"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369411"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369410"><span class="annot"><span class="annottext">Stream m (Stream m b)
</span><a href="#local-6989586621679369410"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369417"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369420"><span class="hs-identifier hs-var">a1</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m b -&gt; Stream m b
</span><a href="#local-6989586621679369486"><span class="hs-operator hs-var">`combine`</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369411"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m (Stream m b) -&gt; Stream m (Stream m b)
</span><a href="#local-6989586621679369456"><span class="hs-identifier hs-var">nonLeafPairs</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (Stream m b)
</span><a href="#local-6989586621679369410"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1107"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m (Stream m b)
</span><a href="#local-6989586621679369418"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m (Stream m b) -&gt; m r
</span><a href="#local-6989586621679369412"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369414"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369415"><span class="hs-identifier hs-var">stop</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (Stream m b)
</span><a href="#local-6989586621679369419"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-1108"></span><span>
</span><span id="line-1109"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679369400"><span id="local-6989586621679369402"><span id="local-6989586621679369404"><span id="local-6989586621679370290"><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370290"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370290"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1110"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><span class="hs-pragma hs-type">pure</span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1111"></span><span>    </span><span id="local-6989586621679369398"><span class="annot"><span class="annottext">pure :: forall a. a -&gt; Stream m a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">pure</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *). a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromPure"><span class="hs-identifier hs-var">fromPure</span></a></span><span>
</span><span id="line-1112"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">&lt;*&gt;</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1113"></span><span>    </span><span id="local-6989586621679369396"><span class="annot"><span class="annottext">&lt;*&gt; :: forall a b. Stream m (a -&gt; b) -&gt; Stream m a -&gt; Stream m b
</span><span class="hs-operator hs-var hs-var hs-var hs-var">(&lt;*&gt;)</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m (a -&gt; b) -&gt; m a -&gt; m b
</span><span class="hs-identifier hs-var">ap</span></span><span>
</span><span id="line-1114"></span><span>
</span><span id="line-1115"></span><span class="hs-comment">-- NOTE: even though concatMap for StreamD is 3x faster compared to StreamK,</span><span>
</span><span id="line-1116"></span><span class="hs-comment">-- the monad instance of StreamD is slower than StreamK after foldr/build</span><span>
</span><span id="line-1117"></span><span class="hs-comment">-- fusion.</span><span>
</span><span id="line-1118"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679369391"><span id="local-6989586621679370289"><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370289"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370289"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1119"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><span class="hs-pragma hs-type">return</span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1120"></span><span>    </span><span id="local-6989586621679369387"><span class="annot"><span class="annottext">return :: forall a. a -&gt; Stream m a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">return</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-1121"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">&gt;&gt;=</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1122"></span><span>    </span><span id="local-6989586621679369386"><span class="annot"><span class="annottext">&gt;&gt;= :: forall a b. Stream m a -&gt; (a -&gt; Stream m b) -&gt; Stream m b
</span><span class="hs-operator hs-var hs-var hs-var hs-var">(&gt;&gt;=)</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *) b.
(a -&gt; Stream m b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a></span><span>
</span><span id="line-1123"></span><span>
</span><span id="line-1124"></span><span class="hs-comment">{-
-- Like concatMap but generates stream using an unfold function. Similar to
-- unfoldMany but for StreamK.
concatUnfoldr :: IsStream t
    =&gt; (b -&gt; t m (Maybe (a, b))) -&gt; t m b -&gt; t m a
concatUnfoldr = undefined
-}</span><span>
</span><span id="line-1131"></span><span>
</span><span id="line-1132"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-1133"></span><span class="hs-comment">-- MonadReader</span><span>
</span><span id="line-1134"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-1135"></span><span>
</span><span id="line-1136"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#withLocal"><span class="hs-pragma hs-type">withLocal</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1137"></span><span id="local-6989586621679370277"><span id="local-6989586621679370279"><span id="local-6989586621679370280"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#withLocal"><span class="hs-identifier hs-type">withLocal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="#local-6989586621679370280"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370279"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370280"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370280"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370279"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370277"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370279"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370277"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-1138"></span><span id="withLocal"><span class="annot"><span class="annottext">withLocal :: forall r (m :: * -&gt; *) a.
MonadReader r m =&gt;
(r -&gt; r) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#withLocal"><span class="hs-identifier hs-var hs-var">withLocal</span></a></span></span><span> </span><span id="local-6989586621679369383"><span class="annot"><span class="annottext">r -&gt; r
</span><a href="#local-6989586621679369383"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679369382"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369382"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1139"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369380"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369380"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369379"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369379"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369378"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369378"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369377"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369377"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1140"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369375"><span class="annot"><span class="annottext">single :: a -&gt; m r
</span><a href="#local-6989586621679369375"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">r -&gt; r
</span><a href="#local-6989586621679369383"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369378"><span class="hs-identifier hs-var">sng</span></a></span><span>
</span><span id="line-1141"></span><span>            </span><span id="local-6989586621679369371"><span class="annot"><span class="annottext">yieldk :: a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369371"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369370"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369370"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369369"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369369"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">r -&gt; r
</span><a href="#local-6989586621679369383"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369379"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369370"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *) a.
MonadReader r m =&gt;
(r -&gt; r) -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#withLocal"><span class="hs-identifier hs-var">withLocal</span></a></span><span> </span><span class="annot"><span class="annottext">r -&gt; r
</span><a href="#local-6989586621679369383"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369369"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1142"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369380"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369371"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369375"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">r -&gt; r
</span><a href="#local-6989586621679369383"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369377"><span class="hs-identifier hs-var">stp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369382"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1143"></span><span>
</span><span id="line-1144"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1145"></span><span class="hs-comment">-- Generation</span><span>
</span><span id="line-1146"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1147"></span><span>
</span><span id="line-1148"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#unfoldr"><span class="hs-pragma hs-type">unfoldr</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1149"></span><span id="local-6989586621679370267"><span id="local-6989586621679370268"><span id="local-6989586621679370269"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#unfoldr"><span class="hs-identifier hs-type">unfoldr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370269"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370268"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679370269"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370269"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370267"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370268"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-1150"></span><span id="unfoldr"><span class="annot"><span class="annottext">unfoldr :: forall b a (m :: * -&gt; *). (b -&gt; Maybe (a, b)) -&gt; b -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#unfoldr"><span class="hs-identifier hs-var hs-var">unfoldr</span></a></span></span><span> </span><span id="local-6989586621679369368"><span class="annot"><span class="annottext">b -&gt; Maybe (a, b)
</span><a href="#local-6989586621679369368"><span class="hs-identifier hs-var">next</span></a></span></span><span> </span><span id="local-6989586621679369367"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369367"><span class="hs-identifier hs-var">s0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall b. (a -&gt; b -&gt; b) -&gt; b -&gt; b) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#build"><span class="hs-identifier hs-var">build</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369366"><span class="annot"><span class="annottext">a -&gt; b -&gt; b
</span><a href="#local-6989586621679369366"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369365"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369365"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1151"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369364"><span class="annot"><span class="annottext">go :: b -&gt; b
</span><a href="#local-6989586621679369364"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679369363"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369363"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1152"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">b -&gt; Maybe (a, b)
</span><a href="#local-6989586621679369368"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369363"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1153"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679369362"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369362"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679369361"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369361"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; b -&gt; b
</span><a href="#local-6989586621679369366"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369362"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; b
</span><a href="#local-6989586621679369364"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369361"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1154"></span><span>                </span><span class="annot"><span class="annottext">Maybe (a, b)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369365"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-1155"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">b -&gt; b
</span><a href="#local-6989586621679369364"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369367"><span class="hs-identifier hs-var">s0</span></a></span><span>
</span><span id="line-1156"></span><span>
</span><span id="line-1157"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#unfoldrMWith"><span class="hs-pragma hs-type">unfoldrMWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1158"></span><span id="local-6989586621679370260"><span id="local-6989586621679370261"><span id="local-6989586621679370262"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#unfoldrMWith"><span class="hs-identifier hs-type">unfoldrMWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1159"></span><span>       </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370261"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370261"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370261"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1160"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370260"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370261"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679370260"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1161"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370260"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-1162"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370261"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-1163"></span><span id="unfoldrMWith"><span class="annot"><span class="annottext">unfoldrMWith :: forall (m :: * -&gt; *) a b.
Monad m =&gt;
(m a -&gt; Stream m a -&gt; Stream m a)
-&gt; (b -&gt; m (Maybe (a, b))) -&gt; b -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#unfoldrMWith"><span class="hs-identifier hs-var hs-var">unfoldrMWith</span></a></span></span><span> </span><span id="local-6989586621679369359"><span class="annot"><span class="annottext">m a -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369359"><span class="hs-identifier hs-var">cns</span></a></span></span><span> </span><span id="local-6989586621679369358"><span class="annot"><span class="annottext">b -&gt; m (Maybe (a, b))
</span><a href="#local-6989586621679369358"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">b -&gt; Stream m a
</span><a href="#local-6989586621679369357"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-1164"></span><span>
</span><span id="line-1165"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1166"></span><span>
</span><span id="line-1167"></span><span>    </span><span id="local-6989586621679369357"><span class="annot"><span class="annottext">go :: b -&gt; Stream m a
</span><a href="#local-6989586621679369357"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679369355"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369355"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
Monad m =&gt;
(m a -&gt; Stream m a -&gt; Stream m a)
-&gt; (forall r. (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#sharedMWith"><span class="hs-identifier hs-var">sharedMWith</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369359"><span class="hs-identifier hs-var">cns</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369353"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369353"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679369352"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369352"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1168"></span><span>                </span><span id="local-6989586621679369351"><span class="annot"><span class="annottext">Maybe (a, b)
</span><a href="#local-6989586621679369351"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">b -&gt; m (Maybe (a, b))
</span><a href="#local-6989586621679369358"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369355"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1169"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (a, b)
</span><a href="#local-6989586621679369351"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1170"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679369350"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369350"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679369349"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369349"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369353"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369350"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; Stream m a
</span><a href="#local-6989586621679369357"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369349"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1171"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (a, b)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369352"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-1172"></span><span>
</span><span id="line-1173"></span><span class="hs-comment">-- | Generate an infinite stream by repeating a pure value.</span><span>
</span><span id="line-1174"></span><span class="hs-comment">--</span><span>
</span><span id="line-1175"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-1176"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#repeat"><span class="hs-pragma hs-type">repeat</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1177"></span><span id="local-6989586621679369347"><span id="local-6989586621679369348"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#repeat"><span class="hs-identifier hs-type">repeat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679369348"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369347"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369348"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1178"></span><span id="repeat"><span class="annot"><span class="annottext">repeat :: forall a (m :: * -&gt; *). a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#repeat"><span class="hs-identifier hs-var hs-var">repeat</span></a></span></span><span> </span><span id="local-6989586621679369346"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369346"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369345"><span class="annot"><span class="annottext">x :: Stream m a
</span><a href="#local-6989586621679369345"><span class="hs-identifier hs-var hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *). a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#cons"><span class="hs-identifier hs-var">cons</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369346"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369345"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *}. Stream m a
</span><a href="#local-6989586621679369345"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1179"></span><span>
</span><span id="line-1180"></span><span class="hs-comment">-- | Like 'repeatM' but takes a stream 'cons' operation to combine the actions</span><span>
</span><span id="line-1181"></span><span class="hs-comment">-- in a stream specific manner. A serial cons would repeat the values serially</span><span>
</span><span id="line-1182"></span><span class="hs-comment">-- while an async cons would repeat concurrently.</span><span>
</span><span id="line-1183"></span><span class="hs-comment">--</span><span>
</span><span id="line-1184"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-1185"></span><span id="local-6989586621679370251"><span id="local-6989586621679370252"><span id="local-6989586621679370253"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#repeatMWith"><span class="hs-identifier hs-type">repeatMWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370253"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370252"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370251"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370253"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370252"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370251"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370253"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370252"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370253"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370252"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370251"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370253"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370252"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-1186"></span><span id="repeatMWith"><span class="annot"><span class="annottext">repeatMWith :: forall (m :: * -&gt; *) a (t :: (* -&gt; *) -&gt; * -&gt; *).
(m a -&gt; t m a -&gt; t m a) -&gt; m a -&gt; t m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#repeatMWith"><span class="hs-identifier hs-var hs-var">repeatMWith</span></a></span></span><span> </span><span id="local-6989586621679369344"><span class="annot"><span class="annottext">m a -&gt; t m a -&gt; t m a
</span><a href="#local-6989586621679369344"><span class="hs-identifier hs-var">cns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m a -&gt; t m a
</span><a href="#local-6989586621679369343"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-1187"></span><span>
</span><span id="line-1188"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1189"></span><span>
</span><span id="line-1190"></span><span>    </span><span id="local-6989586621679369343"><span class="annot"><span class="annottext">go :: m a -&gt; t m a
</span><a href="#local-6989586621679369343"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679369342"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679369342"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679369342"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; t m a -&gt; t m a
</span><a href="#local-6989586621679369344"><span class="hs-operator hs-var">`cns`</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; t m a
</span><a href="#local-6989586621679369343"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679369342"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1191"></span><span>
</span><span id="line-1192"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#replicateMWith"><span class="hs-pragma hs-type">replicateMWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1193"></span><span id="local-6989586621679370246"><span id="local-6989586621679370247"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#replicateMWith"><span class="hs-identifier hs-type">replicateMWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370247"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370246"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370247"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370246"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370247"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370246"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370247"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370246"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370247"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370246"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1194"></span><span id="replicateMWith"><span class="annot"><span class="annottext">replicateMWith :: forall (m :: * -&gt; *) a.
(m a -&gt; Stream m a -&gt; Stream m a) -&gt; Int -&gt; m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#replicateMWith"><span class="hs-identifier hs-var hs-var">replicateMWith</span></a></span></span><span> </span><span id="local-6989586621679369337"><span class="annot"><span class="annottext">m a -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369337"><span class="hs-identifier hs-var">cns</span></a></span></span><span> </span><span id="local-6989586621679369336"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679369336"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679369335"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679369335"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {t}. (Ord t, Num t) =&gt; t -&gt; Stream m a
</span><a href="#local-6989586621679369334"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679369336"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1195"></span><span>
</span><span id="line-1196"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1197"></span><span>
</span><span id="line-1198"></span><span>    </span><span id="local-6989586621679369334"><span class="annot"><span class="annottext">go :: t -&gt; Stream m a
</span><a href="#local-6989586621679369334"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679369327"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679369327"><span class="hs-identifier hs-var">cnt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679369327"><span class="hs-identifier hs-var">cnt</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-identifier hs-var">nil</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679369335"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369337"><span class="hs-operator hs-var">`cns`</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; Stream m a
</span><a href="#local-6989586621679369334"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679369327"><span class="hs-identifier hs-var">cnt</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-1199"></span><span>
</span><span id="line-1200"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromIndicesMWith"><span class="hs-pragma hs-type">fromIndicesMWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1201"></span><span id="local-6989586621679370239"><span id="local-6989586621679370240"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromIndicesMWith"><span class="hs-identifier hs-type">fromIndicesMWith</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1202"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370240"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370239"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370240"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370239"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370240"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370239"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370240"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370239"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370240"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370239"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1203"></span><span id="fromIndicesMWith"><span class="annot"><span class="annottext">fromIndicesMWith :: forall (m :: * -&gt; *) a.
(m a -&gt; Stream m a -&gt; Stream m a) -&gt; (Int -&gt; m a) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromIndicesMWith"><span class="hs-identifier hs-var hs-var">fromIndicesMWith</span></a></span></span><span> </span><span id="local-6989586621679369325"><span class="annot"><span class="annottext">m a -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369325"><span class="hs-identifier hs-var">cns</span></a></span></span><span> </span><span id="local-6989586621679369324"><span class="annot"><span class="annottext">Int -&gt; m a
</span><a href="#local-6989586621679369324"><span class="hs-identifier hs-var">gen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Stream m a
</span><a href="#local-6989586621679369323"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1204"></span><span>
</span><span id="line-1205"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1206"></span><span>
</span><span id="line-1207"></span><span>    </span><span id="local-6989586621679369323"><span class="annot"><span class="annottext">go :: Int -&gt; Stream m a
</span><a href="#local-6989586621679369323"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679369322"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679369322"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369319"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369319"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369318"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369318"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span id="local-6989586621679369317"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369317"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369316"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369316"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1208"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369319"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369318"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369317"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369316"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; m a
</span><a href="#local-6989586621679369324"><span class="hs-identifier hs-var">gen</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679369322"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369325"><span class="hs-operator hs-var">`cns`</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Stream m a
</span><a href="#local-6989586621679369323"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679369322"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1209"></span><span>
</span><span id="line-1210"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#iterateMWith"><span class="hs-pragma hs-type">iterateMWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1211"></span><span id="local-6989586621679370234"><span id="local-6989586621679370235"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#iterateMWith"><span class="hs-identifier hs-type">iterateMWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370235"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1212"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370235"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370234"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370235"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370234"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370235"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370234"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370234"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370235"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370234"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370235"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370234"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370235"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370234"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1213"></span><span id="iterateMWith"><span class="annot"><span class="annottext">iterateMWith :: forall (m :: * -&gt; *) a.
Monad m =&gt;
(m a -&gt; Stream m a -&gt; Stream m a)
-&gt; (a -&gt; m a) -&gt; m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#iterateMWith"><span class="hs-identifier hs-var hs-var">iterateMWith</span></a></span></span><span> </span><span id="local-6989586621679369313"><span class="annot"><span class="annottext">m a -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369313"><span class="hs-identifier hs-var">cns</span></a></span></span><span> </span><span id="local-6989586621679369312"><span class="annot"><span class="annottext">a -&gt; m a
</span><a href="#local-6989586621679369312"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m a -&gt; Stream m a
</span><a href="#local-6989586621679369311"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-1214"></span><span>
</span><span id="line-1215"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1216"></span><span>
</span><span id="line-1217"></span><span>    </span><span id="local-6989586621679369311"><span class="annot"><span class="annottext">go :: m a -&gt; Stream m a
</span><a href="#local-6989586621679369311"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679369310"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679369310"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369307"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369307"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369306"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369306"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span id="local-6989586621679369305"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369305"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369304"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369304"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1218"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679369303"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369303"><span class="hs-identifier hs-var">next</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679369310"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1219"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStreamShared"><span class="hs-identifier hs-var">foldStreamShared</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369307"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369306"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369305"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369304"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369303"><span class="hs-identifier hs-var">next</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369313"><span class="hs-operator hs-var">`cns`</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; Stream m a
</span><a href="#local-6989586621679369311"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; m a
</span><a href="#local-6989586621679369312"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369303"><span class="hs-identifier hs-var">next</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1220"></span><span>
</span><span id="line-1221"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#headPartial"><span class="hs-pragma hs-type">headPartial</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1222"></span><span id="local-6989586621679370229"><span id="local-6989586621679370230"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#headPartial"><span class="hs-identifier hs-type">headPartial</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370230"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370230"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370229"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370230"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370229"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1223"></span><span id="headPartial"><span class="annot"><span class="annottext">headPartial :: forall (m :: * -&gt; *) a. Monad m =&gt; Stream m a -&gt; m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#headPartial"><span class="hs-identifier hs-var hs-var">headPartial</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *) b.
(a -&gt; m b -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldrM"><span class="hs-identifier hs-var">foldrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679369297"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369297"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="annottext">m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369297"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;head of nil&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-1224"></span><span>
</span><span id="line-1225"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#tailPartial"><span class="hs-pragma hs-type">tailPartial</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1226"></span><span id="local-6989586621679369293"><span id="local-6989586621679369294"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#tailPartial"><span class="hs-identifier hs-type">tailPartial</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369294"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369293"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369294"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369293"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1227"></span><span id="tailPartial"><span class="annot"><span class="annottext">tailPartial :: forall (m :: * -&gt; *) a. Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#tailPartial"><span class="hs-identifier hs-var hs-var">tailPartial</span></a></span></span><span> </span><span id="local-6989586621679369292"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369292"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369291"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369291"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369290"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369290"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369289"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369289"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369288"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369288"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1228"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369285"><span class="annot"><span class="annottext">stop :: a
</span><a href="#local-6989586621679369285"><span class="hs-identifier hs-var hs-var">stop</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;tail of nil&quot;</span></span><span>
</span><span id="line-1229"></span><span>        </span><span id="local-6989586621679369284"><span class="annot"><span class="annottext">single :: p -&gt; m r
</span><a href="#local-6989586621679369284"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369288"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-1230"></span><span>        </span><span id="local-6989586621679369283"><span class="annot"><span class="annottext">yieldk :: p -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369283"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679369282"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369282"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369291"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369290"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369289"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369288"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369282"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1231"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369291"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">forall {p}. p -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369283"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">forall {p}. p -&gt; m r
</span><a href="#local-6989586621679369284"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. a
</span><a href="#local-6989586621679369285"><span class="hs-identifier hs-var">stop</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369292"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1232"></span><span>
</span><span id="line-1233"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mfix"><span class="hs-pragma hs-type">mfix</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1234"></span><span id="local-6989586621679370217"><span id="local-6989586621679370218"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mfix"><span class="hs-identifier hs-type">mfix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370218"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370218"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370217"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370218"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370217"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370218"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370217"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1235"></span><span id="mfix"><span class="annot"><span class="annottext">mfix :: forall (m :: * -&gt; *) a.
Monad m =&gt;
(m a -&gt; Stream m a) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mfix"><span class="hs-identifier hs-var hs-var">mfix</span></a></span></span><span> </span><span id="local-6989586621679369280"><span class="annot"><span class="annottext">m a -&gt; Stream m a
</span><a href="#local-6989586621679369280"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369279"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369279"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369278"><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369278"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369277"><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369277"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369276"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369276"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1236"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369275"><span class="annot"><span class="annottext">single :: a -&gt; m r
</span><a href="#local-6989586621679369275"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369274"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369274"><span class="hs-identifier hs-var">a</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369279"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369278"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369277"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369276"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369274"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *). a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#cons"><span class="hs-operator hs-var">`cons`</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369273"><span class="hs-identifier hs-var">ys</span></a></span><span>
</span><span id="line-1237"></span><span>        </span><span id="local-6989586621679369272"><span class="annot"><span class="annottext">yieldk :: a -&gt; p -&gt; m r
</span><a href="#local-6989586621679369272"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369271"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369271"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369279"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369278"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369277"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369276"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369271"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *). a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#cons"><span class="hs-operator hs-var">`cons`</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369273"><span class="hs-identifier hs-var">ys</span></a></span><span>
</span><span id="line-1238"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679369279"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">forall {p}. a -&gt; p -&gt; m r
</span><a href="#local-6989586621679369272"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369275"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369276"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369270"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-1239"></span><span>
</span><span id="line-1240"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1241"></span><span>
</span><span id="line-1242"></span><span>    </span><span class="hs-comment">-- fix the head element of the stream</span><span>
</span><span id="line-1243"></span><span>    </span><span id="local-6989586621679369270"><span class="annot"><span class="annottext">xs :: Stream m a
</span><a href="#local-6989586621679369270"><span class="hs-identifier hs-var hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; a) -&gt; a
</span><span class="hs-identifier hs-var">fix</span></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m a -&gt; Stream m a
</span><a href="#local-6989586621679369280"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; Stream m a -&gt; m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#headPartial"><span class="hs-identifier hs-var">headPartial</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1244"></span><span>
</span><span id="line-1245"></span><span>    </span><span class="hs-comment">-- now fix the tail recursively</span><span>
</span><span id="line-1246"></span><span>    </span><span id="local-6989586621679369273"><span class="annot"><span class="annottext">ys :: Stream m a
</span><a href="#local-6989586621679369273"><span class="hs-identifier hs-var hs-var">ys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
Monad m =&gt;
(m a -&gt; Stream m a) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mfix"><span class="hs-identifier hs-var">mfix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#tailPartial"><span class="hs-identifier hs-var">tailPartial</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">m a -&gt; Stream m a
</span><a href="#local-6989586621679369280"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1247"></span><span>
</span><span id="line-1248"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1249"></span><span class="hs-comment">-- Conversions</span><span>
</span><span id="line-1250"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1251"></span><span>
</span><span id="line-1252"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-1253"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-1254"></span><span class="hs-comment">-- fromFoldable = 'Prelude.foldr' 'cons' 'nil'</span><span>
</span><span id="line-1255"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-1256"></span><span class="hs-comment">--</span><span>
</span><span id="line-1257"></span><span class="hs-comment">-- Construct a stream from a 'Foldable' containing pure values:</span><span>
</span><span id="line-1258"></span><span class="hs-comment">--</span><span>
</span><span id="line-1259"></span><span class="hs-comment">-- @since 0.2.0</span><span>
</span><span id="line-1260"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromFoldable"><span class="hs-pragma hs-type">fromFoldable</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1261"></span><span id="local-6989586621679370209"><span id="local-6989586621679370210"><span id="local-6989586621679370211"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromFoldable"><span class="hs-identifier hs-type">fromFoldable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Foldable</span></span><span> </span><span class="annot"><a href="#local-6989586621679370211"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370211"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370210"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370209"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370210"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-1262"></span><span id="fromFoldable"><span class="annot"><span class="annottext">fromFoldable :: forall (f :: * -&gt; *) a (m :: * -&gt; *).
Foldable f =&gt;
f a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromFoldable"><span class="hs-identifier hs-var hs-var">fromFoldable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">Prelude.foldr</span></span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *). a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#cons"><span class="hs-identifier hs-var">cons</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-identifier hs-var">nil</span></a></span><span>
</span><span id="line-1263"></span><span>
</span><span id="line-1264"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromFoldableM"><span class="hs-pragma hs-type">fromFoldableM</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1265"></span><span id="local-6989586621679370202"><span id="local-6989586621679370203"><span id="local-6989586621679370204"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromFoldableM"><span class="hs-identifier hs-type">fromFoldableM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Foldable</span></span><span> </span><span class="annot"><a href="#local-6989586621679370204"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679370203"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370204"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370203"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370202"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370203"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370202"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-1266"></span><span id="fromFoldableM"><span class="annot"><span class="annottext">fromFoldableM :: forall (f :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable f, Monad m) =&gt;
f (m a) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#fromFoldableM"><span class="hs-identifier hs-var hs-var">fromFoldableM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">Prelude.foldr</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#consM"><span class="hs-identifier hs-var">consM</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-identifier hs-var">nil</span></a></span><span>
</span><span id="line-1267"></span><span>
</span><span id="line-1268"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1269"></span><span class="hs-comment">-- Deconstruction</span><span>
</span><span id="line-1270"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1271"></span><span>
</span><span id="line-1272"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#uncons"><span class="hs-pragma hs-type">uncons</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1273"></span><span id="local-6989586621679370198"><span id="local-6989586621679370199"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#uncons"><span class="hs-identifier hs-type">uncons</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="annot"><a href="#local-6989586621679370199"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370199"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370198"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370199"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679370198"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370199"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370198"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1274"></span><span id="uncons"><span class="annot"><span class="annottext">uncons :: forall (m :: * -&gt; *) a.
Applicative m =&gt;
Stream m a -&gt; m (Maybe (a, Stream m a))
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#uncons"><span class="hs-identifier hs-var hs-var">uncons</span></a></span></span><span> </span><span id="local-6989586621679369258"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369258"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1275"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369256"><span class="annot"><span class="annottext">stop :: m (Maybe a)
</span><a href="#local-6989586621679369256"><span class="hs-identifier hs-var hs-var">stop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1276"></span><span>        </span><span id="local-6989586621679369253"><span class="annot"><span class="annottext">single :: a -&gt; f (Maybe (a, Stream m a))
</span><a href="#local-6989586621679369253"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369252"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369252"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369252"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-identifier hs-var">nil</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1277"></span><span>        </span><span id="local-6989586621679369249"><span class="annot"><span class="annottext">yieldk :: a -&gt; b -&gt; f (Maybe (a, b))
</span><a href="#local-6989586621679369249"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369248"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369248"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369247"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369247"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369248"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679369247"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1278"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.Type.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">forall {f :: * -&gt; *} {a} {b}.
Applicative f =&gt;
a -&gt; b -&gt; f (Maybe (a, b))
</span><a href="#local-6989586621679369249"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">forall {f :: * -&gt; *} {a} {m :: * -&gt; *} {a}.
Applicative f =&gt;
a -&gt; f (Maybe (a, Stream m a))
</span><a href="#local-6989586621679369253"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. m (Maybe a)
</span><a href="#local-6989586621679369256"><span class="hs-identifier hs-var">stop</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369258"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1279"></span><span>
</span><span id="line-1280"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#tail"><span class="hs-pragma hs-type">tail</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1281"></span><span id="local-6989586621679370185"><span id="local-6989586621679370186"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#tail"><span class="hs-identifier hs-type">tail</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="annot"><a href="#local-6989586621679370186"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370186"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370185"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370186"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370186"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370185"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1282"></span><span id="tail"><span class="annot"><span class="annottext">tail :: forall (m :: * -&gt; *) a.
Applicative m =&gt;
Stream m a -&gt; m (Maybe (Stream m a))
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#tail"><span class="hs-identifier hs-var hs-var">tail</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1283"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369242"><span class="annot"><span class="annottext">stop :: m (Maybe a)
</span><a href="#local-6989586621679369242"><span class="hs-identifier hs-var hs-var">stop</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1284"></span><span>        </span><span id="local-6989586621679369239"><span class="annot"><span class="annottext">single :: p -&gt; f (Maybe (Stream m a))
</span><a href="#local-6989586621679369239"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-identifier hs-var">nil</span></a></span><span>
</span><span id="line-1285"></span><span>        </span><span id="local-6989586621679369236"><span class="annot"><span class="annottext">yieldk :: p -&gt; a -&gt; f (Maybe a)
</span><a href="#local-6989586621679369236"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679369235"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369235"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369235"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1286"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.Type.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">forall {f :: * -&gt; *} {p} {a}.
Applicative f =&gt;
p -&gt; a -&gt; f (Maybe a)
</span><a href="#local-6989586621679369236"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">forall {f :: * -&gt; *} {p} {m :: * -&gt; *} {a}.
Applicative f =&gt;
p -&gt; f (Maybe (Stream m a))
</span><a href="#local-6989586621679369239"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. m (Maybe a)
</span><a href="#local-6989586621679369242"><span class="hs-identifier hs-var">stop</span></a></span><span>
</span><span id="line-1287"></span><span>
</span><span id="line-1288"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#init"><span class="hs-pragma hs-type">init</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1289"></span><span id="local-6989586621679369233"><span id="local-6989586621679369234"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#init"><span class="hs-identifier hs-type">init</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="annot"><a href="#local-6989586621679369234"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369234"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369233"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679369234"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369234"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369233"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1290"></span><span id="init"><span class="annot"><span class="annottext">init :: forall (m :: * -&gt; *) a.
Applicative m =&gt;
Stream m a -&gt; m (Maybe (Stream m a))
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#init"><span class="hs-identifier hs-var hs-var">init</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
Applicative m =&gt;
Stream m a -&gt; m (Maybe (Stream m a))
</span><a href="#local-6989586621679369230"><span class="hs-identifier hs-var">go1</span></a></span><span>
</span><span id="line-1291"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1292"></span><span>    </span><span id="local-6989586621679369230"><span class="annot"><span class="annottext">go1 :: Stream m t -&gt; m (Maybe (Stream m t))
</span><a href="#local-6989586621679369230"><span class="hs-identifier hs-var hs-var">go1</span></a></span></span><span> </span><span id="local-6989586621679369224"><span class="annot"><span class="annottext">Stream m t
</span><a href="#local-6989586621679369224"><span class="hs-identifier hs-var">m1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1293"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1294"></span><span>            </span><span class="annot"><span class="annottext">Maybe (t, Stream m t)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1295"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679369223"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679369223"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679369222"><span class="annot"><span class="annottext">Stream m t
</span><a href="#local-6989586621679369222"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *). a -&gt; Stream m a -&gt; Stream m a
</span><a href="#local-6989586621679369221"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679369223"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m t
</span><a href="#local-6989586621679369222"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
Applicative m =&gt;
Stream m a -&gt; m (Maybe (a, Stream m a))
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#uncons"><span class="hs-identifier hs-var">uncons</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m t
</span><a href="#local-6989586621679369224"><span class="hs-identifier hs-var">m1</span></a></span><span>
</span><span id="line-1296"></span><span>    </span><span id="local-6989586621679369221"><span class="annot"><span class="annottext">go :: t -&gt; Stream m t -&gt; Stream m t
</span><a href="#local-6989586621679369221"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679369219"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679369219"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679369218"><span class="annot"><span class="annottext">Stream m t
</span><a href="#local-6989586621679369218"><span class="hs-identifier hs-var">m1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">State Stream m t
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679369217"><span class="annot"><span class="annottext">t -&gt; Stream m t -&gt; m r
</span><a href="#local-6989586621679369217"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369216"><span class="annot"><span class="annottext">t -&gt; m r
</span><a href="#local-6989586621679369216"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369215"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369215"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1297"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369214"><span class="annot"><span class="annottext">single :: p -&gt; m r
</span><a href="#local-6989586621679369214"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t -&gt; m r
</span><a href="#local-6989586621679369216"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679369219"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1298"></span><span>            </span><span id="local-6989586621679369213"><span class="annot"><span class="annottext">yieldk :: t -&gt; Stream m t -&gt; m r
</span><a href="#local-6989586621679369213"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369212"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679369212"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369211"><span class="annot"><span class="annottext">Stream m t
</span><a href="#local-6989586621679369211"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t -&gt; Stream m t -&gt; m r
</span><a href="#local-6989586621679369217"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679369219"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">t -&gt; Stream m t -&gt; Stream m t
</span><a href="#local-6989586621679369221"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679369212"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m t
</span><a href="#local-6989586621679369211"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1299"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a. State t m a
</span><a href="Streamly.Internal.Data.SVar.Type.html#defState"><span class="hs-identifier hs-var">defState</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; Stream m t -&gt; m r
</span><a href="#local-6989586621679369213"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">forall {p}. p -&gt; m r
</span><a href="#local-6989586621679369214"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369215"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m t
</span><a href="#local-6989586621679369218"><span class="hs-identifier hs-var">m1</span></a></span><span>
</span><span id="line-1300"></span><span>
</span><span id="line-1301"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-1302"></span><span class="hs-comment">-- Reordering</span><span>
</span><span id="line-1303"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-1304"></span><span>
</span><span id="line-1305"></span><span class="hs-comment">-- | Lazy left fold to a stream.</span><span>
</span><span id="line-1306"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldlS"><span class="hs-pragma hs-type">foldlS</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1307"></span><span id="local-6989586621679370163"><span id="local-6989586621679370164"><span id="local-6989586621679370165"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldlS"><span class="hs-identifier hs-type">foldlS</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1308"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370164"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679370163"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370164"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370164"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370163"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679370164"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-1309"></span><span id="foldlS"><span class="annot"><span class="annottext">foldlS :: forall (m :: * -&gt; *) b a.
(Stream m b -&gt; a -&gt; Stream m b)
-&gt; Stream m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldlS"><span class="hs-identifier hs-var hs-var">foldlS</span></a></span></span><span> </span><span id="local-6989586621679369210"><span class="annot"><span class="annottext">Stream m b -&gt; a -&gt; Stream m b
</span><a href="#local-6989586621679369210"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m a -&gt; Stream m b
</span><a href="#local-6989586621679369209"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-1310"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1311"></span><span>    </span><span id="local-6989586621679369209"><span class="annot"><span class="annottext">go :: Stream m b -&gt; Stream m a -&gt; Stream m b
</span><a href="#local-6989586621679369209"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679369208"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369208"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621679369207"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369207"><span class="hs-identifier hs-var">rest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(forall r.
 State Stream m a
 -&gt; (a -&gt; Stream m a -&gt; m r) -&gt; (a -&gt; m r) -&gt; m r -&gt; m r)
-&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#mkStream"><span class="hs-identifier hs-var">mkStream</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679369206"><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369206"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679369205"><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369205"><span class="hs-identifier hs-var">yld</span></a></span></span><span> </span><span id="local-6989586621679369204"><span class="annot"><span class="annottext">b -&gt; m r
</span><a href="#local-6989586621679369204"><span class="hs-identifier hs-var">sng</span></a></span></span><span> </span><span id="local-6989586621679369203"><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369203"><span class="hs-identifier hs-var">stp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1312"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679369202"><span class="annot"><span class="annottext">run :: Stream m b -&gt; m r
</span><a href="#local-6989586621679369202"><span class="hs-identifier hs-var hs-var">run</span></a></span></span><span> </span><span id="local-6989586621679369201"><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369201"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369206"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; Stream m b -&gt; m r
</span><a href="#local-6989586621679369205"><span class="hs-identifier hs-var">yld</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; m r
</span><a href="#local-6989586621679369204"><span class="hs-identifier hs-var">sng</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369203"><span class="hs-identifier hs-var">stp</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369201"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1313"></span><span>            </span><span id="local-6989586621679369200"><span class="annot"><span class="annottext">stop :: m r
</span><a href="#local-6989586621679369200"><span class="hs-identifier hs-var hs-var">stop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369202"><span class="hs-identifier hs-var">run</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369208"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-1314"></span><span>            </span><span id="local-6989586621679369199"><span class="annot"><span class="annottext">single :: a -&gt; m r
</span><a href="#local-6989586621679369199"><span class="hs-identifier hs-var hs-var">single</span></a></span></span><span> </span><span id="local-6989586621679369198"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369198"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369202"><span class="hs-identifier hs-var">run</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; a -&gt; Stream m b
</span><a href="#local-6989586621679369210"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369208"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369198"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-1315"></span><span>            </span><span id="local-6989586621679369197"><span class="annot"><span class="annottext">yieldk :: a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369197"><span class="hs-identifier hs-var hs-var">yieldk</span></a></span></span><span> </span><span id="local-6989586621679369196"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369196"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679369195"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369195"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; m r
</span><a href="#local-6989586621679369202"><span class="hs-identifier hs-var">run</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream m b -&gt; Stream m a -&gt; Stream m b
</span><a href="#local-6989586621679369209"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stream m b -&gt; a -&gt; Stream m b
</span><a href="#local-6989586621679369210"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m b
</span><a href="#local-6989586621679369208"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679369196"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369195"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1316"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a r.
State Stream m a
-&gt; (a -&gt; Stream m a -&gt; m r)
-&gt; (a -&gt; m r)
-&gt; m r
-&gt; Stream m a
-&gt; m r
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldStream"><span class="hs-identifier hs-var">foldStream</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m b
</span><a href="#local-6989586621679369206"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; Stream m a -&gt; m r
</span><a href="#local-6989586621679369197"><span class="hs-identifier hs-var">yieldk</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m r
</span><a href="#local-6989586621679369199"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="annot"><span class="annottext">m r
</span><a href="#local-6989586621679369200"><span class="hs-identifier hs-var">stop</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679369207"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-1317"></span><span>
</span><span id="line-1318"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#reverse"><span class="hs-pragma hs-type">reverse</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1319"></span><span id="local-6989586621679369193"><span id="local-6989586621679369194"><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#reverse"><span class="hs-identifier hs-type">reverse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369194"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369193"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369194"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679369193"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1320"></span><span id="reverse"><span class="annot"><span class="annottext">reverse :: forall (m :: * -&gt; *) a. Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#reverse"><span class="hs-identifier hs-var hs-var">reverse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b a.
(Stream m b -&gt; a -&gt; Stream m b)
-&gt; Stream m b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldlS"><span class="hs-identifier hs-var">foldlS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *). a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#cons"><span class="hs-identifier hs-var">cons</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-identifier hs-var">nil</span></a></span><span>
</span><span id="line-1321"></span></pre></body></html>