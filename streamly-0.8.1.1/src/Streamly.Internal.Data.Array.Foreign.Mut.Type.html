<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE UnboxedTuples #-}</span><span>
</span><span id="line-2"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- Module      : Streamly.Internal.Data.Array.Foreign.Mut.Type</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- Copyright   : (c) 2020 Composewell Technologies</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- License     : BSD3-3-Clause</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- Maintainer  : streamly@composewell.com</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- Stability   : experimental</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- Portability : GHC</span><span>
</span><span id="line-9"></span><span class="hs-comment">--</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- Mutable arrays and file system files are quite similar, they can grow and</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- their content is mutable. Therefore, both have similar APIs as well. We</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- strive to keep the API consistent for both. Ideally, you should be able to</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- replace one with another with little changes to the code.</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Streamly.Internal.Data.Array.Foreign.Mut.Type</span><span>
</span><span id="line-16"></span><span>    </span><span class="hs-special">(</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Type</span></span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><span class="hs-comment">-- $arrayNotes</span></span><span>
</span><span id="line-19"></span><span>      </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier">Array</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayContents"><span class="hs-identifier">ArrayContents</span></a></span><span>
</span><span id="line-21"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrayToFptrContents"><span class="hs-identifier">arrayToFptrContents</span></a></span><span>
</span><span id="line-22"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fptrToArrayContents"><span class="hs-identifier">fptrToArrayContents</span></a></span><span>
</span><span id="line-23"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#unsafeWithArrayContents"><span class="hs-identifier">unsafeWithArrayContents</span></a></span><span>
</span><span id="line-24"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#nilArrayContents"><span class="hs-identifier">nilArrayContents</span></a></span><span>
</span><span id="line-25"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier">touch</span></a></span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Constructing and Writing</span></span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Construction</span></span><span>
</span><span id="line-29"></span><span>    </span><span class="hs-comment">-- , nil</span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><span class="hs-comment">-- *** Uninitialized Arrays</span></span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArray"><span class="hs-identifier">newArray</span></a></span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArrayAligned"><span class="hs-identifier">newArrayAligned</span></a></span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArrayAlignedUnmanaged"><span class="hs-identifier">newArrayAlignedUnmanaged</span></a></span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArrayWith"><span class="hs-identifier">newArrayWith</span></a></span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><span class="hs-comment">-- *** Initialized Arrays</span></span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#withNewArrayUnsafe"><span class="hs-identifier">withNewArrayUnsafe</span></a></span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><span class="hs-comment">-- *** From streams</span></span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayUnsafe"><span class="hs-identifier">ArrayUnsafe</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNWithUnsafe"><span class="hs-identifier">writeNWithUnsafe</span></a></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNWith"><span class="hs-identifier">writeNWith</span></a></span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNUnsafe"><span class="hs-identifier">writeNUnsafe</span></a></span><span>
</span><span id="line-45"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeN"><span class="hs-identifier">writeN</span></a></span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNAligned"><span class="hs-identifier">writeNAligned</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNAlignedUnmanaged"><span class="hs-identifier">writeNAlignedUnmanaged</span></a></span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeWith"><span class="hs-identifier">writeWith</span></a></span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#write"><span class="hs-identifier">write</span></a></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-comment">-- , writeRevN</span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-comment">-- , writeRev</span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** From containers</span></span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromForeignPtrUnsafe"><span class="hs-identifier">fromForeignPtrUnsafe</span></a></span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromListN"><span class="hs-identifier">fromListN</span></a></span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromList"><span class="hs-identifier">fromList</span></a></span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromStreamDN"><span class="hs-identifier">fromStreamDN</span></a></span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromStreamD"><span class="hs-identifier">fromStreamD</span></a></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Random writes</span></span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#putIndex"><span class="hs-identifier">putIndex</span></a></span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#putIndexUnsafe"><span class="hs-identifier">putIndexUnsafe</span></a></span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#putIndices"><span class="hs-identifier">putIndices</span></a></span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-comment">-- , putFromThenTo</span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-comment">-- , putFrom -- start writing at the given position</span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-comment">-- , putUpto -- write from beginning up to the given position</span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-comment">-- , putFromTo</span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-comment">-- , putFromRev</span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-comment">-- , putUptoRev</span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#modifyIndexUnsafe"><span class="hs-identifier">modifyIndexUnsafe</span></a></span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#modifyIndex"><span class="hs-identifier">modifyIndex</span></a></span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#modifyIndices"><span class="hs-identifier">modifyIndices</span></a></span><span>
</span><span id="line-75"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#modify"><span class="hs-identifier">modify</span></a></span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#swapIndices"><span class="hs-identifier">swapIndices</span></a></span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Growing and Shrinking</span></span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-comment">-- Arrays grow only at the end, though it is possible to grow on both sides</span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-comment">-- and therefore have a cons as well as snoc. But that will require two</span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-comment">-- bounds in the array representation.</span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Appending elements</span></span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocWith"><span class="hs-identifier">snocWith</span></a></span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snoc"><span class="hs-identifier">snoc</span></a></span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocLinear"><span class="hs-identifier">snocLinear</span></a></span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocMay"><span class="hs-identifier">snocMay</span></a></span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocUnsafe"><span class="hs-identifier">snocUnsafe</span></a></span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Appending streams</span></span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#appendNUnsafe"><span class="hs-identifier">appendNUnsafe</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#appendN"><span class="hs-identifier">appendN</span></a></span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#appendWith"><span class="hs-identifier">appendWith</span></a></span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#append"><span class="hs-identifier">append</span></a></span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Truncation</span></span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-comment">-- These are not the same as slicing the array at the beginning, they may</span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-comment">-- reduce the length as well as the capacity of the array.</span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#truncateWith"><span class="hs-identifier">truncateWith</span></a></span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#truncate"><span class="hs-identifier">truncate</span></a></span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#truncateExp"><span class="hs-identifier">truncateExp</span></a></span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Eliminating and Reading</span></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** To streams</span></span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier">ReadUState</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#read"><span class="hs-identifier">read</span></a></span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#readRev"><span class="hs-identifier">readRev</span></a></span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** To containers</span></span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toStreamD"><span class="hs-identifier">toStreamD</span></a></span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toStreamDRev"><span class="hs-identifier">toStreamDRev</span></a></span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toStreamK"><span class="hs-identifier">toStreamK</span></a></span><span>
</span><span id="line-114"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toStreamKRev"><span class="hs-identifier">toStreamKRev</span></a></span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toList"><span class="hs-identifier">toList</span></a></span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-comment">-- experimental</span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#producer"><span class="hs-identifier">producer</span></a></span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Random reads</span></span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndex"><span class="hs-identifier">getIndex</span></a></span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndexUnsafe"><span class="hs-identifier">getIndexUnsafe</span></a></span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndices"><span class="hs-identifier">getIndices</span></a></span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-comment">-- , getFromThenTo</span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndexRev"><span class="hs-identifier">getIndexRev</span></a></span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Memory Management</span></span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#blockSize"><span class="hs-identifier">blockSize</span></a></span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrayChunkBytes"><span class="hs-identifier">arrayChunkBytes</span></a></span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#allocBytesToElemCount"><span class="hs-identifier">allocBytesToElemCount</span></a></span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#realloc"><span class="hs-identifier">realloc</span></a></span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#resize"><span class="hs-identifier">resize</span></a></span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#resizeExp"><span class="hs-identifier">resizeExp</span></a></span><span>
</span><span id="line-134"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#rightSize"><span class="hs-identifier">rightSize</span></a></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Size</span></span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#length"><span class="hs-identifier">length</span></a></span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#byteLength"><span class="hs-identifier">byteLength</span></a></span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-comment">-- , capacity</span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#byteCapacity"><span class="hs-identifier">byteCapacity</span></a></span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#bytesFree"><span class="hs-identifier">bytesFree</span></a></span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span>    </span><span class="annot"><span class="hs-comment">-- * In-place Mutation Algorithms</span></span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#reverse"><span class="hs-identifier">reverse</span></a></span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#permute"><span class="hs-identifier">permute</span></a></span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#partitionBy"><span class="hs-identifier">partitionBy</span></a></span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#shuffleBy"><span class="hs-identifier">shuffleBy</span></a></span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#divideBy"><span class="hs-identifier">divideBy</span></a></span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#mergeBy"><span class="hs-identifier">mergeBy</span></a></span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Casting</span></span><span>
</span><span id="line-152"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#cast"><span class="hs-identifier">cast</span></a></span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#castUnsafe"><span class="hs-identifier">castUnsafe</span></a></span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#asBytes"><span class="hs-identifier">asBytes</span></a></span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#asPtrUnsafe"><span class="hs-identifier">asPtrUnsafe</span></a></span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Folding</span></span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#foldl%27"><span class="hs-identifier">foldl'</span></a></span><span>
</span><span id="line-159"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#foldr"><span class="hs-identifier">foldr</span></a></span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#cmp"><span class="hs-identifier">cmp</span></a></span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Arrays of arrays</span></span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-comment">--  We can add dimensionality parameter to the array type to get</span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-comment">--  multidimensional arrays. Multidimensional arrays would just be a</span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-comment">--  convenience wrapper on top of single dimensional arrays.</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-comment">-- | Operations dealing with multiple arrays, streams of arrays or</span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-comment">-- multidimensional array representations.</span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Construct from streams</span></span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arraysOf"><span class="hs-identifier">arraysOf</span></a></span><span>
</span><span id="line-172"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrayStreamKFromStreamD"><span class="hs-identifier">arrayStreamKFromStreamD</span></a></span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeChunks"><span class="hs-identifier">writeChunks</span></a></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Eliminate to streams</span></span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#flattenArrays"><span class="hs-identifier">flattenArrays</span></a></span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#flattenArraysRev"><span class="hs-identifier">flattenArraysRev</span></a></span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromArrayStreamK"><span class="hs-identifier">fromArrayStreamK</span></a></span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Construct from arrays</span></span><span>
</span><span id="line-181"></span><span>    </span><span class="hs-comment">-- get chunks without copying</span><span>
</span><span id="line-182"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getSliceUnsafe"><span class="hs-identifier">getSliceUnsafe</span></a></span><span>
</span><span id="line-183"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getSlice"><span class="hs-identifier">getSlice</span></a></span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-comment">-- , getSlicesFromLenN</span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#splitAt"><span class="hs-identifier">splitAt</span></a></span><span> </span><span class="hs-comment">-- XXX should be able to express using getSlice</span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#breakOn"><span class="hs-identifier">breakOn</span></a></span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Appending arrays</span></span><span>
</span><span id="line-189"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#spliceCopy"><span class="hs-identifier">spliceCopy</span></a></span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#spliceWith"><span class="hs-identifier">spliceWith</span></a></span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#splice"><span class="hs-identifier">splice</span></a></span><span>
</span><span id="line-192"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#spliceExp"><span class="hs-identifier">spliceExp</span></a></span><span>
</span><span id="line-193"></span><span>    </span><span class="hs-comment">-- , putSlice</span><span>
</span><span id="line-194"></span><span>    </span><span class="hs-comment">-- , appendSlice</span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-comment">-- , appendSliceFrom</span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Utilities</span></span><span>
</span><span id="line-198"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#memcpy"><span class="hs-identifier">memcpy</span></a></span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#memcmp"><span class="hs-identifier">memcmp</span></a></span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#c_memchr"><span class="hs-identifier">c_memchr</span></a></span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span class="hs-keyword">where</span><span class="hs-cpp">

#include &quot;inline.hs&quot;
</span><span class="hs-cpp">
#ifdef USE_C_MALLOC
</span><span class="hs-cpp">#define USE_FOREIGN_PTR
</span><span class="hs-cpp">#endif
</span><span>
</span><span id="line-210"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">assert</span></span><span class="hs-special">)</span><span>
</span><span id="line-211"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.DeepSeq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NFData</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">when</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">void</span></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadIO</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bits</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(.&amp;.)</span></span><span class="hs-special">)</span><span class="hs-cpp">
#if __GLASGOW_HASKELL__ &lt; 808
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Semigroup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Semigroup</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Word</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Word8</span></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Foreign.C.Types</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">CSize</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">CInt</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Foreign.ForeignPtr.Unsafe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unsafeForeignPtrToPtr</span></span><span class="hs-special">)</span><span class="hs-cpp">
#ifndef USE_FOREIGN_PTR
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Foreign.Marshal.Alloc</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">mallocBytes</span></span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Foreign.Ptr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">plusPtr</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">minusPtr</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">castPtr</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">nullPtr</span></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Foreign.Storable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Storable</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-226"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Base</span></span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">touch#</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">IO</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">byteArrayContents#</span></span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Int</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newAlignedPinnedByteArray#</span></span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-special">)</span><span class="hs-cpp">
#ifndef USE_FOREIGN_PTR
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Base</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">RealWorld</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">MutableByteArray#</span></span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span class="hs-cpp">#if __GLASGOW_HASKELL__ &lt; 802
</span><span class="hs-cpp">#define noinline
</span><span class="hs-cpp">#else
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Base</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">noinline</span></span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Exts</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unsafeCoerce#</span></span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.ForeignPtr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ForeignPtr</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ForeignPtrContents</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-cpp">
#ifdef USE_C_MALLOC
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.ForeignPtr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mallocForeignPtrAlignedBytes</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Ptr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Ptr</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.BaseCompat.html"><span class="hs-identifier">Streamly.Internal.BaseCompat</span></a></span><span>
</span><span id="line-246"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html"><span class="hs-identifier">Streamly.Internal.Data.Fold.Type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier">Fold</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Producer.Type.html"><span class="hs-identifier">Streamly.Internal.Data.Producer.Type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Producer.Type.html#Producer"><span class="hs-identifier">Producer</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.SVar.Type.html"><span class="hs-identifier">Streamly.Internal.Data.SVar.Type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier">adaptState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Type.html"><span class="hs-identifier">Streamly.Internal.Data.Unfold.Type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Type.html#Unfold"><span class="hs-identifier">Unfold</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.System.IO.html"><span class="hs-identifier">Streamly.Internal.System.IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.System.IO.html#arrayPayloadSize"><span class="hs-identifier">arrayPayloadSize</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.System.IO.html#defaultChunkSize"><span class="hs-identifier">defaultChunkSize</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.IO.Unsafe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unsafePerformIO</span></span><span class="hs-special">)</span><span class="hs-cpp">

#ifdef DEVBUILD
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Foldable</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">F</span><span class="hs-cpp">
#endif
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html"><span class="hs-identifier">Streamly.Internal.Data.Fold.Type</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">FL</span></span><span>
</span><span id="line-257"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Producer.html"><span class="hs-identifier">Streamly.Internal.Data.Producer</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Producer</span></span><span>
</span><span id="line-258"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html"><span class="hs-identifier">Streamly.Internal.Data.Stream.StreamD.Type</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">D</span></span><span>
</span><span id="line-259"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html"><span class="hs-identifier">Streamly.Internal.Data.Stream.StreamK.Type</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">K</span></span><span class="hs-cpp">
#ifdef USE_FOREIGN_PTR
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Streamly.Internal.Foreign.Malloc</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Malloc</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-264"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span>
</span><span id="line-265"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">length</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">foldr</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">read</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unlines</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">splitAt</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">reverse</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">truncate</span></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span class="hs-comment">-- $setup</span><span>
</span><span id="line-268"></span><span class="hs-comment">-- &gt;&gt;&gt; :m</span><span>
</span><span id="line-269"></span><span class="hs-comment">-- &gt;&gt;&gt; import qualified Streamly.Internal.Data.Array.Foreign.Mut.Type as Array</span><span>
</span><span id="line-270"></span><span class="hs-comment">-- &gt;&gt;&gt; import qualified Streamly.Internal.Data.Stream.IsStream as Stream</span><span>
</span><span id="line-271"></span><span class="hs-comment">-- &gt;&gt;&gt; import qualified Streamly.Internal.Data.Stream.StreamD as StreamD</span><span>
</span><span id="line-272"></span><span class="hs-comment">-- &gt;&gt;&gt; import qualified Streamly.Internal.Data.Fold as Fold</span><span>
</span><span id="line-273"></span><span class="hs-comment">-- &gt;&gt;&gt; import qualified Streamly.Internal.Data.Fold.Type as Fold</span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-276"></span><span class="hs-comment">-- Array Data Type</span><span>
</span><span id="line-277"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-keyword">ccall</span></span><span> </span><span class="annot"><span class="hs-keyword">unsafe</span></span><span> </span><span class="annot"><span class="hs-string">&quot;string.h memcpy&quot;</span></span><span> </span><span id="c_memcpy"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#c_memcpy"><span class="hs-identifier hs-var">c_memcpy</span></a></span></span><span>
</span><span id="line-280"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CSize</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-keyword">ccall</span></span><span> </span><span class="annot"><span class="hs-keyword">unsafe</span></span><span> </span><span class="annot"><span class="hs-string">&quot;string.h memchr&quot;</span></span><span> </span><span id="c_memchr"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#c_memchr"><span class="hs-identifier hs-var">c_memchr</span></a></span></span><span>
</span><span id="line-283"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CSize</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-keyword">ccall</span></span><span> </span><span class="annot"><span class="hs-keyword">unsafe</span></span><span> </span><span class="annot"><span class="hs-string">&quot;string.h memcmp&quot;</span></span><span> </span><span id="c_memcmp"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#c_memcmp"><span class="hs-identifier hs-var">c_memcmp</span></a></span></span><span>
</span><span id="line-286"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CSize</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CInt</span></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span class="hs-comment">-- | Given a 'Storable' type (unused first arg) and a number of bytes, return</span><span>
</span><span id="line-289"></span><span class="hs-comment">-- how many elements of that type will completely fit in those bytes.</span><span>
</span><span id="line-290"></span><span class="hs-comment">--</span><span>
</span><span id="line-291"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#bytesToElemCount"><span class="hs-pragma hs-type">bytesToElemCount</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-292"></span><span id="local-6989586621679401985"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#bytesToElemCount"><span class="hs-identifier hs-type">bytesToElemCount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401985"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401985"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span></span><span>
</span><span id="line-293"></span><span id="bytesToElemCount"><span class="annot"><span class="annottext">bytesToElemCount :: forall a. Storable a =&gt; a -&gt; Int -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#bytesToElemCount"><span class="hs-identifier hs-var hs-var">bytesToElemCount</span></a></span></span><span> </span><span id="local-6989586621679401273"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679401273"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679401272"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401272"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-294"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679401270"><span class="annot"><span class="annottext">elemSize :: Int
</span><a href="#local-6989586621679401270"><span class="hs-identifier hs-var hs-var">elemSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679401273"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401272"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401270"><span class="hs-identifier hs-var">elemSize</span></a></span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="hs-comment">-- XXX we are converting Int to CSize</span><span>
</span><span id="line-298"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#memcpy"><span class="hs-identifier hs-type">memcpy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span id="memcpy"><span class="annot"><span class="annottext">memcpy :: Ptr Word8 -&gt; Ptr Word8 -&gt; Int -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#memcpy"><span class="hs-identifier hs-var hs-var">memcpy</span></a></span></span><span> </span><span id="local-6989586621679401267"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679401267"><span class="hs-identifier hs-var">dst</span></a></span></span><span> </span><span id="local-6989586621679401266"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679401266"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621679401265"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401265"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; CSize -&gt; IO (Ptr Word8)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#c_memcpy"><span class="hs-identifier hs-var">c_memcpy</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679401267"><span class="hs-identifier hs-var">dst</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679401266"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401265"><span class="hs-identifier hs-var">len</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-300"></span><span>
</span><span id="line-301"></span><span class="hs-comment">-- XXX we are converting Int to CSize</span><span>
</span><span id="line-302"></span><span class="hs-comment">-- return True if the memory locations have identical contents</span><span>
</span><span id="line-303"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#memcmp"><span class="hs-pragma hs-type">memcmp</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-304"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#memcmp"><span class="hs-identifier hs-type">memcmp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-305"></span><span id="memcmp"><span class="annot"><span class="annottext">memcmp :: Ptr Word8 -&gt; Ptr Word8 -&gt; Int -&gt; IO Bool
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#memcmp"><span class="hs-identifier hs-var hs-var">memcmp</span></a></span></span><span> </span><span id="local-6989586621679401264"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679401264"><span class="hs-identifier hs-var">p1</span></a></span></span><span> </span><span id="local-6989586621679401263"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679401263"><span class="hs-identifier hs-var">p2</span></a></span></span><span> </span><span id="local-6989586621679401262"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401262"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-306"></span><span>    </span><span id="local-6989586621679401261"><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679401261"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; CSize -&gt; IO CInt
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#c_memcmp"><span class="hs-identifier hs-var">c_memcmp</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679401264"><span class="hs-identifier hs-var">p1</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679401263"><span class="hs-identifier hs-var">p2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401262"><span class="hs-identifier hs-var">len</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CInt
</span><a href="#local-6989586621679401261"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">CInt
</span><span class="hs-number">0</span></span><span>
</span><span id="line-308"></span><span>
</span><span id="line-309"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-310"></span><span class="hs-comment">-- Array Contents</span><span>
</span><span id="line-311"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-312"></span><span>
</span><span id="line-313"></span><span class="hs-comment">-- We support using ForeignPtrContents or MutableByteArray.</span><span class="hs-cpp">

#ifdef USE_FOREIGN_PTR
</span><span class="hs-keyword">newtype</span><span> </span><span class="hs-identifier">ArrayContents</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ArrayContents</span><span> </span><span class="hs-identifier">ForeignPtrContents</span><span class="hs-cpp">
#define UNPACKIF
</span><span class="hs-cpp">#else
</span><span class="hs-comment">-- XXX can use UnliftedNewtypes</span><span>
</span><span id="line-320"></span><span class="hs-keyword">data</span><span> </span><span id="ArrayContents"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayContents"><span class="hs-identifier hs-var">ArrayContents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ArrayContents"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayContents"><span class="hs-identifier hs-var">ArrayContents</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MutableByteArray#</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">RealWorld</span></span><span class="hs-special">)</span><span class="hs-cpp">
#define UNPACKIF {-# UNPACK #-}
</span><span class="hs-cpp">#endif
</span><span>
</span><span id="line-324"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-pragma hs-type">touch</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-325"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-type">touch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayContents"><span class="hs-identifier hs-type">ArrayContents</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span id="touch"><span class="annot"><span class="annottext">touch :: ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var hs-var">touch</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayContents"><span class="hs-identifier hs-type">ArrayContents</span></a></span><span> </span><span id="local-6989586621679401259"><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679401259"><span class="hs-identifier hs-var">contents</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="annottext">forall a. (State# RealWorld -&gt; (# State# RealWorld, a #)) -&gt; IO a
</span><span class="hs-identifier hs-var">IO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679401258"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679401258"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">touch# :: forall a. a -&gt; State# RealWorld -&gt; State# RealWorld
</span><span class="hs-identifier hs-type">touch#</span></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679401259"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679401258"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span id="local-6989586621679401257"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679401257"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679401257"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fptrToArrayContents"><span class="hs-identifier hs-type">fptrToArrayContents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ForeignPtrContents</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayContents"><span class="hs-identifier hs-type">ArrayContents</span></a></span><span>
</span><span id="line-330"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrayToFptrContents"><span class="hs-identifier hs-type">arrayToFptrContents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayContents"><span class="hs-identifier hs-type">ArrayContents</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ForeignPtrContents</span></span><span class="hs-cpp">
#ifdef USE_FOREIGN_PTR
</span><span class="hs-identifier">fptrToArrayContents</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ArrayContents</span><span>
</span><span id="line-333"></span><span class="hs-identifier">arrayToFptrContents</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ArrayContents</span><span> </span><span class="hs-identifier">contents</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">contents</span><span class="hs-cpp">
#else
</span><span id="fptrToArrayContents"><span class="annot"><span class="annottext">fptrToArrayContents :: ForeignPtrContents -&gt; ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fptrToArrayContents"><span class="hs-identifier hs-var hs-var">fptrToArrayContents</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PlainPtr</span></span><span> </span><span id="local-6989586621679401255"><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679401255"><span class="hs-identifier hs-var">mbarr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld -&gt; ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayContents"><span class="hs-identifier hs-var">ArrayContents</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679401255"><span class="hs-identifier hs-var">mbarr</span></a></span><span>
</span><span id="line-336"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fptrToArrayContents"><span class="hs-identifier hs-var">fptrToArrayContents</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtrContents
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Unsupported foreign ptr&quot;</span></span><span>
</span><span id="line-337"></span><span id="arrayToFptrContents"><span class="annot"><span class="annottext">arrayToFptrContents :: ArrayContents -&gt; ForeignPtrContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrayToFptrContents"><span class="hs-identifier hs-var hs-var">arrayToFptrContents</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayContents"><span class="hs-identifier hs-type">ArrayContents</span></a></span><span> </span><span id="local-6989586621679401253"><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679401253"><span class="hs-identifier hs-var">contents</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld -&gt; ForeignPtrContents
</span><span class="hs-identifier hs-var">PlainPtr</span></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679401253"><span class="hs-identifier hs-var">contents</span></a></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-340"></span><span class="hs-comment">-- | Similar to unsafeWithForeignPtr.</span><span>
</span><span id="line-341"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#unsafeWithArrayContents"><span class="hs-pragma hs-type">unsafeWithArrayContents</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-342"></span><span id="local-6989586621679401960"><span id="local-6989586621679401961"><span id="local-6989586621679401963"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#unsafeWithArrayContents"><span class="hs-identifier hs-type">unsafeWithArrayContents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401963"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-343"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayContents"><span class="hs-identifier hs-type">ArrayContents</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401961"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401961"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401963"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401960"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401963"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401960"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-344"></span><span id="unsafeWithArrayContents"><span class="annot"><span class="annottext">unsafeWithArrayContents :: forall (m :: * -&gt; *) a b.
MonadIO m =&gt;
ArrayContents -&gt; Ptr a -&gt; (Ptr a -&gt; m b) -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#unsafeWithArrayContents"><span class="hs-identifier hs-var hs-var">unsafeWithArrayContents</span></a></span></span><span> </span><span id="local-6989586621679401245"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679401245"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679401244"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401244"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span id="local-6989586621679401243"><span class="annot"><span class="annottext">Ptr a -&gt; m b
</span><a href="#local-6989586621679401243"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-345"></span><span>  </span><span id="local-6989586621679401242"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679401242"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; m b
</span><a href="#local-6989586621679401243"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401244"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-346"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679401245"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-347"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679401242"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-348"></span><span>
</span><span id="line-349"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-350"></span><span class="hs-comment">-- Array Data Type</span><span>
</span><span id="line-351"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span class="hs-comment">-- $arrayNotes</span><span>
</span><span id="line-354"></span><span class="hs-comment">--</span><span>
</span><span id="line-355"></span><span class="hs-comment">-- We can use a 'Storable' constraint in the Array type and the constraint can</span><span>
</span><span id="line-356"></span><span class="hs-comment">-- be automatically provided to a function that pattern matches on the Array</span><span>
</span><span id="line-357"></span><span class="hs-comment">-- type. However, it has huge performance cost, so we do not use it.</span><span>
</span><span id="line-358"></span><span class="hs-comment">-- Investigate a GHC improvement possiblity.</span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span class="hs-comment">-- XXX Rename the fields to better names.</span><span>
</span><span id="line-361"></span><span>
</span><span id="line-362"></span><span class="hs-comment">-- | An unboxed, pinned mutable array. An array is created with a given length</span><span>
</span><span id="line-363"></span><span class="hs-comment">-- and capacity. Length is the number of valid elements in the array.  Capacity</span><span>
</span><span id="line-364"></span><span class="hs-comment">-- is the maximum number of elements that the array can be expanded to without</span><span>
</span><span id="line-365"></span><span class="hs-comment">-- having to reallocate the memory.</span><span>
</span><span id="line-366"></span><span class="hs-comment">--</span><span>
</span><span id="line-367"></span><span class="hs-comment">-- The elements in the array can be mutated in-place without changing the</span><span>
</span><span id="line-368"></span><span class="hs-comment">-- reference (constructor). However, the length of the array cannot be mutated</span><span>
</span><span id="line-369"></span><span class="hs-comment">-- in-place.  A new array reference is generated when the length changes.  When</span><span>
</span><span id="line-370"></span><span class="hs-comment">-- the length is increased (upto the maximum reserved capacity of the array),</span><span>
</span><span id="line-371"></span><span class="hs-comment">-- the array is not reallocated and the new reference uses the same underlying</span><span>
</span><span id="line-372"></span><span class="hs-comment">-- memory as the old one.</span><span>
</span><span id="line-373"></span><span class="hs-comment">--</span><span>
</span><span id="line-374"></span><span class="hs-comment">-- Several routines in this module allow the programmer to control the capacity</span><span>
</span><span id="line-375"></span><span class="hs-comment">-- of the array. The programmer can control the trade-off between memory usage</span><span>
</span><span id="line-376"></span><span class="hs-comment">-- and performance impact due to reallocations when growing or shrinking the</span><span>
</span><span id="line-377"></span><span class="hs-comment">-- array.</span><span>
</span><span id="line-378"></span><span class="hs-comment">--</span><span>
</span><span id="line-379"></span><span class="hs-keyword">data</span><span> </span><span id="Array"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-var">Array</span></a></span></span><span> </span><span id="local-6989586621679401954"><span class="annot"><a href="#local-6989586621679401954"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span class="hs-cpp">
#ifdef DEVBUILD
</span><span>    </span><span class="hs-identifier">Storable</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span class="hs-cpp">
#endif
</span><span>    </span><span id="Array"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-var">Array</span></a></span></span><span>
</span><span id="line-384"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="arrContents"><span class="annot"><span class="annottext">forall a. Array a -&gt; ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrContents"><span class="hs-identifier hs-var hs-var">arrContents</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">UNPACKIF</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">ArrayContents</span><span>
</span><span id="line-385"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="arrStart"><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var hs-var">arrStart</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401954"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- ^ first address</span><span>
</span><span id="line-386"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="aEnd"><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var hs-var">aEnd</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401954"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- ^ first unused address</span><span>
</span><span id="line-387"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="aBound"><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aBound"><span class="hs-identifier hs-var hs-var">aBound</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401954"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- ^ first address beyond allocated memory</span><span>
</span><span id="line-388"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-389"></span><span>
</span><span id="line-390"></span><span class="hs-comment">-- | @fromForeignPtrUnsafe foreignPtr end bound@ creates an 'Array' that starts</span><span>
</span><span id="line-391"></span><span class="hs-comment">-- at the memory pointed by the @foreignPtr@, @end@ is the first unused</span><span>
</span><span id="line-392"></span><span class="hs-comment">-- address, and @bound@ is the first address beyond the allocated memory.</span><span>
</span><span id="line-393"></span><span class="hs-comment">--</span><span>
</span><span id="line-394"></span><span class="hs-comment">-- Unsafe: Make sure that foreignPtr &lt;= end &lt;= bound and (end - start) is an</span><span>
</span><span id="line-395"></span><span class="hs-comment">-- integral multiple of the element size. Only PlainPtr type ForeignPtr is</span><span>
</span><span id="line-396"></span><span class="hs-comment">-- supported.</span><span>
</span><span id="line-397"></span><span class="hs-comment">--</span><span>
</span><span id="line-398"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-399"></span><span class="hs-comment">--</span><span>
</span><span id="line-400"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromForeignPtrUnsafe"><span class="hs-pragma hs-type">fromForeignPtrUnsafe</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-401"></span><span id="local-6989586621679401948"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromForeignPtrUnsafe"><span class="hs-identifier hs-type">fromForeignPtrUnsafe</span></a></span><span> </span><span class="hs-glyph">::</span><span class="hs-cpp">
#ifdef DEVBUILD
</span><span>    </span><span class="hs-identifier">Storable</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span class="hs-cpp">
#endif
</span><span>    </span><span class="annot"><span class="hs-identifier hs-type">ForeignPtr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401948"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401948"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401948"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401948"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-406"></span><span id="fromForeignPtrUnsafe"><span class="annot"><span class="annottext">fromForeignPtrUnsafe :: forall a. ForeignPtr a -&gt; Ptr a -&gt; Ptr a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromForeignPtrUnsafe"><span class="hs-identifier hs-var hs-var">fromForeignPtrUnsafe</span></a></span></span><span> </span><span id="local-6989586621679401230"><span class="annot"><span class="annottext">fp :: ForeignPtr a
</span><a href="#local-6989586621679401230"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ForeignPtr</span></span><span> </span><span id="local-6989586621679401228"><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679401228"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679401227"><span class="annot"><span class="annottext">ForeignPtrContents
</span><a href="#local-6989586621679401227"><span class="hs-identifier hs-var">contents</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679401226"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401226"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679401225"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401225"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-407"></span><span>    </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. ForeignPtr a -&gt; Ptr a
</span><span class="hs-identifier hs-var">unsafeForeignPtrToPtr</span></span><span> </span><span class="annot"><span class="annottext">ForeignPtr a
</span><a href="#local-6989586621679401230"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401226"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401226"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401225"><span class="hs-identifier hs-var">bound</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span>           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; Ptr a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ForeignPtrContents -&gt; ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fptrToArrayContents"><span class="hs-identifier hs-var">fptrToArrayContents</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignPtrContents
</span><a href="#local-6989586621679401227"><span class="hs-identifier hs-var">contents</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Addr# -&gt; Ptr a
</span><span class="hs-identifier hs-var">Ptr</span></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679401228"><span class="hs-identifier hs-var">start</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401226"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401225"><span class="hs-identifier hs-var">bound</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-409"></span><span>
</span><span id="line-410"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-411"></span><span class="hs-comment">-- Construction</span><span>
</span><span id="line-412"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-413"></span><span>
</span><span id="line-414"></span><span class="hs-comment">-- XXX Change the names to use &quot;new&quot; instead of &quot;newArray&quot;. That way we can use</span><span>
</span><span id="line-415"></span><span class="hs-comment">-- the same names for managed file system objects as well. For unmanaged ones</span><span>
</span><span id="line-416"></span><span class="hs-comment">-- we can use open/create etc as usual.</span><span>
</span><span id="line-417"></span><span class="hs-comment">--</span><span>
</span><span id="line-418"></span><span class="hs-comment">-- A new array is similar to &quot;touch&quot; creating a zero length file. An mmapped</span><span>
</span><span id="line-419"></span><span class="hs-comment">-- array would be similar to a sparse file with holes. TBD: support mmapped</span><span>
</span><span id="line-420"></span><span class="hs-comment">-- files and arrays.</span><span>
</span><span id="line-421"></span><span>
</span><span id="line-422"></span><span class="hs-comment">-- GHC always guarantees word-aligned memory, alignment is important only when</span><span>
</span><span id="line-423"></span><span class="hs-comment">-- we need more than that.  See stg_newAlignedPinnedByteArrayzh and</span><span>
</span><span id="line-424"></span><span class="hs-comment">-- allocatePinned in GHC source.</span><span>
</span><span id="line-425"></span><span>
</span><span id="line-426"></span><span class="hs-comment">-- | @newArrayWith allocator alignment count@ allocates a new array of zero</span><span>
</span><span id="line-427"></span><span class="hs-comment">-- length and with a capacity to hold @count@ elements, using @allocator</span><span>
</span><span id="line-428"></span><span class="hs-comment">-- size alignment@ as the memory allocator function.</span><span>
</span><span id="line-429"></span><span class="hs-comment">--</span><span>
</span><span id="line-430"></span><span class="hs-comment">-- Alignment must be greater than or equal to machine word size and a power of</span><span>
</span><span id="line-431"></span><span class="hs-comment">-- 2.</span><span>
</span><span id="line-432"></span><span class="hs-comment">--</span><span>
</span><span id="line-433"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-434"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArrayWith"><span class="hs-pragma hs-type">newArrayWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-435"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArrayWith"><span class="hs-identifier hs-type">newArrayWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401940"><span class="annot"><a href="#local-6989586621679401940"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401939"><span class="annot"><a href="#local-6989586621679401939"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401940"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401939"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-436"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401940"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayContents"><span class="hs-identifier hs-type">ArrayContents</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401939"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401940"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401939"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-437"></span><span id="newArrayWith"><span class="annot"><span class="annottext">newArrayWith :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; Int -&gt; m (ArrayContents, Ptr a))
-&gt; Int -&gt; Int -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArrayWith"><span class="hs-identifier hs-var hs-var">newArrayWith</span></a></span></span><span> </span><span id="local-6989586621679401216"><span class="annot"><span class="annottext">Int -&gt; Int -&gt; m (ArrayContents, Ptr a)
</span><a href="#local-6989586621679401216"><span class="hs-identifier hs-var">alloc</span></a></span></span><span> </span><span id="local-6989586621679401215"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401215"><span class="hs-identifier hs-var">alignSize</span></a></span></span><span> </span><span id="local-6989586621679401214"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401214"><span class="hs-identifier hs-var">count</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-438"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679401207"><span class="annot"><span class="annottext">size :: Int
</span><a href="#local-6989586621679401207"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401214"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401939"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-439"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679401203"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679401203"><span class="hs-identifier hs-var">contents</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679401202"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401202"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; m (ArrayContents, Ptr a)
</span><a href="#local-6989586621679401216"><span class="hs-identifier hs-var">alloc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401207"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401215"><span class="hs-identifier hs-var">alignSize</span></a></span><span>
</span><span id="line-440"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span>
</span><span id="line-441"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">arrContents :: ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrContents"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679401203"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-442"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">arrStart :: Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401202"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-443"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">aEnd :: Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401202"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-444"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">aBound :: Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aBound"><span class="hs-identifier hs-var">aBound</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401202"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401207"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-445"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-446"></span><span>
</span><span id="line-447"></span><span id="local-6989586621679401931"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newAlignedArrayContents"><span class="hs-identifier hs-type">newAlignedArrayContents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayContents"><span class="hs-identifier hs-type">ArrayContents</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401931"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span class="hs-cpp">
#ifdef USE_C_MALLOC
</span><span class="hs-identifier">newAlignedArrayContents</span><span> </span><span class="hs-identifier">size</span><span> </span><span class="hs-identifier">align</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-450"></span><span>    </span><span class="hs-special">(</span><span class="hs-identifier">ForeignPtr</span><span> </span><span class="hs-identifier">addr</span><span> </span><span class="hs-identifier">contents</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">mallocForeignPtrAlignedBytes</span><span> </span><span class="hs-identifier">size</span><span> </span><span class="hs-identifier">align</span><span>
</span><span id="line-451"></span><span>    </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ArrayContents</span><span> </span><span class="hs-identifier">contents</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">addr</span><span class="hs-special">)</span><span class="hs-cpp">
#else
</span><span id="newAlignedArrayContents"><span class="annot"><span class="annottext">newAlignedArrayContents :: forall a. Int -&gt; Int -&gt; IO (ArrayContents, Ptr a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newAlignedArrayContents"><span class="hs-identifier hs-var hs-var">newAlignedArrayContents</span></a></span></span><span> </span><span id="local-6989586621679401198"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401198"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621679401197"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401197"><span class="hs-identifier hs-var">_align</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401198"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-454"></span><span>  </span><span class="annot"><span class="annottext">forall a. [Char] -&gt; a
</span><span class="hs-identifier hs-var">errorWithoutStackTrace</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;newAlignedArrayContents: size must be &gt;= 0&quot;</span></span><span>
</span><span id="line-455"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newAlignedArrayContents"><span class="hs-identifier hs-var">newAlignedArrayContents</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">I#</span></span><span> </span><span id="local-6989586621679401194"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679401194"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">I#</span></span><span> </span><span id="local-6989586621679401193"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679401193"><span class="hs-identifier hs-var">align</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (State# RealWorld -&gt; (# State# RealWorld, a #)) -&gt; IO a
</span><span class="hs-identifier hs-var">IO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679401192"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679401192"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-456"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall d.
Int# -&gt; Int# -&gt; State# d -&gt; (# State# d, MutableByteArray# d #)
</span><span class="hs-identifier hs-var">newAlignedPinnedByteArray#</span></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679401194"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679401193"><span class="hs-identifier hs-var">align</span></a></span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679401192"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-457"></span><span>        </span><span class="hs-special">(#</span><span> </span><span id="local-6989586621679401191"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679401191"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679401190"><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679401190"><span class="hs-identifier hs-var">mbarr#</span></a></span></span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-458"></span><span>           </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679401189"><span class="annot"><span class="annottext">p :: Ptr a
</span><a href="#local-6989586621679401189"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Addr# -&gt; Ptr a
</span><span class="hs-identifier hs-var">Ptr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteArray# -&gt; Addr#
</span><span class="hs-identifier hs-var">byteArrayContents#</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">unsafeCoerce# :: forall a b. a -&gt; b
</span><span class="hs-identifier hs-type">unsafeCoerce#</span></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679401190"><span class="hs-identifier hs-var">mbarr#</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-cpp">
#ifdef USE_FOREIGN_PTR
</span><span>               </span><span class="hs-identifier">c</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ArrayContents</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">PlainPtr</span><span> </span><span class="hs-identifier">mbarr#</span><span class="hs-special">)</span><span class="hs-cpp">
#else
</span><span>               </span><span id="local-6989586621679401188"><span class="annot"><span class="annottext">c :: ArrayContents
</span><a href="#local-6989586621679401188"><span class="hs-identifier hs-var hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld -&gt; ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayContents"><span class="hs-identifier hs-var">ArrayContents</span></a></span><span> </span><span class="annot"><span class="annottext">MutableByteArray# RealWorld
</span><a href="#local-6989586621679401190"><span class="hs-identifier hs-var">mbarr#</span></a></span><span class="hs-cpp">
#endif
</span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679401191"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679401188"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679401189"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-467"></span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#nilArrayContents"><span class="hs-pragma hs-type">nilArrayContents</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-468"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#nilArrayContents"><span class="hs-identifier hs-type">nilArrayContents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayContents"><span class="hs-identifier hs-type">ArrayContents</span></a></span><span>
</span><span id="line-469"></span><span id="nilArrayContents"><span class="annot"><span class="annottext">nilArrayContents :: ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#nilArrayContents"><span class="hs-identifier hs-var hs-var">nilArrayContents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-470"></span><span>    </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. IO a -&gt; a
</span><span class="hs-identifier hs-var">unsafePerformIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Int -&gt; Int -&gt; IO (ArrayContents, Ptr a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newAlignedArrayContents"><span class="hs-identifier hs-var">newAlignedArrayContents</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-471"></span><span>
</span><span id="line-472"></span><span class="hs-comment">-- | Like 'newArrayWith' but using an allocator that allocates unmanaged pinned</span><span>
</span><span id="line-473"></span><span class="hs-comment">-- memory. The memory will never be freed by GHC.  This could be useful in</span><span>
</span><span id="line-474"></span><span class="hs-comment">-- allocate-once global data structures. Use carefully as incorrect use can</span><span>
</span><span id="line-475"></span><span class="hs-comment">-- lead to memory leak.</span><span>
</span><span id="line-476"></span><span class="hs-comment">--</span><span>
</span><span id="line-477"></span><span class="hs-comment">-- /Internal/</span><span>
</span><span id="line-478"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArrayAlignedUnmanaged"><span class="hs-pragma hs-type">newArrayAlignedUnmanaged</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-479"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArrayAlignedUnmanaged"><span class="hs-identifier hs-type">newArrayAlignedUnmanaged</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401918"><span class="annot"><a href="#local-6989586621679401918"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401917"><span class="annot"><a href="#local-6989586621679401917"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401918"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401917"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-480"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401918"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401917"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-cpp">
#ifdef USE_FOREIGN_PTR
</span><span class="hs-identifier">newArrayAlignedUnmanaged</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-483"></span><span>    </span><span class="hs-identifier">newArrayWith</span><span> </span><span class="hs-identifier">mallocForeignPtrAlignedUnmanagedBytes</span><span>
</span><span id="line-484"></span><span>
</span><span id="line-485"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-486"></span><span>
</span><span id="line-487"></span><span>    </span><span class="hs-identifier">mallocForeignPtrAlignedUnmanagedBytes</span><span> </span><span class="hs-identifier">size</span><span> </span><span class="hs-identifier">align</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-488"></span><span>        </span><span class="hs-identifier">ForeignPtr</span><span> </span><span class="hs-identifier">addr</span><span> </span><span class="hs-identifier">contents</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-489"></span><span>            </span><span class="hs-identifier">liftIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">Malloc.mallocForeignPtrAlignedUnmanagedBytes</span><span> </span><span class="hs-identifier">size</span><span> </span><span class="hs-identifier">align</span><span>
</span><span id="line-490"></span><span>        </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ArrayContents</span><span> </span><span class="hs-identifier">contents</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">addr</span><span class="hs-special">)</span><span class="hs-cpp">
#else
</span><span id="newArrayAlignedUnmanaged"><span class="annot"><span class="annottext">newArrayAlignedUnmanaged :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Int -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArrayAlignedUnmanaged"><span class="hs-identifier hs-var hs-var">newArrayAlignedUnmanaged</span></a></span></span><span> </span><span id="local-6989586621679401181"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401181"><span class="hs-identifier hs-var">_align</span></a></span></span><span> </span><span id="local-6989586621679401180"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401180"><span class="hs-identifier hs-var">count</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-493"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679401173"><span class="annot"><span class="annottext">size :: Int
</span><a href="#local-6989586621679401173"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401180"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401917"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-494"></span><span>    </span><span id="local-6989586621679401172"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401172"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Int -&gt; IO (Ptr a)
</span><span class="hs-identifier hs-var">mallocBytes</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401173"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-495"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span>
</span><span id="line-496"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">arrContents :: ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrContents"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#nilArrayContents"><span class="hs-identifier hs-var">nilArrayContents</span></a></span><span>
</span><span id="line-497"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">arrStart :: Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401172"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-498"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">aEnd :: Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401172"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-499"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">aBound :: Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aBound"><span class="hs-identifier hs-var">aBound</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401172"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401173"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-500"></span><span>        </span><span class="hs-special">}</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-503"></span><span class="hs-comment">-- | Like 'newArrayWith' but using an allocator that aligns the memory to the</span><span>
</span><span id="line-504"></span><span class="hs-comment">-- alignment dictated by the 'Storable' instance of the type.</span><span>
</span><span id="line-505"></span><span class="hs-comment">--</span><span>
</span><span id="line-506"></span><span class="hs-comment">-- /Internal/</span><span>
</span><span id="line-507"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArrayAligned"><span class="hs-pragma hs-type">newArrayAligned</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-508"></span><span id="local-6989586621679401170"><span id="local-6989586621679401171"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArrayAligned"><span class="hs-identifier hs-type">newArrayAligned</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401171"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401170"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401171"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401170"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-509"></span><span id="newArrayAligned"><span class="annot"><span class="annottext">newArrayAligned :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Int -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArrayAligned"><span class="hs-identifier hs-var hs-var">newArrayAligned</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; Int -&gt; m (ArrayContents, Ptr a))
-&gt; Int -&gt; Int -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArrayWith"><span class="hs-identifier hs-var">newArrayWith</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679401164"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401164"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679401163"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401163"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Int -&gt; Int -&gt; IO (ArrayContents, Ptr a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newAlignedArrayContents"><span class="hs-identifier hs-var">newAlignedArrayContents</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401164"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401163"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-510"></span><span>
</span><span id="line-511"></span><span class="hs-comment">-- XXX can unaligned allocation be more efficient when alignment is not needed?</span><span>
</span><span id="line-512"></span><span class="hs-comment">--</span><span>
</span><span id="line-513"></span><span class="hs-comment">-- | Allocates an empty array that can hold 'count' items.  The memory of the</span><span>
</span><span id="line-514"></span><span class="hs-comment">-- array is uninitialized and the allocation is aligned as per the 'Storable'</span><span>
</span><span id="line-515"></span><span class="hs-comment">-- instance of the type.</span><span>
</span><span id="line-516"></span><span class="hs-comment">--</span><span>
</span><span id="line-517"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-518"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArray"><span class="hs-pragma hs-type">newArray</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-519"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArray"><span class="hs-identifier hs-type">newArray</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401911"><span class="annot"><a href="#local-6989586621679401911"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401910"><span class="annot"><a href="#local-6989586621679401910"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401911"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401910"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401911"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401910"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-520"></span><span id="newArray"><span class="annot"><span class="annottext">newArray :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArray"><span class="hs-identifier hs-var hs-var">newArray</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Int -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArrayAligned"><span class="hs-identifier hs-var">newArrayAligned</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">alignment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401910"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-521"></span><span>
</span><span id="line-522"></span><span class="hs-comment">-- | Allocate an Array of the given size and run an IO action passing the array</span><span>
</span><span id="line-523"></span><span class="hs-comment">-- start pointer.</span><span>
</span><span id="line-524"></span><span class="hs-comment">--</span><span>
</span><span id="line-525"></span><span class="hs-comment">-- /Internal/</span><span>
</span><span id="line-526"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#withNewArrayUnsafe"><span class="hs-pragma hs-type">withNewArrayUnsafe</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-527"></span><span id="local-6989586621679401906"><span id="local-6989586621679401907"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#withNewArrayUnsafe"><span class="hs-identifier hs-type">withNewArrayUnsafe</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-528"></span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401907"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401906"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401906"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401907"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401907"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401906"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-529"></span><span id="withNewArrayUnsafe"><span class="annot"><span class="annottext">withNewArrayUnsafe :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; (Ptr a -&gt; m ()) -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#withNewArrayUnsafe"><span class="hs-identifier hs-var hs-var">withNewArrayUnsafe</span></a></span></span><span> </span><span id="local-6989586621679401145"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401145"><span class="hs-identifier hs-var">count</span></a></span></span><span> </span><span id="local-6989586621679401144"><span class="annot"><span class="annottext">Ptr a -&gt; m ()
</span><a href="#local-6989586621679401144"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-530"></span><span>    </span><span id="local-6989586621679401143"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679401143"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArray"><span class="hs-identifier hs-var">newArray</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401145"><span class="hs-identifier hs-var">count</span></a></span><span>
</span><span id="line-531"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
MonadIO m =&gt;
ArrayContents -&gt; Ptr a -&gt; (Ptr a -&gt; m b) -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#unsafeWithArrayContents"><span class="hs-identifier hs-var">unsafeWithArrayContents</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrContents"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679401143"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679401143"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-532"></span><span>        </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679401142"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401142"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; m ()
</span><a href="#local-6989586621679401144"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401142"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679401143"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-533"></span><span>
</span><span id="line-534"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-535"></span><span class="hs-comment">-- Random writes</span><span>
</span><span id="line-536"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-537"></span><span>
</span><span id="line-538"></span><span class="hs-comment">-- | Write an input stream of (index, value) pairs to an array. Throws an</span><span>
</span><span id="line-539"></span><span class="hs-comment">-- error if any index is out of bounds.</span><span>
</span><span id="line-540"></span><span class="hs-comment">--</span><span>
</span><span id="line-541"></span><span class="hs-comment">-- /Unimplemented/</span><span>
</span><span id="line-542"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#putIndices"><span class="hs-pragma hs-type">putIndices</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-543"></span><span id="local-6989586621679401900"><span id="local-6989586621679401901"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#putIndices"><span class="hs-identifier hs-type">putIndices</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401901"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401900"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679401901"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-544"></span><span id="putIndices"><span class="annot"><span class="annottext">putIndices :: forall a (m :: * -&gt; *). Array a -&gt; Fold m (Int, a) ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#putIndices"><span class="hs-identifier hs-var hs-var">putIndices</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-545"></span><span>
</span><span id="line-546"></span><span class="hs-comment">-- | Write the given element to the given index of the array. Does not check if</span><span>
</span><span id="line-547"></span><span class="hs-comment">-- the index is out of bounds of the array.</span><span>
</span><span id="line-548"></span><span class="hs-comment">--</span><span>
</span><span id="line-549"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-550"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#putIndexUnsafe"><span class="hs-pragma hs-type">putIndexUnsafe</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-551"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#putIndexUnsafe"><span class="hs-identifier hs-type">putIndexUnsafe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401898"><span class="annot"><a href="#local-6989586621679401898"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401897"><span class="annot"><a href="#local-6989586621679401897"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401898"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401897"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-552"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401897"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401897"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401898"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-553"></span><span id="putIndexUnsafe"><span class="annot"><span class="annottext">putIndexUnsafe :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; Int -&gt; a -&gt; m ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#putIndexUnsafe"><span class="hs-identifier hs-var hs-var">putIndexUnsafe</span></a></span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679401123"><span id="local-6989586621679401124"><span id="local-6989586621679401125"><span id="local-6989586621679401126"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679401123"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679401122"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401122"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679401121"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679401121"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-554"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
MonadIO m =&gt;
ArrayContents -&gt; Ptr a -&gt; (Ptr a -&gt; m b) -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#unsafeWithArrayContents"><span class="hs-identifier hs-var">unsafeWithArrayContents</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679401126"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401125"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679401120"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401120"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-555"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679401116"><span class="annot"><span class="annottext">elemSize :: Int
</span><a href="#local-6989586621679401116"><span class="hs-identifier hs-var hs-var">elemSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401897"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-556"></span><span>            </span><span id="local-6989586621679401114"><span class="annot"><span class="annottext">elemPtr :: Ptr b
</span><a href="#local-6989586621679401114"><span class="hs-identifier hs-var hs-var">elemPtr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401120"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401116"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401122"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-557"></span><span>        </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401122"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679401114"><span class="hs-identifier hs-var">elemPtr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401116"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401124"><span class="hs-identifier hs-var">aEnd</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-558"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">poke</span></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679401114"><span class="hs-identifier hs-var">elemPtr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679401121"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-559"></span><span>
</span><span id="line-560"></span><span id="local-6989586621679401893"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#invalidIndex"><span class="hs-identifier hs-type">invalidIndex</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401893"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-561"></span><span id="invalidIndex"><span class="annot"><span class="annottext">invalidIndex :: forall a. [Char] -&gt; Int -&gt; a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#invalidIndex"><span class="hs-identifier hs-var hs-var">invalidIndex</span></a></span></span><span> </span><span id="local-6989586621679401107"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679401107"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span id="local-6989586621679401106"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401106"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-562"></span><span>    </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679401107"><span class="hs-keyword hs-var">label</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;: invalid array index &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401106"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-563"></span><span>
</span><span id="line-564"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#putIndexPtr"><span class="hs-pragma hs-type">putIndexPtr</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-565"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#putIndexPtr"><span class="hs-identifier hs-type">putIndexPtr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401889"><span class="annot"><a href="#local-6989586621679401889"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401888"><span class="annot"><a href="#local-6989586621679401888"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401889"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401888"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-566"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401888"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401888"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401888"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401889"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-567"></span><span id="putIndexPtr"><span class="annot"><span class="annottext">putIndexPtr :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; Ptr a -&gt; Int -&gt; a -&gt; m ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#putIndexPtr"><span class="hs-identifier hs-var hs-var">putIndexPtr</span></a></span></span><span> </span><span id="local-6989586621679401096"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401096"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span id="local-6989586621679401095"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401095"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679401094"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401094"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679401093"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679401093"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-568"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679401089"><span class="annot"><span class="annottext">elemSize :: Int
</span><a href="#local-6989586621679401089"><span class="hs-identifier hs-var hs-var">elemSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401888"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-569"></span><span>        </span><span id="local-6989586621679401087"><span class="annot"><span class="annottext">elemPtr :: Ptr b
</span><a href="#local-6989586621679401087"><span class="hs-identifier hs-var hs-var">elemPtr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401096"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401089"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401094"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-570"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401094"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679401087"><span class="hs-identifier hs-var">elemPtr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401089"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401095"><span class="hs-identifier hs-var">end</span></a></span><span>
</span><span id="line-571"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">poke</span></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679401087"><span class="hs-identifier hs-var">elemPtr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679401093"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-572"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. [Char] -&gt; Int -&gt; a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#invalidIndex"><span class="hs-identifier hs-var">invalidIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;putIndexPtr&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401094"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-573"></span><span>
</span><span id="line-574"></span><span class="hs-comment">-- | /O(1)/ Write the given element at the given index in the array.</span><span>
</span><span id="line-575"></span><span class="hs-comment">-- Performs in-place mutation of the array.</span><span>
</span><span id="line-576"></span><span class="hs-comment">--</span><span>
</span><span id="line-577"></span><span class="hs-comment">-- &gt;&gt;&gt; putIndex arr ix val = Array.modifyIndex arr ix (const (val, ()))</span><span>
</span><span id="line-578"></span><span class="hs-comment">-- &gt;&gt;&gt; f = Array.putIndices</span><span>
</span><span id="line-579"></span><span class="hs-comment">-- &gt;&gt;&gt; putIndex arr ix val = Stream.fold (f arr) (Stream.fromPure (ix, val))</span><span>
</span><span id="line-580"></span><span class="hs-comment">--</span><span>
</span><span id="line-581"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-582"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#putIndex"><span class="hs-pragma hs-type">putIndex</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-583"></span><span id="local-6989586621679401085"><span id="local-6989586621679401086"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#putIndex"><span class="hs-identifier hs-type">putIndex</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401086"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401085"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401085"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401085"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401086"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-584"></span><span id="putIndex"><span class="annot"><span class="annottext">putIndex :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; Int -&gt; a -&gt; m ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#putIndex"><span class="hs-identifier hs-var hs-var">putIndex</span></a></span></span><span> </span><span id="local-6989586621679401079"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679401079"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621679401078"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401078"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679401077"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679401077"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-585"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
MonadIO m =&gt;
ArrayContents -&gt; Ptr a -&gt; (Ptr a -&gt; m b) -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#unsafeWithArrayContents"><span class="hs-identifier hs-var">unsafeWithArrayContents</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrContents"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679401079"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679401079"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-586"></span><span>        </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679401076"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401076"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; Ptr a -&gt; Int -&gt; a -&gt; m ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#putIndexPtr"><span class="hs-identifier hs-var">putIndexPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401076"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679401079"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401078"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679401077"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-587"></span><span>
</span><span id="line-588"></span><span class="hs-comment">-- | Modify a given index of an array using a modifier function.</span><span>
</span><span id="line-589"></span><span class="hs-comment">--</span><span>
</span><span id="line-590"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-591"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#modifyIndexUnsafe"><span class="hs-identifier hs-type">modifyIndexUnsafe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401882"><span class="annot"><a href="#local-6989586621679401882"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401881"><span class="annot"><a href="#local-6989586621679401881"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679401880"><span class="annot"><a href="#local-6989586621679401880"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401882"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401881"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-592"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401881"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679401881"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679401881"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679401880"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401882"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401880"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-593"></span><span id="modifyIndexUnsafe"><span class="annot"><span class="annottext">modifyIndexUnsafe :: forall (m :: * -&gt; *) a b.
(MonadIO m, Storable a) =&gt;
Array a -&gt; Int -&gt; (a -&gt; (a, b)) -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#modifyIndexUnsafe"><span class="hs-identifier hs-var hs-var">modifyIndexUnsafe</span></a></span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679401055"><span id="local-6989586621679401056"><span id="local-6989586621679401057"><span id="local-6989586621679401058"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679401055"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679401054"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401054"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679401053"><span class="annot"><span class="annottext">a -&gt; (a, b)
</span><a href="#local-6989586621679401053"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-594"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
MonadIO m =&gt;
ArrayContents -&gt; Ptr a -&gt; (Ptr a -&gt; m b) -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#unsafeWithArrayContents"><span class="hs-identifier hs-var">unsafeWithArrayContents</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679401058"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401057"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679401052"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401052"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-595"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679401048"><span class="annot"><span class="annottext">elemSize :: Int
</span><a href="#local-6989586621679401048"><span class="hs-identifier hs-var hs-var">elemSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401881"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-596"></span><span>            </span><span id="local-6989586621679401046"><span class="annot"><span class="annottext">elemPtr :: Ptr b
</span><a href="#local-6989586621679401046"><span class="hs-identifier hs-var hs-var">elemPtr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401052"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401048"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401054"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-597"></span><span>        </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401054"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679401046"><span class="hs-identifier hs-var">elemPtr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401048"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401056"><span class="hs-identifier hs-var">aEnd</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-598"></span><span>        </span><span id="local-6989586621679401045"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679401045"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679401046"><span class="hs-identifier hs-var">elemPtr</span></a></span><span>
</span><span id="line-599"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679401043"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679401043"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679401042"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679401042"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; (a, b)
</span><a href="#local-6989586621679401053"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679401045"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-600"></span><span>        </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">poke</span></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679401046"><span class="hs-identifier hs-var">elemPtr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679401043"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-601"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679401042"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-602"></span><span>
</span><span id="line-603"></span><span class="hs-comment">-- | Modify a given index of an array using a modifier function.</span><span>
</span><span id="line-604"></span><span class="hs-comment">--</span><span>
</span><span id="line-605"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-606"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#modifyIndex"><span class="hs-identifier hs-type">modifyIndex</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401041"><span class="annot"><a href="#local-6989586621679401041"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401040"><span class="annot"><a href="#local-6989586621679401040"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679401039"><span class="annot"><a href="#local-6989586621679401039"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401041"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401040"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-607"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401040"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679401040"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679401040"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679401039"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401041"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401039"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-608"></span><span id="modifyIndex"><span class="annot"><span class="annottext">modifyIndex :: forall (m :: * -&gt; *) a b.
(MonadIO m, Storable a) =&gt;
Array a -&gt; Int -&gt; (a -&gt; (a, b)) -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#modifyIndex"><span class="hs-identifier hs-var hs-var">modifyIndex</span></a></span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679401023"><span id="local-6989586621679401024"><span id="local-6989586621679401025"><span id="local-6989586621679401026"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679401023"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679401022"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401022"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679401021"><span class="annot"><span class="annottext">a -&gt; (a, b)
</span><a href="#local-6989586621679401021"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-609"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
MonadIO m =&gt;
ArrayContents -&gt; Ptr a -&gt; (Ptr a -&gt; m b) -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#unsafeWithArrayContents"><span class="hs-identifier hs-var">unsafeWithArrayContents</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679401026"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401025"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679401020"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401020"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-610"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679401016"><span class="annot"><span class="annottext">elemSize :: Int
</span><a href="#local-6989586621679401016"><span class="hs-identifier hs-var hs-var">elemSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401040"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-611"></span><span>            </span><span id="local-6989586621679401014"><span class="annot"><span class="annottext">elemPtr :: Ptr b
</span><a href="#local-6989586621679401014"><span class="hs-identifier hs-var hs-var">elemPtr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401020"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401016"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401022"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-612"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401022"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679401014"><span class="hs-identifier hs-var">elemPtr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401016"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679401024"><span class="hs-identifier hs-var">aEnd</span></a></span><span>
</span><span id="line-613"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-614"></span><span>            </span><span id="local-6989586621679401013"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679401013"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679401014"><span class="hs-identifier hs-var">elemPtr</span></a></span><span>
</span><span id="line-615"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679401012"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679401012"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679401011"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679401011"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; (a, b)
</span><a href="#local-6989586621679401021"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679401013"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-616"></span><span>            </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">poke</span></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679401014"><span class="hs-identifier hs-var">elemPtr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679401012"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-617"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679401011"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-618"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. [Char] -&gt; Int -&gt; a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#invalidIndex"><span class="hs-identifier hs-var">invalidIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;modifyIndex&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401022"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-619"></span><span>
</span><span id="line-620"></span><span class="hs-comment">-- | Modify the array indices generated by the supplied unfold.</span><span>
</span><span id="line-621"></span><span class="hs-comment">--</span><span>
</span><span id="line-622"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-623"></span><span id="local-6989586621679401870"><span id="local-6989586621679401871"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#modifyIndices"><span class="hs-identifier hs-type">modifyIndices</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-comment">-- forall m a b. (MonadIO m, Storable a) =&gt;</span><span>
</span><span id="line-624"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Type.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401871"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401870"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401870"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679401870"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401870"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401871"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-625"></span><span id="modifyIndices"><span class="annot"><span class="annottext">modifyIndices :: forall (m :: * -&gt; *) a.
Unfold m (Array a) Int -&gt; Array a -&gt; (a -&gt; a) -&gt; m ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#modifyIndices"><span class="hs-identifier hs-var hs-var">modifyIndices</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-626"></span><span>
</span><span id="line-627"></span><span class="hs-comment">-- | Modify each element of an array using the supplied modifier function.</span><span>
</span><span id="line-628"></span><span class="hs-comment">--</span><span>
</span><span id="line-629"></span><span class="hs-comment">-- /Unimplemented/</span><span>
</span><span id="line-630"></span><span id="local-6989586621679401867"><span id="local-6989586621679401868"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#modify"><span class="hs-identifier hs-type">modify</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-comment">-- forall m a b. (MonadIO m, Storable a) =&gt;</span><span>
</span><span id="line-631"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401868"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679401868"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401868"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401867"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-632"></span><span id="modify"><span class="annot"><span class="annottext">modify :: forall a (m :: * -&gt; *). Array a -&gt; (a -&gt; a) -&gt; m ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#modify"><span class="hs-identifier hs-var hs-var">modify</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-633"></span><span>
</span><span id="line-634"></span><span class="hs-comment">-- | Swap the elements at two indices.</span><span>
</span><span id="line-635"></span><span class="hs-comment">--</span><span>
</span><span id="line-636"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-637"></span><span id="local-6989586621679401865"><span id="local-6989586621679401866"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#swapIndices"><span class="hs-identifier hs-type">swapIndices</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-comment">-- (MonadIO m, Storable a) =&gt;</span><span>
</span><span id="line-638"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401866"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401865"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-639"></span><span id="swapIndices"><span class="annot"><span class="annottext">swapIndices :: forall a (m :: * -&gt; *). Array a -&gt; Int -&gt; Int -&gt; m ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#swapIndices"><span class="hs-identifier hs-var hs-var">swapIndices</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-640"></span><span>
</span><span id="line-641"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-642"></span><span class="hs-comment">-- Rounding</span><span>
</span><span id="line-643"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-644"></span><span>
</span><span id="line-645"></span><span class="hs-comment">-- XXX Should we use bitshifts in calculations or it gets optimized by the</span><span>
</span><span id="line-646"></span><span class="hs-comment">-- compiler/processor itself?</span><span>
</span><span id="line-647"></span><span class="hs-comment">--</span><span>
</span><span id="line-648"></span><span class="hs-comment">-- | The page or block size used by the GHC allocator. Allocator allocates at</span><span>
</span><span id="line-649"></span><span class="hs-comment">-- least a block and then allocates smaller allocations from within a block.</span><span>
</span><span id="line-650"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#blockSize"><span class="hs-identifier hs-type">blockSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-651"></span><span id="blockSize"><span class="annot"><span class="annottext">blockSize :: Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#blockSize"><span class="hs-identifier hs-var hs-var">blockSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1024</span></span><span>
</span><span id="line-652"></span><span>
</span><span id="line-653"></span><span class="hs-comment">-- | Allocations larger than 'largeObjectThreshold' are in multiples of block</span><span>
</span><span id="line-654"></span><span class="hs-comment">-- size and are always pinned. The space beyond the end of a large object up to</span><span>
</span><span id="line-655"></span><span class="hs-comment">-- the end of the block is unused.</span><span>
</span><span id="line-656"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#largeObjectThreshold"><span class="hs-identifier hs-type">largeObjectThreshold</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-657"></span><span id="largeObjectThreshold"><span class="annot"><span class="annottext">largeObjectThreshold :: Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#largeObjectThreshold"><span class="hs-identifier hs-var hs-var">largeObjectThreshold</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#blockSize"><span class="hs-identifier hs-var">blockSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span>
</span><span id="line-658"></span><span>
</span><span id="line-659"></span><span class="hs-comment">-- | Round up an array larger than 'largeObjectThreshold' to use the whole</span><span>
</span><span id="line-660"></span><span class="hs-comment">-- block.</span><span>
</span><span id="line-661"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#roundUpLargeArray"><span class="hs-pragma hs-type">roundUpLargeArray</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-662"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#roundUpLargeArray"><span class="hs-identifier hs-type">roundUpLargeArray</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-663"></span><span id="roundUpLargeArray"><span class="annot"><span class="annottext">roundUpLargeArray :: Int -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#roundUpLargeArray"><span class="hs-identifier hs-var hs-var">roundUpLargeArray</span></a></span></span><span> </span><span id="local-6989586621679401002"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401002"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-664"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401002"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#largeObjectThreshold"><span class="hs-identifier hs-var">largeObjectThreshold</span></a></span><span>
</span><span id="line-665"></span><span>    </span><span class="hs-keyword">then</span><span>
</span><span id="line-666"></span><span>        </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span>
</span><span id="line-667"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#blockSize"><span class="hs-identifier hs-var">blockSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#blockSize"><span class="hs-identifier hs-var">blockSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#blockSize"><span class="hs-identifier hs-var">blockSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-668"></span><span>            </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401002"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#blockSize"><span class="hs-identifier hs-var">blockSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">negate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#blockSize"><span class="hs-identifier hs-var">blockSize</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-669"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679401002"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-670"></span><span>
</span><span id="line-671"></span><span class="hs-comment">{-
roundUpToPower2 :: Int -&gt; Int
roundUpToPower2 = undefined
-}</span><span>
</span><span id="line-675"></span><span>
</span><span id="line-676"></span><span class="hs-comment">-- | @allocBytesToBytes elem allocatedBytes@ returns the array size in bytes</span><span>
</span><span id="line-677"></span><span class="hs-comment">-- such that the real allocation is less than or equal to @allocatedBytes@,</span><span>
</span><span id="line-678"></span><span class="hs-comment">-- unless @allocatedBytes@ is less than the size of one array element in which</span><span>
</span><span id="line-679"></span><span class="hs-comment">-- case it returns one element's size.</span><span>
</span><span id="line-680"></span><span class="hs-comment">--</span><span>
</span><span id="line-681"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#allocBytesToBytes"><span class="hs-pragma hs-type">allocBytesToBytes</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-682"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#allocBytesToBytes"><span class="hs-identifier hs-type">allocBytesToBytes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679400998"><span class="annot"><a href="#local-6989586621679400998"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679400998"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400998"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-683"></span><span id="allocBytesToBytes"><span class="annot"><span class="annottext">allocBytesToBytes :: forall a. Storable a =&gt; a -&gt; Int -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#allocBytesToBytes"><span class="hs-identifier hs-var hs-var">allocBytesToBytes</span></a></span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679400992"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400992"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-684"></span><span>    </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int
</span><a href="Streamly.Internal.System.IO.html#arrayPayloadSize"><span class="hs-identifier hs-var">arrayPayloadSize</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400992"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679400998"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-685"></span><span>
</span><span id="line-686"></span><span class="hs-comment">-- | Given a 'Storable' type (unused first arg) and real allocation size</span><span>
</span><span id="line-687"></span><span class="hs-comment">-- (including overhead), return how many elements of that type will completely</span><span>
</span><span id="line-688"></span><span class="hs-comment">-- fit in it, returns at least 1.</span><span>
</span><span id="line-689"></span><span class="hs-comment">--</span><span>
</span><span id="line-690"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#allocBytesToElemCount"><span class="hs-pragma hs-type">allocBytesToElemCount</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-691"></span><span id="local-6989586621679400991"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#allocBytesToElemCount"><span class="hs-identifier hs-type">allocBytesToElemCount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679400991"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400991"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span></span><span>
</span><span id="line-692"></span><span id="allocBytesToElemCount"><span class="annot"><span class="annottext">allocBytesToElemCount :: forall a. Storable a =&gt; a -&gt; Int -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#allocBytesToElemCount"><span class="hs-identifier hs-var hs-var">allocBytesToElemCount</span></a></span></span><span> </span><span id="local-6989586621679400985"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400985"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679400984"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400984"><span class="hs-identifier hs-var">bytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-693"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400981"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621679400981"><span class="hs-identifier hs-var hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#bytesToElemCount"><span class="hs-identifier hs-var">bytesToElemCount</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400985"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#allocBytesToBytes"><span class="hs-identifier hs-var">allocBytesToBytes</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400985"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400984"><span class="hs-identifier hs-var">bytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-694"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400981"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400981"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-695"></span><span>
</span><span id="line-696"></span><span class="hs-comment">-- | The default chunk size by which the array creation routines increase the</span><span>
</span><span id="line-697"></span><span class="hs-comment">-- size of the array when the array is grown linearly.</span><span>
</span><span id="line-698"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrayChunkBytes"><span class="hs-identifier hs-type">arrayChunkBytes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-699"></span><span id="arrayChunkBytes"><span class="annot"><span class="annottext">arrayChunkBytes :: Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrayChunkBytes"><span class="hs-identifier hs-var hs-var">arrayChunkBytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1024</span></span><span>
</span><span id="line-700"></span><span>
</span><span id="line-701"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-702"></span><span class="hs-comment">-- Snoc</span><span>
</span><span id="line-703"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-704"></span><span>
</span><span id="line-705"></span><span class="hs-comment">-- XXX We can possibly use a smallMutableByteArray to hold the start, end,</span><span>
</span><span id="line-706"></span><span class="hs-comment">-- bound pointers.  Using fully mutable handle will ensure that we do not have</span><span>
</span><span id="line-707"></span><span class="hs-comment">-- multiple references to the same array of different lengths lying around and</span><span>
</span><span id="line-708"></span><span class="hs-comment">-- potentially misused. In that case &quot;snoc&quot; need not return a new array (snoc</span><span>
</span><span id="line-709"></span><span class="hs-comment">-- :: Array a -&gt; a -&gt; m ()), it will just modify the old reference.  The array</span><span>
</span><span id="line-710"></span><span class="hs-comment">-- length will be mutable.  This means the length function would also be</span><span>
</span><span id="line-711"></span><span class="hs-comment">-- monadic.  Mutable arrays would behave more like files that grow in that</span><span>
</span><span id="line-712"></span><span class="hs-comment">-- case.</span><span>
</span><span id="line-713"></span><span>
</span><span id="line-714"></span><span class="hs-comment">-- | Snoc using a 'Ptr'. Low level reusable function.</span><span>
</span><span id="line-715"></span><span class="hs-comment">--</span><span>
</span><span id="line-716"></span><span class="hs-comment">-- /Internal/</span><span>
</span><span id="line-717"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocNewEnd"><span class="hs-pragma hs-type">snocNewEnd</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-718"></span><span id="local-6989586621679401860"><span id="local-6989586621679401861"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocNewEnd"><span class="hs-identifier hs-type">snocNewEnd</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401861"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401860"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401860"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401860"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401860"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401861"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401860"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-719"></span><span id="snocNewEnd"><span class="annot"><span class="annottext">snocNewEnd :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; Array a -&gt; a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocNewEnd"><span class="hs-identifier hs-var hs-var">snocNewEnd</span></a></span></span><span> </span><span id="local-6989586621679400967"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400967"><span class="hs-identifier hs-var">newEnd</span></a></span></span><span> </span><span id="local-6989586621679400966"><span class="annot"><span class="annottext">arr :: Array a
</span><a href="#local-6989586621679400966"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679400962"><span id="local-6989586621679400963"><span id="local-6989586621679400964"><span id="local-6989586621679400965"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679400962"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679400961"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400961"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-720"></span><span>    </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400967"><span class="hs-identifier hs-var">newEnd</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400962"><span class="hs-identifier hs-var">aBound</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-721"></span><span>    </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">poke</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400963"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400961"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-722"></span><span>    </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400965"><span class="hs-identifier hs-var">arrContents</span></a></span><span>
</span><span id="line-723"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400966"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">aEnd :: Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400967"><span class="hs-identifier hs-var">newEnd</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-724"></span><span>
</span><span id="line-725"></span><span class="hs-comment">-- | Really really unsafe, appends the element into the first array, may</span><span>
</span><span id="line-726"></span><span class="hs-comment">-- cause silent data corruption or if you are lucky a segfault if the first</span><span>
</span><span id="line-727"></span><span class="hs-comment">-- array does not have enough space to append the element.</span><span>
</span><span id="line-728"></span><span class="hs-comment">--</span><span>
</span><span id="line-729"></span><span class="hs-comment">-- /Internal/</span><span>
</span><span id="line-730"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocUnsafe"><span class="hs-pragma hs-type">snocUnsafe</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-731"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocUnsafe"><span class="hs-identifier hs-type">snocUnsafe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401857"><span class="annot"><a href="#local-6989586621679401857"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401856"><span class="annot"><a href="#local-6989586621679401856"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401857"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401856"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-732"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401856"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401856"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401857"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401856"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-733"></span><span id="snocUnsafe"><span class="annot"><span class="annottext">snocUnsafe :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocUnsafe"><span class="hs-identifier hs-var hs-var">snocUnsafe</span></a></span></span><span> </span><span id="local-6989586621679400953"><span class="annot"><span class="annottext">arr :: Array a
</span><a href="#local-6989586621679400953"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679400949"><span id="local-6989586621679400950"><span id="local-6989586621679400951"><span id="local-6989586621679400952"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679400949"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-734"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; Array a -&gt; a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocNewEnd"><span class="hs-identifier hs-var">snocNewEnd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400950"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401856"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400953"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-735"></span><span>
</span><span id="line-736"></span><span class="hs-comment">-- | Like 'snoc' but does not reallocate when pre-allocated array capacity</span><span>
</span><span id="line-737"></span><span class="hs-comment">-- becomes full.</span><span>
</span><span id="line-738"></span><span class="hs-comment">--</span><span>
</span><span id="line-739"></span><span class="hs-comment">-- /Internal/</span><span>
</span><span id="line-740"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocMay"><span class="hs-pragma hs-type">snocMay</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-741"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocMay"><span class="hs-identifier hs-type">snocMay</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401853"><span class="annot"><a href="#local-6989586621679401853"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401852"><span class="annot"><a href="#local-6989586621679401852"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401853"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401852"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-742"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401852"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401852"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401853"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401852"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-743"></span><span id="snocMay"><span class="annot"><span class="annottext">snocMay :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; a -&gt; m (Maybe (Array a))
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocMay"><span class="hs-identifier hs-var hs-var">snocMay</span></a></span></span><span> </span><span id="local-6989586621679400940"><span class="annot"><span class="annottext">arr :: Array a
</span><a href="#local-6989586621679400940"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679400936"><span id="local-6989586621679400937"><span id="local-6989586621679400938"><span id="local-6989586621679400939"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679400936"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679400935"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400935"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-744"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400931"><span class="annot"><span class="annottext">newEnd :: Ptr b
</span><a href="#local-6989586621679400931"><span class="hs-identifier hs-var hs-var">newEnd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400937"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401852"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-745"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400931"><span class="hs-identifier hs-var">newEnd</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400936"><span class="hs-identifier hs-var">aBound</span></a></span><span>
</span><span id="line-746"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; Array a -&gt; a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocNewEnd"><span class="hs-identifier hs-var">snocNewEnd</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400931"><span class="hs-identifier hs-var">newEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400940"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400935"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-747"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-748"></span><span>
</span><span id="line-749"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#reallocWith"><span class="hs-identifier hs-type">reallocWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401845"><span class="annot"><a href="#local-6989586621679401845"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401844"><span class="annot"><a href="#local-6989586621679401844"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401845"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401844"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-750"></span><span>       </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-751"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-752"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-753"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401844"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-754"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401845"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401844"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-755"></span><span id="reallocWith"><span class="annot"><span class="annottext">reallocWith :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
[Char] -&gt; (Int -&gt; Int) -&gt; Int -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#reallocWith"><span class="hs-identifier hs-var hs-var">reallocWith</span></a></span></span><span> </span><span id="local-6989586621679400910"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679400910"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span id="local-6989586621679400909"><span class="annot"><span class="annottext">Int -&gt; Int
</span><a href="#local-6989586621679400909"><span class="hs-identifier hs-var">sizer</span></a></span></span><span> </span><span id="local-6989586621679400908"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400908"><span class="hs-identifier hs-var">reqSize</span></a></span></span><span> </span><span id="local-6989586621679400907"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400907"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-756"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400906"><span class="annot"><span class="annottext">oldSize :: Int
</span><a href="#local-6989586621679400906"><span class="hs-identifier hs-var hs-var">oldSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400907"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b -&gt; Int
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400907"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-757"></span><span>        </span><span id="local-6989586621679400905"><span class="annot"><span class="annottext">newSize :: Int
</span><a href="#local-6989586621679400905"><span class="hs-identifier hs-var hs-var">newSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
</span><a href="#local-6989586621679400909"><span class="hs-identifier hs-var">sizer</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400906"><span class="hs-identifier hs-var">oldSize</span></a></span><span>
</span><span id="line-758"></span><span>        </span><span id="local-6989586621679400902"><span class="annot"><span class="annottext">safeSize :: Int
</span><a href="#local-6989586621679400902"><span class="hs-identifier hs-var hs-var">safeSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400905"><span class="hs-identifier hs-var">newSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400906"><span class="hs-identifier hs-var">oldSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400908"><span class="hs-identifier hs-var">reqSize</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-759"></span><span>        </span><span id="local-6989586621679400901"><span class="annot"><span class="annottext">rounded :: Int
</span><a href="#local-6989586621679400901"><span class="hs-identifier hs-var hs-var">rounded</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#roundUpLargeArray"><span class="hs-identifier hs-var">roundUpLargeArray</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400902"><span class="hs-identifier hs-var">safeSize</span></a></span><span>
</span><span id="line-760"></span><span>    </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400905"><span class="hs-identifier hs-var">newSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400906"><span class="hs-identifier hs-var">oldSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400908"><span class="hs-identifier hs-var">reqSize</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679400899"><span class="hs-identifier hs-var">badSize</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-761"></span><span>    </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400901"><span class="hs-identifier hs-var">rounded</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400902"><span class="hs-identifier hs-var">safeSize</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-762"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#realloc"><span class="hs-identifier hs-var">realloc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400901"><span class="hs-identifier hs-var">rounded</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400907"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-763"></span><span>
</span><span id="line-764"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-765"></span><span>
</span><span id="line-766"></span><span>    </span><span id="local-6989586621679400899"><span class="annot"><span class="annottext">badSize :: [Char]
</span><a href="#local-6989586621679400899"><span class="hs-identifier hs-var hs-var">badSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span>
</span><span id="line-767"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679400910"><span class="hs-keyword hs-var">label</span></a></span><span>
</span><span id="line-768"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;: new array size is less than required size &quot;</span></span><span>
</span><span id="line-769"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400908"><span class="hs-identifier hs-var">reqSize</span></a></span><span>
</span><span id="line-770"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;. Please check the sizing function passed.&quot;</span></span><span>
</span><span id="line-771"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-772"></span><span>
</span><span id="line-773"></span><span class="hs-comment">-- NOINLINE to move it out of the way and not pollute the instruction cache.</span><span>
</span><span id="line-774"></span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocWithRealloc"><span class="hs-pragma hs-type">snocWithRealloc</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-775"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocWithRealloc"><span class="hs-identifier hs-type">snocWithRealloc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401835"><span class="annot"><a href="#local-6989586621679401835"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401834"><span class="annot"><a href="#local-6989586621679401834"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401835"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401834"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-776"></span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-777"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401834"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-778"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401834"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-779"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401835"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401834"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-780"></span><span id="snocWithRealloc"><span class="annot"><span class="annottext">snocWithRealloc :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; Int) -&gt; Array a -&gt; a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocWithRealloc"><span class="hs-identifier hs-var hs-var">snocWithRealloc</span></a></span></span><span> </span><span id="local-6989586621679400884"><span class="annot"><span class="annottext">Int -&gt; Int
</span><a href="#local-6989586621679400884"><span class="hs-identifier hs-var">sizer</span></a></span></span><span> </span><span id="local-6989586621679400883"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400883"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621679400882"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400882"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-781"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400878"><span class="annot"><span class="annottext">elemSize :: Int
</span><a href="#local-6989586621679400878"><span class="hs-identifier hs-var hs-var">elemSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401834"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-782"></span><span>    </span><span id="local-6989586621679400877"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400877"><span class="hs-identifier hs-var">arr1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
[Char] -&gt; (Int -&gt; Int) -&gt; Int -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#reallocWith"><span class="hs-identifier hs-var">reallocWith</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;snocWith&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
</span><a href="#local-6989586621679400884"><span class="hs-identifier hs-var">sizer</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400878"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400883"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-783"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocUnsafe"><span class="hs-identifier hs-var">snocUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400877"><span class="hs-identifier hs-var">arr1</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400882"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-784"></span><span>
</span><span id="line-785"></span><span class="hs-comment">-- | @snocWith sizer arr elem@ mutates @arr@ to append @elem@. The length of</span><span>
</span><span id="line-786"></span><span class="hs-comment">-- the array increases by 1.</span><span>
</span><span id="line-787"></span><span class="hs-comment">--</span><span>
</span><span id="line-788"></span><span class="hs-comment">-- If there is no reserved space available in @arr@ it is reallocated to a size</span><span>
</span><span id="line-789"></span><span class="hs-comment">-- in bytes determined by the @sizer oldSizeBytes@ function, where</span><span>
</span><span id="line-790"></span><span class="hs-comment">-- @oldSizeBytes@ is the original size of the array in bytes.</span><span>
</span><span id="line-791"></span><span class="hs-comment">--</span><span>
</span><span id="line-792"></span><span class="hs-comment">-- If the new array size is more than 'largeObjectThreshold' we automatically</span><span>
</span><span id="line-793"></span><span class="hs-comment">-- round it up to 'blockSize'.</span><span>
</span><span id="line-794"></span><span class="hs-comment">--</span><span>
</span><span id="line-795"></span><span class="hs-comment">-- Note that the returned array may be a mutated version of the original array.</span><span>
</span><span id="line-796"></span><span class="hs-comment">--</span><span>
</span><span id="line-797"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-798"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocWith"><span class="hs-pragma hs-type">snocWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-799"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocWith"><span class="hs-identifier hs-type">snocWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679400876"><span class="annot"><a href="#local-6989586621679400876"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679400875"><span class="annot"><a href="#local-6989586621679400875"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679400876"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679400875"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-800"></span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-801"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400875"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-802"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400875"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-803"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400876"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400875"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-804"></span><span id="snocWith"><span class="annot"><span class="annottext">snocWith :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; Int) -&gt; Array a -&gt; a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocWith"><span class="hs-identifier hs-var hs-var">snocWith</span></a></span></span><span> </span><span id="local-6989586621679400866"><span class="annot"><span class="annottext">Int -&gt; Int
</span><a href="#local-6989586621679400866"><span class="hs-identifier hs-var">allocSize</span></a></span></span><span> </span><span id="local-6989586621679400865"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400865"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621679400864"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400864"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-805"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400860"><span class="annot"><span class="annottext">newEnd :: Ptr b
</span><a href="#local-6989586621679400860"><span class="hs-identifier hs-var hs-var">newEnd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400865"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679400875"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-806"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400860"><span class="hs-identifier hs-var">newEnd</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aBound"><span class="hs-identifier hs-var">aBound</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400865"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-807"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; Array a -&gt; a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocNewEnd"><span class="hs-identifier hs-var">snocNewEnd</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400860"><span class="hs-identifier hs-var">newEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400865"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400864"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-808"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; Int) -&gt; Array a -&gt; a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocWithRealloc"><span class="hs-identifier hs-var">snocWithRealloc</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
</span><a href="#local-6989586621679400866"><span class="hs-identifier hs-var">allocSize</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400865"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400864"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-809"></span><span>
</span><span id="line-810"></span><span class="hs-comment">-- | The array is mutated to append an additional element to it. If there</span><span>
</span><span id="line-811"></span><span class="hs-comment">-- is no reserved space available in the array then it is reallocated to grow</span><span>
</span><span id="line-812"></span><span class="hs-comment">-- it by 'arrayChunkBytes' rounded up to 'blockSize' when the size becomes more</span><span>
</span><span id="line-813"></span><span class="hs-comment">-- than 'largeObjectThreshold'.</span><span>
</span><span id="line-814"></span><span class="hs-comment">--</span><span>
</span><span id="line-815"></span><span class="hs-comment">-- Note that the returned array may be a mutated version of the original array.</span><span>
</span><span id="line-816"></span><span class="hs-comment">--</span><span>
</span><span id="line-817"></span><span class="hs-comment">-- Performs O(n^2) copies to grow but is thrifty on memory.</span><span>
</span><span id="line-818"></span><span class="hs-comment">--</span><span>
</span><span id="line-819"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-820"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocLinear"><span class="hs-pragma hs-type">snocLinear</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-821"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocLinear"><span class="hs-identifier hs-type">snocLinear</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679400859"><span class="annot"><a href="#local-6989586621679400859"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679400858"><span class="annot"><a href="#local-6989586621679400858"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679400859"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679400858"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400858"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400858"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400859"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400858"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-822"></span><span id="snocLinear"><span class="annot"><span class="annottext">snocLinear :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocLinear"><span class="hs-identifier hs-var hs-var">snocLinear</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; Int) -&gt; Array a -&gt; a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocWith"><span class="hs-identifier hs-var">snocWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#allocBytesToBytes"><span class="hs-identifier hs-var">allocBytesToBytes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679400858"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrayChunkBytes"><span class="hs-identifier hs-var">arrayChunkBytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-823"></span><span>
</span><span id="line-824"></span><span class="hs-comment">-- XXX round it to next power of 2.</span><span>
</span><span id="line-825"></span><span class="hs-comment">--</span><span>
</span><span id="line-826"></span><span class="hs-comment">-- | The array is mutated to append an additional element to it. If there is no</span><span>
</span><span id="line-827"></span><span class="hs-comment">-- reserved space available in the array then it is reallocated to double the</span><span>
</span><span id="line-828"></span><span class="hs-comment">-- original size.</span><span>
</span><span id="line-829"></span><span class="hs-comment">--</span><span>
</span><span id="line-830"></span><span class="hs-comment">-- This is useful to reduce allocations when appending unknown number of</span><span>
</span><span id="line-831"></span><span class="hs-comment">-- elements.</span><span>
</span><span id="line-832"></span><span class="hs-comment">--</span><span>
</span><span id="line-833"></span><span class="hs-comment">-- Note that the returned array may be a mutated version of the original array.</span><span>
</span><span id="line-834"></span><span class="hs-comment">--</span><span>
</span><span id="line-835"></span><span class="hs-comment">-- &gt;&gt;&gt; snoc = Array.snocWith (* 2)</span><span>
</span><span id="line-836"></span><span class="hs-comment">--</span><span>
</span><span id="line-837"></span><span class="hs-comment">-- Performs O(n * log n) copies to grow, but is liberal with memory allocation.</span><span>
</span><span id="line-838"></span><span class="hs-comment">--</span><span>
</span><span id="line-839"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-840"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snoc"><span class="hs-pragma hs-type">snoc</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-841"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snoc"><span class="hs-identifier hs-type">snoc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679400849"><span class="annot"><a href="#local-6989586621679400849"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679400848"><span class="annot"><a href="#local-6989586621679400848"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679400849"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679400848"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400848"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400848"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400849"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400848"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-842"></span><span id="snoc"><span class="annot"><span class="annottext">snoc :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snoc"><span class="hs-identifier hs-var hs-var">snoc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; Int) -&gt; Array a -&gt; a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocWith"><span class="hs-identifier hs-var">snocWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span>
</span><span id="line-843"></span><span>
</span><span id="line-844"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-845"></span><span class="hs-comment">-- Resizing</span><span>
</span><span id="line-846"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-847"></span><span>
</span><span id="line-848"></span><span class="hs-comment">-- XXX See if resizing can be implemented by reading the old array as a stream</span><span>
</span><span id="line-849"></span><span class="hs-comment">-- and then using writeN to the new array.</span><span>
</span><span id="line-850"></span><span class="hs-comment">--</span><span>
</span><span id="line-851"></span><span class="hs-comment">-- | Reallocate the array to the specified size in bytes. If the size is less</span><span>
</span><span id="line-852"></span><span class="hs-comment">-- than the original array the array gets truncated.</span><span>
</span><span id="line-853"></span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#reallocAligned"><span class="hs-pragma hs-type">reallocAligned</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-854"></span><span id="local-6989586621679401824"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#reallocAligned"><span class="hs-identifier hs-type">reallocAligned</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401824"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401824"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-855"></span><span id="reallocAligned"><span class="annot"><span class="annottext">reallocAligned :: forall a. Int -&gt; Int -&gt; Int -&gt; Array a -&gt; IO (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#reallocAligned"><span class="hs-identifier hs-var hs-var">reallocAligned</span></a></span></span><span> </span><span id="local-6989586621679400809"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400809"><span class="hs-identifier hs-var">elemSize</span></a></span></span><span> </span><span id="local-6989586621679400808"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400808"><span class="hs-identifier hs-var">alignSize</span></a></span></span><span> </span><span id="local-6989586621679400807"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400807"><span class="hs-identifier hs-var">newSize</span></a></span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679400803"><span id="local-6989586621679400804"><span id="local-6989586621679400805"><span id="local-6989586621679400806"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679400803"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-856"></span><span>    </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400804"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400803"><span class="hs-identifier hs-var">aBound</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-857"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400802"><span class="annot"><span class="annottext">oldStart :: Ptr a
</span><a href="#local-6989586621679400802"><span class="hs-identifier hs-var hs-var">oldStart</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400805"><span class="hs-identifier hs-var">arrStart</span></a></span><span>
</span><span id="line-858"></span><span>        </span><span id="local-6989586621679400801"><span class="annot"><span class="annottext">oldSize :: Int
</span><a href="#local-6989586621679400801"><span class="hs-identifier hs-var hs-var">oldSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400804"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b -&gt; Int
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400802"><span class="hs-identifier hs-var">oldStart</span></a></span><span>
</span><span id="line-859"></span><span>    </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400801"><span class="hs-identifier hs-var">oldSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`mod`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400809"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-860"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679400799"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400799"><span class="hs-identifier hs-var">contents</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679400798"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400798"><span class="hs-identifier hs-var">pNew</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Int -&gt; Int -&gt; IO (ArrayContents, Ptr a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newAlignedArrayContents"><span class="hs-identifier hs-var">newAlignedArrayContents</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400807"><span class="hs-identifier hs-var">newSize</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400808"><span class="hs-identifier hs-var">alignSize</span></a></span><span>
</span><span id="line-861"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400796"><span class="annot"><span class="annottext">size :: Int
</span><a href="#local-6989586621679400796"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">min</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400801"><span class="hs-identifier hs-var">oldSize</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400807"><span class="hs-identifier hs-var">newSize</span></a></span><span>
</span><span id="line-862"></span><span>    </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400796"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-863"></span><span>    </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400796"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`mod`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400809"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-864"></span><span>    </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Int -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#memcpy"><span class="hs-identifier hs-var">memcpy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400798"><span class="hs-identifier hs-var">pNew</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400802"><span class="hs-identifier hs-var">oldStart</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400796"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-865"></span><span>    </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400806"><span class="hs-identifier hs-var">arrContents</span></a></span><span>
</span><span id="line-866"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span>
</span><span id="line-867"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">arrStart :: Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400798"><span class="hs-identifier hs-var">pNew</span></a></span><span>
</span><span id="line-868"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">arrContents :: ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrContents"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400799"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-869"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">aEnd :: Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400798"><span class="hs-identifier hs-var">pNew</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400796"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400796"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`mod`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400809"><span class="hs-identifier hs-var">elemSize</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-870"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">aBound :: Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aBound"><span class="hs-identifier hs-var">aBound</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400798"><span class="hs-identifier hs-var">pNew</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400807"><span class="hs-identifier hs-var">newSize</span></a></span><span>
</span><span id="line-871"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-872"></span><span>
</span><span id="line-873"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#realloc"><span class="hs-pragma hs-type">realloc</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-874"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#realloc"><span class="hs-identifier hs-type">realloc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401839"><span class="annot"><a href="#local-6989586621679401839"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401838"><span class="annot"><a href="#local-6989586621679401838"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401839"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401838"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401838"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401839"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401838"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-875"></span><span id="realloc"><span class="annot"><span class="annottext">realloc :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#realloc"><span class="hs-identifier hs-var hs-var">realloc</span></a></span></span><span> </span><span id="local-6989586621679400785"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400785"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679400784"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400784"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-876"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-877"></span><span>        </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Int -&gt; Int -&gt; Int -&gt; Array a -&gt; IO (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#reallocAligned"><span class="hs-identifier hs-var">reallocAligned</span></a></span><span>
</span><span id="line-878"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401838"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">alignment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401838"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400785"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400784"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-879"></span><span>
</span><span id="line-880"></span><span class="hs-comment">-- | Change the reserved memory of the array so that it is enough to hold the</span><span>
</span><span id="line-881"></span><span class="hs-comment">-- specified number of elements.  Nothing is done if the specified capacity is</span><span>
</span><span id="line-882"></span><span class="hs-comment">-- less than the length of the array.</span><span>
</span><span id="line-883"></span><span class="hs-comment">--</span><span>
</span><span id="line-884"></span><span class="hs-comment">-- If the capacity is more than 'largeObjectThreshold' then it is rounded up to</span><span>
</span><span id="line-885"></span><span class="hs-comment">-- the block size (4K).</span><span>
</span><span id="line-886"></span><span class="hs-comment">--</span><span>
</span><span id="line-887"></span><span class="hs-comment">-- /Unimplemented/</span><span>
</span><span id="line-888"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#resize"><span class="hs-pragma hs-type">resize</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-889"></span><span id="local-6989586621679401817"><span id="local-6989586621679401818"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#resize"><span class="hs-identifier hs-type">resize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-comment">-- (MonadIO m, Storable a) =&gt;</span><span>
</span><span id="line-890"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401818"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401817"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401818"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-891"></span><span id="resize"><span class="annot"><span class="annottext">resize :: forall a (m :: * -&gt; *). Int -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#resize"><span class="hs-identifier hs-var hs-var">resize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-892"></span><span>
</span><span id="line-893"></span><span class="hs-comment">-- | Like 'resize' but if the capacity is more than 'largeObjectThreshold' then</span><span>
</span><span id="line-894"></span><span class="hs-comment">-- it is rounded up to the closest power of 2.</span><span>
</span><span id="line-895"></span><span class="hs-comment">--</span><span>
</span><span id="line-896"></span><span class="hs-comment">-- /Unimplemented/</span><span>
</span><span id="line-897"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#resizeExp"><span class="hs-pragma hs-type">resizeExp</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-898"></span><span id="local-6989586621679400780"><span id="local-6989586621679400781"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#resizeExp"><span class="hs-identifier hs-type">resizeExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-comment">-- (MonadIO m, Storable a) =&gt;</span><span>
</span><span id="line-899"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400781"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400780"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400781"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-900"></span><span id="resizeExp"><span class="annot"><span class="annottext">resizeExp :: forall a (m :: * -&gt; *). Int -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#resizeExp"><span class="hs-identifier hs-var hs-var">resizeExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-901"></span><span>
</span><span id="line-902"></span><span class="hs-comment">-- | Resize the allocated memory to drop any reserved free space at the end of</span><span>
</span><span id="line-903"></span><span class="hs-comment">-- the array and reallocate it to reduce wastage.</span><span>
</span><span id="line-904"></span><span class="hs-comment">--</span><span>
</span><span id="line-905"></span><span class="hs-comment">-- Up to 25% wastage is allowed to avoid reallocations.  If the capacity is</span><span>
</span><span id="line-906"></span><span class="hs-comment">-- more than 'largeObjectThreshold' then free space up to the 'blockSize' is</span><span>
</span><span id="line-907"></span><span class="hs-comment">-- retained.</span><span>
</span><span id="line-908"></span><span class="hs-comment">--</span><span>
</span><span id="line-909"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-910"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#rightSize"><span class="hs-pragma hs-type">rightSize</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-911"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#rightSize"><span class="hs-identifier hs-type">rightSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401816"><span class="annot"><a href="#local-6989586621679401816"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401815"><span class="annot"><a href="#local-6989586621679401815"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401816"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401815"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401815"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401816"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401815"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-912"></span><span id="rightSize"><span class="annot"><span class="annottext">rightSize :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#rightSize"><span class="hs-identifier hs-var hs-var">rightSize</span></a></span></span><span> </span><span id="local-6989586621679400747"><span class="annot"><span class="annottext">arr :: Array a
</span><a href="#local-6989586621679400747"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679400743"><span id="local-6989586621679400744"><span id="local-6989586621679400745"><span id="local-6989586621679400746"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679400743"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-913"></span><span>    </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400744"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400743"><span class="hs-identifier hs-var">aBound</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-914"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400742"><span class="annot"><span class="annottext">start :: Ptr a
</span><a href="#local-6989586621679400742"><span class="hs-identifier hs-var hs-var">start</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400745"><span class="hs-identifier hs-var">arrStart</span></a></span><span>
</span><span id="line-915"></span><span>        </span><span id="local-6989586621679400741"><span class="annot"><span class="annottext">len :: Int
</span><a href="#local-6989586621679400741"><span class="hs-identifier hs-var hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400744"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b -&gt; Int
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400742"><span class="hs-identifier hs-var">start</span></a></span><span>
</span><span id="line-916"></span><span>        </span><span id="local-6989586621679400740"><span class="annot"><span class="annottext">capacity :: Int
</span><a href="#local-6989586621679400740"><span class="hs-identifier hs-var hs-var">capacity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400743"><span class="hs-identifier hs-var">aBound</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b -&gt; Int
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400742"><span class="hs-identifier hs-var">start</span></a></span><span>
</span><span id="line-917"></span><span>        </span><span id="local-6989586621679400739"><span class="annot"><span class="annottext">target :: Int
</span><a href="#local-6989586621679400739"><span class="hs-identifier hs-var hs-var">target</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#roundUpLargeArray"><span class="hs-identifier hs-var">roundUpLargeArray</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400741"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-918"></span><span>        </span><span id="local-6989586621679400738"><span class="annot"><span class="annottext">waste :: Int
</span><a href="#local-6989586621679400738"><span class="hs-identifier hs-var hs-var">waste</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400743"><span class="hs-identifier hs-var">aBound</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b -&gt; Int
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400744"><span class="hs-identifier hs-var">aEnd</span></a></span><span>
</span><span id="line-919"></span><span>    </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400739"><span class="hs-identifier hs-var">target</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400741"><span class="hs-identifier hs-var">len</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-920"></span><span>    </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400741"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`mod`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401815"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-921"></span><span>    </span><span class="hs-comment">-- We trade off some wastage (25%) to avoid reallocations and copying.</span><span>
</span><span id="line-922"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400739"><span class="hs-identifier hs-var">target</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400740"><span class="hs-identifier hs-var">capacity</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400741"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400738"><span class="hs-identifier hs-var">waste</span></a></span><span>
</span><span id="line-923"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#realloc"><span class="hs-identifier hs-var">realloc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400739"><span class="hs-identifier hs-var">target</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400747"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-924"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400747"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-925"></span><span>
</span><span id="line-926"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-927"></span><span class="hs-comment">-- Reducing the length</span><span>
</span><span id="line-928"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-929"></span><span>
</span><span id="line-930"></span><span class="hs-comment">-- XXX Either slice the array or stream it and write it out to a new array?</span><span>
</span><span id="line-931"></span><span class="hs-comment">--</span><span>
</span><span id="line-932"></span><span class="hs-comment">-- | Drop the last n elements of the array to reduce the length by n. The</span><span>
</span><span id="line-933"></span><span class="hs-comment">-- capacity is reallocated using the user supplied function.</span><span>
</span><span id="line-934"></span><span class="hs-comment">--</span><span>
</span><span id="line-935"></span><span class="hs-comment">-- /Unimplemented/</span><span>
</span><span id="line-936"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#truncateWith"><span class="hs-pragma hs-type">truncateWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-937"></span><span id="local-6989586621679401811"><span id="local-6989586621679401812"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#truncateWith"><span class="hs-identifier hs-type">truncateWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-comment">-- (MonadIO m, Storable a) =&gt;</span><span>
</span><span id="line-938"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401812"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401811"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401812"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-939"></span><span id="truncateWith"><span class="annot"><span class="annottext">truncateWith :: forall a (m :: * -&gt; *).
Int -&gt; (Int -&gt; Int) -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#truncateWith"><span class="hs-identifier hs-var hs-var">truncateWith</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-940"></span><span>
</span><span id="line-941"></span><span class="hs-comment">-- | Drop the last n elements of the array to reduce the length by n.</span><span>
</span><span id="line-942"></span><span class="hs-comment">--</span><span>
</span><span id="line-943"></span><span class="hs-comment">-- The capacity is rounded to 1K or 4K if the length is more than the GHC large</span><span>
</span><span id="line-944"></span><span class="hs-comment">-- block threshold.</span><span>
</span><span id="line-945"></span><span class="hs-comment">--</span><span>
</span><span id="line-946"></span><span class="hs-comment">-- /Unimplemented/</span><span>
</span><span id="line-947"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#truncate"><span class="hs-pragma hs-type">truncate</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-948"></span><span id="local-6989586621679400734"><span id="local-6989586621679400735"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#truncate"><span class="hs-identifier hs-type">truncate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-comment">-- (MonadIO m, Storable a) =&gt;</span><span>
</span><span id="line-949"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400735"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400734"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400735"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-950"></span><span id="truncate"><span class="annot"><span class="annottext">truncate :: forall a (m :: * -&gt; *). Int -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#truncate"><span class="hs-identifier hs-var hs-var">truncate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-951"></span><span>
</span><span id="line-952"></span><span class="hs-comment">-- | Like 'truncate' but the capacity is rounded to the closest power of 2.</span><span>
</span><span id="line-953"></span><span class="hs-comment">--</span><span>
</span><span id="line-954"></span><span class="hs-comment">-- /Unimplemented/</span><span>
</span><span id="line-955"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#truncateExp"><span class="hs-pragma hs-type">truncateExp</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-956"></span><span id="local-6989586621679400730"><span id="local-6989586621679400731"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#truncateExp"><span class="hs-identifier hs-type">truncateExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-comment">-- (MonadIO m, Storable a) =&gt;</span><span>
</span><span id="line-957"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400731"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400730"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400731"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-958"></span><span id="truncateExp"><span class="annot"><span class="annottext">truncateExp :: forall a (m :: * -&gt; *). Int -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#truncateExp"><span class="hs-identifier hs-var hs-var">truncateExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-959"></span><span>
</span><span id="line-960"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-961"></span><span class="hs-comment">-- Random reads</span><span>
</span><span id="line-962"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-963"></span><span>
</span><span id="line-964"></span><span class="hs-comment">-- | Return the element at the specified index without checking the bounds.</span><span>
</span><span id="line-965"></span><span class="hs-comment">--</span><span>
</span><span id="line-966"></span><span class="hs-comment">-- Unsafe because it does not check the bounds of the array.</span><span>
</span><span id="line-967"></span><span class="hs-pragma">{-# INLINE_NORMAL getIndexUnsafe #-}</span><span>
</span><span id="line-968"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndexUnsafe"><span class="hs-identifier hs-type">getIndexUnsafe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401810"><span class="annot"><a href="#local-6989586621679401810"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401809"><span class="annot"><a href="#local-6989586621679401809"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401810"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401809"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401809"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401810"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401809"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-969"></span><span id="getIndexUnsafe"><span class="annot"><span class="annottext">getIndexUnsafe :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; Int -&gt; m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndexUnsafe"><span class="hs-identifier hs-var hs-var">getIndexUnsafe</span></a></span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679400711"><span id="local-6989586621679400712"><span id="local-6989586621679400713"><span id="local-6989586621679400714"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679400711"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679400710"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400710"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-970"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
MonadIO m =&gt;
ArrayContents -&gt; Ptr a -&gt; (Ptr a -&gt; m b) -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#unsafeWithArrayContents"><span class="hs-identifier hs-var">unsafeWithArrayContents</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400714"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400713"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679400709"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400709"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-971"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400705"><span class="annot"><span class="annottext">elemSize :: Int
</span><a href="#local-6989586621679400705"><span class="hs-identifier hs-var hs-var">elemSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401809"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-972"></span><span>            </span><span id="local-6989586621679400703"><span class="annot"><span class="annottext">elemPtr :: Ptr b
</span><a href="#local-6989586621679400703"><span class="hs-identifier hs-var hs-var">elemPtr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400709"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400705"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400710"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-973"></span><span>        </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400710"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400703"><span class="hs-identifier hs-var">elemPtr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400705"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400712"><span class="hs-identifier hs-var">aEnd</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-974"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400703"><span class="hs-identifier hs-var">elemPtr</span></a></span><span>
</span><span id="line-975"></span><span>
</span><span id="line-976"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndexPtr"><span class="hs-pragma hs-type">getIndexPtr</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-977"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndexPtr"><span class="hs-identifier hs-type">getIndexPtr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401805"><span class="annot"><a href="#local-6989586621679401805"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401804"><span class="annot"><a href="#local-6989586621679401804"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401805"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401804"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-978"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401804"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401804"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401805"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401804"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-979"></span><span id="getIndexPtr"><span class="annot"><span class="annottext">getIndexPtr :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; Ptr a -&gt; Int -&gt; m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndexPtr"><span class="hs-identifier hs-var hs-var">getIndexPtr</span></a></span></span><span> </span><span id="local-6989586621679400694"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400694"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span id="local-6989586621679400693"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400693"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679400692"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400692"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-980"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400688"><span class="annot"><span class="annottext">elemSize :: Int
</span><a href="#local-6989586621679400688"><span class="hs-identifier hs-var hs-var">elemSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401804"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-981"></span><span>        </span><span id="local-6989586621679400686"><span class="annot"><span class="annottext">elemPtr :: Ptr b
</span><a href="#local-6989586621679400686"><span class="hs-identifier hs-var hs-var">elemPtr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400694"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400688"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400692"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-982"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400692"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400686"><span class="hs-identifier hs-var">elemPtr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400688"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400693"><span class="hs-identifier hs-var">end</span></a></span><span>
</span><span id="line-983"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400686"><span class="hs-identifier hs-var">elemPtr</span></a></span><span>
</span><span id="line-984"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. [Char] -&gt; Int -&gt; a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#invalidIndex"><span class="hs-identifier hs-var">invalidIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;getIndexPtr&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400692"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-985"></span><span>
</span><span id="line-986"></span><span class="hs-comment">-- | /O(1)/ Lookup the element at the given index. Index starts from 0.</span><span>
</span><span id="line-987"></span><span class="hs-comment">--</span><span>
</span><span id="line-988"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndex"><span class="hs-pragma hs-type">getIndex</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-989"></span><span id="local-6989586621679400684"><span id="local-6989586621679400685"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndex"><span class="hs-identifier hs-type">getIndex</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679400685"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679400684"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400684"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400685"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400684"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-990"></span><span id="getIndex"><span class="annot"><span class="annottext">getIndex :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; Int -&gt; m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndex"><span class="hs-identifier hs-var hs-var">getIndex</span></a></span></span><span> </span><span id="local-6989586621679400678"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400678"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621679400677"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400677"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-991"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
MonadIO m =&gt;
ArrayContents -&gt; Ptr a -&gt; (Ptr a -&gt; m b) -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#unsafeWithArrayContents"><span class="hs-identifier hs-var">unsafeWithArrayContents</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrContents"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400678"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400678"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-992"></span><span>        </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679400676"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400676"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; Ptr a -&gt; Int -&gt; m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndexPtr"><span class="hs-identifier hs-var">getIndexPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400676"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400678"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400677"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-993"></span><span>
</span><span id="line-994"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndexPtrRev"><span class="hs-pragma hs-type">getIndexPtrRev</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-995"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndexPtrRev"><span class="hs-identifier hs-type">getIndexPtrRev</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679400674"><span class="annot"><a href="#local-6989586621679400674"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679400673"><span class="annot"><a href="#local-6989586621679400673"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679400674"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679400673"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-996"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679400673"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679400673"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400674"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400673"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-997"></span><span id="getIndexPtrRev"><span class="annot"><span class="annottext">getIndexPtrRev :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; Ptr a -&gt; Int -&gt; m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndexPtrRev"><span class="hs-identifier hs-var hs-var">getIndexPtrRev</span></a></span></span><span> </span><span id="local-6989586621679400665"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400665"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span id="local-6989586621679400664"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400664"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679400663"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400663"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-998"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400659"><span class="annot"><span class="annottext">elemSize :: Int
</span><a href="#local-6989586621679400659"><span class="hs-identifier hs-var hs-var">elemSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679400673"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-999"></span><span>        </span><span id="local-6989586621679400654"><span class="annot"><span class="annottext">elemPtr :: Ptr b
</span><a href="#local-6989586621679400654"><span class="hs-identifier hs-var hs-var">elemPtr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400664"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">negate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400659"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400663"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1000"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400663"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400654"><span class="hs-identifier hs-var">elemPtr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400665"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-1001"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400654"><span class="hs-identifier hs-var">elemPtr</span></a></span><span>
</span><span id="line-1002"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. [Char] -&gt; Int -&gt; a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#invalidIndex"><span class="hs-identifier hs-var">invalidIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;getIndexPtrRev&quot;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400663"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-1003"></span><span>
</span><span id="line-1004"></span><span class="hs-comment">-- | /O(1)/ Lookup the element at the given index from the end of the array.</span><span>
</span><span id="line-1005"></span><span class="hs-comment">-- Index starts from 0.</span><span>
</span><span id="line-1006"></span><span class="hs-comment">--</span><span>
</span><span id="line-1007"></span><span class="hs-comment">-- Slightly faster than computing the forward index and using getIndex.</span><span>
</span><span id="line-1008"></span><span class="hs-comment">--</span><span>
</span><span id="line-1009"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndexRev"><span class="hs-pragma hs-type">getIndexRev</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1010"></span><span id="local-6989586621679400652"><span id="local-6989586621679400653"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndexRev"><span class="hs-identifier hs-type">getIndexRev</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679400653"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679400652"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400652"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400653"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400652"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1011"></span><span id="getIndexRev"><span class="annot"><span class="annottext">getIndexRev :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; Int -&gt; m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndexRev"><span class="hs-identifier hs-var hs-var">getIndexRev</span></a></span></span><span> </span><span id="local-6989586621679400646"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400646"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621679400645"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400645"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1012"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
MonadIO m =&gt;
ArrayContents -&gt; Ptr a -&gt; (Ptr a -&gt; m b) -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#unsafeWithArrayContents"><span class="hs-identifier hs-var">unsafeWithArrayContents</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrContents"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400646"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400646"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1013"></span><span>        </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679400644"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400644"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; Ptr a -&gt; Int -&gt; m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndexPtrRev"><span class="hs-identifier hs-var">getIndexPtrRev</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400644"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400646"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400645"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-1014"></span><span>
</span><span id="line-1015"></span><span class="hs-keyword">data</span><span> </span><span id="GetIndicesState"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GetIndicesState"><span class="hs-identifier hs-var">GetIndicesState</span></a></span></span><span> </span><span id="local-6989586621679401780"><span class="annot"><a href="#local-6989586621679401780"><span class="hs-identifier hs-type">contents</span></a></span></span><span> </span><span id="local-6989586621679401779"><span class="annot"><a href="#local-6989586621679401779"><span class="hs-identifier hs-type">start</span></a></span></span><span> </span><span id="local-6989586621679401778"><span class="annot"><a href="#local-6989586621679401778"><span class="hs-identifier hs-type">end</span></a></span></span><span> </span><span id="local-6989586621679401777"><span class="annot"><a href="#local-6989586621679401777"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1016"></span><span>    </span><span id="GetIndicesState"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GetIndicesState"><span class="hs-identifier hs-var">GetIndicesState</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679401780"><span class="hs-identifier hs-type">contents</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401779"><span class="hs-identifier hs-type">start</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401778"><span class="hs-identifier hs-type">end</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401777"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-1017"></span><span>
</span><span id="line-1018"></span><span class="hs-comment">-- | Given an unfold that generates array indices, read the elements on those</span><span>
</span><span id="line-1019"></span><span class="hs-comment">-- indices from the supplied Array. An error is thrown if an index is out of</span><span>
</span><span id="line-1020"></span><span class="hs-comment">-- bounds.</span><span>
</span><span id="line-1021"></span><span class="hs-comment">--</span><span>
</span><span id="line-1022"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-1023"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndices"><span class="hs-pragma hs-type">getIndices</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1024"></span><span id="local-6989586621679401792"><span id="local-6989586621679401793"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndices"><span class="hs-identifier hs-type">getIndices</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401793"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401792"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1025"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Type.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401793"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401792"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Type.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401793"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401792"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679401792"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1026"></span><span id="getIndices"><span class="annot"><span class="annottext">getIndices :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Unfold m (Array a) Int -&gt; Unfold m (Array a) a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndices"><span class="hs-identifier hs-var hs-var">getIndices</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Type.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span id="local-6989586621679400637"><span class="annot"><span class="annottext">s -&gt; m (Step s Int)
</span><a href="#local-6989586621679400637"><span class="hs-identifier hs-var">stepi</span></a></span></span><span> </span><span id="local-6989586621679400636"><span class="annot"><span class="annottext">Array a -&gt; m s
</span><a href="#local-6989586621679400636"><span class="hs-identifier hs-var">injecti</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b s.
(s -&gt; m (Step s b)) -&gt; (a -&gt; m s) -&gt; Unfold m a b
</span><a href="Streamly.Internal.Data.Unfold.Type.html#Unfold"><span class="hs-identifier hs-var">Unfold</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}.
Storable a =&gt;
GetIndicesState ArrayContents (Ptr a) (Ptr a) s
-&gt; m (Step (GetIndicesState ArrayContents (Ptr a) (Ptr a) s) a)
</span><a href="#local-6989586621679400635"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}.
Array a -&gt; m (GetIndicesState ArrayContents (Ptr a) (Ptr a) s)
</span><a href="#local-6989586621679400634"><span class="hs-identifier hs-var">inject</span></a></span><span>
</span><span id="line-1027"></span><span>
</span><span id="line-1028"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1029"></span><span>
</span><span id="line-1030"></span><span>    </span><span id="local-6989586621679400634"><span class="annot"><span class="annottext">inject :: Array a -&gt; m (GetIndicesState ArrayContents (Ptr a) (Ptr a) s)
</span><a href="#local-6989586621679400634"><span class="hs-identifier hs-var hs-var">inject</span></a></span></span><span> </span><span id="local-6989586621679400631"><span class="annot"><span class="annottext">arr :: Array a
</span><a href="#local-6989586621679400631"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621679400630"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400630"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679400629"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400629"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span id="local-6989586621679400628"><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679400628"><span class="hs-identifier hs-var">end</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1031"></span><span>        </span><span id="local-6989586621679400627"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400627"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Array a -&gt; m s
</span><a href="#local-6989586621679400636"><span class="hs-identifier hs-var">injecti</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400631"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-1032"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall contents start end st.
contents
-&gt; start -&gt; end -&gt; st -&gt; GetIndicesState contents start end st
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GetIndicesState"><span class="hs-identifier hs-var">GetIndicesState</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400630"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400629"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Addr# -&gt; Ptr a
</span><span class="hs-identifier hs-var">Ptr</span></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679400628"><span class="hs-identifier hs-var">end</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400627"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1033"></span><span>
</span><span id="line-1034"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-1035"></span><span>    </span><span id="local-6989586621679400635"><span class="annot"><span class="annottext">step :: GetIndicesState ArrayContents (Ptr a) (Ptr a) s
-&gt; m (Step (GetIndicesState ArrayContents (Ptr a) (Ptr a) s) a)
</span><a href="#local-6989586621679400635"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GetIndicesState"><span class="hs-identifier hs-type">GetIndicesState</span></a></span><span> </span><span id="local-6989586621679400615"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400615"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679400614"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400614"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679400613"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400613"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679400612"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400612"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1036"></span><span>        </span><span id="local-6989586621679400611"><span class="annot"><span class="annottext">Step s Int
</span><a href="#local-6989586621679400611"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Step s Int)
</span><a href="#local-6989586621679400637"><span class="hs-identifier hs-var">stepi</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400612"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1037"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s Int
</span><a href="#local-6989586621679400611"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1038"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Yield"><span class="hs-identifier hs-type">D.Yield</span></a></span><span> </span><span id="local-6989586621679400609"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400609"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679400608"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400608"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1039"></span><span>                </span><span id="local-6989586621679400607"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400607"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; Ptr a -&gt; Int -&gt; m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getIndexPtr"><span class="hs-identifier hs-var">getIndexPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400614"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400613"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400609"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-1040"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Yield"><span class="hs-identifier hs-var">D.Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400607"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall contents start end st.
contents
-&gt; start -&gt; end -&gt; st -&gt; GetIndicesState contents start end st
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GetIndicesState"><span class="hs-identifier hs-var">GetIndicesState</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400615"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400614"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400613"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400608"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1041"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Skip"><span class="hs-identifier hs-type">D.Skip</span></a></span><span> </span><span id="local-6989586621679400605"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400605"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Skip"><span class="hs-identifier hs-var">D.Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall contents start end st.
contents
-&gt; start -&gt; end -&gt; st -&gt; GetIndicesState contents start end st
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GetIndicesState"><span class="hs-identifier hs-var">GetIndicesState</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400615"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400614"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400613"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400605"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1042"></span><span>            </span><span class="annot"><span class="annottext">Step s Int
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Stop"><span class="hs-identifier hs-var">D.Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1043"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400615"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-1044"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Stop"><span class="hs-identifier hs-var">D.Stop</span></a></span><span>
</span><span id="line-1045"></span><span>
</span><span id="line-1046"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1047"></span><span class="hs-comment">-- Subarrays</span><span>
</span><span id="line-1048"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1049"></span><span>
</span><span id="line-1050"></span><span class="hs-comment">-- XXX We can also get immutable slices.</span><span>
</span><span id="line-1051"></span><span>
</span><span id="line-1052"></span><span class="hs-comment">-- | /O(1)/ Slice an array in constant time.</span><span>
</span><span id="line-1053"></span><span class="hs-comment">--</span><span>
</span><span id="line-1054"></span><span class="hs-comment">-- Unsafe: The bounds of the slice are not checked.</span><span>
</span><span id="line-1055"></span><span class="hs-comment">--</span><span>
</span><span id="line-1056"></span><span class="hs-comment">-- /Unsafe/</span><span>
</span><span id="line-1057"></span><span class="hs-comment">--</span><span>
</span><span id="line-1058"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-1059"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getSliceUnsafe"><span class="hs-pragma hs-type">getSliceUnsafe</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1060"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getSliceUnsafe"><span class="hs-identifier hs-type">getSliceUnsafe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401774"><span class="annot"><a href="#local-6989586621679401774"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401774"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1061"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- ^ from index</span><span>
</span><span id="line-1062"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- ^ length of the slice</span><span>
</span><span id="line-1063"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401774"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1064"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401774"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1065"></span><span id="getSliceUnsafe"><span class="annot"><span class="annottext">getSliceUnsafe :: forall a. Storable a =&gt; Int -&gt; Int -&gt; Array a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getSliceUnsafe"><span class="hs-identifier hs-var hs-var">getSliceUnsafe</span></a></span></span><span> </span><span id="local-6989586621679400595"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400595"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span id="local-6989586621679400594"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400594"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621679400593"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400593"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679400592"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400592"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679400591"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400591"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1066"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400587"><span class="annot"><span class="annottext">size :: Int
</span><a href="#local-6989586621679400587"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401774"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1067"></span><span>        </span><span id="local-6989586621679400585"><span class="annot"><span class="annottext">fp1 :: Ptr b
</span><a href="#local-6989586621679400585"><span class="hs-identifier hs-var hs-var">fp1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400592"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400595"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400587"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1068"></span><span>        </span><span id="local-6989586621679400583"><span class="annot"><span class="annottext">end :: Ptr b
</span><a href="#local-6989586621679400583"><span class="hs-identifier hs-var hs-var">end</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400585"><span class="hs-identifier hs-var">fp1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400594"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400587"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1069"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span>
</span><span id="line-1070"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400595"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400594"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400583"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400591"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1071"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; Ptr a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400593"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400585"><span class="hs-identifier hs-var">fp1</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400583"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400583"><span class="hs-identifier hs-var">end</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1072"></span><span>
</span><span id="line-1073"></span><span class="hs-comment">-- | /O(1)/ Slice an array in constant time. Throws an error if the slice</span><span>
</span><span id="line-1074"></span><span class="hs-comment">-- extends out of the array bounds.</span><span>
</span><span id="line-1075"></span><span class="hs-comment">--</span><span>
</span><span id="line-1076"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-1077"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getSlice"><span class="hs-pragma hs-type">getSlice</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1078"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getSlice"><span class="hs-identifier hs-type">getSlice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679400582"><span class="annot"><a href="#local-6989586621679400582"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679400582"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1079"></span><span>       </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- ^ from index</span><span>
</span><span id="line-1080"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- ^ length of the slice</span><span>
</span><span id="line-1081"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400582"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1082"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400582"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1083"></span><span id="getSlice"><span class="annot"><span class="annottext">getSlice :: forall a. Storable a =&gt; Int -&gt; Int -&gt; Array a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#getSlice"><span class="hs-identifier hs-var hs-var">getSlice</span></a></span></span><span> </span><span id="local-6989586621679400571"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400571"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span id="local-6989586621679400570"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400570"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621679400569"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400569"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679400568"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400568"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679400567"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400567"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1084"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400563"><span class="annot"><span class="annottext">size :: Int
</span><a href="#local-6989586621679400563"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679400582"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1085"></span><span>        </span><span id="local-6989586621679400561"><span class="annot"><span class="annottext">fp1 :: Ptr b
</span><a href="#local-6989586621679400561"><span class="hs-identifier hs-var hs-var">fp1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400568"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400571"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400563"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1086"></span><span>        </span><span id="local-6989586621679400559"><span class="annot"><span class="annottext">end :: Ptr b
</span><a href="#local-6989586621679400559"><span class="hs-identifier hs-var hs-var">end</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400561"><span class="hs-identifier hs-var">fp1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400570"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400563"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1087"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400571"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400570"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400559"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400567"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1088"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; Ptr a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400569"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400561"><span class="hs-identifier hs-var">fp1</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400559"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400559"><span class="hs-identifier hs-var">end</span></a></span><span>
</span><span id="line-1089"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span>
</span><span id="line-1090"></span><span>                </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;getSlice: invalid slice, index &quot;</span></span><span>
</span><span id="line-1091"></span><span>                </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400571"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; length &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400570"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-1092"></span><span>
</span><span id="line-1093"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1094"></span><span class="hs-comment">-- In-place mutation algorithms</span><span>
</span><span id="line-1095"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1096"></span><span>
</span><span id="line-1097"></span><span class="hs-comment">-- XXX consider the bulk update/accumulation/permutation APIs from vector.</span><span>
</span><span id="line-1098"></span><span>
</span><span id="line-1099"></span><span class="hs-comment">-- | You may not need to reverse an array because you can consume it in reverse</span><span>
</span><span id="line-1100"></span><span class="hs-comment">-- using 'readRev'. To reverse large arrays you can read in reverse and write</span><span>
</span><span id="line-1101"></span><span class="hs-comment">-- to another array. However, in-place reverse can be useful to take adavantage</span><span>
</span><span id="line-1102"></span><span class="hs-comment">-- of cache locality and when you do not want to allocate additional memory.</span><span>
</span><span id="line-1103"></span><span class="hs-comment">--</span><span>
</span><span id="line-1104"></span><span class="hs-comment">-- /Unimplemented/</span><span>
</span><span id="line-1105"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#reverse"><span class="hs-pragma hs-type">reverse</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1106"></span><span id="local-6989586621679401766"><span id="local-6989586621679401767"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#reverse"><span class="hs-identifier hs-type">reverse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401767"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401766"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span></span><span>
</span><span id="line-1107"></span><span id="reverse"><span class="annot"><span class="annottext">reverse :: forall a (m :: * -&gt; *). Array a -&gt; m Bool
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#reverse"><span class="hs-identifier hs-var hs-var">reverse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-1108"></span><span>
</span><span id="line-1109"></span><span class="hs-comment">-- | Generate the next permutation of the sequence, returns False if this is</span><span>
</span><span id="line-1110"></span><span class="hs-comment">-- the last permutation.</span><span>
</span><span id="line-1111"></span><span class="hs-comment">--</span><span>
</span><span id="line-1112"></span><span class="hs-comment">-- /Unimplemented/</span><span>
</span><span id="line-1113"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#permute"><span class="hs-pragma hs-type">permute</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1114"></span><span id="local-6989586621679400555"><span id="local-6989586621679400556"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#permute"><span class="hs-identifier hs-type">permute</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400556"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400555"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span></span><span>
</span><span id="line-1115"></span><span id="permute"><span class="annot"><span class="annottext">permute :: forall a (m :: * -&gt; *). Array a -&gt; m Bool
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#permute"><span class="hs-identifier hs-var hs-var">permute</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-1116"></span><span>
</span><span id="line-1117"></span><span class="hs-comment">-- | Partition an array into two halves using a partitioning predicate. The</span><span>
</span><span id="line-1118"></span><span class="hs-comment">-- first half retains values where the predicate is 'False' and the second half</span><span>
</span><span id="line-1119"></span><span class="hs-comment">-- retains values where the predicate is 'True'.</span><span>
</span><span id="line-1120"></span><span class="hs-comment">--</span><span>
</span><span id="line-1121"></span><span class="hs-comment">-- /Unimplemented/</span><span>
</span><span id="line-1122"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#partitionBy"><span class="hs-pragma hs-type">partitionBy</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1123"></span><span id="local-6989586621679401764"><span id="local-6989586621679401765"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#partitionBy"><span class="hs-identifier hs-type">partitionBy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679401765"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401765"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401764"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401765"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401765"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1124"></span><span id="partitionBy"><span class="annot"><span class="annottext">partitionBy :: forall a (m :: * -&gt; *).
(a -&gt; Bool) -&gt; Array a -&gt; m (Array a, Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#partitionBy"><span class="hs-identifier hs-var hs-var">partitionBy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-1125"></span><span>
</span><span id="line-1126"></span><span class="hs-comment">-- | Shuffle corresponding elements from two arrays using a shuffle function.</span><span>
</span><span id="line-1127"></span><span class="hs-comment">-- If the shuffle function returns 'False' then do nothing otherwise swap the</span><span>
</span><span id="line-1128"></span><span class="hs-comment">-- elements. This can be used in a bottom up fold to shuffle or reorder the</span><span>
</span><span id="line-1129"></span><span class="hs-comment">-- elements.</span><span>
</span><span id="line-1130"></span><span class="hs-comment">--</span><span>
</span><span id="line-1131"></span><span class="hs-comment">-- /Unimplemented/</span><span>
</span><span id="line-1132"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#shuffleBy"><span class="hs-pragma hs-type">shuffleBy</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1133"></span><span id="local-6989586621679401762"><span id="local-6989586621679401763"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#shuffleBy"><span class="hs-identifier hs-type">shuffleBy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679401763"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401763"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401762"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401763"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401763"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401762"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401763"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1134"></span><span id="shuffleBy"><span class="annot"><span class="annottext">shuffleBy :: forall a (m :: * -&gt; *).
(a -&gt; a -&gt; m Bool) -&gt; Array a -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#shuffleBy"><span class="hs-identifier hs-var hs-var">shuffleBy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-1135"></span><span>
</span><span id="line-1136"></span><span class="hs-comment">-- XXX we can also make the folds partial by stopping at a certain level.</span><span>
</span><span id="line-1137"></span><span class="hs-comment">--</span><span>
</span><span id="line-1138"></span><span class="hs-comment">-- | @divideBy level partition array@  performs a top down hierarchical</span><span>
</span><span id="line-1139"></span><span class="hs-comment">-- recursive partitioning fold of items in the container using the given</span><span>
</span><span id="line-1140"></span><span class="hs-comment">-- function as the partition function.  Level indicates the level in the tree</span><span>
</span><span id="line-1141"></span><span class="hs-comment">-- where the fold would stop.</span><span>
</span><span id="line-1142"></span><span class="hs-comment">--</span><span>
</span><span id="line-1143"></span><span class="hs-comment">-- This performs a quick sort if the partition function is</span><span>
</span><span id="line-1144"></span><span class="hs-comment">-- 'partitionBy (&lt; pivot)'.</span><span>
</span><span id="line-1145"></span><span class="hs-comment">--</span><span>
</span><span id="line-1146"></span><span class="hs-comment">-- /Unimplemented/</span><span>
</span><span id="line-1147"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#divideBy"><span class="hs-pragma hs-type">divideBy</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1148"></span><span id="local-6989586621679401760"><span id="local-6989586621679401761"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#divideBy"><span class="hs-identifier hs-type">divideBy</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1149"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401761"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401761"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401760"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401761"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401761"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401760"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401761"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1150"></span><span id="divideBy"><span class="annot"><span class="annottext">divideBy :: forall a (m :: * -&gt; *).
Int
-&gt; (Array a -&gt; Array a -&gt; m (Array a)) -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#divideBy"><span class="hs-identifier hs-var hs-var">divideBy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-1151"></span><span>
</span><span id="line-1152"></span><span class="hs-comment">-- | @mergeBy level merge array@ performs a pairwise bottom up fold recursively</span><span>
</span><span id="line-1153"></span><span class="hs-comment">-- merging the pairs using the supplied merge function. Level indicates the</span><span>
</span><span id="line-1154"></span><span class="hs-comment">-- level in the tree where the fold would stop.</span><span>
</span><span id="line-1155"></span><span class="hs-comment">--</span><span>
</span><span id="line-1156"></span><span class="hs-comment">-- This performs a random shuffle if the shuffle function is random.  If we</span><span>
</span><span id="line-1157"></span><span class="hs-comment">-- stop at level 0 and repeatedly apply the function then we can do a bubble</span><span>
</span><span id="line-1158"></span><span class="hs-comment">-- sort.</span><span>
</span><span id="line-1159"></span><span class="hs-comment">--</span><span>
</span><span id="line-1160"></span><span class="hs-comment">-- /Unimplemented/</span><span>
</span><span id="line-1161"></span><span id="local-6989586621679400545"><span id="local-6989586621679400546"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#mergeBy"><span class="hs-identifier hs-type">mergeBy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400546"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400546"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400545"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400546"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400546"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679400545"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400546"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1162"></span><span id="mergeBy"><span class="annot"><span class="annottext">mergeBy :: forall a (m :: * -&gt; *).
Int
-&gt; (Array a -&gt; Array a -&gt; m (Array a)) -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#mergeBy"><span class="hs-identifier hs-var hs-var">mergeBy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-1163"></span><span>
</span><span id="line-1164"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1165"></span><span class="hs-comment">-- Size</span><span>
</span><span id="line-1166"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1167"></span><span>
</span><span id="line-1168"></span><span class="hs-comment">-- | /O(1)/ Get the byte length of the array.</span><span>
</span><span id="line-1169"></span><span class="hs-comment">--</span><span>
</span><span id="line-1170"></span><span class="hs-comment">-- @since 0.7.0</span><span>
</span><span id="line-1171"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#byteLength"><span class="hs-pragma hs-type">byteLength</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1172"></span><span id="local-6989586621679401759"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#byteLength"><span class="hs-identifier hs-type">byteLength</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401759"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span></span><span>
</span><span id="line-1173"></span><span id="byteLength"><span class="annot"><span class="annottext">byteLength :: forall a. Array a -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#byteLength"><span class="hs-identifier hs-var hs-var">byteLength</span></a></span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679400535"><span id="local-6989586621679400536"><span id="local-6989586621679400537"><span id="local-6989586621679400538"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679400535"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1174"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400534"><span class="annot"><span class="annottext">len :: Int
</span><a href="#local-6989586621679400534"><span class="hs-identifier hs-var hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400536"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b -&gt; Int
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400537"><span class="hs-identifier hs-var">arrStart</span></a></span><span>
</span><span id="line-1175"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400534"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400534"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-1176"></span><span>
</span><span id="line-1177"></span><span class="hs-comment">-- Note: try to avoid the use of length in performance sensitive internal</span><span>
</span><span id="line-1178"></span><span class="hs-comment">-- routines as it involves a costly 'div' operation. Instead use the end ptr</span><span>
</span><span id="line-1179"></span><span class="hs-comment">-- int he array to check the bounds etc.</span><span>
</span><span id="line-1180"></span><span class="hs-comment">--</span><span>
</span><span id="line-1181"></span><span class="hs-comment">-- | /O(1)/ Get the length of the array i.e. the number of elements in the</span><span>
</span><span id="line-1182"></span><span class="hs-comment">-- array.</span><span>
</span><span id="line-1183"></span><span class="hs-comment">--</span><span>
</span><span id="line-1184"></span><span class="hs-comment">-- Note that 'byteLength' is less expensive than this operation, as 'length'</span><span>
</span><span id="line-1185"></span><span class="hs-comment">-- involves a costly division operation.</span><span>
</span><span id="line-1186"></span><span class="hs-comment">--</span><span>
</span><span id="line-1187"></span><span class="hs-comment">-- @since 0.7.0</span><span>
</span><span id="line-1188"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#length"><span class="hs-pragma hs-type">length</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1189"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#length"><span class="hs-identifier hs-type">length</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401757"><span class="annot"><a href="#local-6989586621679401757"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401757"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401757"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-1190"></span><span id="length"><span class="annot"><span class="annottext">length :: forall a. Storable a =&gt; Array a -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#length"><span class="hs-identifier hs-var hs-var">length</span></a></span></span><span> </span><span id="local-6989586621679400526"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400526"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1191"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400522"><span class="annot"><span class="annottext">elemSize :: Int
</span><a href="#local-6989586621679400522"><span class="hs-identifier hs-var hs-var">elemSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401757"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1192"></span><span>        </span><span id="local-6989586621679400521"><span class="annot"><span class="annottext">blen :: Int
</span><a href="#local-6989586621679400521"><span class="hs-identifier hs-var hs-var">blen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#byteLength"><span class="hs-identifier hs-var">byteLength</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400526"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-1193"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400521"><span class="hs-identifier hs-var">blen</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`mod`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400522"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400521"><span class="hs-identifier hs-var">blen</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400522"><span class="hs-identifier hs-var">elemSize</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1194"></span><span>
</span><span id="line-1195"></span><span class="hs-comment">-- | Get the total capacity of an array. An array may have space reserved</span><span>
</span><span id="line-1196"></span><span class="hs-comment">-- beyond the current used length of the array.</span><span>
</span><span id="line-1197"></span><span class="hs-comment">--</span><span>
</span><span id="line-1198"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-1199"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#byteCapacity"><span class="hs-pragma hs-type">byteCapacity</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1200"></span><span id="local-6989586621679400520"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#byteCapacity"><span class="hs-identifier hs-type">byteCapacity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400520"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span></span><span>
</span><span id="line-1201"></span><span id="byteCapacity"><span class="annot"><span class="annottext">byteCapacity :: forall a. Array a -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#byteCapacity"><span class="hs-identifier hs-var hs-var">byteCapacity</span></a></span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679400512"><span id="local-6989586621679400513"><span id="local-6989586621679400514"><span id="local-6989586621679400515"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679400512"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1202"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400511"><span class="annot"><span class="annottext">len :: Int
</span><a href="#local-6989586621679400511"><span class="hs-identifier hs-var hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400512"><span class="hs-identifier hs-var">aBound</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b -&gt; Int
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400514"><span class="hs-identifier hs-var">arrStart</span></a></span><span>
</span><span id="line-1203"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400511"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400511"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-1204"></span><span>
</span><span id="line-1205"></span><span class="hs-comment">-- | The remaining capacity in the array for appending more elements without</span><span>
</span><span id="line-1206"></span><span class="hs-comment">-- reallocation.</span><span>
</span><span id="line-1207"></span><span class="hs-comment">--</span><span>
</span><span id="line-1208"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-1209"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#bytesFree"><span class="hs-pragma hs-type">bytesFree</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1210"></span><span id="local-6989586621679400510"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#bytesFree"><span class="hs-identifier hs-type">bytesFree</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400510"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span></span><span>
</span><span id="line-1211"></span><span id="bytesFree"><span class="annot"><span class="annottext">bytesFree :: forall a. Array a -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#bytesFree"><span class="hs-identifier hs-var hs-var">bytesFree</span></a></span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679400502"><span id="local-6989586621679400503"><span id="local-6989586621679400504"><span id="local-6989586621679400505"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679400502"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1212"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400501"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621679400501"><span class="hs-identifier hs-var hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400502"><span class="hs-identifier hs-var">aBound</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b -&gt; Int
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400503"><span class="hs-identifier hs-var">aEnd</span></a></span><span>
</span><span id="line-1213"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400501"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400501"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1214"></span><span>
</span><span id="line-1215"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1216"></span><span class="hs-comment">-- Streams of arrays - Creation</span><span>
</span><span id="line-1217"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1218"></span><span>
</span><span id="line-1219"></span><span class="hs-keyword">data</span><span> </span><span id="GroupState"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GroupState"><span class="hs-identifier hs-var">GroupState</span></a></span></span><span> </span><span id="local-6989586621679401739"><span class="annot"><a href="#local-6989586621679401739"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679401738"><span class="annot"><a href="#local-6989586621679401738"><span class="hs-identifier hs-type">contents</span></a></span></span><span> </span><span id="local-6989586621679401737"><span class="annot"><a href="#local-6989586621679401737"><span class="hs-identifier hs-type">start</span></a></span></span><span> </span><span id="local-6989586621679401736"><span class="annot"><a href="#local-6989586621679401736"><span class="hs-identifier hs-type">end</span></a></span></span><span> </span><span id="local-6989586621679401735"><span class="annot"><a href="#local-6989586621679401735"><span class="hs-identifier hs-type">bound</span></a></span></span><span>
</span><span id="line-1220"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="GroupStart"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GroupStart"><span class="hs-identifier hs-var">GroupStart</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679401739"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-1221"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="GroupBuffer"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GroupBuffer"><span class="hs-identifier hs-var">GroupBuffer</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679401739"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401738"><span class="hs-identifier hs-type">contents</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401737"><span class="hs-identifier hs-type">start</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401736"><span class="hs-identifier hs-type">end</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401735"><span class="hs-identifier hs-type">bound</span></a></span><span>
</span><span id="line-1222"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="GroupYield"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GroupYield"><span class="hs-identifier hs-var">GroupYield</span></a></span></span><span>
</span><span id="line-1223"></span><span>        </span><span class="annot"><a href="#local-6989586621679401738"><span class="hs-identifier hs-type">contents</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401737"><span class="hs-identifier hs-type">start</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401736"><span class="hs-identifier hs-type">end</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401735"><span class="hs-identifier hs-type">bound</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GroupState"><span class="hs-identifier hs-type">GroupState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401739"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401738"><span class="hs-identifier hs-type">contents</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401737"><span class="hs-identifier hs-type">start</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401736"><span class="hs-identifier hs-type">end</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401735"><span class="hs-identifier hs-type">bound</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1224"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="GroupFinish"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GroupFinish"><span class="hs-identifier hs-var">GroupFinish</span></a></span></span><span>
</span><span id="line-1225"></span><span>
</span><span id="line-1226"></span><span class="hs-comment">-- | @arraysOf n stream@ groups the input stream into a stream of</span><span>
</span><span id="line-1227"></span><span class="hs-comment">-- arrays of size n.</span><span>
</span><span id="line-1228"></span><span class="hs-comment">--</span><span>
</span><span id="line-1229"></span><span class="hs-comment">-- @arraysOf n = StreamD.foldMany (Array.writeN n)@</span><span>
</span><span id="line-1230"></span><span class="hs-comment">--</span><span>
</span><span id="line-1231"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-1232"></span><span class="hs-pragma">{-# INLINE_NORMAL arraysOf #-}</span><span>
</span><span id="line-1233"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arraysOf"><span class="hs-identifier hs-type">arraysOf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401753"><span class="annot"><a href="#local-6989586621679401753"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401752"><span class="annot"><a href="#local-6989586621679401752"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401753"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401752"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1234"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">D.Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401753"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401752"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">D.Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401753"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401752"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1235"></span><span class="hs-comment">-- XXX the idiomatic implementation leads to large regression in the D.reverse'</span><span>
</span><span id="line-1236"></span><span class="hs-comment">-- benchmark. It seems it has difficulty producing optimized code when</span><span>
</span><span id="line-1237"></span><span class="hs-comment">-- converting to StreamK. Investigate GHC optimizations.</span><span>
</span><span id="line-1238"></span><span class="hs-comment">-- arraysOf n = D.foldMany (writeN n)</span><span>
</span><span id="line-1239"></span><span id="arraysOf"><span class="annot"><span class="annottext">arraysOf :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Stream m a -&gt; Stream m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arraysOf"><span class="hs-identifier hs-var hs-var">arraysOf</span></a></span></span><span> </span><span id="local-6989586621679400491"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400491"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">D.Stream</span></a></span><span> </span><span id="local-6989586621679400489"><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679400489"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679400488"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400488"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1240"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">D.Stream</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a}.
State Stream m a
-&gt; GroupState s ArrayContents (Ptr a) (Ptr a) (Ptr a)
-&gt; m (Step
        (GroupState s ArrayContents (Ptr a) (Ptr a) (Ptr a)) (Array a))
</span><a href="#local-6989586621679400487"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s contents start end bound.
s -&gt; GroupState s contents start end bound
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GroupStart"><span class="hs-identifier hs-var">GroupStart</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400488"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1241"></span><span>
</span><span id="line-1242"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1243"></span><span>
</span><span id="line-1244"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-1245"></span><span>    </span><span id="local-6989586621679400487"><span class="annot"><span class="annottext">step' :: State Stream m a
-&gt; GroupState s ArrayContents (Ptr a) (Ptr a) (Ptr a)
-&gt; m (Step
        (GroupState s ArrayContents (Ptr a) (Ptr a) (Ptr a)) (Array a))
</span><a href="#local-6989586621679400487"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GroupStart"><span class="hs-identifier hs-type">GroupStart</span></a></span><span> </span><span id="local-6989586621679400463"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400463"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1246"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400491"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1247"></span><span>            </span><span class="hs-comment">-- XXX we can pass the module string from the higher level API</span><span>
</span><span id="line-1248"></span><span>            </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Streamly.Internal.Data.Array.Foreign.Mut.Type.arraysOf: &quot;</span></span><span>
</span><span id="line-1249"></span><span>                    </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;the size of arrays [&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400491"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1250"></span><span>                    </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;] must be a natural number&quot;</span></span><span>
</span><span id="line-1251"></span><span>        </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621679400462"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400462"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679400461"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400461"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679400460"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400460"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679400459"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400459"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArray"><span class="hs-identifier hs-var">newArray</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400491"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1252"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Skip"><span class="hs-identifier hs-var">D.Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s contents start end bound.
s
-&gt; contents
-&gt; start
-&gt; end
-&gt; bound
-&gt; GroupState s contents start end bound
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GroupBuffer"><span class="hs-identifier hs-var">GroupBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400463"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400462"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400461"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400460"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400459"><span class="hs-identifier hs-var">bound</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1253"></span><span>
</span><span id="line-1254"></span><span>    </span><span class="annot"><a href="#local-6989586621679400487"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span id="local-6989586621679400458"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679400458"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GroupBuffer"><span class="hs-identifier hs-type">GroupBuffer</span></a></span><span> </span><span id="local-6989586621679400457"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400457"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679400456"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400456"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679400455"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400455"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679400454"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400454"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679400453"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400453"><span class="hs-identifier hs-var">bound</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1255"></span><span>        </span><span id="local-6989586621679400452"><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679400452"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m a -&gt; s -&gt; m (Step s a)
</span><a href="#local-6989586621679400489"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679400458"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400457"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1256"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s a
</span><a href="#local-6989586621679400452"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1257"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Yield"><span class="hs-identifier hs-type">D.Yield</span></a></span><span> </span><span id="local-6989586621679400451"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400451"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679400450"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400450"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1258"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">poke</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400454"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400451"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400456"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-1259"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400446"><span class="annot"><span class="annottext">end' :: Ptr b
</span><a href="#local-6989586621679400446"><span class="hs-identifier hs-var hs-var">end'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400454"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401752"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1260"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1261"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400446"><span class="hs-identifier hs-var">end'</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400453"><span class="hs-identifier hs-var">bound</span></a></span><span>
</span><span id="line-1262"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Skip"><span class="hs-identifier hs-var">D.Skip</span></a></span><span>
</span><span id="line-1263"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s contents start end bound.
contents
-&gt; start
-&gt; end
-&gt; bound
-&gt; GroupState s contents start end bound
-&gt; GroupState s contents start end bound
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GroupYield"><span class="hs-identifier hs-var">GroupYield</span></a></span><span>
</span><span id="line-1264"></span><span>                                </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400456"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400455"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400446"><span class="hs-identifier hs-var">end'</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400453"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s contents start end bound.
s -&gt; GroupState s contents start end bound
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GroupStart"><span class="hs-identifier hs-var">GroupStart</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400450"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1265"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Skip"><span class="hs-identifier hs-var">D.Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s contents start end bound.
s
-&gt; contents
-&gt; start
-&gt; end
-&gt; bound
-&gt; GroupState s contents start end bound
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GroupBuffer"><span class="hs-identifier hs-var">GroupBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400450"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400456"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400455"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400446"><span class="hs-identifier hs-var">end'</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400453"><span class="hs-identifier hs-var">bound</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1266"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Skip"><span class="hs-identifier hs-type">D.Skip</span></a></span><span> </span><span id="local-6989586621679400445"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400445"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1267"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Skip"><span class="hs-identifier hs-var">D.Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s contents start end bound.
s
-&gt; contents
-&gt; start
-&gt; end
-&gt; bound
-&gt; GroupState s contents start end bound
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GroupBuffer"><span class="hs-identifier hs-var">GroupBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400445"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400456"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400455"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400454"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400453"><span class="hs-identifier hs-var">bound</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1268"></span><span>            </span><span class="annot"><span class="annottext">Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Stop"><span class="hs-identifier hs-var">D.Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1269"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-1270"></span><span>                    </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Skip"><span class="hs-identifier hs-var">D.Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s contents start end bound.
contents
-&gt; start
-&gt; end
-&gt; bound
-&gt; GroupState s contents start end bound
-&gt; GroupState s contents start end bound
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GroupYield"><span class="hs-identifier hs-var">GroupYield</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400456"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400455"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400454"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400453"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="annot"><span class="annottext">forall s contents start end bound.
GroupState s contents start end bound
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GroupFinish"><span class="hs-identifier hs-var">GroupFinish</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1271"></span><span>
</span><span id="line-1272"></span><span>    </span><span class="annot"><a href="#local-6989586621679400487"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GroupYield"><span class="hs-identifier hs-type">GroupYield</span></a></span><span> </span><span id="local-6989586621679400444"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400444"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679400443"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400443"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679400442"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400442"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679400441"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400441"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span id="local-6989586621679400440"><span class="annot"><span class="annottext">GroupState s ArrayContents (Ptr a) (Ptr a) (Ptr a)
</span><a href="#local-6989586621679400440"><span class="hs-identifier hs-var">next</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1273"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Yield"><span class="hs-identifier hs-var">D.Yield</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; Ptr a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400444"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400443"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400442"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400441"><span class="hs-identifier hs-var">bound</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">GroupState s ArrayContents (Ptr a) (Ptr a) (Ptr a)
</span><a href="#local-6989586621679400440"><span class="hs-identifier hs-var">next</span></a></span><span>
</span><span id="line-1274"></span><span>
</span><span id="line-1275"></span><span>    </span><span class="annot"><a href="#local-6989586621679400487"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">GroupState s ArrayContents (Ptr a) (Ptr a) (Ptr a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#GroupFinish"><span class="hs-identifier hs-var">GroupFinish</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Stop"><span class="hs-identifier hs-var">D.Stop</span></a></span><span>
</span><span id="line-1276"></span><span>
</span><span id="line-1277"></span><span class="hs-comment">-- XXX buffer to a list instead?</span><span>
</span><span id="line-1278"></span><span class="hs-comment">-- | Buffer the stream into arrays in memory.</span><span>
</span><span id="line-1279"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrayStreamKFromStreamD"><span class="hs-pragma hs-type">arrayStreamKFromStreamD</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1280"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrayStreamKFromStreamD"><span class="hs-identifier hs-type">arrayStreamKFromStreamD</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401727"><span class="annot"><a href="#local-6989586621679401727"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401726"><span class="annot"><a href="#local-6989586621679401726"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401727"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401726"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1281"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">D.Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401727"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401726"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401727"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">K.Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401727"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401726"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1282"></span><span id="arrayStreamKFromStreamD"><span class="annot"><span class="annottext">arrayStreamKFromStreamD :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Stream m a -&gt; m (Stream m (Array a))
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrayStreamKFromStreamD"><span class="hs-identifier hs-var hs-var">arrayStreamKFromStreamD</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1283"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400430"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621679400430"><span class="hs-identifier hs-var hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#allocBytesToElemCount"><span class="hs-identifier hs-var">allocBytesToElemCount</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401726"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Streamly.Internal.System.IO.html#defaultChunkSize"><span class="hs-identifier hs-var">defaultChunkSize</span></a></span><span>
</span><span id="line-1284"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldr"><span class="hs-identifier hs-var">D.foldr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *). a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#cons"><span class="hs-identifier hs-var">K.cons</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-identifier hs-var">K.nil</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Stream m a -&gt; Stream m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arraysOf"><span class="hs-identifier hs-var">arraysOf</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400430"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1285"></span><span>
</span><span id="line-1286"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1287"></span><span class="hs-comment">-- Streams of arrays - Flattening</span><span>
</span><span id="line-1288"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1289"></span><span>
</span><span id="line-1290"></span><span class="hs-keyword">data</span><span> </span><span id="FlattenState"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#FlattenState"><span class="hs-identifier hs-var">FlattenState</span></a></span></span><span> </span><span id="local-6989586621679401705"><span class="annot"><a href="#local-6989586621679401705"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679401704"><span class="annot"><a href="#local-6989586621679401704"><span class="hs-identifier hs-type">contents</span></a></span></span><span> </span><span id="local-6989586621679401703"><span class="annot"><a href="#local-6989586621679401703"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1291"></span><span>      </span><span id="OuterLoop"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#OuterLoop"><span class="hs-identifier hs-var">OuterLoop</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679401705"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-1292"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="InnerLoop"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#InnerLoop"><span class="hs-identifier hs-var">InnerLoop</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679401705"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401704"><span class="hs-identifier hs-type">contents</span></a></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401703"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401703"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1293"></span><span>
</span><span id="line-1294"></span><span class="hs-comment">-- | Use the &quot;read&quot; unfold instead.</span><span>
</span><span id="line-1295"></span><span class="hs-comment">--</span><span>
</span><span id="line-1296"></span><span class="hs-comment">-- @flattenArrays = unfoldMany read@</span><span>
</span><span id="line-1297"></span><span class="hs-comment">--</span><span>
</span><span id="line-1298"></span><span class="hs-comment">-- We can try this if there are any fusion issues in the unfold.</span><span>
</span><span id="line-1299"></span><span class="hs-comment">--</span><span>
</span><span id="line-1300"></span><span class="hs-pragma">{-# INLINE_NORMAL flattenArrays #-}</span><span>
</span><span id="line-1301"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#flattenArrays"><span class="hs-identifier hs-type">flattenArrays</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401713"><span class="annot"><a href="#local-6989586621679401713"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401712"><span class="annot"><a href="#local-6989586621679401712"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401713"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401712"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1302"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">D.Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401713"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401712"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">D.Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401713"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401712"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1303"></span><span id="flattenArrays"><span class="annot"><span class="annottext">flattenArrays :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Stream m (Array a) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#flattenArrays"><span class="hs-identifier hs-var hs-var">flattenArrays</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">D.Stream</span></a></span><span> </span><span id="local-6989586621679400420"><span class="annot"><span class="annottext">State Stream m (Array a) -&gt; s -&gt; m (Step s (Array a))
</span><a href="#local-6989586621679400420"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679400419"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400419"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">D.Stream</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a}.
State Stream m a
-&gt; FlattenState s ArrayContents a
-&gt; m (Step (FlattenState s ArrayContents a) a)
</span><a href="#local-6989586621679400418"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s contents a. s -&gt; FlattenState s contents a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#OuterLoop"><span class="hs-identifier hs-var">OuterLoop</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400419"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1304"></span><span>
</span><span id="line-1305"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1306"></span><span>
</span><span id="line-1307"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-1308"></span><span>    </span><span id="local-6989586621679400418"><span class="annot"><span class="annottext">step' :: State Stream m a
-&gt; FlattenState s ArrayContents a
-&gt; m (Step (FlattenState s ArrayContents a) a)
</span><a href="#local-6989586621679400418"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679400399"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679400399"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#OuterLoop"><span class="hs-identifier hs-type">OuterLoop</span></a></span><span> </span><span id="local-6989586621679400398"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400398"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1309"></span><span>        </span><span id="local-6989586621679400397"><span class="annot"><span class="annottext">Step s (Array a)
</span><a href="#local-6989586621679400397"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m (Array a) -&gt; s -&gt; m (Step s (Array a))
</span><a href="#local-6989586621679400420"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679400399"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400398"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1310"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s (Array a)
</span><a href="#local-6989586621679400397"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1311"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Yield"><span class="hs-identifier hs-type">D.Yield</span></a></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679400393"><span id="local-6989586621679400394"><span id="local-6989586621679400395"><span id="local-6989586621679400396"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679400393"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679400392"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400392"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1312"></span><span>                </span><span class="annot"><span class="annottext">forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Skip"><span class="hs-identifier hs-var">D.Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s contents a.
s -&gt; contents -&gt; Ptr a -&gt; Ptr a -&gt; FlattenState s contents a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#InnerLoop"><span class="hs-identifier hs-var">InnerLoop</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400392"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400396"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400395"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400394"><span class="hs-identifier hs-var">aEnd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1313"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Skip"><span class="hs-identifier hs-type">D.Skip</span></a></span><span> </span><span id="local-6989586621679400391"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400391"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Skip"><span class="hs-identifier hs-var">D.Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s contents a. s -&gt; FlattenState s contents a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#OuterLoop"><span class="hs-identifier hs-var">OuterLoop</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400391"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1314"></span><span>            </span><span class="annot"><span class="annottext">Step s (Array a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Stop"><span class="hs-identifier hs-var">D.Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Stop"><span class="hs-identifier hs-var">D.Stop</span></a></span><span>
</span><span id="line-1315"></span><span>
</span><span id="line-1316"></span><span>    </span><span class="annot"><a href="#local-6989586621679400418"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#InnerLoop"><span class="hs-identifier hs-type">InnerLoop</span></a></span><span> </span><span id="local-6989586621679400390"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400390"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679400389"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400389"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679400388"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400388"><span class="hs-identifier hs-var">end</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400389"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400388"><span class="hs-identifier hs-var">end</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400389"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400388"><span class="hs-identifier hs-var">end</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1317"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Skip"><span class="hs-identifier hs-var">D.Skip</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s contents a. s -&gt; FlattenState s contents a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#OuterLoop"><span class="hs-identifier hs-var">OuterLoop</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400390"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1318"></span><span>
</span><span id="line-1319"></span><span>    </span><span class="annot"><a href="#local-6989586621679400418"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#InnerLoop"><span class="hs-identifier hs-type">InnerLoop</span></a></span><span> </span><span id="local-6989586621679400387"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400387"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679400386"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400386"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679400385"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400385"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679400384"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400384"><span class="hs-identifier hs-var">end</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1320"></span><span>        </span><span id="local-6989586621679400383"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400383"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1321"></span><span>                    </span><span id="local-6989586621679400382"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400382"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400385"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1322"></span><span>                    </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400386"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-1323"></span><span>                    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400382"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1324"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Yield"><span class="hs-identifier hs-var">D.Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400383"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s contents a.
s -&gt; contents -&gt; Ptr a -&gt; Ptr a -&gt; FlattenState s contents a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#InnerLoop"><span class="hs-identifier hs-var">InnerLoop</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400387"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400386"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-1325"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400385"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401712"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400384"><span class="hs-identifier hs-var">end</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1326"></span><span>
</span><span id="line-1327"></span><span class="hs-comment">-- | Use the &quot;readRev&quot; unfold instead.</span><span>
</span><span id="line-1328"></span><span class="hs-comment">--</span><span>
</span><span id="line-1329"></span><span class="hs-comment">-- @flattenArrays = unfoldMany readRev@</span><span>
</span><span id="line-1330"></span><span class="hs-comment">--</span><span>
</span><span id="line-1331"></span><span class="hs-comment">-- We can try this if there are any fusion issues in the unfold.</span><span>
</span><span id="line-1332"></span><span class="hs-comment">--</span><span>
</span><span id="line-1333"></span><span class="hs-pragma">{-# INLINE_NORMAL flattenArraysRev #-}</span><span>
</span><span id="line-1334"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#flattenArraysRev"><span class="hs-identifier hs-type">flattenArraysRev</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679400381"><span class="annot"><a href="#local-6989586621679400381"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679400380"><span class="annot"><a href="#local-6989586621679400380"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679400381"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679400380"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1335"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">D.Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400381"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400380"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">D.Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400381"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400380"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1336"></span><span id="flattenArraysRev"><span class="annot"><span class="annottext">flattenArraysRev :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Stream m (Array a) -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#flattenArraysRev"><span class="hs-identifier hs-var hs-var">flattenArraysRev</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">D.Stream</span></a></span><span> </span><span id="local-6989586621679400376"><span class="annot"><span class="annottext">State Stream m (Array a) -&gt; s -&gt; m (Step s (Array a))
</span><a href="#local-6989586621679400376"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679400375"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400375"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">D.Stream</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a}.
State Stream m a
-&gt; FlattenState s ArrayContents a
-&gt; m (Step (FlattenState s ArrayContents a) a)
</span><a href="#local-6989586621679400374"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s contents a. s -&gt; FlattenState s contents a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#OuterLoop"><span class="hs-identifier hs-var">OuterLoop</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400375"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1337"></span><span>
</span><span id="line-1338"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1339"></span><span>
</span><span id="line-1340"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step' #-}</span><span>
</span><span id="line-1341"></span><span>    </span><span id="local-6989586621679400374"><span class="annot"><span class="annottext">step' :: State Stream m a
-&gt; FlattenState s ArrayContents a
-&gt; m (Step (FlattenState s ArrayContents a) a)
</span><a href="#local-6989586621679400374"><span class="hs-identifier hs-var hs-var">step'</span></a></span></span><span> </span><span id="local-6989586621679400362"><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679400362"><span class="hs-identifier hs-var">gst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#OuterLoop"><span class="hs-identifier hs-type">OuterLoop</span></a></span><span> </span><span id="local-6989586621679400361"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400361"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1342"></span><span>        </span><span id="local-6989586621679400360"><span class="annot"><span class="annottext">Step s (Array a)
</span><a href="#local-6989586621679400360"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State Stream m (Array a) -&gt; s -&gt; m (Step s (Array a))
</span><a href="#local-6989586621679400376"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a (n :: * -&gt; *) b.
State t m a -&gt; State t n b
</span><a href="Streamly.Internal.Data.SVar.Type.html#adaptState"><span class="hs-identifier hs-var">adaptState</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><a href="#local-6989586621679400362"><span class="hs-identifier hs-var">gst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400361"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1343"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Step s (Array a)
</span><a href="#local-6989586621679400360"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1344"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Yield"><span class="hs-identifier hs-type">D.Yield</span></a></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679400356"><span id="local-6989586621679400357"><span id="local-6989586621679400358"><span id="local-6989586621679400359"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679400356"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679400355"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400355"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1345"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400350"><span class="annot"><span class="annottext">p :: Ptr b
</span><a href="#local-6989586621679400350"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400357"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">negate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679400380"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1346"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Skip"><span class="hs-identifier hs-var">D.Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s contents a.
s -&gt; contents -&gt; Ptr a -&gt; Ptr a -&gt; FlattenState s contents a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#InnerLoop"><span class="hs-identifier hs-var">InnerLoop</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400355"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400359"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400350"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400358"><span class="hs-identifier hs-var">arrStart</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1347"></span><span>            </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Skip"><span class="hs-identifier hs-type">D.Skip</span></a></span><span> </span><span id="local-6989586621679400349"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400349"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Skip"><span class="hs-identifier hs-var">D.Skip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s contents a. s -&gt; FlattenState s contents a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#OuterLoop"><span class="hs-identifier hs-var">OuterLoop</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400349"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1348"></span><span>            </span><span class="annot"><span class="annottext">Step s (Array a)
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Stop"><span class="hs-identifier hs-var">D.Stop</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Stop"><span class="hs-identifier hs-var">D.Stop</span></a></span><span>
</span><span id="line-1349"></span><span>
</span><span id="line-1350"></span><span>    </span><span class="annot"><a href="#local-6989586621679400374"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#InnerLoop"><span class="hs-identifier hs-type">InnerLoop</span></a></span><span> </span><span id="local-6989586621679400348"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400348"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679400347"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400347"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679400346"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400346"><span class="hs-identifier hs-var">start</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400347"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400346"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1351"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Skip"><span class="hs-identifier hs-var">D.Skip</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s contents a. s -&gt; FlattenState s contents a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#OuterLoop"><span class="hs-identifier hs-var">OuterLoop</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400348"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-1352"></span><span>
</span><span id="line-1353"></span><span>    </span><span class="annot"><a href="#local-6989586621679400374"><span class="hs-identifier hs-var">step'</span></a></span><span> </span><span class="annot"><span class="annottext">State Stream m a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#InnerLoop"><span class="hs-identifier hs-type">InnerLoop</span></a></span><span> </span><span id="local-6989586621679400345"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400345"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679400344"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400344"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679400343"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400343"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679400342"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400342"><span class="hs-identifier hs-var">start</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1354"></span><span>        </span><span id="local-6989586621679400341"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400341"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1355"></span><span>                    </span><span id="local-6989586621679400340"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400340"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400343"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1356"></span><span>                    </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400344"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-1357"></span><span>                    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400340"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1358"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400335"><span class="annot"><span class="annottext">cur :: Ptr b
</span><a href="#local-6989586621679400335"><span class="hs-identifier hs-var hs-var">cur</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400343"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">negate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679400380"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1359"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Yield"><span class="hs-identifier hs-var">D.Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400341"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s contents a.
s -&gt; contents -&gt; Ptr a -&gt; Ptr a -&gt; FlattenState s contents a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#InnerLoop"><span class="hs-identifier hs-var">InnerLoop</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679400345"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400344"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400335"><span class="hs-identifier hs-var">cur</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400342"><span class="hs-identifier hs-var">start</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1360"></span><span>
</span><span id="line-1361"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1362"></span><span class="hs-comment">-- Unfolds</span><span>
</span><span id="line-1363"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1364"></span><span>
</span><span id="line-1365"></span><span class="hs-keyword">data</span><span> </span><span id="ReadUState"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-var">ReadUState</span></a></span></span><span> </span><span id="local-6989586621679401691"><span class="annot"><a href="#local-6989586621679401691"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ReadUState"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-var">ReadUState</span></a></span></span><span>
</span><span id="line-1366"></span><span>    </span><span class="hs-identifier">UNPACKIF</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">ArrayContents</span><span>  </span><span class="hs-comment">-- contents</span><span>
</span><span id="line-1367"></span><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401691"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- end address</span><span>
</span><span id="line-1368"></span><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401691"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- current address</span><span>
</span><span id="line-1369"></span><span>
</span><span id="line-1370"></span><span id="local-6989586621679401694"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toReadUState"><span class="hs-identifier hs-type">toReadUState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401694"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-type">ReadUState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401694"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-1371"></span><span id="toReadUState"><span class="annot"><span class="annottext">toReadUState :: forall a. Array a -&gt; ReadUState a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toReadUState"><span class="hs-identifier hs-var hs-var">toReadUState</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621679400332"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400332"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679400331"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400331"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679400330"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400330"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; ReadUState a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-var">ReadUState</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400332"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400330"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400331"><span class="hs-identifier hs-var">start</span></a></span><span>
</span><span id="line-1372"></span><span>
</span><span id="line-1373"></span><span class="hs-comment">-- | Resumable unfold of an array.</span><span>
</span><span id="line-1374"></span><span class="hs-comment">--</span><span>
</span><span id="line-1375"></span><span class="hs-pragma">{-# INLINE_NORMAL producer #-}</span><span>
</span><span id="line-1376"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#producer"><span class="hs-identifier hs-type">producer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401690"><span class="annot"><a href="#local-6989586621679401690"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401689"><span class="annot"><a href="#local-6989586621679401689"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401690"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401689"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Producer.Type.html#Producer"><span class="hs-identifier hs-type">Producer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401690"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401689"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679401689"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1377"></span><span id="producer"><span class="annot"><span class="annottext">producer :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Producer m (Array a) a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#producer"><span class="hs-identifier hs-var hs-var">producer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b s.
(s -&gt; m (Step s b)) -&gt; (a -&gt; m s) -&gt; (s -&gt; m a) -&gt; Producer m a b
</span><a href="Streamly.Internal.Data.Producer.Type.html#Producer"><span class="hs-identifier hs-var">Producer</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a}.
(MonadIO m, Storable a) =&gt;
ReadUState a -&gt; m (Step (ReadUState a) a)
</span><a href="#local-6989586621679400321"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; ReadUState a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toReadUState"><span class="hs-identifier hs-var">toReadUState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a}. Monad m =&gt; ReadUState a -&gt; m (Array a)
</span><a href="#local-6989586621679400320"><span class="hs-identifier hs-var">extract</span></a></span><span>
</span><span id="line-1378"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1379"></span><span>
</span><span id="line-1380"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-1381"></span><span>    </span><span id="local-6989586621679400321"><span class="annot"><span class="annottext">step :: ReadUState a -&gt; m (Step (ReadUState a) a)
</span><a href="#local-6989586621679400321"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-type">ReadUState</span></a></span><span> </span><span id="local-6989586621679400305"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400305"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679400304"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400304"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679400303"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400303"><span class="hs-identifier hs-var">cur</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1382"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400303"><span class="hs-identifier hs-var">cur</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400304"><span class="hs-identifier hs-var">end</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400303"><span class="hs-identifier hs-var">cur</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400304"><span class="hs-identifier hs-var">end</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1383"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400305"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-1384"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Stop"><span class="hs-identifier hs-var">D.Stop</span></a></span><span>
</span><span id="line-1385"></span><span>    </span><span class="annot"><a href="#local-6989586621679400321"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-type">ReadUState</span></a></span><span> </span><span id="local-6989586621679400302"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400302"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679400301"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400301"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679400300"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400300"><span class="hs-identifier hs-var">cur</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1386"></span><span>            </span><span class="hs-glyph">!</span><span id="local-6989586621679400299"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400299"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400300"><span class="hs-identifier hs-var">cur</span></a></span><span>
</span><span id="line-1387"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400295"><span class="annot"><span class="annottext">cur1 :: Ptr b
</span><a href="#local-6989586621679400295"><span class="hs-identifier hs-var hs-var">cur1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400300"><span class="hs-identifier hs-var">cur</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401689"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1388"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Yield"><span class="hs-identifier hs-var">D.Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400299"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; ReadUState a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-var">ReadUState</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400302"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400301"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400295"><span class="hs-identifier hs-var">cur1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1389"></span><span>
</span><span id="line-1390"></span><span>    </span><span id="local-6989586621679400320"><span class="annot"><span class="annottext">extract :: ReadUState a -&gt; m (Array a)
</span><a href="#local-6989586621679400320"><span class="hs-identifier hs-var hs-var">extract</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-type">ReadUState</span></a></span><span> </span><span id="local-6989586621679400292"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400292"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679400291"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400291"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679400290"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400290"><span class="hs-identifier hs-var">cur</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; Ptr a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400292"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400290"><span class="hs-identifier hs-var">cur</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400291"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400291"><span class="hs-identifier hs-var">end</span></a></span><span>
</span><span id="line-1391"></span><span>
</span><span id="line-1392"></span><span class="hs-comment">-- | Unfold an array into a stream.</span><span>
</span><span id="line-1393"></span><span class="hs-comment">--</span><span>
</span><span id="line-1394"></span><span class="hs-comment">-- @since 0.7.0</span><span>
</span><span id="line-1395"></span><span class="hs-pragma">{-# INLINE_NORMAL read #-}</span><span>
</span><span id="line-1396"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#read"><span class="hs-identifier hs-type">read</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401676"><span class="annot"><a href="#local-6989586621679401676"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401675"><span class="annot"><a href="#local-6989586621679401675"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401676"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401675"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Type.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401676"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401675"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679401675"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1397"></span><span id="read"><span class="annot"><span class="annottext">read :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Unfold m (Array a) a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#read"><span class="hs-identifier hs-var hs-var">read</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Producer m a b -&gt; Unfold m a b
</span><a href="Streamly.Internal.Data.Producer.html#simplify"><span class="hs-identifier hs-var">Producer.simplify</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Producer m (Array a) a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#producer"><span class="hs-identifier hs-var">producer</span></a></span><span>
</span><span id="line-1398"></span><span>
</span><span id="line-1399"></span><span class="hs-comment">-- | Unfold an array into a stream in reverse order.</span><span>
</span><span id="line-1400"></span><span class="hs-comment">--</span><span>
</span><span id="line-1401"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-1402"></span><span class="hs-pragma">{-# INLINE_NORMAL readRev #-}</span><span>
</span><span id="line-1403"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#readRev"><span class="hs-identifier hs-type">readRev</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679400284"><span class="annot"><a href="#local-6989586621679400284"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679400283"><span class="annot"><a href="#local-6989586621679400283"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679400284"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679400283"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Type.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400284"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400283"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679400283"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1404"></span><span id="readRev"><span class="annot"><span class="annottext">readRev :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Unfold m (Array a) a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#readRev"><span class="hs-identifier hs-var hs-var">readRev</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b s.
(s -&gt; m (Step s b)) -&gt; (a -&gt; m s) -&gt; Unfold m a b
</span><a href="Streamly.Internal.Data.Unfold.Type.html#Unfold"><span class="hs-identifier hs-var">Unfold</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a}.
(MonadIO m, Storable a) =&gt;
ReadUState a -&gt; m (Step (ReadUState a) a)
</span><a href="#local-6989586621679400276"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a}. Monad m =&gt; Array a -&gt; m (ReadUState a)
</span><a href="#local-6989586621679400275"><span class="hs-identifier hs-var">inject</span></a></span><span>
</span><span id="line-1405"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1406"></span><span>
</span><span id="line-1407"></span><span>    </span><span id="local-6989586621679400275"><span class="annot"><span class="annottext">inject :: Array a -&gt; m (ReadUState a)
</span><a href="#local-6989586621679400275"><span class="hs-identifier hs-var hs-var">inject</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621679400272"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400272"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679400271"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400271"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679400270"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400270"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1408"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400265"><span class="annot"><span class="annottext">p :: Ptr b
</span><a href="#local-6989586621679400265"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400270"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">negate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679400283"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1409"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; ReadUState a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-var">ReadUState</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400272"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400271"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400265"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1410"></span><span>
</span><span id="line-1411"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-1412"></span><span>    </span><span id="local-6989586621679400276"><span class="annot"><span class="annottext">step :: ReadUState a -&gt; m (Step (ReadUState a) a)
</span><a href="#local-6989586621679400276"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-type">ReadUState</span></a></span><span> </span><span id="local-6989586621679400253"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400253"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679400252"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400252"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679400251"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400251"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400251"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400252"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1413"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400253"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-1414"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Stop"><span class="hs-identifier hs-var">D.Stop</span></a></span><span>
</span><span id="line-1415"></span><span>    </span><span class="annot"><a href="#local-6989586621679400276"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-type">ReadUState</span></a></span><span> </span><span id="local-6989586621679400250"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400250"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679400249"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400249"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679400248"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400248"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1416"></span><span>            </span><span id="local-6989586621679400247"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400247"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400248"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1417"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400242"><span class="annot"><span class="annottext">cur :: Ptr b
</span><a href="#local-6989586621679400242"><span class="hs-identifier hs-var hs-var">cur</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400248"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">negate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679400283"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1418"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Yield"><span class="hs-identifier hs-var">D.Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400247"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; ReadUState a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-var">ReadUState</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400250"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400249"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400242"><span class="hs-identifier hs-var">cur</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1419"></span><span>
</span><span id="line-1420"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1421"></span><span class="hs-comment">-- to Lists and streams</span><span>
</span><span id="line-1422"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1423"></span><span>
</span><span id="line-1424"></span><span class="hs-comment">{-
-- Use foldr/build fusion to fuse with list consumers
-- This can be useful when using the IsList instance
{-# INLINE_LATE toListFB #-}
toListFB :: forall a b. Storable a =&gt; (a -&gt; b -&gt; b) -&gt; b -&gt; Array a -&gt; b
toListFB c n Array{..} = go arrStart
    where

    go p | assert (p &lt;= aEnd) (p == aEnd) = n
    go p =
        -- unsafeInlineIO allows us to run this in Identity monad for pure
        -- toList/foldr case which makes them much faster due to not
        -- accumulating the list and fusing better with the pure consumers.
        --
        -- This should be safe as the array contents are guaranteed to be
        -- evaluated/written to before we peek at them.
        -- XXX
        let !x = unsafeInlineIO $ do
                    r &lt;- peek p
                    touch arrContents
                    return r
        in c x (go (p `plusPtr` sizeOf (undefined :: a)))
-}</span><span>
</span><span id="line-1447"></span><span>
</span><span id="line-1448"></span><span class="hs-comment">-- XXX Monadic foldr/build fusion?</span><span>
</span><span id="line-1449"></span><span class="hs-comment">-- Reference: https://www.researchgate.net/publication/220676509_Monadic_augment_and_generalised_short_cut_fusion</span><span>
</span><span id="line-1450"></span><span class="hs-comment">-- | Convert an 'Array' into a list.</span><span>
</span><span id="line-1451"></span><span class="hs-comment">--</span><span>
</span><span id="line-1452"></span><span class="hs-comment">-- @since 0.7.0</span><span>
</span><span id="line-1453"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toList"><span class="hs-pragma hs-type">toList</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1454"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toList"><span class="hs-identifier hs-type">toList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401661"><span class="annot"><a href="#local-6989586621679401661"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401660"><span class="annot"><a href="#local-6989586621679401660"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401661"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401660"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401660"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401661"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679401660"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1455"></span><span id="toList"><span class="annot"><span class="annottext">toList :: forall (m :: * -&gt; *) a. (MonadIO m, Storable a) =&gt; Array a -&gt; m [a]
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toList"><span class="hs-identifier hs-var hs-var">toList</span></a></span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679400235"><span id="local-6989586621679400236"><span id="local-6989586621679400237"><span id="local-6989586621679400238"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679400235"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; IO [a]
</span><a href="#local-6989586621679400234"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400237"><span class="hs-identifier hs-var">arrStart</span></a></span><span>
</span><span id="line-1456"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1457"></span><span>
</span><span id="line-1458"></span><span>    </span><span id="local-6989586621679400234"><span class="annot"><span class="annottext">go :: Ptr a -&gt; IO [a]
</span><a href="#local-6989586621679400234"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679400221"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400221"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400221"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400236"><span class="hs-identifier hs-var">aEnd</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400221"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400236"><span class="hs-identifier hs-var">aEnd</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1459"></span><span>    </span><span class="annot"><a href="#local-6989586621679400234"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621679400220"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400220"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1460"></span><span>        </span><span id="local-6989586621679400219"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400219"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400220"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1461"></span><span>        </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400238"><span class="hs-identifier hs-var">arrContents</span></a></span><span>
</span><span id="line-1462"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400219"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; IO [a]
</span><a href="#local-6989586621679400234"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400220"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401660"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1463"></span><span>
</span><span id="line-1464"></span><span class="hs-comment">-- | Use the 'read' unfold instead.</span><span>
</span><span id="line-1465"></span><span class="hs-comment">--</span><span>
</span><span id="line-1466"></span><span class="hs-comment">-- @toStreamD = D.unfold read@</span><span>
</span><span id="line-1467"></span><span class="hs-comment">--</span><span>
</span><span id="line-1468"></span><span class="hs-comment">-- We can try this if the unfold has any performance issues.</span><span>
</span><span id="line-1469"></span><span class="hs-pragma">{-# INLINE_NORMAL toStreamD #-}</span><span>
</span><span id="line-1470"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toStreamD"><span class="hs-identifier hs-type">toStreamD</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401657"><span class="annot"><a href="#local-6989586621679401657"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401656"><span class="annot"><a href="#local-6989586621679401656"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401657"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401656"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401656"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">D.Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401657"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401656"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1471"></span><span id="toStreamD"><span class="annot"><span class="annottext">toStreamD :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toStreamD"><span class="hs-identifier hs-var hs-var">toStreamD</span></a></span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679400212"><span id="local-6989586621679400213"><span id="local-6989586621679400214"><span id="local-6989586621679400215"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679400212"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">D.Stream</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {p} {b}.
MonadIO m =&gt;
p -&gt; Ptr a -&gt; m (Step (Ptr b) a)
</span><a href="#local-6989586621679400211"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400214"><span class="hs-identifier hs-var">arrStart</span></a></span><span>
</span><span id="line-1472"></span><span>
</span><span id="line-1473"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1474"></span><span>
</span><span id="line-1475"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-1476"></span><span>    </span><span id="local-6989586621679400211"><span class="annot"><span class="annottext">step :: p -&gt; Ptr a -&gt; m (Step (Ptr b) a)
</span><a href="#local-6989586621679400211"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679400195"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400195"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400195"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400213"><span class="hs-identifier hs-var">aEnd</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400195"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400213"><span class="hs-identifier hs-var">aEnd</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Stop"><span class="hs-identifier hs-var">D.Stop</span></a></span><span>
</span><span id="line-1477"></span><span>    </span><span class="annot"><a href="#local-6989586621679400211"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679400194"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400194"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1478"></span><span>        </span><span id="local-6989586621679400193"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400193"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400194"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1479"></span><span>        </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400215"><span class="hs-identifier hs-var">arrContents</span></a></span><span>
</span><span id="line-1480"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Yield"><span class="hs-identifier hs-var">D.Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400193"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400194"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401656"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1481"></span><span>
</span><span id="line-1482"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toStreamK"><span class="hs-pragma hs-type">toStreamK</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1483"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toStreamK"><span class="hs-identifier hs-type">toStreamK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401650"><span class="annot"><a href="#local-6989586621679401650"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401649"><span class="annot"><a href="#local-6989586621679401649"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401650"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401649"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401649"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">K.Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401650"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401649"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1484"></span><span id="toStreamK"><span class="annot"><span class="annottext">toStreamK :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toStreamK"><span class="hs-identifier hs-var hs-var">toStreamK</span></a></span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679400186"><span id="local-6989586621679400187"><span id="local-6989586621679400188"><span id="local-6989586621679400189"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679400186"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *}. MonadIO m =&gt; Ptr a -&gt; Stream m a
</span><a href="#local-6989586621679400185"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400188"><span class="hs-identifier hs-var">arrStart</span></a></span><span>
</span><span id="line-1485"></span><span>
</span><span id="line-1486"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1487"></span><span>
</span><span id="line-1488"></span><span>    </span><span id="local-6989586621679400185"><span class="annot"><span class="annottext">go :: Ptr a -&gt; Stream m a
</span><a href="#local-6989586621679400185"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679400173"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400173"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400173"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400187"><span class="hs-identifier hs-var">aEnd</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400173"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400187"><span class="hs-identifier hs-var">aEnd</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-identifier hs-var">K.nil</span></a></span><span>
</span><span id="line-1489"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1490"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400168"><span class="annot"><span class="annottext">elemM :: IO a
</span><a href="#local-6989586621679400168"><span class="hs-identifier hs-var hs-var">elemM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1491"></span><span>              </span><span id="local-6989586621679400167"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400167"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400173"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1492"></span><span>              </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400189"><span class="hs-identifier hs-var">arrContents</span></a></span><span>
</span><span id="line-1493"></span><span>              </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400167"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1494"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679400168"><span class="hs-identifier hs-var">elemM</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#consM"><span class="hs-operator hs-var">`K.consM`</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; Stream m a
</span><a href="#local-6989586621679400185"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400173"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401649"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1495"></span><span>
</span><span id="line-1496"></span><span class="hs-comment">-- | Use the 'readRev' unfold instead.</span><span>
</span><span id="line-1497"></span><span class="hs-comment">--</span><span>
</span><span id="line-1498"></span><span class="hs-comment">-- @toStreamDRev = D.unfold readRev@</span><span>
</span><span id="line-1499"></span><span class="hs-comment">--</span><span>
</span><span id="line-1500"></span><span class="hs-comment">-- We can try this if the unfold has any perf issues.</span><span>
</span><span id="line-1501"></span><span class="hs-pragma">{-# INLINE_NORMAL toStreamDRev #-}</span><span>
</span><span id="line-1502"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toStreamDRev"><span class="hs-identifier hs-type">toStreamDRev</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679400165"><span class="annot"><a href="#local-6989586621679400165"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679400164"><span class="annot"><a href="#local-6989586621679400164"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679400165"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679400164"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400164"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">D.Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400164"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1503"></span><span id="toStreamDRev"><span class="annot"><span class="annottext">toStreamDRev :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toStreamDRev"><span class="hs-identifier hs-var hs-var">toStreamDRev</span></a></span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679400157"><span id="local-6989586621679400158"><span id="local-6989586621679400159"><span id="local-6989586621679400160"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679400157"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1504"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400152"><span class="annot"><span class="annottext">p :: Ptr b
</span><a href="#local-6989586621679400152"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400158"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">negate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679400164"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1505"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a s.
(State Stream m a -&gt; s -&gt; m (Step s a)) -&gt; s -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-var">D.Stream</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {p} {b}.
MonadIO m =&gt;
p -&gt; Ptr a -&gt; m (Step (Ptr b) a)
</span><a href="#local-6989586621679400151"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400152"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1506"></span><span>
</span><span id="line-1507"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1508"></span><span>
</span><span id="line-1509"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-1510"></span><span>    </span><span id="local-6989586621679400151"><span class="annot"><span class="annottext">step :: p -&gt; Ptr a -&gt; m (Step (Ptr b) a)
</span><a href="#local-6989586621679400151"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679400137"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400137"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400137"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400159"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Stop"><span class="hs-identifier hs-var">D.Stop</span></a></span><span>
</span><span id="line-1511"></span><span>    </span><span class="annot"><a href="#local-6989586621679400151"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679400136"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400136"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1512"></span><span>        </span><span id="local-6989586621679400135"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400135"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400136"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1513"></span><span>        </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400160"><span class="hs-identifier hs-var">arrContents</span></a></span><span>
</span><span id="line-1514"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Yield"><span class="hs-identifier hs-var">D.Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400135"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400136"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">negate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679400164"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1515"></span><span>
</span><span id="line-1516"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toStreamKRev"><span class="hs-pragma hs-type">toStreamKRev</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1517"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toStreamKRev"><span class="hs-identifier hs-type">toStreamKRev</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679400134"><span class="annot"><a href="#local-6989586621679400134"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679400133"><span class="annot"><a href="#local-6989586621679400133"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679400134"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679400133"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400133"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">K.Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400134"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400133"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1518"></span><span id="toStreamKRev"><span class="annot"><span class="annottext">toStreamKRev :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toStreamKRev"><span class="hs-identifier hs-var hs-var">toStreamKRev</span></a></span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679400126"><span id="local-6989586621679400127"><span id="local-6989586621679400128"><span id="local-6989586621679400129"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679400126"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1519"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400121"><span class="annot"><span class="annottext">p :: Ptr b
</span><a href="#local-6989586621679400121"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400127"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">negate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679400133"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1520"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *}. MonadIO m =&gt; Ptr a -&gt; Stream m a
</span><a href="#local-6989586621679400120"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400121"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1521"></span><span>
</span><span id="line-1522"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1523"></span><span>
</span><span id="line-1524"></span><span>    </span><span id="local-6989586621679400120"><span class="annot"><span class="annottext">go :: Ptr a -&gt; Stream m a
</span><a href="#local-6989586621679400120"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679400110"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400110"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400110"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400128"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#nil"><span class="hs-identifier hs-var">K.nil</span></a></span><span>
</span><span id="line-1525"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1526"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400105"><span class="annot"><span class="annottext">elemM :: IO a
</span><a href="#local-6989586621679400105"><span class="hs-identifier hs-var hs-var">elemM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1527"></span><span>              </span><span id="local-6989586621679400104"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400104"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400110"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1528"></span><span>              </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400129"><span class="hs-identifier hs-var">arrContents</span></a></span><span>
</span><span id="line-1529"></span><span>              </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400104"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1530"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679400105"><span class="hs-identifier hs-var">elemM</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#consM"><span class="hs-operator hs-var">`K.consM`</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; Stream m a
</span><a href="#local-6989586621679400120"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400110"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">negate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679400133"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1531"></span><span>
</span><span id="line-1532"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1533"></span><span class="hs-comment">-- Folding</span><span>
</span><span id="line-1534"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1535"></span><span>
</span><span id="line-1536"></span><span class="hs-comment">-- XXX Need something like &quot;Array m a&quot; enforcing monadic action to avoid the</span><span>
</span><span id="line-1537"></span><span class="hs-comment">-- possibility of such APIs.</span><span>
</span><span id="line-1538"></span><span class="hs-comment">--</span><span>
</span><span id="line-1539"></span><span class="hs-comment">-- | Strict left fold of an array.</span><span>
</span><span id="line-1540"></span><span class="hs-pragma">{-# INLINE_NORMAL foldl' #-}</span><span>
</span><span id="line-1541"></span><span id="local-6989586621679401631"><span id="local-6989586621679401632"><span id="local-6989586621679401633"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#foldl%27"><span class="hs-identifier hs-type">foldl'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401633"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401632"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679401631"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401632"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401631"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401631"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401632"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401633"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401631"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-1542"></span><span id="foldl%27"><span class="annot"><span class="annottext">foldl' :: forall (m :: * -&gt; *) a b.
(MonadIO m, Storable a) =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; Array a -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#foldl%27"><span class="hs-identifier hs-var hs-var">foldl'</span></a></span></span><span> </span><span id="local-6989586621679400097"><span class="annot"><span class="annottext">b -&gt; a -&gt; b
</span><a href="#local-6989586621679400097"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679400096"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679400096"><span class="hs-identifier hs-var">z</span></a></span></span><span> </span><span id="local-6989586621679400095"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400095"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b a.
Monad m =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldl%27"><span class="hs-identifier hs-var">D.foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; a -&gt; b
</span><a href="#local-6989586621679400097"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679400096"><span class="hs-identifier hs-var">z</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toStreamD"><span class="hs-identifier hs-var">toStreamD</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400095"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-1543"></span><span>
</span><span id="line-1544"></span><span class="hs-comment">-- | Right fold of an array.</span><span>
</span><span id="line-1545"></span><span class="hs-pragma">{-# INLINE_NORMAL foldr #-}</span><span>
</span><span id="line-1546"></span><span id="local-6989586621679401622"><span id="local-6989586621679401623"><span id="local-6989586621679401624"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#foldr"><span class="hs-identifier hs-type">foldr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401624"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401623"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679401623"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401622"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401622"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401622"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401623"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401624"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401622"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-1547"></span><span id="foldr"><span class="annot"><span class="annottext">foldr :: forall (m :: * -&gt; *) a b.
(MonadIO m, Storable a) =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; Array a -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#foldr"><span class="hs-identifier hs-var hs-var">foldr</span></a></span></span><span> </span><span id="local-6989586621679400087"><span class="annot"><span class="annottext">a -&gt; b -&gt; b
</span><a href="#local-6989586621679400087"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679400086"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679400086"><span class="hs-identifier hs-var">z</span></a></span></span><span> </span><span id="local-6989586621679400085"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400085"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldr"><span class="hs-identifier hs-var">D.foldr</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; b -&gt; b
</span><a href="#local-6989586621679400087"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679400086"><span class="hs-identifier hs-var">z</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toStreamD"><span class="hs-identifier hs-var">toStreamD</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400085"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-1548"></span><span>
</span><span id="line-1549"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1550"></span><span class="hs-comment">-- Folds</span><span>
</span><span id="line-1551"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1552"></span><span>
</span><span id="line-1553"></span><span class="hs-keyword">data</span><span> </span><span id="ArrayUnsafe"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayUnsafe"><span class="hs-identifier hs-var">ArrayUnsafe</span></a></span></span><span> </span><span id="local-6989586621679401615"><span class="annot"><a href="#local-6989586621679401615"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ArrayUnsafe"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayUnsafe"><span class="hs-identifier hs-var">ArrayUnsafe</span></a></span></span><span>
</span><span id="line-1554"></span><span>    </span><span class="hs-identifier">UNPACKIF</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">ArrayContents</span><span>  </span><span class="hs-comment">-- contents</span><span>
</span><span id="line-1555"></span><span>    </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401615"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- start address</span><span>
</span><span id="line-1556"></span><span>    </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401615"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- first unused address</span><span>
</span><span id="line-1557"></span><span>
</span><span id="line-1558"></span><span id="local-6989586621679401618"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toArrayUnsafe"><span class="hs-identifier hs-type">toArrayUnsafe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401618"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayUnsafe"><span class="hs-identifier hs-type">ArrayUnsafe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401618"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-1559"></span><span id="toArrayUnsafe"><span class="annot"><span class="annottext">toArrayUnsafe :: forall a. Array a -&gt; ArrayUnsafe a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toArrayUnsafe"><span class="hs-identifier hs-var hs-var">toArrayUnsafe</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621679400082"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400082"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679400081"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400081"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679400080"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400080"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1560"></span><span>    </span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; ArrayUnsafe a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayUnsafe"><span class="hs-identifier hs-var">ArrayUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400082"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400081"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400080"><span class="hs-identifier hs-var">end</span></a></span><span>
</span><span id="line-1561"></span><span>
</span><span id="line-1562"></span><span id="local-6989586621679401614"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromArrayUnsafe"><span class="hs-identifier hs-type">fromArrayUnsafe</span></a></span><span> </span><span class="hs-glyph">::</span><span class="hs-cpp">
#ifdef DEVBUILD
</span><span>    </span><span class="hs-identifier">Storable</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span class="hs-cpp">
#endif
</span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayUnsafe"><span class="hs-identifier hs-type">ArrayUnsafe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401614"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401614"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-1567"></span><span id="fromArrayUnsafe"><span class="annot"><span class="annottext">fromArrayUnsafe :: forall a. ArrayUnsafe a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromArrayUnsafe"><span class="hs-identifier hs-var hs-var">fromArrayUnsafe</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayUnsafe"><span class="hs-identifier hs-type">ArrayUnsafe</span></a></span><span> </span><span id="local-6989586621679400078"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400078"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679400077"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400077"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679400076"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400076"><span class="hs-identifier hs-var">end</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1568"></span><span>         </span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; Ptr a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400078"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400077"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400076"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400076"><span class="hs-identifier hs-var">end</span></a></span><span>
</span><span id="line-1569"></span><span>
</span><span id="line-1570"></span><span class="hs-comment">-- Note: Arrays may be allocated with a specific alignment at the beginning of</span><span>
</span><span id="line-1571"></span><span class="hs-comment">-- the array. If you need to maintain that alignment on reallocations then you</span><span>
</span><span id="line-1572"></span><span class="hs-comment">-- can resize the array manually before append, using an aligned resize</span><span>
</span><span id="line-1573"></span><span class="hs-comment">-- operation.</span><span>
</span><span id="line-1574"></span><span>
</span><span id="line-1575"></span><span class="hs-comment">-- XXX Keep the bound intact to not lose any free space? Perf impact?</span><span>
</span><span id="line-1576"></span><span>
</span><span id="line-1577"></span><span class="hs-comment">-- | Append up to @n@ input items to the supplied array.</span><span>
</span><span id="line-1578"></span><span class="hs-comment">--</span><span>
</span><span id="line-1579"></span><span class="hs-comment">-- Unsafe: Do not drive the fold beyond @n@ elements, it will lead to memory</span><span>
</span><span id="line-1580"></span><span class="hs-comment">-- corruption or segfault.</span><span>
</span><span id="line-1581"></span><span class="hs-comment">--</span><span>
</span><span id="line-1582"></span><span class="hs-comment">-- Any free space left in the array after appending @n@ elements is lost.</span><span>
</span><span id="line-1583"></span><span class="hs-comment">--</span><span>
</span><span id="line-1584"></span><span class="hs-comment">-- /Internal/</span><span>
</span><span id="line-1585"></span><span class="hs-pragma">{-# INLINE_NORMAL appendNUnsafe #-}</span><span>
</span><span id="line-1586"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#appendNUnsafe"><span class="hs-identifier hs-type">appendNUnsafe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401612"><span class="annot"><a href="#local-6989586621679401612"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401611"><span class="annot"><a href="#local-6989586621679401611"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401612"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401611"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1587"></span><span>       </span><span class="annot"><a href="#local-6989586621679401612"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401611"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1588"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-1589"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401612"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401611"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401611"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1590"></span><span id="appendNUnsafe"><span class="annot"><span class="annottext">appendNUnsafe :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
m (Array a) -&gt; Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#appendNUnsafe"><span class="hs-identifier hs-var hs-var">appendNUnsafe</span></a></span></span><span> </span><span id="local-6989586621679400064"><span class="annot"><span class="annottext">m (Array a)
</span><a href="#local-6989586621679400064"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span id="local-6989586621679400063"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400063"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1591"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">forall a. ArrayUnsafe a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromArrayUnsafe"><span class="hs-identifier hs-var">fromArrayUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b a.
Monad m =&gt;
(b -&gt; a -&gt; m b) -&gt; m b -&gt; Fold m a b
</span><a href="Streamly.Internal.Data.Fold.Type.html#foldlM%27"><span class="hs-identifier hs-var">FL.foldlM'</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a}.
(MonadIO m, Storable a) =&gt;
ArrayUnsafe a -&gt; a -&gt; m (ArrayUnsafe a)
</span><a href="#local-6989586621679400061"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">m (ArrayUnsafe a)
</span><a href="#local-6989586621679400060"><span class="hs-identifier hs-var">initial</span></a></span><span>
</span><span id="line-1592"></span><span>
</span><span id="line-1593"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1594"></span><span>
</span><span id="line-1595"></span><span>    </span><span id="local-6989586621679400060"><span class="annot"><span class="annottext">initial :: m (ArrayUnsafe a)
</span><a href="#local-6989586621679400060"><span class="hs-identifier hs-var hs-var">initial</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1596"></span><span>        </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400063"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1597"></span><span>        </span><span id="local-6989586621679400045"><span class="annot"><span class="annottext">arr :: Array a
</span><a href="#local-6989586621679400045"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679400044"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400044"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679400043"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400043"><span class="hs-identifier hs-var">bound</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Array a)
</span><a href="#local-6989586621679400064"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-1598"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400042"><span class="annot"><span class="annottext">free :: Int
</span><a href="#local-6989586621679400042"><span class="hs-identifier hs-var hs-var">free</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400043"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b -&gt; Int
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400044"><span class="hs-identifier hs-var">end</span></a></span><span>
</span><span id="line-1599"></span><span>            </span><span id="local-6989586621679400038"><span class="annot"><span class="annottext">elemSize :: Int
</span><a href="#local-6989586621679400038"><span class="hs-identifier hs-var hs-var">elemSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401611"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1600"></span><span>            </span><span id="local-6989586621679400036"><span class="annot"><span class="annottext">needed :: Int
</span><a href="#local-6989586621679400036"><span class="hs-identifier hs-var hs-var">needed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400063"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400038"><span class="hs-identifier hs-var">elemSize</span></a></span><span>
</span><span id="line-1601"></span><span>        </span><span class="hs-comment">-- XXX We can also reallocate if the array has too much free space,</span><span>
</span><span id="line-1602"></span><span>        </span><span class="hs-comment">-- otherwise we lose that space.</span><span>
</span><span id="line-1603"></span><span>        </span><span id="local-6989586621679400035"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400035"><span class="hs-identifier hs-var">arr1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1604"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400042"><span class="hs-identifier hs-var">free</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400036"><span class="hs-identifier hs-var">needed</span></a></span><span>
</span><span id="line-1605"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
</span><span class="hs-identifier hs-var">noinline</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
[Char] -&gt; (Int -&gt; Int) -&gt; Int -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#reallocWith"><span class="hs-identifier hs-var">reallocWith</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;appendNUnsafeWith&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400036"><span class="hs-identifier hs-var">needed</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400036"><span class="hs-identifier hs-var">needed</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400045"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-1606"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400045"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-1607"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; ArrayUnsafe a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toArrayUnsafe"><span class="hs-identifier hs-var">toArrayUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679400035"><span class="hs-identifier hs-var">arr1</span></a></span><span>
</span><span id="line-1608"></span><span>
</span><span id="line-1609"></span><span>    </span><span id="local-6989586621679400061"><span class="annot"><span class="annottext">step :: ArrayUnsafe a -&gt; a -&gt; m (ArrayUnsafe a)
</span><a href="#local-6989586621679400061"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayUnsafe"><span class="hs-identifier hs-type">ArrayUnsafe</span></a></span><span> </span><span id="local-6989586621679400026"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400026"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679400025"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400025"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679400024"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400024"><span class="hs-identifier hs-var">end</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679400023"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400023"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1610"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">poke</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400024"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679400023"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400026"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-1611"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679400019"><span class="annot"><span class="annottext">end1 :: Ptr b
</span><a href="#local-6989586621679400019"><span class="hs-identifier hs-var hs-var">end1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400024"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401611"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1612"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; ArrayUnsafe a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayUnsafe"><span class="hs-identifier hs-var">ArrayUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679400026"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679400025"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679400019"><span class="hs-identifier hs-var">end1</span></a></span><span>
</span><span id="line-1613"></span><span>
</span><span id="line-1614"></span><span class="hs-comment">-- | Append @n@ elements to an existing array. Any free space left in the array</span><span>
</span><span id="line-1615"></span><span class="hs-comment">-- after appending @n@ elements is lost.</span><span>
</span><span id="line-1616"></span><span class="hs-comment">--</span><span>
</span><span id="line-1617"></span><span class="hs-comment">-- &gt;&gt;&gt; appendN initial n = Fold.take n (Array.appendNUnsafe initial n)</span><span>
</span><span id="line-1618"></span><span class="hs-comment">--</span><span>
</span><span id="line-1619"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-1620"></span><span class="hs-pragma">{-# INLINE_NORMAL appendN #-}</span><span>
</span><span id="line-1621"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#appendN"><span class="hs-identifier hs-type">appendN</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679400018"><span class="annot"><a href="#local-6989586621679400018"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679400017"><span class="annot"><a href="#local-6989586621679400017"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679400018"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679400017"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1622"></span><span>    </span><span class="annot"><a href="#local-6989586621679400018"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400017"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400018"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400017"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679400017"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1623"></span><span id="appendN"><span class="annot"><span class="annottext">appendN :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
m (Array a) -&gt; Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#appendN"><span class="hs-identifier hs-var hs-var">appendN</span></a></span></span><span> </span><span id="local-6989586621679400010"><span class="annot"><span class="annottext">m (Array a)
</span><a href="#local-6989586621679400010"><span class="hs-identifier hs-var">initial</span></a></span></span><span> </span><span id="local-6989586621679400009"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400009"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
Monad m =&gt;
Int -&gt; Fold m a b -&gt; Fold m a b
</span><a href="Streamly.Internal.Data.Fold.Type.html#take"><span class="hs-identifier hs-var">FL.take</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400009"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
m (Array a) -&gt; Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#appendNUnsafe"><span class="hs-identifier hs-var">appendNUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">m (Array a)
</span><a href="#local-6989586621679400010"><span class="hs-identifier hs-var">initial</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679400009"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1624"></span><span>
</span><span id="line-1625"></span><span class="hs-comment">-- | @appendWith realloc action@ mutates the array generated by @action@ to</span><span>
</span><span id="line-1626"></span><span class="hs-comment">-- append the input stream. If there is no reserved space available in the</span><span>
</span><span id="line-1627"></span><span class="hs-comment">-- array it is reallocated to a size in bytes  determined by @realloc oldSize@,</span><span>
</span><span id="line-1628"></span><span class="hs-comment">-- where @oldSize@ is the current size of the array in bytes.</span><span>
</span><span id="line-1629"></span><span class="hs-comment">--</span><span>
</span><span id="line-1630"></span><span class="hs-comment">-- Note that the returned array may be a mutated version of original array.</span><span>
</span><span id="line-1631"></span><span class="hs-comment">--</span><span>
</span><span id="line-1632"></span><span class="hs-comment">-- &gt;&gt;&gt; appendWith sizer = Fold.foldlM' (Array.snocWith sizer)</span><span>
</span><span id="line-1633"></span><span class="hs-comment">--</span><span>
</span><span id="line-1634"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-1635"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#appendWith"><span class="hs-pragma hs-type">appendWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1636"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#appendWith"><span class="hs-identifier hs-type">appendWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401591"><span class="annot"><a href="#local-6989586621679401591"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401590"><span class="annot"><a href="#local-6989586621679401590"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401591"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401590"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1637"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401591"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401590"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401591"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401590"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401590"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1638"></span><span id="appendWith"><span class="annot"><span class="annottext">appendWith :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; Int) -&gt; m (Array a) -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#appendWith"><span class="hs-identifier hs-var hs-var">appendWith</span></a></span></span><span> </span><span id="local-6989586621679400001"><span class="annot"><span class="annottext">Int -&gt; Int
</span><a href="#local-6989586621679400001"><span class="hs-identifier hs-var">sizer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b a.
Monad m =&gt;
(b -&gt; a -&gt; m b) -&gt; m b -&gt; Fold m a b
</span><a href="Streamly.Internal.Data.Fold.Type.html#foldlM%27"><span class="hs-identifier hs-var">FL.foldlM'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; Int) -&gt; Array a -&gt; a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocWith"><span class="hs-identifier hs-var">snocWith</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
</span><a href="#local-6989586621679400001"><span class="hs-identifier hs-var">sizer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1639"></span><span>
</span><span id="line-1640"></span><span class="hs-comment">-- | @append action@ mutates the array generated by @action@ to append the</span><span>
</span><span id="line-1641"></span><span class="hs-comment">-- input stream. If there is no reserved space available in the array it is</span><span>
</span><span id="line-1642"></span><span class="hs-comment">-- reallocated to double the size.</span><span>
</span><span id="line-1643"></span><span class="hs-comment">--</span><span>
</span><span id="line-1644"></span><span class="hs-comment">-- Note that the returned array may be a mutated version of original array.</span><span>
</span><span id="line-1645"></span><span class="hs-comment">--</span><span>
</span><span id="line-1646"></span><span class="hs-comment">-- &gt;&gt;&gt; append = Array.appendWith (* 2)</span><span>
</span><span id="line-1647"></span><span class="hs-comment">--</span><span>
</span><span id="line-1648"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-1649"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#append"><span class="hs-pragma hs-type">append</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1650"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#append"><span class="hs-identifier hs-type">append</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401587"><span class="annot"><a href="#local-6989586621679401587"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401586"><span class="annot"><a href="#local-6989586621679401586"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401587"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401586"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1651"></span><span>    </span><span class="annot"><a href="#local-6989586621679401587"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401586"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401587"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401586"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401586"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1652"></span><span id="append"><span class="annot"><span class="annottext">append :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
m (Array a) -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#append"><span class="hs-identifier hs-var hs-var">append</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; Int) -&gt; m (Array a) -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#appendWith"><span class="hs-identifier hs-var">appendWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span>
</span><span id="line-1653"></span><span>
</span><span id="line-1654"></span><span class="hs-comment">-- | @writeNWith alloc n@ folds a maximum of @n@ elements into an array</span><span>
</span><span id="line-1655"></span><span class="hs-comment">-- allocated using the @alloc@ function.</span><span>
</span><span id="line-1656"></span><span class="hs-comment">--</span><span>
</span><span id="line-1657"></span><span class="hs-comment">-- &gt;&gt;&gt; writeNWith alloc n = Fold.take n (Array.writeNWithUnsafe alloc n)</span><span>
</span><span id="line-1658"></span><span class="hs-comment">-- &gt;&gt;&gt; writeNWith alloc n = Array.appendN (alloc n) n</span><span>
</span><span id="line-1659"></span><span class="hs-comment">--</span><span>
</span><span id="line-1660"></span><span class="hs-pragma">{-# INLINE_NORMAL writeNWith #-}</span><span>
</span><span id="line-1661"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNWith"><span class="hs-identifier hs-type">writeNWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401583"><span class="annot"><a href="#local-6989586621679401583"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401582"><span class="annot"><a href="#local-6989586621679401582"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401583"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401582"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1662"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401583"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401582"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401583"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401582"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401582"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1663"></span><span id="writeNWith"><span class="annot"><span class="annottext">writeNWith :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; m (Array a)) -&gt; Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNWith"><span class="hs-identifier hs-var hs-var">writeNWith</span></a></span></span><span> </span><span id="local-6989586621679399988"><span class="annot"><span class="annottext">Int -&gt; m (Array a)
</span><a href="#local-6989586621679399988"><span class="hs-identifier hs-var">alloc</span></a></span></span><span> </span><span id="local-6989586621679399987"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399987"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
Monad m =&gt;
Int -&gt; Fold m a b -&gt; Fold m a b
</span><a href="Streamly.Internal.Data.Fold.Type.html#take"><span class="hs-identifier hs-var">FL.take</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399987"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; m (Array a)) -&gt; Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNWithUnsafe"><span class="hs-identifier hs-var">writeNWithUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; m (Array a)
</span><a href="#local-6989586621679399988"><span class="hs-identifier hs-var">alloc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399987"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1664"></span><span>
</span><span id="line-1665"></span><span class="hs-comment">-- | @writeN n@ folds a maximum of @n@ elements from the input stream to an</span><span>
</span><span id="line-1666"></span><span class="hs-comment">-- 'Array'.</span><span>
</span><span id="line-1667"></span><span class="hs-comment">--</span><span>
</span><span id="line-1668"></span><span class="hs-comment">-- &gt;&gt;&gt; writeN = Array.writeNWith Array.newArray</span><span>
</span><span id="line-1669"></span><span class="hs-comment">-- &gt;&gt;&gt; writeN n = Fold.take n (Array.writeNUnsafe n)</span><span>
</span><span id="line-1670"></span><span class="hs-comment">-- &gt;&gt;&gt; writeN n = Array.appendN (Array.newArray n) n</span><span>
</span><span id="line-1671"></span><span class="hs-comment">--</span><span>
</span><span id="line-1672"></span><span class="hs-comment">-- @since 0.7.0</span><span>
</span><span id="line-1673"></span><span class="hs-pragma">{-# INLINE_NORMAL writeN #-}</span><span>
</span><span id="line-1674"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeN"><span class="hs-identifier hs-type">writeN</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401579"><span class="annot"><a href="#local-6989586621679401579"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401578"><span class="annot"><a href="#local-6989586621679401578"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401579"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401578"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401579"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401578"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401578"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1675"></span><span id="writeN"><span class="annot"><span class="annottext">writeN :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeN"><span class="hs-identifier hs-var hs-var">writeN</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; m (Array a)) -&gt; Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNWith"><span class="hs-identifier hs-var">writeNWith</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArray"><span class="hs-identifier hs-var">newArray</span></a></span><span>
</span><span id="line-1676"></span><span>
</span><span id="line-1677"></span><span class="hs-comment">-- | @writeNAligned align n@ folds a maximum of @n@ elements from the input</span><span>
</span><span id="line-1678"></span><span class="hs-comment">-- stream to an 'Array' aligned to the given size.</span><span>
</span><span id="line-1679"></span><span class="hs-comment">--</span><span>
</span><span id="line-1680"></span><span class="hs-comment">-- &gt;&gt;&gt; writeNAligned align = Array.writeNWith (Array.newArrayAligned align)</span><span>
</span><span id="line-1681"></span><span class="hs-comment">-- &gt;&gt;&gt; writeNAligned align n = Array.appendN (Array.newArrayAligned align n) n</span><span>
</span><span id="line-1682"></span><span class="hs-comment">--</span><span>
</span><span id="line-1683"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-1684"></span><span class="hs-comment">--</span><span>
</span><span id="line-1685"></span><span class="hs-pragma">{-# INLINE_NORMAL writeNAligned #-}</span><span>
</span><span id="line-1686"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNAligned"><span class="hs-identifier hs-type">writeNAligned</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401575"><span class="annot"><a href="#local-6989586621679401575"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401574"><span class="annot"><a href="#local-6989586621679401574"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401575"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401574"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1687"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401575"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401574"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401574"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1688"></span><span id="writeNAligned"><span class="annot"><span class="annottext">writeNAligned :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNAligned"><span class="hs-identifier hs-var hs-var">writeNAligned</span></a></span></span><span> </span><span id="local-6989586621679399974"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399974"><span class="hs-identifier hs-var">align</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; m (Array a)) -&gt; Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNWith"><span class="hs-identifier hs-var">writeNWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Int -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArrayAligned"><span class="hs-identifier hs-var">newArrayAligned</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399974"><span class="hs-identifier hs-var">align</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1689"></span><span>
</span><span id="line-1690"></span><span class="hs-comment">-- | @writeNAlignedUnmanaged align n@ folds a maximum of @n@ elements from the</span><span>
</span><span id="line-1691"></span><span class="hs-comment">-- input stream to an 'Array' whose starting address is aligned to @align@</span><span>
</span><span id="line-1692"></span><span class="hs-comment">-- bytes and is allocated using unmanaged memory (never freed).  This could be</span><span>
</span><span id="line-1693"></span><span class="hs-comment">-- useful to allocate memory that we need to allocate only once in the lifetime</span><span>
</span><span id="line-1694"></span><span class="hs-comment">-- of the program.</span><span>
</span><span id="line-1695"></span><span class="hs-comment">--</span><span>
</span><span id="line-1696"></span><span class="hs-comment">-- &gt;&gt;&gt; f = Array.newArrayAlignedUnmanaged</span><span>
</span><span id="line-1697"></span><span class="hs-comment">-- &gt;&gt;&gt; writeNAlignedUnmanaged a = Array.writeNWith (f a)</span><span>
</span><span id="line-1698"></span><span class="hs-comment">-- &gt;&gt;&gt; writeNAlignedUnmanaged a n = Array.appendN (f a n) n</span><span>
</span><span id="line-1699"></span><span class="hs-comment">--</span><span>
</span><span id="line-1700"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-1701"></span><span class="hs-comment">--</span><span>
</span><span id="line-1702"></span><span class="hs-pragma">{-# INLINE_NORMAL writeNAlignedUnmanaged #-}</span><span>
</span><span id="line-1703"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNAlignedUnmanaged"><span class="hs-identifier hs-type">writeNAlignedUnmanaged</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679399973"><span class="annot"><a href="#local-6989586621679399973"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679399972"><span class="annot"><a href="#local-6989586621679399972"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679399973"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679399972"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1704"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399973"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399972"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399972"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1705"></span><span id="writeNAlignedUnmanaged"><span class="annot"><span class="annottext">writeNAlignedUnmanaged :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNAlignedUnmanaged"><span class="hs-identifier hs-var hs-var">writeNAlignedUnmanaged</span></a></span></span><span> </span><span id="local-6989586621679399965"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399965"><span class="hs-identifier hs-var">align</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; m (Array a)) -&gt; Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNWith"><span class="hs-identifier hs-var">writeNWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Int -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArrayAlignedUnmanaged"><span class="hs-identifier hs-var">newArrayAlignedUnmanaged</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399965"><span class="hs-identifier hs-var">align</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1706"></span><span>
</span><span id="line-1707"></span><span class="hs-comment">-- XXX We can carry bound as well in the state to make sure we do not lose the</span><span>
</span><span id="line-1708"></span><span class="hs-comment">-- remaining capacity. Need to check perf impact.</span><span>
</span><span id="line-1709"></span><span class="hs-comment">--</span><span>
</span><span id="line-1710"></span><span class="hs-comment">-- | Like 'writeNUnsafe' but takes a new array allocator @alloc size@ function</span><span>
</span><span id="line-1711"></span><span class="hs-comment">-- as argument.</span><span>
</span><span id="line-1712"></span><span class="hs-comment">--</span><span>
</span><span id="line-1713"></span><span class="hs-comment">-- &gt;&gt;&gt; writeNWithUnsafe alloc n = Array.appendNUnsafe (alloc n) n</span><span>
</span><span id="line-1714"></span><span class="hs-comment">--</span><span>
</span><span id="line-1715"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-1716"></span><span class="hs-pragma">{-# INLINE_NORMAL writeNWithUnsafe #-}</span><span>
</span><span id="line-1717"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNWithUnsafe"><span class="hs-identifier hs-type">writeNWithUnsafe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679399964"><span class="annot"><a href="#local-6989586621679399964"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679399963"><span class="annot"><a href="#local-6989586621679399963"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679399964"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679399963"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1718"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679399964"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399963"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399964"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399963"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399963"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1719"></span><span id="writeNWithUnsafe"><span class="annot"><span class="annottext">writeNWithUnsafe :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; m (Array a)) -&gt; Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNWithUnsafe"><span class="hs-identifier hs-var hs-var">writeNWithUnsafe</span></a></span></span><span> </span><span id="local-6989586621679399954"><span class="annot"><span class="annottext">Int -&gt; m (Array a)
</span><a href="#local-6989586621679399954"><span class="hs-identifier hs-var">alloc</span></a></span></span><span> </span><span id="local-6989586621679399953"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399953"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b s.
(s -&gt; a -&gt; m (Step s b))
-&gt; m (Step s b) -&gt; (s -&gt; m b) -&gt; Fold m a b
</span><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier hs-var">Fold</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a} {b}.
(MonadIO m, Storable a) =&gt;
ArrayUnsafe a -&gt; a -&gt; m (Step (ArrayUnsafe a) b)
</span><a href="#local-6989586621679399951"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">forall {b}. m (Step (ArrayUnsafe a) b)
</span><a href="#local-6989586621679399950"><span class="hs-identifier hs-var">initial</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a. ArrayUnsafe a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromArrayUnsafe"><span class="hs-identifier hs-var">fromArrayUnsafe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1720"></span><span>
</span><span id="line-1721"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1722"></span><span>
</span><span id="line-1723"></span><span>    </span><span id="local-6989586621679399950"><span class="annot"><span class="annottext">initial :: m (Step (ArrayUnsafe a) b)
</span><a href="#local-6989586621679399950"><span class="hs-identifier hs-var hs-var">initial</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall s b. s -&gt; Step s b
</span><a href="Streamly.Internal.Data.Fold.Step.html#Partial"><span class="hs-identifier hs-var">FL.Partial</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; ArrayUnsafe a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#toArrayUnsafe"><span class="hs-identifier hs-var">toArrayUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; m (Array a)
</span><a href="#local-6989586621679399954"><span class="hs-identifier hs-var">alloc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399953"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-1724"></span><span>
</span><span id="line-1725"></span><span>    </span><span id="local-6989586621679399951"><span class="annot"><span class="annottext">step :: ArrayUnsafe a -&gt; a -&gt; m (Step (ArrayUnsafe a) b)
</span><a href="#local-6989586621679399951"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayUnsafe"><span class="hs-identifier hs-type">ArrayUnsafe</span></a></span><span> </span><span id="local-6989586621679399934"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679399934"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679399933"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399933"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679399932"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399932"><span class="hs-identifier hs-var">end</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679399931"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679399931"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1726"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">poke</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399932"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679399931"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679399934"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-1727"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-1728"></span><span>          </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s b. s -&gt; Step s b
</span><a href="Streamly.Internal.Data.Fold.Step.html#Partial"><span class="hs-identifier hs-var">FL.Partial</span></a></span><span>
</span><span id="line-1729"></span><span>          </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; ArrayUnsafe a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ArrayUnsafe"><span class="hs-identifier hs-var">ArrayUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679399934"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399933"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399932"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679399963"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1730"></span><span>
</span><span id="line-1731"></span><span class="hs-comment">-- | Like 'writeN' but does not check the array bounds when writing. The fold</span><span>
</span><span id="line-1732"></span><span class="hs-comment">-- driver must not call the step function more than 'n' times otherwise it will</span><span>
</span><span id="line-1733"></span><span class="hs-comment">-- corrupt the memory and crash. This function exists mainly because any</span><span>
</span><span id="line-1734"></span><span class="hs-comment">-- conditional in the step function blocks fusion causing 10x performance</span><span>
</span><span id="line-1735"></span><span class="hs-comment">-- slowdown.</span><span>
</span><span id="line-1736"></span><span class="hs-comment">--</span><span>
</span><span id="line-1737"></span><span class="hs-comment">-- &gt;&gt;&gt; writeNUnsafe = Array.writeNWithUnsafe Array.newArray</span><span>
</span><span id="line-1738"></span><span class="hs-comment">--</span><span>
</span><span id="line-1739"></span><span class="hs-comment">-- @since 0.7.0</span><span>
</span><span id="line-1740"></span><span class="hs-pragma">{-# INLINE_NORMAL writeNUnsafe #-}</span><span>
</span><span id="line-1741"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNUnsafe"><span class="hs-identifier hs-type">writeNUnsafe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679399930"><span class="annot"><a href="#local-6989586621679399930"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679399929"><span class="annot"><a href="#local-6989586621679399929"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679399930"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679399929"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1742"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399930"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399929"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399929"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1743"></span><span id="writeNUnsafe"><span class="annot"><span class="annottext">writeNUnsafe :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNUnsafe"><span class="hs-identifier hs-var hs-var">writeNUnsafe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; m (Array a)) -&gt; Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeNWithUnsafe"><span class="hs-identifier hs-var">writeNWithUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArray"><span class="hs-identifier hs-var">newArray</span></a></span><span>
</span><span id="line-1744"></span><span>
</span><span id="line-1745"></span><span class="hs-comment">-- XXX Buffer to a list instead?</span><span>
</span><span id="line-1746"></span><span class="hs-comment">--</span><span>
</span><span id="line-1747"></span><span class="hs-comment">-- | Buffer a stream into a stream of arrays.</span><span>
</span><span id="line-1748"></span><span class="hs-comment">--</span><span>
</span><span id="line-1749"></span><span class="hs-comment">-- &gt;&gt;&gt; writeChunks n = Fold.many (Array.writeN n) Fold.toStreamK</span><span>
</span><span id="line-1750"></span><span class="hs-comment">--</span><span>
</span><span id="line-1751"></span><span class="hs-comment">-- Breaking an array into an array stream  can be useful to consume a large</span><span>
</span><span id="line-1752"></span><span class="hs-comment">-- array sequentially such that memory of the array is released incrementatlly.</span><span>
</span><span id="line-1753"></span><span class="hs-comment">--</span><span>
</span><span id="line-1754"></span><span class="hs-comment">-- See also: 'arrayStreamKFromStreamD'.</span><span>
</span><span id="line-1755"></span><span class="hs-comment">--</span><span>
</span><span id="line-1756"></span><span class="hs-comment">-- /Unimplemented/</span><span>
</span><span id="line-1757"></span><span class="hs-comment">--</span><span>
</span><span id="line-1758"></span><span class="hs-pragma">{-# INLINE_NORMAL writeChunks #-}</span><span>
</span><span id="line-1759"></span><span id="local-6989586621679401552"><span id="local-6989586621679401553"><span id="local-6989586621679401554"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeChunks"><span class="hs-identifier hs-type">writeChunks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401554"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401553"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1760"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401554"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401553"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">K.Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401552"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401553"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1761"></span><span id="writeChunks"><span class="annot"><span class="annottext">writeChunks :: forall (m :: * -&gt; *) a (n :: * -&gt; *).
(MonadIO m, Storable a) =&gt;
Int -&gt; Fold m a (Stream n (Array a))
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeChunks"><span class="hs-identifier hs-var hs-var">writeChunks</span></a></span></span><span> </span><span id="local-6989586621679399915"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399915"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b c.
Monad m =&gt;
Fold m a b -&gt; Fold m b c -&gt; Fold m a c
</span><a href="Streamly.Internal.Data.Fold.Type.html#many"><span class="hs-identifier hs-var">FL.many</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeN"><span class="hs-identifier hs-var">writeN</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399915"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a (n :: * -&gt; *).
Monad m =&gt;
Fold m a (Stream n a)
</span><a href="Streamly.Internal.Data.Fold.Type.html#toStreamK"><span class="hs-identifier hs-var">FL.toStreamK</span></a></span><span>
</span><span id="line-1762"></span><span>
</span><span id="line-1763"></span><span class="hs-comment">-- XXX Compare writeWith with fromStreamD which uses an array of streams</span><span>
</span><span id="line-1764"></span><span class="hs-comment">-- implementation. We can write this using writeChunks above if that is faster.</span><span>
</span><span id="line-1765"></span><span class="hs-comment">-- If writeWith is faster then we should use that to implement</span><span>
</span><span id="line-1766"></span><span class="hs-comment">-- fromStreamD.</span><span>
</span><span id="line-1767"></span><span class="hs-comment">--</span><span>
</span><span id="line-1768"></span><span class="hs-comment">-- XXX The realloc based implementation needs to make one extra copy if we use</span><span>
</span><span id="line-1769"></span><span class="hs-comment">-- shrinkToFit.  On the other hand, the stream of arrays implementation may</span><span>
</span><span id="line-1770"></span><span class="hs-comment">-- buffer the array chunk pointers in memory but it does not have to shrink as</span><span>
</span><span id="line-1771"></span><span class="hs-comment">-- we know the exact size in the end. However, memory copying does not seem to</span><span>
</span><span id="line-1772"></span><span class="hs-comment">-- be as expensive as the allocations. Therefore, we need to reduce the number</span><span>
</span><span id="line-1773"></span><span class="hs-comment">-- of allocations instead. Also, the size of allocations matters, right sizing</span><span>
</span><span id="line-1774"></span><span class="hs-comment">-- an allocation even at the cost of copying sems to help.  Should be measured</span><span>
</span><span id="line-1775"></span><span class="hs-comment">-- on a big stream with heavy calls to toArray to see the effect.</span><span>
</span><span id="line-1776"></span><span class="hs-comment">--</span><span>
</span><span id="line-1777"></span><span class="hs-comment">-- XXX check if GHC's memory allocator is efficient enough. We can try the C</span><span>
</span><span id="line-1778"></span><span class="hs-comment">-- malloc to compare against.</span><span>
</span><span id="line-1779"></span><span>
</span><span id="line-1780"></span><span class="hs-comment">-- | @writeWith minCount@ folds the whole input to a single array. The array</span><span>
</span><span id="line-1781"></span><span class="hs-comment">-- starts at a size big enough to hold minCount elements, the size is doubled</span><span>
</span><span id="line-1782"></span><span class="hs-comment">-- every time the array needs to be grown.</span><span>
</span><span id="line-1783"></span><span class="hs-comment">--</span><span>
</span><span id="line-1784"></span><span class="hs-comment">-- /Caution! Do not use this on infinite streams./</span><span>
</span><span id="line-1785"></span><span class="hs-comment">--</span><span>
</span><span id="line-1786"></span><span class="hs-comment">-- &gt;&gt;&gt; f n = Array.appendWith (* 2) (Array.newArray n)</span><span>
</span><span id="line-1787"></span><span class="hs-comment">-- &gt;&gt;&gt; writeWith n = Fold.rmapM Array.rightSize (f n)</span><span>
</span><span id="line-1788"></span><span class="hs-comment">-- &gt;&gt;&gt; writeWith n = Fold.rmapM Array.fromArrayStreamK (Array.writeChunks n)</span><span>
</span><span id="line-1789"></span><span class="hs-comment">--</span><span>
</span><span id="line-1790"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-1791"></span><span class="hs-pragma">{-# INLINE_NORMAL writeWith #-}</span><span>
</span><span id="line-1792"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeWith"><span class="hs-identifier hs-type">writeWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679399912"><span class="annot"><a href="#local-6989586621679399912"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679399911"><span class="annot"><a href="#local-6989586621679399911"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679399912"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679399911"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1793"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399912"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399911"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399911"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1794"></span><span class="hs-comment">-- writeWith n = FL.rmapM rightSize $ appendWith (* 2) (newArray n)</span><span>
</span><span id="line-1795"></span><span id="writeWith"><span class="annot"><span class="annottext">writeWith :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeWith"><span class="hs-identifier hs-var hs-var">writeWith</span></a></span></span><span> </span><span id="local-6989586621679399902"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399902"><span class="hs-identifier hs-var">elemCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1796"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; Fold m a b -&gt; Fold m a c
</span><a href="Streamly.Internal.Data.Fold.Type.html#rmapM"><span class="hs-identifier hs-var">FL.rmapM</span></a></span><span> </span><span class="annot"><span class="annottext">Array a -&gt; m (Array a)
</span><a href="#local-6989586621679399900"><span class="hs-identifier hs-var">extract</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b a.
Monad m =&gt;
(b -&gt; a -&gt; m b) -&gt; m b -&gt; Fold m a b
</span><a href="Streamly.Internal.Data.Fold.Type.html#foldlM%27"><span class="hs-identifier hs-var">FL.foldlM'</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; a -&gt; m (Array a)
</span><a href="#local-6989586621679399899"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">m (Array a)
</span><a href="#local-6989586621679399898"><span class="hs-identifier hs-var">initial</span></a></span><span>
</span><span id="line-1797"></span><span>
</span><span id="line-1798"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1799"></span><span>
</span><span id="line-1800"></span><span>    </span><span id="local-6989586621679399890"><span class="annot"><span class="annottext">insertElem :: Array a -&gt; a -&gt; m (Array a)
</span><a href="#local-6989586621679399890"><span class="hs-identifier hs-var hs-var">insertElem</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621679399889"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679399889"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679399888"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399888"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679399887"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399887"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679399886"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399886"><span class="hs-identifier hs-var">bound</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679399885"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679399885"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1801"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">poke</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399887"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679399885"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1802"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399881"><span class="annot"><span class="annottext">end1 :: Ptr b
</span><a href="#local-6989586621679399881"><span class="hs-identifier hs-var hs-var">end1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399887"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679399911"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1803"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; Ptr a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679399889"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399888"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679399881"><span class="hs-identifier hs-var">end1</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399886"><span class="hs-identifier hs-var">bound</span></a></span><span>
</span><span id="line-1804"></span><span>
</span><span id="line-1805"></span><span>    </span><span id="local-6989586621679399898"><span class="annot"><span class="annottext">initial :: m (Array a)
</span><a href="#local-6989586621679399898"><span class="hs-identifier hs-var hs-var">initial</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1806"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399902"><span class="hs-identifier hs-var">elemCount</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;writeWith: elemCount is negative&quot;</span></span><span>
</span><span id="line-1807"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Int -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArrayAligned"><span class="hs-identifier hs-var">newArrayAligned</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">alignment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679399911"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399902"><span class="hs-identifier hs-var">elemCount</span></a></span><span>
</span><span id="line-1808"></span><span>    </span><span id="local-6989586621679399899"><span class="annot"><span class="annottext">step :: Array a -&gt; a -&gt; m (Array a)
</span><a href="#local-6989586621679399899"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span id="local-6989586621679399849"><span class="annot"><span class="annottext">arr :: Array a
</span><a href="#local-6989586621679399849"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679399848"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399848"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679399847"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399847"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679399846"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399846"><span class="hs-identifier hs-var">bound</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679399845"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679399845"><span class="hs-identifier hs-var">x</span></a></span></span><span>
</span><span id="line-1809"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399847"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679399911"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399846"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1810"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399843"><span class="annot"><span class="annottext">oldSize :: Int
</span><a href="#local-6989586621679399843"><span class="hs-identifier hs-var hs-var">oldSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399847"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b -&gt; Int
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399848"><span class="hs-identifier hs-var">start</span></a></span><span>
</span><span id="line-1811"></span><span>            </span><span id="local-6989586621679399838"><span class="annot"><span class="annottext">newSize :: Int
</span><a href="#local-6989586621679399838"><span class="hs-identifier hs-var hs-var">newSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399843"><span class="hs-identifier hs-var">oldSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1812"></span><span>        </span><span id="local-6989586621679399837"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399837"><span class="hs-identifier hs-var">arr1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1813"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span>
</span><span id="line-1814"></span><span>                </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Int -&gt; Int -&gt; Int -&gt; Array a -&gt; IO (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#reallocAligned"><span class="hs-identifier hs-var">reallocAligned</span></a></span><span>
</span><span id="line-1815"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679399911"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1816"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">alignment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679399911"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1817"></span><span>                    </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399838"><span class="hs-identifier hs-var">newSize</span></a></span><span>
</span><span id="line-1818"></span><span>                    </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399849"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-1819"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; a -&gt; m (Array a)
</span><a href="#local-6989586621679399890"><span class="hs-identifier hs-var">insertElem</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399837"><span class="hs-identifier hs-var">arr1</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679399845"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1820"></span><span>    </span><span class="annot"><a href="#local-6989586621679399899"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span id="local-6989586621679399836"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399836"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621679399835"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679399835"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; a -&gt; m (Array a)
</span><a href="#local-6989586621679399890"><span class="hs-identifier hs-var">insertElem</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399836"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679399835"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1821"></span><span>    </span><span id="local-6989586621679399900"><span class="annot"><span class="annottext">extract :: Array a -&gt; m (Array a)
</span><a href="#local-6989586621679399900"><span class="hs-identifier hs-var hs-var">extract</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#rightSize"><span class="hs-identifier hs-var">rightSize</span></a></span><span>
</span><span id="line-1822"></span><span>
</span><span id="line-1823"></span><span class="hs-comment">-- | Fold the whole input to a single array.</span><span>
</span><span id="line-1824"></span><span class="hs-comment">--</span><span>
</span><span id="line-1825"></span><span class="hs-comment">-- Same as 'writeWith' using an initial array size of 'arrayChunkBytes' bytes</span><span>
</span><span id="line-1826"></span><span class="hs-comment">-- rounded up to the element size.</span><span>
</span><span id="line-1827"></span><span class="hs-comment">--</span><span>
</span><span id="line-1828"></span><span class="hs-comment">-- /Caution! Do not use this on infinite streams./</span><span>
</span><span id="line-1829"></span><span class="hs-comment">--</span><span>
</span><span id="line-1830"></span><span class="hs-comment">-- @since 0.7.0</span><span>
</span><span id="line-1831"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#write"><span class="hs-pragma hs-type">write</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1832"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#write"><span class="hs-identifier hs-type">write</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401531"><span class="annot"><a href="#local-6989586621679401531"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401530"><span class="annot"><a href="#local-6989586621679401530"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401531"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401530"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401531"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401530"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401530"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1833"></span><span id="write"><span class="annot"><span class="annottext">write :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#write"><span class="hs-identifier hs-var hs-var">write</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#writeWith"><span class="hs-identifier hs-var">writeWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#allocBytesToElemCount"><span class="hs-identifier hs-var">allocBytesToElemCount</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401530"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrayChunkBytes"><span class="hs-identifier hs-var">arrayChunkBytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1834"></span><span>
</span><span id="line-1835"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1836"></span><span class="hs-comment">-- construct from streams, known size</span><span>
</span><span id="line-1837"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1838"></span><span>
</span><span id="line-1839"></span><span class="hs-comment">-- | Use the 'writeN' fold instead.</span><span>
</span><span id="line-1840"></span><span class="hs-comment">--</span><span>
</span><span id="line-1841"></span><span class="hs-comment">-- &gt;&gt;&gt; fromStreamDN n = StreamD.fold (Array.writeN n)</span><span>
</span><span id="line-1842"></span><span class="hs-comment">--</span><span>
</span><span id="line-1843"></span><span class="hs-pragma">{-# INLINE_NORMAL fromStreamDN #-}</span><span>
</span><span id="line-1844"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromStreamDN"><span class="hs-identifier hs-type">fromStreamDN</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401527"><span class="annot"><a href="#local-6989586621679401527"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401526"><span class="annot"><a href="#local-6989586621679401526"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401527"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401526"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1845"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">D.Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401527"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401526"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401527"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401526"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1846"></span><span class="hs-comment">-- fromStreamDN n = D.fold (writeN n)</span><span>
</span><span id="line-1847"></span><span id="fromStreamDN"><span class="annot"><span class="annottext">fromStreamDN :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Stream m a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromStreamDN"><span class="hs-identifier hs-var hs-var">fromStreamDN</span></a></span></span><span> </span><span id="local-6989586621679399809"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399809"><span class="hs-identifier hs-var">limit</span></a></span></span><span> </span><span id="local-6989586621679399808"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679399808"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1848"></span><span>    </span><span id="local-6989586621679399807"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399807"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArray"><span class="hs-identifier hs-var">newArray</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399809"><span class="hs-identifier hs-var">limit</span></a></span><span>
</span><span id="line-1849"></span><span>    </span><span id="local-6989586621679399806"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399806"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b a.
Monad m =&gt;
(b -&gt; a -&gt; m b) -&gt; m b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#foldlM%27"><span class="hs-identifier hs-var">D.foldlM'</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a} {b}.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; a -&gt; m (Ptr b)
</span><a href="#local-6989586621679399804"><span class="hs-identifier hs-var">fwrite</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399807"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
Applicative m =&gt;
Int -&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#take"><span class="hs-identifier hs-var">D.take</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399809"><span class="hs-identifier hs-var">limit</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679399808"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-1850"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399807"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">aEnd :: Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399806"><span class="hs-identifier hs-var">end</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-1851"></span><span>
</span><span id="line-1852"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1853"></span><span>
</span><span id="line-1854"></span><span>    </span><span id="local-6989586621679399804"><span class="annot"><span class="annottext">fwrite :: Ptr a -&gt; a -&gt; m (Ptr b)
</span><a href="#local-6989586621679399804"><span class="hs-identifier hs-var hs-var">fwrite</span></a></span></span><span> </span><span id="local-6989586621679399792"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399792"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span id="local-6989586621679399791"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679399791"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1855"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">poke</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399792"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679399791"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1856"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399792"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401526"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1857"></span><span>
</span><span id="line-1858"></span><span class="hs-comment">-- | Create an 'Array' from the first N elements of a list. The array is</span><span>
</span><span id="line-1859"></span><span class="hs-comment">-- allocated to size N, if the list terminates before N elements then the</span><span>
</span><span id="line-1860"></span><span class="hs-comment">-- array may hold less than N elements.</span><span>
</span><span id="line-1861"></span><span class="hs-comment">--</span><span>
</span><span id="line-1862"></span><span class="hs-comment">-- @since 0.7.0</span><span>
</span><span id="line-1863"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromListN"><span class="hs-pragma hs-type">fromListN</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1864"></span><span id="local-6989586621679401514"><span id="local-6989586621679401515"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromListN"><span class="hs-identifier hs-type">fromListN</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401515"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401514"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679401514"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401515"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401514"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1865"></span><span id="fromListN"><span class="annot"><span class="annottext">fromListN :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; [a] -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromListN"><span class="hs-identifier hs-var hs-var">fromListN</span></a></span></span><span> </span><span id="local-6989586621679399783"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399783"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679399782"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679399782"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Stream m a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromStreamDN"><span class="hs-identifier hs-var">fromStreamDN</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399783"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Applicative m =&gt; [a] -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#fromList"><span class="hs-identifier hs-var">D.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679399782"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-1866"></span><span>
</span><span id="line-1867"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1868"></span><span class="hs-comment">-- convert stream to a single array</span><span>
</span><span id="line-1869"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1870"></span><span>
</span><span id="line-1871"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrayStreamKLength"><span class="hs-pragma hs-type">arrayStreamKLength</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1872"></span><span id="local-6989586621679401508"><span id="local-6989586621679401509"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrayStreamKLength"><span class="hs-identifier hs-type">arrayStreamKLength</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679401509"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401508"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">K.Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401509"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401508"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401509"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span></span></span><span>
</span><span id="line-1873"></span><span id="arrayStreamKLength"><span class="annot"><span class="annottext">arrayStreamKLength :: forall (m :: * -&gt; *) a.
(Monad m, Storable a) =&gt;
Stream m (Array a) -&gt; m Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrayStreamKLength"><span class="hs-identifier hs-var hs-var">arrayStreamKLength</span></a></span></span><span> </span><span id="local-6989586621679399773"><span class="annot"><span class="annottext">Stream m (Array a)
</span><a href="#local-6989586621679399773"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b a.
Monad m =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#foldl%27"><span class="hs-identifier hs-var">K.foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(+)</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b (m :: * -&gt; *). (a -&gt; b) -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#map"><span class="hs-identifier hs-var">K.map</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Array a -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (Array a)
</span><a href="#local-6989586621679399773"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1874"></span><span>
</span><span id="line-1875"></span><span class="hs-comment">-- | Convert an array stream to an array. Note that this requires peak memory</span><span>
</span><span id="line-1876"></span><span class="hs-comment">-- that is double the size of the array stream.</span><span>
</span><span id="line-1877"></span><span class="hs-comment">--</span><span>
</span><span id="line-1878"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromArrayStreamK"><span class="hs-pragma hs-type">fromArrayStreamK</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1879"></span><span id="local-6989586621679401498"><span id="local-6989586621679401499"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromArrayStreamK"><span class="hs-identifier hs-type">fromArrayStreamK</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401499"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401498"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1880"></span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamK.Type.html#Stream"><span class="hs-identifier hs-type">K.Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401498"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401499"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401498"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401499"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1881"></span><span id="fromArrayStreamK"><span class="annot"><span class="annottext">fromArrayStreamK :: forall a (m :: * -&gt; *).
(Storable a, MonadIO m) =&gt;
Stream m (Array a) -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromArrayStreamK"><span class="hs-identifier hs-var hs-var">fromArrayStreamK</span></a></span></span><span> </span><span id="local-6989586621679399757"><span class="annot"><span class="annottext">Stream m (Array a)
</span><a href="#local-6989586621679399757"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1882"></span><span>    </span><span id="local-6989586621679399756"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399756"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(Monad m, Storable a) =&gt;
Stream m (Array a) -&gt; m Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrayStreamKLength"><span class="hs-identifier hs-var">arrayStreamKLength</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (Array a)
</span><a href="#local-6989586621679399757"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-1883"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Stream m a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromStreamDN"><span class="hs-identifier hs-var">fromStreamDN</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399756"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
Monad m =&gt;
Unfold m a b -&gt; Stream m a -&gt; Stream m b
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#unfoldMany"><span class="hs-identifier hs-var">D.unfoldMany</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Unfold m (Array a) a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#read"><span class="hs-identifier hs-var">read</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Applicative m =&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#fromStreamK"><span class="hs-identifier hs-var">D.fromStreamK</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m (Array a)
</span><a href="#local-6989586621679399757"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-1884"></span><span>
</span><span id="line-1885"></span><span class="hs-comment">-- CAUTION: a very large number (millions) of arrays can degrade performance</span><span>
</span><span id="line-1886"></span><span class="hs-comment">-- due to GC overhead because we need to buffer the arrays before we flatten</span><span>
</span><span id="line-1887"></span><span class="hs-comment">-- all the arrays.</span><span>
</span><span id="line-1888"></span><span class="hs-comment">--</span><span>
</span><span id="line-1889"></span><span class="hs-comment">-- XXX Compare if this is faster or &quot;fold write&quot;.</span><span>
</span><span id="line-1890"></span><span class="hs-comment">--</span><span>
</span><span id="line-1891"></span><span class="hs-comment">-- | We could take the approach of doubling the memory allocation on each</span><span>
</span><span id="line-1892"></span><span class="hs-comment">-- overflow. This would result in more or less the same amount of copying as in</span><span>
</span><span id="line-1893"></span><span class="hs-comment">-- the chunking approach. However, if we have to shrink in the end then it may</span><span>
</span><span id="line-1894"></span><span class="hs-comment">-- result in an extra copy of the entire data.</span><span>
</span><span id="line-1895"></span><span class="hs-comment">--</span><span>
</span><span id="line-1896"></span><span class="hs-comment">-- &gt;&gt;&gt; fromStreamD = StreamD.fold Array.write</span><span>
</span><span id="line-1897"></span><span class="hs-comment">--</span><span>
</span><span id="line-1898"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromStreamD"><span class="hs-pragma hs-type">fromStreamD</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1899"></span><span id="local-6989586621679401489"><span id="local-6989586621679401490"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromStreamD"><span class="hs-identifier hs-type">fromStreamD</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401490"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401489"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#Stream"><span class="hs-identifier hs-type">D.Stream</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401490"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401489"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401490"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401489"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1900"></span><span id="fromStreamD"><span class="annot"><span class="annottext">fromStreamD :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Stream m a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromStreamD"><span class="hs-identifier hs-var hs-var">fromStreamD</span></a></span></span><span> </span><span id="local-6989586621679399745"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679399745"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Stream m a -&gt; m (Stream m (Array a))
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrayStreamKFromStreamD"><span class="hs-identifier hs-var">arrayStreamKFromStreamD</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679399745"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *).
(Storable a, MonadIO m) =&gt;
Stream m (Array a) -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromArrayStreamK"><span class="hs-identifier hs-var">fromArrayStreamK</span></a></span><span>
</span><span id="line-1901"></span><span>
</span><span id="line-1902"></span><span class="hs-comment">-- | Create an 'Array' from a list. The list must be of finite size.</span><span>
</span><span id="line-1903"></span><span class="hs-comment">--</span><span>
</span><span id="line-1904"></span><span class="hs-comment">-- @since 0.7.0</span><span>
</span><span id="line-1905"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromList"><span class="hs-pragma hs-type">fromList</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1906"></span><span id="local-6989586621679401483"><span id="local-6989586621679401484"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromList"><span class="hs-identifier hs-type">fromList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401484"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401483"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679401483"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401484"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401483"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1907"></span><span id="fromList"><span class="annot"><span class="annottext">fromList :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
[a] -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromList"><span class="hs-identifier hs-var hs-var">fromList</span></a></span></span><span> </span><span id="local-6989586621679399737"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679399737"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Stream m a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#fromStreamD"><span class="hs-identifier hs-var">fromStreamD</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Applicative m =&gt; [a] -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#fromList"><span class="hs-identifier hs-var">D.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679399737"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-1908"></span><span>
</span><span id="line-1909"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1910"></span><span class="hs-comment">-- Combining</span><span>
</span><span id="line-1911"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-1912"></span><span>
</span><span id="line-1913"></span><span class="hs-comment">-- | Copy two arrays into a newly allocated array.</span><span>
</span><span id="line-1914"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#spliceCopy"><span class="hs-pragma hs-type">spliceCopy</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1915"></span><span id="local-6989586621679401479"><span id="local-6989586621679401480"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#spliceCopy"><span class="hs-identifier hs-type">spliceCopy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401480"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401479"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401479"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401479"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401480"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401479"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1916"></span><span id="spliceCopy"><span class="annot"><span class="annottext">spliceCopy :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#spliceCopy"><span class="hs-identifier hs-var hs-var">spliceCopy</span></a></span></span><span> </span><span id="local-6989586621679399721"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399721"><span class="hs-identifier hs-var">arr1</span></a></span></span><span> </span><span id="local-6989586621679399720"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399720"><span class="hs-identifier hs-var">arr2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1917"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399719"><span class="annot"><span class="annottext">src1 :: Ptr a
</span><a href="#local-6989586621679399719"><span class="hs-identifier hs-var hs-var">src1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399721"><span class="hs-identifier hs-var">arr1</span></a></span><span>
</span><span id="line-1918"></span><span>        </span><span id="local-6989586621679399718"><span class="annot"><span class="annottext">src2 :: Ptr a
</span><a href="#local-6989586621679399718"><span class="hs-identifier hs-var hs-var">src2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399720"><span class="hs-identifier hs-var">arr2</span></a></span><span>
</span><span id="line-1919"></span><span>        </span><span id="local-6989586621679399717"><span class="annot"><span class="annottext">len1 :: Int
</span><a href="#local-6989586621679399717"><span class="hs-identifier hs-var hs-var">len1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399721"><span class="hs-identifier hs-var">arr1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b -&gt; Int
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399719"><span class="hs-identifier hs-var">src1</span></a></span><span>
</span><span id="line-1920"></span><span>        </span><span id="local-6989586621679399716"><span class="annot"><span class="annottext">len2 :: Int
</span><a href="#local-6989586621679399716"><span class="hs-identifier hs-var hs-var">len2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399720"><span class="hs-identifier hs-var">arr2</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b -&gt; Int
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399718"><span class="hs-identifier hs-var">src2</span></a></span><span>
</span><span id="line-1921"></span><span>
</span><span id="line-1922"></span><span>    </span><span id="local-6989586621679399715"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399715"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArray"><span class="hs-identifier hs-var">newArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399717"><span class="hs-identifier hs-var">len1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399716"><span class="hs-identifier hs-var">len2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1923"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399714"><span class="annot"><span class="annottext">dst :: Ptr a
</span><a href="#local-6989586621679399714"><span class="hs-identifier hs-var hs-var">dst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399715"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-1924"></span><span>
</span><span id="line-1925"></span><span>    </span><span class="hs-comment">-- XXX Should we use copyMutableByteArray# instead? Is there an overhead to</span><span>
</span><span id="line-1926"></span><span>    </span><span class="hs-comment">-- ccall?</span><span>
</span><span id="line-1927"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1928"></span><span>        </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Int -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#memcpy"><span class="hs-identifier hs-var">memcpy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399714"><span class="hs-identifier hs-var">dst</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399719"><span class="hs-identifier hs-var">src1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399717"><span class="hs-identifier hs-var">len1</span></a></span><span>
</span><span id="line-1929"></span><span>        </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrContents"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399721"><span class="hs-identifier hs-var">arr1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1930"></span><span>        </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Int -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#memcpy"><span class="hs-identifier hs-var">memcpy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399714"><span class="hs-identifier hs-var">dst</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399717"><span class="hs-identifier hs-var">len1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399718"><span class="hs-identifier hs-var">src2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399716"><span class="hs-identifier hs-var">len2</span></a></span><span>
</span><span id="line-1931"></span><span>        </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrContents"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399720"><span class="hs-identifier hs-var">arr2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1932"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399715"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">aEnd :: Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399714"><span class="hs-identifier hs-var">dst</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399717"><span class="hs-identifier hs-var">len1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399716"><span class="hs-identifier hs-var">len2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1933"></span><span>
</span><span id="line-1934"></span><span class="hs-comment">-- | Really really unsafe, appends the second array into the first array. If</span><span>
</span><span id="line-1935"></span><span class="hs-comment">-- the first array does not have enough space it may cause silent data</span><span>
</span><span id="line-1936"></span><span class="hs-comment">-- corruption or if you are lucky a segfault.</span><span>
</span><span id="line-1937"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#spliceUnsafe"><span class="hs-pragma hs-type">spliceUnsafe</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1938"></span><span id="local-6989586621679401475"><span id="local-6989586621679401476"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#spliceUnsafe"><span class="hs-identifier hs-type">spliceUnsafe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401476"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401475"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401475"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401476"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401475"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1939"></span><span id="spliceUnsafe"><span class="annot"><span class="annottext">spliceUnsafe :: forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Array a -&gt; (Array a, Int) -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#spliceUnsafe"><span class="hs-identifier hs-var hs-var">spliceUnsafe</span></a></span></span><span> </span><span id="local-6989586621679399701"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399701"><span class="hs-identifier hs-var">dst</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679399700"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399700"><span class="hs-identifier hs-var">src</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679399699"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399699"><span class="hs-identifier hs-var">srcLen</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1940"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1941"></span><span>         </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399698"><span class="annot"><span class="annottext">psrc :: Ptr a
</span><a href="#local-6989586621679399698"><span class="hs-identifier hs-var hs-var">psrc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399700"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-1942"></span><span>         </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399697"><span class="annot"><span class="annottext">pdst :: Ptr a
</span><a href="#local-6989586621679399697"><span class="hs-identifier hs-var hs-var">pdst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399701"><span class="hs-identifier hs-var">dst</span></a></span><span>
</span><span id="line-1943"></span><span>         </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399697"><span class="hs-identifier hs-var">pdst</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399699"><span class="hs-identifier hs-var">srcLen</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aBound"><span class="hs-identifier hs-var">aBound</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399701"><span class="hs-identifier hs-var">dst</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1944"></span><span>         </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Int -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#memcpy"><span class="hs-identifier hs-var">memcpy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399697"><span class="hs-identifier hs-var">pdst</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399698"><span class="hs-identifier hs-var">psrc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399699"><span class="hs-identifier hs-var">srcLen</span></a></span><span>
</span><span id="line-1945"></span><span>         </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrContents"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399700"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1946"></span><span>         </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrContents"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399701"><span class="hs-identifier hs-var">dst</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1947"></span><span>         </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399701"><span class="hs-identifier hs-var">dst</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">aEnd :: Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399697"><span class="hs-identifier hs-var">pdst</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399699"><span class="hs-identifier hs-var">srcLen</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-1948"></span><span>
</span><span id="line-1949"></span><span class="hs-comment">-- | @spliceWith sizer dst src@ mutates @dst@ to append @src@. If there is no</span><span>
</span><span id="line-1950"></span><span class="hs-comment">-- reserved space available in @dst@ it is reallocated to a size determined by</span><span>
</span><span id="line-1951"></span><span class="hs-comment">-- the @sizer dstBytesn srcBytes@ function, where @dstBytes@ is the size of the</span><span>
</span><span id="line-1952"></span><span class="hs-comment">-- first array and @srcBytes@ is the size of the second array, in bytes.</span><span>
</span><span id="line-1953"></span><span class="hs-comment">--</span><span>
</span><span id="line-1954"></span><span class="hs-comment">-- Note that the returned array may be a mutated version of first array.</span><span>
</span><span id="line-1955"></span><span class="hs-comment">--</span><span>
</span><span id="line-1956"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-1957"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#spliceWith"><span class="hs-pragma hs-type">spliceWith</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1958"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#spliceWith"><span class="hs-identifier hs-type">spliceWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401472"><span class="annot"><a href="#local-6989586621679401472"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679401471"><span class="annot"><a href="#local-6989586621679401471"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401472"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401471"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1959"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401471"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401471"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401472"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401471"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1960"></span><span id="spliceWith"><span class="annot"><span class="annottext">spliceWith :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; Int -&gt; Int) -&gt; Array a -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#spliceWith"><span class="hs-identifier hs-var hs-var">spliceWith</span></a></span></span><span> </span><span id="local-6989586621679399674"><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
</span><a href="#local-6989586621679399674"><span class="hs-identifier hs-var">sizer</span></a></span></span><span> </span><span id="local-6989586621679399673"><span class="annot"><span class="annottext">dst :: Array a
</span><a href="#local-6989586621679399673"><span class="hs-identifier hs-var">dst</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679399672"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399672"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679399671"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399671"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679399670"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399670"><span class="hs-identifier hs-var">bound</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679399669"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399669"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1961"></span><span class="hs-comment">{-
    let f = appendWith (`sizer` byteLength src) (return dst)
     in D.fold f (toStreamD src)
-}</span><span>
</span><span id="line-1965"></span><span>    </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399671"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399670"><span class="hs-identifier hs-var">bound</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1966"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399668"><span class="annot"><span class="annottext">srcLen :: Int
</span><a href="#local-6989586621679399668"><span class="hs-identifier hs-var hs-var">srcLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399669"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b -&gt; Int
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399669"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-1967"></span><span>
</span><span id="line-1968"></span><span>    </span><span id="local-6989586621679399667"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399667"><span class="hs-identifier hs-var">dst1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1969"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399671"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399668"><span class="hs-identifier hs-var">srcLen</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399670"><span class="hs-identifier hs-var">bound</span></a></span><span>
</span><span id="line-1970"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1971"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399666"><span class="annot"><span class="annottext">oldSize :: Int
</span><a href="#local-6989586621679399666"><span class="hs-identifier hs-var hs-var">oldSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399671"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b -&gt; Int
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399672"><span class="hs-identifier hs-var">start</span></a></span><span>
</span><span id="line-1972"></span><span>                </span><span id="local-6989586621679399665"><span class="annot"><span class="annottext">newSize :: Int
</span><a href="#local-6989586621679399665"><span class="hs-identifier hs-var hs-var">newSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
</span><a href="#local-6989586621679399674"><span class="hs-identifier hs-var">sizer</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399666"><span class="hs-identifier hs-var">oldSize</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399668"><span class="hs-identifier hs-var">srcLen</span></a></span><span>
</span><span id="line-1973"></span><span>            </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399665"><span class="hs-identifier hs-var">newSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399666"><span class="hs-identifier hs-var">oldSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399668"><span class="hs-identifier hs-var">srcLen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1974"></span><span>                </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span>
</span><span id="line-1975"></span><span>                    </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;splice: newSize is less than the total size &quot;</span></span><span>
</span><span id="line-1976"></span><span>                    </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;of arrays being appended. Please check the &quot;</span></span><span>
</span><span id="line-1977"></span><span>                    </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;newSize function passed.&quot;</span></span><span>
</span><span id="line-1978"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#realloc"><span class="hs-identifier hs-var">realloc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399665"><span class="hs-identifier hs-var">newSize</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399673"><span class="hs-identifier hs-var">dst</span></a></span><span>
</span><span id="line-1979"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399673"><span class="hs-identifier hs-var">dst</span></a></span><span>
</span><span id="line-1980"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Array a -&gt; (Array a, Int) -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#spliceUnsafe"><span class="hs-identifier hs-var">spliceUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399667"><span class="hs-identifier hs-var">dst1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399669"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399668"><span class="hs-identifier hs-var">srcLen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1981"></span><span>
</span><span id="line-1982"></span><span class="hs-comment">-- | The first array is mutated to append the second array. If there is no</span><span>
</span><span id="line-1983"></span><span class="hs-comment">-- reserved space available in the first array a new allocation of exact</span><span>
</span><span id="line-1984"></span><span class="hs-comment">-- required size is done.</span><span>
</span><span id="line-1985"></span><span class="hs-comment">--</span><span>
</span><span id="line-1986"></span><span class="hs-comment">-- Note that the returned array may be a mutated version of first array.</span><span>
</span><span id="line-1987"></span><span class="hs-comment">--</span><span>
</span><span id="line-1988"></span><span class="hs-comment">-- &gt;&gt;&gt; splice = Array.spliceWith (+)</span><span>
</span><span id="line-1989"></span><span class="hs-comment">--</span><span>
</span><span id="line-1990"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-1991"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#splice"><span class="hs-pragma hs-type">splice</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1992"></span><span id="local-6989586621679399663"><span id="local-6989586621679399664"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#splice"><span class="hs-identifier hs-type">splice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679399664"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679399663"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399663"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399663"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679399664"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399663"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1993"></span><span id="splice"><span class="annot"><span class="annottext">splice :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#splice"><span class="hs-identifier hs-var hs-var">splice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; Int -&gt; Int) -&gt; Array a -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#spliceWith"><span class="hs-identifier hs-var">spliceWith</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(+)</span></span><span>
</span><span id="line-1994"></span><span>
</span><span id="line-1995"></span><span class="hs-comment">-- | Like 'append' but the growth of the array is exponential. Whenever a new</span><span>
</span><span id="line-1996"></span><span class="hs-comment">-- allocation is required the previous array size is at least doubled.</span><span>
</span><span id="line-1997"></span><span class="hs-comment">--</span><span>
</span><span id="line-1998"></span><span class="hs-comment">-- This is useful to reduce allocations when folding many arrays together.</span><span>
</span><span id="line-1999"></span><span class="hs-comment">--</span><span>
</span><span id="line-2000"></span><span class="hs-comment">-- Note that the returned array may be a mutated version of first array.</span><span>
</span><span id="line-2001"></span><span class="hs-comment">--</span><span>
</span><span id="line-2002"></span><span class="hs-comment">-- &gt;&gt;&gt; spliceExp = Array.spliceWith (\l1 l2 -&gt; max (l1 * 2) (l1 + l2))</span><span>
</span><span id="line-2003"></span><span class="hs-comment">--</span><span>
</span><span id="line-2004"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-2005"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#spliceExp"><span class="hs-pragma hs-type">spliceExp</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-2006"></span><span id="local-6989586621679399656"><span id="local-6989586621679399657"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#spliceExp"><span class="hs-identifier hs-type">spliceExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679399657"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679399656"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399656"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399656"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679399657"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679399656"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-2007"></span><span id="spliceExp"><span class="annot"><span class="annottext">spliceExp :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Array a -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#spliceExp"><span class="hs-identifier hs-var hs-var">spliceExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
(Int -&gt; Int -&gt; Int) -&gt; Array a -&gt; Array a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#spliceWith"><span class="hs-identifier hs-var">spliceWith</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679399647"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399647"><span class="hs-identifier hs-var">l1</span></a></span></span><span> </span><span id="local-6989586621679399646"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399646"><span class="hs-identifier hs-var">l2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399647"><span class="hs-identifier hs-var">l1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399647"><span class="hs-identifier hs-var">l1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399646"><span class="hs-identifier hs-var">l2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-2008"></span><span>
</span><span id="line-2009"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-2010"></span><span class="hs-comment">-- Splitting</span><span>
</span><span id="line-2011"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-2012"></span><span>
</span><span id="line-2013"></span><span class="hs-comment">-- | Drops the separator byte</span><span>
</span><span id="line-2014"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#breakOn"><span class="hs-pragma hs-type">breakOn</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-2015"></span><span id="local-6989586621679401464"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#breakOn"><span class="hs-identifier hs-type">breakOn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401464"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-2016"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401464"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-2017"></span><span id="breakOn"><span class="annot"><span class="annottext">breakOn :: forall (m :: * -&gt; *).
MonadIO m =&gt;
Word8 -&gt; Array Word8 -&gt; m (Array Word8, Maybe (Array Word8))
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#breakOn"><span class="hs-identifier hs-var hs-var">breakOn</span></a></span></span><span> </span><span id="local-6989586621679399636"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679399636"><span class="hs-identifier hs-var">sep</span></a></span></span><span> </span><span id="local-6989586621679399635"><span class="annot"><span class="annottext">arr :: Array Word8
</span><a href="#local-6989586621679399635"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679399631"><span id="local-6989586621679399632"><span id="local-6989586621679399633"><span id="local-6989586621679399634"><span class="annot"><span class="annottext">Ptr Word8
ArrayContents
aBound :: Ptr Word8
aEnd :: Ptr Word8
arrStart :: Ptr Word8
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679399631"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2018"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399630"><span class="annot"><span class="annottext">p :: Ptr Word8
</span><a href="#local-6989586621679399630"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679399633"><span class="hs-identifier hs-var">arrStart</span></a></span><span>
</span><span id="line-2019"></span><span>    </span><span id="local-6989586621679399629"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679399629"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Word8 -&gt; CSize -&gt; IO (Ptr Word8)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#c_memchr"><span class="hs-identifier hs-var">c_memchr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679399630"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679399636"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679399632"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b -&gt; Int
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679399630"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2020"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-2021"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679399629"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><span class="hs-identifier hs-var">nullPtr</span></span><span>
</span><span id="line-2022"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Array Word8
</span><a href="#local-6989586621679399635"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-2023"></span><span>        </span><span class="hs-keyword">else</span><span>
</span><span id="line-2024"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span>
</span><span id="line-2025"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">arrContents :: ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrContents"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679399634"><span class="hs-identifier hs-var">arrContents</span></a></span><span>
</span><span id="line-2026"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">arrStart :: Ptr Word8
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679399633"><span class="hs-identifier hs-var">arrStart</span></a></span><span>
</span><span id="line-2027"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">aEnd :: Ptr Word8
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679399629"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-2028"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">aBound :: Ptr Word8
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aBound"><span class="hs-identifier hs-var">aBound</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679399629"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-2029"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-2030"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span>
</span><span id="line-2031"></span><span>                    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">arrContents :: ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrContents"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679399634"><span class="hs-identifier hs-var">arrContents</span></a></span><span>
</span><span id="line-2032"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">arrStart :: Ptr Word8
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679399633"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679399629"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b -&gt; Int
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679399630"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-2033"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">aEnd :: Ptr Word8
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679399632"><span class="hs-identifier hs-var">aEnd</span></a></span><span>
</span><span id="line-2034"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">aBound :: Ptr Word8
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aBound"><span class="hs-identifier hs-var">aBound</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679399631"><span class="hs-identifier hs-var">aBound</span></a></span><span>
</span><span id="line-2035"></span><span>                    </span><span class="hs-special">}</span><span>
</span><span id="line-2036"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-2037"></span><span>
</span><span id="line-2038"></span><span class="hs-comment">-- | Create two slices of an array without copying the original array. The</span><span>
</span><span id="line-2039"></span><span class="hs-comment">-- specified index @i@ is the first index of the second slice.</span><span>
</span><span id="line-2040"></span><span class="hs-comment">--</span><span>
</span><span id="line-2041"></span><span class="hs-comment">-- @since 0.7.0</span><span>
</span><span id="line-2042"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#splitAt"><span class="hs-identifier hs-type">splitAt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401462"><span class="annot"><a href="#local-6989586621679401462"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401462"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401462"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401462"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401462"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2043"></span><span id="splitAt"><span class="annot"><span class="annottext">splitAt :: forall a. Storable a =&gt; Int -&gt; Array a -&gt; (Array a, Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#splitAt"><span class="hs-identifier hs-var hs-var">splitAt</span></a></span></span><span> </span><span id="local-6989586621679399618"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399618"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679399617"><span class="annot"><span class="annottext">arr :: Array a
</span><a href="#local-6989586621679399617"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679399613"><span id="local-6989586621679399614"><span id="local-6989586621679399615"><span id="local-6989586621679399616"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679399613"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2044"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399609"><span class="annot"><span class="annottext">maxIndex :: Int
</span><a href="#local-6989586621679399609"><span class="hs-identifier hs-var hs-var">maxIndex</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Array a -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399617"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-2045"></span><span>    </span><span class="hs-keyword">in</span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399618"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-2046"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;sliceAt: negative array index&quot;</span></span><span>
</span><span id="line-2047"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399618"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399609"><span class="hs-identifier hs-var">maxIndex</span></a></span><span>
</span><span id="line-2048"></span><span>             </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;sliceAt: specified array index &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399618"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-2049"></span><span>                        </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; is beyond the maximum index &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399609"><span class="hs-identifier hs-var">maxIndex</span></a></span><span>
</span><span id="line-2050"></span><span>             </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399604"><span class="annot"><span class="annottext">off :: Int
</span><a href="#local-6989586621679399604"><span class="hs-identifier hs-var hs-var">off</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399618"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401462"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2051"></span><span>                      </span><span id="local-6989586621679399603"><span class="annot"><span class="annottext">p :: Ptr b
</span><a href="#local-6989586621679399603"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399615"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399604"><span class="hs-identifier hs-var">off</span></a></span><span>
</span><span id="line-2052"></span><span>                </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span>
</span><span id="line-2053"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">arrContents :: ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrContents"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679399616"><span class="hs-identifier hs-var">arrContents</span></a></span><span>
</span><span id="line-2054"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">arrStart :: Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399615"><span class="hs-identifier hs-var">arrStart</span></a></span><span>
</span><span id="line-2055"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">aEnd :: Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679399603"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-2056"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">aBound :: Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aBound"><span class="hs-identifier hs-var">aBound</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {a}. Ptr a
</span><a href="#local-6989586621679399603"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-2057"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-2058"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span>
</span><span id="line-2059"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">arrContents :: ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrContents"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679399616"><span class="hs-identifier hs-var">arrContents</span></a></span><span>
</span><span id="line-2060"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">arrStart :: Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399615"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399604"><span class="hs-identifier hs-var">off</span></a></span><span>
</span><span id="line-2061"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">aEnd :: Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399614"><span class="hs-identifier hs-var">aEnd</span></a></span><span>
</span><span id="line-2062"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">aBound :: Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aBound"><span class="hs-identifier hs-var">aBound</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399613"><span class="hs-identifier hs-var">aBound</span></a></span><span>
</span><span id="line-2063"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-2064"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-2065"></span><span>
</span><span id="line-2066"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-2067"></span><span class="hs-comment">-- Casting</span><span>
</span><span id="line-2068"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-2069"></span><span>
</span><span id="line-2070"></span><span class="hs-comment">-- | Cast an array having elements of type @a@ into an array having elements of</span><span>
</span><span id="line-2071"></span><span class="hs-comment">-- type @b@. The array size must be a multiple of the size of type @b@</span><span>
</span><span id="line-2072"></span><span class="hs-comment">-- otherwise accessing the last element of the array may result into a crash or</span><span>
</span><span id="line-2073"></span><span class="hs-comment">-- a random value.</span><span>
</span><span id="line-2074"></span><span class="hs-comment">--</span><span>
</span><span id="line-2075"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-2076"></span><span class="hs-comment">--</span><span>
</span><span id="line-2077"></span><span id="local-6989586621679401458"><span id="local-6989586621679401459"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#castUnsafe"><span class="hs-identifier hs-type">castUnsafe</span></a></span><span> </span><span class="hs-glyph">::</span><span class="hs-cpp">
#ifdef DEVBUILD
</span><span>    </span><span class="hs-identifier">Storable</span><span> </span><span class="hs-identifier">b</span><span> </span><span class="hs-glyph">=&gt;</span><span class="hs-cpp">
#endif
</span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401459"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401458"><span class="hs-identifier hs-type">b</span></a></span></span></span><span>
</span><span id="line-2082"></span><span id="castUnsafe"><span class="annot"><span class="annottext">castUnsafe :: forall a b. Array a -&gt; Array b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#castUnsafe"><span class="hs-identifier hs-var hs-var">castUnsafe</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621679399602"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679399602"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679399601"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399601"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679399600"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399600"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679399599"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399599"><span class="hs-identifier hs-var">bound</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2083"></span><span>    </span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; Ptr a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679399602"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399601"><span class="hs-identifier hs-var">start</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399600"><span class="hs-identifier hs-var">end</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399599"><span class="hs-identifier hs-var">bound</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2084"></span><span>
</span><span id="line-2085"></span><span class="hs-comment">-- | Cast an @Array a@ into an @Array Word8@.</span><span>
</span><span id="line-2086"></span><span class="hs-comment">--</span><span>
</span><span id="line-2087"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-2088"></span><span class="hs-comment">--</span><span>
</span><span id="line-2089"></span><span id="local-6989586621679401456"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#asBytes"><span class="hs-identifier hs-type">asBytes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401456"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span></span><span>
</span><span id="line-2090"></span><span id="asBytes"><span class="annot"><span class="annottext">asBytes :: forall a. Array a -&gt; Array Word8
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#asBytes"><span class="hs-identifier hs-var hs-var">asBytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. Array a -&gt; Array b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#castUnsafe"><span class="hs-identifier hs-var">castUnsafe</span></a></span><span>
</span><span id="line-2091"></span><span>
</span><span id="line-2092"></span><span class="hs-comment">-- | Cast an array having elements of type @a@ into an array having elements of</span><span>
</span><span id="line-2093"></span><span class="hs-comment">-- type @b@. The length of the array should be a multiple of the size of the</span><span>
</span><span id="line-2094"></span><span class="hs-comment">-- target element otherwise 'Nothing' is returned.</span><span>
</span><span id="line-2095"></span><span class="hs-comment">--</span><span>
</span><span id="line-2096"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-2097"></span><span class="hs-comment">--</span><span>
</span><span id="line-2098"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#cast"><span class="hs-identifier hs-type">cast</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679401454"><span class="annot"><a href="#local-6989586621679401454"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679401455"><span class="annot"><a href="#local-6989586621679401455"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679401455"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401454"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401455"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2099"></span><span id="cast"><span class="annot"><span class="annottext">cast :: forall a b. Storable b =&gt; Array a -&gt; Maybe (Array b)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#cast"><span class="hs-identifier hs-var hs-var">cast</span></a></span></span><span> </span><span id="local-6989586621679399595"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399595"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2100"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399594"><span class="annot"><span class="annottext">len :: Int
</span><a href="#local-6989586621679399594"><span class="hs-identifier hs-var hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#byteLength"><span class="hs-identifier hs-var">byteLength</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399595"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-2101"></span><span>        </span><span id="local-6989586621679399589"><span class="annot"><span class="annottext">r :: Int
</span><a href="#local-6989586621679399589"><span class="hs-identifier hs-var hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399594"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`mod`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (?callStack::CallStack) =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679401455"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2102"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399589"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-2103"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-2104"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. Array a -&gt; Array b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#castUnsafe"><span class="hs-identifier hs-var">castUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399595"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-2105"></span><span>
</span><span id="line-2106"></span><span class="hs-comment">-- | Use an @Array a@ as @Ptr b@.</span><span>
</span><span id="line-2107"></span><span class="hs-comment">--</span><span>
</span><span id="line-2108"></span><span class="hs-comment">-- /Unsafe/</span><span>
</span><span id="line-2109"></span><span class="hs-comment">--</span><span>
</span><span id="line-2110"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-2111"></span><span class="hs-comment">--</span><span>
</span><span id="line-2112"></span><span id="local-6989586621679401449"><span id="local-6989586621679401450"><span id="local-6989586621679401451"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#asPtrUnsafe"><span class="hs-identifier hs-type">asPtrUnsafe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401451"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679401450"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401449"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401449"><span class="hs-identifier hs-type">c</span></a></span></span></span></span><span>
</span><span id="line-2113"></span><span id="asPtrUnsafe"><span class="annot"><span class="annottext">asPtrUnsafe :: forall a b c. Array a -&gt; (Ptr b -&gt; IO c) -&gt; IO c
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#asPtrUnsafe"><span class="hs-identifier hs-var hs-var">asPtrUnsafe</span></a></span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679399584"><span id="local-6989586621679399585"><span id="local-6989586621679399586"><span id="local-6989586621679399587"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aBound :: Ptr a
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aBound :: forall a. Array a -&gt; Ptr a
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679399584"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679399583"><span class="annot"><span class="annottext">Ptr b -&gt; IO c
</span><a href="#local-6989586621679399583"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2114"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
MonadIO m =&gt;
ArrayContents -&gt; Ptr a -&gt; (Ptr a -&gt; m b) -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#unsafeWithArrayContents"><span class="hs-identifier hs-var">unsafeWithArrayContents</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679399587"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399586"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679399582"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399582"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Ptr b -&gt; IO c
</span><a href="#local-6989586621679399583"><span class="hs-identifier hs-var">act</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399582"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2115"></span><span>
</span><span id="line-2116"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-2117"></span><span class="hs-comment">-- Equality</span><span>
</span><span id="line-2118"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-2119"></span><span>
</span><span id="line-2120"></span><span class="hs-comment">-- | Compare if two arrays are equal.</span><span>
</span><span id="line-2121"></span><span class="hs-comment">--</span><span>
</span><span id="line-2122"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-2123"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#cmp"><span class="hs-pragma hs-type">cmp</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-2124"></span><span id="local-6989586621679401444"><span id="local-6989586621679401445"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#cmp"><span class="hs-identifier hs-type">cmp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679401445"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401444"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401444"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679401445"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span></span><span>
</span><span id="line-2125"></span><span id="cmp"><span class="annot"><span class="annottext">cmp :: forall (m :: * -&gt; *) a. MonadIO m =&gt; Array a -&gt; Array a -&gt; m Bool
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#cmp"><span class="hs-identifier hs-var hs-var">cmp</span></a></span></span><span> </span><span id="local-6989586621679399571"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399571"><span class="hs-identifier hs-var">arr1</span></a></span></span><span> </span><span id="local-6989586621679399570"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399570"><span class="hs-identifier hs-var">arr2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-2126"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2127"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399569"><span class="annot"><span class="annottext">ptr1 :: Ptr a
</span><a href="#local-6989586621679399569"><span class="hs-identifier hs-var hs-var">ptr1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399571"><span class="hs-identifier hs-var">arr1</span></a></span><span>
</span><span id="line-2128"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399568"><span class="annot"><span class="annottext">ptr2 :: Ptr a
</span><a href="#local-6989586621679399568"><span class="hs-identifier hs-var hs-var">ptr2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399570"><span class="hs-identifier hs-var">arr2</span></a></span><span>
</span><span id="line-2129"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399567"><span class="annot"><span class="annottext">len1 :: Int
</span><a href="#local-6989586621679399567"><span class="hs-identifier hs-var hs-var">len1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399571"><span class="hs-identifier hs-var">arr1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b -&gt; Int
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399569"><span class="hs-identifier hs-var">ptr1</span></a></span><span>
</span><span id="line-2130"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679399566"><span class="annot"><span class="annottext">len2 :: Int
</span><a href="#local-6989586621679399566"><span class="hs-identifier hs-var hs-var">len2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399570"><span class="hs-identifier hs-var">arr2</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b -&gt; Int
</span><span class="hs-operator hs-var">`minusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399568"><span class="hs-identifier hs-var">ptr2</span></a></span><span>
</span><span id="line-2131"></span><span>
</span><span id="line-2132"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399567"><span class="hs-identifier hs-var">len1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399566"><span class="hs-identifier hs-var">len2</span></a></span><span>
</span><span id="line-2133"></span><span>        </span><span class="hs-keyword">then</span><span>
</span><span id="line-2134"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399569"><span class="hs-identifier hs-var">ptr1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399568"><span class="hs-identifier hs-var">ptr2</span></a></span><span>
</span><span id="line-2135"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-2136"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-2137"></span><span>                </span><span id="local-6989586621679399565"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399565"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Int -&gt; IO Bool
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#memcmp"><span class="hs-identifier hs-var">memcmp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399569"><span class="hs-identifier hs-var">ptr1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679399568"><span class="hs-identifier hs-var">ptr2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679399567"><span class="hs-identifier hs-var">len1</span></a></span><span>
</span><span id="line-2138"></span><span>                </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrContents"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399571"><span class="hs-identifier hs-var">arr1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2139"></span><span>                </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#arrContents"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679399570"><span class="hs-identifier hs-var">arr2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-2140"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679399565"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-2141"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-2142"></span><span>
</span><span id="line-2143"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-2144"></span><span class="hs-comment">-- NFData</span><span>
</span><span id="line-2145"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-2146"></span><span>
</span><span id="line-2147"></span><span class="hs-comment">-- This is a Storable array, we cannot have unevaluated data in it so this is</span><span>
</span><span id="line-2148"></span><span class="hs-comment">-- just a no op.</span><span>
</span><span id="line-2149"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679401438"><span class="annot"><span class="hs-identifier hs-type">NFData</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679401438"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2150"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><span class="hs-pragma hs-type">rnf</span></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-2151"></span><span>    </span><span id="local-6989586621679399560"><span class="annot"><span class="annottext">rnf :: Array a -&gt; ()
</span><a href="#local-6989586621679399560"><span class="hs-identifier hs-var hs-var hs-var hs-var">rnf</span></a></span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-2152"></span></pre></body></html>