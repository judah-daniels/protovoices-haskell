<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-cpp">#include &quot;inline.hs&quot;
</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- Module      : Streamly.Internal.Data.Array.Foreign</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- Copyright   : (c) 2019 Composewell Technologies</span><span>
</span><span id="line-6"></span><span class="hs-comment">--</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- License     : BSD3</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- Maintainer  : streamly@composewell.com</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- Stability   : experimental</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- Portability : GHC</span><span>
</span><span id="line-11"></span><span class="hs-comment">--</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- To summarize:</span><span>
</span><span id="line-13"></span><span class="hs-comment">--</span><span>
</span><span id="line-14"></span><span class="hs-comment">--  * Arrays are finite and fixed in size</span><span>
</span><span id="line-15"></span><span class="hs-comment">--  * provide /O(1)/ access to elements</span><span>
</span><span id="line-16"></span><span class="hs-comment">--  * store only data and not functions</span><span>
</span><span id="line-17"></span><span class="hs-comment">--  * provide efficient IO interfacing</span><span>
</span><span id="line-18"></span><span class="hs-comment">--</span><span>
</span><span id="line-19"></span><span class="hs-comment">-- 'Foldable' instance is not provided because the implementation would be much</span><span>
</span><span id="line-20"></span><span class="hs-comment">-- less efficient compared to folding via streams.  'Semigroup' and 'Monoid'</span><span>
</span><span id="line-21"></span><span class="hs-comment">-- instances should be used with care; concatenating arrays using binary</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- operations can be highly inefficient.  Instead, use</span><span>
</span><span id="line-23"></span><span class="hs-comment">-- 'Streamly.Internal.Data.Array.Stream.Foreign.toArray' to concatenate N</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- arrays at once.</span><span>
</span><span id="line-25"></span><span class="hs-comment">--</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- Each array is one pointer visible to the GC.  Too many small arrays (e.g.</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- single byte) are only as good as holding those elements in a Haskell list.</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- However, small arrays can be compacted into large ones to reduce the</span><span>
</span><span id="line-29"></span><span class="hs-comment">-- overhead. To hold 32GB memory in 32k sized buffers we need 1 million arrays</span><span>
</span><span id="line-30"></span><span class="hs-comment">-- if we use one array for each chunk. This is still significant to add</span><span>
</span><span id="line-31"></span><span class="hs-comment">-- pressure to GC.</span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Streamly.Internal.Data.Array.Foreign</span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">(</span><span>
</span><span id="line-35"></span><span>      </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier">Array</span></a></span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Construction</span></span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-comment">-- Pure, From Static Memory (Unsafe)</span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-comment">-- We can use fromPtrM#, fromCStringM# and fromAddrM# to create arrays from</span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-comment">-- a dynamic memory address which requires a finalizer.</span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#fromPtr"><span class="hs-identifier">A.fromPtr</span></a></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#fromAddr%23"><span class="hs-identifier">A.fromAddr#</span></a></span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#fromCString%23"><span class="hs-identifier">A.fromCString#</span></a></span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-comment">-- Pure List APIs</span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#fromListN"><span class="hs-identifier">A.fromListN</span></a></span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#fromList"><span class="hs-identifier">A.fromList</span></a></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-comment">-- Stream Folds</span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#fromStreamN"><span class="hs-identifier">fromStreamN</span></a></span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#fromStream"><span class="hs-identifier">fromStream</span></a></span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-comment">-- Monadic Folds</span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#writeN"><span class="hs-identifier">A.writeN</span></a></span><span>      </span><span class="hs-comment">-- drop new</span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#writeNAligned"><span class="hs-identifier">A.writeNAligned</span></a></span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#write"><span class="hs-identifier">A.write</span></a></span><span>       </span><span class="hs-comment">-- full buffer</span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#writeLastN"><span class="hs-identifier">writeLastN</span></a></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Elimination</span></span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#toList"><span class="hs-identifier">A.toList</span></a></span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#toStream"><span class="hs-identifier">A.toStream</span></a></span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#toStreamRev"><span class="hs-identifier">A.toStreamRev</span></a></span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#read"><span class="hs-identifier">read</span></a></span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#unsafeRead"><span class="hs-identifier">unsafeRead</span></a></span><span>    </span><span class="hs-comment">-- XXX readUnsafe?</span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#readRev"><span class="hs-identifier">A.readRev</span></a></span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#producer"><span class="hs-identifier">producer</span></a></span><span> </span><span class="hs-comment">-- experimental</span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Random Access</span></span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-comment">-- , (!!)</span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#getIndex"><span class="hs-identifier">getIndex</span></a></span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#unsafeIndex"><span class="hs-identifier">A.unsafeIndex</span></a></span><span> </span><span class="hs-comment">-- XXX Rename to getIndexUnsafe??</span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#getIndexRev"><span class="hs-identifier">getIndexRev</span></a></span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#last"><span class="hs-identifier">last</span></a></span><span>           </span><span class="hs-comment">-- XXX getIndexLast?</span><span>
</span><span id="line-75"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#getIndices"><span class="hs-identifier">getIndices</span></a></span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#getIndicesFromThenTo"><span class="hs-identifier">getIndicesFromThenTo</span></a></span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-comment">-- , getIndicesFrom    -- read from a given position to the end of file</span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-comment">-- , getIndicesUpto    -- read from beginning up to the given position</span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-comment">-- , getIndicesFromTo</span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-comment">-- , getIndicesFromRev  -- read from a given position to the beginning of file</span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-comment">-- , getIndicesUptoRev  -- read from end to the given position in file</span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Size</span></span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#length"><span class="hs-identifier">length</span></a></span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#null"><span class="hs-identifier">null</span></a></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Search</span></span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#binarySearch"><span class="hs-identifier">binarySearch</span></a></span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#findIndicesOf"><span class="hs-identifier">findIndicesOf</span></a></span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-comment">-- , findIndexOf</span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-comment">-- , find</span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Casting</span></span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#cast"><span class="hs-identifier">cast</span></a></span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#asBytes"><span class="hs-identifier">asBytes</span></a></span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#unsafeCast"><span class="hs-identifier">unsafeCast</span></a></span><span>   </span><span class="hs-comment">-- castUnsafe?</span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#unsafeAsPtr"><span class="hs-identifier">unsafeAsPtr</span></a></span><span>  </span><span class="hs-comment">-- asPtrUnsafe?</span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#unsafeAsCString"><span class="hs-identifier">unsafeAsCString</span></a></span><span> </span><span class="hs-comment">-- asCStringUnsafe?</span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#unsafeFreeze"><span class="hs-identifier">A.unsafeFreeze</span></a></span><span> </span><span class="hs-comment">-- asImmutableUnsafe?</span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#unsafeThaw"><span class="hs-identifier">A.unsafeThaw</span></a></span><span>   </span><span class="hs-comment">-- asMutableUnsafe?</span><span>
</span><span id="line-101"></span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Subarrays</span></span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#getSliceUnsafe"><span class="hs-identifier">getSliceUnsafe</span></a></span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-comment">-- , getSlice</span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#genSlicesFromLen"><span class="hs-identifier">genSlicesFromLen</span></a></span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#getSlicesFromLen"><span class="hs-identifier">getSlicesFromLen</span></a></span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#splitOn"><span class="hs-identifier">splitOn</span></a></span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Streaming Operations</span></span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#streamTransform"><span class="hs-identifier">streamTransform</span></a></span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Folding</span></span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#streamFold"><span class="hs-identifier">streamFold</span></a></span><span>
</span><span id="line-114"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#fold"><span class="hs-identifier">fold</span></a></span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span class="hs-keyword">where</span><span>
</span><span id="line-117"></span><span>
</span><span id="line-118"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">assert</span></span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">when</span></span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadIO</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Functor.Identity</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Identity</span></span><span class="hs-special">)</span><span class="hs-cpp">
#if !(MIN_VERSION_base(4,11,0))
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Semigroup</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator">&lt;&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Word</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Word8</span></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Foreign.C.String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">CString</span></span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Foreign.Ptr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">plusPtr</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">castPtr</span></span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Foreign.Storable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Storable</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">length</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">null</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">last</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">map</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(!!)</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">read</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">concat</span></span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Ptr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Ptr</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html"><span class="hs-identifier">Streamly.Internal.Data.Array.Foreign.Mut.Type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier">ReadUState</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier">touch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html"><span class="hs-identifier">Streamly.Internal.Data.Array.Foreign.Type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier">Array</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#length"><span class="hs-identifier">length</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html"><span class="hs-identifier">Streamly.Internal.Data.Fold.Type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier">Fold</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-136"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Producer.Type.html"><span class="hs-identifier">Streamly.Internal.Data.Producer.Type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Producer.Type.html#Producer"><span class="hs-identifier">Producer</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.Serial.html"><span class="hs-identifier">Streamly.Internal.Data.Stream.Serial</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.Serial.html#SerialT"><span class="hs-identifier">SerialT</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-138"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Tuple.Strict.html"><span class="hs-identifier">Streamly.Internal.Data.Tuple.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Tuple.Strict.html#Tuple3%27"><span class="hs-identifier">Tuple3'</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Type.html"><span class="hs-identifier">Streamly.Internal.Data.Unfold.Type</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Type.html#Unfold"><span class="hs-identifier">Unfold</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Streamly.Internal.System.IO.html"><span class="hs-identifier">Streamly.Internal.System.IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.System.IO.html#unsafeInlineIO"><span class="hs-identifier">unsafeInlineIO</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html"><span class="hs-identifier">Streamly.Internal.Data.Array.Foreign.Mut.Type</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MA</span></span><span>
</span><span id="line-143"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.html"><span class="hs-identifier">Streamly.Internal.Data.Array.Foreign.Mut</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MA</span></span><span>
</span><span id="line-144"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html"><span class="hs-identifier">Streamly.Internal.Data.Array.Foreign.Type</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">A</span></span><span>
</span><span id="line-145"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.html"><span class="hs-identifier">Streamly.Internal.Data.Fold</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">FL</span></span><span>
</span><span id="line-146"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Producer.html"><span class="hs-identifier">Streamly.Internal.Data.Producer</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Producer</span></span><span>
</span><span id="line-147"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.IsStream.Type.html"><span class="hs-identifier">Streamly.Internal.Data.Stream.IsStream.Type</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IsStream</span></span><span>
</span><span id="line-148"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.Prelude.html"><span class="hs-identifier">Streamly.Internal.Data.Stream.Prelude</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">P</span></span><span>
</span><span id="line-149"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.StreamD.html"><span class="hs-identifier">Streamly.Internal.Data.Stream.StreamD</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">D</span></span><span>
</span><span id="line-150"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.html"><span class="hs-identifier">Streamly.Internal.Data.Unfold</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Unfold</span></span><span>
</span><span id="line-151"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Streamly.Internal.Ring.Foreign.html"><span class="hs-identifier">Streamly.Internal.Ring.Foreign</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">RB</span></span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-154"></span><span class="hs-comment">-- Construction</span><span>
</span><span id="line-155"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span class="hs-comment">-- | Create an 'Array' from the first N elements of a stream. The array is</span><span>
</span><span id="line-158"></span><span class="hs-comment">-- allocated to size N, if the stream terminates before N elements then the</span><span>
</span><span id="line-159"></span><span class="hs-comment">-- array may hold less than N elements.</span><span>
</span><span id="line-160"></span><span class="hs-comment">--</span><span>
</span><span id="line-161"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-162"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#fromStreamN"><span class="hs-pragma hs-type">fromStreamN</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-163"></span><span id="local-6989586621679428126"><span id="local-6989586621679428128"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#fromStreamN"><span class="hs-identifier hs-type">fromStreamN</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679428128"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679428126"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.Serial.html#SerialT"><span class="hs-identifier hs-type">SerialT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679428128"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679428126"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679428128"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679428126"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-164"></span><span id="fromStreamN"><span class="annot"><span class="annottext">fromStreamN :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; SerialT m a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.html#fromStreamN"><span class="hs-identifier hs-var hs-var">fromStreamN</span></a></span></span><span> </span><span id="local-6989586621679427805"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427805"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.Serial.html#SerialT"><span class="hs-identifier hs-type">SerialT</span></a></span><span> </span><span id="local-6989586621679427803"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679427803"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-165"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427805"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;writeN: negative write count specified&quot;</span></span><span>
</span><span id="line-166"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Stream m a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#fromStreamDN"><span class="hs-identifier hs-var">A.fromStreamDN</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427805"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Applicative m =&gt; Stream m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Type.html#fromStreamK"><span class="hs-identifier hs-var">D.fromStreamK</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679427803"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span class="hs-comment">-- | Create an 'Array' from a stream. This is useful when we want to create a</span><span>
</span><span id="line-169"></span><span class="hs-comment">-- single array from a stream of unknown size. 'writeN' is at least twice</span><span>
</span><span id="line-170"></span><span class="hs-comment">-- as efficient when the size is already known.</span><span>
</span><span id="line-171"></span><span class="hs-comment">--</span><span>
</span><span id="line-172"></span><span class="hs-comment">-- Note that if the input stream is too large memory allocation for the array</span><span>
</span><span id="line-173"></span><span class="hs-comment">-- may fail.  When the stream size is not known, `arraysOf` followed by</span><span>
</span><span id="line-174"></span><span class="hs-comment">-- processing of indvidual arrays in the resulting stream should be preferred.</span><span>
</span><span id="line-175"></span><span class="hs-comment">--</span><span>
</span><span id="line-176"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-177"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#fromStream"><span class="hs-pragma hs-type">fromStream</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-178"></span><span id="local-6989586621679428103"><span id="local-6989586621679428104"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#fromStream"><span class="hs-identifier hs-type">fromStream</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679428104"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679428103"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.Serial.html#SerialT"><span class="hs-identifier hs-type">SerialT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679428104"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679428103"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679428104"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679428103"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-179"></span><span id="fromStream"><span class="annot"><span class="annottext">fromStream :: forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
SerialT m a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.html#fromStream"><span class="hs-identifier hs-var hs-var">fromStream</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.Serial.html#SerialT"><span class="hs-identifier hs-type">SerialT</span></a></span><span> </span><span id="local-6989586621679427792"><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679427792"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
Monad m =&gt;
Fold m a b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.Prelude.html#fold"><span class="hs-identifier hs-var">P.fold</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#write"><span class="hs-identifier hs-var">A.write</span></a></span><span> </span><span class="annot"><span class="annottext">Stream m a
</span><a href="#local-6989586621679427792"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-180"></span><span class="hs-comment">-- write m = A.fromStreamD $ D.fromStreamK m</span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-183"></span><span class="hs-comment">-- Elimination</span><span>
</span><span id="line-184"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="hs-pragma">{-# INLINE_NORMAL producer #-}</span><span>
</span><span id="line-187"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#producer"><span class="hs-identifier hs-type">producer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679428094"><span class="annot"><a href="#local-6989586621679428094"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679428093"><span class="annot"><a href="#local-6989586621679428093"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679428094"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679428093"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Producer.Type.html#Producer"><span class="hs-identifier hs-type">Producer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679428094"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679428093"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679428093"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-188"></span><span id="producer"><span class="annot"><span class="annottext">producer :: forall (m :: * -&gt; *) a.
(Monad m, Storable a) =&gt;
Producer m (Array a) a
</span><a href="Streamly.Internal.Data.Array.Foreign.html#producer"><span class="hs-identifier hs-var hs-var">producer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b s.
(s -&gt; m (Step s b)) -&gt; (a -&gt; m s) -&gt; (s -&gt; m a) -&gt; Producer m a b
</span><a href="Streamly.Internal.Data.Producer.Type.html#Producer"><span class="hs-identifier hs-var">Producer</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a}.
(Monad m, Storable a) =&gt;
ReadUState a -&gt; m (Step (ReadUState a) a)
</span><a href="#local-6989586621679427783"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a}. Monad m =&gt; Array a -&gt; m (ReadUState a)
</span><a href="#local-6989586621679427782"><span class="hs-identifier hs-var">inject</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a}. Monad m =&gt; ReadUState a -&gt; m (Array a)
</span><a href="#local-6989586621679427781"><span class="hs-identifier hs-var">extract</span></a></span><span>
</span><span id="line-189"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679427782"><span class="hs-pragma hs-type">inject</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-192"></span><span>    </span><span id="local-6989586621679427782"><span class="annot"><span class="annottext">inject :: Array a -&gt; m (ReadUState a)
</span><a href="#local-6989586621679427782"><span class="hs-identifier hs-var hs-var">inject</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621679427777"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679427777"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679427776"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427776"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679427775"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427775"><span class="hs-identifier hs-var">end</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; ReadUState a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-var">ReadUState</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679427777"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427775"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427776"><span class="hs-identifier hs-var">start</span></a></span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-195"></span><span>    </span><span id="local-6989586621679427783"><span class="annot"><span class="annottext">step :: ReadUState a -&gt; m (Step (ReadUState a) a)
</span><a href="#local-6989586621679427783"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-type">ReadUState</span></a></span><span> </span><span id="local-6989586621679427763"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679427763"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679427762"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427762"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679427761"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427761"><span class="hs-identifier hs-var">cur</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427761"><span class="hs-identifier hs-var">cur</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427762"><span class="hs-identifier hs-var">end</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427761"><span class="hs-identifier hs-var">cur</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427762"><span class="hs-identifier hs-var">end</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-197"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679427759"><span class="annot"><span class="annottext">x :: ()
</span><a href="#local-6989586621679427759"><span class="hs-identifier hs-var hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. IO a -&gt; a
</span><a href="Streamly.Internal.System.IO.html#unsafeInlineIO"><span class="hs-identifier hs-var">unsafeInlineIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679427763"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-198"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">()
</span><a href="#local-6989586621679427759"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">seq :: forall a b. a -&gt; b -&gt; b
</span><span class="hs-operator hs-type">`seq`</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall s a. Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Stop"><span class="hs-identifier hs-var">D.Stop</span></a></span><span>
</span><span id="line-199"></span><span>    </span><span class="annot"><a href="#local-6989586621679427783"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-type">ReadUState</span></a></span><span> </span><span id="local-6989586621679427757"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679427757"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679427756"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427756"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679427755"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427755"><span class="hs-identifier hs-var">cur</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-200"></span><span>            </span><span class="hs-comment">-- unsafeInlineIO allows us to run this in Identity monad for pure</span><span>
</span><span id="line-201"></span><span>            </span><span class="hs-comment">-- toList/foldr case which makes them much faster due to not</span><span>
</span><span id="line-202"></span><span>            </span><span class="hs-comment">-- accumulating the list and fusing better with the pure consumers.</span><span>
</span><span id="line-203"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-204"></span><span>            </span><span class="hs-comment">-- This should be safe as the array contents are guaranteed to be</span><span>
</span><span id="line-205"></span><span>            </span><span class="hs-comment">-- evaluated/written to before we peek at them.</span><span>
</span><span id="line-206"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679427753"><span class="annot"><span class="annottext">x :: a
</span><a href="#local-6989586621679427753"><span class="hs-identifier hs-var hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. IO a -&gt; a
</span><a href="Streamly.Internal.System.IO.html#unsafeInlineIO"><span class="hs-identifier hs-var">unsafeInlineIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427755"><span class="hs-identifier hs-var">cur</span></a></span><span>
</span><span id="line-207"></span><span>                </span><span id="local-6989586621679427748"><span class="annot"><span class="annottext">cur1 :: Ptr b
</span><a href="#local-6989586621679427748"><span class="hs-identifier hs-var hs-var">cur1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427755"><span class="hs-identifier hs-var">cur</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679428093"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Yield"><span class="hs-identifier hs-var">D.Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679427753"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; ReadUState a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-var">ReadUState</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679427757"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427756"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall {b}. Ptr b
</span><a href="#local-6989586621679427748"><span class="hs-identifier hs-var">cur1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span>    </span><span id="local-6989586621679427781"><span class="annot"><span class="annottext">extract :: ReadUState a -&gt; m (Array a)
</span><a href="#local-6989586621679427781"><span class="hs-identifier hs-var hs-var">extract</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-type">ReadUState</span></a></span><span> </span><span id="local-6989586621679427742"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679427742"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679427741"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427741"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679427740"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427740"><span class="hs-identifier hs-var">cur</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679427742"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427740"><span class="hs-identifier hs-var">cur</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427741"><span class="hs-identifier hs-var">end</span></a></span><span>
</span><span id="line-211"></span><span>
</span><span id="line-212"></span><span class="hs-comment">-- | Unfold an array into a stream.</span><span>
</span><span id="line-213"></span><span class="hs-comment">--</span><span>
</span><span id="line-214"></span><span class="hs-comment">-- /Since 0.7.0 (Streamly.Memory.Array)/</span><span>
</span><span id="line-215"></span><span class="hs-comment">--</span><span>
</span><span id="line-216"></span><span class="hs-comment">-- @since 0.8.0</span><span>
</span><span id="line-217"></span><span class="hs-pragma">{-# INLINE_NORMAL read #-}</span><span>
</span><span id="line-218"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#read"><span class="hs-identifier hs-type">read</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679428057"><span class="annot"><a href="#local-6989586621679428057"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679428056"><span class="annot"><a href="#local-6989586621679428056"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679428057"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679428056"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Type.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679428057"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679428056"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679428056"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-219"></span><span id="read"><span class="annot"><span class="annottext">read :: forall (m :: * -&gt; *) a.
(Monad m, Storable a) =&gt;
Unfold m (Array a) a
</span><a href="Streamly.Internal.Data.Array.Foreign.html#read"><span class="hs-identifier hs-var hs-var">read</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Producer m a b -&gt; Unfold m a b
</span><a href="Streamly.Internal.Data.Producer.html#simplify"><span class="hs-identifier hs-var">Producer.simplify</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(Monad m, Storable a) =&gt;
Producer m (Array a) a
</span><a href="Streamly.Internal.Data.Array.Foreign.html#producer"><span class="hs-identifier hs-var">producer</span></a></span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span class="hs-comment">-- | Unfold an array into a stream, does not check the end of the array, the</span><span>
</span><span id="line-222"></span><span class="hs-comment">-- user is responsible for terminating the stream within the array bounds. For</span><span>
</span><span id="line-223"></span><span class="hs-comment">-- high performance application where the end condition can be determined by</span><span>
</span><span id="line-224"></span><span class="hs-comment">-- a terminating fold.</span><span>
</span><span id="line-225"></span><span class="hs-comment">--</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- Written in the hope that it may be faster than &quot;read&quot;, however, in the case</span><span>
</span><span id="line-227"></span><span class="hs-comment">-- for which this was written, &quot;read&quot; proves to be faster even though the core</span><span>
</span><span id="line-228"></span><span class="hs-comment">-- generated with unsafeRead looks simpler.</span><span>
</span><span id="line-229"></span><span class="hs-comment">--</span><span>
</span><span id="line-230"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-231"></span><span class="hs-comment">--</span><span>
</span><span id="line-232"></span><span class="hs-pragma">{-# INLINE_NORMAL unsafeRead #-}</span><span>
</span><span id="line-233"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#unsafeRead"><span class="hs-identifier hs-type">unsafeRead</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679427734"><span class="annot"><a href="#local-6989586621679427734"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679427733"><span class="annot"><a href="#local-6989586621679427733"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679427734"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679427733"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Type.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427734"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427733"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679427733"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-234"></span><span id="unsafeRead"><span class="annot"><span class="annottext">unsafeRead :: forall (m :: * -&gt; *) a.
(Monad m, Storable a) =&gt;
Unfold m (Array a) a
</span><a href="Streamly.Internal.Data.Array.Foreign.html#unsafeRead"><span class="hs-identifier hs-var hs-var">unsafeRead</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b s.
(s -&gt; m (Step s b)) -&gt; (a -&gt; m s) -&gt; Unfold m a b
</span><a href="Streamly.Internal.Data.Unfold.Type.html#Unfold"><span class="hs-identifier hs-var">Unfold</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a}.
(Monad m, Storable a) =&gt;
ReadUState a -&gt; m (Step (ReadUState a) a)
</span><a href="#local-6989586621679427726"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a}. Monad m =&gt; Array a -&gt; m (ReadUState a)
</span><a href="#local-6989586621679427725"><span class="hs-identifier hs-var">inject</span></a></span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-236"></span><span>
</span><span id="line-237"></span><span>    </span><span id="local-6989586621679427725"><span class="annot"><span class="annottext">inject :: Array a -&gt; m (ReadUState a)
</span><a href="#local-6989586621679427725"><span class="hs-identifier hs-var hs-var">inject</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621679427722"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679427722"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679427721"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427721"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679427720"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427720"><span class="hs-identifier hs-var">end</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-238"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; ReadUState a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-var">ReadUState</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679427722"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427720"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427721"><span class="hs-identifier hs-var">start</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span>    </span><span class="hs-pragma">{-# INLINE_LATE step #-}</span><span>
</span><span id="line-241"></span><span>    </span><span id="local-6989586621679427726"><span class="annot"><span class="annottext">step :: ReadUState a -&gt; m (Step (ReadUState a) a)
</span><a href="#local-6989586621679427726"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-type">ReadUState</span></a></span><span> </span><span id="local-6989586621679427716"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679427716"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679427715"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427715"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span id="local-6989586621679427714"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427714"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-242"></span><span>            </span><span class="hs-comment">-- unsafeInlineIO allows us to run this in Identity monad for pure</span><span>
</span><span id="line-243"></span><span>            </span><span class="hs-comment">-- toList/foldr case which makes them much faster due to not</span><span>
</span><span id="line-244"></span><span>            </span><span class="hs-comment">-- accumulating the list and fusing better with the pure consumers.</span><span>
</span><span id="line-245"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-246"></span><span>            </span><span class="hs-comment">-- This should be safe as the array contents are guaranteed to be</span><span>
</span><span id="line-247"></span><span>            </span><span class="hs-comment">-- evaluated/written to before we peek at them.</span><span>
</span><span id="line-248"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679427708"><span class="annot"><span class="annottext">x :: a
</span><a href="#local-6989586621679427708"><span class="hs-identifier hs-var hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. IO a -&gt; a
</span><a href="Streamly.Internal.System.IO.html#unsafeInlineIO"><span class="hs-identifier hs-var">unsafeInlineIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-249"></span><span>                        </span><span id="local-6989586621679427707"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679427707"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427714"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-250"></span><span>                        </span><span class="annot"><span class="annottext">ArrayContents -&gt; IO ()
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#touch"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679427716"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-251"></span><span>                        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679427707"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-252"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679427703"><span class="annot"><span class="annottext">p1 :: Ptr b
</span><a href="#local-6989586621679427703"><span class="hs-identifier hs-var hs-var">p1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427714"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679427733"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s a. a -&gt; s -&gt; Step s a
</span><a href="Streamly.Internal.Data.Stream.StreamD.Step.html#Yield"><span class="hs-identifier hs-var">D.Yield</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679427708"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; ReadUState a
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#ReadUState"><span class="hs-identifier hs-var">ReadUState</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679427716"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427715"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall {b}. Ptr b
</span><a href="#local-6989586621679427703"><span class="hs-identifier hs-var">p1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-256"></span><span class="hs-comment">--</span><span>
</span><span id="line-257"></span><span class="hs-comment">-- &gt;&gt;&gt; import qualified Streamly.Internal.Data.Array.Foreign.Type as Array</span><span>
</span><span id="line-258"></span><span class="hs-comment">-- &gt;&gt;&gt; null arr = Array.byteLength arr == 0</span><span>
</span><span id="line-259"></span><span class="hs-comment">--</span><span>
</span><span id="line-260"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-261"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#null"><span class="hs-pragma hs-type">null</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-262"></span><span id="local-6989586621679428038"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#null"><span class="hs-identifier hs-type">null</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679428038"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-263"></span><span id="null"><span class="annot"><span class="annottext">null :: forall a. Array a -&gt; Bool
</span><a href="Streamly.Internal.Data.Array.Foreign.html#null"><span class="hs-identifier hs-var hs-var">null</span></a></span></span><span> </span><span id="local-6989586621679427699"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427699"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#byteLength"><span class="hs-identifier hs-var">A.byteLength</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427699"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span class="hs-comment">-- | Like 'getIndex' but indexes the array in reverse from the end.</span><span>
</span><span id="line-266"></span><span class="hs-comment">--</span><span>
</span><span id="line-267"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-268"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#getIndexRev"><span class="hs-pragma hs-type">getIndexRev</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-269"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#getIndexRev"><span class="hs-identifier hs-type">getIndexRev</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679428035"><span class="annot"><a href="#local-6989586621679428035"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679428035"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679428035"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679428035"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-270"></span><span id="getIndexRev"><span class="annot"><span class="annottext">getIndexRev :: forall a. Storable a =&gt; Array a -&gt; Int -&gt; Maybe a
</span><a href="Streamly.Internal.Data.Array.Foreign.html#getIndexRev"><span class="hs-identifier hs-var hs-var">getIndexRev</span></a></span></span><span> </span><span id="local-6989586621679427687"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427687"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621679427686"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427686"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-271"></span><span>    </span><span class="annot"><span class="annottext">forall a. IO a -&gt; a
</span><a href="Streamly.Internal.System.IO.html#unsafeInlineIO"><span class="hs-identifier hs-var">unsafeInlineIO</span></a></span><span>
</span><span id="line-272"></span><span>        </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
MonadIO m =&gt;
ArrayContents -&gt; Ptr a -&gt; (Ptr a -&gt; m b) -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#unsafeWithArrayContents"><span class="hs-identifier hs-var">MA.unsafeWithArrayContents</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#arrContents"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427687"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427687"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>            </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679427682"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427682"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-274"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679427678"><span class="annot"><span class="annottext">elemSize :: Int
</span><a href="#local-6989586621679427678"><span class="hs-identifier hs-var hs-var">elemSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679428035"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>                    </span><span id="local-6989586621679427673"><span class="annot"><span class="annottext">elemPtr :: Ptr b
</span><a href="#local-6989586621679427673"><span class="hs-identifier hs-var hs-var">elemPtr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427687"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">negate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427678"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427686"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427686"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall {b}. Ptr b
</span><a href="#local-6989586621679427673"><span class="hs-identifier hs-var">elemPtr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427682"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-277"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">forall {b}. Ptr b
</span><a href="#local-6989586621679427673"><span class="hs-identifier hs-var">elemPtr</span></a></span><span>
</span><span id="line-278"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-281"></span><span class="hs-comment">--</span><span>
</span><span id="line-282"></span><span class="hs-comment">-- &gt;&gt;&gt; import qualified Streamly.Internal.Data.Array.Foreign as Array</span><span>
</span><span id="line-283"></span><span class="hs-comment">-- &gt;&gt;&gt; last arr = Array.getIndexRev arr 0</span><span>
</span><span id="line-284"></span><span class="hs-comment">--</span><span>
</span><span id="line-285"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-286"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#last"><span class="hs-pragma hs-type">last</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-287"></span><span id="local-6989586621679428025"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#last"><span class="hs-identifier hs-type">last</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679428025"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679428025"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679428025"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-288"></span><span id="last"><span class="annot"><span class="annottext">last :: forall a. Storable a =&gt; Array a -&gt; Maybe a
</span><a href="Streamly.Internal.Data.Array.Foreign.html#last"><span class="hs-identifier hs-var hs-var">last</span></a></span></span><span> </span><span id="local-6989586621679427665"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427665"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Array a -&gt; Int -&gt; Maybe a
</span><a href="Streamly.Internal.Data.Array.Foreign.html#getIndexRev"><span class="hs-identifier hs-var">getIndexRev</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427665"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-289"></span><span>
</span><span id="line-290"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-291"></span><span class="hs-comment">-- Folds with Array as the container</span><span>
</span><span id="line-292"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-293"></span><span>
</span><span id="line-294"></span><span class="hs-comment">-- | @writeLastN n@ folds a maximum of @n@ elements from the end of the input</span><span>
</span><span id="line-295"></span><span class="hs-comment">-- stream to an 'Array'.</span><span>
</span><span id="line-296"></span><span class="hs-comment">--</span><span>
</span><span id="line-297"></span><span class="hs-comment">-- @since 0.8.0</span><span>
</span><span id="line-298"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#writeLastN"><span class="hs-pragma hs-type">writeLastN</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-299"></span><span id="local-6989586621679428022"><span id="local-6989586621679428023"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#writeLastN"><span class="hs-identifier hs-type">writeLastN</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679428023"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679428022"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679428022"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679428023"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679428023"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-300"></span><span id="writeLastN"><span class="annot"><span class="annottext">writeLastN :: forall a (m :: * -&gt; *).
(Storable a, MonadIO m) =&gt;
Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.html#writeLastN"><span class="hs-identifier hs-var hs-var">writeLastN</span></a></span></span><span> </span><span id="local-6989586621679427645"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427645"><span class="hs-identifier hs-var">n</span></a></span></span><span>
</span><span id="line-301"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427645"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; Fold m a ()
</span><a href="Streamly.Internal.Data.Fold.Type.html#drain"><span class="hs-identifier hs-var">FL.drain</span></a></span><span>
</span><span id="line-302"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#unsafeFreeze"><span class="hs-identifier hs-var">A.unsafeFreeze</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b s.
(s -&gt; a -&gt; m (Step s b))
-&gt; m (Step s b) -&gt; (s -&gt; m b) -&gt; Fold m a b
</span><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier hs-var">Fold</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a} {c} {b}.
(MonadIO m, Storable a, Num c) =&gt;
Tuple3' (Ring a) (Ptr a) c
-&gt; a -&gt; m (Step (Tuple3' (Ring a) (Ptr a) c) b)
</span><a href="#local-6989586621679427641"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">forall {b}. m (Step (Tuple3' (Ring a) (Ptr a) Int) b)
</span><a href="#local-6989586621679427640"><span class="hs-identifier hs-var">initial</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a}.
(MonadIO m, Storable a) =&gt;
Tuple3' (Ring a) (Ptr a) Int -&gt; m (Array a)
</span><a href="#local-6989586621679427639"><span class="hs-identifier hs-var">done</span></a></span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span>    </span><span id="local-6989586621679427641"><span class="annot"><span class="annottext">step :: Tuple3' (Ring a) (Ptr a) c
-&gt; a -&gt; m (Step (Tuple3' (Ring a) (Ptr a) c) b)
</span><a href="#local-6989586621679427641"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Tuple.Strict.html#Tuple3%27"><span class="hs-identifier hs-type">Tuple3'</span></a></span><span> </span><span id="local-6989586621679427627"><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679427627"><span class="hs-identifier hs-var">rb</span></a></span></span><span> </span><span id="local-6989586621679427626"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427626"><span class="hs-identifier hs-var">rh</span></a></span></span><span> </span><span id="local-6989586621679427625"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679427625"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679427624"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679427624"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-307"></span><span>        </span><span id="local-6989586621679427623"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427623"><span class="hs-identifier hs-var">rh1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ring a -&gt; Ptr a -&gt; a -&gt; IO (Ptr a)
</span><a href="Streamly.Internal.Ring.Foreign.html#unsafeInsert"><span class="hs-identifier hs-var">RB.unsafeInsert</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679427627"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427626"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679427624"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-308"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s b. s -&gt; Step s b
</span><a href="Streamly.Internal.Data.Fold.Step.html#Partial"><span class="hs-identifier hs-var">FL.Partial</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b c. a -&gt; b -&gt; c -&gt; Tuple3' a b c
</span><a href="Streamly.Internal.Data.Tuple.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679427627"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427623"><span class="hs-identifier hs-var">rh1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679427625"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">c
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span>
</span><span id="line-310"></span><span>    </span><span id="local-6989586621679427640"><span class="annot"><span class="annottext">initial :: m (Step (Tuple3' (Ring a) (Ptr a) Int) b)
</span><a href="#local-6989586621679427640"><span class="hs-identifier hs-var hs-var">initial</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-311"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679427616"><span class="annot"><span class="annottext">f :: (a, b) -&gt; Step (Tuple3' a b Int) b
</span><a href="#local-6989586621679427616"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679427615"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679427615"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679427614"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679427614"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall s b. s -&gt; Step s b
</span><a href="Streamly.Internal.Data.Fold.Step.html#Partial"><span class="hs-identifier hs-var">FL.Partial</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b c. a -&gt; b -&gt; c -&gt; Tuple3' a b c
</span><a href="Streamly.Internal.Data.Tuple.Strict.html#Tuple3%27"><span class="hs-identifier hs-var">Tuple3'</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679427615"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679427614"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">forall {a} {b} {b}. (a, b) -&gt; Step (Tuple3' a b Int) b
</span><a href="#local-6989586621679427616"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Int -&gt; IO (Ring a, Ptr a)
</span><a href="Streamly.Internal.Ring.Foreign.html#new"><span class="hs-identifier hs-var">RB.new</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427645"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span>    </span><span id="local-6989586621679427639"><span class="annot"><span class="annottext">done :: Tuple3' (Ring a) (Ptr a) Int -&gt; m (Array a)
</span><a href="#local-6989586621679427639"><span class="hs-identifier hs-var hs-var">done</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Tuple.Strict.html#Tuple3%27"><span class="hs-identifier hs-type">Tuple3'</span></a></span><span> </span><span id="local-6989586621679427601"><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679427601"><span class="hs-identifier hs-var">rb</span></a></span></span><span> </span><span id="local-6989586621679427600"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427600"><span class="hs-identifier hs-var">rh</span></a></span></span><span> </span><span id="local-6989586621679427599"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427599"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-315"></span><span>        </span><span id="local-6989586621679427598"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427598"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#newArray"><span class="hs-identifier hs-var">MA.newArray</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427645"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-316"></span><span>        </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a} {b}.
(MonadIO m, Storable a) =&gt;
Int -&gt; Ptr a -&gt; (b -&gt; a -&gt; m b) -&gt; b -&gt; Ring a -&gt; m b
</span><a href="#local-6989586621679427596"><span class="hs-identifier hs-var">foldFunc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427599"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427600"><span class="hs-identifier hs-var">rh</span></a></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a}.
(MonadIO m, Storable a) =&gt;
Array a -&gt; a -&gt; m (Array a)
</span><a href="#local-6989586621679427595"><span class="hs-identifier hs-var">snoc'</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427598"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Ring a
</span><a href="#local-6989586621679427601"><span class="hs-identifier hs-var">rb</span></a></span><span>
</span><span id="line-317"></span><span>
</span><span id="line-318"></span><span>    </span><span class="hs-comment">-- XXX We should write a read unfold for ring.</span><span>
</span><span id="line-319"></span><span>    </span><span id="local-6989586621679427595"><span class="annot"><span class="annottext">snoc' :: Array a -&gt; a -&gt; m (Array a)
</span><a href="#local-6989586621679427595"><span class="hs-identifier hs-var hs-var">snoc'</span></a></span></span><span> </span><span id="local-6989586621679427589"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427589"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679427588"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679427588"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a}.
(MonadIO m, Storable a) =&gt;
Array a -&gt; a -&gt; m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#snocUnsafe"><span class="hs-identifier hs-var">MA.snocUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427589"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679427588"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-320"></span><span>
</span><span id="line-321"></span><span>    </span><span id="local-6989586621679427596"><span class="annot"><span class="annottext">foldFunc :: Int -&gt; Ptr a -&gt; (b -&gt; a -&gt; m b) -&gt; b -&gt; Ring a -&gt; m b
</span><a href="#local-6989586621679427596"><span class="hs-identifier hs-var hs-var">foldFunc</span></a></span></span><span> </span><span id="local-6989586621679427579"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427579"><span class="hs-identifier hs-var">i</span></a></span></span><span>
</span><span id="line-322"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427579"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427645"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; (b -&gt; a -&gt; m b) -&gt; b -&gt; Ring a -&gt; m b
</span><a href="Streamly.Internal.Ring.Foreign.html#unsafeFoldRingM"><span class="hs-identifier hs-var">RB.unsafeFoldRingM</span></a></span><span>
</span><span id="line-323"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
(MonadIO m, Storable a) =&gt;
Ptr a -&gt; (b -&gt; a -&gt; m b) -&gt; b -&gt; Ring a -&gt; m b
</span><a href="Streamly.Internal.Ring.Foreign.html#unsafeFoldRingFullM"><span class="hs-identifier hs-var">RB.unsafeFoldRingFullM</span></a></span><span>
</span><span id="line-324"></span><span>
</span><span id="line-325"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-326"></span><span class="hs-comment">-- Random Access</span><span>
</span><span id="line-327"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-330"></span><span class="hs-comment">-- Searching</span><span>
</span><span id="line-331"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-332"></span><span>
</span><span id="line-333"></span><span class="hs-comment">-- | Given a sorted array, perform a binary search to find the given element.</span><span>
</span><span id="line-334"></span><span class="hs-comment">-- Returns the index of the element if found.</span><span>
</span><span id="line-335"></span><span class="hs-comment">--</span><span>
</span><span id="line-336"></span><span class="hs-comment">-- /Unimplemented/</span><span>
</span><span id="line-337"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#binarySearch"><span class="hs-pragma hs-type">binarySearch</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-338"></span><span id="local-6989586621679427970"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#binarySearch"><span class="hs-identifier hs-type">binarySearch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679427970"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427970"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span></span><span>
</span><span id="line-339"></span><span id="binarySearch"><span class="annot"><span class="annottext">binarySearch :: forall a. a -&gt; Array a -&gt; Maybe Int
</span><a href="Streamly.Internal.Data.Array.Foreign.html#binarySearch"><span class="hs-identifier hs-var hs-var">binarySearch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span class="hs-comment">-- find/findIndex etc can potentially be implemented more efficiently on arrays</span><span>
</span><span id="line-342"></span><span class="hs-comment">-- compared to streams by using SIMD instructions.</span><span>
</span><span id="line-343"></span><span class="hs-comment">-- We can also return a bit array instead.</span><span>
</span><span id="line-344"></span><span>
</span><span id="line-345"></span><span class="hs-comment">-- | Perform a linear search to find all the indices where a given element is</span><span>
</span><span id="line-346"></span><span class="hs-comment">-- present in an array.</span><span>
</span><span id="line-347"></span><span class="hs-comment">--</span><span>
</span><span id="line-348"></span><span class="hs-comment">-- /Unimplemented/</span><span>
</span><span id="line-349"></span><span id="local-6989586621679427969"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#findIndicesOf"><span class="hs-identifier hs-type">findIndicesOf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679427969"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Type.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Identity</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427969"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span></span><span>
</span><span id="line-350"></span><span id="findIndicesOf"><span class="annot"><span class="annottext">findIndicesOf :: forall a. (a -&gt; Bool) -&gt; Unfold Identity (Array a) Int
</span><a href="Streamly.Internal.Data.Array.Foreign.html#findIndicesOf"><span class="hs-identifier hs-var hs-var">findIndicesOf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-351"></span><span>
</span><span id="line-352"></span><span class="hs-comment">{-
findIndexOf :: (a -&gt; Bool) -&gt; Array a -&gt; Maybe Int
findIndexOf p = Unfold.fold Fold.head . Stream.unfold (findIndicesOf p)

find :: (a -&gt; Bool) -&gt; Array a -&gt; Bool
find = Unfold.fold Fold.null . Stream.unfold (findIndicesOf p)
-}</span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-361"></span><span class="hs-comment">-- Folds</span><span>
</span><span id="line-362"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-363"></span><span>
</span><span id="line-364"></span><span class="hs-comment">-- XXX We can potentially use SIMD instructions on arrays to fold faster.</span><span>
</span><span id="line-365"></span><span>
</span><span id="line-366"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-367"></span><span class="hs-comment">-- Slice</span><span>
</span><span id="line-368"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-369"></span><span>
</span><span id="line-370"></span><span class="hs-comment">-- | /O(1)/ Slice an array in constant time.</span><span>
</span><span id="line-371"></span><span class="hs-comment">--</span><span>
</span><span id="line-372"></span><span class="hs-comment">-- Caution: The bounds of the slice are not checked.</span><span>
</span><span id="line-373"></span><span class="hs-comment">--</span><span>
</span><span id="line-374"></span><span class="hs-comment">-- /Unsafe/</span><span>
</span><span id="line-375"></span><span class="hs-comment">--</span><span>
</span><span id="line-376"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-377"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#getSliceUnsafe"><span class="hs-pragma hs-type">getSliceUnsafe</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-378"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#getSliceUnsafe"><span class="hs-identifier hs-type">getSliceUnsafe</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-379"></span><span>       </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679427967"><span class="annot"><a href="#local-6989586621679427967"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679427967"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-380"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- ^ starting index</span><span>
</span><span id="line-381"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- ^ length of the slice</span><span>
</span><span id="line-382"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427967"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-383"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427967"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-384"></span><span id="getSliceUnsafe"><span class="annot"><span class="annottext">getSliceUnsafe :: forall a. Storable a =&gt; Int -&gt; Int -&gt; Array a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.html#getSliceUnsafe"><span class="hs-identifier hs-var hs-var">getSliceUnsafe</span></a></span></span><span> </span><span id="local-6989586621679427568"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427568"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span id="local-6989586621679427567"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427567"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621679427566"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679427566"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679427565"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427565"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679427564"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427564"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-385"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679427560"><span class="annot"><span class="annottext">size :: Int
</span><a href="#local-6989586621679427560"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679427967"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-386"></span><span>        </span><span id="local-6989586621679427558"><span class="annot"><span class="annottext">fp1 :: Ptr b
</span><a href="#local-6989586621679427558"><span class="hs-identifier hs-var hs-var">fp1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427565"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427568"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427560"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-387"></span><span>        </span><span id="local-6989586621679427556"><span class="annot"><span class="annottext">end :: Ptr b
</span><a href="#local-6989586621679427556"><span class="hs-identifier hs-var hs-var">end</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {b}. Ptr b
</span><a href="#local-6989586621679427558"><span class="hs-identifier hs-var">fp1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427567"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427560"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {b}. Ptr b
</span><a href="#local-6989586621679427556"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427564"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679427566"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">forall {b}. Ptr b
</span><a href="#local-6989586621679427558"><span class="hs-identifier hs-var">fp1</span></a></span><span> </span><span class="annot"><span class="annottext">forall {b}. Ptr b
</span><a href="#local-6989586621679427556"><span class="hs-identifier hs-var">end</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-389"></span><span>
</span><span id="line-390"></span><span class="hs-comment">-- | Split the array into a stream of slices using a predicate. The element</span><span>
</span><span id="line-391"></span><span class="hs-comment">-- matching the predicate is dropped.</span><span>
</span><span id="line-392"></span><span class="hs-comment">--</span><span>
</span><span id="line-393"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-394"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#splitOn"><span class="hs-pragma hs-type">splitOn</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-395"></span><span id="local-6989586621679427962"><span id="local-6989586621679427963"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#splitOn"><span class="hs-identifier hs-type">splitOn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679427963"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679427962"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-396"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679427962"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427962"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.Serial.html#SerialT"><span class="hs-identifier hs-type">SerialT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427963"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427962"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-397"></span><span id="splitOn"><span class="annot"><span class="annottext">splitOn :: forall (m :: * -&gt; *) a.
(Monad m, Storable a) =&gt;
(a -&gt; Bool) -&gt; Array a -&gt; SerialT m (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.html#splitOn"><span class="hs-identifier hs-var hs-var">splitOn</span></a></span></span><span> </span><span id="local-6989586621679427542"><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679427542"><span class="hs-identifier hs-var">predicate</span></a></span></span><span> </span><span id="local-6989586621679427541"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427541"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-398"></span><span>    </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(IsStream t, Monad m) =&gt;
Stream m a -&gt; t m a
</span><a href="Streamly.Internal.Data.Stream.IsStream.Type.html#fromStreamD"><span class="hs-identifier hs-var">IsStream.fromStreamD</span></a></span><span>
</span><span id="line-399"></span><span>        </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679427539"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427539"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679427538"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427538"><span class="hs-identifier hs-var">len</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Int -&gt; Int -&gt; Array a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.html#getSliceUnsafe"><span class="hs-identifier hs-var">getSliceUnsafe</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427539"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427538"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427541"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-400"></span><span>        </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
Monad m =&gt;
(a -&gt; Bool) -&gt; Stream m a -&gt; Stream m (Int, Int)
</span><a href="Streamly.Internal.Data.Stream.StreamD.Nesting.html#sliceOnSuffix"><span class="hs-identifier hs-var">D.sliceOnSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621679427542"><span class="hs-identifier hs-var">predicate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(Monad m, Storable a) =&gt;
Array a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#toStreamD"><span class="hs-identifier hs-var">A.toStreamD</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427541"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-401"></span><span>
</span><span id="line-402"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#genSlicesFromLen"><span class="hs-pragma hs-type">genSlicesFromLen</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-403"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#genSlicesFromLen"><span class="hs-identifier hs-type">genSlicesFromLen</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679427950"><span class="annot"><a href="#local-6989586621679427950"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679427949"><span class="annot"><a href="#local-6989586621679427949"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679427950"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679427949"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-404"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- ^ from index</span><span>
</span><span id="line-405"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- ^ length of the slice</span><span>
</span><span id="line-406"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Type.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427950"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427949"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span id="genSlicesFromLen"><span class="annot"><span class="annottext">genSlicesFromLen :: forall (m :: * -&gt; *) a.
(Monad m, Storable a) =&gt;
Int -&gt; Int -&gt; Unfold m (Array a) (Int, Int)
</span><a href="Streamly.Internal.Data.Array.Foreign.html#genSlicesFromLen"><span class="hs-identifier hs-var hs-var">genSlicesFromLen</span></a></span></span><span> </span><span id="local-6989586621679427531"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427531"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621679427530"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427530"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-408"></span><span>    </span><span class="annot"><span class="annottext">forall a c (m :: * -&gt; *) b.
(a -&gt; c) -&gt; Unfold m c b -&gt; Unfold m a b
</span><a href="Streamly.Internal.Data.Unfold.Type.html#lmap"><span class="hs-identifier hs-var">Unfold.lmap</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#unsafeThaw"><span class="hs-identifier hs-var">A.unsafeThaw</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(Monad m, Storable a) =&gt;
Int -&gt; Int -&gt; Unfold m (Array a) (Int, Int)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.html#genSlicesFromLen"><span class="hs-identifier hs-var">MA.genSlicesFromLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427531"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427530"><span class="hs-identifier hs-var">len</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-409"></span><span>
</span><span id="line-410"></span><span class="hs-comment">-- | Generate a stream of slices of specified length from an array, starting</span><span>
</span><span id="line-411"></span><span class="hs-comment">-- from the supplied array index. The last slice may be shorter than the</span><span>
</span><span id="line-412"></span><span class="hs-comment">-- requested length.</span><span>
</span><span id="line-413"></span><span class="hs-comment">--</span><span>
</span><span id="line-414"></span><span class="hs-comment">-- /Pre-release//</span><span>
</span><span id="line-415"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#getSlicesFromLen"><span class="hs-pragma hs-type">getSlicesFromLen</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-416"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#getSlicesFromLen"><span class="hs-identifier hs-type">getSlicesFromLen</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679427939"><span class="annot"><a href="#local-6989586621679427939"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679427938"><span class="annot"><a href="#local-6989586621679427938"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679427939"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679427938"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-417"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- ^ from index</span><span>
</span><span id="line-418"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- ^ length of the slice</span><span>
</span><span id="line-419"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Type.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427939"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427938"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427938"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-420"></span><span id="getSlicesFromLen"><span class="annot"><span class="annottext">getSlicesFromLen :: forall (m :: * -&gt; *) a.
(Monad m, Storable a) =&gt;
Int -&gt; Int -&gt; Unfold m (Array a) (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.html#getSlicesFromLen"><span class="hs-identifier hs-var hs-var">getSlicesFromLen</span></a></span></span><span> </span><span id="local-6989586621679427519"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427519"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621679427518"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427518"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-421"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#unsafeFreeze"><span class="hs-identifier hs-var">A.unsafeFreeze</span></a></span><span>
</span><span id="line-422"></span><span>        </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a c (m :: * -&gt; *) b.
(a -&gt; c) -&gt; Unfold m c b -&gt; Unfold m a b
</span><a href="Streamly.Internal.Data.Unfold.Type.html#lmap"><span class="hs-identifier hs-var">Unfold.lmap</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#unsafeThaw"><span class="hs-identifier hs-var">A.unsafeThaw</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(Monad m, Storable a) =&gt;
Int -&gt; Int -&gt; Unfold m (Array a) (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.html#getSlicesFromLen"><span class="hs-identifier hs-var">MA.getSlicesFromLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427519"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427518"><span class="hs-identifier hs-var">len</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-423"></span><span>
</span><span id="line-424"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-425"></span><span class="hs-comment">-- Random reads and writes</span><span>
</span><span id="line-426"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-427"></span><span>
</span><span id="line-428"></span><span class="hs-comment">-- XXX Change this to a partial function instead of a Maybe type? And use</span><span>
</span><span id="line-429"></span><span class="hs-comment">-- MA.getIndex instead.</span><span>
</span><span id="line-430"></span><span class="hs-comment">--</span><span>
</span><span id="line-431"></span><span class="hs-comment">-- | /O(1)/ Lookup the element at the given index. Index starts from 0.</span><span>
</span><span id="line-432"></span><span class="hs-comment">--</span><span>
</span><span id="line-433"></span><span class="hs-comment">-- @since 0.8.0</span><span>
</span><span id="line-434"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#getIndex"><span class="hs-pragma hs-type">getIndex</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-435"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#getIndex"><span class="hs-identifier hs-type">getIndex</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679427516"><span class="annot"><a href="#local-6989586621679427516"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679427516"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427516"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679427516"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-436"></span><span id="getIndex"><span class="annot"><span class="annottext">getIndex :: forall a. Storable a =&gt; Array a -&gt; Int -&gt; Maybe a
</span><a href="Streamly.Internal.Data.Array.Foreign.html#getIndex"><span class="hs-identifier hs-var hs-var">getIndex</span></a></span></span><span> </span><span id="local-6989586621679427507"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427507"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621679427506"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427506"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-437"></span><span>    </span><span class="annot"><span class="annottext">forall a. IO a -&gt; a
</span><a href="Streamly.Internal.System.IO.html#unsafeInlineIO"><span class="hs-identifier hs-var">unsafeInlineIO</span></a></span><span>
</span><span id="line-438"></span><span>        </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
MonadIO m =&gt;
ArrayContents -&gt; Ptr a -&gt; (Ptr a -&gt; m b) -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#unsafeWithArrayContents"><span class="hs-identifier hs-var">MA.unsafeWithArrayContents</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; ArrayContents
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#arrContents"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427507"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#arrStart"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427507"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span>            </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679427505"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427505"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-440"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679427501"><span class="annot"><span class="annottext">elemSize :: Int
</span><a href="#local-6989586621679427501"><span class="hs-identifier hs-var hs-var">elemSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679427516"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-441"></span><span>                    </span><span id="local-6989586621679427499"><span class="annot"><span class="annottext">elemPtr :: Ptr b
</span><a href="#local-6989586621679427499"><span class="hs-identifier hs-var hs-var">elemPtr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427505"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427501"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427506"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-442"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427506"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall {b}. Ptr b
</span><a href="#local-6989586621679427499"><span class="hs-identifier hs-var">elemPtr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><span class="hs-operator hs-var">`plusPtr`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427501"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Ptr a
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#aEnd"><span class="hs-identifier hs-var">aEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427507"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-443"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Ptr a -&gt; IO a
</span><span class="hs-identifier hs-var">peek</span></span><span> </span><span class="annot"><span class="annottext">forall {b}. Ptr b
</span><a href="#local-6989586621679427499"><span class="hs-identifier hs-var">elemPtr</span></a></span><span>
</span><span id="line-444"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-445"></span><span>
</span><span id="line-446"></span><span class="hs-comment">-- | Given a stream of array indices, read the elements on those indices from</span><span>
</span><span id="line-447"></span><span class="hs-comment">-- the supplied Array. An exception is thrown if an index is out of bounds.</span><span>
</span><span id="line-448"></span><span class="hs-comment">--</span><span>
</span><span id="line-449"></span><span class="hs-comment">-- This is the most general operation. We can implement other operations in</span><span>
</span><span id="line-450"></span><span class="hs-comment">-- terms of this:</span><span>
</span><span id="line-451"></span><span class="hs-comment">--</span><span>
</span><span id="line-452"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-453"></span><span class="hs-comment">-- read =</span><span>
</span><span id="line-454"></span><span class="hs-comment">--      let u = lmap (\arr -&gt; (0, length arr - 1)) Unfold.enumerateFromTo</span><span>
</span><span id="line-455"></span><span class="hs-comment">--       in Unfold.lmap f (getIndices arr)</span><span>
</span><span id="line-456"></span><span class="hs-comment">--</span><span>
</span><span id="line-457"></span><span class="hs-comment">-- readRev =</span><span>
</span><span id="line-458"></span><span class="hs-comment">--      let i = length arr - 1</span><span>
</span><span id="line-459"></span><span class="hs-comment">--       in Unfold.lmap f (getIndicesFromThenTo i (i - 1) 0)</span><span>
</span><span id="line-460"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-461"></span><span class="hs-comment">--</span><span>
</span><span id="line-462"></span><span class="hs-comment">-- /Unimplemented/</span><span>
</span><span id="line-463"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#getIndices"><span class="hs-pragma hs-type">getIndices</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-464"></span><span id="local-6989586621679427928"><span id="local-6989586621679427929"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#getIndices"><span class="hs-identifier hs-type">getIndices</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Type.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427929"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427928"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Type.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427929"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427928"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679427928"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-465"></span><span id="getIndices"><span class="annot"><span class="annottext">getIndices :: forall (m :: * -&gt; *) a.
Unfold m (Array a) Int -&gt; Unfold m (Array a) a
</span><a href="Streamly.Internal.Data.Array.Foreign.html#getIndices"><span class="hs-identifier hs-var hs-var">getIndices</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-466"></span><span>
</span><span id="line-467"></span><span class="hs-comment">-- | Unfolds @(from, then, to, array)@ generating a finite stream whose first</span><span>
</span><span id="line-468"></span><span class="hs-comment">-- element is the array value from the index @from@ and the successive elements</span><span>
</span><span id="line-469"></span><span class="hs-comment">-- are from the indices in increments of @then@ up to @to@. Index enumeration</span><span>
</span><span id="line-470"></span><span class="hs-comment">-- can occur downwards or upwards depending on whether @then@ comes before or</span><span>
</span><span id="line-471"></span><span class="hs-comment">-- after @from@.</span><span>
</span><span id="line-472"></span><span class="hs-comment">--</span><span>
</span><span id="line-473"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-474"></span><span class="hs-comment">-- getIndicesFromThenTo =</span><span>
</span><span id="line-475"></span><span class="hs-comment">--     let f (from, next, to, arr) =</span><span>
</span><span id="line-476"></span><span class="hs-comment">--             (Stream.enumerateFromThenTo from next to, arr)</span><span>
</span><span id="line-477"></span><span class="hs-comment">--      in Unfold.lmap f getIndices</span><span>
</span><span id="line-478"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-479"></span><span class="hs-comment">--</span><span>
</span><span id="line-480"></span><span class="hs-comment">-- /Unimplemented/</span><span>
</span><span id="line-481"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#getIndicesFromThenTo"><span class="hs-pragma hs-type">getIndicesFromThenTo</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-482"></span><span id="local-6989586621679427926"><span id="local-6989586621679427927"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#getIndicesFromThenTo"><span class="hs-identifier hs-type">getIndicesFromThenTo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Unfold.Type.html#Unfold"><span class="hs-identifier hs-type">Unfold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427927"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427926"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679427926"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-483"></span><span id="getIndicesFromThenTo"><span class="annot"><span class="annottext">getIndicesFromThenTo :: forall (m :: * -&gt; *) a. Unfold m (Int, Int, Int, Array a) a
</span><a href="Streamly.Internal.Data.Array.Foreign.html#getIndicesFromThenTo"><span class="hs-identifier hs-var hs-var">getIndicesFromThenTo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span>
</span><span id="line-484"></span><span>
</span><span id="line-485"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-486"></span><span class="hs-comment">-- Transform via stream operations</span><span>
</span><span id="line-487"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-488"></span><span>
</span><span id="line-489"></span><span class="hs-comment">-- for non-length changing operations we can use the original length for</span><span>
</span><span id="line-490"></span><span class="hs-comment">-- allocation. If we can predict the length then we can use the prediction for</span><span>
</span><span id="line-491"></span><span class="hs-comment">-- new allocation. Otherwise we can use a hint and adjust dynamically.</span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span class="hs-comment">{-
-- | Transform an array into another array using a pipe transformation
-- operation.
--
-- @since 0.7.0
{-# INLINE runPipe #-}
runPipe :: (MonadIO m, Storable a, Storable b)
    =&gt; Pipe m a b -&gt; Array a -&gt; m (Array b)
runPipe f arr = P.runPipe (toArrayMinChunk (length arr)) $ f (A.read arr)
-}</span><span>
</span><span id="line-503"></span><span>
</span><span id="line-504"></span><span class="hs-comment">-- XXX For transformations that cannot change the number of elements e.g. &quot;map&quot;</span><span>
</span><span id="line-505"></span><span class="hs-comment">-- we can use a predetermined array length.</span><span>
</span><span id="line-506"></span><span class="hs-comment">--</span><span>
</span><span id="line-507"></span><span class="hs-comment">-- | Transform an array into another array using a stream transformation</span><span>
</span><span id="line-508"></span><span class="hs-comment">-- operation.</span><span>
</span><span id="line-509"></span><span class="hs-comment">--</span><span>
</span><span id="line-510"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-511"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#streamTransform"><span class="hs-pragma hs-type">streamTransform</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-512"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#streamTransform"><span class="hs-identifier hs-type">streamTransform</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679427925"><span class="annot"><a href="#local-6989586621679427925"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679427924"><span class="annot"><a href="#local-6989586621679427924"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679427923"><span class="annot"><a href="#local-6989586621679427923"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679427925"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679427924"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679427923"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-513"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.Serial.html#SerialT"><span class="hs-identifier hs-type">SerialT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427925"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427924"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Stream.Serial.html#SerialT"><span class="hs-identifier hs-type">SerialT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427925"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427923"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427924"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679427925"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427923"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-514"></span><span id="streamTransform"><span class="annot"><span class="annottext">streamTransform :: forall (m :: * -&gt; *) a b.
(MonadIO m, Storable a, Storable b) =&gt;
(SerialT m a -&gt; SerialT m b) -&gt; Array a -&gt; m (Array b)
</span><a href="Streamly.Internal.Data.Array.Foreign.html#streamTransform"><span class="hs-identifier hs-var hs-var">streamTransform</span></a></span></span><span> </span><span id="local-6989586621679427484"><span class="annot"><span class="annottext">SerialT m a -&gt; SerialT m b
</span><a href="#local-6989586621679427484"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679427483"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427483"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-515"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
Monad m =&gt;
Fold m a b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.Prelude.html#fold"><span class="hs-identifier hs-var">P.fold</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, Storable a) =&gt;
Int -&gt; Fold m a (Array a)
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#writeWith"><span class="hs-identifier hs-var">A.writeWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Storable a =&gt; Array a -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427483"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. SerialT m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.Serial.html#getSerialT"><span class="hs-identifier hs-var">getSerialT</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SerialT m a -&gt; SerialT m b
</span><a href="#local-6989586621679427484"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(Monad m, Storable a) =&gt;
Array a -&gt; SerialT m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#toStream"><span class="hs-identifier hs-var">A.toStream</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427483"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-516"></span><span>
</span><span id="line-517"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-518"></span><span class="hs-comment">-- Casts</span><span>
</span><span id="line-519"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-520"></span><span>
</span><span id="line-521"></span><span class="hs-comment">-- | Cast an array having elements of type @a@ into an array having elements of</span><span>
</span><span id="line-522"></span><span class="hs-comment">-- type @b@. The array size must be a multiple of the size of type @b@</span><span>
</span><span id="line-523"></span><span class="hs-comment">-- otherwise accessing the last element of the array may result into a crash or</span><span>
</span><span id="line-524"></span><span class="hs-comment">-- a random value.</span><span>
</span><span id="line-525"></span><span class="hs-comment">--</span><span>
</span><span id="line-526"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-527"></span><span class="hs-comment">--</span><span>
</span><span id="line-528"></span><span id="local-6989586621679427911"><span id="local-6989586621679427912"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#unsafeCast"><span class="hs-identifier hs-type">unsafeCast</span></a></span><span> </span><span class="hs-glyph">::</span><span class="hs-cpp">
#ifdef DEVBUILD
</span><span>    </span><span class="hs-identifier">Storable</span><span> </span><span class="hs-identifier">b</span><span> </span><span class="hs-glyph">=&gt;</span><span class="hs-cpp">
#endif
</span><span>    </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427912"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427911"><span class="hs-identifier hs-type">b</span></a></span></span></span><span>
</span><span id="line-533"></span><span id="unsafeCast"><span class="annot"><span class="annottext">unsafeCast :: forall a b. Array a -&gt; Array b
</span><a href="Streamly.Internal.Data.Array.Foreign.html#unsafeCast"><span class="hs-identifier hs-var hs-var">unsafeCast</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621679427480"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679427480"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span id="local-6989586621679427479"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427479"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679427478"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427478"><span class="hs-identifier hs-var">end</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-534"></span><span>    </span><span class="annot"><span class="annottext">forall a. ArrayContents -&gt; Ptr a -&gt; Ptr a -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679427480"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427479"><span class="hs-identifier hs-var">start</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427478"><span class="hs-identifier hs-var">end</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-535"></span><span>
</span><span id="line-536"></span><span class="hs-comment">-- | Cast an @Array a@ into an @Array Word8@.</span><span>
</span><span id="line-537"></span><span class="hs-comment">--</span><span>
</span><span id="line-538"></span><span class="hs-comment">-- @since 0.8.0</span><span>
</span><span id="line-539"></span><span class="hs-comment">--</span><span>
</span><span id="line-540"></span><span id="local-6989586621679427907"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#asBytes"><span class="hs-identifier hs-type">asBytes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427907"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span></span><span>
</span><span id="line-541"></span><span id="asBytes"><span class="annot"><span class="annottext">asBytes :: forall a. Array a -&gt; Array Word8
</span><a href="Streamly.Internal.Data.Array.Foreign.html#asBytes"><span class="hs-identifier hs-var hs-var">asBytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. Array a -&gt; Array b
</span><a href="Streamly.Internal.Data.Array.Foreign.html#unsafeCast"><span class="hs-identifier hs-var">unsafeCast</span></a></span><span>
</span><span id="line-542"></span><span>
</span><span id="line-543"></span><span class="hs-comment">-- | Cast an array having elements of type @a@ into an array having elements of</span><span>
</span><span id="line-544"></span><span class="hs-comment">-- type @b@. The length of the array should be a multiple of the size of the</span><span>
</span><span id="line-545"></span><span class="hs-comment">-- target element otherwise 'Nothing' is returned.</span><span>
</span><span id="line-546"></span><span class="hs-comment">--</span><span>
</span><span id="line-547"></span><span class="hs-comment">-- @since 0.8.0</span><span>
</span><span id="line-548"></span><span class="hs-comment">--</span><span>
</span><span id="line-549"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#cast"><span class="hs-identifier hs-type">cast</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679427905"><span class="annot"><a href="#local-6989586621679427905"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679427906"><span class="annot"><a href="#local-6989586621679427906"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679427906"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427905"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427906"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-550"></span><span id="cast"><span class="annot"><span class="annottext">cast :: forall a b. Storable b =&gt; Array a -&gt; Maybe (Array b)
</span><a href="Streamly.Internal.Data.Array.Foreign.html#cast"><span class="hs-identifier hs-var hs-var">cast</span></a></span></span><span> </span><span id="local-6989586621679427474"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427474"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-551"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679427473"><span class="annot"><span class="annottext">len :: Int
</span><a href="#local-6989586621679427473"><span class="hs-identifier hs-var hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Int
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#byteLength"><span class="hs-identifier hs-var">A.byteLength</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427474"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-552"></span><span>        </span><span id="local-6989586621679427467"><span class="annot"><span class="annottext">r :: Int
</span><a href="#local-6989586621679427467"><span class="hs-identifier hs-var hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427473"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`mod`</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">sizeOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679427906"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-553"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679427467"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-554"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-555"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. Array a -&gt; Array b
</span><a href="Streamly.Internal.Data.Array.Foreign.html#unsafeCast"><span class="hs-identifier hs-var">unsafeCast</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427474"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-556"></span><span>
</span><span id="line-557"></span><span class="hs-comment">-- | Use an @Array a@ as @Ptr b@.</span><span>
</span><span id="line-558"></span><span class="hs-comment">--</span><span>
</span><span id="line-559"></span><span class="hs-comment">-- /Unsafe/</span><span>
</span><span id="line-560"></span><span class="hs-comment">--</span><span>
</span><span id="line-561"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-562"></span><span class="hs-comment">--</span><span>
</span><span id="line-563"></span><span id="local-6989586621679427899"><span id="local-6989586621679427900"><span id="local-6989586621679427901"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#unsafeAsPtr"><span class="hs-identifier hs-type">unsafeAsPtr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427901"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ptr</span></span><span> </span><span class="annot"><a href="#local-6989586621679427900"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679427899"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679427899"><span class="hs-identifier hs-type">c</span></a></span></span></span></span><span>
</span><span id="line-564"></span><span id="unsafeAsPtr"><span class="annot"><span class="annottext">unsafeAsPtr :: forall a b c. Array a -&gt; (Ptr b -&gt; IO c) -&gt; IO c
</span><a href="Streamly.Internal.Data.Array.Foreign.html#unsafeAsPtr"><span class="hs-identifier hs-var hs-var">unsafeAsPtr</span></a></span></span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679427461"><span id="local-6989586621679427462"><span id="local-6989586621679427463"><span class="annot"><span class="annottext">Ptr a
ArrayContents
aEnd :: Ptr a
arrStart :: Ptr a
arrContents :: ArrayContents
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679427461"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679427460"><span class="annot"><span class="annottext">Ptr b -&gt; IO c
</span><a href="#local-6989586621679427460"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-565"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
MonadIO m =&gt;
ArrayContents -&gt; Ptr a -&gt; (Ptr a -&gt; m b) -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#unsafeWithArrayContents"><span class="hs-identifier hs-var">MA.unsafeWithArrayContents</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679427463"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427462"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679427459"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427459"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Ptr b -&gt; IO c
</span><a href="#local-6989586621679427460"><span class="hs-identifier hs-var">act</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679427459"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-566"></span><span>
</span><span id="line-567"></span><span class="hs-comment">-- | Convert an array of any type into a null terminated CString Ptr.</span><span>
</span><span id="line-568"></span><span class="hs-comment">--</span><span>
</span><span id="line-569"></span><span class="hs-comment">-- /Unsafe/</span><span>
</span><span id="line-570"></span><span class="hs-comment">--</span><span>
</span><span id="line-571"></span><span class="hs-comment">-- /O(n) Time: (creates a copy of the array)/</span><span>
</span><span id="line-572"></span><span class="hs-comment">--</span><span>
</span><span id="line-573"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-574"></span><span class="hs-comment">--</span><span>
</span><span id="line-575"></span><span id="local-6989586621679427893"><span id="local-6989586621679427895"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#unsafeAsCString"><span class="hs-identifier hs-type">unsafeAsCString</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427895"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679427893"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679427893"><span class="hs-identifier hs-type">b</span></a></span></span></span><span>
</span><span id="line-576"></span><span id="unsafeAsCString"><span class="annot"><span class="annottext">unsafeAsCString :: forall a b. Array a -&gt; (CString -&gt; IO b) -&gt; IO b
</span><a href="Streamly.Internal.Data.Array.Foreign.html#unsafeAsCString"><span class="hs-identifier hs-var hs-var">unsafeAsCString</span></a></span></span><span> </span><span id="local-6989586621679427457"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427457"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621679427456"><span class="annot"><span class="annottext">CString -&gt; IO b
</span><a href="#local-6989586621679427456"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-577"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span class="hs-special">{</span><span id="local-6989586621679427446"><span id="local-6989586621679427447"><span id="local-6989586621679427448"><span class="annot"><span class="annottext">Ptr Word8
ArrayContents
aEnd :: Ptr Word8
arrStart :: Ptr Word8
arrContents :: ArrayContents
aEnd :: forall a. Array a -&gt; Ptr a
arrStart :: forall a. Array a -&gt; Ptr a
arrContents :: forall a. Array a -&gt; ArrayContents
</span><a href="#local-6989586621679427446"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Array a -&gt; Array Word8
</span><a href="Streamly.Internal.Data.Array.Foreign.html#asBytes"><span class="hs-identifier hs-var">asBytes</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427457"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Storable a =&gt; [a] -&gt; Array a
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#fromList"><span class="hs-identifier hs-var">A.fromList</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span>
</span><span id="line-578"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
MonadIO m =&gt;
ArrayContents -&gt; Ptr a -&gt; (Ptr a -&gt; m b) -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.Mut.Type.html#unsafeWithArrayContents"><span class="hs-identifier hs-var">MA.unsafeWithArrayContents</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621679427448"><span class="hs-identifier hs-var">arrContents</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679427447"><span class="hs-identifier hs-var">arrStart</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679427445"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679427445"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CString -&gt; IO b
</span><a href="#local-6989586621679427456"><span class="hs-identifier hs-var">act</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. Ptr a -&gt; Ptr b
</span><span class="hs-identifier hs-var">castPtr</span></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679427445"><span class="hs-identifier hs-var">ptr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-579"></span><span>
</span><span id="line-580"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-581"></span><span class="hs-comment">-- Folds</span><span>
</span><span id="line-582"></span><span class="hs-comment">-------------------------------------------------------------------------------</span><span>
</span><span id="line-583"></span><span>
</span><span id="line-584"></span><span class="hs-comment">-- | Fold an array using a 'Fold'.</span><span>
</span><span id="line-585"></span><span class="hs-comment">--</span><span>
</span><span id="line-586"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-587"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#fold"><span class="hs-pragma hs-type">fold</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-588"></span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#fold"><span class="hs-identifier hs-type">fold</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679427887"><span class="annot"><a href="#local-6989586621679427887"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679427886"><span class="annot"><a href="#local-6989586621679427886"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679427885"><span class="annot"><a href="#local-6989586621679427885"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679427887"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679427886"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Fold.Type.html#Fold"><span class="hs-identifier hs-type">Fold</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427887"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427886"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427885"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427886"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679427887"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427885"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-589"></span><span id="fold"><span class="annot"><span class="annottext">fold :: forall (m :: * -&gt; *) a b.
(MonadIO m, Storable a) =&gt;
Fold m a b -&gt; Array a -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.html#fold"><span class="hs-identifier hs-var hs-var">fold</span></a></span></span><span> </span><span id="local-6989586621679427438"><span class="annot"><span class="annottext">Fold m a b
</span><a href="#local-6989586621679427438"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679427437"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427437"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
Monad m =&gt;
Fold m a b -&gt; Stream m a -&gt; m b
</span><a href="Streamly.Internal.Data.Stream.Prelude.html#fold"><span class="hs-identifier hs-var">P.fold</span></a></span><span> </span><span class="annot"><span class="annottext">Fold m a b
</span><a href="#local-6989586621679427438"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. SerialT m a -&gt; Stream m a
</span><a href="Streamly.Internal.Data.Stream.Serial.html#getSerialT"><span class="hs-identifier hs-var">getSerialT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(Monad m, Storable a) =&gt;
Array a -&gt; SerialT m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#toStream"><span class="hs-identifier hs-var">A.toStream</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427437"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-590"></span><span>
</span><span id="line-591"></span><span class="hs-comment">-- | Fold an array using a stream fold operation.</span><span>
</span><span id="line-592"></span><span class="hs-comment">--</span><span>
</span><span id="line-593"></span><span class="hs-comment">-- /Pre-release/</span><span>
</span><span id="line-594"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#streamFold"><span class="hs-pragma hs-type">streamFold</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-595"></span><span id="local-6989586621679427879"><span id="local-6989586621679427880"><span id="local-6989586621679427881"><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.html#streamFold"><span class="hs-identifier hs-type">streamFold</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679427881"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Storable</span></span><span> </span><span class="annot"><a href="#local-6989586621679427880"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Streamly.Internal.Data.Stream.Serial.html#SerialT"><span class="hs-identifier hs-type">SerialT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427881"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427880"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679427881"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427879"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Streamly.Internal.Data.Array.Foreign.Type.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427880"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679427881"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679427879"><span class="hs-identifier hs-type">b</span></a></span></span></span></span><span>
</span><span id="line-596"></span><span id="streamFold"><span class="annot"><span class="annottext">streamFold :: forall (m :: * -&gt; *) a b.
(MonadIO m, Storable a) =&gt;
(SerialT m a -&gt; m b) -&gt; Array a -&gt; m b
</span><a href="Streamly.Internal.Data.Array.Foreign.html#streamFold"><span class="hs-identifier hs-var hs-var">streamFold</span></a></span></span><span> </span><span id="local-6989586621679427431"><span class="annot"><span class="annottext">SerialT m a -&gt; m b
</span><a href="#local-6989586621679427431"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679427430"><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427430"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SerialT m a -&gt; m b
</span><a href="#local-6989586621679427431"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(Monad m, Storable a) =&gt;
Array a -&gt; SerialT m a
</span><a href="Streamly.Internal.Data.Array.Foreign.Type.html#toStream"><span class="hs-identifier hs-var">A.toStream</span></a></span><span> </span><span class="annot"><span class="annottext">Array a
</span><a href="#local-6989586621679427430"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-597"></span></pre></body></html>