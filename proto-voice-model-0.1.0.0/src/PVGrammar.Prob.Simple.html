<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE PartialTypeSignatures #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-partial-type-signatures #-}</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-comment">{- | This module contains a simple (and musically rather naive)
 probabilistic model of protovoice derivations.
 This model can be used to sample a derivation,
 evaluate a derivations probability,
 or infer posterior distributions of the model parmeters from given derivations
 (i.e., &quot;learn&quot; the model's probabilities).

 This model is a /locally conjugate/ model:
 It samples a derivation using a sequence of random decisions with certain probabilities.
 These probabilities are generally unknown, so they are themselves modeled as random variables with prior distributions.
 The full model \(p(d, \theta)\) thus splits into
 \[p(D, \theta) = p(d \mid \theta) \cdot p(\theta),\]
 the prior over the probability variables
 \[p(\theta) = \prod_i p(\theta_i),\]
 and the likelihood of the derivation(s) given these probabilities
 \[p(D \mid \theta) = \prod_{d \in D} p(d \mid \theta) = \prod_{d \in D} \prod_i p(d_i \mid \theta, d_0, \ldots, d_{i-1}).\]
 Given all prior decisions, the likelihood of a decision \(d_i\) based on some parameter \(\theta_a\)
 \[p(d_i \mid \theta, d_{&lt;i})\]
 is [conjugate](https://en.wikipedia.org/wiki/Conjugate_prior) with the prior of that parameter \(p(\theta_a)\),
 which means that the posterior of the parameters given one (or several) derivation(s) \(p(\theta \mid D)\)
 can be computed analytically.

 The parameters \(\theta\) and their prior distributions
 are represented by the higher-kinded type 'PVParams'.
 Different instantiations of this type (using 'Hyper' or 'Probs') results in concrete record types
 that represent prior or posterior distributions
 or concrete values (probabilities) for the parameters.
 'PVParams' also supports 'jeffreysPrior' and 'uniformPrior' as default priors,
as well as 'sampleProbs' for sampling from a prior (see &quot;Inferenc.Conjugate&quot;).

 The likelihood \(p(d \mid \theta)\) of a derivation is represented by
 'sampleDerivation'.
 It can be executed under different &quot;modes&quot; (probability monads)
 for sampling, inference, or tracing (see &quot;Inference.Conjugate&quot;).
 The decisions during the derivation are represented by a 'Trace' (here @Trace PVParams@).
 In order to learn from a given derivation,
 the corresponding trace can be obtained using 'observeDerivation'.
 A combination of getting a trace and learning from it
 is provided by 'trainSinglePiece'.
-}</span><span>
</span><span id="line-48"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">PVGrammar.Prob.Simple</span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Model Parameters</span></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-comment">-- | A higher-kinded type that represents the global parameters (probabilities) of the model.</span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-comment">-- Use it as 'Hyper PVParams' to represent hyperparameters (priors and posteriors)</span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-comment">-- or as 'Probs PVParams' to represent actual probabilites.</span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-comment">-- Each record field corresponds to one parameter</span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-comment">-- that influences a specific type of decision in the generation process.</span><span>
</span><span id="line-56"></span><span>    </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier">PVParams</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsOuter"><span class="hs-identifier">PVParamsOuter</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier">PVParamsInner</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Likelihood Model</span></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-comment">-- | 'sampleDerivation' represents a probabilistic program that samples a derivation.</span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-comment">-- that can be interpreted in various modes for</span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-comment">-- - sampling ('sampleTrace', 'sampleResult'),</span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-comment">-- - inference ('evalTraceLogP', 'getPosterior'),</span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-comment">-- - tracing ('showTrace', 'traceTrace').</span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-comment">-- 'observeDerivation' takes and existing derivation and returns the corresponding trace.</span><span>
</span><span id="line-70"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleDerivation"><span class="hs-identifier">sampleDerivation</span></a></span><span>
</span><span id="line-71"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleDerivation%27"><span class="hs-identifier">sampleDerivation'</span></a></span><span>
</span><span id="line-72"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeDerivation"><span class="hs-identifier">observeDerivation</span></a></span><span>
</span><span id="line-73"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeDerivation%27"><span class="hs-identifier">observeDerivation'</span></a></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Utilities</span></span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#roundtrip"><span class="hs-identifier">roundtrip</span></a></span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#trainSinglePiece"><span class="hs-identifier">trainSinglePiece</span></a></span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Common.html"><span class="hs-identifier">Common</span></a></span><span>
</span><span id="line-81"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Common.html#Analysis"><span class="hs-identifier">Analysis</span></a></span><span>
</span><span id="line-82"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Common.html#anaDerivation"><span class="hs-identifier">anaDerivation</span></a></span><span>
</span><span id="line-83"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#anaTop"><span class="hs-identifier">anaTop</span></a></span><span>
</span><span id="line-84"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#Leftmost"><span class="hs-identifier">Leftmost</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#LeftmostDouble"><span class="hs-identifier">LeftmostDouble</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#LeftmostSingle"><span class="hs-identifier">LeftmostSingle</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier">Path</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#StartStop"><span class="hs-identifier">StartStop</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#getInner"><span class="hs-identifier">getInner</span></a></span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PVGrammar.html"><span class="hs-identifier">PVGrammar</span></a></span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html"><span class="hs-identifier">PVGrammar.Generate</span></a></span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#applySplit"><span class="hs-identifier">applySplit</span></a></span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#applySpread"><span class="hs-identifier">applySpread</span></a></span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#freezable"><span class="hs-identifier">freezable</span></a></span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">guard</span></span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unless</span></span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">when</span></span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">lift</span></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Except</span></span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">except</span></span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">runExceptT</span></span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.State</span></span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">StateT</span></span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">execStateT</span></span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Bi</span></span><span>
</span><span id="line-114"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">forM_</span></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HM</span></span><span>
</span><span id="line-116"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashSet</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-117"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hashable</span></span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-119"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-120"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">catMaybes</span></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">fromMaybe</span></span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Debug.Trace</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DT</span></span><span>
</span><span id="line-125"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Generics</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Inference.Conjugate</span></span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span class="hs-comment">-- import qualified Inference.Conjugate           as IC</span><span>
</span><span id="line-129"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Internal.MultiSet.html"><span class="hs-identifier">Internal.MultiSet</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MS</span></span><span>
</span><span id="line-130"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Lens.Micro.TH</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">makeLenses</span></span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Musicology.Pitch</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MP</span></span><span> </span><span class="hs-keyword">hiding</span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">a</span></span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">b</span></span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">c</span></span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">d</span></span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">e</span></span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">f</span></span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">g</span></span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Random.MWC.Probability</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">categorical</span></span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="hs-comment">-- | Parameters for decisions about outer operations (split, spread, freeze).</span><span>
</span><span id="line-143"></span><span id="local-6989586621679468412"><span id="local-6989586621679468413"></span></span><span class="hs-keyword">data</span><span> </span><span id="PVParamsOuter"><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsOuter"><span class="hs-identifier hs-var">PVParamsOuter</span></a></span></span><span> </span><span id="local-6989586621679469424"><span class="annot"><a href="#local-6989586621679469424"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PVParamsOuter"><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsOuter"><span class="hs-identifier hs-var">PVParamsOuter</span></a></span></span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_pSingleFreeze"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsOuter f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pSingleFreeze"><span class="hs-identifier hs-var hs-var">_pSingleFreeze</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469424"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pDoubleLeft"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsOuter f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pDoubleLeft"><span class="hs-identifier hs-var hs-var">_pDoubleLeft</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469424"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pDoubleLeftFreeze"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsOuter f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pDoubleLeftFreeze"><span class="hs-identifier hs-var hs-var">_pDoubleLeftFreeze</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469424"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pDoubleRightSplit"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsOuter f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pDoubleRightSplit"><span class="hs-identifier hs-var hs-var">_pDoubleRightSplit</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469424"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (f :: * -&gt; *) x. Rep (PVParamsOuter f) x -&gt; PVParamsOuter f
forall (f :: * -&gt; *) x. PVParamsOuter f -&gt; Rep (PVParamsOuter f) x
$cto :: forall (f :: * -&gt; *) x. Rep (PVParamsOuter f) x -&gt; PVParamsOuter f
$cfrom :: forall (f :: * -&gt; *) x. PVParamsOuter f -&gt; Rep (PVParamsOuter f) x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span id="local-6989586621679468392"><span id="local-6989586621679468394"><span id="local-6989586621679468401"><span id="local-6989586621679469416"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679469416"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsOuter"><span class="hs-identifier hs-type">PVParamsOuter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679469416"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span id="pSingleFreeze"><span id="pDoubleRightSplit"><span id="pDoubleLeftFreeze"><span id="pDoubleLeft"><span id="local-6989586621679469424"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">PVParamsOuter</span></span></span></span></span></span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span class="hs-comment">{- | Parameters for decisions about inner operations
 (elaboration and distribution within splits and spreads).
-}</span><span>
</span><span id="line-158"></span><span id="local-6989586621679468353"><span id="local-6989586621679468354"></span></span><span class="hs-keyword">data</span><span> </span><span id="PVParamsInner"><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-var">PVParamsInner</span></a></span></span><span> </span><span id="local-6989586621679469402"><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PVParamsInner"><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-var">PVParamsInner</span></a></span></span><span>
</span><span id="line-159"></span><span>  </span><span class="hs-comment">-- split</span><span>
</span><span id="line-160"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_pElaborateRegular"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pElaborateRegular"><span class="hs-identifier hs-var hs-var">_pElaborateRegular</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-161"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pElaborateL"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pElaborateL"><span class="hs-identifier hs-var hs-var">_pElaborateL</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-162"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pElaborateR"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pElaborateR"><span class="hs-identifier hs-var hs-var">_pElaborateR</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-163"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pRootFifths"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pRootFifths"><span class="hs-identifier hs-var hs-var">_pRootFifths</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-164"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pKeepL"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pKeepL"><span class="hs-identifier hs-var hs-var">_pKeepL</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-165"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pKeepR"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pKeepR"><span class="hs-identifier hs-var hs-var">_pKeepR</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-166"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pRepeatOverNeighbor"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pRepeatOverNeighbor"><span class="hs-identifier hs-var hs-var">_pRepeatOverNeighbor</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pNBChromatic"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pNBChromatic"><span class="hs-identifier hs-var hs-var">_pNBChromatic</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pNBAlt"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pNBAlt"><span class="hs-identifier hs-var hs-var">_pNBAlt</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pRepeatLeftOverRight"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pRepeatLeftOverRight"><span class="hs-identifier hs-var hs-var">_pRepeatLeftOverRight</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pRepeatAlter"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pRepeatAlter"><span class="hs-identifier hs-var hs-var">_pRepeatAlter</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-171"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pRepeatAlterUp"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pRepeatAlterUp"><span class="hs-identifier hs-var hs-var">_pRepeatAlterUp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pRepeatAlterSemis"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pRepeatAlterSemis"><span class="hs-identifier hs-var hs-var">_pRepeatAlterSemis</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-173"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pConnect"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pConnect"><span class="hs-identifier hs-var hs-var">_pConnect</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-174"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pConnectChromaticLeftOverRight"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pConnectChromaticLeftOverRight"><span class="hs-identifier hs-var hs-var">_pConnectChromaticLeftOverRight</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-175"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pPassUp"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pPassUp"><span class="hs-identifier hs-var hs-var">_pPassUp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-176"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pPassLeftOverRight"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pPassLeftOverRight"><span class="hs-identifier hs-var hs-var">_pPassLeftOverRight</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-177"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pNewPassingLeft"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pNewPassingLeft"><span class="hs-identifier hs-var hs-var">_pNewPassingLeft</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pNewPassingRight"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pNewPassingRight"><span class="hs-identifier hs-var hs-var">_pNewPassingRight</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-179"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- spread</span><span>
</span><span id="line-180"></span><span>    </span><span id="_pNewPassingMid"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pNewPassingMid"><span class="hs-identifier hs-var hs-var">_pNewPassingMid</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pNoteSpreadDirection"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f (Dirichlet 3)
</span><a href="PVGrammar.Prob.Simple.html#_pNoteSpreadDirection"><span class="hs-identifier hs-var hs-var">_pNoteSpreadDirection</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Dirichlet</span></span><span> </span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pNotesOnOtherSide"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pNotesOnOtherSide"><span class="hs-identifier hs-var hs-var">_pNotesOnOtherSide</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pSpreadRepetitionEdge"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParamsInner f -&gt; f Beta
</span><a href="PVGrammar.Prob.Simple.html#_pSpreadRepetitionEdge"><span class="hs-identifier hs-var hs-var">_pSpreadRepetitionEdge</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679469402"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-184"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-185"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (f :: * -&gt; *) x. Rep (PVParamsInner f) x -&gt; PVParamsInner f
forall (f :: * -&gt; *) x. PVParamsInner f -&gt; Rep (PVParamsInner f) x
$cto :: forall (f :: * -&gt; *) x. Rep (PVParamsInner f) x -&gt; PVParamsInner f
$cfrom :: forall (f :: * -&gt; *) x. PVParamsInner f -&gt; Rep (PVParamsInner f) x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span id="local-6989586621679468296"><span id="local-6989586621679468298"><span id="local-6989586621679468324"><span id="local-6989586621679469378"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679469378"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679469378"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679469378"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679469378"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Dirichlet</span></span><span> </span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679469378"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679469378"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span id="pSpreadRepetitionEdge"><span id="pRootFifths"><span id="pRepeatOverNeighbor"><span id="pRepeatLeftOverRight"><span id="pRepeatAlterUp"><span id="pRepeatAlterSemis"><span id="pRepeatAlter"><span id="pPassUp"><span id="pPassLeftOverRight"><span id="pNotesOnOtherSide"><span id="pNoteSpreadDirection"><span id="pNewPassingRight"><span id="pNewPassingMid"><span id="pNewPassingLeft"><span id="pNBChromatic"><span id="pNBAlt"><span id="pKeepR"><span id="pKeepL"><span id="pElaborateRegular"><span id="pElaborateR"><span id="pElaborateL"><span id="pConnectChromaticLeftOverRight"><span id="pConnect"><span id="local-6989586621679469402"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">PVParamsInner</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="hs-comment">-- | The combined parameters for inner and outer operations.</span><span>
</span><span id="line-199"></span><span id="local-6989586621679467650"><span id="local-6989586621679467651"></span></span><span class="hs-keyword">data</span><span> </span><span id="PVParams"><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-var">PVParams</span></a></span></span><span> </span><span id="local-6989586621679469330"><span class="annot"><a href="#local-6989586621679469330"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PVParams"><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-var">PVParams</span></a></span></span><span>
</span><span id="line-200"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_pOuter"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParams f -&gt; PVParamsOuter f
</span><a href="PVGrammar.Prob.Simple.html#_pOuter"><span class="hs-identifier hs-var hs-var">_pOuter</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsOuter"><span class="hs-identifier hs-type">PVParamsOuter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679469330"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-201"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pInner"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). PVParams f -&gt; PVParamsInner f
</span><a href="PVGrammar.Prob.Simple.html#_pInner"><span class="hs-identifier hs-var hs-var">_pInner</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679469330"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (f :: * -&gt; *) x. Rep (PVParams f) x -&gt; PVParams f
forall (f :: * -&gt; *) x. PVParams f -&gt; Rep (PVParams f) x
$cto :: forall (f :: * -&gt; *) x. Rep (PVParams f) x -&gt; PVParams f
$cfrom :: forall (f :: * -&gt; *) x. PVParams f -&gt; Rep (PVParams f) x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span id="local-6989586621679467635"><span id="local-6989586621679467637"><span id="local-6989586621679467642"><span id="local-6989586621679469327"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679469327"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679469327"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679469327"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679469327"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Dirichlet</span></span><span> </span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679469327"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span class="hs-special">)</span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679469327"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-213"></span><span>
</span><span id="line-214"></span><span id="pOuter"><span id="pInner"><span id="local-6989586621679469330"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">PVParams</span></span></span></span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span class="hs-keyword">data</span><span> </span><span id="MagicalOctaves"><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalOctaves"><span class="hs-identifier hs-var">MagicalOctaves</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MagicalOctaves"><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalOctaves"><span class="hs-identifier hs-var">MagicalOctaves</span></a></span></span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679467616"><span id="local-6989586621679467618"><span class="annot"><span class="annottext">MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
$c/= :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
== :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
$c== :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467596"><span id="local-6989586621679467598"><span id="local-6989586621679467601"><span id="local-6989586621679467604"><span id="local-6989586621679467607"><span id="local-6989586621679467609"><span id="local-6989586621679467611"><span class="annot"><span class="annottext">Eq MagicalOctaves
MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
MagicalOctaves -&gt; MagicalOctaves -&gt; Ordering
MagicalOctaves -&gt; MagicalOctaves -&gt; MagicalOctaves
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: MagicalOctaves -&gt; MagicalOctaves -&gt; MagicalOctaves
$cmin :: MagicalOctaves -&gt; MagicalOctaves -&gt; MagicalOctaves
max :: MagicalOctaves -&gt; MagicalOctaves -&gt; MagicalOctaves
$cmax :: MagicalOctaves -&gt; MagicalOctaves -&gt; MagicalOctaves
&gt;= :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
$c&gt;= :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
&gt; :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
$c&gt; :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
&lt;= :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
$c&lt;= :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
&lt; :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
$c&lt; :: MagicalOctaves -&gt; MagicalOctaves -&gt; Bool
compare :: MagicalOctaves -&gt; MagicalOctaves -&gt; Ordering
$ccompare :: MagicalOctaves -&gt; MagicalOctaves -&gt; Ordering
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467589"><span id="local-6989586621679467591"><span id="local-6989586621679467593"><span class="annot"><span class="annottext">Int -&gt; MagicalOctaves -&gt; ShowS
[MagicalOctaves] -&gt; ShowS
MagicalOctaves -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [MagicalOctaves] -&gt; ShowS
$cshowList :: [MagicalOctaves] -&gt; ShowS
show :: MagicalOctaves -&gt; String
$cshow :: MagicalOctaves -&gt; String
showsPrec :: Int -&gt; MagicalOctaves -&gt; ShowS
$cshowsPrec :: Int -&gt; MagicalOctaves -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Distribution</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalOctaves"><span class="hs-identifier hs-type">MagicalOctaves</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="Params"><span class="annot"><span class="hs-identifier hs-var">Params</span></span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalOctaves"><span class="hs-identifier hs-type">MagicalOctaves</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="Support"><span class="annot"><span class="hs-identifier hs-var">Support</span></span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#MagicalOctaves"><span class="hs-identifier hs-type">MagicalOctaves</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-222"></span><span>  </span><span id="local-6989586621679467567"><span class="annot"><span class="annottext">distSample :: forall (m :: * -&gt; *).
PrimMonad m =&gt;
MagicalOctaves
-&gt; Params MagicalOctaves -&gt; Prob m (Support MagicalOctaves)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">distSample</span></span></span><span> </span><span class="annot"><span class="annottext">MagicalOctaves
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Params MagicalOctaves
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`subtract`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (m :: * -&gt; *).
(Foldable f, PrimMonad m) =&gt;
f Double -&gt; Prob m Int
</span><span class="hs-identifier hs-var">categorical</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.2</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.4</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.2</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.1</span></span><span class="hs-special">]</span><span>
</span><span id="line-223"></span><span>  </span><span id="local-6989586621679467563"><span class="annot"><span class="annottext">distLogP :: MagicalOctaves
-&gt; Params MagicalOctaves -&gt; Support MagicalOctaves -&gt; Double
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">distLogP</span></span></span><span> </span><span class="annot"><span class="annottext">MagicalOctaves
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Params MagicalOctaves
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Support MagicalOctaves
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0</span></span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span class="hs-keyword">type</span><span> </span><span id="PVProbs"><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVProbs"><span class="hs-identifier hs-var">PVProbs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ProbsRep</span></span><span>
</span><span id="line-226"></span><span class="hs-keyword">type</span><span> </span><span id="PVProbsInner"><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVProbsInner"><span class="hs-identifier hs-var">PVProbsInner</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ProbsRep</span></span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span class="hs-keyword">type</span><span> </span><span id="ContextSingle"><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextSingle"><span class="hs-identifier hs-var">ContextSingle</span></a></span></span><span> </span><span id="local-6989586621679467558"><span class="annot"><a href="#local-6989586621679467558"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#StartStop"><span class="hs-identifier hs-type">StartStop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679467558"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679467558"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#StartStop"><span class="hs-identifier hs-type">StartStop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679467558"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span class="hs-keyword">type</span><span> </span><span id="ContextDouble"><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextDouble"><span class="hs-identifier hs-var">ContextDouble</span></a></span></span><span> </span><span id="local-6989586621679467557"><span class="annot"><a href="#local-6989586621679467557"><span class="hs-identifier hs-type">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-230"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#StartStop"><span class="hs-identifier hs-type">StartStop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679467557"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679467557"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679467557"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679467557"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#StartStop"><span class="hs-identifier hs-type">StartStop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679467557"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span class="hs-keyword">type</span><span> </span><span id="PVObs"><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-var">PVObs</span></a></span></span><span> </span><span id="local-6989586621679467556"><span class="annot"><a href="#local-6989586621679467556"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Trace</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679467556"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span class="hs-comment">{- | A helper function that tests whether 'observeDerivation''
 followed by 'sampleDerivation'' restores the original derivation.
 Useful for testing the compatibility of the two functions.
-}</span><span>
</span><span id="line-238"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#roundtrip"><span class="hs-identifier hs-type">roundtrip</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PVGrammar.html#PVLeftmost"><span class="hs-identifier hs-type">PVLeftmost</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span id="roundtrip"><span class="annot"><span class="annottext">roundtrip :: String -&gt; IO (Either String [PVLeftmost SPitch])
</span><a href="PVGrammar.Prob.Simple.html#roundtrip"><span class="hs-identifier hs-var hs-var">roundtrip</span></a></span></span><span> </span><span id="local-6989586621679467554"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679467554"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-240"></span><span>  </span><span id="local-6989586621679467553"><span class="annot"><span class="annottext">Either String (PVAnalysis SPitch)
</span><a href="#local-6989586621679467553"><span class="hs-identifier hs-var">anaE</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO (Either String (PVAnalysis SPitch))
</span><a href="PVGrammar.html#loadAnalysis"><span class="hs-identifier hs-var">loadAnalysis</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679467554"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-241"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either String (PVAnalysis SPitch)
</span><a href="#local-6989586621679467553"><span class="hs-identifier hs-var">anaE</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-242"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679467551"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679467551"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679467551"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-243"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679467549"><span class="annot"><span class="annottext">PVAnalysis SPitch
</span><a href="#local-6989586621679467549"><span class="hs-identifier hs-var">ana</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-244"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679467548"><span class="annot"><span class="annottext">traceE :: Either String (Trace PVParams)
</span><a href="#local-6989586621679467548"><span class="hs-identifier hs-var hs-var">traceE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch] -&gt; Either String (Trace PVParams)
</span><a href="PVGrammar.Prob.Simple.html#observeDerivation%27"><span class="hs-identifier hs-var">observeDerivation'</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s f h tr slc. Analysis s f h tr slc -&gt; [Leftmost s f h]
</span><a href="Common.html#anaDerivation"><span class="hs-identifier hs-var">anaDerivation</span></a></span><span> </span><span class="annot"><span class="annottext">PVAnalysis SPitch
</span><a href="#local-6989586621679467549"><span class="hs-identifier hs-var">ana</span></a></span><span>
</span><span id="line-245"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either String (Trace PVParams)
</span><a href="#local-6989586621679467548"><span class="hs-identifier hs-var">traceE</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-246"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679467547"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679467547"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679467547"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-247"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679467546"><span class="annot"><span class="annottext">Trace PVParams
</span><a href="#local-6989586621679467546"><span class="hs-identifier hs-var">trace</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-248"></span><span>          </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (r :: (* -&gt; *) -&gt; *) a. Trace r -&gt; TraceTraceI r a -&gt; a
</span><span class="hs-identifier hs-var">traceTrace</span></span><span> </span><span class="annot"><span class="annottext">Trace PVParams
</span><a href="#local-6989586621679467546"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m Geometric1,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 SampleCtx m (Categorical 3), SampleCtx m Binomial,
 RandomInterpreter m PVParams) =&gt;
m (Either String [PVLeftmost SPitch])
</span><a href="PVGrammar.Prob.Simple.html#sampleDerivation%27"><span class="hs-identifier hs-var">sampleDerivation'</span></a></span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span class="hs-comment">{- | Helper function: Load a single derivation
 and infer the corresponding posterior for a uniform prior.
-}</span><span>
</span><span id="line-253"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#trainSinglePiece"><span class="hs-identifier hs-type">trainSinglePiece</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HyperRep</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span id="trainSinglePiece"><span class="annot"><span class="annottext">trainSinglePiece :: String -&gt; IO (Maybe (PVParams HyperRep))
</span><a href="PVGrammar.Prob.Simple.html#trainSinglePiece"><span class="hs-identifier hs-var hs-var">trainSinglePiece</span></a></span></span><span> </span><span id="local-6989586621679467544"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679467544"><span class="hs-identifier hs-var">fn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-255"></span><span>  </span><span id="local-6989586621679467543"><span class="annot"><span class="annottext">Either String (PVAnalysis SPitch)
</span><a href="#local-6989586621679467543"><span class="hs-identifier hs-var">anaE</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO (Either String (PVAnalysis SPitch))
</span><a href="PVGrammar.html#loadAnalysis"><span class="hs-identifier hs-var">loadAnalysis</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679467544"><span class="hs-identifier hs-var">fn</span></a></span><span>
</span><span id="line-256"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either String (PVAnalysis SPitch)
</span><a href="#local-6989586621679467543"><span class="hs-identifier hs-var">anaE</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-257"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679467542"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679467542"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679467542"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-258"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679467541"><span class="annot"><span class="annottext">PVAnalysis SPitch
</span><a href="#local-6989586621679467541"><span class="hs-identifier hs-var">ana</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-259"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679467540"><span class="annot"><span class="annottext">traceE :: Either String (Trace PVParams)
</span><a href="#local-6989586621679467540"><span class="hs-identifier hs-var hs-var">traceE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch] -&gt; Either String (Trace PVParams)
</span><a href="PVGrammar.Prob.Simple.html#observeDerivation%27"><span class="hs-identifier hs-var">observeDerivation'</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s f h tr slc. Analysis s f h tr slc -&gt; [Leftmost s f h]
</span><a href="Common.html#anaDerivation"><span class="hs-identifier hs-var">anaDerivation</span></a></span><span> </span><span class="annot"><span class="annottext">PVAnalysis SPitch
</span><a href="#local-6989586621679467541"><span class="hs-identifier hs-var">ana</span></a></span><span>
</span><span id="line-260"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either String (Trace PVParams)
</span><a href="#local-6989586621679467540"><span class="hs-identifier hs-var">traceE</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-261"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679467539"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679467539"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679467539"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-262"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679467538"><span class="annot"><span class="annottext">Trace PVParams
</span><a href="#local-6989586621679467538"><span class="hs-identifier hs-var">trace</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-263"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679467449"><span class="annot"><span class="annottext">prior :: Hyper PVParams
</span><a href="#local-6989586621679467449"><span class="hs-identifier hs-var hs-var">prior</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {k} (a :: k). Uniform a =&gt; Hyper a
</span><span class="hs-identifier hs-var">uniformPrior</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span>
</span><span id="line-264"></span><span>          </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (r :: (* -&gt; *) -&gt; *) a.
r HyperRep -&gt; Trace r -&gt; UpdatePriorsI r a -&gt; Maybe (r HyperRep)
</span><span class="hs-identifier hs-var">getPosterior</span></span><span> </span><span class="annot"><span class="annottext">PVParams HyperRep
</span><a href="#local-6989586621679467449"><span class="hs-identifier hs-var">prior</span></a></span><span> </span><span class="annot"><span class="annottext">Trace PVParams
</span><a href="#local-6989586621679467538"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m Geometric1,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 SampleCtx m (Categorical 3), SampleCtx m Binomial,
 RandomInterpreter m PVParams) =&gt;
Path (Edges SPitch) (Notes SPitch)
-&gt; m (Either String [PVLeftmost SPitch])
</span><a href="PVGrammar.Prob.Simple.html#sampleDerivation"><span class="hs-identifier hs-var">sampleDerivation</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s f h tr slc. Analysis s f h tr slc -&gt; Path tr slc
</span><a href="Common.html#anaTop"><span class="hs-identifier hs-var">anaTop</span></a></span><span> </span><span class="annot"><span class="annottext">PVAnalysis SPitch
</span><a href="#local-6989586621679467541"><span class="hs-identifier hs-var">ana</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span class="hs-comment">-- | A shorthand for 'sampleDerivation' starting from &#8906;&#8212;&#8212;&#8905;.</span><span>
</span><span id="line-267"></span><span id="local-6989586621679467446"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleDerivation%27"><span class="hs-identifier hs-type">sampleDerivation'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679467446"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PVGrammar.html#PVLeftmost"><span class="hs-identifier hs-type">PVLeftmost</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-268"></span><span id="sampleDerivation%27"><span class="annot"><span class="annottext">sampleDerivation' :: m (Either String [PVLeftmost SPitch])
</span><a href="PVGrammar.Prob.Simple.html#sampleDerivation%27"><span class="hs-identifier hs-var hs-var">sampleDerivation'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m Geometric1,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 SampleCtx m (Categorical 3), SampleCtx m Binomial,
 RandomInterpreter m PVParams) =&gt;
Path (Edges SPitch) (Notes SPitch)
-&gt; m (Either String [PVLeftmost SPitch])
</span><a href="PVGrammar.Prob.Simple.html#sampleDerivation"><span class="hs-identifier hs-var">sampleDerivation</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall around between. around -&gt; Path around between
</span><a href="Common.html#PathEnd"><span class="hs-identifier hs-var">PathEnd</span></a></span><span> </span><span class="annot"><span class="annottext">forall n. Hashable n =&gt; Edges n
</span><a href="PVGrammar.html#topEdges"><span class="hs-identifier hs-var">topEdges</span></a></span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span class="hs-comment">-- | A shorthand for 'observeDerivation' starting from &#8906;&#8212;&#8212;&#8905;.</span><span>
</span><span id="line-271"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeDerivation%27"><span class="hs-identifier hs-type">observeDerivation'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PVGrammar.html#PVLeftmost"><span class="hs-identifier hs-type">PVLeftmost</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Trace</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span id="observeDerivation%27"><span class="annot"><span class="annottext">observeDerivation' :: [PVLeftmost SPitch] -&gt; Either String (Trace PVParams)
</span><a href="PVGrammar.Prob.Simple.html#observeDerivation%27"><span class="hs-identifier hs-var hs-var">observeDerivation'</span></a></span></span><span> </span><span id="local-6989586621679467427"><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467427"><span class="hs-identifier hs-var">deriv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Either String (Trace PVParams)
</span><a href="PVGrammar.Prob.Simple.html#observeDerivation"><span class="hs-identifier hs-var">observeDerivation</span></a></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467427"><span class="hs-identifier hs-var">deriv</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall around between. around -&gt; Path around between
</span><a href="Common.html#PathEnd"><span class="hs-identifier hs-var">PathEnd</span></a></span><span> </span><span class="annot"><span class="annottext">forall n. Hashable n =&gt; Edges n
</span><a href="PVGrammar.html#topEdges"><span class="hs-identifier hs-var">topEdges</span></a></span><span>
</span><span id="line-273"></span><span>
</span><span id="line-274"></span><span class="hs-comment">{- | A probabilistic program that samples a derivation starting from a given root path.
 Can be interpreted by the interpreter functions in &quot;Inference.Conjugate&quot;.
-}</span><span>
</span><span id="line-277"></span><span id="local-6989586621679467426"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleDerivation"><span class="hs-identifier hs-type">sampleDerivation</span></a></span><span>
</span><span id="line-278"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span>
</span><span id="line-279"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span>  </span><span class="hs-comment">-- ^ root path</span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679467426"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PVGrammar.html#PVLeftmost"><span class="hs-identifier hs-type">PVLeftmost</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-282"></span><span>  </span><span class="hs-comment">-- ^ a probabilistic program</span><span>
</span><span id="line-283"></span><span id="sampleDerivation"><span class="annot"><span class="annottext">sampleDerivation :: Path (Edges SPitch) (Notes SPitch)
-&gt; m (Either String [PVLeftmost SPitch])
</span><a href="PVGrammar.Prob.Simple.html#sampleDerivation"><span class="hs-identifier hs-var hs-var">sampleDerivation</span></a></span></span><span> </span><span id="local-6989586621679467411"><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467411"><span class="hs-identifier hs-var">top</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *}.
(SampleCtx m Bernoulli, SampleCtx m Geometric1,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 SampleCtx m (Categorical 3), SampleCtx m Binomial,
 RandomInterpreter m PVParams) =&gt;
StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; ExceptT String m [PVLeftmost SPitch]
</span><a href="#local-6989586621679467410"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. StartStop a
</span><a href="Common.html#Start"><span class="hs-identifier hs-var">Start</span></a></span><span> </span><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467411"><span class="hs-identifier hs-var">top</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-284"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-285"></span><span>  </span><span id="local-6989586621679467410"><span class="annot"><span class="annottext">go :: StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; ExceptT String m [PVLeftmost SPitch]
</span><a href="#local-6989586621679467410"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679467341"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467341"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span id="local-6989586621679467340"><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467340"><span class="hs-identifier hs-var">surface</span></a></span></span><span> </span><span id="local-6989586621679467339"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467339"><span class="hs-identifier hs-var">ars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467340"><span class="hs-identifier hs-var">surface</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-286"></span><span>    </span><span class="hs-comment">-- 1 trans left:</span><span>
</span><span id="line-287"></span><span>    </span><span class="annot"><a href="Common.html#PathEnd"><span class="hs-identifier hs-type">PathEnd</span></a></span><span> </span><span id="local-6989586621679467338"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467338"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-288"></span><span>      </span><span id="local-6989586621679467337"><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) Freeze
</span><a href="#local-6989586621679467337"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m Geometric1,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 RandomInterpreter m PVParams) =&gt;
ContextSingle SPitch -&gt; m (LeftmostSingle (Split SPitch) Freeze)
</span><a href="PVGrammar.Prob.Simple.html#sampleSingleStep"><span class="hs-identifier hs-var">sampleSingleStep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467341"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467338"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. StartStop a
</span><a href="Common.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-289"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) Freeze
</span><a href="#local-6989586621679467337"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-290"></span><span>        </span><span class="annot"><a href="Common.html#LMSingleSplit"><span class="hs-identifier hs-type">LMSingleSplit</span></a></span><span> </span><span id="local-6989586621679467333"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467333"><span class="hs-identifier hs-var">splitOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-291"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679467332"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467332"><span class="hs-identifier hs-var">ctl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467331"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467331"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467330"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467330"><span class="hs-identifier hs-var">ctr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) e a. Monad m =&gt; Either e a -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">except</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall n.
(Ord n, Notation n, Hashable n) =&gt;
Split n -&gt; Edges n -&gt; Either String (Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySplit"><span class="hs-identifier hs-var">applySplit</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467333"><span class="hs-identifier hs-var">splitOp</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467338"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-292"></span><span>          </span><span id="local-6989586621679467329"><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467329"><span class="hs-identifier hs-var">nextSteps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; ExceptT String m [PVLeftmost SPitch]
</span><a href="#local-6989586621679467410"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467341"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall around between.
around -&gt; between -&gt; Path around between -&gt; Path around between
</span><a href="Common.html#Path"><span class="hs-identifier hs-var">Path</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467332"><span class="hs-identifier hs-var">ctl</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467331"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall around between. around -&gt; Path around between
</span><a href="Common.html#PathEnd"><span class="hs-identifier hs-var">PathEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467330"><span class="hs-identifier hs-var">ctr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-293"></span><span>          </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s f h. s -&gt; Leftmost s f h
</span><a href="Common.html#LMSplitOnly"><span class="hs-identifier hs-var">LMSplitOnly</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467333"><span class="hs-identifier hs-var">splitOp</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467329"><span class="hs-identifier hs-var">nextSteps</span></a></span><span>
</span><span id="line-294"></span><span>        </span><span class="annot"><a href="Common.html#LMSingleFreeze"><span class="hs-identifier hs-type">LMSingleFreeze</span></a></span><span> </span><span id="local-6989586621679467325"><span class="annot"><span class="annottext">Freeze
</span><a href="#local-6989586621679467325"><span class="hs-identifier hs-var">freezeOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">forall f s h. f -&gt; Leftmost s f h
</span><a href="Common.html#LMFreezeOnly"><span class="hs-identifier hs-var">LMFreezeOnly</span></a></span><span> </span><span class="annot"><span class="annottext">Freeze
</span><a href="#local-6989586621679467325"><span class="hs-identifier hs-var">freezeOp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-comment">-- 2 trans left</span><span>
</span><span id="line-296"></span><span>    </span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span id="local-6989586621679467323"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467323"><span class="hs-identifier hs-var">tl</span></a></span></span><span> </span><span id="local-6989586621679467322"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467322"><span class="hs-identifier hs-var">sm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#PathEnd"><span class="hs-identifier hs-type">PathEnd</span></a></span><span> </span><span id="local-6989586621679467321"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467321"><span class="hs-identifier hs-var">tr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
-&gt; Edges SPitch
-&gt; Notes SPitch
-&gt; Edges SPitch
-&gt; StartStop (Notes SPitch)
-&gt; Bool
-&gt; (Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch))
-&gt; ExceptT String m [PVLeftmost SPitch]
</span><a href="#local-6989586621679467320"><span class="hs-identifier hs-var">goDouble</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467341"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467323"><span class="hs-identifier hs-var">tl</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467322"><span class="hs-identifier hs-var">sm</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467321"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. StartStop a
</span><a href="Common.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467339"><span class="hs-identifier hs-var">ars</span></a></span><span> </span><span class="annot"><span class="annottext">forall around between. around -&gt; Path around between
</span><a href="Common.html#PathEnd"><span class="hs-identifier hs-var">PathEnd</span></a></span><span>
</span><span id="line-297"></span><span>    </span><span class="hs-comment">-- 3 or more trans left</span><span>
</span><span id="line-298"></span><span>    </span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span id="local-6989586621679467319"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467319"><span class="hs-identifier hs-var">tl</span></a></span></span><span> </span><span id="local-6989586621679467318"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467318"><span class="hs-identifier hs-var">sm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span id="local-6989586621679467317"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467317"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span id="local-6989586621679467316"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467316"><span class="hs-identifier hs-var">sr</span></a></span></span><span> </span><span id="local-6989586621679467315"><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467315"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-299"></span><span>      </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
-&gt; Edges SPitch
-&gt; Notes SPitch
-&gt; Edges SPitch
-&gt; StartStop (Notes SPitch)
-&gt; Bool
-&gt; (Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch))
-&gt; ExceptT String m [PVLeftmost SPitch]
</span><a href="#local-6989586621679467320"><span class="hs-identifier hs-var">goDouble</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467341"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467319"><span class="hs-identifier hs-var">tl</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467318"><span class="hs-identifier hs-var">sm</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467317"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467316"><span class="hs-identifier hs-var">sr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467339"><span class="hs-identifier hs-var">ars</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679467313"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467313"><span class="hs-identifier hs-var">tr'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall around between.
around -&gt; between -&gt; Path around between -&gt; Path around between
</span><a href="Common.html#Path"><span class="hs-identifier hs-var">Path</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467313"><span class="hs-identifier hs-var">tr'</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467316"><span class="hs-identifier hs-var">sr</span></a></span><span> </span><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467315"><span class="hs-identifier hs-var">rest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-300"></span><span>
</span><span id="line-301"></span><span>  </span><span class="hs-comment">-- helper for the two cases of 2+ edges (2 and 3+):</span><span>
</span><span id="line-302"></span><span>  </span><span id="local-6989586621679467320"><span class="annot"><span class="annottext">goDouble :: StartStop (Notes SPitch)
-&gt; Edges SPitch
-&gt; Notes SPitch
-&gt; Edges SPitch
-&gt; StartStop (Notes SPitch)
-&gt; Bool
-&gt; (Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch))
-&gt; ExceptT String m [PVLeftmost SPitch]
</span><a href="#local-6989586621679467320"><span class="hs-identifier hs-var hs-var">goDouble</span></a></span></span><span> </span><span id="local-6989586621679467312"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467312"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span id="local-6989586621679467311"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467311"><span class="hs-identifier hs-var">tl</span></a></span></span><span> </span><span id="local-6989586621679467310"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467310"><span class="hs-identifier hs-var">sm</span></a></span></span><span> </span><span id="local-6989586621679467309"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467309"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span id="local-6989586621679467308"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467308"><span class="hs-identifier hs-var">sr</span></a></span></span><span> </span><span id="local-6989586621679467307"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467307"><span class="hs-identifier hs-var">ars</span></a></span></span><span> </span><span id="local-6989586621679467306"><span class="annot"><span class="annottext">Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467306"><span class="hs-identifier hs-var">mkrest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-303"></span><span>    </span><span id="local-6989586621679467305"><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) Freeze (Spread SPitch)
</span><a href="#local-6989586621679467305"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m Geometric1,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 SampleCtx m (Categorical 3), SampleCtx m Binomial,
 RandomInterpreter m PVParams) =&gt;
ContextDouble SPitch
-&gt; Bool -&gt; m (LeftmostDouble (Split SPitch) Freeze (Spread SPitch))
</span><a href="PVGrammar.Prob.Simple.html#sampleDoubleStep"><span class="hs-identifier hs-var">sampleDoubleStep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467312"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467311"><span class="hs-identifier hs-var">tl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467310"><span class="hs-identifier hs-var">sm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467309"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467308"><span class="hs-identifier hs-var">sr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467307"><span class="hs-identifier hs-var">ars</span></a></span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) Freeze (Spread SPitch)
</span><a href="#local-6989586621679467305"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-305"></span><span>      </span><span class="annot"><a href="Common.html#LMDoubleSplitLeft"><span class="hs-identifier hs-type">LMDoubleSplitLeft</span></a></span><span> </span><span id="local-6989586621679467302"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467302"><span class="hs-identifier hs-var">splitOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-306"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679467301"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467301"><span class="hs-identifier hs-var">ctl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467300"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467300"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467299"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467299"><span class="hs-identifier hs-var">ctr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) e a. Monad m =&gt; Either e a -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">except</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall n.
(Ord n, Notation n, Hashable n) =&gt;
Split n -&gt; Edges n -&gt; Either String (Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySplit"><span class="hs-identifier hs-var">applySplit</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467302"><span class="hs-identifier hs-var">splitOp</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467311"><span class="hs-identifier hs-var">tl</span></a></span><span>
</span><span id="line-307"></span><span>        </span><span id="local-6989586621679467298"><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467298"><span class="hs-identifier hs-var">nextSteps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; ExceptT String m [PVLeftmost SPitch]
</span><a href="#local-6989586621679467410"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467312"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall around between.
around -&gt; between -&gt; Path around between -&gt; Path around between
</span><a href="Common.html#Path"><span class="hs-identifier hs-var">Path</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467301"><span class="hs-identifier hs-var">ctl</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467300"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall around between.
around -&gt; between -&gt; Path around between -&gt; Path around between
</span><a href="Common.html#Path"><span class="hs-identifier hs-var">Path</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467299"><span class="hs-identifier hs-var">ctr</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467310"><span class="hs-identifier hs-var">sm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467306"><span class="hs-identifier hs-var">mkrest</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467309"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-308"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s f h. s -&gt; Leftmost s f h
</span><a href="Common.html#LMSplitLeft"><span class="hs-identifier hs-var">LMSplitLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467302"><span class="hs-identifier hs-var">splitOp</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467298"><span class="hs-identifier hs-var">nextSteps</span></a></span><span>
</span><span id="line-309"></span><span>      </span><span class="annot"><a href="Common.html#LMDoubleFreezeLeft"><span class="hs-identifier hs-type">LMDoubleFreezeLeft</span></a></span><span> </span><span id="local-6989586621679467295"><span class="annot"><span class="annottext">Freeze
</span><a href="#local-6989586621679467295"><span class="hs-identifier hs-var">freezeOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-310"></span><span>        </span><span id="local-6989586621679467294"><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467294"><span class="hs-identifier hs-var">nextSteps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; ExceptT String m [PVLeftmost SPitch]
</span><a href="#local-6989586621679467410"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467310"><span class="hs-identifier hs-var">sm</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467306"><span class="hs-identifier hs-var">mkrest</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467309"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-311"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall f s h. f -&gt; Leftmost s f h
</span><a href="Common.html#LMFreezeLeft"><span class="hs-identifier hs-var">LMFreezeLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Freeze
</span><a href="#local-6989586621679467295"><span class="hs-identifier hs-var">freezeOp</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467294"><span class="hs-identifier hs-var">nextSteps</span></a></span><span>
</span><span id="line-312"></span><span>      </span><span class="annot"><a href="Common.html#LMDoubleSplitRight"><span class="hs-identifier hs-type">LMDoubleSplitRight</span></a></span><span> </span><span id="local-6989586621679467291"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467291"><span class="hs-identifier hs-var">splitOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-313"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679467290"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467290"><span class="hs-identifier hs-var">ctl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467289"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467289"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467288"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467288"><span class="hs-identifier hs-var">ctr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) e a. Monad m =&gt; Either e a -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">except</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall n.
(Ord n, Notation n, Hashable n) =&gt;
Split n -&gt; Edges n -&gt; Either String (Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySplit"><span class="hs-identifier hs-var">applySplit</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467291"><span class="hs-identifier hs-var">splitOp</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467309"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-314"></span><span>        </span><span id="local-6989586621679467287"><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467287"><span class="hs-identifier hs-var">nextSteps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; ExceptT String m [PVLeftmost SPitch]
</span><a href="#local-6989586621679467410"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467312"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall around between.
around -&gt; between -&gt; Path around between -&gt; Path around between
</span><a href="Common.html#Path"><span class="hs-identifier hs-var">Path</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467311"><span class="hs-identifier hs-var">tl</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467310"><span class="hs-identifier hs-var">sm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall around between.
around -&gt; between -&gt; Path around between -&gt; Path around between
</span><a href="Common.html#Path"><span class="hs-identifier hs-var">Path</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467290"><span class="hs-identifier hs-var">ctl</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467289"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467306"><span class="hs-identifier hs-var">mkrest</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467288"><span class="hs-identifier hs-var">ctr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-315"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall s f h. s -&gt; Leftmost s f h
</span><a href="Common.html#LMSplitRight"><span class="hs-identifier hs-var">LMSplitRight</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467291"><span class="hs-identifier hs-var">splitOp</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467287"><span class="hs-identifier hs-var">nextSteps</span></a></span><span>
</span><span id="line-316"></span><span>      </span><span class="annot"><a href="Common.html#LMDoubleSpread"><span class="hs-identifier hs-type">LMDoubleSpread</span></a></span><span> </span><span id="local-6989586621679467284"><span class="annot"><span class="annottext">Spread SPitch
</span><a href="#local-6989586621679467284"><span class="hs-identifier hs-var">spreadOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-317"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679467283"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467283"><span class="hs-identifier hs-var">ctl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467282"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467282"><span class="hs-identifier hs-var">csl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467281"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467281"><span class="hs-identifier hs-var">ctm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467280"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467280"><span class="hs-identifier hs-var">csr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467279"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467279"><span class="hs-identifier hs-var">ctr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) e a. Monad m =&gt; Either e a -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">except</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall n.
(Ord n, Notation n, Hashable n) =&gt;
Spread n
-&gt; Edges n
-&gt; Notes n
-&gt; Edges n
-&gt; Either String (Edges n, Notes n, Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySpread"><span class="hs-identifier hs-var">applySpread</span></a></span><span> </span><span class="annot"><span class="annottext">Spread SPitch
</span><a href="#local-6989586621679467284"><span class="hs-identifier hs-var">spreadOp</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467311"><span class="hs-identifier hs-var">tl</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467310"><span class="hs-identifier hs-var">sm</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467309"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-318"></span><span>        </span><span id="local-6989586621679467278"><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467278"><span class="hs-identifier hs-var">nextSteps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; ExceptT String m [PVLeftmost SPitch]
</span><a href="#local-6989586621679467410"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467312"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall around between.
around -&gt; between -&gt; Path around between -&gt; Path around between
</span><a href="Common.html#Path"><span class="hs-identifier hs-var">Path</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467283"><span class="hs-identifier hs-var">ctl</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467282"><span class="hs-identifier hs-var">csl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall around between.
around -&gt; between -&gt; Path around between -&gt; Path around between
</span><a href="Common.html#Path"><span class="hs-identifier hs-var">Path</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467281"><span class="hs-identifier hs-var">ctm</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467280"><span class="hs-identifier hs-var">csr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467306"><span class="hs-identifier hs-var">mkrest</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467279"><span class="hs-identifier hs-var">ctr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-319"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall h s f. h -&gt; Leftmost s f h
</span><a href="Common.html#LMSpread"><span class="hs-identifier hs-var">LMSpread</span></a></span><span> </span><span class="annot"><span class="annottext">Spread SPitch
</span><a href="#local-6989586621679467284"><span class="hs-identifier hs-var">spreadOp</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467278"><span class="hs-identifier hs-var">nextSteps</span></a></span><span>
</span><span id="line-320"></span><span>
</span><span id="line-321"></span><span class="hs-comment">{- | Walk through a derivation (starting at a given root path)
 and return the corresponding 'Trace' (if possible).
 The trace can be used together with 'sampleDerivation'
 for inference ('getPosterior') or for showing the trace ('printTrace').
-}</span><span>
</span><span id="line-326"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeDerivation"><span class="hs-identifier hs-type">observeDerivation</span></a></span><span>
</span><span id="line-327"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PVGrammar.html#PVLeftmost"><span class="hs-identifier hs-type">PVLeftmost</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span>
</span><span id="line-328"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-329"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Trace</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-330"></span><span id="observeDerivation"><span class="annot"><span class="annottext">observeDerivation :: [PVLeftmost SPitch]
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Either String (Trace PVParams)
</span><a href="PVGrammar.Prob.Simple.html#observeDerivation"><span class="hs-identifier hs-var hs-var">observeDerivation</span></a></span></span><span> </span><span id="local-6989586621679467276"><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467276"><span class="hs-identifier hs-var">deriv</span></a></span></span><span> </span><span id="local-6989586621679467275"><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467275"><span class="hs-identifier hs-var">top</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-331"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m s
</span><span class="hs-identifier hs-var">execStateT</span></span><span>
</span><span id="line-332"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; [PVLeftmost SPitch]
-&gt; PVObs ()
</span><a href="#local-6989586621679467274"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. StartStop a
</span><a href="Common.html#Start"><span class="hs-identifier hs-var">Start</span></a></span><span> </span><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467275"><span class="hs-identifier hs-var">top</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467276"><span class="hs-identifier hs-var">deriv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (r :: (* -&gt; *) -&gt; *). Seq Dynamic -&gt; Trace r
</span><span class="hs-identifier hs-var">Trace</span></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-335"></span><span>  </span><span class="annot"><a href="#local-6989586621679467274"><span class="hs-identifier hs-type">go</span></a></span><span>
</span><span id="line-336"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Common.html#StartStop"><span class="hs-identifier hs-type">StartStop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-339"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PVGrammar.html#PVLeftmost"><span class="hs-identifier hs-type">PVLeftmost</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span>
</span><span id="line-340"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>  </span><span id="local-6989586621679467274"><span class="annot"><span class="annottext">go :: StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; [PVLeftmost SPitch]
-&gt; PVObs ()
</span><a href="#local-6989586621679467274"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679467272"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467272"><span class="hs-identifier hs-var">_sl</span></a></span></span><span> </span><span id="local-6989586621679467271"><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467271"><span class="hs-identifier hs-var">_surface</span></a></span></span><span> </span><span id="local-6989586621679467270"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467270"><span class="hs-identifier hs-var">_ars</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Derivation incomplete.&quot;</span></span><span>
</span><span id="line-342"></span><span>  </span><span class="annot"><a href="#local-6989586621679467274"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621679467269"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467269"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#PathEnd"><span class="hs-identifier hs-type">PathEnd</span></a></span><span> </span><span id="local-6989586621679467268"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467268"><span class="hs-identifier hs-var">trans</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679467267"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467267"><span class="hs-identifier hs-var">_ars</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679467266"><span class="annot"><span class="annottext">PVLeftmost SPitch
</span><a href="#local-6989586621679467266"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679467265"><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467265"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PVLeftmost SPitch
</span><a href="#local-6989586621679467266"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-343"></span><span>    </span><span class="annot"><a href="Common.html#LMSingle"><span class="hs-identifier hs-type">LMSingle</span></a></span><span> </span><span id="local-6989586621679467263"><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) Freeze
</span><a href="#local-6989586621679467263"><span class="hs-identifier hs-var">single</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-344"></span><span>      </span><span class="annot"><span class="annottext">ContextSingle SPitch
-&gt; LeftmostSingle (Split SPitch) Freeze -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeSingleStep"><span class="hs-identifier hs-var">observeSingleStep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467269"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467268"><span class="hs-identifier hs-var">trans</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. StartStop a
</span><a href="Common.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) Freeze
</span><a href="#local-6989586621679467263"><span class="hs-identifier hs-var">single</span></a></span><span>
</span><span id="line-345"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) Freeze
</span><a href="#local-6989586621679467263"><span class="hs-identifier hs-var">single</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-346"></span><span>        </span><span class="annot"><a href="Common.html#LMSingleFreeze"><span class="hs-identifier hs-type">LMSingleFreeze</span></a></span><span> </span><span class="annot"><span class="annottext">Freeze
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>        </span><span class="annot"><a href="Common.html#LMSingleSplit"><span class="hs-identifier hs-type">LMSingleSplit</span></a></span><span> </span><span id="local-6989586621679467261"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467261"><span class="hs-identifier hs-var">splitOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-348"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679467260"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467260"><span class="hs-identifier hs-var">ctl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467259"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467259"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467258"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467258"><span class="hs-identifier hs-var">ctr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall n.
(Ord n, Notation n, Hashable n) =&gt;
Split n -&gt; Edges n -&gt; Either String (Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySplit"><span class="hs-identifier hs-var">applySplit</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467261"><span class="hs-identifier hs-var">splitOp</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467268"><span class="hs-identifier hs-var">trans</span></a></span><span>
</span><span id="line-349"></span><span>          </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; [PVLeftmost SPitch]
-&gt; PVObs ()
</span><a href="#local-6989586621679467274"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467269"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall around between.
around -&gt; between -&gt; Path around between -&gt; Path around between
</span><a href="Common.html#Path"><span class="hs-identifier hs-var">Path</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467260"><span class="hs-identifier hs-var">ctl</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467259"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall around between. around -&gt; Path around between
</span><a href="Common.html#PathEnd"><span class="hs-identifier hs-var">PathEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467258"><span class="hs-identifier hs-var">ctr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467265"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-350"></span><span>    </span><span class="annot"><a href="Common.html#LMDouble"><span class="hs-identifier hs-type">LMDouble</span></a></span><span> </span><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) Freeze (Spread SPitch)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Double operation on single transition.&quot;</span></span><span>
</span><span id="line-351"></span><span>  </span><span class="annot"><a href="#local-6989586621679467274"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621679467256"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467256"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span id="local-6989586621679467255"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467255"><span class="hs-identifier hs-var">tl</span></a></span></span><span> </span><span id="local-6989586621679467254"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467254"><span class="hs-identifier hs-var">sm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#PathEnd"><span class="hs-identifier hs-type">PathEnd</span></a></span><span> </span><span id="local-6989586621679467253"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467253"><span class="hs-identifier hs-var">tr</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679467252"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467252"><span class="hs-identifier hs-var">ars</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679467251"><span class="annot"><span class="annottext">PVLeftmost SPitch
</span><a href="#local-6989586621679467251"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679467250"><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467250"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-352"></span><span>    </span><span class="annot"><span class="annottext">PVLeftmost SPitch
-&gt; [PVLeftmost SPitch]
-&gt; Bool
-&gt; ContextDouble SPitch
-&gt; (Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch))
-&gt; PVObs ()
</span><a href="#local-6989586621679467249"><span class="hs-identifier hs-var">goDouble</span></a></span><span> </span><span class="annot"><span class="annottext">PVLeftmost SPitch
</span><a href="#local-6989586621679467251"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467250"><span class="hs-identifier hs-var">rest</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467252"><span class="hs-identifier hs-var">ars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467256"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467255"><span class="hs-identifier hs-var">tl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467254"><span class="hs-identifier hs-var">sm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467253"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. StartStop a
</span><a href="Common.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall around between. around -&gt; Path around between
</span><a href="Common.html#PathEnd"><span class="hs-identifier hs-var">PathEnd</span></a></span><span>
</span><span id="line-353"></span><span>  </span><span class="annot"><a href="#local-6989586621679467274"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621679467248"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467248"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span id="local-6989586621679467247"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467247"><span class="hs-identifier hs-var">tl</span></a></span></span><span> </span><span id="local-6989586621679467246"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467246"><span class="hs-identifier hs-var">sm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span id="local-6989586621679467245"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467245"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span id="local-6989586621679467244"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467244"><span class="hs-identifier hs-var">sr</span></a></span></span><span> </span><span id="local-6989586621679467243"><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467243"><span class="hs-identifier hs-var">pathRest</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679467242"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467242"><span class="hs-identifier hs-var">ars</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679467241"><span class="annot"><span class="annottext">PVLeftmost SPitch
</span><a href="#local-6989586621679467241"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679467240"><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467240"><span class="hs-identifier hs-var">derivRest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-354"></span><span>    </span><span class="annot"><span class="annottext">PVLeftmost SPitch
-&gt; [PVLeftmost SPitch]
-&gt; Bool
-&gt; ContextDouble SPitch
-&gt; (Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch))
-&gt; PVObs ()
</span><a href="#local-6989586621679467249"><span class="hs-identifier hs-var">goDouble</span></a></span><span> </span><span class="annot"><span class="annottext">PVLeftmost SPitch
</span><a href="#local-6989586621679467241"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467240"><span class="hs-identifier hs-var">derivRest</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467242"><span class="hs-identifier hs-var">ars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467248"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467247"><span class="hs-identifier hs-var">tl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467246"><span class="hs-identifier hs-var">sm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467245"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467244"><span class="hs-identifier hs-var">sr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-355"></span><span>      </span><span class="hs-glyph">\</span><span id="local-6989586621679467239"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467239"><span class="hs-identifier hs-var">tr'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall around between.
around -&gt; between -&gt; Path around between -&gt; Path around between
</span><a href="Common.html#Path"><span class="hs-identifier hs-var">Path</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467239"><span class="hs-identifier hs-var">tr'</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467244"><span class="hs-identifier hs-var">sr</span></a></span><span> </span><span class="annot"><span class="annottext">Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467243"><span class="hs-identifier hs-var">pathRest</span></a></span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span>  </span><span id="local-6989586621679467249"><span class="annot"><span class="annottext">goDouble :: PVLeftmost SPitch
-&gt; [PVLeftmost SPitch]
-&gt; Bool
-&gt; ContextDouble SPitch
-&gt; (Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch))
-&gt; PVObs ()
</span><a href="#local-6989586621679467249"><span class="hs-identifier hs-var hs-var">goDouble</span></a></span></span><span> </span><span id="local-6989586621679467206"><span class="annot"><span class="annottext">PVLeftmost SPitch
</span><a href="#local-6989586621679467206"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621679467205"><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467205"><span class="hs-identifier hs-var">rest</span></a></span></span><span> </span><span id="local-6989586621679467204"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467204"><span class="hs-identifier hs-var">ars</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679467203"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467203"><span class="hs-identifier hs-var">sl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467202"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467202"><span class="hs-identifier hs-var">tl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467201"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467201"><span class="hs-identifier hs-var">sm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467200"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467200"><span class="hs-identifier hs-var">tr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467199"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467199"><span class="hs-identifier hs-var">sr</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679467198"><span class="annot"><span class="annottext">Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467198"><span class="hs-identifier hs-var">mkRest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PVLeftmost SPitch
</span><a href="#local-6989586621679467206"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-358"></span><span>    </span><span class="annot"><a href="Common.html#LMSingle"><span class="hs-identifier hs-type">LMSingle</span></a></span><span> </span><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) Freeze
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Single operation with several transitions left.&quot;</span></span><span>
</span><span id="line-359"></span><span>    </span><span class="annot"><a href="Common.html#LMDouble"><span class="hs-identifier hs-type">LMDouble</span></a></span><span> </span><span id="local-6989586621679467197"><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) Freeze (Spread SPitch)
</span><a href="#local-6989586621679467197"><span class="hs-identifier hs-var">double</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-360"></span><span>      </span><span class="annot"><span class="annottext">ContextDouble SPitch
-&gt; Bool
-&gt; LeftmostDouble (Split SPitch) Freeze (Spread SPitch)
-&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeDoubleStep"><span class="hs-identifier hs-var">observeDoubleStep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467203"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467202"><span class="hs-identifier hs-var">tl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467201"><span class="hs-identifier hs-var">sm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467200"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467199"><span class="hs-identifier hs-var">sr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467204"><span class="hs-identifier hs-var">ars</span></a></span><span> </span><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) Freeze (Spread SPitch)
</span><a href="#local-6989586621679467197"><span class="hs-identifier hs-var">double</span></a></span><span>
</span><span id="line-361"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) Freeze (Spread SPitch)
</span><a href="#local-6989586621679467197"><span class="hs-identifier hs-var">double</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-362"></span><span>        </span><span class="annot"><a href="Common.html#LMDoubleFreezeLeft"><span class="hs-identifier hs-type">LMDoubleFreezeLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Freeze
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-363"></span><span>          </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467204"><span class="hs-identifier hs-var">ars</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;FreezeLeft after SplitRight.&quot;</span></span><span>
</span><span id="line-364"></span><span>          </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; [PVLeftmost SPitch]
-&gt; PVObs ()
</span><a href="#local-6989586621679467274"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467201"><span class="hs-identifier hs-var">sm</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467198"><span class="hs-identifier hs-var">mkRest</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467200"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467205"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-365"></span><span>        </span><span class="annot"><a href="Common.html#LMDoubleSplitLeft"><span class="hs-identifier hs-type">LMDoubleSplitLeft</span></a></span><span> </span><span id="local-6989586621679467195"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467195"><span class="hs-identifier hs-var">splitOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-366"></span><span>          </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467204"><span class="hs-identifier hs-var">ars</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SplitLeft after SplitRight.&quot;</span></span><span>
</span><span id="line-367"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679467194"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467194"><span class="hs-identifier hs-var">ctl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467193"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467193"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467192"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467192"><span class="hs-identifier hs-var">ctr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall n.
(Ord n, Notation n, Hashable n) =&gt;
Split n -&gt; Edges n -&gt; Either String (Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySplit"><span class="hs-identifier hs-var">applySplit</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467195"><span class="hs-identifier hs-var">splitOp</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467202"><span class="hs-identifier hs-var">tl</span></a></span><span>
</span><span id="line-368"></span><span>          </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; [PVLeftmost SPitch]
-&gt; PVObs ()
</span><a href="#local-6989586621679467274"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467203"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall around between.
around -&gt; between -&gt; Path around between -&gt; Path around between
</span><a href="Common.html#Path"><span class="hs-identifier hs-var">Path</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467194"><span class="hs-identifier hs-var">ctl</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467193"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall around between.
around -&gt; between -&gt; Path around between -&gt; Path around between
</span><a href="Common.html#Path"><span class="hs-identifier hs-var">Path</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467192"><span class="hs-identifier hs-var">ctr</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467201"><span class="hs-identifier hs-var">sm</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467198"><span class="hs-identifier hs-var">mkRest</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467200"><span class="hs-identifier hs-var">tr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467205"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-369"></span><span>        </span><span class="annot"><a href="Common.html#LMDoubleSplitRight"><span class="hs-identifier hs-type">LMDoubleSplitRight</span></a></span><span> </span><span id="local-6989586621679467191"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467191"><span class="hs-identifier hs-var">splitOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-370"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679467190"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467190"><span class="hs-identifier hs-var">ctl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467189"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467189"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467188"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467188"><span class="hs-identifier hs-var">ctr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall n.
(Ord n, Notation n, Hashable n) =&gt;
Split n -&gt; Edges n -&gt; Either String (Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySplit"><span class="hs-identifier hs-var">applySplit</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467191"><span class="hs-identifier hs-var">splitOp</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467200"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-371"></span><span>          </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; [PVLeftmost SPitch]
-&gt; PVObs ()
</span><a href="#local-6989586621679467274"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467203"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall around between.
around -&gt; between -&gt; Path around between -&gt; Path around between
</span><a href="Common.html#Path"><span class="hs-identifier hs-var">Path</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467202"><span class="hs-identifier hs-var">tl</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467201"><span class="hs-identifier hs-var">sm</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall around between.
around -&gt; between -&gt; Path around between -&gt; Path around between
</span><a href="Common.html#Path"><span class="hs-identifier hs-var">Path</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467190"><span class="hs-identifier hs-var">ctl</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467189"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467198"><span class="hs-identifier hs-var">mkRest</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467188"><span class="hs-identifier hs-var">ctr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467205"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-372"></span><span>        </span><span class="annot"><a href="Common.html#LMDoubleSpread"><span class="hs-identifier hs-type">LMDoubleSpread</span></a></span><span> </span><span id="local-6989586621679467187"><span class="annot"><span class="annottext">Spread SPitch
</span><a href="#local-6989586621679467187"><span class="hs-identifier hs-var">spreadOp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-373"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679467186"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467186"><span class="hs-identifier hs-var">ctl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467185"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467185"><span class="hs-identifier hs-var">csl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467184"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467184"><span class="hs-identifier hs-var">ctm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467183"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467183"><span class="hs-identifier hs-var">csr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467182"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467182"><span class="hs-identifier hs-var">ctr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall n.
(Ord n, Notation n, Hashable n) =&gt;
Spread n
-&gt; Edges n
-&gt; Notes n
-&gt; Edges n
-&gt; Either String (Edges n, Notes n, Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySpread"><span class="hs-identifier hs-var">applySpread</span></a></span><span> </span><span class="annot"><span class="annottext">Spread SPitch
</span><a href="#local-6989586621679467187"><span class="hs-identifier hs-var">spreadOp</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467202"><span class="hs-identifier hs-var">tl</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467201"><span class="hs-identifier hs-var">sm</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467200"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-374"></span><span>          </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
-&gt; Path (Edges SPitch) (Notes SPitch)
-&gt; Bool
-&gt; [PVLeftmost SPitch]
-&gt; PVObs ()
</span><a href="#local-6989586621679467274"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467203"><span class="hs-identifier hs-var">sl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall around between.
around -&gt; between -&gt; Path around between -&gt; Path around between
</span><a href="Common.html#Path"><span class="hs-identifier hs-var">Path</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467186"><span class="hs-identifier hs-var">ctl</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467185"><span class="hs-identifier hs-var">csl</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall around between.
around -&gt; between -&gt; Path around between -&gt; Path around between
</span><a href="Common.html#Path"><span class="hs-identifier hs-var">Path</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467184"><span class="hs-identifier hs-var">ctm</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467183"><span class="hs-identifier hs-var">csr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Edges SPitch -&gt; Path (Edges SPitch) (Notes SPitch)
</span><a href="#local-6989586621679467198"><span class="hs-identifier hs-var">mkRest</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467182"><span class="hs-identifier hs-var">ctr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">[PVLeftmost SPitch]
</span><a href="#local-6989586621679467205"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-375"></span><span>
</span><span id="line-376"></span><span id="local-6989586621679467181"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleSingleStep"><span class="hs-identifier hs-type">sampleSingleStep</span></a></span><span>
</span><span id="line-377"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextSingle"><span class="hs-identifier hs-type">ContextSingle</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679467181"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#LeftmostSingle"><span class="hs-identifier hs-type">LeftmostSingle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-378"></span><span id="sampleSingleStep"><span class="annot"><span class="annottext">sampleSingleStep :: ContextSingle SPitch -&gt; m (LeftmostSingle (Split SPitch) Freeze)
</span><a href="PVGrammar.Prob.Simple.html#sampleSingleStep"><span class="hs-identifier hs-var hs-var">sampleSingleStep</span></a></span></span><span> </span><span id="local-6989586621679467150"><span class="annot"><span class="annottext">parents :: ContextSingle SPitch
</span><a href="#local-6989586621679467150"><span class="hs-identifier hs-var">parents</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467149"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467149"><span class="hs-identifier hs-var">trans</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-379"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">forall n. (Eq (IntervalOf n), HasPitch n) =&gt; Edges n -&gt; Bool
</span><a href="PVGrammar.Generate.html#freezable"><span class="hs-identifier hs-var">freezable</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467149"><span class="hs-identifier hs-var">trans</span></a></span><span>
</span><span id="line-380"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-381"></span><span>      </span><span id="local-6989586621679467148"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467148"><span class="hs-identifier hs-var">shouldFreeze</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-382"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldFreeze (single)&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsOuter f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pSingleFreeze"><span class="hs-identifier hs-var">pSingleFreeze</span></a></span><span>
</span><span id="line-383"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467148"><span class="hs-identifier hs-var">shouldFreeze</span></a></span><span>
</span><span id="line-384"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall s f. f -&gt; LeftmostSingle s f
</span><a href="Common.html#LMSingleFreeze"><span class="hs-identifier hs-var">LMSingleFreeze</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) n.
RandomInterpreter m PVParams =&gt;
ContextSingle n -&gt; m Freeze
</span><a href="PVGrammar.Prob.Simple.html#sampleFreeze"><span class="hs-identifier hs-var">sampleFreeze</span></a></span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch
</span><a href="#local-6989586621679467150"><span class="hs-identifier hs-var">parents</span></a></span><span>
</span><span id="line-385"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall s f. s -&gt; LeftmostSingle s f
</span><a href="Common.html#LMSingleSplit"><span class="hs-identifier hs-var">LMSingleSplit</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Geometric1, SampleCtx m Bernoulli,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 RandomInterpreter m PVParams) =&gt;
ContextSingle SPitch -&gt; m (Split SPitch)
</span><a href="PVGrammar.Prob.Simple.html#sampleSplit"><span class="hs-identifier hs-var">sampleSplit</span></a></span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch
</span><a href="#local-6989586621679467150"><span class="hs-identifier hs-var">parents</span></a></span><span>
</span><span id="line-386"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall s f. s -&gt; LeftmostSingle s f
</span><a href="Common.html#LMSingleSplit"><span class="hs-identifier hs-var">LMSingleSplit</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Geometric1, SampleCtx m Bernoulli,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 RandomInterpreter m PVParams) =&gt;
ContextSingle SPitch -&gt; m (Split SPitch)
</span><a href="PVGrammar.Prob.Simple.html#sampleSplit"><span class="hs-identifier hs-var">sampleSplit</span></a></span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch
</span><a href="#local-6989586621679467150"><span class="hs-identifier hs-var">parents</span></a></span><span>
</span><span id="line-387"></span><span>
</span><span id="line-388"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeSingleStep"><span class="hs-identifier hs-type">observeSingleStep</span></a></span><span>
</span><span id="line-389"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextSingle"><span class="hs-identifier hs-type">ContextSingle</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.html#LeftmostSingle"><span class="hs-identifier hs-type">LeftmostSingle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-390"></span><span id="observeSingleStep"><span class="annot"><span class="annottext">observeSingleStep :: ContextSingle SPitch
-&gt; LeftmostSingle (Split SPitch) Freeze -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeSingleStep"><span class="hs-identifier hs-var hs-var">observeSingleStep</span></a></span></span><span> </span><span id="local-6989586621679467139"><span class="annot"><span class="annottext">parents :: ContextSingle SPitch
</span><a href="#local-6989586621679467139"><span class="hs-identifier hs-var">parents</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467138"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467138"><span class="hs-identifier hs-var">trans</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679467137"><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) Freeze
</span><a href="#local-6989586621679467137"><span class="hs-identifier hs-var">singleOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-391"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">forall n. (Eq (IntervalOf n), HasPitch n) =&gt; Edges n -&gt; Bool
</span><a href="PVGrammar.Generate.html#freezable"><span class="hs-identifier hs-var">freezable</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467138"><span class="hs-identifier hs-var">trans</span></a></span><span>
</span><span id="line-392"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) Freeze
</span><a href="#local-6989586621679467137"><span class="hs-identifier hs-var">singleOp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-393"></span><span>      </span><span class="annot"><a href="Common.html#LMSingleFreeze"><span class="hs-identifier hs-type">LMSingleFreeze</span></a></span><span> </span><span id="local-6989586621679467136"><span class="annot"><span class="annottext">Freeze
</span><a href="#local-6989586621679467136"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-394"></span><span>        </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-395"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldFreeze (single)&quot;</span></span><span>
</span><span id="line-396"></span><span>          </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-397"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsOuter f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pSingleFreeze"><span class="hs-identifier hs-var">pSingleFreeze</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-398"></span><span>          </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-399"></span><span>        </span><span class="annot"><span class="annottext">ContextSingle SPitch -&gt; Freeze -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeFreeze"><span class="hs-identifier hs-var">observeFreeze</span></a></span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch
</span><a href="#local-6989586621679467139"><span class="hs-identifier hs-var">parents</span></a></span><span> </span><span class="annot"><span class="annottext">Freeze
</span><a href="#local-6989586621679467136"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-400"></span><span>      </span><span class="annot"><a href="Common.html#LMSingleSplit"><span class="hs-identifier hs-type">LMSingleSplit</span></a></span><span> </span><span id="local-6989586621679467130"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467130"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-401"></span><span>        </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-402"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldFreeze (single)&quot;</span></span><span>
</span><span id="line-403"></span><span>          </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-404"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsOuter f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pSingleFreeze"><span class="hs-identifier hs-var">pSingleFreeze</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span>          </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-406"></span><span>        </span><span class="annot"><span class="annottext">ContextSingle SPitch -&gt; Split SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeSplit"><span class="hs-identifier hs-var">observeSplit</span></a></span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch
</span><a href="#local-6989586621679467139"><span class="hs-identifier hs-var">parents</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467130"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-407"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LeftmostSingle (Split SPitch) Freeze
</span><a href="#local-6989586621679467137"><span class="hs-identifier hs-var">singleOp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-408"></span><span>      </span><span class="annot"><a href="Common.html#LMSingleFreeze"><span class="hs-identifier hs-type">LMSingleFreeze</span></a></span><span> </span><span class="annot"><span class="annottext">Freeze
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Freezing a non-freezable transition.&quot;</span></span><span>
</span><span id="line-409"></span><span>      </span><span class="annot"><a href="Common.html#LMSingleSplit"><span class="hs-identifier hs-type">LMSingleSplit</span></a></span><span> </span><span id="local-6989586621679467125"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467125"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch -&gt; Split SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeSplit"><span class="hs-identifier hs-var">observeSplit</span></a></span><span> </span><span class="annot"><span class="annottext">ContextSingle SPitch
</span><a href="#local-6989586621679467139"><span class="hs-identifier hs-var">parents</span></a></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467125"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span id="local-6989586621679467124"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleDoubleStep"><span class="hs-identifier hs-type">sampleDoubleStep</span></a></span><span>
</span><span id="line-412"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span>
</span><span id="line-413"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextDouble"><span class="hs-identifier hs-type">ContextDouble</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-414"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-415"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679467124"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#LeftmostDouble"><span class="hs-identifier hs-type">LeftmostDouble</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-416"></span><span id="sampleDoubleStep"><span class="annot"><span class="annottext">sampleDoubleStep :: ContextDouble SPitch
-&gt; Bool -&gt; m (LeftmostDouble (Split SPitch) Freeze (Spread SPitch))
</span><a href="PVGrammar.Prob.Simple.html#sampleDoubleStep"><span class="hs-identifier hs-var hs-var">sampleDoubleStep</span></a></span></span><span> </span><span id="local-6989586621679467071"><span class="annot"><span class="annottext">parents :: ContextDouble SPitch
</span><a href="#local-6989586621679467071"><span class="hs-identifier hs-var">parents</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679467070"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467070"><span class="hs-identifier hs-var">sliceL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467069"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467069"><span class="hs-identifier hs-var">transL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467068"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467068"><span class="hs-identifier hs-var">sliceM</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467067"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467067"><span class="hs-identifier hs-var">transR</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467066"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467066"><span class="hs-identifier hs-var">sliceR</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679467065"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467065"><span class="hs-identifier hs-var">afterRightSplit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-417"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467065"><span class="hs-identifier hs-var">afterRightSplit</span></a></span><span>
</span><span id="line-418"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-419"></span><span>      </span><span id="local-6989586621679467064"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467064"><span class="hs-identifier hs-var">shouldSplitRight</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-420"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldSplitRight&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsOuter f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleRightSplit"><span class="hs-identifier hs-var">pDoubleRightSplit</span></a></span><span>
</span><span id="line-421"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467064"><span class="hs-identifier hs-var">shouldSplitRight</span></a></span><span>
</span><span id="line-422"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall s f h. s -&gt; LeftmostDouble s f h
</span><a href="Common.html#LMDoubleSplitRight"><span class="hs-identifier hs-var">LMDoubleSplitRight</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Geometric1, SampleCtx m Bernoulli,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 RandomInterpreter m PVParams) =&gt;
ContextSingle SPitch -&gt; m (Split SPitch)
</span><a href="PVGrammar.Prob.Simple.html#sampleSplit"><span class="hs-identifier hs-var">sampleSplit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467068"><span class="hs-identifier hs-var">sliceM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467067"><span class="hs-identifier hs-var">transR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467066"><span class="hs-identifier hs-var">sliceR</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-423"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall s f h. h -&gt; LeftmostDouble s f h
</span><a href="Common.html#LMDoubleSpread"><span class="hs-identifier hs-var">LMDoubleSpread</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m (Categorical 3), SampleCtx m Binomial,
 SampleCtx m Bernoulli, SampleCtx m Geometric0,
 RandomInterpreter m PVParams) =&gt;
ContextDouble SPitch -&gt; m (Spread SPitch)
</span><a href="PVGrammar.Prob.Simple.html#sampleSpread"><span class="hs-identifier hs-var">sampleSpread</span></a></span><span> </span><span class="annot"><span class="annottext">ContextDouble SPitch
</span><a href="#local-6989586621679467071"><span class="hs-identifier hs-var">parents</span></a></span><span>
</span><span id="line-424"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-425"></span><span>      </span><span id="local-6989586621679467059"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467059"><span class="hs-identifier hs-var">continueLeft</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-426"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;continueLeft&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsOuter f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeft"><span class="hs-identifier hs-var">pDoubleLeft</span></a></span><span>
</span><span id="line-427"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467059"><span class="hs-identifier hs-var">continueLeft</span></a></span><span>
</span><span id="line-428"></span><span>        </span><span class="hs-keyword">then</span><span>
</span><span id="line-429"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">forall n. (Eq (IntervalOf n), HasPitch n) =&gt; Edges n -&gt; Bool
</span><a href="PVGrammar.Generate.html#freezable"><span class="hs-identifier hs-var">freezable</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467069"><span class="hs-identifier hs-var">transL</span></a></span><span>
</span><span id="line-430"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-431"></span><span>              </span><span id="local-6989586621679467055"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467055"><span class="hs-identifier hs-var">shouldFreeze</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-432"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldFreeze (double)&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-433"></span><span>                  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span>
</span><span id="line-434"></span><span>                    </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsOuter f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeftFreeze"><span class="hs-identifier hs-var">pDoubleLeftFreeze</span></a></span><span>
</span><span id="line-435"></span><span>              </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467055"><span class="hs-identifier hs-var">shouldFreeze</span></a></span><span>
</span><span id="line-436"></span><span>                </span><span class="hs-keyword">then</span><span>
</span><span id="line-437"></span><span>                  </span><span class="annot"><span class="annottext">forall s f h. f -&gt; LeftmostDouble s f h
</span><a href="Common.html#LMDoubleFreezeLeft"><span class="hs-identifier hs-var">LMDoubleFreezeLeft</span></a></span><span>
</span><span id="line-438"></span><span>                    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) n.
RandomInterpreter m PVParams =&gt;
ContextSingle n -&gt; m Freeze
</span><a href="PVGrammar.Prob.Simple.html#sampleFreeze"><span class="hs-identifier hs-var">sampleFreeze</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467070"><span class="hs-identifier hs-var">sliceL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467069"><span class="hs-identifier hs-var">transL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467068"><span class="hs-identifier hs-var">sliceM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span>                </span><span class="hs-keyword">else</span><span>
</span><span id="line-440"></span><span>                  </span><span class="annot"><span class="annottext">forall s f h. s -&gt; LeftmostDouble s f h
</span><a href="Common.html#LMDoubleSplitLeft"><span class="hs-identifier hs-var">LMDoubleSplitLeft</span></a></span><span>
</span><span id="line-441"></span><span>                    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Geometric1, SampleCtx m Bernoulli,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 RandomInterpreter m PVParams) =&gt;
ContextSingle SPitch -&gt; m (Split SPitch)
</span><a href="PVGrammar.Prob.Simple.html#sampleSplit"><span class="hs-identifier hs-var">sampleSplit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467070"><span class="hs-identifier hs-var">sliceL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467069"><span class="hs-identifier hs-var">transL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467068"><span class="hs-identifier hs-var">sliceM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-442"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall s f h. s -&gt; LeftmostDouble s f h
</span><a href="Common.html#LMDoubleSplitLeft"><span class="hs-identifier hs-var">LMDoubleSplitLeft</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Geometric1, SampleCtx m Bernoulli,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 RandomInterpreter m PVParams) =&gt;
ContextSingle SPitch -&gt; m (Split SPitch)
</span><a href="PVGrammar.Prob.Simple.html#sampleSplit"><span class="hs-identifier hs-var">sampleSplit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467070"><span class="hs-identifier hs-var">sliceL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467069"><span class="hs-identifier hs-var">transL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467068"><span class="hs-identifier hs-var">sliceM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-443"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ContextDouble SPitch
-&gt; Bool -&gt; m (LeftmostDouble (Split SPitch) Freeze (Spread SPitch))
</span><a href="PVGrammar.Prob.Simple.html#sampleDoubleStep"><span class="hs-identifier hs-var">sampleDoubleStep</span></a></span><span> </span><span class="annot"><span class="annottext">ContextDouble SPitch
</span><a href="#local-6989586621679467071"><span class="hs-identifier hs-var">parents</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-444"></span><span>
</span><span id="line-445"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeDoubleStep"><span class="hs-identifier hs-type">observeDoubleStep</span></a></span><span>
</span><span id="line-446"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextDouble"><span class="hs-identifier hs-type">ContextDouble</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-447"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-448"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.html#LeftmostDouble"><span class="hs-identifier hs-type">LeftmostDouble</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-449"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-450"></span><span id="observeDoubleStep"><span class="annot"><span class="annottext">observeDoubleStep :: ContextDouble SPitch
-&gt; Bool
-&gt; LeftmostDouble (Split SPitch) Freeze (Spread SPitch)
-&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeDoubleStep"><span class="hs-identifier hs-var hs-var">observeDoubleStep</span></a></span></span><span> </span><span id="local-6989586621679467051"><span class="annot"><span class="annottext">parents :: ContextDouble SPitch
</span><a href="#local-6989586621679467051"><span class="hs-identifier hs-var">parents</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679467050"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467050"><span class="hs-identifier hs-var">sliceL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467049"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467049"><span class="hs-identifier hs-var">transL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467048"><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467048"><span class="hs-identifier hs-var">sliceM</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467047"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467047"><span class="hs-identifier hs-var">transR</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679467046"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467046"><span class="hs-identifier hs-var">sliceR</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679467045"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467045"><span class="hs-identifier hs-var">afterRightSplit</span></a></span></span><span> </span><span id="local-6989586621679467044"><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) Freeze (Spread SPitch)
</span><a href="#local-6989586621679467044"><span class="hs-identifier hs-var">doubleOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-451"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LeftmostDouble (Split SPitch) Freeze (Spread SPitch)
</span><a href="#local-6989586621679467044"><span class="hs-identifier hs-var">doubleOp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-452"></span><span>    </span><span class="annot"><a href="Common.html#LMDoubleFreezeLeft"><span class="hs-identifier hs-type">LMDoubleFreezeLeft</span></a></span><span> </span><span id="local-6989586621679467043"><span class="annot"><span class="annottext">Freeze
</span><a href="#local-6989586621679467043"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-453"></span><span>      </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;continueLeft&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsOuter f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeft"><span class="hs-identifier hs-var">pDoubleLeft</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-454"></span><span>      </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-455"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldFreeze (double)&quot;</span></span><span>
</span><span id="line-456"></span><span>        </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-457"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsOuter f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeftFreeze"><span class="hs-identifier hs-var">pDoubleLeftFreeze</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-458"></span><span>        </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-459"></span><span>      </span><span class="annot"><span class="annottext">ContextSingle SPitch -&gt; Freeze -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeFreeze"><span class="hs-identifier hs-var">observeFreeze</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467050"><span class="hs-identifier hs-var">sliceL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467049"><span class="hs-identifier hs-var">transL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467048"><span class="hs-identifier hs-var">sliceM</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Freeze
</span><a href="#local-6989586621679467043"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-460"></span><span>    </span><span class="annot"><a href="Common.html#LMDoubleSplitLeft"><span class="hs-identifier hs-type">LMDoubleSplitLeft</span></a></span><span> </span><span id="local-6989586621679467036"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467036"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-461"></span><span>      </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;continueLeft&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsOuter f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeft"><span class="hs-identifier hs-var">pDoubleLeft</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-462"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall n. (Eq (IntervalOf n), HasPitch n) =&gt; Edges n -&gt; Bool
</span><a href="PVGrammar.Generate.html#freezable"><span class="hs-identifier hs-var">freezable</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467049"><span class="hs-identifier hs-var">transL</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-463"></span><span>        </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-464"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldFreeze (double)&quot;</span></span><span>
</span><span id="line-465"></span><span>          </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-466"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsOuter f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeftFreeze"><span class="hs-identifier hs-var">pDoubleLeftFreeze</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-467"></span><span>          </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-468"></span><span>      </span><span class="annot"><span class="annottext">ContextSingle SPitch -&gt; Split SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeSplit"><span class="hs-identifier hs-var">observeSplit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467050"><span class="hs-identifier hs-var">sliceL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467049"><span class="hs-identifier hs-var">transL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467048"><span class="hs-identifier hs-var">sliceM</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467036"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-469"></span><span>    </span><span class="annot"><a href="Common.html#LMDoubleSplitRight"><span class="hs-identifier hs-type">LMDoubleSplitRight</span></a></span><span> </span><span id="local-6989586621679467029"><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467029"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-470"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467045"><span class="hs-identifier hs-var">afterRightSplit</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-471"></span><span>        </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;continueLeft&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsOuter f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeft"><span class="hs-identifier hs-var">pDoubleLeft</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-472"></span><span>      </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-473"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldSplitRight&quot;</span></span><span>
</span><span id="line-474"></span><span>        </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-475"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsOuter f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleRightSplit"><span class="hs-identifier hs-var">pDoubleRightSplit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-476"></span><span>        </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-477"></span><span>      </span><span class="annot"><span class="annottext">ContextSingle SPitch -&gt; Split SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeSplit"><span class="hs-identifier hs-var">observeSplit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">Notes SPitch
</span><a href="#local-6989586621679467048"><span class="hs-identifier hs-var">sliceM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679467047"><span class="hs-identifier hs-var">transR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679467046"><span class="hs-identifier hs-var">sliceR</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679467029"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-478"></span><span>    </span><span class="annot"><a href="Common.html#LMDoubleSpread"><span class="hs-identifier hs-type">LMDoubleSpread</span></a></span><span> </span><span id="local-6989586621679467022"><span class="annot"><span class="annottext">Spread SPitch
</span><a href="#local-6989586621679467022"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-479"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679467045"><span class="hs-identifier hs-var">afterRightSplit</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-480"></span><span>        </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;continueLeft&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsOuter f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleLeft"><span class="hs-identifier hs-var">pDoubleLeft</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-481"></span><span>      </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-482"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shouldSplitRight&quot;</span></span><span>
</span><span id="line-483"></span><span>        </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-484"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsOuter f)
</span><a href="PVGrammar.Prob.Simple.html#pOuter"><span class="hs-identifier hs-var">pOuter</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsOuter f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pDoubleRightSplit"><span class="hs-identifier hs-var">pDoubleRightSplit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-485"></span><span>        </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-486"></span><span>      </span><span class="annot"><span class="annottext">ContextDouble SPitch -&gt; Spread SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeSpread"><span class="hs-identifier hs-var">observeSpread</span></a></span><span> </span><span class="annot"><span class="annottext">ContextDouble SPitch
</span><a href="#local-6989586621679467051"><span class="hs-identifier hs-var">parents</span></a></span><span> </span><span class="annot"><span class="annottext">Spread SPitch
</span><a href="#local-6989586621679467022"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span id="local-6989586621679469189"><span id="local-6989586621679469190"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleFreeze"><span class="hs-identifier hs-type">sampleFreeze</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RandomInterpreter</span></span><span> </span><span class="annot"><a href="#local-6989586621679469190"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParams"><span class="hs-identifier hs-type">PVParams</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextSingle"><span class="hs-identifier hs-type">ContextSingle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679469189"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679469190"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span></span></span><span>
</span><span id="line-489"></span><span id="sampleFreeze"><span class="annot"><span class="annottext">sampleFreeze :: forall (m :: * -&gt; *) n.
RandomInterpreter m PVParams =&gt;
ContextSingle n -&gt; m Freeze
</span><a href="PVGrammar.Prob.Simple.html#sampleFreeze"><span class="hs-identifier hs-var hs-var">sampleFreeze</span></a></span></span><span> </span><span id="local-6989586621679467010"><span class="annot"><span class="annottext">ContextSingle n
</span><a href="#local-6989586621679467010"><span class="hs-identifier hs-var">_parents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Freeze
</span><a href="PVGrammar.html#FreezeOp"><span class="hs-identifier hs-var">FreezeOp</span></a></span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeFreeze"><span class="hs-identifier hs-type">observeFreeze</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextSingle"><span class="hs-identifier hs-type">ContextSingle</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-492"></span><span id="observeFreeze"><span class="annot"><span class="annottext">observeFreeze :: ContextSingle SPitch -&gt; Freeze -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeFreeze"><span class="hs-identifier hs-var hs-var">observeFreeze</span></a></span></span><span> </span><span id="local-6989586621679467008"><span class="annot"><span class="annottext">ContextSingle SPitch
</span><a href="#local-6989586621679467008"><span class="hs-identifier hs-var">_parents</span></a></span></span><span> </span><span class="annot"><span class="annottext">Freeze
</span><a href="PVGrammar.html#FreezeOp"><span class="hs-identifier hs-var">FreezeOp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-493"></span><span>
</span><span id="line-494"></span><span class="hs-comment">-- helper for sampleSplit and observeSplit</span><span>
</span><span id="line-495"></span><span id="local-6989586621679469149"><span id="local-6989586621679469150"><span id="local-6989586621679469151"><span class="annot"><a href="PVGrammar.Prob.Simple.html#collectElabos"><span class="hs-identifier hs-type">collectElabos</span></a></span><span>
</span><span id="line-496"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679469151"><span class="hs-identifier hs-type">o1</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-497"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#InnerEdge"><span class="hs-identifier hs-type">InnerEdge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-498"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679469150"><span class="hs-identifier hs-type">o2</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-499"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679469149"><span class="hs-identifier hs-type">o3</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-500"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#StartStop"><span class="hs-identifier hs-type">StartStop</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#StartStop"><span class="hs-identifier hs-type">StartStop</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679469151"><span class="hs-identifier hs-type">o1</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-501"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-502"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679469150"><span class="hs-identifier hs-type">o2</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-503"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679469149"><span class="hs-identifier hs-type">o3</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-504"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.HashSet</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-505"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.HashSet</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-506"></span><span>     </span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-507"></span><span id="collectElabos"><span class="annot"><span class="annottext">collectElabos :: forall o1 o2 o3.
[(Edge SPitch, [(SPitch, o1)])]
-&gt; [(InnerEdge SPitch, [(SPitch, PassingOrnament)])]
-&gt; [(SPitch, [(SPitch, o2)])]
-&gt; [(SPitch, [(SPitch, o3)])]
-&gt; (Map (Edge SPitch) [(SPitch, o1)],
    Map (InnerEdge SPitch) [(SPitch, PassingOrnament)],
    Map SPitch [(SPitch, o2)], Map SPitch [(SPitch, o3)],
    HashSet (Edge SPitch), HashSet (Edge SPitch))
</span><a href="PVGrammar.Prob.Simple.html#collectElabos"><span class="hs-identifier hs-var hs-var">collectElabos</span></a></span></span><span> </span><span id="local-6989586621679466982"><span class="annot"><span class="annottext">[(Edge SPitch, [(SPitch, o1)])]
</span><a href="#local-6989586621679466982"><span class="hs-identifier hs-var">childrenT</span></a></span></span><span> </span><span id="local-6989586621679466981"><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679466981"><span class="hs-identifier hs-var">childrenNT</span></a></span></span><span> </span><span id="local-6989586621679466980"><span class="annot"><span class="annottext">[(SPitch, [(SPitch, o2)])]
</span><a href="#local-6989586621679466980"><span class="hs-identifier hs-var">childrenL</span></a></span></span><span> </span><span id="local-6989586621679466979"><span class="annot"><span class="annottext">[(SPitch, [(SPitch, o3)])]
</span><a href="#local-6989586621679466979"><span class="hs-identifier hs-var">childrenR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-508"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466978"><span class="annot"><span class="annottext">splitTs :: Map (Edge SPitch) [(SPitch, o1)]
</span><a href="#local-6989586621679466978"><span class="hs-identifier hs-var hs-var">splitTs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Edge SPitch, [(SPitch, o1)])]
</span><a href="#local-6989586621679466982"><span class="hs-identifier hs-var">childrenT</span></a></span><span>
</span><span id="line-509"></span><span>      </span><span id="local-6989586621679466976"><span class="annot"><span class="annottext">splitNTs :: Map (InnerEdge SPitch) [(SPitch, PassingOrnament)]
</span><a href="#local-6989586621679466976"><span class="hs-identifier hs-var hs-var">splitNTs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679466981"><span class="hs-identifier hs-var">childrenNT</span></a></span><span>
</span><span id="line-510"></span><span>      </span><span id="local-6989586621679466975"><span class="annot"><span class="annottext">fromLeft :: Map SPitch [(SPitch, o2)]
</span><a href="#local-6989586621679466975"><span class="hs-identifier hs-var hs-var">fromLeft</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(SPitch, [(SPitch, o2)])]
</span><a href="#local-6989586621679466980"><span class="hs-identifier hs-var">childrenL</span></a></span><span>
</span><span id="line-511"></span><span>      </span><span id="local-6989586621679466974"><span class="annot"><span class="annottext">fromRight :: Map SPitch [(SPitch, o3)]
</span><a href="#local-6989586621679466974"><span class="hs-identifier hs-var hs-var">fromRight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(SPitch, [(SPitch, o3)])]
</span><a href="#local-6989586621679466979"><span class="hs-identifier hs-var">childrenR</span></a></span><span>
</span><span id="line-512"></span><span>      </span><span id="local-6989586621679466973"><span class="annot"><span class="annottext">keepLeftT :: [Edge SPitch]
</span><a href="#local-6989586621679466973"><span class="hs-identifier hs-var hs-var">keepLeftT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall p c o.
[(p, [(c, o)])] -&gt; (p -&gt; c -&gt; Edge SPitch) -&gt; [Edge SPitch]
</span><a href="#local-6989586621679466972"><span class="hs-identifier hs-var">getEdges</span></a></span><span> </span><span class="annot"><span class="annottext">[(Edge SPitch, [(SPitch, o1)])]
</span><a href="#local-6989586621679466982"><span class="hs-identifier hs-var">childrenT</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679466971"><span class="annot"><span class="annottext">Edge SPitch
</span><a href="#local-6989586621679466971"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679466970"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466970"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">Edge SPitch
</span><a href="#local-6989586621679466971"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466970"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-513"></span><span>      </span><span id="local-6989586621679466969"><span class="annot"><span class="annottext">keepLeftL :: [Edge SPitch]
</span><a href="#local-6989586621679466969"><span class="hs-identifier hs-var hs-var">keepLeftL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall p c o.
[(p, [(c, o)])] -&gt; (p -&gt; c -&gt; Edge SPitch) -&gt; [Edge SPitch]
</span><a href="#local-6989586621679466972"><span class="hs-identifier hs-var">getEdges</span></a></span><span> </span><span class="annot"><span class="annottext">[(SPitch, [(SPitch, o2)])]
</span><a href="#local-6989586621679466980"><span class="hs-identifier hs-var">childrenL</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679466968"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466968"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679466967"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466967"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466968"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466967"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-514"></span><span>      </span><span id="local-6989586621679466966"><span class="annot"><span class="annottext">keepLeftNT :: [Edge SPitch]
</span><a href="#local-6989586621679466966"><span class="hs-identifier hs-var hs-var">keepLeftNT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-515"></span><span>        </span><span class="hs-comment">-- List</span><span>
</span><span id="line-516"></span><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679466965"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466965"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466964"><span class="annot"><span class="annottext">[(SPitch, PassingOrnament)]
</span><a href="#local-6989586621679466964"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679466981"><span class="hs-identifier hs-var">childrenNT</span></a></span><span>
</span><span id="line-517"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679466963"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466963"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466962"><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679466962"><span class="hs-identifier hs-var">orn</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(SPitch, PassingOrnament)]
</span><a href="#local-6989586621679466964"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-518"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679466962"><span class="hs-identifier hs-var">orn</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="PVGrammar.html#PassingRight"><span class="hs-identifier hs-var">PassingRight</span></a></span><span>
</span><span id="line-519"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466965"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466963"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-520"></span><span>      </span><span id="local-6989586621679466959"><span class="annot"><span class="annottext">leftEdges :: HashSet (Edge SPitch)
</span><a href="#local-6989586621679466959"><span class="hs-identifier hs-var hs-var">leftEdges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Edge SPitch]
</span><a href="#local-6989586621679466973"><span class="hs-identifier hs-var">keepLeftT</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Edge SPitch]
</span><a href="#local-6989586621679466966"><span class="hs-identifier hs-var">keepLeftNT</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Edge SPitch]
</span><a href="#local-6989586621679466969"><span class="hs-identifier hs-var">keepLeftL</span></a></span><span>
</span><span id="line-521"></span><span>      </span><span id="local-6989586621679466957"><span class="annot"><span class="annottext">keepRightT :: [Edge SPitch]
</span><a href="#local-6989586621679466957"><span class="hs-identifier hs-var hs-var">keepRightT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall p c o.
[(p, [(c, o)])] -&gt; (p -&gt; c -&gt; Edge SPitch) -&gt; [Edge SPitch]
</span><a href="#local-6989586621679466972"><span class="hs-identifier hs-var">getEdges</span></a></span><span> </span><span class="annot"><span class="annottext">[(Edge SPitch, [(SPitch, o1)])]
</span><a href="#local-6989586621679466982"><span class="hs-identifier hs-var">childrenT</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679466956"><span class="annot"><span class="annottext">Edge SPitch
</span><a href="#local-6989586621679466956"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679466955"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466955"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466955"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">Edge SPitch
</span><a href="#local-6989586621679466956"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-522"></span><span>      </span><span id="local-6989586621679466954"><span class="annot"><span class="annottext">keepRightR :: [Edge SPitch]
</span><a href="#local-6989586621679466954"><span class="hs-identifier hs-var hs-var">keepRightR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall p c o.
[(p, [(c, o)])] -&gt; (p -&gt; c -&gt; Edge SPitch) -&gt; [Edge SPitch]
</span><a href="#local-6989586621679466972"><span class="hs-identifier hs-var">getEdges</span></a></span><span> </span><span class="annot"><span class="annottext">[(SPitch, [(SPitch, o3)])]
</span><a href="#local-6989586621679466979"><span class="hs-identifier hs-var">childrenR</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679466953"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466953"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621679466952"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466952"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466952"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466953"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-523"></span><span>      </span><span id="local-6989586621679466951"><span class="annot"><span class="annottext">keepRightNT :: [Edge SPitch]
</span><a href="#local-6989586621679466951"><span class="hs-identifier hs-var hs-var">keepRightNT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-524"></span><span>        </span><span class="hs-comment">-- List</span><span>
</span><span id="line-525"></span><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466950"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466950"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466949"><span class="annot"><span class="annottext">[(SPitch, PassingOrnament)]
</span><a href="#local-6989586621679466949"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679466981"><span class="hs-identifier hs-var">childrenNT</span></a></span><span>
</span><span id="line-526"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679466948"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466948"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466947"><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679466947"><span class="hs-identifier hs-var">orn</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(SPitch, PassingOrnament)]
</span><a href="#local-6989586621679466949"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-527"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679466947"><span class="hs-identifier hs-var">orn</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="PVGrammar.html#PassingLeft"><span class="hs-identifier hs-var">PassingLeft</span></a></span><span>
</span><span id="line-528"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466948"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466950"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-529"></span><span>      </span><span id="local-6989586621679466945"><span class="annot"><span class="annottext">rightEdges :: HashSet (Edge SPitch)
</span><a href="#local-6989586621679466945"><span class="hs-identifier hs-var hs-var">rightEdges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Edge SPitch]
</span><a href="#local-6989586621679466957"><span class="hs-identifier hs-var">keepRightT</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Edge SPitch]
</span><a href="#local-6989586621679466951"><span class="hs-identifier hs-var">keepRightNT</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Edge SPitch]
</span><a href="#local-6989586621679466954"><span class="hs-identifier hs-var">keepRightR</span></a></span><span>
</span><span id="line-530"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (Edge SPitch) [(SPitch, o1)]
</span><a href="#local-6989586621679466978"><span class="hs-identifier hs-var">splitTs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map (InnerEdge SPitch) [(SPitch, PassingOrnament)]
</span><a href="#local-6989586621679466976"><span class="hs-identifier hs-var">splitNTs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map SPitch [(SPitch, o2)]
</span><a href="#local-6989586621679466975"><span class="hs-identifier hs-var">fromLeft</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map SPitch [(SPitch, o3)]
</span><a href="#local-6989586621679466974"><span class="hs-identifier hs-var">fromRight</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466959"><span class="hs-identifier hs-var">leftEdges</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466945"><span class="hs-identifier hs-var">rightEdges</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-531"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-532"></span><span>  </span><span id="local-6989586621679469139"><span id="local-6989586621679469140"><span id="local-6989586621679469141"><span class="annot"><a href="#local-6989586621679466972"><span class="hs-identifier hs-type">getEdges</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679469141"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679469140"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679469139"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679469141"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679469140"><span class="hs-identifier hs-type">c</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span></span></span></span><span>
</span><span id="line-533"></span><span>  </span><span id="local-6989586621679466972"><span class="annot"><span class="annottext">getEdges :: forall p c o.
[(p, [(c, o)])] -&gt; (p -&gt; c -&gt; Edge SPitch) -&gt; [Edge SPitch]
</span><a href="#local-6989586621679466972"><span class="hs-identifier hs-var hs-var">getEdges</span></a></span></span><span> </span><span id="local-6989586621679466941"><span class="annot"><span class="annottext">[(p, [(c, o)])]
</span><a href="#local-6989586621679466941"><span class="hs-identifier hs-var">elabos</span></a></span></span><span> </span><span id="local-6989586621679466940"><span class="annot"><span class="annottext">p -&gt; c -&gt; Edge SPitch
</span><a href="#local-6989586621679466940"><span class="hs-identifier hs-var">mkEdge</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-534"></span><span>    </span><span class="hs-comment">-- List</span><span>
</span><span id="line-535"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679466939"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679466939"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466938"><span class="annot"><span class="annottext">[(c, o)]
</span><a href="#local-6989586621679466938"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(p, [(c, o)])]
</span><a href="#local-6989586621679466941"><span class="hs-identifier hs-var">elabos</span></a></span><span>
</span><span id="line-536"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679466937"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679466937"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">o
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(c, o)]
</span><a href="#local-6989586621679466938"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-537"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">p -&gt; c -&gt; Edge SPitch
</span><a href="#local-6989586621679466940"><span class="hs-identifier hs-var">mkEdge</span></a></span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679466939"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679466937"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-538"></span><span>
</span><span id="line-539"></span><span class="hs-comment">-- helper for sampleSplit and observeSplit</span><span>
</span><span id="line-540"></span><span id="local-6989586621679469126"><span id="local-6989586621679469127"><span id="local-6989586621679469128"><span class="annot"><a href="PVGrammar.Prob.Simple.html#collectNotes"><span class="hs-identifier hs-type">collectNotes</span></a></span><span>
</span><span id="line-541"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679469128"><span class="hs-identifier hs-type">o1</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-542"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#InnerEdge"><span class="hs-identifier hs-type">InnerEdge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-543"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679469127"><span class="hs-identifier hs-type">o2</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-544"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679469126"><span class="hs-identifier hs-type">o3</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-545"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span></span></span></span><span>
</span><span id="line-546"></span><span id="collectNotes"><span class="annot"><span class="annottext">collectNotes :: forall o1 o2 o3.
[(Edge SPitch, [(SPitch, o1)])]
-&gt; [(InnerEdge SPitch, [(SPitch, PassingOrnament)])]
-&gt; [(SPitch, [(SPitch, o2)])]
-&gt; [(SPitch, [(SPitch, o3)])]
-&gt; [SPitch]
</span><a href="PVGrammar.Prob.Simple.html#collectNotes"><span class="hs-identifier hs-var hs-var">collectNotes</span></a></span></span><span> </span><span id="local-6989586621679466923"><span class="annot"><span class="annottext">[(Edge SPitch, [(SPitch, o1)])]
</span><a href="#local-6989586621679466923"><span class="hs-identifier hs-var">childrenT</span></a></span></span><span> </span><span id="local-6989586621679466922"><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679466922"><span class="hs-identifier hs-var">childrenNT</span></a></span></span><span> </span><span id="local-6989586621679466921"><span class="annot"><span class="annottext">[(SPitch, [(SPitch, o2)])]
</span><a href="#local-6989586621679466921"><span class="hs-identifier hs-var">childrenL</span></a></span></span><span> </span><span id="local-6989586621679466920"><span class="annot"><span class="annottext">[(SPitch, [(SPitch, o3)])]
</span><a href="#local-6989586621679466920"><span class="hs-identifier hs-var">childrenR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-547"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466919"><span class="annot"><span class="annottext">notesT :: [SPitch]
</span><a href="#local-6989586621679466919"><span class="hs-identifier hs-var hs-var">notesT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Edge SPitch, [(SPitch, o1)])]
</span><a href="#local-6989586621679466923"><span class="hs-identifier hs-var">childrenT</span></a></span><span>
</span><span id="line-548"></span><span>      </span><span id="local-6989586621679466917"><span class="annot"><span class="annottext">notesNT :: [SPitch]
</span><a href="#local-6989586621679466917"><span class="hs-identifier hs-var hs-var">notesNT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679466922"><span class="hs-identifier hs-var">childrenNT</span></a></span><span>
</span><span id="line-549"></span><span>      </span><span id="local-6989586621679466916"><span class="annot"><span class="annottext">notesFromL :: [SPitch]
</span><a href="#local-6989586621679466916"><span class="hs-identifier hs-var hs-var">notesFromL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(SPitch, [(SPitch, o2)])]
</span><a href="#local-6989586621679466921"><span class="hs-identifier hs-var">childrenL</span></a></span><span>
</span><span id="line-550"></span><span>      </span><span id="local-6989586621679466915"><span class="annot"><span class="annottext">notesFromR :: [SPitch]
</span><a href="#local-6989586621679466915"><span class="hs-identifier hs-var hs-var">notesFromR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(SPitch, [(SPitch, o3)])]
</span><a href="#local-6989586621679466920"><span class="hs-identifier hs-var">childrenR</span></a></span><span>
</span><span id="line-551"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679466919"><span class="hs-identifier hs-var">notesT</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679466917"><span class="hs-identifier hs-var">notesNT</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679466916"><span class="hs-identifier hs-var">notesFromL</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679466915"><span class="hs-identifier hs-var">notesFromR</span></a></span><span>
</span><span id="line-552"></span><span>
</span><span id="line-553"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleSplit"><span class="hs-identifier hs-type">sampleSplit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679466913"><span class="annot"><a href="#local-6989586621679466913"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextSingle"><span class="hs-identifier hs-type">ContextSingle</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679466913"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-554"></span><span id="sampleSplit"><span class="annot"><span class="annottext">sampleSplit :: ContextSingle SPitch -&gt; m (Split SPitch)
</span><a href="PVGrammar.Prob.Simple.html#sampleSplit"><span class="hs-identifier hs-var hs-var">sampleSplit</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679466839"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679466839"><span class="hs-identifier hs-var">sliceL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466838"><span class="annot"><span class="annottext">_edges :: Edges SPitch
</span><a href="#local-6989586621679466838"><span class="hs-identifier hs-var">_edges</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span id="local-6989586621679466836"><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466836"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621679466835"><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679466835"><span class="hs-identifier hs-var">nts</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466834"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679466834"><span class="hs-identifier hs-var">sliceR</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-555"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;\nPerforming split (smp) on: &quot; &lt;&gt; show edges</span><span>
</span><span id="line-556"></span><span>  </span><span class="hs-comment">-- ornament regular edges at least once</span><span>
</span><span id="line-557"></span><span>  </span><span id="local-6989586621679466833"><span class="annot"><span class="annottext">[(Edge SPitch, [(SPitch, DoubleOrnament)])]
</span><a href="#local-6989586621679466833"><span class="hs-identifier hs-var">childrenT</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Geometric1, SampleCtx m Bernoulli,
 SampleCtx m Geometric0, SampleCtx m MagicalOctaves,
 RandomInterpreter m PVParams) =&gt;
Edge SPitch -&gt; m (Edge SPitch, [(SPitch, DoubleOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#sampleT"><span class="hs-identifier hs-var">sampleT</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466836"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-558"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;childrenT (smp): &quot; &lt;&gt; show childrenT</span><span>
</span><span id="line-559"></span><span>  </span><span class="hs-comment">-- ornament passing edges exactly once</span><span>
</span><span id="line-560"></span><span>  </span><span id="local-6989586621679466829"><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679466829"><span class="hs-identifier hs-var">childrenNT</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m MagicalOctaves,
 SampleCtx m Geometric0, RandomInterpreter m PVParams) =&gt;
(InnerEdge SPitch, Int)
-&gt; m (InnerEdge SPitch, [(SPitch, PassingOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#sampleNT"><span class="hs-identifier hs-var">sampleNT</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall k. MultiSet k -&gt; [(k, Int)]
</span><a href="Internal.MultiSet.html#toOccurList"><span class="hs-identifier hs-var">MS.toOccurList</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679466835"><span class="hs-identifier hs-var">nts</span></a></span><span>
</span><span id="line-561"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;childrenNT (smp): &quot; &lt;&gt; show childrenNT</span><span>
</span><span id="line-562"></span><span>  </span><span class="hs-comment">-- ornament left notes</span><span>
</span><span id="line-563"></span><span>  </span><span id="local-6989586621679466826"><span class="annot"><span class="annottext">[(SPitch, [(SPitch, RightOrnament)])]
</span><a href="#local-6989586621679466826"><span class="hs-identifier hs-var">childrenL</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. StartStop a -&gt; Maybe a
</span><a href="Common.html#getInner"><span class="hs-identifier hs-var">getInner</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679466839"><span class="hs-identifier hs-var">sliceL</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-564"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Notes SPitch)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-565"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679466824"><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679466824"><span class="hs-identifier hs-var">notes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Geometric0, SampleCtx m Bernoulli,
 SampleCtx m MagicalOctaves, RandomInterpreter m PVParams) =&gt;
SPitch -&gt; m (SPitch, [(SPitch, RightOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#sampleL"><span class="hs-identifier hs-var">sampleL</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a -&gt; [a]
</span><a href="Internal.MultiSet.html#toList"><span class="hs-identifier hs-var">MS.toList</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679466824"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-566"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;childrenL (smp): &quot; &lt;&gt; show childrenL</span><span>
</span><span id="line-567"></span><span>  </span><span class="hs-comment">-- ornament right notes</span><span>
</span><span id="line-568"></span><span>  </span><span id="local-6989586621679466821"><span class="annot"><span class="annottext">[(SPitch, [(SPitch, LeftOrnament)])]
</span><a href="#local-6989586621679466821"><span class="hs-identifier hs-var">childrenR</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. StartStop a -&gt; Maybe a
</span><a href="Common.html#getInner"><span class="hs-identifier hs-var">getInner</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679466834"><span class="hs-identifier hs-var">sliceR</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-569"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Notes SPitch)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-570"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679466820"><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679466820"><span class="hs-identifier hs-var">notes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Geometric0, SampleCtx m Bernoulli,
 SampleCtx m MagicalOctaves, RandomInterpreter m PVParams) =&gt;
SPitch -&gt; m (SPitch, [(SPitch, LeftOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#sampleR"><span class="hs-identifier hs-var">sampleR</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a -&gt; [a]
</span><a href="Internal.MultiSet.html#toList"><span class="hs-identifier hs-var">MS.toList</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679466820"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-571"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;childrenR (smp): &quot; &lt;&gt; show childrenR</span><span>
</span><span id="line-572"></span><span>  </span><span class="hs-comment">-- introduce new passing edges left and right</span><span>
</span><span id="line-573"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466818"><span class="annot"><span class="annottext">notes :: [SPitch]
</span><a href="#local-6989586621679466818"><span class="hs-identifier hs-var hs-var">notes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall o1 o2 o3.
[(Edge SPitch, [(SPitch, o1)])]
-&gt; [(InnerEdge SPitch, [(SPitch, PassingOrnament)])]
-&gt; [(SPitch, [(SPitch, o2)])]
-&gt; [(SPitch, [(SPitch, o3)])]
-&gt; [SPitch]
</span><a href="PVGrammar.Prob.Simple.html#collectNotes"><span class="hs-identifier hs-var">collectNotes</span></a></span><span> </span><span class="annot"><span class="annottext">[(Edge SPitch, [(SPitch, DoubleOrnament)])]
</span><a href="#local-6989586621679466833"><span class="hs-identifier hs-var">childrenT</span></a></span><span> </span><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679466829"><span class="hs-identifier hs-var">childrenNT</span></a></span><span> </span><span class="annot"><span class="annottext">[(SPitch, [(SPitch, RightOrnament)])]
</span><a href="#local-6989586621679466826"><span class="hs-identifier hs-var">childrenL</span></a></span><span> </span><span class="annot"><span class="annottext">[(SPitch, [(SPitch, LeftOrnament)])]
</span><a href="#local-6989586621679466821"><span class="hs-identifier hs-var">childrenR</span></a></span><span>
</span><span id="line-574"></span><span>  </span><span id="local-6989586621679466817"><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679466817"><span class="hs-identifier hs-var">passLeft</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. StartStop a -&gt; Maybe a
</span><a href="Common.html#getInner"><span class="hs-identifier hs-var">getInner</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679466839"><span class="hs-identifier hs-var">sliceL</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-575"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Notes SPitch)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span>
</span><span id="line-576"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679466815"><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679466815"><span class="hs-identifier hs-var">notesl</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-577"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Geometric0, RandomInterpreter m PVParams) =&gt;
[SPitch]
-&gt; [SPitch]
-&gt; (forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; m (MultiSet (InnerEdge SPitch))
</span><a href="PVGrammar.Prob.Simple.html#samplePassing"><span class="hs-identifier hs-var">samplePassing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a -&gt; [a]
</span><a href="Internal.MultiSet.html#toList"><span class="hs-identifier hs-var">MS.toList</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679466815"><span class="hs-identifier hs-var">notesl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679466818"><span class="hs-identifier hs-var">notes</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pNewPassingLeft"><span class="hs-identifier hs-var">pNewPassingLeft</span></a></span><span>
</span><span id="line-578"></span><span>  </span><span id="local-6989586621679466811"><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679466811"><span class="hs-identifier hs-var">passRight</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. StartStop a -&gt; Maybe a
</span><a href="Common.html#getInner"><span class="hs-identifier hs-var">getInner</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679466834"><span class="hs-identifier hs-var">sliceR</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-579"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Notes SPitch)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span>
</span><span id="line-580"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679466810"><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679466810"><span class="hs-identifier hs-var">notesr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-581"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Geometric0, RandomInterpreter m PVParams) =&gt;
[SPitch]
-&gt; [SPitch]
-&gt; (forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; m (MultiSet (InnerEdge SPitch))
</span><a href="PVGrammar.Prob.Simple.html#samplePassing"><span class="hs-identifier hs-var">samplePassing</span></a></span><span> </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679466818"><span class="hs-identifier hs-var">notes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a -&gt; [a]
</span><a href="Internal.MultiSet.html#toList"><span class="hs-identifier hs-var">MS.toList</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679466810"><span class="hs-identifier hs-var">notesr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pNewPassingRight"><span class="hs-identifier hs-var">pNewPassingRight</span></a></span><span>
</span><span id="line-582"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679466807"><span class="annot"><span class="annottext">Map (Edge SPitch) [(SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679466807"><span class="hs-identifier hs-var">splitReg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466806"><span class="annot"><span class="annottext">Map (InnerEdge SPitch) [(SPitch, PassingOrnament)]
</span><a href="#local-6989586621679466806"><span class="hs-identifier hs-var">splitPass</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466805"><span class="annot"><span class="annottext">Map SPitch [(SPitch, RightOrnament)]
</span><a href="#local-6989586621679466805"><span class="hs-identifier hs-var">fromLeft</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466804"><span class="annot"><span class="annottext">Map SPitch [(SPitch, LeftOrnament)]
</span><a href="#local-6989586621679466804"><span class="hs-identifier hs-var">fromRight</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466803"><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466803"><span class="hs-identifier hs-var">leftEdges</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466802"><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466802"><span class="hs-identifier hs-var">rightEdges</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-583"></span><span>        </span><span class="annot"><span class="annottext">forall o1 o2 o3.
[(Edge SPitch, [(SPitch, o1)])]
-&gt; [(InnerEdge SPitch, [(SPitch, PassingOrnament)])]
-&gt; [(SPitch, [(SPitch, o2)])]
-&gt; [(SPitch, [(SPitch, o3)])]
-&gt; (Map (Edge SPitch) [(SPitch, o1)],
    Map (InnerEdge SPitch) [(SPitch, PassingOrnament)],
    Map SPitch [(SPitch, o2)], Map SPitch [(SPitch, o3)],
    HashSet (Edge SPitch), HashSet (Edge SPitch))
</span><a href="PVGrammar.Prob.Simple.html#collectElabos"><span class="hs-identifier hs-var">collectElabos</span></a></span><span> </span><span class="annot"><span class="annottext">[(Edge SPitch, [(SPitch, DoubleOrnament)])]
</span><a href="#local-6989586621679466833"><span class="hs-identifier hs-var">childrenT</span></a></span><span> </span><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679466829"><span class="hs-identifier hs-var">childrenNT</span></a></span><span> </span><span class="annot"><span class="annottext">[(SPitch, [(SPitch, RightOrnament)])]
</span><a href="#local-6989586621679466826"><span class="hs-identifier hs-var">childrenL</span></a></span><span> </span><span class="annot"><span class="annottext">[(SPitch, [(SPitch, LeftOrnament)])]
</span><a href="#local-6989586621679466821"><span class="hs-identifier hs-var">childrenR</span></a></span><span>
</span><span id="line-584"></span><span>  </span><span class="hs-comment">-- decide which edges to keep</span><span>
</span><span id="line-585"></span><span>  </span><span id="local-6989586621679466801"><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466801"><span class="hs-identifier hs-var">keepLeft</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *).
(SampleCtx m Bernoulli, RandomInterpreter m PVParams, Ord e,
 Hashable e) =&gt;
(forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; HashSet e -&gt; m (HashSet e)
</span><a href="PVGrammar.Prob.Simple.html#sampleKeepEdges"><span class="hs-identifier hs-var">sampleKeepEdges</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pKeepL"><span class="hs-identifier hs-var">pKeepL</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466803"><span class="hs-identifier hs-var">leftEdges</span></a></span><span>
</span><span id="line-586"></span><span>  </span><span id="local-6989586621679466797"><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466797"><span class="hs-identifier hs-var">keepRight</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *).
(SampleCtx m Bernoulli, RandomInterpreter m PVParams, Ord e,
 Hashable e) =&gt;
(forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; HashSet e -&gt; m (HashSet e)
</span><a href="PVGrammar.Prob.Simple.html#sampleKeepEdges"><span class="hs-identifier hs-var">sampleKeepEdges</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pKeepR"><span class="hs-identifier hs-var">pKeepR</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466802"><span class="hs-identifier hs-var">rightEdges</span></a></span><span>
</span><span id="line-587"></span><span>  </span><span class="hs-comment">-- combine all sampling results into split operation</span><span>
</span><span id="line-588"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466794"><span class="annot"><span class="annottext">splitOp :: Split SPitch
</span><a href="#local-6989586621679466794"><span class="hs-identifier hs-var hs-var">splitOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-589"></span><span>        </span><span class="annot"><a href="PVGrammar.html#SplitOp"><span class="hs-identifier hs-type">SplitOp</span></a></span><span>
</span><span id="line-590"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Map (Edge SPitch) [(SPitch, DoubleOrnament)]
splitReg :: Map (Edge SPitch) [(SPitch, DoubleOrnament)]
splitReg :: Map (Edge SPitch) [(SPitch, DoubleOrnament)]
</span><a href="PVGrammar.html#splitReg"><span class="hs-identifier hs-var hs-var">splitReg</span></a></span><span>
</span><span id="line-591"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map (InnerEdge SPitch) [(SPitch, PassingOrnament)]
splitPass :: Map (InnerEdge SPitch) [(SPitch, PassingOrnament)]
splitPass :: Map (InnerEdge SPitch) [(SPitch, PassingOrnament)]
</span><a href="PVGrammar.html#splitPass"><span class="hs-identifier hs-var hs-var">splitPass</span></a></span><span>
</span><span id="line-592"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map SPitch [(SPitch, RightOrnament)]
fromLeft :: Map SPitch [(SPitch, RightOrnament)]
fromLeft :: Map SPitch [(SPitch, RightOrnament)]
</span><a href="PVGrammar.html#fromLeft"><span class="hs-identifier hs-var hs-var">fromLeft</span></a></span><span>
</span><span id="line-593"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map SPitch [(SPitch, LeftOrnament)]
fromRight :: Map SPitch [(SPitch, LeftOrnament)]
fromRight :: Map SPitch [(SPitch, LeftOrnament)]
</span><a href="PVGrammar.html#fromRight"><span class="hs-identifier hs-var hs-var">fromRight</span></a></span><span>
</span><span id="line-594"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
keepLeft :: HashSet (Edge SPitch)
keepLeft :: HashSet (Edge SPitch)
</span><a href="PVGrammar.html#keepLeft"><span class="hs-identifier hs-var hs-var">keepLeft</span></a></span><span>
</span><span id="line-595"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
keepRight :: HashSet (Edge SPitch)
keepRight :: HashSet (Edge SPitch)
</span><a href="PVGrammar.html#keepRight"><span class="hs-identifier hs-var hs-var">keepRight</span></a></span><span>
</span><span id="line-596"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
passLeft :: MultiSet (InnerEdge SPitch)
passLeft :: MultiSet (InnerEdge SPitch)
</span><a href="PVGrammar.html#passLeft"><span class="hs-identifier hs-var hs-var">passLeft</span></a></span><span>
</span><span id="line-597"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
passRight :: MultiSet (InnerEdge SPitch)
passRight :: MultiSet (InnerEdge SPitch)
</span><a href="PVGrammar.html#passRight"><span class="hs-identifier hs-var hs-var">passRight</span></a></span><span>
</span><span id="line-598"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-599"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;Performing split (smp): &quot; &lt;&gt; show splitOp</span><span>
</span><span id="line-600"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Split SPitch
</span><a href="#local-6989586621679466794"><span class="hs-identifier hs-var">splitOp</span></a></span><span>
</span><span id="line-601"></span><span>
</span><span id="line-602"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeSplit"><span class="hs-identifier hs-type">observeSplit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextSingle"><span class="hs-identifier hs-type">ContextSingle</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-603"></span><span id="observeSplit"><span class="annot"><span class="annottext">observeSplit :: ContextSingle SPitch -&gt; Split SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeSplit"><span class="hs-identifier hs-var hs-var">observeSplit</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679466784"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679466784"><span class="hs-identifier hs-var">sliceL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466783"><span class="annot"><span class="annottext">_edges :: Edges SPitch
</span><a href="#local-6989586621679466783"><span class="hs-identifier hs-var">_edges</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span id="local-6989586621679466782"><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466782"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621679466781"><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679466781"><span class="hs-identifier hs-var">nts</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466780"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679466780"><span class="hs-identifier hs-var">sliceR</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679466779"><span class="annot"><span class="annottext">_splitOp :: Split SPitch
</span><a href="#local-6989586621679466779"><span class="hs-identifier hs-var">_splitOp</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#SplitOp"><span class="hs-identifier hs-type">SplitOp</span></a></span><span> </span><span id="local-6989586621679466778"><span class="annot"><span class="annottext">Map (Edge SPitch) [(SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679466778"><span class="hs-identifier hs-var">splitTs</span></a></span></span><span> </span><span id="local-6989586621679466777"><span class="annot"><span class="annottext">Map (InnerEdge SPitch) [(SPitch, PassingOrnament)]
</span><a href="#local-6989586621679466777"><span class="hs-identifier hs-var">splitNTs</span></a></span></span><span> </span><span id="local-6989586621679466776"><span class="annot"><span class="annottext">Map SPitch [(SPitch, RightOrnament)]
</span><a href="#local-6989586621679466776"><span class="hs-identifier hs-var">fromLeft</span></a></span></span><span> </span><span id="local-6989586621679466775"><span class="annot"><span class="annottext">Map SPitch [(SPitch, LeftOrnament)]
</span><a href="#local-6989586621679466775"><span class="hs-identifier hs-var">fromRight</span></a></span></span><span> </span><span id="local-6989586621679466774"><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466774"><span class="hs-identifier hs-var">keepLeft</span></a></span></span><span> </span><span id="local-6989586621679466773"><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466773"><span class="hs-identifier hs-var">keepRight</span></a></span></span><span> </span><span id="local-6989586621679466772"><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679466772"><span class="hs-identifier hs-var">passLeft</span></a></span></span><span> </span><span id="local-6989586621679466771"><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679466771"><span class="hs-identifier hs-var">passRight</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-604"></span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-605"></span><span>    </span><span class="hs-comment">-- DT.traceM $ &quot;\nPerforming split (obs): &quot; &lt;&gt; show splitOp</span><span>
</span><span id="line-606"></span><span>    </span><span class="hs-comment">-- observe ornaments of regular edges</span><span>
</span><span id="line-607"></span><span>    </span><span id="local-6989586621679466770"><span class="annot"><span class="annottext">[(Edge SPitch, [(SPitch, DoubleOrnament)])]
</span><a href="#local-6989586621679466770"><span class="hs-identifier hs-var">childrenT</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (Edge SPitch) [(SPitch, DoubleOrnament)]
-&gt; Edge SPitch -&gt; PVObs (Edge SPitch, [(SPitch, DoubleOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#observeT"><span class="hs-identifier hs-var">observeT</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Edge SPitch) [(SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679466778"><span class="hs-identifier hs-var">splitTs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466782"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-608"></span><span>    </span><span class="hs-comment">-- DT.traceM $ &quot;childrenT (obs): &quot; &lt;&gt; show childrenT</span><span>
</span><span id="line-609"></span><span>    </span><span class="hs-comment">-- observe ornaments of passing edges</span><span>
</span><span id="line-610"></span><span>    </span><span id="local-6989586621679466768"><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679466768"><span class="hs-identifier hs-var">childrenNT</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (InnerEdge SPitch) [(SPitch, PassingOrnament)]
-&gt; (InnerEdge SPitch, Int)
-&gt; PVObs (InnerEdge SPitch, [(SPitch, PassingOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#observeNT"><span class="hs-identifier hs-var">observeNT</span></a></span><span> </span><span class="annot"><span class="annottext">Map (InnerEdge SPitch) [(SPitch, PassingOrnament)]
</span><a href="#local-6989586621679466777"><span class="hs-identifier hs-var">splitNTs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall k. MultiSet k -&gt; [(k, Int)]
</span><a href="Internal.MultiSet.html#toOccurList"><span class="hs-identifier hs-var">MS.toOccurList</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679466781"><span class="hs-identifier hs-var">nts</span></a></span><span>
</span><span id="line-611"></span><span>    </span><span class="hs-comment">-- DT.traceM $ &quot;childrenNT (obs): &quot; &lt;&gt; show childrenNT</span><span>
</span><span id="line-612"></span><span>    </span><span class="hs-comment">-- observe ornaments of left notes</span><span>
</span><span id="line-613"></span><span>    </span><span id="local-6989586621679466766"><span class="annot"><span class="annottext">[(SPitch, [(SPitch, RightOrnament)])]
</span><a href="#local-6989586621679466766"><span class="hs-identifier hs-var">childrenL</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. StartStop a -&gt; Maybe a
</span><a href="Common.html#getInner"><span class="hs-identifier hs-var">getInner</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679466784"><span class="hs-identifier hs-var">sliceL</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-614"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Notes SPitch)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-615"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679466765"><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679466765"><span class="hs-identifier hs-var">notes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map SPitch [(SPitch, RightOrnament)]
-&gt; SPitch -&gt; PVObs (SPitch, [(SPitch, RightOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#observeL"><span class="hs-identifier hs-var">observeL</span></a></span><span> </span><span class="annot"><span class="annottext">Map SPitch [(SPitch, RightOrnament)]
</span><a href="#local-6989586621679466776"><span class="hs-identifier hs-var">fromLeft</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a -&gt; [a]
</span><a href="Internal.MultiSet.html#toList"><span class="hs-identifier hs-var">MS.toList</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679466765"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-616"></span><span>    </span><span class="hs-comment">-- DT.traceM $ &quot;childrenL (obs): &quot; &lt;&gt; show childrenL</span><span>
</span><span id="line-617"></span><span>    </span><span class="hs-comment">-- observe ornaments of right notes</span><span>
</span><span id="line-618"></span><span>    </span><span id="local-6989586621679466763"><span class="annot"><span class="annottext">[(SPitch, [(SPitch, LeftOrnament)])]
</span><a href="#local-6989586621679466763"><span class="hs-identifier hs-var">childrenR</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. StartStop a -&gt; Maybe a
</span><a href="Common.html#getInner"><span class="hs-identifier hs-var">getInner</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679466780"><span class="hs-identifier hs-var">sliceR</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-619"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Notes SPitch)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-620"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679466762"><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679466762"><span class="hs-identifier hs-var">notes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-621"></span><span>        </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map SPitch [(SPitch, LeftOrnament)]
-&gt; SPitch -&gt; PVObs (SPitch, [(SPitch, LeftOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#observeR"><span class="hs-identifier hs-var">observeR</span></a></span><span> </span><span class="annot"><span class="annottext">Map SPitch [(SPitch, LeftOrnament)]
</span><a href="#local-6989586621679466775"><span class="hs-identifier hs-var">fromRight</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a -&gt; [a]
</span><a href="Internal.MultiSet.html#toList"><span class="hs-identifier hs-var">MS.toList</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679466762"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-622"></span><span>    </span><span class="hs-comment">-- DT.traceM $ &quot;childrenR (obs): &quot; &lt;&gt; show childrenR</span><span>
</span><span id="line-623"></span><span>    </span><span class="hs-comment">-- observe new passing edges</span><span>
</span><span id="line-624"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466760"><span class="annot"><span class="annottext">notes :: [SPitch]
</span><a href="#local-6989586621679466760"><span class="hs-identifier hs-var hs-var">notes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall o1 o2 o3.
[(Edge SPitch, [(SPitch, o1)])]
-&gt; [(InnerEdge SPitch, [(SPitch, PassingOrnament)])]
-&gt; [(SPitch, [(SPitch, o2)])]
-&gt; [(SPitch, [(SPitch, o3)])]
-&gt; [SPitch]
</span><a href="PVGrammar.Prob.Simple.html#collectNotes"><span class="hs-identifier hs-var">collectNotes</span></a></span><span> </span><span class="annot"><span class="annottext">[(Edge SPitch, [(SPitch, DoubleOrnament)])]
</span><a href="#local-6989586621679466770"><span class="hs-identifier hs-var">childrenT</span></a></span><span> </span><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679466768"><span class="hs-identifier hs-var">childrenNT</span></a></span><span> </span><span class="annot"><span class="annottext">[(SPitch, [(SPitch, RightOrnament)])]
</span><a href="#local-6989586621679466766"><span class="hs-identifier hs-var">childrenL</span></a></span><span> </span><span class="annot"><span class="annottext">[(SPitch, [(SPitch, LeftOrnament)])]
</span><a href="#local-6989586621679466763"><span class="hs-identifier hs-var">childrenR</span></a></span><span>
</span><span id="line-625"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. StartStop a -&gt; Maybe a
</span><a href="Common.html#getInner"><span class="hs-identifier hs-var">getInner</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679466784"><span class="hs-identifier hs-var">sliceL</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-626"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Notes SPitch)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-627"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679466759"><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679466759"><span class="hs-identifier hs-var">notesl</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-628"></span><span>        </span><span class="annot"><span class="annottext">[SPitch]
-&gt; [SPitch]
-&gt; (forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; MultiSet (InnerEdge SPitch)
-&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observePassing"><span class="hs-identifier hs-var">observePassing</span></a></span><span>
</span><span id="line-629"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a -&gt; [a]
</span><a href="Internal.MultiSet.html#toList"><span class="hs-identifier hs-var">MS.toList</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679466759"><span class="hs-identifier hs-var">notesl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-630"></span><span>          </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679466760"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-631"></span><span>          </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pNewPassingLeft"><span class="hs-identifier hs-var">pNewPassingLeft</span></a></span><span>
</span><span id="line-632"></span><span>          </span><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679466772"><span class="hs-identifier hs-var">passLeft</span></a></span><span>
</span><span id="line-633"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. StartStop a -&gt; Maybe a
</span><a href="Common.html#getInner"><span class="hs-identifier hs-var">getInner</span></a></span><span> </span><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679466780"><span class="hs-identifier hs-var">sliceR</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-634"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Notes SPitch)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-635"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679466755"><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679466755"><span class="hs-identifier hs-var">notesr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-636"></span><span>        </span><span class="annot"><span class="annottext">[SPitch]
-&gt; [SPitch]
-&gt; (forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; MultiSet (InnerEdge SPitch)
-&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observePassing"><span class="hs-identifier hs-var">observePassing</span></a></span><span>
</span><span id="line-637"></span><span>          </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679466760"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-638"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a -&gt; [a]
</span><a href="Internal.MultiSet.html#toList"><span class="hs-identifier hs-var">MS.toList</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679466755"><span class="hs-identifier hs-var">notesr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-639"></span><span>          </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pNewPassingRight"><span class="hs-identifier hs-var">pNewPassingRight</span></a></span><span>
</span><span id="line-640"></span><span>          </span><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679466771"><span class="hs-identifier hs-var">passRight</span></a></span><span>
</span><span id="line-641"></span><span>    </span><span class="hs-comment">-- observe which edges are kept</span><span>
</span><span id="line-642"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (Edge SPitch) [(SPitch, DoubleOrnament)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map (InnerEdge SPitch) [(SPitch, PassingOrnament)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map SPitch [(SPitch, RightOrnament)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map SPitch [(SPitch, LeftOrnament)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466752"><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466752"><span class="hs-identifier hs-var">leftEdges</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466751"><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466751"><span class="hs-identifier hs-var">rightEdges</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-643"></span><span>          </span><span class="annot"><span class="annottext">forall o1 o2 o3.
[(Edge SPitch, [(SPitch, o1)])]
-&gt; [(InnerEdge SPitch, [(SPitch, PassingOrnament)])]
-&gt; [(SPitch, [(SPitch, o2)])]
-&gt; [(SPitch, [(SPitch, o3)])]
-&gt; (Map (Edge SPitch) [(SPitch, o1)],
    Map (InnerEdge SPitch) [(SPitch, PassingOrnament)],
    Map SPitch [(SPitch, o2)], Map SPitch [(SPitch, o3)],
    HashSet (Edge SPitch), HashSet (Edge SPitch))
</span><a href="PVGrammar.Prob.Simple.html#collectElabos"><span class="hs-identifier hs-var">collectElabos</span></a></span><span> </span><span class="annot"><span class="annottext">[(Edge SPitch, [(SPitch, DoubleOrnament)])]
</span><a href="#local-6989586621679466770"><span class="hs-identifier hs-var">childrenT</span></a></span><span> </span><span class="annot"><span class="annottext">[(InnerEdge SPitch, [(SPitch, PassingOrnament)])]
</span><a href="#local-6989586621679466768"><span class="hs-identifier hs-var">childrenNT</span></a></span><span> </span><span class="annot"><span class="annottext">[(SPitch, [(SPitch, RightOrnament)])]
</span><a href="#local-6989586621679466766"><span class="hs-identifier hs-var">childrenL</span></a></span><span> </span><span class="annot"><span class="annottext">[(SPitch, [(SPitch, LeftOrnament)])]
</span><a href="#local-6989586621679466763"><span class="hs-identifier hs-var">childrenR</span></a></span><span>
</span><span id="line-644"></span><span>    </span><span class="annot"><span class="annottext">forall e.
(Eq e, Hashable e, Ord e) =&gt;
(forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; HashSet e -&gt; HashSet e -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeKeepEdges"><span class="hs-identifier hs-var">observeKeepEdges</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pKeepL"><span class="hs-identifier hs-var">pKeepL</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466752"><span class="hs-identifier hs-var">leftEdges</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466774"><span class="hs-identifier hs-var">keepLeft</span></a></span><span>
</span><span id="line-645"></span><span>    </span><span class="annot"><span class="annottext">forall e.
(Eq e, Hashable e, Ord e) =&gt;
(forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; HashSet e -&gt; HashSet e -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeKeepEdges"><span class="hs-identifier hs-var">observeKeepEdges</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pKeepR"><span class="hs-identifier hs-var">pKeepR</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466751"><span class="hs-identifier hs-var">rightEdges</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679466773"><span class="hs-identifier hs-var">keepRight</span></a></span><span>
</span><span id="line-646"></span><span>
</span><span id="line-647"></span><span id="local-6989586621679466745"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleRootNote"><span class="hs-identifier hs-type">sampleRootNote</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679466745"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span></span><span>
</span><span id="line-648"></span><span id="sampleRootNote"><span class="annot"><span class="annottext">sampleRootNote :: m SPitch
</span><a href="PVGrammar.Prob.Simple.html#sampleRootNote"><span class="hs-identifier hs-var hs-var">sampleRootNote</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-649"></span><span>  </span><span id="local-6989586621679466708"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466708"><span class="hs-identifier hs-var">fifthsSign</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) d.
(RandomInterpreter m r, Distribution d, SampleCtx m d) =&gt;
String -&gt; d -&gt; Params d -&gt; m (Support d)
</span><span class="hs-identifier hs-var">sampleConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rootFifthsSign&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.5</span></span><span>
</span><span id="line-650"></span><span>  </span><span id="local-6989586621679466706"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466706"><span class="hs-identifier hs-var">fifthsN</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rootFifthsN&quot;</span></span><span> </span><span class="annot"><span class="annottext">Geometric0
</span><span class="hs-identifier hs-var">Geometric0</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pRootFifths"><span class="hs-identifier hs-var">pRootFifths</span></a></span><span>
</span><span id="line-651"></span><span>  </span><span id="local-6989586621679466701"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466701"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) d.
(RandomInterpreter m r, Distribution d, SampleCtx m d) =&gt;
String -&gt; d -&gt; Params d -&gt; m (Support d)
</span><span class="hs-identifier hs-var">sampleConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rootOctave&quot;</span></span><span> </span><span class="annot"><span class="annottext">MagicalOctaves
</span><a href="PVGrammar.Prob.Simple.html#MagicalOctaves"><span class="hs-identifier hs-var">MagicalOctaves</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-652"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466700"><span class="annot"><span class="annottext">fs :: Int
</span><a href="#local-6989586621679466700"><span class="hs-identifier hs-var hs-var">fs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466708"><span class="hs-identifier hs-var">fifthsSign</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466706"><span class="hs-identifier hs-var">fifthsN</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">negate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466706"><span class="hs-identifier hs-var">fifthsN</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-653"></span><span>      </span><span id="local-6989586621679466698"><span class="annot"><span class="annottext">p :: SPitch
</span><a href="#local-6989586621679466698"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall i. IntervalClass i =&gt; i -&gt; IOf i
</span><span class="hs-identifier hs-var">emb</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Pitch SIC
</span><span class="hs-identifier hs-var">spc</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466700"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall {a}. AdditiveGroup a =&gt; Pitch a -&gt; a -&gt; Pitch a
</span><span class="hs-operator hs-var">+^</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i
</span><span class="hs-identifier hs-var">octave</span></span><span> </span><span class="annot"><span class="annottext">forall v s. (VectorSpace v, s ~ Scalar v) =&gt; v -&gt; s -&gt; v
</span><span class="hs-operator hs-var">^*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466701"><span class="hs-identifier hs-var">os</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-654"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;root note (sample): &quot; &lt;&gt; show p</span><span>
</span><span id="line-655"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466698"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-656"></span><span>
</span><span id="line-657"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeRootNote"><span class="hs-identifier hs-type">observeRootNote</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-658"></span><span id="observeRootNote"><span class="annot"><span class="annottext">observeRootNote :: SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeRootNote"><span class="hs-identifier hs-var hs-var">observeRootNote</span></a></span></span><span> </span><span id="local-6989586621679466691"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466691"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-659"></span><span>  </span><span class="annot"><span class="annottext">forall d (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Distribution d, Typeable (Support d), Monad m) =&gt;
String -&gt; d -&gt; Params d -&gt; Support d -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rootFifthsSign&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.5</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466689"><span class="hs-identifier hs-var">fifthsSign</span></a></span><span>
</span><span id="line-660"></span><span>  </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rootFifthsN&quot;</span></span><span> </span><span class="annot"><span class="annottext">Geometric0
</span><span class="hs-identifier hs-var">Geometric0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pRootFifths"><span class="hs-identifier hs-var">pRootFifths</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466685"><span class="hs-identifier hs-var">fifthsN</span></a></span><span>
</span><span id="line-661"></span><span>  </span><span class="annot"><span class="annottext">forall d (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Distribution d, Typeable (Support d), Monad m) =&gt;
String -&gt; d -&gt; Params d -&gt; Support d -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;rootOctave&quot;</span></span><span> </span><span class="annot"><span class="annottext">MagicalOctaves
</span><a href="PVGrammar.Prob.Simple.html#MagicalOctaves"><span class="hs-identifier hs-var">MagicalOctaves</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">octaves</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466691"><span class="hs-identifier hs-var">child</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span class="hs-special">)</span><span>
</span><span id="line-662"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-663"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;root note (obs): &quot; &lt;&gt; show child</span><span>
</span><span id="line-664"></span><span>
</span><span id="line-665"></span><span>  </span><span id="local-6989586621679466683"><span class="annot"><span class="annottext">fs :: Int
</span><a href="#local-6989586621679466683"><span class="hs-identifier hs-var hs-var">fs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">fifths</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466691"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-666"></span><span>  </span><span id="local-6989586621679466689"><span class="annot"><span class="annottext">fifthsSign :: Bool
</span><a href="#local-6989586621679466689"><span class="hs-identifier hs-var hs-var">fifthsSign</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466683"><span class="hs-identifier hs-var">fs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-667"></span><span>  </span><span id="local-6989586621679466685"><span class="annot"><span class="annottext">fifthsN :: Int
</span><a href="#local-6989586621679466685"><span class="hs-identifier hs-var hs-var">fifthsN</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466689"><span class="hs-identifier hs-var">fifthsSign</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466683"><span class="hs-identifier hs-var">fs</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">negate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466683"><span class="hs-identifier hs-var">fs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-668"></span><span>
</span><span id="line-669"></span><span id="local-6989586621679466681"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleOctaveShift"><span class="hs-identifier hs-type">sampleOctaveShift</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679466681"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SInterval</span></span></span><span>
</span><span id="line-670"></span><span id="sampleOctaveShift"><span class="annot"><span class="annottext">sampleOctaveShift :: String -&gt; m SInterval
</span><a href="PVGrammar.Prob.Simple.html#sampleOctaveShift"><span class="hs-identifier hs-var hs-var">sampleOctaveShift</span></a></span></span><span> </span><span id="local-6989586621679466664"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679466664"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-671"></span><span>  </span><span id="local-6989586621679466663"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466663"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) d.
(RandomInterpreter m r, Distribution d, SampleCtx m d) =&gt;
String -&gt; d -&gt; Params d -&gt; m (Support d)
</span><span class="hs-identifier hs-var">sampleConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679466664"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">MagicalOctaves
</span><a href="PVGrammar.Prob.Simple.html#MagicalOctaves"><span class="hs-identifier hs-var">MagicalOctaves</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-672"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466662"><span class="annot"><span class="annottext">os :: SInterval
</span><a href="#local-6989586621679466662"><span class="hs-identifier hs-var hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i
</span><span class="hs-identifier hs-var">octave</span></span><span> </span><span class="annot"><span class="annottext">forall v s. (VectorSpace v, s ~ Scalar v) =&gt; v -&gt; s -&gt; v
</span><span class="hs-operator hs-var">^*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466663"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span class="hs-special">)</span><span>
</span><span id="line-673"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;octave shift (smp) &quot; &lt;&gt; show os</span><span>
</span><span id="line-674"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466662"><span class="hs-identifier hs-var">os</span></a></span><span>
</span><span id="line-675"></span><span>
</span><span id="line-676"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeOctaveShift"><span class="hs-identifier hs-type">observeOctaveShift</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SInterval</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-677"></span><span id="observeOctaveShift"><span class="annot"><span class="annottext">observeOctaveShift :: String -&gt; SInterval -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeOctaveShift"><span class="hs-identifier hs-var hs-var">observeOctaveShift</span></a></span></span><span> </span><span id="local-6989586621679466651"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679466651"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679466650"><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466650"><span class="hs-identifier hs-var">interval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-678"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466649"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621679466649"><span class="hs-identifier hs-var hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">octaves</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466650"><span class="hs-identifier hs-var">interval</span></a></span><span> </span><span class="annot"><span class="annottext">forall v. AdditiveGroup v =&gt; v -&gt; v -&gt; v
</span><span class="hs-operator hs-var">^+^</span></span><span> </span><span class="annot"><span class="annottext">forall i. Interval i =&gt; ImperfectInterval i -&gt; i
</span><span class="hs-identifier hs-var">major</span></span><span> </span><span class="annot"><span class="annottext">ImperfectInterval SInterval
</span><span class="hs-identifier hs-var">second</span></span><span class="hs-special">)</span><span>
</span><span id="line-679"></span><span>  </span><span class="annot"><span class="annottext">forall d (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Distribution d, Typeable (Support d), Monad m) =&gt;
String -&gt; d -&gt; Params d -&gt; Support d -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679466651"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">MagicalOctaves
</span><a href="PVGrammar.Prob.Simple.html#MagicalOctaves"><span class="hs-identifier hs-var">MagicalOctaves</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466649"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span>
</span><span id="line-680"></span><span>
</span><span id="line-681"></span><span class="hs-comment">-- DT.traceM $ &quot;octave shift (obs) &quot; &lt;&gt; show (octave @SInterval ^* n)</span><span>
</span><span id="line-682"></span><span>
</span><span id="line-683"></span><span id="local-6989586621679466645"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleNeighbor"><span class="hs-identifier hs-type">sampleNeighbor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679466645"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span></span><span>
</span><span id="line-684"></span><span id="sampleNeighbor"><span class="annot"><span class="annottext">sampleNeighbor :: Bool -&gt; SPitch -&gt; m SPitch
</span><a href="PVGrammar.Prob.Simple.html#sampleNeighbor"><span class="hs-identifier hs-var hs-var">sampleNeighbor</span></a></span></span><span> </span><span id="local-6989586621679466602"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466602"><span class="hs-identifier hs-var">stepUp</span></a></span></span><span> </span><span id="local-6989586621679466601"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466601"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-685"></span><span>  </span><span id="local-6989586621679466600"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466600"><span class="hs-identifier hs-var">chromatic</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nbChromatic&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pNBChromatic"><span class="hs-identifier hs-var">pNBChromatic</span></a></span><span>
</span><span id="line-686"></span><span>  </span><span id="local-6989586621679466596"><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466596"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) {r :: (* -&gt; *) -&gt; *}.
(SampleCtx m MagicalOctaves, RandomInterpreter m r) =&gt;
String -&gt; m SInterval
</span><a href="PVGrammar.Prob.Simple.html#sampleOctaveShift"><span class="hs-identifier hs-var">sampleOctaveShift</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nbOctShift&quot;</span></span><span>
</span><span id="line-687"></span><span>  </span><span id="local-6989586621679466595"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466595"><span class="hs-identifier hs-var">alt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nbAlt&quot;</span></span><span> </span><span class="annot"><span class="annottext">Geometric0
</span><span class="hs-identifier hs-var">Geometric0</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pNBAlt"><span class="hs-identifier hs-var">pNBAlt</span></a></span><span>
</span><span id="line-688"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466591"><span class="annot"><span class="annottext">altInterval :: IOf SIC
</span><a href="#local-6989586621679466591"><span class="hs-identifier hs-var hs-var">altInterval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall i. IntervalClass i =&gt; i -&gt; IOf i
</span><span class="hs-identifier hs-var">emb</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466595"><span class="hs-identifier hs-var">alt</span></a></span><span> </span><span class="annot"><span class="annottext">forall v. VectorSpace v =&gt; Scalar v -&gt; v -&gt; v
</span><span class="hs-operator hs-var">*^</span></span><span> </span><span class="annot"><span class="annottext">forall i. Chromatic i =&gt; i
</span><span class="hs-identifier hs-var">chromaticSemitone</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">SIC</span></span><span class="hs-special">)</span><span>
</span><span id="line-689"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466600"><span class="hs-identifier hs-var">chromatic</span></a></span><span>
</span><span id="line-690"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-691"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466601"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. AdditiveGroup a =&gt; Pitch a -&gt; a -&gt; Pitch a
</span><span class="hs-operator hs-var">+^</span></span><span> </span><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466596"><span class="hs-identifier hs-var">os</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. AdditiveGroup a =&gt; Pitch a -&gt; a -&gt; Pitch a
</span><span class="hs-operator hs-var">+^</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466602"><span class="hs-identifier hs-var">stepUp</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">IOf SIC
</span><a href="#local-6989586621679466591"><span class="hs-identifier hs-var">altInterval</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i -&gt; i
</span><span class="hs-identifier hs-var">down</span></span><span> </span><span class="annot"><span class="annottext">IOf SIC
</span><a href="#local-6989586621679466591"><span class="hs-identifier hs-var">altInterval</span></a></span><span>
</span><span id="line-692"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-693"></span><span>      </span><span id="local-6989586621679466587"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466587"><span class="hs-identifier hs-var">altUp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) d.
(RandomInterpreter m r, Distribution d, SampleCtx m d) =&gt;
String -&gt; d -&gt; Params d -&gt; m (Support d)
</span><span class="hs-identifier hs-var">sampleConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nbAltUp&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.5</span></span><span>
</span><span id="line-694"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466586"><span class="annot"><span class="annottext">step :: SInterval
</span><a href="#local-6989586621679466586"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-695"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466587"><span class="hs-identifier hs-var">altUp</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466602"><span class="hs-identifier hs-var">stepUp</span></a></span><span>
</span><span id="line-696"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall i. Interval i =&gt; ImperfectInterval i -&gt; i
</span><span class="hs-identifier hs-var">major</span></span><span> </span><span class="annot"><span class="annottext">ImperfectInterval SInterval
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">forall v. AdditiveGroup v =&gt; v -&gt; v -&gt; v
</span><span class="hs-operator hs-var">^+^</span></span><span> </span><span class="annot"><span class="annottext">IOf SIC
</span><a href="#local-6989586621679466591"><span class="hs-identifier hs-var">altInterval</span></a></span><span>
</span><span id="line-697"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall i. Chromatic i =&gt; ImperfectInterval i -&gt; i
</span><span class="hs-identifier hs-var">minor</span></span><span> </span><span class="annot"><span class="annottext">ImperfectInterval SInterval
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">forall v. AdditiveGroup v =&gt; v -&gt; v -&gt; v
</span><span class="hs-operator hs-var">^-^</span></span><span> </span><span class="annot"><span class="annottext">IOf SIC
</span><a href="#local-6989586621679466591"><span class="hs-identifier hs-var">altInterval</span></a></span><span>
</span><span id="line-698"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466601"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. AdditiveGroup a =&gt; Pitch a -&gt; a -&gt; Pitch a
</span><span class="hs-operator hs-var">+^</span></span><span> </span><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466596"><span class="hs-identifier hs-var">os</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. AdditiveGroup a =&gt; Pitch a -&gt; a -&gt; Pitch a
</span><span class="hs-operator hs-var">+^</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466602"><span class="hs-identifier hs-var">stepUp</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466586"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i -&gt; i
</span><span class="hs-identifier hs-var">down</span></span><span> </span><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466586"><span class="hs-identifier hs-var">step</span></a></span><span>
</span><span id="line-699"></span><span>
</span><span id="line-700"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeNeighbor"><span class="hs-identifier hs-type">observeNeighbor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-701"></span><span id="observeNeighbor"><span class="annot"><span class="annottext">observeNeighbor :: Bool -&gt; SPitch -&gt; SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeNeighbor"><span class="hs-identifier hs-var hs-var">observeNeighbor</span></a></span></span><span> </span><span id="local-6989586621679466582"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466582"><span class="hs-identifier hs-var">goesUp</span></a></span></span><span> </span><span id="local-6989586621679466581"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466581"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span id="local-6989586621679466580"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466580"><span class="hs-identifier hs-var">nb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-702"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466579"><span class="annot"><span class="annottext">interval :: ICOf SInterval
</span><a href="#local-6989586621679466579"><span class="hs-identifier hs-var hs-var">interval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i -&gt; ICOf i
</span><span class="hs-identifier hs-var">ic</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466581"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466580"><span class="hs-identifier hs-var">nb</span></a></span><span>
</span><span id="line-703"></span><span>      </span><span id="local-6989586621679466576"><span class="annot"><span class="annottext">isChromatic :: Bool
</span><a href="#local-6989586621679466576"><span class="hs-identifier hs-var hs-var">isChromatic</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">diasteps</span></span><span> </span><span class="annot"><span class="annottext">ICOf SInterval
</span><a href="#local-6989586621679466579"><span class="hs-identifier hs-var">interval</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-704"></span><span>  </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nbChromatic&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pNBChromatic"><span class="hs-identifier hs-var">pNBChromatic</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466576"><span class="hs-identifier hs-var">isChromatic</span></a></span><span>
</span><span id="line-705"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; SInterval -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeOctaveShift"><span class="hs-identifier hs-var">observeOctaveShift</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nbOctShift&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466581"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466580"><span class="hs-identifier hs-var">nb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-706"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466576"><span class="hs-identifier hs-var">isChromatic</span></a></span><span>
</span><span id="line-707"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-708"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466571"><span class="annot"><span class="annottext">alt :: Int
</span><a href="#local-6989586621679466571"><span class="hs-identifier hs-var hs-var">alt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">abs</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">alteration</span></span><span> </span><span class="annot"><span class="annottext">ICOf SInterval
</span><a href="#local-6989586621679466579"><span class="hs-identifier hs-var">interval</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-709"></span><span>      </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nbAlt&quot;</span></span><span> </span><span class="annot"><span class="annottext">Geometric0
</span><span class="hs-identifier hs-var">Geometric0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pNBAlt"><span class="hs-identifier hs-var">pNBAlt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466571"><span class="hs-identifier hs-var">alt</span></a></span><span>
</span><span id="line-710"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-711"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466565"><span class="annot"><span class="annottext">alt :: Int
</span><a href="#local-6989586621679466565"><span class="hs-identifier hs-var hs-var">alt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">alteration</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i -&gt; i
</span><span class="hs-identifier hs-var">iabs</span></span><span> </span><span class="annot"><span class="annottext">ICOf SInterval
</span><a href="#local-6989586621679466579"><span class="hs-identifier hs-var">interval</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-712"></span><span>          </span><span id="local-6989586621679466563"><span class="annot"><span class="annottext">altUp :: Bool
</span><a href="#local-6989586621679466563"><span class="hs-identifier hs-var hs-var">altUp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466565"><span class="hs-identifier hs-var">alt</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466582"><span class="hs-identifier hs-var">goesUp</span></a></span><span>
</span><span id="line-713"></span><span>          </span><span id="local-6989586621679466562"><span class="annot"><span class="annottext">altN :: Int
</span><a href="#local-6989586621679466562"><span class="hs-identifier hs-var hs-var">altN</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466565"><span class="hs-identifier hs-var">alt</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466565"><span class="hs-identifier hs-var">alt</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466565"><span class="hs-identifier hs-var">alt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-714"></span><span>      </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nbAlt&quot;</span></span><span> </span><span class="annot"><span class="annottext">Geometric0
</span><span class="hs-identifier hs-var">Geometric0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pNBAlt"><span class="hs-identifier hs-var">pNBAlt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466562"><span class="hs-identifier hs-var">altN</span></a></span><span>
</span><span id="line-715"></span><span>      </span><span class="annot"><span class="annottext">forall d (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Distribution d, Typeable (Support d), Monad m) =&gt;
String -&gt; d -&gt; Params d -&gt; Support d -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nbAltUp&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.5</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466563"><span class="hs-identifier hs-var">altUp</span></a></span><span>
</span><span id="line-716"></span><span>
</span><span id="line-717"></span><span id="local-6989586621679466558"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleDoubleChild"><span class="hs-identifier hs-type">sampleDoubleChild</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679466558"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#DoubleOrnament"><span class="hs-identifier hs-type">DoubleOrnament</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-718"></span><span id="sampleDoubleChild"><span class="annot"><span class="annottext">sampleDoubleChild :: SPitch -&gt; SPitch -&gt; m (SPitch, DoubleOrnament)
</span><a href="PVGrammar.Prob.Simple.html#sampleDoubleChild"><span class="hs-identifier hs-var hs-var">sampleDoubleChild</span></a></span></span><span> </span><span id="local-6989586621679466488"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466488"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span id="local-6989586621679466487"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466487"><span class="hs-identifier hs-var">pr</span></a></span></span><span>
</span><span id="line-719"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466488"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466487"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-720"></span><span>      </span><span id="local-6989586621679466485"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466485"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-721"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatOverNeighbor&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatOverNeighbor"><span class="hs-identifier hs-var">pRepeatOverNeighbor</span></a></span><span>
</span><span id="line-722"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466485"><span class="hs-identifier hs-var">rep</span></a></span><span>
</span><span id="line-723"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-724"></span><span>          </span><span id="local-6989586621679466481"><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466481"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) {r :: (* -&gt; *) -&gt; *}.
(SampleCtx m MagicalOctaves, RandomInterpreter m r) =&gt;
String -&gt; m SInterval
</span><a href="PVGrammar.Prob.Simple.html#sampleOctaveShift"><span class="hs-identifier hs-var">sampleOctaveShift</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;doubleChildOctave&quot;</span></span><span>
</span><span id="line-725"></span><span>          </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466488"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. AdditiveGroup a =&gt; Pitch a -&gt; a -&gt; Pitch a
</span><span class="hs-operator hs-var">+^</span></span><span> </span><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466481"><span class="hs-identifier hs-var">os</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DoubleOrnament
</span><a href="PVGrammar.html#FullRepeat"><span class="hs-identifier hs-var">FullRepeat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-726"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-727"></span><span>          </span><span id="local-6989586621679466479"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466479"><span class="hs-identifier hs-var">stepUp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) d.
(RandomInterpreter m r, Distribution d, SampleCtx m d) =&gt;
String -&gt; d -&gt; Params d -&gt; m (Support d)
</span><span class="hs-identifier hs-var">sampleConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;stepUp&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.5</span></span><span>
</span><span id="line-728"></span><span>          </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="annot"><span class="annottext">DoubleOrnament
</span><a href="PVGrammar.html#FullNeighbor"><span class="hs-identifier hs-var">FullNeighbor</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m MagicalOctaves,
 SampleCtx m Geometric0, RandomInterpreter m PVParams) =&gt;
Bool -&gt; SPitch -&gt; m SPitch
</span><a href="PVGrammar.Prob.Simple.html#sampleNeighbor"><span class="hs-identifier hs-var">sampleNeighbor</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466479"><span class="hs-identifier hs-var">stepUp</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466488"><span class="hs-identifier hs-var">pl</span></a></span><span>
</span><span id="line-729"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-730"></span><span>      </span><span id="local-6989586621679466477"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466477"><span class="hs-identifier hs-var">repeatLeft</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-731"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatLeftOverRight&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-732"></span><span>          </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span>
</span><span id="line-733"></span><span>            </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatLeftOverRight"><span class="hs-identifier hs-var">pRepeatLeftOverRight</span></a></span><span>
</span><span id="line-734"></span><span>      </span><span id="local-6989586621679466473"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466473"><span class="hs-identifier hs-var">repeatAlter</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatAlter&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatAlter"><span class="hs-identifier hs-var">pRepeatAlter</span></a></span><span>
</span><span id="line-735"></span><span>      </span><span id="local-6989586621679466469"><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466469"><span class="hs-identifier hs-var">alt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-736"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466473"><span class="hs-identifier hs-var">repeatAlter</span></a></span><span>
</span><span id="line-737"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-738"></span><span>            </span><span id="local-6989586621679466468"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466468"><span class="hs-identifier hs-var">alterUp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-739"></span><span>              </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatAlterUp&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatAlterUp"><span class="hs-identifier hs-var">pRepeatAlterUp</span></a></span><span>
</span><span id="line-740"></span><span>            </span><span id="local-6989586621679466464"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466464"><span class="hs-identifier hs-var">semis</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-741"></span><span>              </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatAlterSemis&quot;</span></span><span> </span><span class="annot"><span class="annottext">Geometric1
</span><span class="hs-identifier hs-var">Geometric1</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatAlterSemis"><span class="hs-identifier hs-var">pRepeatAlterSemis</span></a></span><span>
</span><span id="line-742"></span><span>            </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466468"><span class="hs-identifier hs-var">alterUp</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i -&gt; i
</span><span class="hs-identifier hs-var">down</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall i. Chromatic i =&gt; i
</span><span class="hs-identifier hs-var">chromaticSemitone</span></span><span> </span><span class="annot"><span class="annottext">forall v s. (VectorSpace v, s ~ Scalar v) =&gt; v -&gt; s -&gt; v
</span><span class="hs-operator hs-var">^*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466464"><span class="hs-identifier hs-var">semis</span></a></span><span>
</span><span id="line-743"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i
</span><span class="hs-identifier hs-var">unison</span></span><span>
</span><span id="line-744"></span><span>      </span><span id="local-6989586621679466457"><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466457"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) {r :: (* -&gt; *) -&gt; *}.
(SampleCtx m MagicalOctaves, RandomInterpreter m r) =&gt;
String -&gt; m SInterval
</span><a href="PVGrammar.Prob.Simple.html#sampleOctaveShift"><span class="hs-identifier hs-var">sampleOctaveShift</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;doubleChildOctave&quot;</span></span><span>
</span><span id="line-745"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466477"><span class="hs-identifier hs-var">repeatLeft</span></a></span><span>
</span><span id="line-746"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466488"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. AdditiveGroup a =&gt; Pitch a -&gt; a -&gt; Pitch a
</span><span class="hs-operator hs-var">+^</span></span><span> </span><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466457"><span class="hs-identifier hs-var">os</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. AdditiveGroup a =&gt; Pitch a -&gt; a -&gt; Pitch a
</span><span class="hs-operator hs-var">+^</span></span><span> </span><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466469"><span class="hs-identifier hs-var">alt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DoubleOrnament
</span><a href="PVGrammar.html#RightRepeatOfLeft"><span class="hs-identifier hs-var">RightRepeatOfLeft</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-747"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466487"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. AdditiveGroup a =&gt; Pitch a -&gt; a -&gt; Pitch a
</span><span class="hs-operator hs-var">+^</span></span><span> </span><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466457"><span class="hs-identifier hs-var">os</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. AdditiveGroup a =&gt; Pitch a -&gt; a -&gt; Pitch a
</span><span class="hs-operator hs-var">+^</span></span><span> </span><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466469"><span class="hs-identifier hs-var">alt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DoubleOrnament
</span><a href="PVGrammar.html#LeftRepeatOfRight"><span class="hs-identifier hs-var">LeftRepeatOfRight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-748"></span><span>
</span><span id="line-749"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeDoubleChild"><span class="hs-identifier hs-type">observeDoubleChild</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-750"></span><span id="observeDoubleChild"><span class="annot"><span class="annottext">observeDoubleChild :: SPitch -&gt; SPitch -&gt; SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeDoubleChild"><span class="hs-identifier hs-var hs-var">observeDoubleChild</span></a></span></span><span> </span><span id="local-6989586621679466453"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466453"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span id="local-6989586621679466452"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466452"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span id="local-6989586621679466451"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466451"><span class="hs-identifier hs-var">child</span></a></span></span><span>
</span><span id="line-751"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466453"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466452"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-752"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466450"><span class="annot"><span class="annottext">isRep :: Bool
</span><a href="#local-6989586621679466450"><span class="hs-identifier hs-var hs-var">isRep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466451"><span class="hs-identifier hs-var">child</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466453"><span class="hs-identifier hs-var">pl</span></a></span><span>
</span><span id="line-753"></span><span>      </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-754"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;RepeatOverNeighbor&quot;</span></span><span>
</span><span id="line-755"></span><span>        </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-756"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatOverNeighbor"><span class="hs-identifier hs-var">pRepeatOverNeighbor</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-757"></span><span>        </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466450"><span class="hs-identifier hs-var">isRep</span></a></span><span>
</span><span id="line-758"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466450"><span class="hs-identifier hs-var">isRep</span></a></span><span>
</span><span id="line-759"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-760"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; SInterval -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeOctaveShift"><span class="hs-identifier hs-var">observeOctaveShift</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;doubleChildOctave&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466453"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466451"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-761"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-762"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466445"><span class="annot"><span class="annottext">dir :: Ordering
</span><a href="#local-6989586621679466445"><span class="hs-identifier hs-var hs-var">dir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i -&gt; Ordering
</span><span class="hs-identifier hs-var">direction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466453"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466451"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-763"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466443"><span class="annot"><span class="annottext">goesUp :: Bool
</span><a href="#local-6989586621679466443"><span class="hs-identifier hs-var hs-var">goesUp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ordering
</span><a href="#local-6989586621679466445"><span class="hs-identifier hs-var">dir</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span>
</span><span id="line-764"></span><span>          </span><span class="annot"><span class="annottext">forall d (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Distribution d, Typeable (Support d), Monad m) =&gt;
String -&gt; d -&gt; Params d -&gt; Support d -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;stepUp&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.5</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466443"><span class="hs-identifier hs-var">goesUp</span></a></span><span>
</span><span id="line-765"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; SPitch -&gt; SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeNeighbor"><span class="hs-identifier hs-var">observeNeighbor</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466443"><span class="hs-identifier hs-var">goesUp</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466453"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466451"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-766"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-767"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466442"><span class="annot"><span class="annottext">repeatLeft :: Bool
</span><a href="#local-6989586621679466442"><span class="hs-identifier hs-var hs-var">repeatLeft</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466453"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466451"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-768"></span><span>          </span><span id="local-6989586621679466441"><span class="annot"><span class="annottext">ref :: SPitch
</span><a href="#local-6989586621679466441"><span class="hs-identifier hs-var hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466442"><span class="hs-identifier hs-var">repeatLeft</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466453"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466452"><span class="hs-identifier hs-var">pr</span></a></span><span>
</span><span id="line-769"></span><span>          </span><span id="local-6989586621679466440"><span class="annot"><span class="annottext">alt :: Int
</span><a href="#local-6989586621679466440"><span class="hs-identifier hs-var hs-var">alt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">alteration</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466451"><span class="hs-identifier hs-var">child</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">alteration</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466441"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-770"></span><span>      </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-771"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatLeftOverRight&quot;</span></span><span>
</span><span id="line-772"></span><span>        </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-773"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatLeftOverRight"><span class="hs-identifier hs-var">pRepeatLeftOverRight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-774"></span><span>        </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466442"><span class="hs-identifier hs-var">repeatLeft</span></a></span><span>
</span><span id="line-775"></span><span>      </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatAlter&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatAlter"><span class="hs-identifier hs-var">pRepeatAlter</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466440"><span class="hs-identifier hs-var">alt</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-776"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466440"><span class="hs-identifier hs-var">alt</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-777"></span><span>        </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatAlterUp&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatAlterUp"><span class="hs-identifier hs-var">pRepeatAlterUp</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466440"><span class="hs-identifier hs-var">alt</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-778"></span><span>        </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-779"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatAlterSemis&quot;</span></span><span>
</span><span id="line-780"></span><span>          </span><span class="annot"><span class="annottext">Geometric1
</span><span class="hs-identifier hs-var">Geometric1</span></span><span>
</span><span id="line-781"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatAlterSemis"><span class="hs-identifier hs-var">pRepeatAlterSemis</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-782"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">abs</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466440"><span class="hs-identifier hs-var">alt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-783"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; SInterval -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeOctaveShift"><span class="hs-identifier hs-var">observeOctaveShift</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;doubleChildOctave&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466441"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466451"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-784"></span><span>
</span><span id="line-785"></span><span id="local-6989586621679466426"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleT"><span class="hs-identifier hs-type">sampleT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679466426"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#DoubleOrnament"><span class="hs-identifier hs-type">DoubleOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-786"></span><span id="sampleT"><span class="annot"><span class="annottext">sampleT :: Edge SPitch -&gt; m (Edge SPitch, [(SPitch, DoubleOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#sampleT"><span class="hs-identifier hs-var hs-var">sampleT</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679466390"><span class="annot"><span class="annottext">StartStop SPitch
</span><a href="#local-6989586621679466390"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466389"><span class="annot"><span class="annottext">StartStop SPitch
</span><a href="#local-6989586621679466389"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-787"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;elaborating T (smp): &quot; &lt;&gt; show (l, r)</span><span>
</span><span id="line-788"></span><span>  </span><span id="local-6989586621679466388"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466388"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;elaborateRegular&quot;</span></span><span> </span><span class="annot"><span class="annottext">Geometric1
</span><span class="hs-identifier hs-var">Geometric1</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pElaborateRegular"><span class="hs-identifier hs-var">pElaborateRegular</span></a></span><span>
</span><span id="line-789"></span><span>  </span><span id="local-6989586621679466384"><span class="annot"><span class="annottext">[Maybe (SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679466384"><span class="hs-identifier hs-var">children</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) a.
(RandomInterpreter m r, Ord a) =&gt;
Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">permutationPlate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466388"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop SPitch
</span><a href="#local-6989586621679466390"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop SPitch
</span><a href="#local-6989586621679466389"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-790"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop SPitch
</span><a href="Common.html#Start"><span class="hs-identifier hs-var">Start</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop SPitch
</span><a href="Common.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-791"></span><span>      </span><span id="local-6989586621679466382"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466382"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m Geometric0,
 SampleCtx m MagicalOctaves, RandomInterpreter m PVParams) =&gt;
m SPitch
</span><a href="PVGrammar.Prob.Simple.html#sampleRootNote"><span class="hs-identifier hs-var">sampleRootNote</span></a></span><span>
</span><span id="line-792"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466382"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DoubleOrnament
</span><a href="PVGrammar.html#RootNote"><span class="hs-identifier hs-var">RootNote</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-793"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span id="local-6989586621679466380"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466380"><span class="hs-identifier hs-var">pl</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span id="local-6989586621679466379"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466379"><span class="hs-identifier hs-var">pr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-794"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679466378"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466378"><span class="hs-identifier hs-var">child</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466377"><span class="annot"><span class="annottext">DoubleOrnament
</span><a href="#local-6989586621679466377"><span class="hs-identifier hs-var">orn</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m MagicalOctaves,
 SampleCtx m Geometric0, SampleCtx m Geometric1,
 RandomInterpreter m PVParams) =&gt;
SPitch -&gt; SPitch -&gt; m (SPitch, DoubleOrnament)
</span><a href="PVGrammar.Prob.Simple.html#sampleDoubleChild"><span class="hs-identifier hs-var">sampleDoubleChild</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466380"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466379"><span class="hs-identifier hs-var">pr</span></a></span><span>
</span><span id="line-795"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466378"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DoubleOrnament
</span><a href="#local-6989586621679466377"><span class="hs-identifier hs-var">orn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-796"></span><span>    </span><span class="annot"><span class="annottext">Edge SPitch
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-797"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop SPitch
</span><a href="#local-6989586621679466390"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop SPitch
</span><a href="#local-6989586621679466389"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679466384"><span class="hs-identifier hs-var">children</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-798"></span><span>
</span><span id="line-799"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeT"><span class="hs-identifier hs-type">observeT</span></a></span><span>
</span><span id="line-800"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#DoubleOrnament"><span class="hs-identifier hs-type">DoubleOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-801"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-802"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#DoubleOrnament"><span class="hs-identifier hs-type">DoubleOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-803"></span><span id="observeT"><span class="annot"><span class="annottext">observeT :: Map (Edge SPitch) [(SPitch, DoubleOrnament)]
-&gt; Edge SPitch -&gt; PVObs (Edge SPitch, [(SPitch, DoubleOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#observeT"><span class="hs-identifier hs-var hs-var">observeT</span></a></span></span><span> </span><span id="local-6989586621679466376"><span class="annot"><span class="annottext">Map (Edge SPitch) [(SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679466376"><span class="hs-identifier hs-var">splitTs</span></a></span></span><span> </span><span id="local-6989586621679466375"><span class="annot"><span class="annottext">Edge SPitch
</span><a href="#local-6989586621679466375"><span class="hs-identifier hs-var">parents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-804"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;elaborating T (obs): &quot; &lt;&gt; show parents</span><span>
</span><span id="line-805"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466374"><span class="annot"><span class="annottext">children :: [(SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679466374"><span class="hs-identifier hs-var hs-var">children</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">Edge SPitch
</span><a href="#local-6989586621679466375"><span class="hs-identifier hs-var">parents</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Edge SPitch) [(SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679466376"><span class="hs-identifier hs-var">splitTs</span></a></span><span>
</span><span id="line-806"></span><span>  </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-807"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;elaborateRegular&quot;</span></span><span>
</span><span id="line-808"></span><span>    </span><span class="annot"><span class="annottext">Geometric1
</span><span class="hs-identifier hs-var">Geometric1</span></span><span>
</span><span id="line-809"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pElaborateRegular"><span class="hs-identifier hs-var">pElaborateRegular</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-810"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[(SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679466374"><span class="hs-identifier hs-var">children</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-811"></span><span>  </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679466374"><span class="hs-identifier hs-var">children</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679466368"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466368"><span class="hs-identifier hs-var">child</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DoubleOrnament
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Edge SPitch
</span><a href="#local-6989586621679466375"><span class="hs-identifier hs-var">parents</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-812"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop SPitch
</span><a href="Common.html#Start"><span class="hs-identifier hs-var">Start</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop SPitch
</span><a href="Common.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-813"></span><span>      </span><span class="annot"><span class="annottext">SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeRootNote"><span class="hs-identifier hs-var">observeRootNote</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466368"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-814"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span id="local-6989586621679466367"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466367"><span class="hs-identifier hs-var">pl</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Common.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span id="local-6989586621679466366"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466366"><span class="hs-identifier hs-var">pr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-815"></span><span>      </span><span class="annot"><span class="annottext">SPitch -&gt; SPitch -&gt; SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeDoubleChild"><span class="hs-identifier hs-var">observeDoubleChild</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466367"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466366"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466368"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-816"></span><span>    </span><span class="annot"><span class="annottext">Edge SPitch
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Invalid parent edge &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Edge SPitch
</span><a href="#local-6989586621679466375"><span class="hs-identifier hs-var">parents</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-817"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Edge SPitch
</span><a href="#local-6989586621679466375"><span class="hs-identifier hs-var">parents</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(SPitch, DoubleOrnament)]
</span><a href="#local-6989586621679466374"><span class="hs-identifier hs-var">children</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-818"></span><span>
</span><span id="line-819"></span><span class="hs-comment">-- requires distance &gt;= M2</span><span>
</span><span id="line-820"></span><span id="local-6989586621679466364"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleChromPassing"><span class="hs-identifier hs-type">sampleChromPassing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679466364"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-821"></span><span id="sampleChromPassing"><span class="annot"><span class="annottext">sampleChromPassing :: SPitch -&gt; SPitch -&gt; m (SPitch, PassingOrnament)
</span><a href="PVGrammar.Prob.Simple.html#sampleChromPassing"><span class="hs-identifier hs-var hs-var">sampleChromPassing</span></a></span></span><span> </span><span id="local-6989586621679466338"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466338"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span id="local-6989586621679466337"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466337"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-822"></span><span>  </span><span id="local-6989586621679466336"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466336"><span class="hs-identifier hs-var">atLeft</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-823"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;connectChromaticLeftOverRight&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-824"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span>
</span><span id="line-825"></span><span>        </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pConnectChromaticLeftOverRight"><span class="hs-identifier hs-var">pConnectChromaticLeftOverRight</span></a></span><span>
</span><span id="line-826"></span><span>  </span><span id="local-6989586621679466332"><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466332"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) {r :: (* -&gt; *) -&gt; *}.
(SampleCtx m MagicalOctaves, RandomInterpreter m r) =&gt;
String -&gt; m SInterval
</span><a href="PVGrammar.Prob.Simple.html#sampleOctaveShift"><span class="hs-identifier hs-var">sampleOctaveShift</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;connectChromaticOctave&quot;</span></span><span>
</span><span id="line-827"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466331"><span class="annot"><span class="annottext">dir :: SInterval -&gt; SInterval
</span><a href="#local-6989586621679466331"><span class="hs-identifier hs-var hs-var">dir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i -&gt; Ordering
</span><span class="hs-identifier hs-var">direction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466338"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466337"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i -&gt; i
</span><span class="hs-identifier hs-var">down</span></span><span>
</span><span id="line-828"></span><span>      </span><span id="local-6989586621679466330"><span class="annot"><span class="annottext">child :: SPitch
</span><a href="#local-6989586621679466330"><span class="hs-identifier hs-var hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-829"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466336"><span class="hs-identifier hs-var">atLeft</span></a></span><span>
</span><span id="line-830"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466338"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. AdditiveGroup a =&gt; Pitch a -&gt; a -&gt; Pitch a
</span><span class="hs-operator hs-var">+^</span></span><span> </span><span class="annot"><span class="annottext">SInterval -&gt; SInterval
</span><a href="#local-6989586621679466331"><span class="hs-identifier hs-var">dir</span></a></span><span> </span><span class="annot"><span class="annottext">forall i. Chromatic i =&gt; i
</span><span class="hs-identifier hs-var">chromaticSemitone</span></span><span>
</span><span id="line-831"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466337"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. AdditiveGroup a =&gt; Pitch a -&gt; a -&gt; Pitch a
</span><span class="hs-operator hs-var">-^</span></span><span> </span><span class="annot"><span class="annottext">SInterval -&gt; SInterval
</span><a href="#local-6989586621679466331"><span class="hs-identifier hs-var">dir</span></a></span><span> </span><span class="annot"><span class="annottext">forall i. Chromatic i =&gt; i
</span><span class="hs-identifier hs-var">chromaticSemitone</span></span><span>
</span><span id="line-832"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466330"><span class="hs-identifier hs-var">child</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. AdditiveGroup a =&gt; Pitch a -&gt; a -&gt; Pitch a
</span><span class="hs-operator hs-var">+^</span></span><span> </span><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466332"><span class="hs-identifier hs-var">os</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="PVGrammar.html#PassingMid"><span class="hs-identifier hs-var">PassingMid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-833"></span><span>
</span><span id="line-834"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeChromPassing"><span class="hs-identifier hs-type">observeChromPassing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-835"></span><span id="observeChromPassing"><span class="annot"><span class="annottext">observeChromPassing :: SPitch -&gt; SPitch -&gt; SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeChromPassing"><span class="hs-identifier hs-var hs-var">observeChromPassing</span></a></span></span><span> </span><span id="local-6989586621679466326"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466326"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span id="local-6989586621679466325"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466325"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span id="local-6989586621679466324"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466324"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-836"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466323"><span class="annot"><span class="annottext">isLeft :: Bool
</span><a href="#local-6989586621679466323"><span class="hs-identifier hs-var hs-var">isLeft</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466326"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466324"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-837"></span><span>  </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-838"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;connectChromaticLeftOverRight&quot;</span></span><span>
</span><span id="line-839"></span><span>    </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-840"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pConnectChromaticLeftOverRight"><span class="hs-identifier hs-var">pConnectChromaticLeftOverRight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-841"></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466323"><span class="hs-identifier hs-var">isLeft</span></a></span><span>
</span><span id="line-842"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; SInterval -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeOctaveShift"><span class="hs-identifier hs-var">observeOctaveShift</span></a></span><span>
</span><span id="line-843"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;connectChromaticOctave&quot;</span></span><span>
</span><span id="line-844"></span><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466323"><span class="hs-identifier hs-var">isLeft</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466326"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466325"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466324"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-845"></span><span>
</span><span id="line-846"></span><span id="local-6989586621679466319"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleMidPassing"><span class="hs-identifier hs-type">sampleMidPassing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679466319"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-847"></span><span id="sampleMidPassing"><span class="annot"><span class="annottext">sampleMidPassing :: SPitch -&gt; SPitch -&gt; m (SPitch, PassingOrnament)
</span><a href="PVGrammar.Prob.Simple.html#sampleMidPassing"><span class="hs-identifier hs-var hs-var">sampleMidPassing</span></a></span></span><span> </span><span id="local-6989586621679466300"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466300"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span id="local-6989586621679466299"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466299"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-848"></span><span>  </span><span id="local-6989586621679466298"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466298"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m MagicalOctaves,
 SampleCtx m Geometric0, RandomInterpreter m PVParams) =&gt;
Bool -&gt; SPitch -&gt; m SPitch
</span><a href="PVGrammar.Prob.Simple.html#sampleNeighbor"><span class="hs-identifier hs-var">sampleNeighbor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i -&gt; Ordering
</span><span class="hs-identifier hs-var">direction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466300"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466299"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466300"><span class="hs-identifier hs-var">pl</span></a></span><span>
</span><span id="line-849"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466298"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="PVGrammar.html#PassingMid"><span class="hs-identifier hs-var">PassingMid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-850"></span><span>
</span><span id="line-851"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeMidPassing"><span class="hs-identifier hs-type">observeMidPassing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-852"></span><span id="observeMidPassing"><span class="annot"><span class="annottext">observeMidPassing :: SPitch -&gt; SPitch -&gt; SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeMidPassing"><span class="hs-identifier hs-var hs-var">observeMidPassing</span></a></span></span><span> </span><span id="local-6989586621679466296"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466296"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span id="local-6989586621679466295"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466295"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-853"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; SPitch -&gt; SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeNeighbor"><span class="hs-identifier hs-var">observeNeighbor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i -&gt; Ordering
</span><span class="hs-identifier hs-var">direction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466296"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466295"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466296"><span class="hs-identifier hs-var">pl</span></a></span><span>
</span><span id="line-854"></span><span>
</span><span id="line-855"></span><span id="local-6989586621679466294"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleNonMidPassing"><span class="hs-identifier hs-type">sampleNonMidPassing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679466294"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-856"></span><span id="sampleNonMidPassing"><span class="annot"><span class="annottext">sampleNonMidPassing :: SPitch -&gt; SPitch -&gt; m (SPitch, PassingOrnament)
</span><a href="PVGrammar.Prob.Simple.html#sampleNonMidPassing"><span class="hs-identifier hs-var hs-var">sampleNonMidPassing</span></a></span></span><span> </span><span id="local-6989586621679466266"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466266"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span id="local-6989586621679466265"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466265"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-857"></span><span>  </span><span id="local-6989586621679466264"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466264"><span class="hs-identifier hs-var">left</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-858"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;passLeftOverRight&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pPassLeftOverRight"><span class="hs-identifier hs-var">pPassLeftOverRight</span></a></span><span>
</span><span id="line-859"></span><span>  </span><span class="hs-comment">-- TODO: sampling like this overgenerates, since it allows passing motions to change direction</span><span>
</span><span id="line-860"></span><span>  </span><span class="hs-comment">-- the direction of a passing edge should be tracked explicitly!</span><span>
</span><span id="line-861"></span><span>  </span><span id="local-6989586621679466260"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466260"><span class="hs-identifier hs-var">dirUp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;passUp&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pPassUp"><span class="hs-identifier hs-var">pPassUp</span></a></span><span>
</span><span id="line-862"></span><span>  </span><span class="hs-comment">-- let dirUp = direction (pc pl `pto` pc pr) == GT</span><span>
</span><span id="line-863"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466264"><span class="hs-identifier hs-var">left</span></a></span><span>
</span><span id="line-864"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-865"></span><span>      </span><span id="local-6989586621679466256"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466256"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m MagicalOctaves,
 SampleCtx m Geometric0, RandomInterpreter m PVParams) =&gt;
Bool -&gt; SPitch -&gt; m SPitch
</span><a href="PVGrammar.Prob.Simple.html#sampleNeighbor"><span class="hs-identifier hs-var">sampleNeighbor</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466260"><span class="hs-identifier hs-var">dirUp</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466266"><span class="hs-identifier hs-var">pl</span></a></span><span>
</span><span id="line-866"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466256"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="PVGrammar.html#PassingLeft"><span class="hs-identifier hs-var">PassingLeft</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-867"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-868"></span><span>      </span><span id="local-6989586621679466255"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466255"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m MagicalOctaves,
 SampleCtx m Geometric0, RandomInterpreter m PVParams) =&gt;
Bool -&gt; SPitch -&gt; m SPitch
</span><a href="PVGrammar.Prob.Simple.html#sampleNeighbor"><span class="hs-identifier hs-var">sampleNeighbor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466260"><span class="hs-identifier hs-var">dirUp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466265"><span class="hs-identifier hs-var">pr</span></a></span><span>
</span><span id="line-869"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466255"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="PVGrammar.html#PassingRight"><span class="hs-identifier hs-var">PassingRight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-870"></span><span>
</span><span id="line-871"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeNonMidPassing"><span class="hs-identifier hs-type">observeNonMidPassing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-872"></span><span id="observeNonMidPassing"><span class="annot"><span class="annottext">observeNonMidPassing :: SPitch -&gt; SPitch -&gt; SPitch -&gt; PassingOrnament -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeNonMidPassing"><span class="hs-identifier hs-var hs-var">observeNonMidPassing</span></a></span></span><span> </span><span id="local-6989586621679466252"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466252"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span id="local-6989586621679466251"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466251"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span id="local-6989586621679466250"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466250"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span id="local-6989586621679466249"><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679466249"><span class="hs-identifier hs-var">orn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-873"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466248"><span class="annot"><span class="annottext">left :: Bool
</span><a href="#local-6989586621679466248"><span class="hs-identifier hs-var hs-var">left</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679466249"><span class="hs-identifier hs-var">orn</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="PVGrammar.html#PassingLeft"><span class="hs-identifier hs-var">PassingLeft</span></a></span><span>
</span><span id="line-874"></span><span>      </span><span id="local-6989586621679466247"><span class="annot"><span class="annottext">dirUp :: Bool
</span><a href="#local-6989586621679466247"><span class="hs-identifier hs-var hs-var">dirUp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-875"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466248"><span class="hs-identifier hs-var">left</span></a></span><span>
</span><span id="line-876"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i -&gt; Ordering
</span><span class="hs-identifier hs-var">direction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466252"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466250"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span>
</span><span id="line-877"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i -&gt; Ordering
</span><span class="hs-identifier hs-var">direction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466251"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466250"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">LT</span></span><span>
</span><span id="line-878"></span><span>  </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;passLeftOverRight&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pPassLeftOverRight"><span class="hs-identifier hs-var">pPassLeftOverRight</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466248"><span class="hs-identifier hs-var">left</span></a></span><span>
</span><span id="line-879"></span><span>  </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;passUp&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pPassUp"><span class="hs-identifier hs-var">pPassUp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466247"><span class="hs-identifier hs-var">dirUp</span></a></span><span>
</span><span id="line-880"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466248"><span class="hs-identifier hs-var">left</span></a></span><span>
</span><span id="line-881"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SPitch -&gt; SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeNeighbor"><span class="hs-identifier hs-var">observeNeighbor</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466247"><span class="hs-identifier hs-var">dirUp</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466252"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466250"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-882"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SPitch -&gt; SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeNeighbor"><span class="hs-identifier hs-var">observeNeighbor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466247"><span class="hs-identifier hs-var">dirUp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466251"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466250"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-883"></span><span>
</span><span id="line-884"></span><span id="local-6989586621679466240"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleNT"><span class="hs-identifier hs-type">sampleNT</span></a></span><span>
</span><span id="line-885"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#InnerEdge"><span class="hs-identifier hs-type">InnerEdge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679466240"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#InnerEdge"><span class="hs-identifier hs-type">InnerEdge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-886"></span><span id="sampleNT"><span class="annot"><span class="annottext">sampleNT :: (InnerEdge SPitch, Int)
-&gt; m (InnerEdge SPitch, [(SPitch, PassingOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#sampleNT"><span class="hs-identifier hs-var hs-var">sampleNT</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679466197"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466197"><span class="hs-identifier hs-var">pl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466196"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466196"><span class="hs-identifier hs-var">pr</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466195"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466195"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-887"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;Elaborating edge (smp): &quot; &lt;&gt; show ((pl, pr), n)</span><span>
</span><span id="line-888"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466194"><span class="annot"><span class="annottext">dist :: Int
</span><a href="#local-6989586621679466194"><span class="hs-identifier hs-var hs-var">dist</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i -&gt; i
</span><span class="hs-identifier hs-var">iabs</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466197"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466196"><span class="hs-identifier hs-var">pr</span></a></span><span>
</span><span id="line-889"></span><span>  </span><span class="hs-comment">-- DT.traceM    $  &quot;passing from &quot;    &lt;&gt; showNotation pl    &lt;&gt; &quot; to &quot;    &lt;&gt; showNotation pr    &lt;&gt; &quot;: &quot;    &lt;&gt; show dist    &lt;&gt; &quot; steps.&quot;</span><span>
</span><span id="line-890"></span><span>  </span><span id="local-6989586621679466193"><span class="annot"><span class="annottext">[(SPitch, PassingOrnament)]
</span><a href="#local-6989586621679466193"><span class="hs-identifier hs-var">children</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) a.
(RandomInterpreter m r, Ord a) =&gt;
Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">permutationPlate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466195"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466194"><span class="hs-identifier hs-var">dist</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-891"></span><span>    </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m MagicalOctaves,
 RandomInterpreter m PVParams) =&gt;
SPitch -&gt; SPitch -&gt; m (SPitch, PassingOrnament)
</span><a href="PVGrammar.Prob.Simple.html#sampleChromPassing"><span class="hs-identifier hs-var">sampleChromPassing</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466197"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466196"><span class="hs-identifier hs-var">pr</span></a></span><span>
</span><span id="line-892"></span><span>    </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-893"></span><span>      </span><span id="local-6989586621679466192"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466192"><span class="hs-identifier hs-var">connect</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;passingConnect&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pConnect"><span class="hs-identifier hs-var">pConnect</span></a></span><span>
</span><span id="line-894"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466192"><span class="hs-identifier hs-var">connect</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m MagicalOctaves,
 SampleCtx m Geometric0, RandomInterpreter m PVParams) =&gt;
SPitch -&gt; SPitch -&gt; m (SPitch, PassingOrnament)
</span><a href="PVGrammar.Prob.Simple.html#sampleMidPassing"><span class="hs-identifier hs-var">sampleMidPassing</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466197"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466196"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m MagicalOctaves,
 SampleCtx m Geometric0, RandomInterpreter m PVParams) =&gt;
SPitch -&gt; SPitch -&gt; m (SPitch, PassingOrnament)
</span><a href="PVGrammar.Prob.Simple.html#sampleNonMidPassing"><span class="hs-identifier hs-var">sampleNonMidPassing</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466197"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466196"><span class="hs-identifier hs-var">pr</span></a></span><span>
</span><span id="line-895"></span><span>    </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m MagicalOctaves,
 SampleCtx m Geometric0, RandomInterpreter m PVParams) =&gt;
SPitch -&gt; SPitch -&gt; m (SPitch, PassingOrnament)
</span><a href="PVGrammar.Prob.Simple.html#sampleNonMidPassing"><span class="hs-identifier hs-var">sampleNonMidPassing</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466197"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466196"><span class="hs-identifier hs-var">pr</span></a></span><span>
</span><span id="line-896"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466197"><span class="hs-identifier hs-var">pl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466196"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(SPitch, PassingOrnament)]
</span><a href="#local-6989586621679466193"><span class="hs-identifier hs-var">children</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-897"></span><span>
</span><span id="line-898"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeNT"><span class="hs-identifier hs-type">observeNT</span></a></span><span>
</span><span id="line-899"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span>
</span><span id="line-900"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#InnerEdge"><span class="hs-identifier hs-type">InnerEdge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-901"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#InnerEdge"><span class="hs-identifier hs-type">InnerEdge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-902"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#InnerEdge"><span class="hs-identifier hs-type">InnerEdge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-903"></span><span id="observeNT"><span class="annot"><span class="annottext">observeNT :: Map (InnerEdge SPitch) [(SPitch, PassingOrnament)]
-&gt; (InnerEdge SPitch, Int)
-&gt; PVObs (InnerEdge SPitch, [(SPitch, PassingOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#observeNT"><span class="hs-identifier hs-var hs-var">observeNT</span></a></span></span><span> </span><span id="local-6989586621679466160"><span class="annot"><span class="annottext">Map (InnerEdge SPitch) [(SPitch, PassingOrnament)]
</span><a href="#local-6989586621679466160"><span class="hs-identifier hs-var">splitNTs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679466159"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466159"><span class="hs-identifier hs-var">pl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466158"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466158"><span class="hs-identifier hs-var">pr</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466157"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466157"><span class="hs-identifier hs-var">_n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-904"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;Elaborating edge (obs): &quot; &lt;&gt; show ((pl, pr), n)</span><span>
</span><span id="line-905"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466156"><span class="annot"><span class="annottext">children :: [(SPitch, PassingOrnament)]
</span><a href="#local-6989586621679466156"><span class="hs-identifier hs-var hs-var">children</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466159"><span class="hs-identifier hs-var">pl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466158"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map (InnerEdge SPitch) [(SPitch, PassingOrnament)]
</span><a href="#local-6989586621679466160"><span class="hs-identifier hs-var">splitNTs</span></a></span><span>
</span><span id="line-906"></span><span>  </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(SPitch, PassingOrnament)]
</span><a href="#local-6989586621679466156"><span class="hs-identifier hs-var">children</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679466155"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466155"><span class="hs-identifier hs-var">child</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679466154"><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679466154"><span class="hs-identifier hs-var">orn</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i -&gt; i
</span><span class="hs-identifier hs-var">iabs</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466159"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466158"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-907"></span><span>    </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; SPitch -&gt; SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeChromPassing"><span class="hs-identifier hs-var">observeChromPassing</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466159"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466158"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466155"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-908"></span><span>    </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679466154"><span class="hs-identifier hs-var">orn</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-909"></span><span>      </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="PVGrammar.html#PassingMid"><span class="hs-identifier hs-var">PassingMid</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-910"></span><span>        </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;passingConnect&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pConnect"><span class="hs-identifier hs-var">pConnect</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-911"></span><span>        </span><span class="annot"><span class="annottext">SPitch -&gt; SPitch -&gt; SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeMidPassing"><span class="hs-identifier hs-var">observeMidPassing</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466159"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466158"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466155"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-912"></span><span>      </span><span class="annot"><span class="annottext">PassingOrnament
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-913"></span><span>        </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;passingConnect&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pConnect"><span class="hs-identifier hs-var">pConnect</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-914"></span><span>        </span><span class="annot"><span class="annottext">SPitch -&gt; SPitch -&gt; SPitch -&gt; PassingOrnament -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeNonMidPassing"><span class="hs-identifier hs-var">observeNonMidPassing</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466159"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466158"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466155"><span class="hs-identifier hs-var">child</span></a></span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679466154"><span class="hs-identifier hs-var">orn</span></a></span><span>
</span><span id="line-915"></span><span>    </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SPitch -&gt; SPitch -&gt; SPitch -&gt; PassingOrnament -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeNonMidPassing"><span class="hs-identifier hs-var">observeNonMidPassing</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466159"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466158"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466155"><span class="hs-identifier hs-var">child</span></a></span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679466154"><span class="hs-identifier hs-var">orn</span></a></span><span>
</span><span id="line-916"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466159"><span class="hs-identifier hs-var">pl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466158"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(SPitch, PassingOrnament)]
</span><a href="#local-6989586621679466156"><span class="hs-identifier hs-var">children</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-917"></span><span>
</span><span id="line-918"></span><span id="local-6989586621679466146"><span id="local-6989586621679466147"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleSingleOrn"><span class="hs-identifier hs-type">sampleSingleOrn</span></a></span><span>
</span><span id="line-919"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span>
</span><span id="line-920"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-921"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679466147"><span class="hs-identifier hs-type">o</span></a></span><span>
</span><span id="line-922"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679466147"><span class="hs-identifier hs-type">o</span></a></span><span>
</span><span id="line-923"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Accessor</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-924"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679466146"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679466147"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-925"></span><span id="sampleSingleOrn"><span class="annot"><span class="annottext">sampleSingleOrn :: SPitch
-&gt; o
-&gt; o
-&gt; (forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; m (SPitch, [(SPitch, o)])
</span><a href="PVGrammar.Prob.Simple.html#sampleSingleOrn"><span class="hs-identifier hs-var hs-var">sampleSingleOrn</span></a></span></span><span> </span><span id="local-6989586621679466106"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466106"><span class="hs-identifier hs-var">parent</span></a></span></span><span> </span><span id="local-6989586621679466105"><span class="annot"><span class="annottext">o
</span><a href="#local-6989586621679466105"><span class="hs-identifier hs-var">oRepeat</span></a></span></span><span> </span><span id="local-6989586621679466104"><span class="annot"><span class="annottext">o
</span><a href="#local-6989586621679466104"><span class="hs-identifier hs-var">oNeighbor</span></a></span></span><span> </span><span id="local-6989586621679466103"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="#local-6989586621679466103"><span class="hs-identifier hs-var">pElaborate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-926"></span><span>  </span><span id="local-6989586621679466102"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466102"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;elaborateSingle&quot;</span></span><span> </span><span class="annot"><span class="annottext">Geometric0
</span><span class="hs-identifier hs-var">Geometric0</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="#local-6989586621679466103"><span class="hs-identifier hs-var">pElaborate</span></a></span><span>
</span><span id="line-927"></span><span>  </span><span id="local-6989586621679466098"><span class="annot"><span class="annottext">[(SPitch, o)]
</span><a href="#local-6989586621679466098"><span class="hs-identifier hs-var">children</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) a.
(RandomInterpreter m r, Ord a) =&gt;
Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">permutationPlate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679466102"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-928"></span><span>    </span><span id="local-6989586621679466097"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466097"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-929"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatOverNeighborSingle&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-930"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span>
</span><span id="line-931"></span><span>          </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatOverNeighbor"><span class="hs-identifier hs-var">pRepeatOverNeighbor</span></a></span><span>
</span><span id="line-932"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466097"><span class="hs-identifier hs-var">rep</span></a></span><span>
</span><span id="line-933"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-934"></span><span>        </span><span id="local-6989586621679466093"><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466093"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) {r :: (* -&gt; *) -&gt; *}.
(SampleCtx m MagicalOctaves, RandomInterpreter m r) =&gt;
String -&gt; m SInterval
</span><a href="PVGrammar.Prob.Simple.html#sampleOctaveShift"><span class="hs-identifier hs-var">sampleOctaveShift</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;singleChildOctave&quot;</span></span><span>
</span><span id="line-935"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466106"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. AdditiveGroup a =&gt; Pitch a -&gt; a -&gt; Pitch a
</span><span class="hs-operator hs-var">+^</span></span><span> </span><span class="annot"><span class="annottext">SInterval
</span><a href="#local-6989586621679466093"><span class="hs-identifier hs-var">os</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">o
</span><a href="#local-6989586621679466105"><span class="hs-identifier hs-var">oRepeat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-936"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-937"></span><span>        </span><span id="local-6989586621679466092"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466092"><span class="hs-identifier hs-var">stepUp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) d.
(RandomInterpreter m r, Distribution d, SampleCtx m d) =&gt;
String -&gt; d -&gt; Params d -&gt; m (Support d)
</span><span class="hs-identifier hs-var">sampleConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;singleUp&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.5</span></span><span>
</span><span id="line-938"></span><span>        </span><span id="local-6989586621679466091"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466091"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Bernoulli, SampleCtx m MagicalOctaves,
 SampleCtx m Geometric0, RandomInterpreter m PVParams) =&gt;
Bool -&gt; SPitch -&gt; m SPitch
</span><a href="PVGrammar.Prob.Simple.html#sampleNeighbor"><span class="hs-identifier hs-var">sampleNeighbor</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466092"><span class="hs-identifier hs-var">stepUp</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466106"><span class="hs-identifier hs-var">parent</span></a></span><span>
</span><span id="line-939"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466091"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">o
</span><a href="#local-6989586621679466104"><span class="hs-identifier hs-var">oNeighbor</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-940"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466106"><span class="hs-identifier hs-var">parent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(SPitch, o)]
</span><a href="#local-6989586621679466098"><span class="hs-identifier hs-var">children</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-941"></span><span>
</span><span id="line-942"></span><span id="local-6989586621679468981"><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeSingleOrn"><span class="hs-identifier hs-type">observeSingleOrn</span></a></span><span>
</span><span id="line-943"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679468981"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-944"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-945"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Accessor</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-946"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679468981"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-947"></span><span id="observeSingleOrn"><span class="annot"><span class="annottext">observeSingleOrn :: forall o.
Map SPitch [(SPitch, o)]
-&gt; SPitch
-&gt; (forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; PVObs (SPitch, [(SPitch, o)])
</span><a href="PVGrammar.Prob.Simple.html#observeSingleOrn"><span class="hs-identifier hs-var hs-var">observeSingleOrn</span></a></span></span><span> </span><span id="local-6989586621679466061"><span class="annot"><span class="annottext">Map SPitch [(SPitch, o)]
</span><a href="#local-6989586621679466061"><span class="hs-identifier hs-var">table</span></a></span></span><span> </span><span id="local-6989586621679466060"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466060"><span class="hs-identifier hs-var">parent</span></a></span></span><span> </span><span id="local-6989586621679466059"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="#local-6989586621679466059"><span class="hs-identifier hs-var">pElaborate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-948"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466058"><span class="annot"><span class="annottext">children :: [(SPitch, o)]
</span><a href="#local-6989586621679466058"><span class="hs-identifier hs-var hs-var">children</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466060"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">Map SPitch [(SPitch, o)]
</span><a href="#local-6989586621679466061"><span class="hs-identifier hs-var">table</span></a></span><span>
</span><span id="line-949"></span><span>  </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-950"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;elaborateSingle&quot;</span></span><span>
</span><span id="line-951"></span><span>    </span><span class="annot"><span class="annottext">Geometric0
</span><span class="hs-identifier hs-var">Geometric0</span></span><span>
</span><span id="line-952"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="#local-6989586621679466059"><span class="hs-identifier hs-var">pElaborate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-953"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[(SPitch, o)]
</span><a href="#local-6989586621679466058"><span class="hs-identifier hs-var">children</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-954"></span><span>  </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(SPitch, o)]
</span><a href="#local-6989586621679466058"><span class="hs-identifier hs-var">children</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679466054"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466054"><span class="hs-identifier hs-var">child</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">o
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-955"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466053"><span class="annot"><span class="annottext">rep :: Bool
</span><a href="#local-6989586621679466053"><span class="hs-identifier hs-var hs-var">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466054"><span class="hs-identifier hs-var">child</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466060"><span class="hs-identifier hs-var">parent</span></a></span><span>
</span><span id="line-956"></span><span>    </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-957"></span><span>      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;repeatOverNeighborSingle&quot;</span></span><span>
</span><span id="line-958"></span><span>      </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-959"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pRepeatOverNeighbor"><span class="hs-identifier hs-var">pRepeatOverNeighbor</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-960"></span><span>      </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466053"><span class="hs-identifier hs-var">rep</span></a></span><span>
</span><span id="line-961"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466053"><span class="hs-identifier hs-var">rep</span></a></span><span>
</span><span id="line-962"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-963"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; SInterval -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeOctaveShift"><span class="hs-identifier hs-var">observeOctaveShift</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;singleChildOctave&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466060"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466054"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-964"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-965"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679466049"><span class="annot"><span class="annottext">dir :: Ordering
</span><a href="#local-6989586621679466049"><span class="hs-identifier hs-var hs-var">dir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i -&gt; Ordering
</span><span class="hs-identifier hs-var">direction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466060"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466054"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-966"></span><span>            </span><span id="local-6989586621679466048"><span class="annot"><span class="annottext">up :: Bool
</span><a href="#local-6989586621679466048"><span class="hs-identifier hs-var hs-var">up</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ordering
</span><a href="#local-6989586621679466049"><span class="hs-identifier hs-var">dir</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span>
</span><span id="line-967"></span><span>        </span><span class="annot"><span class="annottext">forall d (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Distribution d, Typeable (Support d), Monad m) =&gt;
String -&gt; d -&gt; Params d -&gt; Support d -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeConst</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;singleUp&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.5</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466048"><span class="hs-identifier hs-var">up</span></a></span><span>
</span><span id="line-968"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; SPitch -&gt; SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeNeighbor"><span class="hs-identifier hs-var">observeNeighbor</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679466048"><span class="hs-identifier hs-var">up</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466060"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466054"><span class="hs-identifier hs-var">child</span></a></span><span>
</span><span id="line-969"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466060"><span class="hs-identifier hs-var">parent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(SPitch, o)]
</span><a href="#local-6989586621679466058"><span class="hs-identifier hs-var">children</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-970"></span><span>
</span><span id="line-971"></span><span id="local-6989586621679466047"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleL"><span class="hs-identifier hs-type">sampleL</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679466047"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#RightOrnament"><span class="hs-identifier hs-type">RightOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-972"></span><span id="sampleL"><span class="annot"><span class="annottext">sampleL :: SPitch -&gt; m (SPitch, [(SPitch, RightOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#sampleL"><span class="hs-identifier hs-var hs-var">sampleL</span></a></span></span><span> </span><span id="local-6989586621679466036"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466036"><span class="hs-identifier hs-var">parent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall o (m :: * -&gt; *).
(SampleCtx m Geometric0, SampleCtx m Bernoulli,
 SampleCtx m MagicalOctaves, RandomInterpreter m PVParams, Ord o) =&gt;
SPitch
-&gt; o
-&gt; o
-&gt; (forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; m (SPitch, [(SPitch, o)])
</span><a href="PVGrammar.Prob.Simple.html#sampleSingleOrn"><span class="hs-identifier hs-var">sampleSingleOrn</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466036"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">RightOrnament
</span><a href="PVGrammar.html#RightRepeat"><span class="hs-identifier hs-var">RightRepeat</span></a></span><span> </span><span class="annot"><span class="annottext">RightOrnament
</span><a href="PVGrammar.html#RightNeighbor"><span class="hs-identifier hs-var">RightNeighbor</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pElaborateL"><span class="hs-identifier hs-var">pElaborateL</span></a></span><span>
</span><span id="line-973"></span><span>
</span><span id="line-974"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeL"><span class="hs-identifier hs-type">observeL</span></a></span><span>
</span><span id="line-975"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#RightOrnament"><span class="hs-identifier hs-type">RightOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-976"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-977"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#RightOrnament"><span class="hs-identifier hs-type">RightOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-978"></span><span id="observeL"><span class="annot"><span class="annottext">observeL :: Map SPitch [(SPitch, RightOrnament)]
-&gt; SPitch -&gt; PVObs (SPitch, [(SPitch, RightOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#observeL"><span class="hs-identifier hs-var hs-var">observeL</span></a></span></span><span> </span><span id="local-6989586621679466031"><span class="annot"><span class="annottext">Map SPitch [(SPitch, RightOrnament)]
</span><a href="#local-6989586621679466031"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span id="local-6989586621679466030"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466030"><span class="hs-identifier hs-var">parent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall o.
Map SPitch [(SPitch, o)]
-&gt; SPitch
-&gt; (forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; PVObs (SPitch, [(SPitch, o)])
</span><a href="PVGrammar.Prob.Simple.html#observeSingleOrn"><span class="hs-identifier hs-var">observeSingleOrn</span></a></span><span> </span><span class="annot"><span class="annottext">Map SPitch [(SPitch, RightOrnament)]
</span><a href="#local-6989586621679466031"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466030"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pElaborateL"><span class="hs-identifier hs-var">pElaborateL</span></a></span><span>
</span><span id="line-979"></span><span>
</span><span id="line-980"></span><span id="local-6989586621679466027"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleR"><span class="hs-identifier hs-type">sampleR</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679466027"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#LeftOrnament"><span class="hs-identifier hs-type">LeftOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-981"></span><span id="sampleR"><span class="annot"><span class="annottext">sampleR :: SPitch -&gt; m (SPitch, [(SPitch, LeftOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#sampleR"><span class="hs-identifier hs-var hs-var">sampleR</span></a></span></span><span> </span><span id="local-6989586621679466016"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466016"><span class="hs-identifier hs-var">parent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall o (m :: * -&gt; *).
(SampleCtx m Geometric0, SampleCtx m Bernoulli,
 SampleCtx m MagicalOctaves, RandomInterpreter m PVParams, Ord o) =&gt;
SPitch
-&gt; o
-&gt; o
-&gt; (forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; m (SPitch, [(SPitch, o)])
</span><a href="PVGrammar.Prob.Simple.html#sampleSingleOrn"><span class="hs-identifier hs-var">sampleSingleOrn</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466016"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">LeftOrnament
</span><a href="PVGrammar.html#LeftRepeat"><span class="hs-identifier hs-var">LeftRepeat</span></a></span><span> </span><span class="annot"><span class="annottext">LeftOrnament
</span><a href="PVGrammar.html#LeftNeighbor"><span class="hs-identifier hs-var">LeftNeighbor</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pElaborateR"><span class="hs-identifier hs-var">pElaborateR</span></a></span><span>
</span><span id="line-982"></span><span>
</span><span id="line-983"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeR"><span class="hs-identifier hs-type">observeR</span></a></span><span>
</span><span id="line-984"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#LeftOrnament"><span class="hs-identifier hs-type">LeftOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-985"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span>
</span><span id="line-986"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#LeftOrnament"><span class="hs-identifier hs-type">LeftOrnament</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-987"></span><span id="observeR"><span class="annot"><span class="annottext">observeR :: Map SPitch [(SPitch, LeftOrnament)]
-&gt; SPitch -&gt; PVObs (SPitch, [(SPitch, LeftOrnament)])
</span><a href="PVGrammar.Prob.Simple.html#observeR"><span class="hs-identifier hs-var hs-var">observeR</span></a></span></span><span> </span><span id="local-6989586621679466011"><span class="annot"><span class="annottext">Map SPitch [(SPitch, LeftOrnament)]
</span><a href="#local-6989586621679466011"><span class="hs-identifier hs-var">rs</span></a></span></span><span> </span><span id="local-6989586621679466010"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466010"><span class="hs-identifier hs-var">parent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall o.
Map SPitch [(SPitch, o)]
-&gt; SPitch
-&gt; (forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; PVObs (SPitch, [(SPitch, o)])
</span><a href="PVGrammar.Prob.Simple.html#observeSingleOrn"><span class="hs-identifier hs-var">observeSingleOrn</span></a></span><span> </span><span class="annot"><span class="annottext">Map SPitch [(SPitch, LeftOrnament)]
</span><a href="#local-6989586621679466011"><span class="hs-identifier hs-var">rs</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679466010"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pElaborateR"><span class="hs-identifier hs-var">pElaborateR</span></a></span><span>
</span><span id="line-988"></span><span>
</span><span id="line-989"></span><span id="local-6989586621679466006"><span id="local-6989586621679466007"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleKeepEdges"><span class="hs-identifier hs-type">sampleKeepEdges</span></a></span><span>
</span><span id="line-990"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Accessor</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.HashSet</span></span><span> </span><span class="annot"><a href="#local-6989586621679466007"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679466006"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.HashSet</span></span><span> </span><span class="annot"><a href="#local-6989586621679466007"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-991"></span><span id="sampleKeepEdges"><span class="annot"><span class="annottext">sampleKeepEdges :: (forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; HashSet e -&gt; m (HashSet e)
</span><a href="PVGrammar.Prob.Simple.html#sampleKeepEdges"><span class="hs-identifier hs-var hs-var">sampleKeepEdges</span></a></span></span><span> </span><span id="local-6989586621679465985"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="#local-6989586621679465985"><span class="hs-identifier hs-var">pKeep</span></a></span></span><span> </span><span id="local-6989586621679465984"><span class="annot"><span class="annottext">HashSet e
</span><a href="#local-6989586621679465984"><span class="hs-identifier hs-var">set</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-992"></span><span>  </span><span id="local-6989586621679465983"><span class="annot"><span class="annottext">[Maybe e]
</span><a href="#local-6989586621679465983"><span class="hs-identifier hs-var">kept</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">e -&gt; m (Maybe e)
</span><a href="#local-6989586621679465982"><span class="hs-identifier hs-var">sKeep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet e
</span><a href="#local-6989586621679465984"><span class="hs-identifier hs-var">set</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-993"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">[Maybe e]
</span><a href="#local-6989586621679465983"><span class="hs-identifier hs-var">kept</span></a></span><span>
</span><span id="line-994"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-995"></span><span>  </span><span id="local-6989586621679465982"><span class="annot"><span class="annottext">sKeep :: e -&gt; m (Maybe e)
</span><a href="#local-6989586621679465982"><span class="hs-identifier hs-var hs-var">sKeep</span></a></span></span><span> </span><span id="local-6989586621679465981"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679465981"><span class="hs-identifier hs-var">elt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-996"></span><span>    </span><span id="local-6989586621679465980"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679465980"><span class="hs-identifier hs-var">keep</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;keep&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="#local-6989586621679465985"><span class="hs-identifier hs-var">pKeep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-997"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679465980"><span class="hs-identifier hs-var">keep</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679465981"><span class="hs-identifier hs-var">elt</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-998"></span><span>
</span><span id="line-999"></span><span id="local-6989586621679469092"><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeKeepEdges"><span class="hs-identifier hs-type">observeKeepEdges</span></a></span><span>
</span><span id="line-1000"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679469092"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679469092"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679469092"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1001"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Accessor</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-1002"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.HashSet</span></span><span> </span><span class="annot"><a href="#local-6989586621679469092"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-1003"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.HashSet</span></span><span> </span><span class="annot"><a href="#local-6989586621679469092"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-1004"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-1005"></span><span id="observeKeepEdges"><span class="annot"><span class="annottext">observeKeepEdges :: forall e.
(Eq e, Hashable e, Ord e) =&gt;
(forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; HashSet e -&gt; HashSet e -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeKeepEdges"><span class="hs-identifier hs-var hs-var">observeKeepEdges</span></a></span></span><span> </span><span id="local-6989586621679465965"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="#local-6989586621679465965"><span class="hs-identifier hs-var">pKeep</span></a></span></span><span> </span><span id="local-6989586621679465964"><span class="annot"><span class="annottext">HashSet e
</span><a href="#local-6989586621679465964"><span class="hs-identifier hs-var">candidates</span></a></span></span><span> </span><span id="local-6989586621679465963"><span class="annot"><span class="annottext">HashSet e
</span><a href="#local-6989586621679465963"><span class="hs-identifier hs-var">kept</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1006"></span><span>  </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span>
</span><span id="line-1007"></span><span>    </span><span class="annot"><span class="annottext">e -&gt; PVObs ()
</span><a href="#local-6989586621679465961"><span class="hs-identifier hs-var">oKeep</span></a></span><span>
</span><span id="line-1008"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">L.sort</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. HashSet a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">HashSet e
</span><a href="#local-6989586621679465964"><span class="hs-identifier hs-var">candidates</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1009"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1010"></span><span>  </span><span id="local-6989586621679465961"><span class="annot"><span class="annottext">oKeep :: e -&gt; PVObs ()
</span><a href="#local-6989586621679465961"><span class="hs-identifier hs-var hs-var">oKeep</span></a></span></span><span> </span><span id="local-6989586621679465960"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679465960"><span class="hs-identifier hs-var">edge</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1011"></span><span>    </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;keep&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="#local-6989586621679465965"><span class="hs-identifier hs-var">pKeep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; a -&gt; HashSet a -&gt; Bool
</span><span class="hs-identifier hs-var">S.member</span></span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679465960"><span class="hs-identifier hs-var">edge</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet e
</span><a href="#local-6989586621679465963"><span class="hs-identifier hs-var">kept</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1012"></span><span>
</span><span id="line-1013"></span><span id="local-6989586621679465955"><span class="annot"><a href="PVGrammar.Prob.Simple.html#sampleSpread"><span class="hs-identifier hs-type">sampleSpread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextDouble"><span class="hs-identifier hs-type">ContextDouble</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679465955"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-1014"></span><span id="sampleSpread"><span class="annot"><span class="annottext">sampleSpread :: ContextDouble SPitch -&gt; m (Spread SPitch)
</span><a href="PVGrammar.Prob.Simple.html#sampleSpread"><span class="hs-identifier hs-var hs-var">sampleSpread</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679465897"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679465897"><span class="hs-identifier hs-var">_sliceL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679465896"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679465896"><span class="hs-identifier hs-var">_transL</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679465895"><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679465895"><span class="hs-identifier hs-var">sliceM</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679465894"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679465894"><span class="hs-identifier hs-var">_transR</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679465893"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679465893"><span class="hs-identifier hs-var">_sliceR</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1015"></span><span>  </span><span class="hs-comment">-- distribute notes</span><span>
</span><span id="line-1016"></span><span>  </span><span id="local-6989586621679465892"><span class="annot"><span class="annottext">[((SPitch, Int), SpreadDirection)]
</span><a href="#local-6989586621679465892"><span class="hs-identifier hs-var">dists</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">forall {m :: * -&gt; *} {a}.
(SampleCtx m (Categorical 3), SampleCtx m Binomial,
 RandomInterpreter m PVParams) =&gt;
(a, Int) -&gt; m ((a, Int), SpreadDirection)
</span><a href="#local-6989586621679465891"><span class="hs-identifier hs-var">distNote</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall k. MultiSet k -&gt; [(k, Int)]
</span><a href="Internal.MultiSet.html#toOccurList"><span class="hs-identifier hs-var">MS.toOccurList</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679465895"><span class="hs-identifier hs-var">sliceM</span></a></span><span>
</span><span id="line-1017"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679465890"><span class="annot"><span class="annottext">notesLeft :: [SPitch]
</span><a href="#local-6989586621679465890"><span class="hs-identifier hs-var hs-var">notesLeft</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[((SPitch, Int), SpreadDirection)]
</span><a href="#local-6989586621679465892"><span class="hs-identifier hs-var">dists</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679465888"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465888"><span class="hs-identifier hs-var">note</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679465887"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465887"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679465886"><span class="annot"><span class="annottext">SpreadDirection
</span><a href="#local-6989586621679465886"><span class="hs-identifier hs-var">to</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SpreadDirection
</span><a href="#local-6989586621679465886"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1018"></span><span>        </span><span class="annot"><a href="PVGrammar.html#ToRight"><span class="hs-identifier hs-type">ToRight</span></a></span><span> </span><span id="local-6989586621679465884"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465884"><span class="hs-identifier hs-var">dl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465887"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465884"><span class="hs-identifier hs-var">dl</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465888"><span class="hs-identifier hs-var">note</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1019"></span><span>        </span><span class="annot"><span class="annottext">SpreadDirection
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465888"><span class="hs-identifier hs-var">note</span></a></span><span>
</span><span id="line-1020"></span><span>      </span><span id="local-6989586621679465883"><span class="annot"><span class="annottext">notesRight :: [SPitch]
</span><a href="#local-6989586621679465883"><span class="hs-identifier hs-var hs-var">notesRight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[((SPitch, Int), SpreadDirection)]
</span><a href="#local-6989586621679465892"><span class="hs-identifier hs-var">dists</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679465882"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465882"><span class="hs-identifier hs-var">note</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679465881"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465881"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679465880"><span class="annot"><span class="annottext">SpreadDirection
</span><a href="#local-6989586621679465880"><span class="hs-identifier hs-var">to</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SpreadDirection
</span><a href="#local-6989586621679465880"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1021"></span><span>        </span><span class="annot"><a href="PVGrammar.html#ToLeft"><span class="hs-identifier hs-type">ToLeft</span></a></span><span> </span><span id="local-6989586621679465878"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465878"><span class="hs-identifier hs-var">dr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465881"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465878"><span class="hs-identifier hs-var">dr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465882"><span class="hs-identifier hs-var">note</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1022"></span><span>        </span><span class="annot"><span class="annottext">SpreadDirection
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465882"><span class="hs-identifier hs-var">note</span></a></span><span>
</span><span id="line-1023"></span><span>  </span><span class="hs-comment">-- generate repetition edges</span><span>
</span><span id="line-1024"></span><span>  </span><span id="local-6989586621679465877"><span class="annot"><span class="annottext">[Maybe (Edge SPitch)]
</span><a href="#local-6989586621679465877"><span class="hs-identifier hs-var">repeats</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Traversable t, Monad m) =&gt;
t (m a) -&gt; m (t a)
</span><span class="hs-identifier hs-var">sequence</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1025"></span><span>    </span><span class="hs-comment">-- List</span><span>
</span><span id="line-1026"></span><span>    </span><span id="local-6989586621679465875"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465875"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679465890"><span class="hs-identifier hs-var">notesLeft</span></a></span><span>
</span><span id="line-1027"></span><span>    </span><span id="local-6989586621679465874"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465874"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679465883"><span class="hs-identifier hs-var">notesRight</span></a></span><span>
</span><span id="line-1028"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465875"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465874"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1029"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1030"></span><span>      </span><span class="hs-comment">-- m</span><span>
</span><span id="line-1031"></span><span>      </span><span id="local-6989586621679465873"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679465873"><span class="hs-identifier hs-var">rep</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1032"></span><span>        </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;spreadRepeatEdge&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1033"></span><span>          </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span>
</span><span id="line-1034"></span><span>            </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pSpreadRepetitionEdge"><span class="hs-identifier hs-var">pSpreadRepetitionEdge</span></a></span><span>
</span><span id="line-1035"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679465873"><span class="hs-identifier hs-var">rep</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465875"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465874"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1036"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679465869"><span class="annot"><span class="annottext">repEdges :: HashSet (Edge SPitch)
</span><a href="#local-6989586621679465869"><span class="hs-identifier hs-var hs-var">repEdges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (Edge SPitch)]
</span><a href="#local-6989586621679465877"><span class="hs-identifier hs-var">repeats</span></a></span><span>
</span><span id="line-1037"></span><span>  </span><span class="hs-comment">-- generate passing edges</span><span>
</span><span id="line-1038"></span><span>  </span><span id="local-6989586621679465868"><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679465868"><span class="hs-identifier hs-var">passEdges</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
(SampleCtx m Geometric0, RandomInterpreter m PVParams) =&gt;
[SPitch]
-&gt; [SPitch]
-&gt; (forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; m (MultiSet (InnerEdge SPitch))
</span><a href="PVGrammar.Prob.Simple.html#samplePassing"><span class="hs-identifier hs-var">samplePassing</span></a></span><span> </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679465890"><span class="hs-identifier hs-var">notesLeft</span></a></span><span> </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679465883"><span class="hs-identifier hs-var">notesRight</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pNewPassingMid"><span class="hs-identifier hs-var">pNewPassingMid</span></a></span><span>
</span><span id="line-1039"></span><span>  </span><span class="hs-comment">-- construct result</span><span>
</span><span id="line-1040"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679465865"><span class="annot"><span class="annottext">distMap :: HashMap SPitch SpreadDirection
</span><a href="#local-6989586621679465865"><span class="hs-identifier hs-var hs-var">distMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HM.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">Bi.first</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[((SPitch, Int), SpreadDirection)]
</span><a href="#local-6989586621679465892"><span class="hs-identifier hs-var">dists</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1041"></span><span>      </span><span id="local-6989586621679465862"><span class="annot"><span class="annottext">edges :: Edges SPitch
</span><a href="#local-6989586621679465862"><span class="hs-identifier hs-var hs-var">edges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall n. HashSet (Edge n) -&gt; MultiSet (InnerEdge n) -&gt; Edges n
</span><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-var">Edges</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679465869"><span class="hs-identifier hs-var">repEdges</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679465868"><span class="hs-identifier hs-var">passEdges</span></a></span><span>
</span><span id="line-1042"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall n. HashMap n SpreadDirection -&gt; Edges n -&gt; Spread n
</span><a href="PVGrammar.html#SpreadOp"><span class="hs-identifier hs-var">SpreadOp</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap SPitch SpreadDirection
</span><a href="#local-6989586621679465865"><span class="hs-identifier hs-var">distMap</span></a></span><span> </span><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679465862"><span class="hs-identifier hs-var">edges</span></a></span><span>
</span><span id="line-1043"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1044"></span><span>  </span><span class="hs-comment">-- distribute a note to the two child slices</span><span>
</span><span id="line-1045"></span><span>  </span><span id="local-6989586621679465891"><span class="annot"><span class="annottext">distNote :: (a, Int) -&gt; m ((a, Int), SpreadDirection)
</span><a href="#local-6989586621679465891"><span class="hs-identifier hs-var hs-var">distNote</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679465826"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679465826"><span class="hs-identifier hs-var">note</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679465825"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465825"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1046"></span><span>    </span><span id="local-6989586621679465824"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465824"><span class="hs-identifier hs-var">dir</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1047"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;noteSpreadDirection&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (n :: Nat). Categorical n
</span><span class="hs-identifier hs-var">Categorical</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1048"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span>
</span><span id="line-1049"></span><span>          </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f (Dirichlet 3))
</span><a href="PVGrammar.Prob.Simple.html#pNoteSpreadDirection"><span class="hs-identifier hs-var">pNoteSpreadDirection</span></a></span><span>
</span><span id="line-1050"></span><span>    </span><span id="local-6989586621679465819"><span class="annot"><span class="annottext">SpreadDirection
</span><a href="#local-6989586621679465819"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465824"><span class="hs-identifier hs-var">dir</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1051"></span><span>      </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SpreadDirection
</span><a href="PVGrammar.html#ToBoth"><span class="hs-identifier hs-var">ToBoth</span></a></span><span>
</span><span id="line-1052"></span><span>      </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1053"></span><span>        </span><span id="local-6989586621679465817"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465817"><span class="hs-identifier hs-var">nother</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1054"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;notesOnOtherSide&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Binomial
</span><span class="hs-identifier hs-var">Binomial</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465825"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1055"></span><span>            </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span>
</span><span id="line-1056"></span><span>              </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pNotesOnOtherSide"><span class="hs-identifier hs-var">pNotesOnOtherSide</span></a></span><span>
</span><span id="line-1057"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SpreadDirection
</span><a href="PVGrammar.html#ToLeft"><span class="hs-identifier hs-var">ToLeft</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465825"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465817"><span class="hs-identifier hs-var">nother</span></a></span><span>
</span><span id="line-1058"></span><span>      </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1059"></span><span>        </span><span id="local-6989586621679465812"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465812"><span class="hs-identifier hs-var">nother</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1060"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;notesOnOtherSide&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Binomial
</span><span class="hs-identifier hs-var">Binomial</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465825"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1061"></span><span>            </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span>
</span><span id="line-1062"></span><span>              </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pNotesOnOtherSide"><span class="hs-identifier hs-var">pNotesOnOtherSide</span></a></span><span>
</span><span id="line-1063"></span><span>        </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SpreadDirection
</span><a href="PVGrammar.html#ToRight"><span class="hs-identifier hs-var">ToRight</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465825"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465812"><span class="hs-identifier hs-var">nother</span></a></span><span>
</span><span id="line-1064"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679465826"><span class="hs-identifier hs-var">note</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465825"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SpreadDirection
</span><a href="#local-6989586621679465819"><span class="hs-identifier hs-var">to</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1065"></span><span>
</span><span id="line-1066"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observeSpread"><span class="hs-identifier hs-type">observeSpread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#ContextDouble"><span class="hs-identifier hs-type">ContextDouble</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1067"></span><span id="observeSpread"><span class="annot"><span class="annottext">observeSpread :: ContextDouble SPitch -&gt; Spread SPitch -&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observeSpread"><span class="hs-identifier hs-var hs-var">observeSpread</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679465808"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679465808"><span class="hs-identifier hs-var">_sliceL</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679465807"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679465807"><span class="hs-identifier hs-var">_transL</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679465806"><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679465806"><span class="hs-identifier hs-var">sliceM</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679465805"><span class="annot"><span class="annottext">Edges SPitch
</span><a href="#local-6989586621679465805"><span class="hs-identifier hs-var">_transR</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679465804"><span class="annot"><span class="annottext">StartStop (Notes SPitch)
</span><a href="#local-6989586621679465804"><span class="hs-identifier hs-var">_sliceR</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#SpreadOp"><span class="hs-identifier hs-type">SpreadOp</span></a></span><span> </span><span id="local-6989586621679465803"><span class="annot"><span class="annottext">HashMap SPitch SpreadDirection
</span><a href="#local-6989586621679465803"><span class="hs-identifier hs-var">obsDists</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span id="local-6989586621679465802"><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679465802"><span class="hs-identifier hs-var">repEdges</span></a></span></span><span> </span><span id="local-6989586621679465801"><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679465801"><span class="hs-identifier hs-var">passEdges</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1068"></span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-1069"></span><span>    </span><span class="hs-comment">-- observe note distribution</span><span>
</span><span id="line-1070"></span><span>    </span><span id="local-6989586621679465800"><span class="annot"><span class="annottext">[((SPitch, Int), SpreadDirection)]
</span><a href="#local-6989586621679465800"><span class="hs-identifier hs-var">dists</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {a}.
(Hashable a, Notation a) =&gt;
HashMap a SpreadDirection
-&gt; (a, Int)
-&gt; StateT
     (Trace PVParams) (Either String) ((a, Int), SpreadDirection)
</span><a href="#local-6989586621679465799"><span class="hs-identifier hs-var">observeNoteDist</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap SPitch SpreadDirection
</span><a href="#local-6989586621679465803"><span class="hs-identifier hs-var">obsDists</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall k. MultiSet k -&gt; [(k, Int)]
</span><a href="Internal.MultiSet.html#toOccurList"><span class="hs-identifier hs-var">MS.toOccurList</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet SPitch
</span><a href="#local-6989586621679465806"><span class="hs-identifier hs-var">sliceM</span></a></span><span>
</span><span id="line-1071"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679465798"><span class="annot"><span class="annottext">notesLeft :: [SPitch]
</span><a href="#local-6989586621679465798"><span class="hs-identifier hs-var hs-var">notesLeft</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[((SPitch, Int), SpreadDirection)]
</span><a href="#local-6989586621679465800"><span class="hs-identifier hs-var">dists</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679465797"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465797"><span class="hs-identifier hs-var">note</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679465796"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465796"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679465795"><span class="annot"><span class="annottext">SpreadDirection
</span><a href="#local-6989586621679465795"><span class="hs-identifier hs-var">to</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1072"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SpreadDirection
</span><a href="#local-6989586621679465795"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1073"></span><span>            </span><span class="annot"><a href="PVGrammar.html#ToRight"><span class="hs-identifier hs-type">ToRight</span></a></span><span> </span><span id="local-6989586621679465794"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465794"><span class="hs-identifier hs-var">dl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465796"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465794"><span class="hs-identifier hs-var">dl</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465797"><span class="hs-identifier hs-var">note</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1074"></span><span>            </span><span class="annot"><span class="annottext">SpreadDirection
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465797"><span class="hs-identifier hs-var">note</span></a></span><span>
</span><span id="line-1075"></span><span>        </span><span id="local-6989586621679465793"><span class="annot"><span class="annottext">notesRight :: [SPitch]
</span><a href="#local-6989586621679465793"><span class="hs-identifier hs-var hs-var">notesRight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[((SPitch, Int), SpreadDirection)]
</span><a href="#local-6989586621679465800"><span class="hs-identifier hs-var">dists</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679465792"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465792"><span class="hs-identifier hs-var">note</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679465791"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465791"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679465790"><span class="annot"><span class="annottext">SpreadDirection
</span><a href="#local-6989586621679465790"><span class="hs-identifier hs-var">to</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1076"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SpreadDirection
</span><a href="#local-6989586621679465790"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1077"></span><span>            </span><span class="annot"><a href="PVGrammar.html#ToLeft"><span class="hs-identifier hs-type">ToLeft</span></a></span><span> </span><span id="local-6989586621679465789"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465789"><span class="hs-identifier hs-var">dr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465791"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465789"><span class="hs-identifier hs-var">dr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465792"><span class="hs-identifier hs-var">note</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1078"></span><span>            </span><span class="annot"><span class="annottext">SpreadDirection
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465792"><span class="hs-identifier hs-var">note</span></a></span><span>
</span><span id="line-1079"></span><span>    </span><span class="hs-comment">-- observe repetition edges</span><span>
</span><span id="line-1080"></span><span>    </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable t, Monad m) =&gt;
t (m a) -&gt; m ()
</span><span class="hs-identifier hs-var">sequence_</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1081"></span><span>      </span><span class="hs-comment">-- List</span><span>
</span><span id="line-1082"></span><span>      </span><span id="local-6989586621679465787"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465787"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679465798"><span class="hs-identifier hs-var">notesLeft</span></a></span><span>
</span><span id="line-1083"></span><span>      </span><span id="local-6989586621679465786"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465786"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679465793"><span class="hs-identifier hs-var">notesRight</span></a></span><span>
</span><span id="line-1084"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465787"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465786"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1085"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1086"></span><span>        </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-1087"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;spreadRepeatEdge&quot;</span></span><span>
</span><span id="line-1088"></span><span>          </span><span class="annot"><span class="annottext">Bernoulli
</span><span class="hs-identifier hs-var">Bernoulli</span></span><span>
</span><span id="line-1089"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pSpreadRepetitionEdge"><span class="hs-identifier hs-var">pSpreadRepetitionEdge</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1090"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; a -&gt; HashSet a -&gt; Bool
</span><span class="hs-identifier hs-var">S.member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465787"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465786"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashSet (Edge SPitch)
</span><a href="#local-6989586621679465802"><span class="hs-identifier hs-var">repEdges</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1091"></span><span>    </span><span class="hs-comment">-- observe passing edges</span><span>
</span><span id="line-1092"></span><span>    </span><span class="annot"><span class="annottext">[SPitch]
-&gt; [SPitch]
-&gt; (forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; MultiSet (InnerEdge SPitch)
-&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observePassing"><span class="hs-identifier hs-var">observePassing</span></a></span><span> </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679465798"><span class="hs-identifier hs-var">notesLeft</span></a></span><span> </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679465793"><span class="hs-identifier hs-var">notesRight</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pNewPassingMid"><span class="hs-identifier hs-var">pNewPassingMid</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679465801"><span class="hs-identifier hs-var">passEdges</span></a></span><span>
</span><span id="line-1093"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1094"></span><span>  </span><span id="local-6989586621679465799"><span class="annot"><span class="annottext">observeNoteDist :: HashMap a SpreadDirection
-&gt; (a, Int)
-&gt; StateT
     (Trace PVParams) (Either String) ((a, Int), SpreadDirection)
</span><a href="#local-6989586621679465799"><span class="hs-identifier hs-var hs-var">observeNoteDist</span></a></span></span><span> </span><span id="local-6989586621679465739"><span class="annot"><span class="annottext">HashMap a SpreadDirection
</span><a href="#local-6989586621679465739"><span class="hs-identifier hs-var">distMap</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679465738"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679465738"><span class="hs-identifier hs-var">parent</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679465737"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465737"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HM.lookup</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679465738"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap a SpreadDirection
</span><a href="#local-6989586621679465739"><span class="hs-identifier hs-var">distMap</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1095"></span><span>    </span><span class="annot"><span class="annottext">Maybe SpreadDirection
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1096"></span><span>      </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Note &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall i. Notation i =&gt; i -&gt; String
</span><span class="hs-identifier hs-var">showNotation</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679465738"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; is not distributed.&quot;</span></span><span>
</span><span id="line-1097"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679465734"><span class="annot"><span class="annottext">SpreadDirection
</span><a href="#local-6989586621679465734"><span class="hs-identifier hs-var">dir</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1098"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SpreadDirection
</span><a href="#local-6989586621679465734"><span class="hs-identifier hs-var">dir</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1099"></span><span>        </span><span class="annot"><span class="annottext">SpreadDirection
</span><a href="PVGrammar.html#ToBoth"><span class="hs-identifier hs-var">ToBoth</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1100"></span><span>          </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-1101"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;noteSpreadDirection&quot;</span></span><span>
</span><span id="line-1102"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (n :: Nat). Categorical n
</span><span class="hs-identifier hs-var">Categorical</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span>
</span><span id="line-1103"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f (Dirichlet 3))
</span><a href="PVGrammar.Prob.Simple.html#pNoteSpreadDirection"><span class="hs-identifier hs-var">pNoteSpreadDirection</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1104"></span><span>            </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1105"></span><span>        </span><span class="annot"><a href="PVGrammar.html#ToLeft"><span class="hs-identifier hs-type">ToLeft</span></a></span><span> </span><span id="local-6989586621679465730"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465730"><span class="hs-identifier hs-var">ndiff</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1106"></span><span>          </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-1107"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;noteSpreadDirection&quot;</span></span><span>
</span><span id="line-1108"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (n :: Nat). Categorical n
</span><span class="hs-identifier hs-var">Categorical</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span>
</span><span id="line-1109"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f (Dirichlet 3))
</span><a href="PVGrammar.Prob.Simple.html#pNoteSpreadDirection"><span class="hs-identifier hs-var">pNoteSpreadDirection</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1110"></span><span>            </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1111"></span><span>          </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-1112"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;notesOnOtherSide&quot;</span></span><span>
</span><span id="line-1113"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Binomial
</span><span class="hs-identifier hs-var">Binomial</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465737"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-1114"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pNotesOnOtherSide"><span class="hs-identifier hs-var">pNotesOnOtherSide</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1115"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465737"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465730"><span class="hs-identifier hs-var">ndiff</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1116"></span><span>        </span><span class="annot"><a href="PVGrammar.html#ToRight"><span class="hs-identifier hs-type">ToRight</span></a></span><span> </span><span id="local-6989586621679465723"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465723"><span class="hs-identifier hs-var">ndiff</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1117"></span><span>          </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-1118"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;noteSpreadDirection&quot;</span></span><span>
</span><span id="line-1119"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (n :: Nat). Categorical n
</span><span class="hs-identifier hs-var">Categorical</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-number">3</span></span><span class="hs-special">)</span><span>
</span><span id="line-1120"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f (Dirichlet 3))
</span><a href="PVGrammar.Prob.Simple.html#pNoteSpreadDirection"><span class="hs-identifier hs-var">pNoteSpreadDirection</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1121"></span><span>            </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-1122"></span><span>          </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-1123"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;notesOnOtherSide&quot;</span></span><span>
</span><span id="line-1124"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Binomial
</span><span class="hs-identifier hs-var">Binomial</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465737"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-1125"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="PVGrammar.Prob.Simple.html#pNotesOnOtherSide"><span class="hs-identifier hs-var">pNotesOnOtherSide</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1126"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465737"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465723"><span class="hs-identifier hs-var">ndiff</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1127"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679465738"><span class="hs-identifier hs-var">parent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465737"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SpreadDirection
</span><a href="#local-6989586621679465734"><span class="hs-identifier hs-var">dir</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1128"></span><span>
</span><span id="line-1129"></span><span id="local-6989586621679465716"><span class="annot"><a href="PVGrammar.Prob.Simple.html#samplePassing"><span class="hs-identifier hs-type">samplePassing</span></a></span><span>
</span><span id="line-1130"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span>
</span><span id="line-1131"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span>
</span><span id="line-1132"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span>
</span><span id="line-1133"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Accessor</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-1134"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679465716"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Internal.MultiSet.html#MultiSet"><span class="hs-identifier hs-type">MS.MultiSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#InnerEdge"><span class="hs-identifier hs-type">InnerEdge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-1135"></span><span id="samplePassing"><span class="annot"><span class="annottext">samplePassing :: [SPitch]
-&gt; [SPitch]
-&gt; (forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; m (MultiSet (InnerEdge SPitch))
</span><a href="PVGrammar.Prob.Simple.html#samplePassing"><span class="hs-identifier hs-var hs-var">samplePassing</span></a></span></span><span> </span><span id="local-6989586621679465674"><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679465674"><span class="hs-identifier hs-var">notesLeft</span></a></span></span><span> </span><span id="local-6989586621679465673"><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679465673"><span class="hs-identifier hs-var">notesRight</span></a></span></span><span> </span><span id="local-6989586621679465672"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="#local-6989586621679465672"><span class="hs-identifier hs-var">pNewPassing</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1136"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a.
(Foldable t, Eq a, Hashable a) =&gt;
t a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#fromList"><span class="hs-identifier hs-var">MS.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Traversable t, Monad m) =&gt;
t (m a) -&gt; m (t a)
</span><span class="hs-identifier hs-var">sequence</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1137"></span><span>    </span><span class="hs-comment">-- List</span><span>
</span><span id="line-1138"></span><span>    </span><span class="hs-comment">-- DT.traceM $ &quot;notesLeft (smp)&quot; &lt;&gt; show notesLeft</span><span>
</span><span id="line-1139"></span><span>    </span><span class="hs-comment">-- DT.traceM $ &quot;notesRight (smp)&quot; &lt;&gt; show notesRight</span><span>
</span><span id="line-1140"></span><span>    </span><span id="local-6989586621679465669"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465669"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679465674"><span class="hs-identifier hs-var">notesLeft</span></a></span><span>
</span><span id="line-1141"></span><span>    </span><span id="local-6989586621679465668"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465668"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679465673"><span class="hs-identifier hs-var">notesRight</span></a></span><span>
</span><span id="line-1142"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679465667"><span class="annot"><span class="annottext">step :: SIC
</span><a href="#local-6989586621679465667"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i -&gt; i
</span><span class="hs-identifier hs-var">iabs</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465669"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465668"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1143"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SIC
</span><a href="#local-6989586621679465667"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SIC
</span><a href="#local-6989586621679465667"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">alteration</span></span><span> </span><span class="annot"><span class="annottext">SIC
</span><a href="#local-6989586621679465667"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-1144"></span><span>    </span><span class="hs-comment">-- DT.traceM $ &quot;parent edge (sample)&quot; &lt;&gt; show (l, r)</span><span>
</span><span id="line-1145"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1146"></span><span>      </span><span class="hs-comment">-- m</span><span>
</span><span id="line-1147"></span><span>      </span><span id="local-6989586621679465664"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465664"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *) p l.
(RandomInterpreter m r, Conjugate p l, SampleCtx m l) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; m (Support l)
</span><span class="hs-identifier hs-var">sampleValue</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;newPassing&quot;</span></span><span> </span><span class="annot"><span class="annottext">Geometric0
</span><span class="hs-identifier hs-var">Geometric0</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="#local-6989586621679465672"><span class="hs-identifier hs-var">pNewPassing</span></a></span><span>
</span><span id="line-1148"></span><span>      </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679465664"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465669"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465668"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1149"></span><span>
</span><span id="line-1150"></span><span class="annot"><a href="PVGrammar.Prob.Simple.html#observePassing"><span class="hs-identifier hs-type">observePassing</span></a></span><span>
</span><span id="line-1151"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span>
</span><span id="line-1152"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">]</span><span>
</span><span id="line-1153"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Accessor</span></span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVParamsInner"><span class="hs-identifier hs-type">PVParamsInner</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Beta</span></span><span>
</span><span id="line-1154"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Internal.MultiSet.html#MultiSet"><span class="hs-identifier hs-type">MS.MultiSet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#InnerEdge"><span class="hs-identifier hs-type">InnerEdge</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SPitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-1155"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.Prob.Simple.html#PVObs"><span class="hs-identifier hs-type">PVObs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1156"></span><span id="observePassing"><span class="annot"><span class="annottext">observePassing :: [SPitch]
-&gt; [SPitch]
-&gt; (forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta))
-&gt; MultiSet (InnerEdge SPitch)
-&gt; PVObs ()
</span><a href="PVGrammar.Prob.Simple.html#observePassing"><span class="hs-identifier hs-var hs-var">observePassing</span></a></span></span><span> </span><span id="local-6989586621679465659"><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679465659"><span class="hs-identifier hs-var">notesLeft</span></a></span></span><span> </span><span id="local-6989586621679465658"><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679465658"><span class="hs-identifier hs-var">notesRight</span></a></span></span><span> </span><span id="local-6989586621679465657"><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="#local-6989586621679465657"><span class="hs-identifier hs-var">pNewPassing</span></a></span></span><span> </span><span id="local-6989586621679465656"><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679465656"><span class="hs-identifier hs-var">edges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable t, Monad m) =&gt;
t (m a) -&gt; m ()
</span><span class="hs-identifier hs-var">sequence_</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1157"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;edges (obs)&quot; &lt;&gt; show edges</span><span>
</span><span id="line-1158"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;notesLeft (obs)&quot; &lt;&gt; show notesLeft</span><span>
</span><span id="line-1159"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;notesRight (obs)&quot; &lt;&gt; show notesRight</span><span>
</span><span id="line-1160"></span><span>  </span><span id="local-6989586621679465655"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465655"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679465659"><span class="hs-identifier hs-var">notesLeft</span></a></span><span>
</span><span id="line-1161"></span><span>  </span><span id="local-6989586621679465654"><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465654"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SPitch]
</span><a href="#local-6989586621679465658"><span class="hs-identifier hs-var">notesRight</span></a></span><span>
</span><span id="line-1162"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679465653"><span class="annot"><span class="annottext">step :: SIC
</span><a href="#local-6989586621679465653"><span class="hs-identifier hs-var hs-var">step</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall i. Interval i =&gt; i -&gt; i
</span><span class="hs-identifier hs-var">iabs</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465655"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">forall {v}. AdditiveGroup v =&gt; Pitch v -&gt; Pitch v -&gt; v
</span><span class="hs-operator hs-var">`pto`</span></span><span> </span><span class="annot"><span class="annottext">forall p. Interval p =&gt; Pitch p -&gt; Pitch (ICOf p)
</span><span class="hs-identifier hs-var">pc</span></span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465654"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1163"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SIC
</span><a href="#local-6989586621679465653"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">degree</span></span><span> </span><span class="annot"><span class="annottext">SIC
</span><a href="#local-6989586621679465653"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall i. Spelled i =&gt; i -&gt; Int
</span><span class="hs-identifier hs-var">alteration</span></span><span> </span><span class="annot"><span class="annottext">SIC
</span><a href="#local-6989586621679465653"><span class="hs-identifier hs-var">step</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-1164"></span><span>  </span><span class="hs-comment">-- DT.traceM $ &quot;parent edge (obs)&quot; &lt;&gt; show (l, r)</span><span>
</span><span id="line-1165"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1166"></span><span>    </span><span class="annot"><span class="annottext">forall p l (m :: * -&gt; *) (r :: (* -&gt; *) -&gt; *).
(Conjugate p l, Typeable (Support l), Monad m) =&gt;
String -&gt; l -&gt; Accessor r p -&gt; Support l -&gt; StateT (Trace r) m ()
</span><span class="hs-identifier hs-var">observeValue</span></span><span>
</span><span id="line-1167"></span><span>      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;newPassing&quot;</span></span><span>
</span><span id="line-1168"></span><span>      </span><span class="annot"><span class="annottext">Geometric0
</span><span class="hs-identifier hs-var">Geometric0</span></span><span>
</span><span id="line-1169"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParams f) (PVParamsInner f)
</span><a href="PVGrammar.Prob.Simple.html#pInner"><span class="hs-identifier hs-var">pInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Lens' (PVParamsInner f) (f Beta)
</span><a href="#local-6989586621679465657"><span class="hs-identifier hs-var">pNewPassing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1170"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MultiSet (InnerEdge SPitch)
</span><a href="#local-6989586621679465656"><span class="hs-identifier hs-var">edges</span></a></span><span> </span><span class="annot"><span class="annottext">forall k. (Eq k, Hashable k) =&gt; MultiSet k -&gt; k -&gt; Int
</span><a href="Internal.MultiSet.html#%21"><span class="hs-operator hs-var">MS.!</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465655"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SPitch
</span><a href="#local-6989586621679465654"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1171"></span></pre></body></html>