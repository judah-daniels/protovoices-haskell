<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-comment">{- | This module contains functions for the generative aspects of protovoice derivations:

 - manually constructing protovoice operations (see &quot;PVGrammar&quot;) using a monadic interface
 - applying (&quot;replaying&quot;) these operations.
-}</span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">PVGrammar.Generate</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Manually Constructing Derivations</span></span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span>    </span><span class="hs-comment">-- | The functions in this section can be used</span><span>
</span><span id="line-12"></span><span>    </span><span class="hs-comment">-- to manually construct individual derivation operations</span><span>
</span><span id="line-13"></span><span>    </span><span class="hs-comment">-- or in conjunction with the (indexed-)monadic functions in &quot;Common&quot; (see 'Common.buildDerivation')</span><span>
</span><span id="line-14"></span><span>    </span><span class="hs-comment">-- to manually construct complete derivations.</span><span>
</span><span id="line-15"></span><span>    </span><span class="hs-comment">-- Each outer-structure operation ('mkSplit', 'mkSpread', 'mkFreeze') enters a writer monad</span><span>
</span><span id="line-16"></span><span>    </span><span class="hs-comment">-- in which inner-structure operations can be chained to determine the details.</span><span>
</span><span id="line-17"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-18"></span><span>    </span><span class="hs-comment">-- Note that the legality of the operations is not always checked, so be careful!</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Freeze</span></span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="PVGrammar.Generate.html#mkFreeze"><span class="hs-identifier">mkFreeze</span></a></span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Split</span></span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#mkSplit"><span class="hs-identifier">mkSplit</span></a></span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#splitRegular"><span class="hs-identifier">splitRegular</span></a></span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#splitPassing"><span class="hs-identifier">splitPassing</span></a></span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#addToLeft"><span class="hs-identifier">addToLeft</span></a></span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#addToRight"><span class="hs-identifier">addToRight</span></a></span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#addPassingLeft"><span class="hs-identifier">addPassingLeft</span></a></span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#addPassingRight"><span class="hs-identifier">addPassingRight</span></a></span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Spread</span></span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#mkSpread"><span class="hs-identifier">mkSpread</span></a></span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#spreadNote"><span class="hs-identifier">spreadNote</span></a></span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#addPassing"><span class="hs-identifier">addPassing</span></a></span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#addOctaveRepetition"><span class="hs-identifier">addOctaveRepetition</span></a></span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Derivation Players</span></span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-comment">-- | These players can be used with the replay functions in the &quot;Display&quot; module</span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-comment">-- to obtain derivation graphs for protovoice derivations.</span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#derivationPlayerPV"><span class="hs-identifier">derivationPlayerPV</span></a></span><span>
</span><span id="line-43"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#derivationPlayerPVAllEdges"><span class="hs-identifier">derivationPlayerPVAllEdges</span></a></span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Applying Operations</span></span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><span class="hs-comment">-- | Apply operations to parent objects and get the resulting child objects.</span></span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#applySplit"><span class="hs-identifier">applySplit</span></a></span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#applySplitAllEdges"><span class="hs-identifier">applySplitAllEdges</span></a></span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#applyFreeze"><span class="hs-identifier">applyFreeze</span></a></span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#applySpread"><span class="hs-identifier">applySpread</span></a></span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#freezable"><span class="hs-identifier">freezable</span></a></span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Utility Functions</span></span><span>
</span><span id="line-55"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#debugPVAnalysis"><span class="hs-identifier">debugPVAnalysis</span></a></span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.Generate.html#checkDerivation"><span class="hs-identifier">checkDerivation</span></a></span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Common.html"><span class="hs-identifier">Common</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Display.html"><span class="hs-identifier">Display</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PVGrammar.html"><span class="hs-identifier">PVGrammar</span></a></span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Musicology.Pitch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Notation</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">foldM</span></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Writer.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MW</span></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">bimap</span></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">toList</span></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HM</span></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashSet</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hashable</span></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Monoid</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Endo</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Internal.MultiSet.html"><span class="hs-identifier">Internal.MultiSet</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MS</span></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Musicology.Core</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MC</span></span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">HasPitch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">pitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Pitched</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">IntervalOf</span></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span class="hs-comment">-- building operations</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- ===================</span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="hs-comment">{- | Create a freeze operation (alias for 'FreezeOp').
 Can be used together with the 'Common.freeze' action within a monadic derivation.
-}</span><span>
</span><span id="line-87"></span><span class="annot"><a href="PVGrammar.Generate.html#mkFreeze"><span class="hs-identifier hs-type">mkFreeze</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span>
</span><span id="line-88"></span><span id="mkFreeze"><span class="annot"><span class="annottext">mkFreeze :: Freeze
</span><a href="PVGrammar.Generate.html#mkFreeze"><span class="hs-identifier hs-var hs-var">mkFreeze</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Freeze
</span><a href="PVGrammar.html#FreezeOp"><span class="hs-identifier hs-var">FreezeOp</span></a></span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="hs-comment">{- | Create a split operation monadically

 &gt; mkSplit $ do
 &gt;   ... -- internal split actions

 Can be used together with the 'Common.split' action within a monadic derivation.
-}</span><span>
</span><span id="line-97"></span><span id="local-6989586621679520557"><span id="local-6989586621679520559"><span class="annot"><a href="PVGrammar.Generate.html#mkSplit"><span class="hs-identifier hs-type">mkSplit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MW.Writer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520559"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679520557"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520559"><span class="hs-identifier hs-type">n</span></a></span></span></span><span>
</span><span id="line-98"></span><span id="mkSplit"><span class="annot"><span class="annottext">mkSplit :: forall n a. Writer (Split n) a -&gt; Split n
</span><a href="PVGrammar.Generate.html#mkSplit"><span class="hs-identifier hs-var hs-var">mkSplit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall w a. Writer w a -&gt; w
</span><span class="hs-identifier hs-var">MW.execWriter</span></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="hs-comment">-- | During a split, split an existing regular edge between two notes.</span><span>
</span><span id="line-101"></span><span id="local-6989586621679520553"><span class="annot"><a href="PVGrammar.Generate.html#splitRegular"><span class="hs-identifier hs-type">splitRegular</span></a></span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679520553"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679520553"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Common.html#StartStop"><span class="hs-identifier hs-type">StartStop</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520553"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-comment">-- ^ left parent</span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.html#StartStop"><span class="hs-identifier hs-type">StartStop</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520553"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-comment">-- ^ right parent</span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679520553"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-comment">-- ^ the new child note</span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#DoubleOrnament"><span class="hs-identifier hs-type">DoubleOrnament</span></a></span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-comment">-- ^ the ornament type of the child note</span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-comment">-- ^ keep the left child edge (left parent to child)?</span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-114"></span><span>  </span><span class="hs-comment">-- ^ keep the right child edge (child to right parent)?</span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MW.Writer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520553"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-116"></span><span id="splitRegular"><span class="annot"><span class="annottext">splitRegular :: forall n.
(Ord n, Hashable n) =&gt;
StartStop n
-&gt; StartStop n
-&gt; n
-&gt; DoubleOrnament
-&gt; Bool
-&gt; Bool
-&gt; Writer (Split n) ()
</span><a href="PVGrammar.Generate.html#splitRegular"><span class="hs-identifier hs-var hs-var">splitRegular</span></a></span></span><span> </span><span id="local-6989586621679520265"><span class="annot"><span class="annottext">StartStop n
</span><a href="#local-6989586621679520265"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679520264"><span class="annot"><span class="annottext">StartStop n
</span><a href="#local-6989586621679520264"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621679520263"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520263"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679520262"><span class="annot"><span class="annottext">DoubleOrnament
</span><a href="#local-6989586621679520262"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span id="local-6989586621679520261"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679520261"><span class="hs-identifier hs-var">kl</span></a></span></span><span> </span><span id="local-6989586621679520260"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679520260"><span class="hs-identifier hs-var">kr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-117"></span><span>  </span><span class="annot"><span class="annottext">forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">MW.tell</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-118"></span><span>    </span><span class="annot"><span class="annottext">forall n.
Map (Edge n) [(n, DoubleOrnament)]
-&gt; Map (InnerEdge n) [(n, PassingOrnament)]
-&gt; Map n [(n, RightOrnament)]
-&gt; Map n [(n, LeftOrnament)]
-&gt; HashSet (Edge n)
-&gt; HashSet (Edge n)
-&gt; MultiSet (InnerEdge n)
-&gt; MultiSet (InnerEdge n)
-&gt; Split n
</span><a href="PVGrammar.html#SplitOp"><span class="hs-identifier hs-var">SplitOp</span></a></span><span>
</span><span id="line-119"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop n
</span><a href="#local-6989586621679520265"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop n
</span><a href="#local-6989586621679520264"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520263"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DoubleOrnament
</span><a href="#local-6989586621679520262"><span class="hs-identifier hs-var">o</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>      </span><span class="annot"><span class="annottext">forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-121"></span><span>      </span><span class="annot"><span class="annottext">forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-122"></span><span>      </span><span class="annot"><span class="annottext">forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-123"></span><span>      </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679520255"><span class="hs-identifier hs-var">kls</span></a></span><span>
</span><span id="line-124"></span><span>      </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679520254"><span class="hs-identifier hs-var">krs</span></a></span><span>
</span><span id="line-125"></span><span>      </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span>
</span><span id="line-126"></span><span>      </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span>
</span><span id="line-127"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-128"></span><span>  </span><span id="local-6989586621679520255"><span class="annot"><span class="annottext">kls :: HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679520255"><span class="hs-identifier hs-var hs-var">kls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679520261"><span class="hs-identifier hs-var">kl</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StartStop n
</span><a href="#local-6989586621679520265"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520263"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. HashSet a
</span><span class="hs-identifier hs-var">S.empty</span></span><span>
</span><span id="line-129"></span><span>  </span><span id="local-6989586621679520254"><span class="annot"><span class="annottext">krs :: HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679520254"><span class="hs-identifier hs-var hs-var">krs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679520260"><span class="hs-identifier hs-var">kr</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520263"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StartStop n
</span><a href="#local-6989586621679520264"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. HashSet a
</span><span class="hs-identifier hs-var">S.empty</span></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="hs-comment">-- | During a split, split an existing passing edge, introducing a new passing note.</span><span>
</span><span id="line-132"></span><span id="local-6989586621679520517"><span class="annot"><a href="PVGrammar.Generate.html#splitPassing"><span class="hs-identifier hs-type">splitPassing</span></a></span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679520517"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679520517"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679520517"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-comment">-- ^ left parent</span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679520517"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-comment">-- ^ right parent</span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679520517"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-comment">-- ^ the new child note</span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#PassingOrnament"><span class="hs-identifier hs-type">PassingOrnament</span></a></span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-comment">-- ^ the ornament type of the child note</span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-comment">-- ^ keep the left child edge (if step)</span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-comment">-- ^ keep the right child edge (if step)</span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MW.Writer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520517"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-147"></span><span id="splitPassing"><span class="annot"><span class="annottext">splitPassing :: forall n.
(Ord n, Hashable n) =&gt;
n
-&gt; n -&gt; n -&gt; PassingOrnament -&gt; Bool -&gt; Bool -&gt; Writer (Split n) ()
</span><a href="PVGrammar.Generate.html#splitPassing"><span class="hs-identifier hs-var hs-var">splitPassing</span></a></span></span><span> </span><span id="local-6989586621679520237"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520237"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679520236"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520236"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621679520235"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520235"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679520234"><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679520234"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span id="local-6989586621679520233"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679520233"><span class="hs-identifier hs-var">kl</span></a></span></span><span> </span><span id="local-6989586621679520232"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679520232"><span class="hs-identifier hs-var">kr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-148"></span><span>  </span><span class="annot"><span class="annottext">forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">MW.tell</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-149"></span><span>    </span><span class="annot"><span class="annottext">forall n.
Map (Edge n) [(n, DoubleOrnament)]
-&gt; Map (InnerEdge n) [(n, PassingOrnament)]
-&gt; Map n [(n, RightOrnament)]
-&gt; Map n [(n, LeftOrnament)]
-&gt; HashSet (Edge n)
-&gt; HashSet (Edge n)
-&gt; MultiSet (InnerEdge n)
-&gt; MultiSet (InnerEdge n)
-&gt; Split n
</span><a href="PVGrammar.html#SplitOp"><span class="hs-identifier hs-var">SplitOp</span></a></span><span>
</span><span id="line-150"></span><span>      </span><span class="annot"><span class="annottext">forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-151"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520237"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520236"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520235"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679520234"><span class="hs-identifier hs-var">o</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>      </span><span class="annot"><span class="annottext">forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-153"></span><span>      </span><span class="annot"><span class="annottext">forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-154"></span><span>      </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679520231"><span class="hs-identifier hs-var">kls</span></a></span><span>
</span><span id="line-155"></span><span>      </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679520230"><span class="hs-identifier hs-var">krs</span></a></span><span>
</span><span id="line-156"></span><span>      </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span>
</span><span id="line-157"></span><span>      </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span>
</span><span id="line-158"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-159"></span><span>  </span><span id="local-6989586621679520231"><span class="annot"><span class="annottext">kls :: HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679520231"><span class="hs-identifier hs-var hs-var">kls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679520234"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="PVGrammar.html#PassingRight"><span class="hs-identifier hs-var">PassingRight</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679520233"><span class="hs-identifier hs-var">kl</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520237"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520235"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. HashSet a
</span><span class="hs-identifier hs-var">S.empty</span></span><span>
</span><span id="line-161"></span><span>  </span><span id="local-6989586621679520230"><span class="annot"><span class="annottext">krs :: HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679520230"><span class="hs-identifier hs-var hs-var">krs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679520234"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="PVGrammar.html#PassingLeft"><span class="hs-identifier hs-var">PassingLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679520232"><span class="hs-identifier hs-var">kr</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520235"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520236"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. HashSet a
</span><span class="hs-identifier hs-var">S.empty</span></span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span class="hs-comment">-- | During a split, add a new single-sided ornament to a left parent note.</span><span>
</span><span id="line-165"></span><span id="local-6989586621679520514"><span class="annot"><a href="PVGrammar.Generate.html#addToLeft"><span class="hs-identifier hs-type">addToLeft</span></a></span><span>
</span><span id="line-166"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679520514"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679520514"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679520514"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-comment">-- ^ parent (from the left slice)</span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679520514"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-comment">-- ^ the new child note</span><span>
</span><span id="line-171"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#RightOrnament"><span class="hs-identifier hs-type">RightOrnament</span></a></span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-comment">-- ^ the new child note's ornament type</span><span>
</span><span id="line-173"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-174"></span><span>  </span><span class="hs-comment">-- ^ keep the new edge?</span><span>
</span><span id="line-175"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MW.Writer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520514"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-176"></span><span id="addToLeft"><span class="annot"><span class="annottext">addToLeft :: forall n.
(Ord n, Hashable n) =&gt;
n -&gt; n -&gt; RightOrnament -&gt; Bool -&gt; Writer (Split n) ()
</span><a href="PVGrammar.Generate.html#addToLeft"><span class="hs-identifier hs-var hs-var">addToLeft</span></a></span></span><span> </span><span id="local-6989586621679520217"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520217"><span class="hs-identifier hs-var">parent</span></a></span></span><span> </span><span id="local-6989586621679520216"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520216"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span id="local-6989586621679520215"><span class="annot"><span class="annottext">RightOrnament
</span><a href="#local-6989586621679520215"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621679520214"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679520214"><span class="hs-identifier hs-var">keep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-177"></span><span>  </span><span class="annot"><span class="annottext">forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">MW.tell</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-178"></span><span>    </span><span class="annot"><span class="annottext">forall n.
Map (Edge n) [(n, DoubleOrnament)]
-&gt; Map (InnerEdge n) [(n, PassingOrnament)]
-&gt; Map n [(n, RightOrnament)]
-&gt; Map n [(n, LeftOrnament)]
-&gt; HashSet (Edge n)
-&gt; HashSet (Edge n)
-&gt; MultiSet (InnerEdge n)
-&gt; MultiSet (InnerEdge n)
-&gt; Split n
</span><a href="PVGrammar.html#SplitOp"><span class="hs-identifier hs-var">SplitOp</span></a></span><span>
</span><span id="line-179"></span><span>      </span><span class="annot"><span class="annottext">forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-180"></span><span>      </span><span class="annot"><span class="annottext">forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-181"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520217"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520216"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RightOrnament
</span><a href="#local-6989586621679520215"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>      </span><span class="annot"><span class="annottext">forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-183"></span><span>      </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679520214"><span class="hs-identifier hs-var">keep</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520217"><span class="hs-identifier hs-var">parent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520216"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. HashSet a
</span><span class="hs-identifier hs-var">S.empty</span></span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span>      </span><span class="annot"><span class="annottext">forall a. HashSet a
</span><span class="hs-identifier hs-var">S.empty</span></span><span>
</span><span id="line-185"></span><span>      </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span>
</span><span id="line-186"></span><span>      </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span class="hs-comment">-- | During a split, add a new single-sided ornament to a right parent note.</span><span>
</span><span id="line-189"></span><span id="local-6989586621679520512"><span class="annot"><a href="PVGrammar.Generate.html#addToRight"><span class="hs-identifier hs-type">addToRight</span></a></span><span>
</span><span id="line-190"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679520512"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679520512"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679520512"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-192"></span><span>  </span><span class="hs-comment">-- ^ parent (from the right slice)</span><span>
</span><span id="line-193"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679520512"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-194"></span><span>  </span><span class="hs-comment">-- ^ the new child note</span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#LeftOrnament"><span class="hs-identifier hs-type">LeftOrnament</span></a></span><span>
</span><span id="line-196"></span><span>  </span><span class="hs-comment">-- ^ the new child note's ornament type</span><span>
</span><span id="line-197"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-198"></span><span>  </span><span class="hs-comment">-- ^ keep the new edge?</span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MW.Writer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520512"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-200"></span><span id="addToRight"><span class="annot"><span class="annottext">addToRight :: forall n.
(Ord n, Hashable n) =&gt;
n -&gt; n -&gt; LeftOrnament -&gt; Bool -&gt; Writer (Split n) ()
</span><a href="PVGrammar.Generate.html#addToRight"><span class="hs-identifier hs-var hs-var">addToRight</span></a></span></span><span> </span><span id="local-6989586621679520205"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520205"><span class="hs-identifier hs-var">parent</span></a></span></span><span> </span><span id="local-6989586621679520204"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520204"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span id="local-6989586621679520203"><span class="annot"><span class="annottext">LeftOrnament
</span><a href="#local-6989586621679520203"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621679520202"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679520202"><span class="hs-identifier hs-var">keep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-201"></span><span>  </span><span class="annot"><span class="annottext">forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">MW.tell</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-202"></span><span>    </span><span class="annot"><span class="annottext">forall n.
Map (Edge n) [(n, DoubleOrnament)]
-&gt; Map (InnerEdge n) [(n, PassingOrnament)]
-&gt; Map n [(n, RightOrnament)]
-&gt; Map n [(n, LeftOrnament)]
-&gt; HashSet (Edge n)
-&gt; HashSet (Edge n)
-&gt; MultiSet (InnerEdge n)
-&gt; MultiSet (InnerEdge n)
-&gt; Split n
</span><a href="PVGrammar.html#SplitOp"><span class="hs-identifier hs-var">SplitOp</span></a></span><span>
</span><span id="line-203"></span><span>      </span><span class="annot"><span class="annottext">forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-204"></span><span>      </span><span class="annot"><span class="annottext">forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-205"></span><span>      </span><span class="annot"><span class="annottext">forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span>
</span><span id="line-206"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520205"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520204"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LeftOrnament
</span><a href="#local-6989586621679520203"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>      </span><span class="annot"><span class="annottext">forall a. HashSet a
</span><span class="hs-identifier hs-var">S.empty</span></span><span>
</span><span id="line-208"></span><span>      </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679520202"><span class="hs-identifier hs-var">keep</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520204"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520205"><span class="hs-identifier hs-var">parent</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. HashSet a
</span><span class="hs-identifier hs-var">S.empty</span></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>      </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span>
</span><span id="line-210"></span><span>      </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span>
</span><span id="line-211"></span><span>
</span><span id="line-212"></span><span class="hs-comment">-- | During a split, add a new passing edge between the left parent slice and the child slice.</span><span>
</span><span id="line-213"></span><span id="local-6989586621679520510"><span class="annot"><a href="PVGrammar.Generate.html#addPassingLeft"><span class="hs-identifier hs-type">addPassingLeft</span></a></span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679520510"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679520510"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679520510"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-216"></span><span>  </span><span class="hs-comment">-- ^ note from the left parent slice</span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679520510"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-218"></span><span>  </span><span class="hs-comment">-- ^ note from the child slice</span><span>
</span><span id="line-219"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MW.Writer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520510"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-220"></span><span id="addPassingLeft"><span class="annot"><span class="annottext">addPassingLeft :: forall n. (Ord n, Hashable n) =&gt; n -&gt; n -&gt; Writer (Split n) ()
</span><a href="PVGrammar.Generate.html#addPassingLeft"><span class="hs-identifier hs-var hs-var">addPassingLeft</span></a></span></span><span> </span><span id="local-6989586621679520194"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520194"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679520193"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520193"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">MW.tell</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">{</span><span class="annot"><span class="annottext">passLeft :: MultiSet (InnerEdge n)
</span><a href="PVGrammar.html#passLeft"><span class="hs-identifier hs-var">passLeft</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#singleton"><span class="hs-identifier hs-var">MS.singleton</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520194"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520193"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span class="hs-comment">-- | During a split, add a new passing edge between the child slice and the right parent slice.</span><span>
</span><span id="line-223"></span><span id="local-6989586621679520190"><span class="annot"><a href="PVGrammar.Generate.html#addPassingRight"><span class="hs-identifier hs-type">addPassingRight</span></a></span><span>
</span><span id="line-224"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679520190"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679520190"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679520190"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-226"></span><span>  </span><span class="hs-comment">-- ^ note from the child slice</span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679520190"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-228"></span><span>  </span><span class="hs-comment">-- ^ note from the right parent slice</span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MW.Writer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520190"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-230"></span><span id="addPassingRight"><span class="annot"><span class="annottext">addPassingRight :: forall n. (Ord n, Hashable n) =&gt; n -&gt; n -&gt; Writer (Split n) ()
</span><a href="PVGrammar.Generate.html#addPassingRight"><span class="hs-identifier hs-var hs-var">addPassingRight</span></a></span></span><span> </span><span id="local-6989586621679520182"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520182"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621679520181"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520181"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">MW.tell</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">{</span><span class="annot"><span class="annottext">passRight :: MultiSet (InnerEdge n)
</span><a href="PVGrammar.html#passRight"><span class="hs-identifier hs-var">passRight</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#singleton"><span class="hs-identifier hs-var">MS.singleton</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520182"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520181"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span class="hs-comment">{- | Create a spread operation monadically

 &gt; mkSpread $ do
 &gt;   ... -- internal spread actions

 Can be used together with the 'Common.spread' action within a monadic derivation.
-}</span><span>
</span><span id="line-239"></span><span id="local-6989586621679520505"><span class="annot"><a href="PVGrammar.Generate.html#mkSpread"><span class="hs-identifier hs-type">mkSpread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MW.Writer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Endo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520505"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520505"><span class="hs-identifier hs-type">n</span></a></span></span><span>
</span><span id="line-240"></span><span id="mkSpread"><span class="annot"><span class="annottext">mkSpread :: forall n. Writer (Endo (Spread n)) () -&gt; Spread n
</span><a href="PVGrammar.Generate.html#mkSpread"><span class="hs-identifier hs-var hs-var">mkSpread</span></a></span></span><span> </span><span id="local-6989586621679520179"><span class="annot"><span class="annottext">Writer (Endo (Spread n)) ()
</span><a href="#local-6989586621679520179"><span class="hs-identifier hs-var">actions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Endo a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">appEndo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall w a. Writer w a -&gt; w
</span><span class="hs-identifier hs-var">MW.execWriter</span></span><span> </span><span class="annot"><span class="annottext">Writer (Endo (Spread n)) ()
</span><a href="#local-6989586621679520179"><span class="hs-identifier hs-var">actions</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall {n}. Spread n
</span><a href="#local-6989586621679520177"><span class="hs-identifier hs-var">emptySpread</span></a></span><span>
</span><span id="line-241"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-242"></span><span>  </span><span id="local-6989586621679520177"><span class="annot"><span class="annottext">emptySpread :: Spread n
</span><a href="#local-6989586621679520177"><span class="hs-identifier hs-var hs-var">emptySpread</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall n. HashMap n SpreadDirection -&gt; Edges n -&gt; Spread n
</span><a href="PVGrammar.html#SpreadOp"><span class="hs-identifier hs-var">SpreadOp</span></a></span><span> </span><span class="annot"><span class="annottext">forall k v. HashMap k v
</span><span class="hs-identifier hs-var">HM.empty</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall n. HashSet (Edge n) -&gt; MultiSet (InnerEdge n) -&gt; Edges n
</span><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-var">Edges</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. HashSet a
</span><span class="hs-identifier hs-var">S.empty</span></span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span class="hs-comment">-- | During a spread, distribute one of the parent notes to the child slices of a spread.</span><span>
</span><span id="line-245"></span><span id="local-6989586621679520492"><span class="annot"><a href="PVGrammar.Generate.html#spreadNote"><span class="hs-identifier hs-type">spreadNote</span></a></span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679520492"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679520492"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679520492"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-comment">-- ^ the parent note</span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#SpreadDirection"><span class="hs-identifier hs-type">SpreadDirection</span></a></span><span>
</span><span id="line-250"></span><span>  </span><span class="hs-comment">-- ^ the distribution of the note</span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-252"></span><span>  </span><span class="hs-comment">-- ^ introduce a repetition edge (if possible)?</span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MW.Writer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Endo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520492"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-254"></span><span id="spreadNote"><span class="annot"><span class="annottext">spreadNote :: forall n.
(Ord n, Hashable n) =&gt;
n -&gt; SpreadDirection -&gt; Bool -&gt; Writer (Endo (Spread n)) ()
</span><a href="PVGrammar.Generate.html#spreadNote"><span class="hs-identifier hs-var hs-var">spreadNote</span></a></span></span><span> </span><span id="local-6989586621679520154"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520154"><span class="hs-identifier hs-var">pitch</span></a></span></span><span> </span><span id="local-6989586621679520153"><span class="annot"><span class="annottext">SpreadDirection
</span><a href="#local-6989586621679520153"><span class="hs-identifier hs-var">dir</span></a></span></span><span> </span><span id="local-6989586621679520152"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679520152"><span class="hs-identifier hs-var">edge</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">MW.tell</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; a) -&gt; Endo a
</span><span class="hs-identifier hs-var">Endo</span></span><span> </span><span class="annot"><span class="annottext">Spread n -&gt; Spread n
</span><a href="#local-6989586621679520150"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-255"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-256"></span><span>  </span><span id="local-6989586621679520150"><span class="annot"><span class="annottext">h :: Spread n -&gt; Spread n
</span><a href="#local-6989586621679520150"><span class="hs-identifier hs-var hs-var">h</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#SpreadOp"><span class="hs-identifier hs-type">SpreadOp</span></a></span><span> </span><span id="local-6989586621679520149"><span class="annot"><span class="annottext">HashMap n SpreadDirection
</span><a href="#local-6989586621679520149"><span class="hs-identifier hs-var">dist</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span id="local-6989586621679520148"><span class="annot"><span class="annottext">HashSet (Edge n)
</span><a href="#local-6989586621679520148"><span class="hs-identifier hs-var">mRegs</span></a></span></span><span> </span><span id="local-6989586621679520147"><span class="annot"><span class="annottext">MultiSet (InnerEdge n)
</span><a href="#local-6989586621679520147"><span class="hs-identifier hs-var">mPassings</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall n. HashMap n SpreadDirection -&gt; Edges n -&gt; Spread n
</span><a href="PVGrammar.html#SpreadOp"><span class="hs-identifier hs-var">SpreadOp</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap n SpreadDirection
</span><a href="#local-6989586621679520146"><span class="hs-identifier hs-var">dist'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall n. HashSet (Edge n) -&gt; MultiSet (InnerEdge n) -&gt; Edges n
</span><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-var">Edges</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge n)
</span><a href="#local-6989586621679520145"><span class="hs-identifier hs-var">mRegs'</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge n)
</span><a href="#local-6989586621679520147"><span class="hs-identifier hs-var">mPassings</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-258"></span><span>    </span><span id="local-6989586621679520146"><span class="annot"><span class="annottext">dist' :: HashMap n SpreadDirection
</span><a href="#local-6989586621679520146"><span class="hs-identifier hs-var hs-var">dist'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">HM.insert</span></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520154"><span class="hs-identifier hs-var">pitch</span></a></span><span> </span><span class="annot"><span class="annottext">SpreadDirection
</span><a href="#local-6989586621679520153"><span class="hs-identifier hs-var">dir</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap n SpreadDirection
</span><a href="#local-6989586621679520149"><span class="hs-identifier hs-var">dist</span></a></span><span>
</span><span id="line-259"></span><span>    </span><span id="local-6989586621679520145"><span class="annot"><span class="annottext">mRegs' :: HashSet (Edge n)
</span><a href="#local-6989586621679520145"><span class="hs-identifier hs-var hs-var">mRegs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-260"></span><span>      </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; HashSet a -&gt; HashSet a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.union</span></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge n)
</span><a href="#local-6989586621679520148"><span class="hs-identifier hs-var">mRegs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-261"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679520152"><span class="hs-identifier hs-var">edge</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520154"><span class="hs-identifier hs-var">pitch</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520154"><span class="hs-identifier hs-var">pitch</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. HashSet a
</span><span class="hs-identifier hs-var">S.empty</span></span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span class="hs-comment">-- | During a spread, add a new passing edge between the child slices of a spread.</span><span>
</span><span id="line-264"></span><span id="local-6989586621679520481"><span class="annot"><a href="PVGrammar.Generate.html#addPassing"><span class="hs-identifier hs-type">addPassing</span></a></span><span>
</span><span id="line-265"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679520481"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679520481"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679520481"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-comment">-- ^ the left end of the edge</span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679520481"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-269"></span><span>  </span><span class="hs-comment">-- ^ the right end of the edge</span><span>
</span><span id="line-270"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MW.Writer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Endo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520481"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-271"></span><span id="addPassing"><span class="annot"><span class="annottext">addPassing :: forall n.
(Ord n, Hashable n) =&gt;
n -&gt; n -&gt; Writer (Endo (Spread n)) ()
</span><a href="PVGrammar.Generate.html#addPassing"><span class="hs-identifier hs-var hs-var">addPassing</span></a></span></span><span> </span><span id="local-6989586621679520134"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520134"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679520133"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520133"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">MW.tell</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; a) -&gt; Endo a
</span><span class="hs-identifier hs-var">Endo</span></span><span> </span><span class="annot"><span class="annottext">Spread n -&gt; Spread n
</span><a href="#local-6989586621679520132"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-272"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-273"></span><span>  </span><span id="local-6989586621679520132"><span class="annot"><span class="annottext">h :: Spread n -&gt; Spread n
</span><a href="#local-6989586621679520132"><span class="hs-identifier hs-var hs-var">h</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#SpreadOp"><span class="hs-identifier hs-type">SpreadOp</span></a></span><span> </span><span id="local-6989586621679520131"><span class="annot"><span class="annottext">HashMap n SpreadDirection
</span><a href="#local-6989586621679520131"><span class="hs-identifier hs-var">dist</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span id="local-6989586621679520130"><span class="annot"><span class="annottext">HashSet (Edge n)
</span><a href="#local-6989586621679520130"><span class="hs-identifier hs-var">mRegs</span></a></span></span><span> </span><span id="local-6989586621679520129"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679520129"><span class="hs-identifier hs-var">mPassings</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall n. HashMap n SpreadDirection -&gt; Edges n -&gt; Spread n
</span><a href="PVGrammar.html#SpreadOp"><span class="hs-identifier hs-var">SpreadOp</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap n SpreadDirection
</span><a href="#local-6989586621679520131"><span class="hs-identifier hs-var">dist</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall n. HashSet (Edge n) -&gt; MultiSet (InnerEdge n) -&gt; Edges n
</span><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-var">Edges</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge n)
</span><a href="#local-6989586621679520130"><span class="hs-identifier hs-var">mRegs</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679520128"><span class="hs-identifier hs-var">mPassings'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-275"></span><span>    </span><span id="local-6989586621679520128"><span class="annot"><span class="annottext">mPassings' :: MultiSet (n, n)
</span><a href="#local-6989586621679520128"><span class="hs-identifier hs-var hs-var">mPassings'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; a -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#insert"><span class="hs-identifier hs-var">MS.insert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520134"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520133"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679520129"><span class="hs-identifier hs-var">mPassings</span></a></span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span class="hs-comment">{- | During a spread, add a new repetition edge
 between two notes of the same pitch class but from different octaves.
-}</span><span>
</span><span id="line-280"></span><span id="local-6989586621679520126"><span class="annot"><a href="PVGrammar.Generate.html#addOctaveRepetition"><span class="hs-identifier hs-type">addOctaveRepetition</span></a></span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679520126"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679520126"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679520126"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-comment">-- ^ the left end of the edge</span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679520126"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-285"></span><span>  </span><span class="hs-comment">-- ^ the right end of the edge</span><span>
</span><span id="line-286"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MW.Writer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Endo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520126"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-287"></span><span id="addOctaveRepetition"><span class="annot"><span class="annottext">addOctaveRepetition :: forall n.
(Ord n, Hashable n) =&gt;
n -&gt; n -&gt; Writer (Endo (Spread n)) ()
</span><a href="PVGrammar.Generate.html#addOctaveRepetition"><span class="hs-identifier hs-var hs-var">addOctaveRepetition</span></a></span></span><span> </span><span id="local-6989586621679520113"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520113"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679520112"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520112"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">MW.tell</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; a) -&gt; Endo a
</span><span class="hs-identifier hs-var">Endo</span></span><span> </span><span class="annot"><span class="annottext">Spread n -&gt; Spread n
</span><a href="#local-6989586621679520111"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-288"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-289"></span><span>  </span><span id="local-6989586621679520111"><span class="annot"><span class="annottext">h :: Spread n -&gt; Spread n
</span><a href="#local-6989586621679520111"><span class="hs-identifier hs-var hs-var">h</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#SpreadOp"><span class="hs-identifier hs-type">SpreadOp</span></a></span><span> </span><span id="local-6989586621679520110"><span class="annot"><span class="annottext">HashMap n SpreadDirection
</span><a href="#local-6989586621679520110"><span class="hs-identifier hs-var">dist</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span id="local-6989586621679520109"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679520109"><span class="hs-identifier hs-var">mRegs</span></a></span></span><span> </span><span id="local-6989586621679520108"><span class="annot"><span class="annottext">MultiSet (InnerEdge n)
</span><a href="#local-6989586621679520108"><span class="hs-identifier hs-var">mPassings</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall n. HashMap n SpreadDirection -&gt; Edges n -&gt; Spread n
</span><a href="PVGrammar.html#SpreadOp"><span class="hs-identifier hs-var">SpreadOp</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap n SpreadDirection
</span><a href="#local-6989586621679520110"><span class="hs-identifier hs-var">dist</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall n. HashSet (Edge n) -&gt; MultiSet (InnerEdge n) -&gt; Edges n
</span><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-var">Edges</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679520107"><span class="hs-identifier hs-var">mRegs'</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge n)
</span><a href="#local-6989586621679520108"><span class="hs-identifier hs-var">mPassings</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-291"></span><span>    </span><span id="local-6989586621679520107"><span class="annot"><span class="annottext">mRegs' :: HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679520107"><span class="hs-identifier hs-var hs-var">mRegs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; a -&gt; HashSet a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520113"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679520112"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679520109"><span class="hs-identifier hs-var">mRegs</span></a></span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span class="hs-comment">-- applying operations</span><span>
</span><span id="line-294"></span><span class="hs-comment">-- ===================</span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span class="hs-comment">-- | Tries to apply a split operation to the parent transition.</span><span>
</span><span id="line-297"></span><span class="annot"><a href="PVGrammar.Generate.html#applySplit"><span class="hs-identifier hs-type">applySplit</span></a></span><span>
</span><span id="line-298"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679520476"><span class="annot"><a href="#local-6989586621679520476"><span class="hs-identifier hs-type">n</span></a></span></span><span>
</span><span id="line-299"></span><span>   </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679520476"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Notation</span></span><span> </span><span class="annot"><a href="#local-6989586621679520476"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679520476"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-300"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520476"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-301"></span><span>  </span><span class="hs-comment">-- ^ the split operation</span><span>
</span><span id="line-302"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520476"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-303"></span><span>  </span><span class="hs-comment">-- ^ the parent transition</span><span>
</span><span id="line-304"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520476"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520476"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520476"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>  </span><span class="hs-comment">-- ^ the resulting child transitions and slice (or an error message).</span><span>
</span><span id="line-306"></span><span id="applySplit"><span class="annot"><span class="annottext">applySplit :: forall n.
(Ord n, Notation n, Hashable n) =&gt;
Split n -&gt; Edges n -&gt; Either String (Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySplit"><span class="hs-identifier hs-var hs-var">applySplit</span></a></span></span><span> </span><span id="local-6989586621679520035"><span class="annot"><span class="annottext">inSplit :: Split n
</span><a href="#local-6989586621679520035"><span class="hs-identifier hs-var">inSplit</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#SplitOp"><span class="hs-identifier hs-type">SplitOp</span></a></span><span> </span><span id="local-6989586621679520034"><span class="annot"><span class="annottext">Map (StartStop n, StartStop n) [(n, DoubleOrnament)]
</span><a href="#local-6989586621679520034"><span class="hs-identifier hs-var">splitRegs</span></a></span></span><span> </span><span id="local-6989586621679520033"><span class="annot"><span class="annottext">Map (n, n) [(n, PassingOrnament)]
</span><a href="#local-6989586621679520033"><span class="hs-identifier hs-var">splitPassings</span></a></span></span><span> </span><span id="local-6989586621679520032"><span class="annot"><span class="annottext">Map n [(n, RightOrnament)]
</span><a href="#local-6989586621679520032"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span id="local-6989586621679520031"><span class="annot"><span class="annottext">Map n [(n, LeftOrnament)]
</span><a href="#local-6989586621679520031"><span class="hs-identifier hs-var">rs</span></a></span></span><span> </span><span id="local-6989586621679520030"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679520030"><span class="hs-identifier hs-var">keepl</span></a></span></span><span> </span><span id="local-6989586621679520029"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679520029"><span class="hs-identifier hs-var">keepr</span></a></span></span><span> </span><span id="local-6989586621679520028"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679520028"><span class="hs-identifier hs-var">passl</span></a></span></span><span> </span><span id="local-6989586621679520027"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679520027"><span class="hs-identifier hs-var">passr</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679520026"><span class="annot"><span class="annottext">inTop :: Edges n
</span><a href="#local-6989586621679520026"><span class="hs-identifier hs-var">inTop</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span id="local-6989586621679520025"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679520025"><span class="hs-identifier hs-var">topRegs</span></a></span></span><span> </span><span id="local-6989586621679520024"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679520024"><span class="hs-identifier hs-var">topPassings</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-307"></span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-308"></span><span>    </span><span id="local-6989586621679520023"><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679520023"><span class="hs-identifier hs-var">notesReg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
-&gt; Map (StartStop n, StartStop n) [(n, DoubleOrnament)]
-&gt; Either String (MultiSet n)
</span><a href="#local-6989586621679520022"><span class="hs-identifier hs-var">applyRegs</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679520025"><span class="hs-identifier hs-var">topRegs</span></a></span><span> </span><span class="annot"><span class="annottext">Map (StartStop n, StartStop n) [(n, DoubleOrnament)]
</span><a href="#local-6989586621679520034"><span class="hs-identifier hs-var">splitRegs</span></a></span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679520021"><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679520021"><span class="hs-identifier hs-var">notesPassing</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679520020"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679520020"><span class="hs-identifier hs-var">leftPassings</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679520019"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679520019"><span class="hs-identifier hs-var">rightPassings</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
-&gt; Map (n, n) [(n, PassingOrnament)]
-&gt; Either String (MultiSet n, MultiSet (n, n), MultiSet (n, n))
</span><a href="#local-6989586621679520018"><span class="hs-identifier hs-var">applyPassings</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679520024"><span class="hs-identifier hs-var">topPassings</span></a></span><span> </span><span class="annot"><span class="annottext">Map (n, n) [(n, PassingOrnament)]
</span><a href="#local-6989586621679520033"><span class="hs-identifier hs-var">splitPassings</span></a></span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679520017"><span class="annot"><span class="annottext">notesL :: MultiSet n
</span><a href="#local-6989586621679520017"><span class="hs-identifier hs-var hs-var">notesL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {a} {a} {b}. Hashable a =&gt; Map a [(a, b)] -&gt; MultiSet a
</span><a href="#local-6989586621679520016"><span class="hs-identifier hs-var">collectNotes</span></a></span><span> </span><span class="annot"><span class="annottext">Map n [(n, RightOrnament)]
</span><a href="#local-6989586621679520032"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-311"></span><span>        </span><span id="local-6989586621679520015"><span class="annot"><span class="annottext">notesR :: MultiSet n
</span><a href="#local-6989586621679520015"><span class="hs-identifier hs-var hs-var">notesR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {a} {a} {b}. Hashable a =&gt; Map a [(a, b)] -&gt; MultiSet a
</span><a href="#local-6989586621679520016"><span class="hs-identifier hs-var">collectNotes</span></a></span><span> </span><span class="annot"><span class="annottext">Map n [(n, LeftOrnament)]
</span><a href="#local-6989586621679520031"><span class="hs-identifier hs-var">rs</span></a></span><span>
</span><span id="line-312"></span><span>        </span><span id="local-6989586621679520014"><span class="annot"><span class="annottext">notes :: MultiSet n
</span><a href="#local-6989586621679520014"><span class="hs-identifier hs-var hs-var">notes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a0.
(Foldable t, Eq a0, Hashable a0) =&gt;
t (MultiSet a0) -&gt; MultiSet a0
</span><a href="Internal.MultiSet.html#unions"><span class="hs-identifier hs-var">MS.unions</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679520023"><span class="hs-identifier hs-var">notesReg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679520021"><span class="hs-identifier hs-var">notesPassing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679520017"><span class="hs-identifier hs-var">notesL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679520015"><span class="hs-identifier hs-var">notesR</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-313"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-314"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">forall n. HashSet (Edge n) -&gt; MultiSet (InnerEdge n) -&gt; Edges n
</span><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-var">Edges</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679520030"><span class="hs-identifier hs-var">keepl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a.
(Eq a, Hashable a) =&gt;
MultiSet a -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#union"><span class="hs-identifier hs-var">MS.union</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679520020"><span class="hs-identifier hs-var">leftPassings</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679520028"><span class="hs-identifier hs-var">passl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall n. MultiSet n -&gt; Notes n
</span><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-var">Notes</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679520014"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-316"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall n. HashSet (Edge n) -&gt; MultiSet (InnerEdge n) -&gt; Edges n
</span><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-var">Edges</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679520029"><span class="hs-identifier hs-var">keepr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a.
(Eq a, Hashable a) =&gt;
MultiSet a -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#union"><span class="hs-identifier hs-var">MS.union</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679520019"><span class="hs-identifier hs-var">rightPassings</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679520027"><span class="hs-identifier hs-var">passr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-318"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-319"></span><span>  </span><span id="local-6989586621679520005"><span class="annot"><span class="annottext">allOps :: Map a [b] -&gt; [(a, b)]
</span><a href="#local-6989586621679520005"><span class="hs-identifier hs-var hs-var">allOps</span></a></span></span><span> </span><span id="local-6989586621679520004"><span class="annot"><span class="annottext">Map a [b]
</span><a href="#local-6989586621679520004"><span class="hs-identifier hs-var">opset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679520003"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679520003"><span class="hs-identifier hs-var">parent</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679520002"><span class="annot"><span class="annottext">[b]
</span><a href="#local-6989586621679520002"><span class="hs-identifier hs-var">children</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">Map a [b]
</span><a href="#local-6989586621679520004"><span class="hs-identifier hs-var">opset</span></a></span><span>
</span><span id="line-321"></span><span>    </span><span id="local-6989586621679520000"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679520000"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[b]
</span><a href="#local-6989586621679520002"><span class="hs-identifier hs-var">children</span></a></span><span>
</span><span id="line-322"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679520003"><span class="hs-identifier hs-var">parent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679520000"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span>  </span><span id="local-6989586621679519993"><span class="annot"><span class="annottext">showEdge :: (i, i) -&gt; String
</span><a href="#local-6989586621679519993"><span class="hs-identifier hs-var hs-var">showEdge</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519992"><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679519992"><span class="hs-identifier hs-var">p1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519991"><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679519991"><span class="hs-identifier hs-var">p2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall i. Notation i =&gt; i -&gt; String
</span><span class="hs-identifier hs-var">showNotation</span></span><span> </span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679519992"><span class="hs-identifier hs-var">p1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall i. Notation i =&gt; i -&gt; String
</span><span class="hs-identifier hs-var">showNotation</span></span><span> </span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679519991"><span class="hs-identifier hs-var">p2</span></a></span><span>
</span><span id="line-325"></span><span>  </span><span id="local-6989586621679519979"><span class="annot"><span class="annottext">showEdges :: t (i, i) -&gt; String
</span><a href="#local-6989586621679519979"><span class="hs-identifier hs-var hs-var">showEdges</span></a></span></span><span> </span><span id="local-6989586621679519978"><span class="annot"><span class="annottext">t (i, i)
</span><a href="#local-6989586621679519978"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;{&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [[a]] -&gt; [a]
</span><span class="hs-identifier hs-var">L.intercalate</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;,&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {i} {i}. (Notation i, Notation i) =&gt; (i, i) -&gt; String
</span><a href="#local-6989586621679519993"><span class="hs-identifier hs-var">showEdge</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">t (i, i)
</span><a href="#local-6989586621679519978"><span class="hs-identifier hs-var">ts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;}&quot;</span></span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span>  </span><span id="local-6989586621679520022"><span class="annot"><span class="annottext">applyRegs :: HashSet (StartStop n, StartStop n)
-&gt; Map (StartStop n, StartStop n) [(n, DoubleOrnament)]
-&gt; Either String (MultiSet n)
</span><a href="#local-6989586621679520022"><span class="hs-identifier hs-var hs-var">applyRegs</span></a></span></span><span> </span><span id="local-6989586621679519975"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519975"><span class="hs-identifier hs-var">top</span></a></span></span><span> </span><span id="local-6989586621679519974"><span class="annot"><span class="annottext">Map (StartStop n, StartStop n) [(n, DoubleOrnament)]
</span><a href="#local-6989586621679519974"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-328"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679519973"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519973"><span class="hs-identifier hs-var">top'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519972"><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519972"><span class="hs-identifier hs-var">notes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
-&gt; (HashSet (StartStop n, StartStop n), MultiSet n)
-&gt; ((StartStop n, StartStop n), (n, DoubleOrnament))
-&gt; Either String (HashSet (StartStop n, StartStop n), MultiSet n)
</span><a href="#local-6989586621679519971"><span class="hs-identifier hs-var">applyReg</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519975"><span class="hs-identifier hs-var">top</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519975"><span class="hs-identifier hs-var">top</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall {a} {b}. Map a [b] -&gt; [(a, b)]
</span><a href="#local-6989586621679520005"><span class="hs-identifier hs-var">allOps</span></a></span><span> </span><span class="annot"><span class="annottext">Map (StartStop n, StartStop n) [(n, DoubleOrnament)]
</span><a href="#local-6989586621679519974"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-329"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">forall a. HashSet a -&gt; Bool
</span><span class="hs-identifier hs-var">S.null</span></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519973"><span class="hs-identifier hs-var">top'</span></a></span><span>
</span><span id="line-330"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519972"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-331"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;did not use all terminal edges, remaining: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall {i} {i} {t :: * -&gt; *}.
(Notation i, Notation i, Foldable t) =&gt;
t (i, i) -&gt; String
</span><a href="#local-6989586621679519979"><span class="hs-identifier hs-var">showEdges</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519973"><span class="hs-identifier hs-var">top'</span></a></span><span>
</span><span id="line-332"></span><span>
</span><span id="line-333"></span><span>  </span><span id="local-6989586621679519971"><span class="annot"><span class="annottext">applyReg :: HashSet (StartStop n, StartStop n)
-&gt; (HashSet (StartStop n, StartStop n), MultiSet n)
-&gt; ((StartStop n, StartStop n), (n, DoubleOrnament))
-&gt; Either String (HashSet (StartStop n, StartStop n), MultiSet n)
</span><a href="#local-6989586621679519971"><span class="hs-identifier hs-var hs-var">applyReg</span></a></span></span><span> </span><span id="local-6989586621679519969"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519969"><span class="hs-identifier hs-var">topAll</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519968"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519968"><span class="hs-identifier hs-var">top</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519967"><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519967"><span class="hs-identifier hs-var">notes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519966"><span class="annot"><span class="annottext">(StartStop n, StartStop n)
</span><a href="#local-6989586621679519966"><span class="hs-identifier hs-var">parent</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519965"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519965"><span class="hs-identifier hs-var">note</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DoubleOrnament
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(StartStop n, StartStop n)
</span><a href="#local-6989586621679519966"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; a -&gt; HashSet a -&gt; Bool
</span><span class="hs-operator hs-var">`S.member`</span></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519969"><span class="hs-identifier hs-var">topAll</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-335"></span><span>        </span><span class="annot"><span class="annottext">forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519963"><span class="hs-identifier hs-var">top'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519962"><span class="hs-identifier hs-var">notes'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-337"></span><span>        </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-338"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;used non-existing terminal edge\n  top=&quot;</span></span><span>
</span><span id="line-339"></span><span>            </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679520026"><span class="hs-identifier hs-var">inTop</span></a></span><span>
</span><span id="line-340"></span><span>            </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n  split=&quot;</span></span><span>
</span><span id="line-341"></span><span>            </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Split n
</span><a href="#local-6989586621679520035"><span class="hs-identifier hs-var">inSplit</span></a></span><span>
</span><span id="line-342"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-343"></span><span>    </span><span id="local-6989586621679519963"><span class="annot"><span class="annottext">top' :: HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519963"><span class="hs-identifier hs-var hs-var">top'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; a -&gt; HashSet a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.delete</span></span><span> </span><span class="annot"><span class="annottext">(StartStop n, StartStop n)
</span><a href="#local-6989586621679519966"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519968"><span class="hs-identifier hs-var">top</span></a></span><span>
</span><span id="line-344"></span><span>    </span><span id="local-6989586621679519962"><span class="annot"><span class="annottext">notes' :: MultiSet n
</span><a href="#local-6989586621679519962"><span class="hs-identifier hs-var hs-var">notes'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; a -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#insert"><span class="hs-identifier hs-var">MS.insert</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519965"><span class="hs-identifier hs-var">note</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519967"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-345"></span><span>
</span><span id="line-346"></span><span>  </span><span id="local-6989586621679520018"><span class="annot"><span class="annottext">applyPassings :: MultiSet (n, n)
-&gt; Map (n, n) [(n, PassingOrnament)]
-&gt; Either String (MultiSet n, MultiSet (n, n), MultiSet (n, n))
</span><a href="#local-6989586621679520018"><span class="hs-identifier hs-var hs-var">applyPassings</span></a></span></span><span> </span><span id="local-6989586621679519959"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519959"><span class="hs-identifier hs-var">top</span></a></span></span><span> </span><span id="local-6989586621679519958"><span class="annot"><span class="annottext">Map (n, n) [(n, PassingOrnament)]
</span><a href="#local-6989586621679519958"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-347"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679519957"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519957"><span class="hs-identifier hs-var">top'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519956"><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519956"><span class="hs-identifier hs-var">notes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519955"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519955"><span class="hs-identifier hs-var">lPassings</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519954"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519954"><span class="hs-identifier hs-var">rPassings</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-348"></span><span>      </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="annot"><span class="annottext">(MultiSet (n, n), MultiSet n, MultiSet (n, n), MultiSet (n, n))
-&gt; ((n, n), (n, PassingOrnament))
-&gt; Either
     String
     (MultiSet (n, n), MultiSet n, MultiSet (n, n), MultiSet (n, n))
</span><a href="#local-6989586621679519953"><span class="hs-identifier hs-var">applyPassing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519959"><span class="hs-identifier hs-var">top</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall {a} {b}. Map a [b] -&gt; [(a, b)]
</span><a href="#local-6989586621679520005"><span class="hs-identifier hs-var">allOps</span></a></span><span> </span><span class="annot"><span class="annottext">Map (n, n) [(n, PassingOrnament)]
</span><a href="#local-6989586621679519958"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-349"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">forall k. MultiSet k -&gt; Bool
</span><a href="Internal.MultiSet.html#null"><span class="hs-identifier hs-var">MS.null</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519957"><span class="hs-identifier hs-var">top'</span></a></span><span>
</span><span id="line-350"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519956"><span class="hs-identifier hs-var">notes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519955"><span class="hs-identifier hs-var">lPassings</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519954"><span class="hs-identifier hs-var">rPassings</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span>      </span><span class="hs-keyword">else</span><span>
</span><span id="line-352"></span><span>        </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-353"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;did not use all non-terminal edges, remaining: &quot;</span></span><span>
</span><span id="line-354"></span><span>            </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall {i} {i} {t :: * -&gt; *}.
(Notation i, Notation i, Foldable t) =&gt;
t (i, i) -&gt; String
</span><a href="#local-6989586621679519979"><span class="hs-identifier hs-var">showEdges</span></a></span><span>
</span><span id="line-355"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. MultiSet a -&gt; [a]
</span><a href="Internal.MultiSet.html#toList"><span class="hs-identifier hs-var">MS.toList</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519957"><span class="hs-identifier hs-var">top'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span>  </span><span id="local-6989586621679519953"><span class="annot"><span class="annottext">applyPassing :: (MultiSet (n, n), MultiSet n, MultiSet (n, n), MultiSet (n, n))
-&gt; ((n, n), (n, PassingOrnament))
-&gt; Either
     String
     (MultiSet (n, n), MultiSet n, MultiSet (n, n), MultiSet (n, n))
</span><a href="#local-6989586621679519953"><span class="hs-identifier hs-var hs-var">applyPassing</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519950"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519950"><span class="hs-identifier hs-var">top</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519949"><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519949"><span class="hs-identifier hs-var">notes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519948"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519948"><span class="hs-identifier hs-var">lPassings</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519947"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519947"><span class="hs-identifier hs-var">rPassings</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519946"><span class="annot"><span class="annottext">parent :: (n, n)
</span><a href="#local-6989586621679519946"><span class="hs-identifier hs-var">parent</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679519945"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519945"><span class="hs-identifier hs-var">pl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519944"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519944"><span class="hs-identifier hs-var">pr</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519943"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519943"><span class="hs-identifier hs-var">note</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519942"><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679519942"><span class="hs-identifier hs-var">pass</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(n, n)
</span><a href="#local-6989586621679519946"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">forall k. (Eq k, Hashable k) =&gt; k -&gt; MultiSet k -&gt; Bool
</span><a href="Internal.MultiSet.html#member"><span class="hs-operator hs-var">`MS.member`</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519950"><span class="hs-identifier hs-var">top</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-359"></span><span>        </span><span class="annot"><span class="annottext">forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519940"><span class="hs-identifier hs-var">top'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519939"><span class="hs-identifier hs-var">notes'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519938"><span class="hs-identifier hs-var">lPassings'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519937"><span class="hs-identifier hs-var">rPassings'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-361"></span><span>        </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-362"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;used non-existing non-terminal edge\n  top=&quot;</span></span><span>
</span><span id="line-363"></span><span>            </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679520026"><span class="hs-identifier hs-var">inTop</span></a></span><span>
</span><span id="line-364"></span><span>            </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n  split=&quot;</span></span><span>
</span><span id="line-365"></span><span>            </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Split n
</span><a href="#local-6989586621679520035"><span class="hs-identifier hs-var">inSplit</span></a></span><span>
</span><span id="line-366"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-367"></span><span>    </span><span id="local-6989586621679519940"><span class="annot"><span class="annottext">top' :: MultiSet (n, n)
</span><a href="#local-6989586621679519940"><span class="hs-identifier hs-var hs-var">top'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; a -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#delete"><span class="hs-identifier hs-var">MS.delete</span></a></span><span> </span><span class="annot"><span class="annottext">(n, n)
</span><a href="#local-6989586621679519946"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519950"><span class="hs-identifier hs-var">top</span></a></span><span>
</span><span id="line-368"></span><span>    </span><span id="local-6989586621679519939"><span class="annot"><span class="annottext">notes' :: MultiSet n
</span><a href="#local-6989586621679519939"><span class="hs-identifier hs-var hs-var">notes'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; a -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#insert"><span class="hs-identifier hs-var">MS.insert</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519943"><span class="hs-identifier hs-var">note</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519949"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-369"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679519935"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519935"><span class="hs-identifier hs-var">newl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519934"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519934"><span class="hs-identifier hs-var">newr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679519942"><span class="hs-identifier hs-var">pass</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-370"></span><span>      </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="PVGrammar.html#PassingMid"><span class="hs-identifier hs-var">PassingMid</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>      </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="PVGrammar.html#PassingLeft"><span class="hs-identifier hs-var">PassingLeft</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#singleton"><span class="hs-identifier hs-var">MS.singleton</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519943"><span class="hs-identifier hs-var">note</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519944"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span>      </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="PVGrammar.html#PassingRight"><span class="hs-identifier hs-var">PassingRight</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#singleton"><span class="hs-identifier hs-var">MS.singleton</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519945"><span class="hs-identifier hs-var">pl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519943"><span class="hs-identifier hs-var">note</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-373"></span><span>    </span><span id="local-6989586621679519938"><span class="annot"><span class="annottext">lPassings' :: MultiSet (n, n)
</span><a href="#local-6989586621679519938"><span class="hs-identifier hs-var hs-var">lPassings'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a.
(Eq a, Hashable a) =&gt;
MultiSet a -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#union"><span class="hs-identifier hs-var">MS.union</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519935"><span class="hs-identifier hs-var">newl</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519948"><span class="hs-identifier hs-var">lPassings</span></a></span><span>
</span><span id="line-374"></span><span>    </span><span id="local-6989586621679519937"><span class="annot"><span class="annottext">rPassings' :: MultiSet (n, n)
</span><a href="#local-6989586621679519937"><span class="hs-identifier hs-var hs-var">rPassings'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a.
(Eq a, Hashable a) =&gt;
MultiSet a -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#union"><span class="hs-identifier hs-var">MS.union</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519934"><span class="hs-identifier hs-var">newr</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519947"><span class="hs-identifier hs-var">rPassings</span></a></span><span>
</span><span id="line-375"></span><span>
</span><span id="line-376"></span><span>  </span><span id="local-6989586621679519932"><span class="annot"><span class="annottext">singleChild :: (a, (a, b)) -&gt; a
</span><a href="#local-6989586621679519932"><span class="hs-identifier hs-var hs-var">singleChild</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519931"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679519931"><span class="hs-identifier hs-var">note</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679519931"><span class="hs-identifier hs-var">note</span></a></span><span>
</span><span id="line-377"></span><span>  </span><span id="local-6989586621679520016"><span class="annot"><span class="annottext">collectNotes :: Map a [(a, b)] -&gt; MultiSet a
</span><a href="#local-6989586621679520016"><span class="hs-identifier hs-var hs-var">collectNotes</span></a></span></span><span> </span><span id="local-6989586621679519923"><span class="annot"><span class="annottext">Map a [(a, b)]
</span><a href="#local-6989586621679519923"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a.
(Foldable t, Eq a, Hashable a) =&gt;
t a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#fromList"><span class="hs-identifier hs-var">MS.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall {a} {a} {b}. (a, (a, b)) -&gt; a
</span><a href="#local-6989586621679519932"><span class="hs-identifier hs-var">singleChild</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall {a} {b}. Map a [b] -&gt; [(a, b)]
</span><a href="#local-6989586621679520005"><span class="hs-identifier hs-var">allOps</span></a></span><span> </span><span class="annot"><span class="annottext">Map a [(a, b)]
</span><a href="#local-6989586621679519923"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-378"></span><span>
</span><span id="line-379"></span><span class="hs-comment">-- | Indicates whether a transition can be frozen (i.e., doesn't contain non-&quot;tie&quot; edges).</span><span>
</span><span id="line-380"></span><span id="local-6989586621679520422"><span class="annot"><a href="PVGrammar.Generate.html#freezable"><span class="hs-identifier hs-type">freezable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MC.IntervalOf</span></span><span> </span><span class="annot"><a href="#local-6989586621679520422"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MC.HasPitch</span></span><span> </span><span class="annot"><a href="#local-6989586621679520422"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520422"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-381"></span><span id="freezable"><span class="annot"><span class="annottext">freezable :: forall n. (Eq (IntervalOf n), HasPitch n) =&gt; Edges n -&gt; Bool
</span><a href="PVGrammar.Generate.html#freezable"><span class="hs-identifier hs-var hs-var">freezable</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span id="local-6989586621679519910"><span class="annot"><span class="annottext">HashSet (Edge n)
</span><a href="#local-6989586621679519910"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621679519909"><span class="annot"><span class="annottext">MultiSet (InnerEdge n)
</span><a href="#local-6989586621679519909"><span class="hs-identifier hs-var">nts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k. MultiSet k -&gt; Bool
</span><a href="Internal.MultiSet.html#null"><span class="hs-identifier hs-var">MS.null</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge n)
</span><a href="#local-6989586621679519909"><span class="hs-identifier hs-var">nts</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">forall {a} {a} {f :: * -&gt; *}.
(IntervalOf a ~ IntervalOf a, Eq (f (Pitch (IntervalOf a))),
 Functor f, HasPitch a, HasPitch a) =&gt;
(f a, f a) -&gt; Bool
</span><a href="#local-6989586621679519907"><span class="hs-identifier hs-var">isRep</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge n)
</span><a href="#local-6989586621679519910"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-382"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-383"></span><span>  </span><span id="local-6989586621679519907"><span class="annot"><span class="annottext">isRep :: (f a, f a) -&gt; Bool
</span><a href="#local-6989586621679519907"><span class="hs-identifier hs-var hs-var">isRep</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519895"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679519895"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519894"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679519894"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">forall a. HasPitch a =&gt; a -&gt; Pitch (IntervalOf a)
</span><span class="hs-identifier hs-var">MC.pitch</span></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679519895"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">forall a. HasPitch a =&gt; a -&gt; Pitch (IntervalOf a)
</span><span class="hs-identifier hs-var">MC.pitch</span></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679519894"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-384"></span><span>
</span><span id="line-385"></span><span class="hs-comment">-- | Tries to apply a freeze operation to a transition.</span><span>
</span><span id="line-386"></span><span id="local-6989586621679520407"><span class="annot"><a href="PVGrammar.Generate.html#applyFreeze"><span class="hs-identifier hs-type">applyFreeze</span></a></span><span>
</span><span id="line-387"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MC.IntervalOf</span></span><span> </span><span class="annot"><a href="#local-6989586621679520407"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MC.HasPitch</span></span><span> </span><span class="annot"><a href="#local-6989586621679520407"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span>
</span><span id="line-389"></span><span>  </span><span class="hs-comment">-- ^ the freeze operation</span><span>
</span><span id="line-390"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520407"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-391"></span><span>  </span><span class="hs-comment">-- ^ the unfrozen edge</span><span>
</span><span id="line-392"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520407"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-393"></span><span>  </span><span class="hs-comment">-- ^ the frozen transition</span><span>
</span><span id="line-394"></span><span id="applyFreeze"><span class="annot"><span class="annottext">applyFreeze :: forall n.
(Eq (IntervalOf n), HasPitch n) =&gt;
Freeze -&gt; Edges n -&gt; Either String (Edges n)
</span><a href="PVGrammar.Generate.html#applyFreeze"><span class="hs-identifier hs-var hs-var">applyFreeze</span></a></span></span><span> </span><span class="annot"><span class="annottext">Freeze
</span><a href="PVGrammar.html#FreezeOp"><span class="hs-identifier hs-var">FreezeOp</span></a></span><span> </span><span id="local-6989586621679519884"><span class="annot"><span class="annottext">e :: Edges n
</span><a href="#local-6989586621679519884"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span id="local-6989586621679519883"><span class="annot"><span class="annottext">HashSet (Edge n)
</span><a href="#local-6989586621679519883"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621679519882"><span class="annot"><span class="annottext">MultiSet (InnerEdge n)
</span><a href="#local-6989586621679519882"><span class="hs-identifier hs-var">nts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-395"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall k. MultiSet k -&gt; Bool
</span><a href="Internal.MultiSet.html#null"><span class="hs-identifier hs-var">MS.null</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge n)
</span><a href="#local-6989586621679519882"><span class="hs-identifier hs-var">nts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cannot freeze non-terminal edges&quot;</span></span><span>
</span><span id="line-396"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">forall {a} {a} {f :: * -&gt; *}.
(IntervalOf a ~ IntervalOf a, Eq (f (Pitch (IntervalOf a))),
 Functor f, HasPitch a, HasPitch a) =&gt;
(f a, f a) -&gt; Bool
</span><a href="#local-6989586621679519880"><span class="hs-identifier hs-var">isRep</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge n)
</span><a href="#local-6989586621679519883"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cannot freeze non-tie edges&quot;</span></span><span>
</span><span id="line-397"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679519884"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-398"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-399"></span><span>  </span><span id="local-6989586621679519880"><span class="annot"><span class="annottext">isRep :: (f a, f a) -&gt; Bool
</span><a href="#local-6989586621679519880"><span class="hs-identifier hs-var hs-var">isRep</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519868"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679519868"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519867"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679519867"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">forall a. HasPitch a =&gt; a -&gt; Pitch (IntervalOf a)
</span><span class="hs-identifier hs-var">MC.pitch</span></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679519868"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">forall a. HasPitch a =&gt; a -&gt; Pitch (IntervalOf a)
</span><span class="hs-identifier hs-var">MC.pitch</span></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621679519867"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span class="hs-comment">-- | Tries to apply a spread operation to the parent transitions and slice.</span><span>
</span><span id="line-402"></span><span class="annot"><a href="PVGrammar.Generate.html#applySpread"><span class="hs-identifier hs-type">applySpread</span></a></span><span>
</span><span id="line-403"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679520402"><span class="annot"><a href="#local-6989586621679520402"><span class="hs-identifier hs-type">n</span></a></span></span><span>
</span><span id="line-404"></span><span>   </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679520402"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Notation</span></span><span> </span><span class="annot"><a href="#local-6989586621679520402"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679520402"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520402"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-406"></span><span>  </span><span class="hs-comment">-- ^ the spread operation</span><span>
</span><span id="line-407"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520402"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-408"></span><span>  </span><span class="hs-comment">-- ^ the left parent transition</span><span>
</span><span id="line-409"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520402"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-410"></span><span>  </span><span class="hs-comment">-- ^ the parent slice</span><span>
</span><span id="line-411"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520402"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-412"></span><span>  </span><span class="hs-comment">-- ^ the right parent transition</span><span>
</span><span id="line-413"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520402"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520402"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520402"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520402"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520402"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-414"></span><span>  </span><span class="hs-comment">-- ^ the child transitions and slices (or an error message)</span><span>
</span><span id="line-415"></span><span id="applySpread"><span class="annot"><span class="annottext">applySpread :: forall n.
(Ord n, Notation n, Hashable n) =&gt;
Spread n
-&gt; Edges n
-&gt; Notes n
-&gt; Edges n
-&gt; Either String (Edges n, Notes n, Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySpread"><span class="hs-identifier hs-var hs-var">applySpread</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#SpreadOp"><span class="hs-identifier hs-type">SpreadOp</span></a></span><span> </span><span id="local-6989586621679519819"><span class="annot"><span class="annottext">HashMap n SpreadDirection
</span><a href="#local-6989586621679519819"><span class="hs-identifier hs-var">dist</span></a></span></span><span> </span><span id="local-6989586621679519818"><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679519818"><span class="hs-identifier hs-var">childm</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679519817"><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679519817"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span id="local-6989586621679519816"><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519816"><span class="hs-identifier hs-var">notesm</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679519815"><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679519815"><span class="hs-identifier hs-var">pr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-416"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679519814"><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519814"><span class="hs-identifier hs-var">notesl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519813"><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519813"><span class="hs-identifier hs-var">notesr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-417"></span><span>    </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="annot"><span class="annottext">(MultiSet n, MultiSet n)
-&gt; (n, Int) -&gt; Either String (MultiSet n, MultiSet n)
</span><a href="#local-6989586621679519812"><span class="hs-identifier hs-var">applyDist</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-418"></span><span>      </span><span class="annot"><span class="annottext">forall k. MultiSet k -&gt; [(k, Int)]
</span><a href="Internal.MultiSet.html#toOccurList"><span class="hs-identifier hs-var">MS.toOccurList</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519816"><span class="hs-identifier hs-var">notesm</span></a></span><span>
</span><span id="line-419"></span><span>  </span><span id="local-6989586621679519810"><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679519810"><span class="hs-identifier hs-var">childl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(forall a. (a, a) -&gt; a)
-&gt; Edges n -&gt; MultiSet n -&gt; Either String (Edges n)
</span><a href="#local-6989586621679519809"><span class="hs-identifier hs-var">fixEdges</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679519817"><span class="hs-identifier hs-var">pl</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519814"><span class="hs-identifier hs-var">notesl</span></a></span><span>
</span><span id="line-420"></span><span>  </span><span id="local-6989586621679519808"><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679519808"><span class="hs-identifier hs-var">childr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(forall a. (a, a) -&gt; a)
-&gt; Edges n -&gt; MultiSet n -&gt; Either String (Edges n)
</span><a href="#local-6989586621679519809"><span class="hs-identifier hs-var">fixEdges</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679519815"><span class="hs-identifier hs-var">pr</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519813"><span class="hs-identifier hs-var">notesr</span></a></span><span>
</span><span id="line-421"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679519810"><span class="hs-identifier hs-var">childl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall n. MultiSet n -&gt; Notes n
</span><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-var">Notes</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519814"><span class="hs-identifier hs-var">notesl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679519818"><span class="hs-identifier hs-var">childm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall n. MultiSet n -&gt; Notes n
</span><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-var">Notes</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519813"><span class="hs-identifier hs-var">notesr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679519808"><span class="hs-identifier hs-var">childr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-423"></span><span>  </span><span id="local-6989586621679519812"><span class="annot"><span class="annottext">applyDist :: (MultiSet n, MultiSet n)
-&gt; (n, Int) -&gt; Either String (MultiSet n, MultiSet n)
</span><a href="#local-6989586621679519812"><span class="hs-identifier hs-var hs-var">applyDist</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519807"><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519807"><span class="hs-identifier hs-var">notesl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519806"><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519806"><span class="hs-identifier hs-var">notesr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519805"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519805"><span class="hs-identifier hs-var">note</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519804"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679519804"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-424"></span><span>    </span><span id="local-6989586621679519803"><span class="annot"><span class="annottext">SpreadDirection
</span><a href="#local-6989586621679519803"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-425"></span><span>      </span><span class="annot"><span class="annottext">forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall i. Notation i =&gt; i -&gt; String
</span><span class="hs-identifier hs-var">showNotation</span></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519805"><span class="hs-identifier hs-var">note</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; is not distributed&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-426"></span><span>        </span><span class="annot"><span class="annottext">forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HM.lookup</span></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519805"><span class="hs-identifier hs-var">note</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap n SpreadDirection
</span><a href="#local-6989586621679519819"><span class="hs-identifier hs-var">dist</span></a></span><span>
</span><span id="line-427"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SpreadDirection
</span><a href="#local-6989586621679519803"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-428"></span><span>      </span><span class="annot"><span class="annottext">SpreadDirection
</span><a href="PVGrammar.html#ToBoth"><span class="hs-identifier hs-var">ToBoth</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a.
(Eq a, Hashable a) =&gt;
a -&gt; Int -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#insertMany"><span class="hs-identifier hs-var">MS.insertMany</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519805"><span class="hs-identifier hs-var">note</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679519804"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519807"><span class="hs-identifier hs-var">notesl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a.
(Eq a, Hashable a) =&gt;
a -&gt; Int -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#insertMany"><span class="hs-identifier hs-var">MS.insertMany</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519805"><span class="hs-identifier hs-var">note</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679519804"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519806"><span class="hs-identifier hs-var">notesr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-429"></span><span>      </span><span class="annot"><a href="PVGrammar.html#ToLeft"><span class="hs-identifier hs-type">ToLeft</span></a></span><span> </span><span id="local-6989586621679519797"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679519797"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-430"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679519797"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679519804"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679519797"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-431"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;moving more notes than allowed to the right&quot;</span></span><span>
</span><span id="line-432"></span><span>          </span><span class="hs-keyword">else</span><span>
</span><span id="line-433"></span><span>            </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-434"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a.
(Eq a, Hashable a) =&gt;
a -&gt; Int -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#insertMany"><span class="hs-identifier hs-var">MS.insertMany</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519805"><span class="hs-identifier hs-var">note</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679519804"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519807"><span class="hs-identifier hs-var">notesl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a.
(Eq a, Hashable a) =&gt;
a -&gt; Int -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#insertMany"><span class="hs-identifier hs-var">MS.insertMany</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519805"><span class="hs-identifier hs-var">note</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679519804"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679519797"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519806"><span class="hs-identifier hs-var">notesr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-435"></span><span>      </span><span class="annot"><a href="PVGrammar.html#ToRight"><span class="hs-identifier hs-type">ToRight</span></a></span><span> </span><span id="local-6989586621679519792"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679519792"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-436"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679519792"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679519804"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679519792"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-437"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;moving more notes than allowed to the left&quot;</span></span><span>
</span><span id="line-438"></span><span>          </span><span class="hs-keyword">else</span><span>
</span><span id="line-439"></span><span>            </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-440"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a.
(Eq a, Hashable a) =&gt;
a -&gt; Int -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#insertMany"><span class="hs-identifier hs-var">MS.insertMany</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519805"><span class="hs-identifier hs-var">note</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679519804"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679519792"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519807"><span class="hs-identifier hs-var">notesl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a.
(Eq a, Hashable a) =&gt;
a -&gt; Int -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#insertMany"><span class="hs-identifier hs-var">MS.insertMany</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519805"><span class="hs-identifier hs-var">note</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679519804"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519806"><span class="hs-identifier hs-var">notesr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-441"></span><span>  </span><span class="annot"><a href="#local-6989586621679519809"><span class="hs-identifier hs-type">fixEdges</span></a></span><span>
</span><span id="line-442"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679520399"><span class="annot"><a href="#local-6989586621679520399"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679520399"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679520399"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679520399"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-443"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520402"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-444"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Internal.MultiSet.html#MultiSet"><span class="hs-identifier hs-type">MS.MultiSet</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520402"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-445"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520402"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-446"></span><span>  </span><span id="local-6989586621679519809"><span class="annot"><span class="annottext">fixEdges :: (forall a. (a, a) -&gt; a)
-&gt; Edges n -&gt; MultiSet n -&gt; Either String (Edges n)
</span><a href="#local-6989586621679519809"><span class="hs-identifier hs-var hs-var">fixEdges</span></a></span></span><span> </span><span id="local-6989586621679519791"><span class="annot"><span class="annottext">forall a. (a, a) -&gt; a
</span><a href="#local-6989586621679519791"><span class="hs-identifier hs-var">accessor</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span id="local-6989586621679519790"><span class="annot"><span class="annottext">HashSet (Edge n)
</span><a href="#local-6989586621679519790"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621679519789"><span class="annot"><span class="annottext">MultiSet (InnerEdge n)
</span><a href="#local-6989586621679519789"><span class="hs-identifier hs-var">nts</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679519788"><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519788"><span class="hs-identifier hs-var">notesms</span></a></span></span><span>
</span><span id="line-447"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; MultiSet a -&gt; Bool
</span><a href="Internal.MultiSet.html#all"><span class="hs-identifier hs-var">MS.all</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; a -&gt; HashSet a -&gt; Bool
</span><span class="hs-operator hs-var">`S.member`</span></span><span> </span><span class="annot"><span class="annottext">HashSet n
</span><a href="#local-6989586621679519786"><span class="hs-identifier hs-var">notes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a. (a, a) -&gt; a
</span><a href="#local-6989586621679519791"><span class="hs-identifier hs-var">accessor</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge n)
</span><a href="#local-6989586621679519789"><span class="hs-identifier hs-var">nts</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-448"></span><span>        </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span>
</span><span id="line-449"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;dropping non-terminal edge in spread&quot;</span></span><span>
</span><span id="line-450"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall n. HashSet (Edge n) -&gt; MultiSet (InnerEdge n) -&gt; Edges n
</span><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-var">Edges</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (Edge n)
</span><a href="#local-6989586621679519784"><span class="hs-identifier hs-var">ts'</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge n)
</span><a href="#local-6989586621679519789"><span class="hs-identifier hs-var">nts</span></a></span><span>
</span><span id="line-451"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-452"></span><span>    </span><span id="local-6989586621679519786"><span class="annot"><span class="annottext">notes :: HashSet n
</span><a href="#local-6989586621679519786"><span class="hs-identifier hs-var hs-var">notes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k. MultiSet k -&gt; HashSet k
</span><a href="Internal.MultiSet.html#toSet"><span class="hs-identifier hs-var">MS.toSet</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519788"><span class="hs-identifier hs-var">notesms</span></a></span><span>
</span><span id="line-453"></span><span>    </span><span id="local-6989586621679519782"><span class="annot"><span class="annottext">notesi :: HashSet (StartStop n)
</span><a href="#local-6989586621679519782"><span class="hs-identifier hs-var hs-var">notesi</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b a.
(Hashable b, Eq b) =&gt;
(a -&gt; b) -&gt; HashSet a -&gt; HashSet b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet n
</span><a href="#local-6989586621679519786"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-454"></span><span>    </span><span id="local-6989586621679519784"><span class="annot"><span class="annottext">ts' :: HashSet (Edge n)
</span><a href="#local-6989586621679519784"><span class="hs-identifier hs-var hs-var">ts'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; Bool) -&gt; HashSet a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; a -&gt; HashSet a -&gt; Bool
</span><span class="hs-operator hs-var">`S.member`</span></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n)
</span><a href="#local-6989586621679519782"><span class="hs-identifier hs-var">notesi</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a. (a, a) -&gt; a
</span><a href="#local-6989586621679519791"><span class="hs-identifier hs-var">accessor</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashSet (Edge n)
</span><a href="#local-6989586621679519790"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-455"></span><span>
</span><span id="line-456"></span><span class="hs-comment">{- | A variant of 'applySplit' that inserts all protovoice edges into the child transitions,
 even those that are not &quot;kept&quot; (used for further elaboration).
 This is useful when you want to see all relations between notes in the piece.
-}</span><span>
</span><span id="line-460"></span><span class="annot"><a href="PVGrammar.Generate.html#applySplitAllEdges"><span class="hs-identifier hs-type">applySplitAllEdges</span></a></span><span>
</span><span id="line-461"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679519779"><span class="annot"><a href="#local-6989586621679519779"><span class="hs-identifier hs-type">n</span></a></span></span><span>
</span><span id="line-462"></span><span>   </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679519779"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Notation</span></span><span> </span><span class="annot"><a href="#local-6989586621679519779"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679519779"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-463"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679519779"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-464"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679519779"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-465"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679519779"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679519779"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679519779"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-466"></span><span id="applySplitAllEdges"><span class="annot"><span class="annottext">applySplitAllEdges :: forall n.
(Ord n, Notation n, Hashable n) =&gt;
Split n -&gt; Edges n -&gt; Either String (Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySplitAllEdges"><span class="hs-identifier hs-var hs-var">applySplitAllEdges</span></a></span></span><span> </span><span id="local-6989586621679519698"><span class="annot"><span class="annottext">inSplit :: Split n
</span><a href="#local-6989586621679519698"><span class="hs-identifier hs-var">inSplit</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#SplitOp"><span class="hs-identifier hs-type">SplitOp</span></a></span><span> </span><span id="local-6989586621679519697"><span class="annot"><span class="annottext">Map (StartStop n, StartStop n) [(n, DoubleOrnament)]
</span><a href="#local-6989586621679519697"><span class="hs-identifier hs-var">splitRegs</span></a></span></span><span> </span><span id="local-6989586621679519696"><span class="annot"><span class="annottext">Map (n, n) [(n, PassingOrnament)]
</span><a href="#local-6989586621679519696"><span class="hs-identifier hs-var">splitPassings</span></a></span></span><span> </span><span id="local-6989586621679519695"><span class="annot"><span class="annottext">Map n [(n, RightOrnament)]
</span><a href="#local-6989586621679519695"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span id="local-6989586621679519694"><span class="annot"><span class="annottext">Map n [(n, LeftOrnament)]
</span><a href="#local-6989586621679519694"><span class="hs-identifier hs-var">rs</span></a></span></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679519693"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519693"><span class="hs-identifier hs-var">passl</span></a></span></span><span> </span><span id="local-6989586621679519692"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519692"><span class="hs-identifier hs-var">passr</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679519691"><span class="annot"><span class="annottext">inTop :: Edges n
</span><a href="#local-6989586621679519691"><span class="hs-identifier hs-var">inTop</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span id="local-6989586621679519690"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519690"><span class="hs-identifier hs-var">topRegs</span></a></span></span><span> </span><span id="local-6989586621679519689"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519689"><span class="hs-identifier hs-var">topPassings</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-467"></span><span>  </span><span class="hs-keyword">do</span><span>
</span><span id="line-468"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679519688"><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519688"><span class="hs-identifier hs-var">notesReg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519687"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519687"><span class="hs-identifier hs-var">leftRegsReg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519686"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519686"><span class="hs-identifier hs-var">rightRegsReg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
-&gt; Map (StartStop n, StartStop n) [(n, DoubleOrnament)]
-&gt; Either
     String
     (MultiSet n, HashSet (StartStop n, StartStop n),
      HashSet (StartStop n, StartStop n))
</span><a href="#local-6989586621679519685"><span class="hs-identifier hs-var">applyRegs</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519690"><span class="hs-identifier hs-var">topRegs</span></a></span><span> </span><span class="annot"><span class="annottext">Map (StartStop n, StartStop n) [(n, DoubleOrnament)]
</span><a href="#local-6989586621679519697"><span class="hs-identifier hs-var">splitRegs</span></a></span><span>
</span><span id="line-469"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679519684"><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519684"><span class="hs-identifier hs-var">notesPassing</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519683"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519683"><span class="hs-identifier hs-var">leftPassings</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519682"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519682"><span class="hs-identifier hs-var">rightPassings</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519681"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519681"><span class="hs-identifier hs-var">leftRegsPass</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519680"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519680"><span class="hs-identifier hs-var">rightRegsPass</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-470"></span><span>      </span><span class="annot"><span class="annottext">MultiSet (n, n)
-&gt; Map (n, n) [(n, PassingOrnament)]
-&gt; Either
     String
     (MultiSet n, MultiSet (n, n), MultiSet (n, n),
      HashSet (StartStop n, StartStop n),
      HashSet (StartStop n, StartStop n))
</span><a href="#local-6989586621679519679"><span class="hs-identifier hs-var">applyPassings</span></a></span><span>
</span><span id="line-471"></span><span>        </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519689"><span class="hs-identifier hs-var">topPassings</span></a></span><span>
</span><span id="line-472"></span><span>        </span><span class="annot"><span class="annottext">Map (n, n) [(n, PassingOrnament)]
</span><a href="#local-6989586621679519696"><span class="hs-identifier hs-var">splitPassings</span></a></span><span>
</span><span id="line-473"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679519678"><span class="annot"><span class="annottext">notesL :: MultiSet n
</span><a href="#local-6989586621679519678"><span class="hs-identifier hs-var hs-var">notesL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {a} {a} {b}. Hashable a =&gt; Map a [(a, b)] -&gt; MultiSet a
</span><a href="#local-6989586621679519677"><span class="hs-identifier hs-var">collectNotes</span></a></span><span> </span><span class="annot"><span class="annottext">Map n [(n, RightOrnament)]
</span><a href="#local-6989586621679519695"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-474"></span><span>        </span><span id="local-6989586621679519676"><span class="annot"><span class="annottext">notesR :: MultiSet n
</span><a href="#local-6989586621679519676"><span class="hs-identifier hs-var hs-var">notesR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {a} {a} {b}. Hashable a =&gt; Map a [(a, b)] -&gt; MultiSet a
</span><a href="#local-6989586621679519677"><span class="hs-identifier hs-var">collectNotes</span></a></span><span> </span><span class="annot"><span class="annottext">Map n [(n, LeftOrnament)]
</span><a href="#local-6989586621679519694"><span class="hs-identifier hs-var">rs</span></a></span><span>
</span><span id="line-475"></span><span>        </span><span id="local-6989586621679519675"><span class="annot"><span class="annottext">notes :: MultiSet n
</span><a href="#local-6989586621679519675"><span class="hs-identifier hs-var hs-var">notes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a0.
(Foldable t, Eq a0, Hashable a0) =&gt;
t (MultiSet a0) -&gt; MultiSet a0
</span><a href="Internal.MultiSet.html#unions"><span class="hs-identifier hs-var">MS.unions</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519688"><span class="hs-identifier hs-var">notesReg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519684"><span class="hs-identifier hs-var">notesPassing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519678"><span class="hs-identifier hs-var">notesL</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519676"><span class="hs-identifier hs-var">notesR</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-476"></span><span>        </span><span id="local-6989586621679519674"><span class="annot"><span class="annottext">leftSingleEdges :: [(StartStop n, StartStop n)]
</span><a href="#local-6989586621679519674"><span class="hs-identifier hs-var hs-var">leftSingleEdges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679519673"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519673"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519672"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519672"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RightOrnament
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519673"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519672"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall {a} {b}. Map a [b] -&gt; [(a, b)]
</span><a href="#local-6989586621679519671"><span class="hs-identifier hs-var">allOps</span></a></span><span> </span><span class="annot"><span class="annottext">Map n [(n, RightOrnament)]
</span><a href="#local-6989586621679519695"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-477"></span><span>        </span><span id="local-6989586621679519670"><span class="annot"><span class="annottext">rightSingleEdges :: [(StartStop n, StartStop n)]
</span><a href="#local-6989586621679519670"><span class="hs-identifier hs-var hs-var">rightSingleEdges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679519669"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519669"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519668"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519668"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LeftOrnament
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519668"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519669"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall {a} {b}. Map a [b] -&gt; [(a, b)]
</span><a href="#local-6989586621679519671"><span class="hs-identifier hs-var">allOps</span></a></span><span> </span><span class="annot"><span class="annottext">Map n [(n, LeftOrnament)]
</span><a href="#local-6989586621679519694"><span class="hs-identifier hs-var">rs</span></a></span><span>
</span><span id="line-478"></span><span>        </span><span id="local-6989586621679519667"><span class="annot"><span class="annottext">edgesl :: HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519667"><span class="hs-identifier hs-var hs-var">edgesl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519687"><span class="hs-identifier hs-var">leftRegsReg</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519681"><span class="hs-identifier hs-var">leftRegsPass</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(StartStop n, StartStop n)]
</span><a href="#local-6989586621679519674"><span class="hs-identifier hs-var">leftSingleEdges</span></a></span><span>
</span><span id="line-479"></span><span>        </span><span id="local-6989586621679519665"><span class="annot"><span class="annottext">edgesr :: HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519665"><span class="hs-identifier hs-var hs-var">edgesr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519686"><span class="hs-identifier hs-var">rightRegsReg</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519680"><span class="hs-identifier hs-var">rightRegsPass</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(StartStop n, StartStop n)]
</span><a href="#local-6989586621679519670"><span class="hs-identifier hs-var">rightSingleEdges</span></a></span><span>
</span><span id="line-480"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-481"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">forall n. HashSet (Edge n) -&gt; MultiSet (InnerEdge n) -&gt; Edges n
</span><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-var">Edges</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519667"><span class="hs-identifier hs-var">edgesl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a.
(Eq a, Hashable a) =&gt;
MultiSet a -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#union"><span class="hs-identifier hs-var">MS.union</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519683"><span class="hs-identifier hs-var">leftPassings</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519693"><span class="hs-identifier hs-var">passl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-482"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall n. MultiSet n -&gt; Notes n
</span><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-var">Notes</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519675"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-483"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall n. HashSet (Edge n) -&gt; MultiSet (InnerEdge n) -&gt; Edges n
</span><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-var">Edges</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519665"><span class="hs-identifier hs-var">edgesr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a.
(Eq a, Hashable a) =&gt;
MultiSet a -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#union"><span class="hs-identifier hs-var">MS.union</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519682"><span class="hs-identifier hs-var">rightPassings</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519692"><span class="hs-identifier hs-var">passr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-484"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-485"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-486"></span><span>  </span><span id="local-6989586621679519671"><span class="annot"><span class="annottext">allOps :: Map a [b] -&gt; [(a, b)]
</span><a href="#local-6989586621679519671"><span class="hs-identifier hs-var hs-var">allOps</span></a></span></span><span> </span><span id="local-6989586621679519661"><span class="annot"><span class="annottext">Map a [b]
</span><a href="#local-6989586621679519661"><span class="hs-identifier hs-var">opset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-487"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679519660"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679519660"><span class="hs-identifier hs-var">parent</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519659"><span class="annot"><span class="annottext">[b]
</span><a href="#local-6989586621679519659"><span class="hs-identifier hs-var">children</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">Map a [b]
</span><a href="#local-6989586621679519661"><span class="hs-identifier hs-var">opset</span></a></span><span>
</span><span id="line-488"></span><span>    </span><span id="local-6989586621679519658"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679519658"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[b]
</span><a href="#local-6989586621679519659"><span class="hs-identifier hs-var">children</span></a></span><span>
</span><span id="line-489"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679519660"><span class="hs-identifier hs-var">parent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679519658"><span class="hs-identifier hs-var">child</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span>  </span><span id="local-6989586621679519651"><span class="annot"><span class="annottext">showEdge :: (i, i) -&gt; String
</span><a href="#local-6989586621679519651"><span class="hs-identifier hs-var hs-var">showEdge</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519650"><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679519650"><span class="hs-identifier hs-var">p1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519649"><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679519649"><span class="hs-identifier hs-var">p2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall i. Notation i =&gt; i -&gt; String
</span><span class="hs-identifier hs-var">showNotation</span></span><span> </span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679519650"><span class="hs-identifier hs-var">p1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;-&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall i. Notation i =&gt; i -&gt; String
</span><span class="hs-identifier hs-var">showNotation</span></span><span> </span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621679519649"><span class="hs-identifier hs-var">p2</span></a></span><span>
</span><span id="line-492"></span><span>  </span><span id="local-6989586621679519639"><span class="annot"><span class="annottext">showEdges :: t (i, i) -&gt; String
</span><a href="#local-6989586621679519639"><span class="hs-identifier hs-var hs-var">showEdges</span></a></span></span><span> </span><span id="local-6989586621679519638"><span class="annot"><span class="annottext">t (i, i)
</span><a href="#local-6989586621679519638"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;{&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [[a]] -&gt; [a]
</span><span class="hs-identifier hs-var">L.intercalate</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;,&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {i} {i}. (Notation i, Notation i) =&gt; (i, i) -&gt; String
</span><a href="#local-6989586621679519651"><span class="hs-identifier hs-var">showEdge</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">t (i, i)
</span><a href="#local-6989586621679519638"><span class="hs-identifier hs-var">ts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;}&quot;</span></span><span>
</span><span id="line-493"></span><span>
</span><span id="line-494"></span><span>  </span><span id="local-6989586621679519685"><span class="annot"><span class="annottext">applyRegs :: HashSet (StartStop n, StartStop n)
-&gt; Map (StartStop n, StartStop n) [(n, DoubleOrnament)]
-&gt; Either
     String
     (MultiSet n, HashSet (StartStop n, StartStop n),
      HashSet (StartStop n, StartStop n))
</span><a href="#local-6989586621679519685"><span class="hs-identifier hs-var hs-var">applyRegs</span></a></span></span><span> </span><span id="local-6989586621679519637"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519637"><span class="hs-identifier hs-var">top</span></a></span></span><span> </span><span id="local-6989586621679519636"><span class="annot"><span class="annottext">Map (StartStop n, StartStop n) [(n, DoubleOrnament)]
</span><a href="#local-6989586621679519636"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-495"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679519635"><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519635"><span class="hs-identifier hs-var">notes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519634"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519634"><span class="hs-identifier hs-var">edgesl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519633"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519633"><span class="hs-identifier hs-var">edgesr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-496"></span><span>      </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
-&gt; (MultiSet n, HashSet (StartStop n, StartStop n),
    HashSet (StartStop n, StartStop n))
-&gt; ((StartStop n, StartStop n), (n, DoubleOrnament))
-&gt; Either
     String
     (MultiSet n, HashSet (StartStop n, StartStop n),
      HashSet (StartStop n, StartStop n))
</span><a href="#local-6989586621679519632"><span class="hs-identifier hs-var">applyReg</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519637"><span class="hs-identifier hs-var">top</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. HashSet a
</span><span class="hs-identifier hs-var">S.empty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. HashSet a
</span><span class="hs-identifier hs-var">S.empty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-497"></span><span>        </span><span class="annot"><span class="annottext">forall {a} {b}. Map a [b] -&gt; [(a, b)]
</span><a href="#local-6989586621679519671"><span class="hs-identifier hs-var">allOps</span></a></span><span> </span><span class="annot"><span class="annottext">Map (StartStop n, StartStop n) [(n, DoubleOrnament)]
</span><a href="#local-6989586621679519636"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-498"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519635"><span class="hs-identifier hs-var">notes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519634"><span class="hs-identifier hs-var">edgesl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519633"><span class="hs-identifier hs-var">edgesr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-499"></span><span>
</span><span id="line-500"></span><span>  </span><span id="local-6989586621679519632"><span class="annot"><span class="annottext">applyReg :: HashSet (StartStop n, StartStop n)
-&gt; (MultiSet n, HashSet (StartStop n, StartStop n),
    HashSet (StartStop n, StartStop n))
-&gt; ((StartStop n, StartStop n), (n, DoubleOrnament))
-&gt; Either
     String
     (MultiSet n, HashSet (StartStop n, StartStop n),
      HashSet (StartStop n, StartStop n))
</span><a href="#local-6989586621679519632"><span class="hs-identifier hs-var hs-var">applyReg</span></a></span></span><span> </span><span id="local-6989586621679519631"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519631"><span class="hs-identifier hs-var">topAll</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519630"><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519630"><span class="hs-identifier hs-var">notes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519629"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519629"><span class="hs-identifier hs-var">edgesl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519628"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519628"><span class="hs-identifier hs-var">edgesr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519627"><span class="annot"><span class="annottext">(StartStop n, StartStop n)
</span><a href="#local-6989586621679519627"><span class="hs-identifier hs-var">parent</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519626"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519626"><span class="hs-identifier hs-var">note</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DoubleOrnament
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-501"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(StartStop n, StartStop n)
</span><a href="#local-6989586621679519627"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; a -&gt; HashSet a -&gt; Bool
</span><span class="hs-operator hs-var">`S.member`</span></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519631"><span class="hs-identifier hs-var">topAll</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-502"></span><span>        </span><span class="annot"><span class="annottext">forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519625"><span class="hs-identifier hs-var">notes'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519624"><span class="hs-identifier hs-var">edgesl'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519623"><span class="hs-identifier hs-var">edgesr'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-503"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-504"></span><span>        </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-505"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;used non-existing terminal edge\n  top=&quot;</span></span><span>
</span><span id="line-506"></span><span>            </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679519691"><span class="hs-identifier hs-var">inTop</span></a></span><span>
</span><span id="line-507"></span><span>            </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n  split=&quot;</span></span><span>
</span><span id="line-508"></span><span>            </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Split n
</span><a href="#local-6989586621679519698"><span class="hs-identifier hs-var">inSplit</span></a></span><span>
</span><span id="line-509"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-510"></span><span>    </span><span id="local-6989586621679519625"><span class="annot"><span class="annottext">notes' :: MultiSet n
</span><a href="#local-6989586621679519625"><span class="hs-identifier hs-var hs-var">notes'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; a -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#insert"><span class="hs-identifier hs-var">MS.insert</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519626"><span class="hs-identifier hs-var">note</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519630"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-511"></span><span>    </span><span id="local-6989586621679519624"><span class="annot"><span class="annottext">edgesl' :: HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519624"><span class="hs-identifier hs-var hs-var">edgesl'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; a -&gt; HashSet a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(StartStop n, StartStop n)
</span><a href="#local-6989586621679519627"><span class="hs-identifier hs-var">parent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519626"><span class="hs-identifier hs-var">note</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519629"><span class="hs-identifier hs-var">edgesl</span></a></span><span>
</span><span id="line-512"></span><span>    </span><span id="local-6989586621679519623"><span class="annot"><span class="annottext">edgesr' :: HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519623"><span class="hs-identifier hs-var hs-var">edgesr'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; a -&gt; HashSet a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519626"><span class="hs-identifier hs-var">note</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(StartStop n, StartStop n)
</span><a href="#local-6989586621679519627"><span class="hs-identifier hs-var">parent</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519628"><span class="hs-identifier hs-var">edgesr</span></a></span><span>
</span><span id="line-513"></span><span>
</span><span id="line-514"></span><span>  </span><span id="local-6989586621679519679"><span class="annot"><span class="annottext">applyPassings :: MultiSet (n, n)
-&gt; Map (n, n) [(n, PassingOrnament)]
-&gt; Either
     String
     (MultiSet n, MultiSet (n, n), MultiSet (n, n),
      HashSet (StartStop n, StartStop n),
      HashSet (StartStop n, StartStop n))
</span><a href="#local-6989586621679519679"><span class="hs-identifier hs-var hs-var">applyPassings</span></a></span></span><span> </span><span id="local-6989586621679519622"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519622"><span class="hs-identifier hs-var">top</span></a></span></span><span> </span><span id="local-6989586621679519621"><span class="annot"><span class="annottext">Map (n, n) [(n, PassingOrnament)]
</span><a href="#local-6989586621679519621"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-515"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679519620"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519620"><span class="hs-identifier hs-var">top'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519619"><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519619"><span class="hs-identifier hs-var">notes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519618"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519618"><span class="hs-identifier hs-var">lPassings</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519617"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519617"><span class="hs-identifier hs-var">rPassings</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519616"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519616"><span class="hs-identifier hs-var">lRegs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519615"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519615"><span class="hs-identifier hs-var">rRegs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-516"></span><span>      </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="annot"><span class="annottext">(MultiSet (n, n), MultiSet n, MultiSet (n, n), MultiSet (n, n),
 HashSet (StartStop n, StartStop n),
 HashSet (StartStop n, StartStop n))
-&gt; ((n, n), (n, PassingOrnament))
-&gt; Either
     String
     (MultiSet (n, n), MultiSet n, MultiSet (n, n), MultiSet (n, n),
      HashSet (StartStop n, StartStop n),
      HashSet (StartStop n, StartStop n))
</span><a href="#local-6989586621679519614"><span class="hs-identifier hs-var">applyPassing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519622"><span class="hs-identifier hs-var">top</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. HashSet a
</span><span class="hs-identifier hs-var">S.empty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. HashSet a
</span><span class="hs-identifier hs-var">S.empty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-517"></span><span>        </span><span class="annot"><span class="annottext">forall {a} {b}. Map a [b] -&gt; [(a, b)]
</span><a href="#local-6989586621679519671"><span class="hs-identifier hs-var">allOps</span></a></span><span> </span><span class="annot"><span class="annottext">Map (n, n) [(n, PassingOrnament)]
</span><a href="#local-6989586621679519621"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-518"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">forall k. MultiSet k -&gt; Bool
</span><a href="Internal.MultiSet.html#null"><span class="hs-identifier hs-var">MS.null</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519620"><span class="hs-identifier hs-var">top'</span></a></span><span>
</span><span id="line-519"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519619"><span class="hs-identifier hs-var">notes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519618"><span class="hs-identifier hs-var">lPassings</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519617"><span class="hs-identifier hs-var">rPassings</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519616"><span class="hs-identifier hs-var">lRegs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519615"><span class="hs-identifier hs-var">rRegs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-520"></span><span>      </span><span class="hs-keyword">else</span><span>
</span><span id="line-521"></span><span>        </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-522"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;did not use all non-terminal edges, remaining: &quot;</span></span><span>
</span><span id="line-523"></span><span>            </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall {i} {i} {t :: * -&gt; *}.
(Notation i, Notation i, Foldable t) =&gt;
t (i, i) -&gt; String
</span><a href="#local-6989586621679519639"><span class="hs-identifier hs-var">showEdges</span></a></span><span>
</span><span id="line-524"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. MultiSet a -&gt; [a]
</span><a href="Internal.MultiSet.html#toList"><span class="hs-identifier hs-var">MS.toList</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519620"><span class="hs-identifier hs-var">top'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-525"></span><span>
</span><span id="line-526"></span><span>  </span><span id="local-6989586621679519614"><span class="annot"><span class="annottext">applyPassing :: (MultiSet (n, n), MultiSet n, MultiSet (n, n), MultiSet (n, n),
 HashSet (StartStop n, StartStop n),
 HashSet (StartStop n, StartStop n))
-&gt; ((n, n), (n, PassingOrnament))
-&gt; Either
     String
     (MultiSet (n, n), MultiSet n, MultiSet (n, n), MultiSet (n, n),
      HashSet (StartStop n, StartStop n),
      HashSet (StartStop n, StartStop n))
</span><a href="#local-6989586621679519614"><span class="hs-identifier hs-var hs-var">applyPassing</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519613"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519613"><span class="hs-identifier hs-var">top</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519612"><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519612"><span class="hs-identifier hs-var">notes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519611"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519611"><span class="hs-identifier hs-var">lPassings</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519610"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519610"><span class="hs-identifier hs-var">rPassings</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519609"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519609"><span class="hs-identifier hs-var">lRegs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519608"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519608"><span class="hs-identifier hs-var">rRegs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519607"><span class="annot"><span class="annottext">parent :: (n, n)
</span><a href="#local-6989586621679519607"><span class="hs-identifier hs-var">parent</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679519606"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519606"><span class="hs-identifier hs-var">pl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519605"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519605"><span class="hs-identifier hs-var">pr</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519604"><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519604"><span class="hs-identifier hs-var">note</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519603"><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679519603"><span class="hs-identifier hs-var">pass</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-527"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(n, n)
</span><a href="#local-6989586621679519607"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">forall k. (Eq k, Hashable k) =&gt; k -&gt; MultiSet k -&gt; Bool
</span><a href="Internal.MultiSet.html#member"><span class="hs-operator hs-var">`MS.member`</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519613"><span class="hs-identifier hs-var">top</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-528"></span><span>        </span><span class="annot"><span class="annottext">forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519602"><span class="hs-identifier hs-var">top'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519601"><span class="hs-identifier hs-var">notes'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519600"><span class="hs-identifier hs-var">lPassings'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519599"><span class="hs-identifier hs-var">rPassings'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519598"><span class="hs-identifier hs-var">lRegs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519597"><span class="hs-identifier hs-var">rRegs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-529"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-530"></span><span>        </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-531"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;used non-existing non-terminal edge\n  top=&quot;</span></span><span>
</span><span id="line-532"></span><span>            </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679519691"><span class="hs-identifier hs-var">inTop</span></a></span><span>
</span><span id="line-533"></span><span>            </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n  split=&quot;</span></span><span>
</span><span id="line-534"></span><span>            </span><span class="annot"><span class="annottext">forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Split n
</span><a href="#local-6989586621679519698"><span class="hs-identifier hs-var">inSplit</span></a></span><span>
</span><span id="line-535"></span><span>   </span><span class="hs-keyword">where</span><span>
</span><span id="line-536"></span><span>    </span><span id="local-6989586621679519602"><span class="annot"><span class="annottext">top' :: MultiSet (n, n)
</span><a href="#local-6989586621679519602"><span class="hs-identifier hs-var hs-var">top'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; a -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#delete"><span class="hs-identifier hs-var">MS.delete</span></a></span><span> </span><span class="annot"><span class="annottext">(n, n)
</span><a href="#local-6989586621679519607"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519613"><span class="hs-identifier hs-var">top</span></a></span><span>
</span><span id="line-537"></span><span>    </span><span id="local-6989586621679519601"><span class="annot"><span class="annottext">notes' :: MultiSet n
</span><a href="#local-6989586621679519601"><span class="hs-identifier hs-var hs-var">notes'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; a -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#insert"><span class="hs-identifier hs-var">MS.insert</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519604"><span class="hs-identifier hs-var">note</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet n
</span><a href="#local-6989586621679519612"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-538"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679519596"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519596"><span class="hs-identifier hs-var">newlPassing</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519595"><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519595"><span class="hs-identifier hs-var">newrPassing</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519594"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519594"><span class="hs-identifier hs-var">newlReg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519593"><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519593"><span class="hs-identifier hs-var">newrReg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="#local-6989586621679519603"><span class="hs-identifier hs-var">pass</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-539"></span><span>      </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="PVGrammar.html#PassingMid"><span class="hs-identifier hs-var">PassingMid</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-540"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span>
</span><span id="line-541"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span>
</span><span id="line-542"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519606"><span class="hs-identifier hs-var">pl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519604"><span class="hs-identifier hs-var">note</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-543"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519604"><span class="hs-identifier hs-var">note</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519605"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-544"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-545"></span><span>      </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="PVGrammar.html#PassingLeft"><span class="hs-identifier hs-var">PassingLeft</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-546"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span>
</span><span id="line-547"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#singleton"><span class="hs-identifier hs-var">MS.singleton</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519604"><span class="hs-identifier hs-var">note</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519605"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-548"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519606"><span class="hs-identifier hs-var">pl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519604"><span class="hs-identifier hs-var">note</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-549"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. HashSet a
</span><span class="hs-identifier hs-var">S.empty</span></span><span>
</span><span id="line-550"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-551"></span><span>      </span><span class="annot"><span class="annottext">PassingOrnament
</span><a href="PVGrammar.html#PassingRight"><span class="hs-identifier hs-var">PassingRight</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-552"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#singleton"><span class="hs-identifier hs-var">MS.singleton</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519606"><span class="hs-identifier hs-var">pl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519604"><span class="hs-identifier hs-var">note</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-553"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span>
</span><span id="line-554"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. HashSet a
</span><span class="hs-identifier hs-var">S.empty</span></span><span>
</span><span id="line-555"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519604"><span class="hs-identifier hs-var">note</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; StartStop a
</span><a href="Common.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">n
</span><a href="#local-6989586621679519605"><span class="hs-identifier hs-var">pr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-556"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-557"></span><span>    </span><span id="local-6989586621679519600"><span class="annot"><span class="annottext">lPassings' :: MultiSet (n, n)
</span><a href="#local-6989586621679519600"><span class="hs-identifier hs-var hs-var">lPassings'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a.
(Eq a, Hashable a) =&gt;
MultiSet a -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#union"><span class="hs-identifier hs-var">MS.union</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519596"><span class="hs-identifier hs-var">newlPassing</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519611"><span class="hs-identifier hs-var">lPassings</span></a></span><span>
</span><span id="line-558"></span><span>    </span><span id="local-6989586621679519599"><span class="annot"><span class="annottext">rPassings' :: MultiSet (n, n)
</span><a href="#local-6989586621679519599"><span class="hs-identifier hs-var hs-var">rPassings'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a.
(Eq a, Hashable a) =&gt;
MultiSet a -&gt; MultiSet a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#union"><span class="hs-identifier hs-var">MS.union</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519595"><span class="hs-identifier hs-var">newrPassing</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (n, n)
</span><a href="#local-6989586621679519610"><span class="hs-identifier hs-var">rPassings</span></a></span><span>
</span><span id="line-559"></span><span>    </span><span id="local-6989586621679519598"><span class="annot"><span class="annottext">lRegs' :: HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519598"><span class="hs-identifier hs-var hs-var">lRegs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; HashSet a -&gt; HashSet a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.union</span></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519594"><span class="hs-identifier hs-var">newlReg</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519609"><span class="hs-identifier hs-var">lRegs</span></a></span><span>
</span><span id="line-560"></span><span>    </span><span id="local-6989586621679519597"><span class="annot"><span class="annottext">rRegs' :: HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519597"><span class="hs-identifier hs-var hs-var">rRegs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; HashSet a -&gt; HashSet a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.union</span></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519593"><span class="hs-identifier hs-var">newrReg</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (StartStop n, StartStop n)
</span><a href="#local-6989586621679519608"><span class="hs-identifier hs-var">rRegs</span></a></span><span>
</span><span id="line-561"></span><span>
</span><span id="line-562"></span><span>  </span><span id="local-6989586621679519592"><span class="annot"><span class="annottext">singleChild :: (a, (a, b)) -&gt; a
</span><a href="#local-6989586621679519592"><span class="hs-identifier hs-var hs-var">singleChild</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519591"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679519591"><span class="hs-identifier hs-var">note</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679519591"><span class="hs-identifier hs-var">note</span></a></span><span>
</span><span id="line-563"></span><span>  </span><span id="local-6989586621679519677"><span class="annot"><span class="annottext">collectNotes :: Map a [(a, b)] -&gt; MultiSet a
</span><a href="#local-6989586621679519677"><span class="hs-identifier hs-var hs-var">collectNotes</span></a></span></span><span> </span><span id="local-6989586621679519584"><span class="annot"><span class="annottext">Map a [(a, b)]
</span><a href="#local-6989586621679519584"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a.
(Foldable t, Eq a, Hashable a) =&gt;
t a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#fromList"><span class="hs-identifier hs-var">MS.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall {a} {a} {b}. (a, (a, b)) -&gt; a
</span><a href="#local-6989586621679519592"><span class="hs-identifier hs-var">singleChild</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall {a} {b}. Map a [b] -&gt; [(a, b)]
</span><a href="#local-6989586621679519671"><span class="hs-identifier hs-var">allOps</span></a></span><span> </span><span class="annot"><span class="annottext">Map a [(a, b)]
</span><a href="#local-6989586621679519584"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-564"></span><span>
</span><span id="line-565"></span><span class="hs-comment">{- | A variant of 'applyFreeze' that allows non-&quot;tie&quot; edges in the open transition.
 This is useful in conjunction with 'applySplitAllEdges'
 because the non-tie edges will not be dropped before freezing.
-}</span><span>
</span><span id="line-569"></span><span id="applyFreezeAllEdges"><span class="annot"><span class="annottext">applyFreezeAllEdges :: Freeze -&gt; Edges n -&gt; Either String (Edges n)
</span><a href="PVGrammar.Generate.html#applyFreezeAllEdges"><span class="hs-identifier hs-var hs-var">applyFreezeAllEdges</span></a></span></span><span> </span><span class="annot"><span class="annottext">Freeze
</span><a href="PVGrammar.html#FreezeOp"><span class="hs-identifier hs-var">FreezeOp</span></a></span><span> </span><span id="local-6989586621679519582"><span class="annot"><span class="annottext">e :: Edges n
</span><a href="#local-6989586621679519582"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span id="local-6989586621679519581"><span class="annot"><span class="annottext">HashSet (Edge n)
</span><a href="#local-6989586621679519581"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621679519580"><span class="annot"><span class="annottext">MultiSet (InnerEdge n)
</span><a href="#local-6989586621679519580"><span class="hs-identifier hs-var">nts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-570"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall k. MultiSet k -&gt; Bool
</span><a href="Internal.MultiSet.html#null"><span class="hs-identifier hs-var">MS.null</span></a></span><span> </span><span class="annot"><span class="annottext">MultiSet (InnerEdge n)
</span><a href="#local-6989586621679519580"><span class="hs-identifier hs-var">nts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cannot freeze non-terminal edges&quot;</span></span><span>
</span><span id="line-571"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679519582"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-572"></span><span>
</span><span id="line-573"></span><span class="hs-comment">-- debugging analyses</span><span>
</span><span id="line-574"></span><span>
</span><span id="line-575"></span><span class="hs-comment">{- | A specialized version of 'debugAnalysis' for protovoice derivations.
 Prints the steps and intermediate configurations of a derivation.
-}</span><span>
</span><span id="line-578"></span><span id="local-6989586621679520363"><span class="annot"><a href="PVGrammar.Generate.html#debugPVAnalysis"><span class="hs-identifier hs-type">debugPVAnalysis</span></a></span><span>
</span><span id="line-579"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Notation</span></span><span> </span><span class="annot"><a href="#local-6989586621679520363"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679520363"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679520363"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MC.HasPitch</span></span><span> </span><span class="annot"><a href="#local-6989586621679520363"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MC.IntervalOf</span></span><span> </span><span class="annot"><a href="#local-6989586621679520363"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-580"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PVGrammar.html#PVAnalysis"><span class="hs-identifier hs-type">PVAnalysis</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520363"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-581"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-582"></span><span id="debugPVAnalysis"><span class="annot"><span class="annottext">debugPVAnalysis :: forall n.
(Notation n, Ord n, Hashable n, HasPitch n, Eq (IntervalOf n)) =&gt;
PVAnalysis n -&gt; IO (Either String ())
</span><a href="PVGrammar.Generate.html#debugPVAnalysis"><span class="hs-identifier hs-var hs-var">debugPVAnalysis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall tr slc s f h.
(Show tr, Show slc, Show s, Show h) =&gt;
(s -&gt; tr -&gt; Either String (tr, slc, tr))
-&gt; (f -&gt; tr -&gt; Either String tr)
-&gt; (h -&gt; tr -&gt; slc -&gt; tr -&gt; Either String (tr, slc, tr, slc, tr))
-&gt; Analysis s f h tr slc
-&gt; IO (Either String ())
</span><a href="Common.html#debugAnalysis"><span class="hs-identifier hs-var">debugAnalysis</span></a></span><span> </span><span class="annot"><span class="annottext">forall n.
(Ord n, Notation n, Hashable n) =&gt;
Split n -&gt; Edges n -&gt; Either String (Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySplit"><span class="hs-identifier hs-var">applySplit</span></a></span><span> </span><span class="annot"><span class="annottext">forall n.
(Eq (IntervalOf n), HasPitch n) =&gt;
Freeze -&gt; Edges n -&gt; Either String (Edges n)
</span><a href="PVGrammar.Generate.html#applyFreeze"><span class="hs-identifier hs-var">applyFreeze</span></a></span><span> </span><span class="annot"><span class="annottext">forall n.
(Ord n, Notation n, Hashable n) =&gt;
Spread n
-&gt; Edges n
-&gt; Notes n
-&gt; Edges n
-&gt; Either String (Edges n, Notes n, Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySpread"><span class="hs-identifier hs-var">applySpread</span></a></span><span>
</span><span id="line-583"></span><span>
</span><span id="line-584"></span><span class="hs-comment">-- derivation player</span><span>
</span><span id="line-585"></span><span class="hs-comment">-- =================</span><span>
</span><span id="line-586"></span><span>
</span><span id="line-587"></span><span class="hs-comment">{- | A derivation player for protovoices.
 The default version of the PV player drops all edges that are not used later on
 when generating child transitions.
 This behaviour matches the intermediate representation of the parsers,
 which only track edges that are necessary to explain the downstream notes.
 If you want to generate all edges (i.e., all functional relations between notes)
 use 'derivationPlayerPVAllEdges'.
-}</span><span>
</span><span id="line-595"></span><span id="local-6989586621679520352"><span class="annot"><a href="PVGrammar.Generate.html#derivationPlayerPV"><span class="hs-identifier hs-type">derivationPlayerPV</span></a></span><span>
</span><span id="line-596"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679520352"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679520352"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Notation</span></span><span> </span><span class="annot"><a href="#local-6989586621679520352"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679520352"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MC.IntervalOf</span></span><span> </span><span class="annot"><a href="#local-6989586621679520352"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MC.HasPitch</span></span><span> </span><span class="annot"><a href="#local-6989586621679520352"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-597"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Display.html#DerivationPlayer"><span class="hs-identifier hs-type">DerivationPlayer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520352"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520352"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520352"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520352"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-598"></span><span id="derivationPlayerPV"><span class="annot"><span class="annottext">derivationPlayerPV :: forall n.
(Eq n, Ord n, Notation n, Hashable n, Eq (IntervalOf n),
 HasPitch n) =&gt;
DerivationPlayer (Split n) Freeze (Spread n) (Notes n) (Edges n)
</span><a href="PVGrammar.Generate.html#derivationPlayerPV"><span class="hs-identifier hs-var hs-var">derivationPlayerPV</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-599"></span><span>  </span><span class="annot"><span class="annottext">forall s f h slc tr.
tr
-&gt; (s -&gt; tr -&gt; Either String (tr, slc, tr))
-&gt; (f -&gt; tr -&gt; Either String tr)
-&gt; (h -&gt; tr -&gt; slc -&gt; tr -&gt; Either String (tr, slc, tr, slc, tr))
-&gt; DerivationPlayer s f h slc tr
</span><a href="Display.html#DerivationPlayer"><span class="hs-identifier hs-var">DerivationPlayer</span></a></span><span>
</span><span id="line-600"></span><span>    </span><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679519544"><span class="hs-identifier hs-var">topTrans</span></a></span><span>
</span><span id="line-601"></span><span>    </span><span class="annot"><span class="annottext">forall n.
(Ord n, Notation n, Hashable n) =&gt;
Split n -&gt; Edges n -&gt; Either String (Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySplit"><span class="hs-identifier hs-var">applySplit</span></a></span><span>
</span><span id="line-602"></span><span>    </span><span class="annot"><span class="annottext">forall n.
(Eq (IntervalOf n), HasPitch n) =&gt;
Freeze -&gt; Edges n -&gt; Either String (Edges n)
</span><a href="PVGrammar.Generate.html#applyFreeze"><span class="hs-identifier hs-var">applyFreeze</span></a></span><span>
</span><span id="line-603"></span><span>    </span><span class="annot"><span class="annottext">forall n.
(Ord n, Notation n, Hashable n) =&gt;
Spread n
-&gt; Edges n
-&gt; Notes n
-&gt; Edges n
-&gt; Either String (Edges n, Notes n, Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySpread"><span class="hs-identifier hs-var">applySpread</span></a></span><span>
</span><span id="line-604"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-605"></span><span>  </span><span id="local-6989586621679519544"><span class="annot"><span class="annottext">topTrans :: Edges n
</span><a href="#local-6989586621679519544"><span class="hs-identifier hs-var hs-var">topTrans</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall n. HashSet (Edge n) -&gt; MultiSet (InnerEdge n) -&gt; Edges n
</span><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-var">Edges</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. StartStop a
</span><a href="Common.html#Start"><span class="hs-identifier hs-var">Start</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. StartStop a
</span><a href="Common.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span>
</span><span id="line-606"></span><span>
</span><span id="line-607"></span><span class="hs-comment">{- | A derivation player for protovoices that produces all edges
 that express a functional relation between two notes.
 For a version that only produces &quot;necessary&quot; edges, use 'derivationPlayerPV'.
-}</span><span>
</span><span id="line-611"></span><span id="local-6989586621679519537"><span class="annot"><a href="PVGrammar.Generate.html#derivationPlayerPVAllEdges"><span class="hs-identifier hs-type">derivationPlayerPVAllEdges</span></a></span><span>
</span><span id="line-612"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679519537"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679519537"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Notation</span></span><span> </span><span class="annot"><a href="#local-6989586621679519537"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679519537"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MC.IntervalOf</span></span><span> </span><span class="annot"><a href="#local-6989586621679519537"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MC.HasPitch</span></span><span> </span><span class="annot"><a href="#local-6989586621679519537"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-613"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Display.html#DerivationPlayer"><span class="hs-identifier hs-type">DerivationPlayer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679519537"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679519537"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-type">Notes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679519537"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-type">Edges</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679519537"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-614"></span><span id="derivationPlayerPVAllEdges"><span class="annot"><span class="annottext">derivationPlayerPVAllEdges :: forall n.
(Eq n, Ord n, Notation n, Hashable n, Eq (IntervalOf n),
 HasPitch n) =&gt;
DerivationPlayer (Split n) Freeze (Spread n) (Notes n) (Edges n)
</span><a href="PVGrammar.Generate.html#derivationPlayerPVAllEdges"><span class="hs-identifier hs-var hs-var">derivationPlayerPVAllEdges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-615"></span><span>  </span><span class="annot"><span class="annottext">forall s f h slc tr.
tr
-&gt; (s -&gt; tr -&gt; Either String (tr, slc, tr))
-&gt; (f -&gt; tr -&gt; Either String tr)
-&gt; (h -&gt; tr -&gt; slc -&gt; tr -&gt; Either String (tr, slc, tr, slc, tr))
-&gt; DerivationPlayer s f h slc tr
</span><a href="Display.html#DerivationPlayer"><span class="hs-identifier hs-var">DerivationPlayer</span></a></span><span>
</span><span id="line-616"></span><span>    </span><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679519524"><span class="hs-identifier hs-var">topTrans</span></a></span><span>
</span><span id="line-617"></span><span>    </span><span class="annot"><span class="annottext">forall n.
(Ord n, Notation n, Hashable n) =&gt;
Split n -&gt; Edges n -&gt; Either String (Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySplitAllEdges"><span class="hs-identifier hs-var">applySplitAllEdges</span></a></span><span>
</span><span id="line-618"></span><span>    </span><span class="annot"><span class="annottext">forall {n}. Freeze -&gt; Edges n -&gt; Either String (Edges n)
</span><a href="PVGrammar.Generate.html#applyFreezeAllEdges"><span class="hs-identifier hs-var">applyFreezeAllEdges</span></a></span><span>
</span><span id="line-619"></span><span>    </span><span class="annot"><span class="annottext">forall n.
(Ord n, Notation n, Hashable n) =&gt;
Spread n
-&gt; Edges n
-&gt; Notes n
-&gt; Edges n
-&gt; Either String (Edges n, Notes n, Edges n, Notes n, Edges n)
</span><a href="PVGrammar.Generate.html#applySpread"><span class="hs-identifier hs-var">applySpread</span></a></span><span>
</span><span id="line-620"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-621"></span><span>  </span><span id="local-6989586621679519524"><span class="annot"><span class="annottext">topTrans :: Edges n
</span><a href="#local-6989586621679519524"><span class="hs-identifier hs-var hs-var">topTrans</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall n. HashSet (Edge n) -&gt; MultiSet (InnerEdge n) -&gt; Edges n
</span><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-var">Edges</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Hashable a =&gt; a -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. StartStop a
</span><a href="Common.html#Start"><span class="hs-identifier hs-var">Start</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. StartStop a
</span><a href="Common.html#Stop"><span class="hs-identifier hs-var">Stop</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span>
</span><span id="line-622"></span><span>
</span><span id="line-623"></span><span class="hs-comment">{- | Compares the output of a derivation
 with the original piece (as provided to the parser).
 Returns 'True' if the output matches the original
 and 'False' if the output doesn't match or the derivation is invalid.
-}</span><span>
</span><span id="line-628"></span><span id="local-6989586621679520343"><span class="annot"><a href="PVGrammar.Generate.html#checkDerivation"><span class="hs-identifier hs-type">checkDerivation</span></a></span><span>
</span><span id="line-629"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679520343"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-630"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Notation</span></span><span> </span><span class="annot"><a href="#local-6989586621679520343"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-631"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679520343"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-632"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MC.IntervalOf</span></span><span> </span><span class="annot"><a href="#local-6989586621679520343"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-633"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MC.HasPitch</span></span><span> </span><span class="annot"><a href="#local-6989586621679520343"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-634"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621679520343"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-635"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-636"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Common.html#Leftmost"><span class="hs-identifier hs-type">Leftmost</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Split"><span class="hs-identifier hs-type">Split</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520343"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="PVGrammar.html#Freeze"><span class="hs-identifier hs-type">Freeze</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PVGrammar.html#Spread"><span class="hs-identifier hs-type">Spread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520343"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-637"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Common.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679520343"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="PVGrammar.html#Edge"><span class="hs-identifier hs-type">Edge</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679520343"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-638"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-639"></span><span id="checkDerivation"><span class="annot"><span class="annottext">checkDerivation :: forall n.
(Ord n, Notation n, Hashable n, Eq (IntervalOf n), HasPitch n,
 Show n) =&gt;
[Leftmost (Split n) Freeze (Spread n)] -&gt; Path [n] [Edge n] -&gt; Bool
</span><a href="PVGrammar.Generate.html#checkDerivation"><span class="hs-identifier hs-var hs-var">checkDerivation</span></a></span></span><span> </span><span id="local-6989586621679519480"><span class="annot"><span class="annottext">[Leftmost (Split n) Freeze (Spread n)]
</span><a href="#local-6989586621679519480"><span class="hs-identifier hs-var">deriv</span></a></span></span><span> </span><span id="local-6989586621679519479"><span class="annot"><span class="annottext">Path [n] [Edge n]
</span><a href="#local-6989586621679519479"><span class="hs-identifier hs-var">original</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-640"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) slc tr s f h.
(Foldable t, Ord slc, Ord tr) =&gt;
DerivationPlayer s f h slc tr
-&gt; t (Leftmost s f h) -&gt; Either String (DerivationGraph slc tr)
</span><a href="Display.html#replayDerivation"><span class="hs-identifier hs-var">replayDerivation</span></a></span><span> </span><span class="annot"><span class="annottext">forall n.
(Eq n, Ord n, Notation n, Hashable n, Eq (IntervalOf n),
 HasPitch n) =&gt;
DerivationPlayer (Split n) Freeze (Spread n) (Notes n) (Edges n)
</span><a href="PVGrammar.Generate.html#derivationPlayerPV"><span class="hs-identifier hs-var">derivationPlayerPV</span></a></span><span> </span><span class="annot"><span class="annottext">[Leftmost (Split n) Freeze (Spread n)]
</span><a href="#local-6989586621679519480"><span class="hs-identifier hs-var">deriv</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-641"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-642"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679519477"><span class="annot"><span class="annottext">DerivationGraph (Notes n) (Edges n)
</span><a href="#local-6989586621679519477"><span class="hs-identifier hs-var">g</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-643"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679519476"><span class="annot"><span class="annottext">path' :: Maybe (Path (Notes n) (Edges n), Edges n)
</span><a href="#local-6989586621679519476"><span class="hs-identifier hs-var hs-var">path'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall slc tr. DerivationGraph slc tr -&gt; [DerivTrans slc tr]
</span><a href="Display.html#dgFrozen"><span class="hs-identifier hs-var">dgFrozen</span></a></span><span> </span><span class="annot"><span class="annottext">DerivationGraph (Notes n) (Edges n)
</span><a href="#local-6989586621679519477"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-644"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DerivTrans (Notes n) (Edges n)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DerivSlice (Notes n)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519474"><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679519474"><span class="hs-identifier hs-var">tlast</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519473"><span class="annot"><span class="annottext">DerivSlice (Notes n)
</span><a href="#local-6989586621679519473"><span class="hs-identifier hs-var">slast</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679519472"><span class="annot"><span class="annottext">[DerivTrans (Notes n) (Edges n)]
</span><a href="#local-6989586621679519472"><span class="hs-identifier hs-var">rst</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-645"></span><span>              </span><span id="local-6989586621679519471"><span class="annot"><span class="annottext">Notes n
</span><a href="#local-6989586621679519471"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. StartStop a -&gt; Maybe a
</span><a href="Common.html#getInner"><span class="hs-identifier hs-var">getInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall slc. DerivSlice slc -&gt; StartStop slc
</span><a href="Display.html#dslContent"><span class="hs-identifier hs-var">dslContent</span></a></span><span> </span><span class="annot"><span class="annottext">DerivSlice (Notes n)
</span><a href="#local-6989586621679519473"><span class="hs-identifier hs-var">slast</span></a></span><span>
</span><span id="line-646"></span><span>              </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="annot"><span class="annottext">forall {around} {between} {a} {b}.
(Path around between, between)
-&gt; (a, b, DerivSlice around) -&gt; Maybe (Path around between, b)
</span><a href="#local-6989586621679519468"><span class="hs-identifier hs-var">foldPath</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall around between. around -&gt; Path around between
</span><a href="Common.html#PathEnd"><span class="hs-identifier hs-var">PathEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Notes n
</span><a href="#local-6989586621679519471"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges n
</span><a href="#local-6989586621679519474"><span class="hs-identifier hs-var">tlast</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DerivTrans (Notes n) (Edges n)]
</span><a href="#local-6989586621679519472"><span class="hs-identifier hs-var">rst</span></a></span><span>
</span><span id="line-647"></span><span>            </span><span class="annot"><span class="annottext">[DerivTrans (Notes n) (Edges n)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-648"></span><span>          </span><span id="local-6989586621679519466"><span class="annot"><span class="annottext">orig' :: Path (Notes n) (Edges n)
</span><a href="#local-6989586621679519466"><span class="hs-identifier hs-var hs-var">orig'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-649"></span><span>            </span><span class="annot"><span class="annottext">forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span>
</span><span id="line-650"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall n. MultiSet n -&gt; Notes n
</span><a href="PVGrammar.html#Notes"><span class="hs-identifier hs-var">Notes</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a.
(Foldable t, Eq a, Hashable a) =&gt;
t a -&gt; MultiSet a
</span><a href="Internal.MultiSet.html#fromList"><span class="hs-identifier hs-var">MS.fromList</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-651"></span><span>              </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679519465"><span class="annot"><span class="annottext">[Edge n]
</span><a href="#local-6989586621679519465"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall n. HashSet (Edge n) -&gt; MultiSet (InnerEdge n) -&gt; Edges n
</span><a href="PVGrammar.html#Edges"><span class="hs-identifier hs-var">Edges</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. (Eq a, Hashable a) =&gt; [a] -&gt; HashSet a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">[Edge n]
</span><a href="#local-6989586621679519465"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a. MultiSet a
</span><a href="Internal.MultiSet.html#empty"><span class="hs-identifier hs-var">MS.empty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-652"></span><span>              </span><span class="annot"><span class="annottext">Path [n] [Edge n]
</span><a href="#local-6989586621679519479"><span class="hs-identifier hs-var">original</span></a></span><span>
</span><span id="line-653"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Path (Notes n) (Edges n), Edges n)
</span><a href="#local-6989586621679519476"><span class="hs-identifier hs-var">path'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-654"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Path (Notes n) (Edges n), Edges n)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-655"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519464"><span class="annot"><span class="annottext">Path (Notes n) (Edges n)
</span><a href="#local-6989586621679519464"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Edges n
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Path (Notes n) (Edges n)
</span><a href="#local-6989586621679519464"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Path (Notes n) (Edges n)
</span><a href="#local-6989586621679519466"><span class="hs-identifier hs-var">orig'</span></a></span><span>
</span><span id="line-656"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-657"></span><span>  </span><span id="local-6989586621679519468"><span class="annot"><span class="annottext">foldPath :: (Path around between, between)
-&gt; (a, b, DerivSlice around) -&gt; Maybe (Path around between, b)
</span><a href="#local-6989586621679519468"><span class="hs-identifier hs-var hs-var">foldPath</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679519460"><span class="annot"><span class="annottext">Path around between
</span><a href="#local-6989586621679519460"><span class="hs-identifier hs-var">pacc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519459"><span class="annot"><span class="annottext">between
</span><a href="#local-6989586621679519459"><span class="hs-identifier hs-var">tacc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519458"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679519458"><span class="hs-identifier hs-var">tnew</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679519457"><span class="annot"><span class="annottext">DerivSlice around
</span><a href="#local-6989586621679519457"><span class="hs-identifier hs-var">snew</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-658"></span><span>    </span><span id="local-6989586621679519456"><span class="annot"><span class="annottext">around
</span><a href="#local-6989586621679519456"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. StartStop a -&gt; Maybe a
</span><a href="Common.html#getInner"><span class="hs-identifier hs-var">getInner</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall slc. DerivSlice slc -&gt; StartStop slc
</span><a href="Display.html#dslContent"><span class="hs-identifier hs-var">dslContent</span></a></span><span> </span><span class="annot"><span class="annottext">DerivSlice around
</span><a href="#local-6989586621679519457"><span class="hs-identifier hs-var">snew</span></a></span><span>
</span><span id="line-659"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall around between.
around -&gt; between -&gt; Path around between -&gt; Path around between
</span><a href="Common.html#Path"><span class="hs-identifier hs-var">Path</span></a></span><span> </span><span class="annot"><span class="annottext">around
</span><a href="#local-6989586621679519456"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">between
</span><a href="#local-6989586621679519459"><span class="hs-identifier hs-var">tacc</span></a></span><span> </span><span class="annot"><span class="annottext">Path around between
</span><a href="#local-6989586621679519460"><span class="hs-identifier hs-var">pacc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679519458"><span class="hs-identifier hs-var">tnew</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-660"></span></pre></body></html>